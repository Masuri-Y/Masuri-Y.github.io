<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello World</title>
    <url>/2022/01/12/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>自动化运维之Ansible（一）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--1/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--1/</url>
    <content><![CDATA[<h2 id="自动化运维之Ansible（一）"><a href="#自动化运维之Ansible（一）" class="headerlink" title="自动化运维之Ansible（一）"></a>自动化运维之Ansible（一）</h2><p>工作中经常会面临到机器非常多，所接触到的主机可能是成百上千台以上，所以在管理那么多主机时必须要使用自动化管理工具对其进行管理，此时如果使用手工进行管理将是非常的费时费力的。</p>
<span id="more"></span>

<h3 id="自动化运维应用场景"><a href="#自动化运维应用场景" class="headerlink" title="自动化运维应用场景"></a>自动化运维应用场景</h3><p>自动化运维工具的应用场景通常会涉及到以下几种环境：</p>
<p>文件传输：比如将某软件的配置文件在某台服务器上配置完成，配置完成后要将其配置文件传送到其他的所有服务器上去，让其他的服务器上的软件也实现相同功能。</p>
<p>应用部署：比如说在某些服务器上安装一个数据库、一个web服务器软件或者缓存服务器的软件，对一批服务器进行批量的部署软件</p>
<p>配置管理：软件部署完毕后还需要对软件的配置文件进行批量的配置和管理，对配置文件进行批量的修改。</p>
<p>任务流编排：类似于编写脚本，对任务的顺序进行编排，人工手动执行过于麻烦</p>
<h3 id="常用自动化运维工具"><a href="#常用自动化运维工具" class="headerlink" title="常用自动化运维工具"></a>常用自动化运维工具</h3><p>Ansible：红帽公司的员工所研发，后来被红帽公司收购。使用python编写，ansible是无代理的，无代理表示安装ansible的机器可以对成千上万台机器进行管理，而被管理的软件无需安装客户端就可以被ansible管理，这主要是因为ansible是基于ssh-key验证来实现的，只要ssh-key通过验证就能对其进行管理。</p>
<p>Saltstack：使用python编写，一般需要部署agent，执行效率更高</p>
<p>Puppet：使用ruby编写，适用于超大环境使用，功能强大，配置复杂。</p>
<p>Fabric：python编写，无代理agentless</p>
<p>chef：ruby编写，国内应用少</p>
<p>Cfengine:</p>
<p>func:</p>
<h3 id="Ansible的特性"><a href="#Ansible的特性" class="headerlink" title="Ansible的特性"></a>Ansible的特性</h3><p>模块化：调用特定的模块，完成特定的任务，有Paramiko，Jinja2（模板语言）三个关键模块，支持自定义模块。</p>
<p>部署简单：基于Python和SSH，agentless无代理，安全性高基于OpenSSH。</p>
<p>支持Playbook编排任务。</p>
<p>幂等性：一个任务执行一 次和执行N次的效果相同，不因重复执行而带来以为情况。</p>
<p>YAML格式：编排任务，支持丰富的数据结构，拥有比较强大的多层解决方案。</p>
<h3 id="Ansible的架构"><a href="#Ansible的架构" class="headerlink" title="Ansible的架构"></a>Ansible的架构</h3><p>Host Inventory：我们可以通过多种方式来使用ansible，我们可以通过用户直接使用ansible命令来使用ansible，在使用ansible之前需要配置一份主机清单，在主机清单中列出哪些主机是需要被ansible所管理的。</p>
<p>Public/Priviate Could：用户也可以通过开发接口来管理使用ansible，比如企业内部使用共有云或私有云来管理使用ansible。</p>
<p>Playbooks：企业内部也可以编写playbook，playbook中可以根据规划加入条件判断和循环，其用法类似于脚本。</p>
<p>Core Modules：ansible在使用时其背后还有各种不同的模块，其使用各种不同的模块来支持管理和配置不同的主机上的各种设置。其模块可以理解为各种命令，比如文件操作的命令，用户管理的命令，软件包管理的命令等等。</p>
<p>Custom Modules：ansible还支持自定义的模块，可以由用户自己开发各种模块。</p>
<p>Plugins：ansible支持各种插件，比如邮件、登录、等等。</p>
<p>Connection Plugins：以上所提到的工具最终将通过连接插件连接到被控制的主机上，从而来控制需要管理的主机。</p>
<p><img src="ansible1.png"></p>
<h3 id="Ansible的使用方法"><a href="#Ansible的使用方法" class="headerlink" title="Ansible的使用方法"></a>Ansible的使用方法</h3><p>Ansible的使用方法有两种Ad-Hoc和ansible-playbook。</p>
<p>Ad-Hoc：即ansible命令，主要用于临时命令使用场景</p>
<p>Ansible-playbook：主要用于长期规划好的，大型项目的场景，需要有前期的规划过程</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><p>执行ansible的主机一般称为主控端，中控，master或堡垒机</p>
</li>
<li><p>主控端Python版本需要2.6或以上</p>
</li>
<li><p>被控端Python版本小于2.4需要安装python-simplejson</p>
</li>
<li><p>被控端如开启SELinux需要安装libselinux-python</p>
</li>
<li><p>windows不能做为主控端</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（十）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--10/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E5%8D%81%EF%BC%89/</url>
    <content><![CDATA[<h2 id="template中的for和if"><a href="#template中的for和if" class="headerlink" title="template中的for和if"></a>template中的for和if</h2><p>在模板文件中可以使用for和if，来实现对模板文件中的内容进行循环和判断。从而实现一个配置文件中的某一段需要被多次引用，或者做判断某一配置段是否需要。</p>
<span id="more"></span>

<h3 id="template中的for循环"><a href="#template中的for循环" class="headerlink" title="template中的for循环"></a>template中的for循环</h3><p>在ansible的模板文件中可以创建循环，将某配置段中需要变动的值设置为一个变量，将变量中的所有值以列表的形式定义在yaml文件中，当playbook被执行时会从文件中逐个读取值，将配置段进行循环。</p>
<h4 id="template中for的使用"><a href="#template中for的使用" class="headerlink" title="template中for的使用"></a>template中for的使用</h4><p>生成以下文件内容，每个server段的监听端口不同其余都相同</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">        listen 81</span><br><span class="line">        server_name www.a.com</span><br><span class="line">        root /app/websitea/</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">        listen 82</span><br><span class="line">        server_name www.a.com</span><br><span class="line">        root /app/websitea/</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">        listen 83</span><br><span class="line">        server_name www.a.com</span><br><span class="line">        root /app/websitea/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.创建模板文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim templates/test1.j2</span></span><br><span class="line">&#123;%<span class="keyword">for</span> i <span class="keyword">in</span> test_ports %&#125;         <span class="comment">#创建for循环段，定义变量列表为test_ports</span></span><br><span class="line">server &#123;</span><br><span class="line">        listen &#123;&#123;i&#125;&#125;            <span class="comment">#将需要改变的port设置为变量</span></span><br><span class="line">        server_name www.a.com</span><br><span class="line">        root /app/websitea</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;%endfor%&#125;              <span class="comment">#for循环结束</span></span><br></pre></td></tr></table></figure>

<p>2.创建yaml文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim test1.yaml</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:                 <span class="comment">#定义变量取值的列表</span></span><br><span class="line">    test_ports:</span><br><span class="line">      - 81</span><br><span class="line">      - 82</span><br><span class="line">      - 83</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: tempate</span><br><span class="line">      template: src=test1.j2 dest=/data/test.conf</span><br></pre></td></tr></table></figure>

<p>3.执行脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible-playbook test1.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [tempate] **************************************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>4.验证创建出的内容所监听的端口是否为81，82，83</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># cat /data/test.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">        listen 81</span><br><span class="line">        server_name www.a.com</span><br><span class="line">        root /app/websitea</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 82</span><br><span class="line">        server_name www.a.com</span><br><span class="line">        root /app/websitea</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 83</span><br><span class="line">        server_name www.a.com</span><br><span class="line">        root /app/websitea</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="template中for的实战应用"><a href="#template中for的实战应用" class="headerlink" title="template中for的实战应用"></a>template中for的实战应用</h4><p>在上一步中已经实现了让生成的文件中监听端口不相同，在本步骤中需要实现使用for来创建出httpd中的虚拟主机配置段，配置结果如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">        listen 81</span><br><span class="line">        server_name www.a.com</span><br><span class="line">        root /app/websitea</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">        listen 82</span><br><span class="line">        server_name www.b.com</span><br><span class="line">        root /app/websiteb</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">        listen 83</span><br><span class="line">        server_name www.a.com</span><br><span class="line">        root /app/websitec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要实现每个循环中的所有配置都不相同，需要使用字典绑定  </p>
<p>1.修改模板</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim templates/test1.j2</span></span><br><span class="line"></span><br><span class="line">&#123;%<span class="keyword">for</span> i <span class="keyword">in</span> vhosts %&#125;            <span class="comment">#配置变量猎豹</span></span><br><span class="line">server &#123;</span><br><span class="line">        listen &#123;&#123;i.port&#125;&#125;       <span class="comment">#使用以&quot;i.*&quot;的变量，来定义端口，server_name和站点目录</span></span><br><span class="line">        server_name &#123;&#123;i.name&#125;&#125;</span><br><span class="line">        root &#123;&#123;i.dir&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;%endfor%&#125;</span><br></pre></td></tr></table></figure>

<p>2.修改剧本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim test1.yaml</span></span><br><span class="line">---</span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:                 <span class="comment">#在变量中定义字典绑定的关系</span></span><br><span class="line">    vhosts:</span><br><span class="line">      - web1:</span><br><span class="line">        port: 81</span><br><span class="line">        name: www.a.com</span><br><span class="line">        dir: /data/websitea</span><br><span class="line">      - web2:</span><br><span class="line">        port: 82</span><br><span class="line">        name: www.b.com</span><br><span class="line">        dir: /data/websiteb</span><br><span class="line">      - web3:</span><br><span class="line">        port: 83</span><br><span class="line">        name: www.c.com</span><br><span class="line">        dir: /data/websitec</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: tempate</span><br><span class="line">      template: src=test1.j2 dest=/data/test2.conf</span><br></pre></td></tr></table></figure>

<p>3.执行脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible-playbook test1.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [tempate] **************************************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>4.验证所创建出的配置文件是否正确</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@web2 data]<span class="comment"># vi test2.conf</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 81</span><br><span class="line">        server_name www.a.com</span><br><span class="line">        root /data/websitea</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 82</span><br><span class="line">        server_name www.b.com</span><br><span class="line">        root /data/websiteb</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 83</span><br><span class="line">        server_name www.c.com</span><br><span class="line">        root /data/websitec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="template中的if"><a href="#template中的if" class="headerlink" title="template中的if"></a>template中的if</h3><p>if可以判断变量是否定义，定了就引用，若是没有定义则不引用</p>
<h4 id="if的使用方法"><a href="#if的使用方法" class="headerlink" title="if的使用方法"></a>if的使用方法</h4><p>此处依旧以上一部为例，在模板中添加判断来创建出以下配置段：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 81</span><br><span class="line">        root /data/websitea</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 82</span><br><span class="line">        root /data/websiteb</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 83</span><br><span class="line">        server_name www.c.com</span><br><span class="line">        root /data/websitec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要创建出没有server_name的配置段只需要对server_name所对应的变量做判断，判断此变量是否被定义，如果此变量没有被定义则不会应用此变量，输出为空。</p>
<p>1.修改模板</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim templates/test1.j2</span></span><br><span class="line"></span><br><span class="line">&#123;%<span class="keyword">for</span> i <span class="keyword">in</span> vhosts %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen &#123;&#123;i.port&#125;&#125;</span><br><span class="line">&#123;%<span class="keyword">if</span> i.name is defined %&#125;             <span class="comment">#在server_name段添加判断，判断变量是否被定义</span></span><br><span class="line">        server_name &#123;&#123;i.name&#125;&#125;</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line">        root &#123;&#123;i.dir&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;%endfor%&#125;</span><br></pre></td></tr></table></figure>

<p>2.修改yaml</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim test1.yaml</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    vhosts:</span><br><span class="line">      - web1:</span><br><span class="line">        port: 81</span><br><span class="line">        <span class="comment">#name: www.a.com        #将name注释，此时变相没有设定，将不引用</span></span><br><span class="line">        dir: /data/websitea</span><br><span class="line">      - web2:</span><br><span class="line">        port: 82</span><br><span class="line">        <span class="comment">#name: www.b.com</span></span><br><span class="line">        dir: /data/websiteb</span><br><span class="line">      - web3:</span><br><span class="line">        port: 83</span><br><span class="line">        name: www.c.com</span><br><span class="line">        dir: /data/websitec</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: tempate</span><br><span class="line">      template: src=test1.j2 dest=/data/test2.conf</span><br></pre></td></tr></table></figure>

<p>3.执行剧本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible-playbook test1.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [tempate] **************************************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>验证远程主机上输出的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible webserver -a &quot;cat /data/test2.conf&quot;</span></span><br><span class="line">192.168.73.132 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 81                       <span class="comment">#输出的文件内容中梅有server_name行</span></span><br><span class="line">        root /data/websitea</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 82</span><br><span class="line">        root /data/websiteb</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 83</span><br><span class="line">        server_name www.c.com</span><br><span class="line">        root /data/websitec</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（十一）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--11/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<h2 id="ansible的roles"><a href="#ansible的roles" class="headerlink" title="ansible的roles"></a>ansible的roles</h2><p>roles用于层次性、结构化地组织playbook。roles能够更具层次结构自动装载变量文件，task以及handlers等。要使用roles只需要在playbook中使用include指令即可，简单来讲，roles就是通过分别将变量、文件、任务、模板以及处理器放置于单独的目录中，并可以便捷地include他们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以时用于构建守护进程等守护场景中。</p>
<p>roles就是按照不同的分类和功能进行目录化，模块化，能够实现代码的复合使用。</p>
<span id="more"></span>

<h3 id="roles的目录结构"><a href="#roles的目录结构" class="headerlink" title="roles的目录结构"></a>roles的目录结构</h3><p>每个角色都有特定的层级目录结构进行组织，每一个roles都必须符合这种结构规范。</p>
<h4 id="roles目录结构及作用"><a href="#roles目录结构及作用" class="headerlink" title="roles目录结构及作用"></a>roles目录结构及作用</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">playbook.yml</span><br><span class="line">roles/</span><br><span class="line">└──project/           <span class="comment">#项目名称</span></span><br><span class="line">   ├──tasks/          <span class="comment">#定义task,role的基本元素，至少包含一个名为main.yml的文件</span></span><br><span class="line">   ├──files/          <span class="comment">#存放由copy或script模块等需要模板文件的目录</span></span><br><span class="line">   ├──vars/           <span class="comment">#定义变量，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</span></span><br><span class="line">   ├──templates/      <span class="comment">#template模块查找所需要模板文件的目录</span></span><br><span class="line">   ├──handlers/       <span class="comment">#至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</span></span><br><span class="line">   ├──default/        <span class="comment">#设定默认变量时使用此目录中的main.yml文件（不常用）</span></span><br><span class="line">   └──meta/           <span class="comment">#定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含（不常用）</span></span><br></pre></td></tr></table></figure>

<h4 id="roles的创建步骤"><a href="#roles的创建步骤" class="headerlink" title="roles的创建步骤"></a>roles的创建步骤</h4><ol>
<li><p>创建以roles命名的目录</p>
</li>
<li><p>在roles目录中分别创建以各角色命名的目录</p>
</li>
<li><p>在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；用不到的目录可以创建为空目录，也可以不创建</p>
</li>
<li><p>在playbook文件中，调用各角色</p>
</li>
</ol>
<h3 id="roles的使用"><a href="#roles的使用" class="headerlink" title="roles的使用"></a>roles的使用</h3><h4 id="创建httpd的roles"><a href="#创建httpd的roles" class="headerlink" title="创建httpd的roles"></a>创建httpd的roles</h4><p>1.创建相应的目录结构</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># mkdir -pv roles/httpd/&#123;templates,tasks,files,vars,handlers&#125;      #在roles目录下创建出相应的目录结构</span></span><br><span class="line">mkdir: created directory ‘roles’</span><br><span class="line">mkdir: created directory ‘roles/httpd’</span><br><span class="line">mkdir: created directory ‘roles/httpd/templates’</span><br><span class="line">mkdir: created directory ‘roles/httpd/tasks’</span><br><span class="line">mkdir: created directory ‘roles/httpd/files’</span><br><span class="line">mkdir: created directory ‘roles/httpd/vars’</span><br><span class="line">mkdir: created directory ‘roles/httpd/handlers’</span><br></pre></td></tr></table></figure>

<p>2.创建所需的task</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#进入到tasks目录下创建任务，原本在playbook中的各个命令全部进行分类拆分，一个类别一个yaml文件。</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/httpd/tasks/install.yaml</span></span><br><span class="line">- name: install httpd</span><br><span class="line">  yum: name=httpd</span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/httpd/tasks/config.yaml</span></span><br><span class="line">- name: config</span><br><span class="line">  copy: src=httpd.conf dest=/etc/httpd.conf</span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/httpd/tasks/html.yaml</span></span><br><span class="line">- name: index.html</span><br><span class="line">  copy: src=index.html dest=/var/www/html</span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/httpd/tasks/service.yaml</span></span><br><span class="line">- name: service start</span><br><span class="line">  service: name=httpd state=started</span><br></pre></td></tr></table></figure>

<p>3.创建task的执行顺序文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在tasks目录下创建一个main.yaml文件里面存放上一步中所创建的各task的执行顺序</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/httpd/tasks/main.yaml</span></span><br><span class="line">- include: install.yaml</span><br><span class="line">- include: config.yaml</span><br><span class="line">- include: html.yaml</span><br><span class="line">- include: service.yaml</span><br></pre></td></tr></table></figure>

<p>4.将所需要用到的配置文件放至file目录下，对配置文件稍做修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#将需要添加的文件放置到files目录下，如果所添加的文件为配置文件则将其进行修改，或者使用模板进行配置</span></span><br><span class="line">[root@ansible data]<span class="comment"># cp /etc/httpd/conf/httpd.conf /data/roles/httpd/files/</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/httpd/files/httpd.conf</span></span><br><span class="line">Listen 8080</span><br></pre></td></tr></table></figure>

<p>5.在files目录下创建，index.html文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在files目录下创建出网站的主页</span></span><br><span class="line">[root@ansible data]<span class="comment"># echo &quot;&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;&quot; &gt; roles/httpd/files/index.html</span></span><br></pre></td></tr></table></figure>

<p>6.创建playbook调用文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在与roles平级的目录下创建出playbook的调用文件，在内部定义调用哪个roles。</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim httpd.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#install httpd</span></span><br><span class="line">- hosts: webserver</span><br><span class="line">  </span><br><span class="line">  roles:</span><br><span class="line">    - role: httpd</span><br></pre></td></tr></table></figure>

<p>7.测试检查</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#检查是否有语法错误</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -C httpd.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [httpd : install httpd] ***********************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [httpd : config] ******************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [httpd : index.html] **************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [httpd : service start] ***********************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=5    changed=4    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=4    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>8.执行playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook  httpd.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [httpd : install httpd] ***********************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [httpd : config] ******************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [httpd : index.html] **************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [httpd : service start] ***********************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=5    changed=4    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=4    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>9.验证httpd是否被部署</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用curl命令测试进行访问，查看httpd是否被部署</span></span><br><span class="line">[root@ansible data]<span class="comment"># curl 192.168.73.134:8080</span></span><br><span class="line">&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;</span><br><span class="line">[root@ansible data]<span class="comment"># curl 192.168.73.135:8080</span></span><br><span class="line">&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（十二）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--12/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<h2 id="roles中template、handler、when及tags的应用"><a href="#roles中template、handler、when及tags的应用" class="headerlink" title="roles中template、handler、when及tags的应用"></a>roles中template、handler、when及tags的应用</h2><p>在ansible的playbook中有template、notify-handler、when、及tags，来控制和管理ansible在部署服务时根据主机的不同，部署上不通的配置文件或者执行不同的操作。同样在roles中也能实现这样的功能，以下将演示这些功能在roles中的使用方法。</p>
<span id="more"></span>

<h3 id="roles中template使用"><a href="#roles中template使用" class="headerlink" title="roles中template使用"></a>roles中template使用</h3><p>roles中可以使用template让部署应用的配置文件进行模板化，可以实现根据需求的不通对各个主机上的配置文件做不同的改变，此处以创建nginx的角色为例来演示如何在roles中使用template</p>
<h4 id="创建Nginx角色"><a href="#创建Nginx角色" class="headerlink" title="创建Nginx角色"></a>创建Nginx角色</h4><p>1.创建相应的角色目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建出nginx的角色目录结构</span></span><br><span class="line">[root@ansible data]<span class="comment"># mkdir -pv roles/nginx/&#123;tasks,templates,files,vars,handlers&#125;</span></span><br><span class="line">mkdir: created directory ‘roles/nginx’</span><br><span class="line">mkdir: created directory ‘roles/nginx/tasks’</span><br><span class="line">mkdir: created directory ‘roles/nginx/templates’</span><br><span class="line">mkdir: created directory ‘roles/nginx/files’</span><br><span class="line">mkdir: created directory ‘roles/nginx/vars’</span><br><span class="line">mkdir: created directory ‘roles/nginx/handlers’</span><br></pre></td></tr></table></figure>

<p>2.将模板文件放入templates目录中，并对模板进行修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#将nginx的配置文件复制到templates目录下添加j2后缀，并对其内部的参数进行修改</span></span><br><span class="line">[root@ansible data]<span class="comment"># cp /etc/nginx/nginx.conf /data/roles/nginx/templates/nginx.conf.j2</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim /data/roles/nginx/templates/nginx.conf.j2</span></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       &#123;&#123;port&#125;&#125; default_server;             <span class="comment">#此处使用变量代替端口号</span></span><br><span class="line">        listen       [::]:&#123;&#123;port&#125;&#125; default_server;        <span class="comment">#此处使用变量代替端口号</span></span><br></pre></td></tr></table></figure>

<p>3.在vars目录中创建变量的定义文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在vars目录下创建一个main.yaml文件，在内部定义变量和值</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim /data/roles/nginx/vars/main.yaml</span></span><br><span class="line">port: 9527</span><br></pre></td></tr></table></figure>

<p>4.在tasks目录下创建各task</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在tasks目录下创建每一步所需的task</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/nginx/tasks/install.yaml</span></span><br><span class="line">- name: install</span><br><span class="line">  yum: name=nginx</span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/nginx/tasks/config.yaml</span></span><br><span class="line">- name: config</span><br><span class="line">  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/nginx/tasks/html.yaml</span></span><br><span class="line">- name: html</span><br><span class="line">  copy: src=roles/httpd/files/index.html dest=/usr/share/nginx/html/index.html</span><br><span class="line">  </span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/nginx/tasks/service.yaml</span></span><br><span class="line">- name: service</span><br><span class="line">  service: name=nginx state=started</span><br></pre></td></tr></table></figure>

<p>5.在tasks目录下创建执行顺序文件main.yaml</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在tasks目录下创建一个main.yaml文件在内部定义各task的执行次序</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/nginx/tasks/main.yaml</span></span><br><span class="line">- include: install.yaml</span><br><span class="line">- include: config.yaml</span><br><span class="line">- include: html.yaml</span><br><span class="line">- include: service.yaml</span><br></pre></td></tr></table></figure>

<p>6.创建roles调用目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建nginx的roles调用文件，在内部定义调用了那个roles。</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim nginx.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#install nginx</span></span><br><span class="line">  - hosts: webserver</span><br><span class="line"></span><br><span class="line">    roles:</span><br><span class="line">      - role: nginx</span><br></pre></td></tr></table></figure>

<p>7.测试检查</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -C  nginx.yaml</span></span><br><span class="line"> [WARNING]: Found variable using reserved name: port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [nginx : install] *****************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [nginx : config] ******************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [nginx : html] ********************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [nginx : service] *****************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=5    changed=4    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=4    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>8.执行playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook   nginx.yaml</span></span><br><span class="line"> [WARNING]: Found variable using reserved name: port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : install] *****************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : config] ******************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : html] ********************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [nginx : service] *****************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=5    changed=4    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=4    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>9.验证nginx是否被部署</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用curl命令测试网站是否被部署</span></span><br><span class="line">[root@ansible data]<span class="comment"># curl 192.168.73.134:9527</span></span><br><span class="line">&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;</span><br><span class="line">[root@ansible data]<span class="comment"># curl 192.168.73.135:9527</span></span><br><span class="line">&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<h3 id="roles中handler的使用"><a href="#roles中handler的使用" class="headerlink" title="roles中handler的使用"></a>roles中handler的使用</h3><p>在roles中可以使用notify+handler，来触发某一特定的任务，其使用方法类似于playbook中的使用。此处以上一步中创建出的roles为例对其进行修改，让其实现当部署的nginx配置文件发生改变时触发服务重启的操作。</p>
<h4 id="在roles中添加触发器"><a href="#在roles中添加触发器" class="headerlink" title="在roles中添加触发器"></a>在roles中添加触发器</h4><p>1.创建在handlers目录下创建handler</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在handlers目录下创建main.yaml文件，内部定义handler所要执行的动作</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/nginx/handlers/main.yaml</span></span><br><span class="line">- name: restart service</span><br><span class="line">  service: name=nginx state=restarted</span><br></pre></td></tr></table></figure>

<p>2.在tasks中添加触发条件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在tasks目录下定义config</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/nginx/tasks/config.yaml</span></span><br><span class="line">- name: config</span><br><span class="line">  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">  notify: restart service</span><br></pre></td></tr></table></figure>

<p>3.对变量稍作修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim roles/nginx/vars/main.yaml</span></span><br><span class="line">port: 1234</span><br></pre></td></tr></table></figure>

<p>4.检查测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -C  nginx.yaml</span></span><br><span class="line"> [WARNING]: Found variable using reserved name: port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : install] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [nginx : config] ******************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : html] ********************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : service] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [nginx : restart service] **********************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=6    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=6    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>5.执行playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook  nginx.yaml</span></span><br><span class="line"> [WARNING]: Found variable using reserved name: port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : install] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : config] ******************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : html] ********************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : service] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [nginx : restart service] **********************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=6    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=6    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>6.验证</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># curl 192.168.73.134:1234</span></span><br><span class="line">&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;</span><br><span class="line">[root@ansible data]<span class="comment"># curl 192.168.73.135:1234</span></span><br><span class="line">&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<h3 id="role中when的使用"><a href="#role中when的使用" class="headerlink" title="role中when的使用"></a>role中when的使用</h3><p>when在roles中的使用方法同playbook相同，使用when来做条件判断，来实现当系统版本不同时，应用不同的配置文件。</p>
<h4 id="when在roles中的应用（一）"><a href="#when在roles中的应用（一）" class="headerlink" title="when在roles中的应用（一）"></a>when在roles中的应用（一）</h4><p>此处以上一节中httpd的角色为例加以修改，将其实现在centos6和centos7上使用不同的配置文件。192.168.73.132为1台centos6主机。</p>
<p>1.将httpd2.2的配置文件存放至file目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># cp ~/httpd6.conf roles/httpd/files/httpd6.conf     #复制httpd2.2的配置文件到files目录下，此为centos6所使用的配置文件。</span></span><br></pre></td></tr></table></figure>

<p>2.在tasks目录下添加centos6的task</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim roles/httpd/tasks/config6.yaml         #添加任务复制配置文件到httpd配置文件目录</span></span><br><span class="line"></span><br><span class="line">- name: config6</span><br><span class="line">  copy: src=httpd6.conf dest=/etc/httpd/conf/httpd.conf</span><br></pre></td></tr></table></figure>

<p>3.修改tasks目录下main.yaml的执行次序，加入条件判断</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#修改tasks目录中的main.yaml文件，对系统做判断当系统为6时执行config6.yaml任务，当系统为7时执行config7.yaml任务，并通知restart service</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/httpd/tasks/main.yaml</span></span><br><span class="line">- include: install.yaml</span><br><span class="line">- include: config.yaml</span><br><span class="line">  when: ansible_distribution_major_version == <span class="string">&quot;7&quot;</span></span><br><span class="line">  notify: restart service</span><br><span class="line">- include: config6.yaml</span><br><span class="line">  when: ansible_distribution_major_version == <span class="string">&quot;6&quot;</span></span><br><span class="line">  notfiy: restart service</span><br><span class="line">- include: html.yaml</span><br><span class="line">- include: service.yaml</span><br></pre></td></tr></table></figure>

<p>4.在handlers目录下加入handler</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在上一步中定义了notify所以此处需要定义，触发所执行的动作是什么，在handler目录下创建main.yaml文件，编写restart service所要执行的任务。</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/httpd/handlers/main.yaml</span></span><br><span class="line">- name: restart service</span><br><span class="line">  service: name=httpd state=restarted</span><br></pre></td></tr></table></figure>

<p>5.检查测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -C httpd.yaml</span></span><br><span class="line">[DEPRECATION WARNING]: Specifying include variables at the top-level of the task is deprecated. Please see:</span><br><span class="line">https://docs.ansible.com/ansible/playbooks_roles.html<span class="comment">#task-include-files-and-encouraging-reuse   for currently</span></span><br><span class="line">supported syntax regarding included files and variables. This feature will be removed <span class="keyword">in</span> version 2.12.</span><br><span class="line">Deprecation warnings can be disabled by setting deprecation_warnings=False <span class="keyword">in</span> ansible.cfg.</span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [httpd : install httpd] ***********************************************************************************</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [httpd : config] ******************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [httpd : config6] *****************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : index.html] **************************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [httpd : service start] ***********************************************************************************</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=5    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=5    changed=0    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>6.执行playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook  httpd.yaml</span></span><br><span class="line">[DEPRECATION WARNING]: Specifying include variables at the top-level of the task is deprecated. Please see:</span><br><span class="line">https://docs.ansible.com/ansible/playbooks_roles.html<span class="comment">#task-include-files-and-encouraging-reuse   for currently</span></span><br><span class="line">supported syntax regarding included files and variables. This feature will be removed <span class="keyword">in</span> version 2.12.</span><br><span class="line">Deprecation warnings can be disabled by setting deprecation_warnings=False <span class="keyword">in</span> ansible.cfg.</span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [httpd : install httpd] ***********************************************************************************</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [httpd : config] ******************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [httpd : config6] *****************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : index.html] **************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : service start] ***********************************************************************************</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=5    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=5    changed=0    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>7.校验centos6主机上的httpd服务是否启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># curl 192.168.73.132:9527</span></span><br><span class="line">&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<h4 id="when在roles中的应用（二）"><a href="#when在roles中的应用（二）" class="headerlink" title="when在roles中的应用（二）"></a>when在roles中的应用（二）</h4><p>在上一步骤中将wehn放在了task中实现了不通的系统版本使用不同的配置文件。我们也可以将条件判断放在role调用中，实现根据条件的不同来执行不同的roles。</p>
<p>当系统为centos7时安装nginx，系统为centos6时安装httpd</p>
<p>1.创建roles调用文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在roles调用文件中进行判断，当远程主机的系统版本号为centos6时部署httpd，远程主机的系统版本号为centos7时部署nginx服务。</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim web.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#intsall web</span></span><br><span class="line">- hosts: webserver</span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line">      when: ansible_distribution_major_version == <span class="string">&quot;7&quot;</span></span><br><span class="line">    - role: httpd</span><br><span class="line">      when: ansible_distribution_major_version == <span class="string">&quot;6&quot;</span></span><br></pre></td></tr></table></figure>

<p>2.检查语法错误</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -C  web.yaml</span></span><br><span class="line">[DEPRECATION WARNING]: Specifying include variables at the top-level of the task is deprecated. Please see:</span><br><span class="line">https://docs.ansible.com/ansible/playbooks_roles.html<span class="comment">#task-include-files-and-encouraging-reuse   for currently</span></span><br><span class="line">supported syntax regarding included files and variables. This feature will be removed <span class="keyword">in</span> version 2.12.</span><br><span class="line">Deprecation warnings can be disabled by setting deprecation_warnings=False <span class="keyword">in</span> ansible.cfg.</span><br><span class="line"> [WARNING]: Found variable using reserved name: port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : install] *****************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : config] ******************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [nginx : html] ********************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [nginx : service] *****************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [httpd : install httpd] ***********************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : config] ******************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : config6] *****************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : index.html] **************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : service start] ***********************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [nginx : restart service] **********************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=5    changed=3    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=6    changed=5    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=6    changed=5    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>3.执行playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook  web.yaml</span></span><br><span class="line">[DEPRECATION WARNING]: Specifying include variables at the top-level of the task is deprecated. Please see:</span><br><span class="line">https://docs.ansible.com/ansible/playbooks_roles.html<span class="comment">#task-include-files-and-encouraging-reuse   for currently</span></span><br><span class="line">supported syntax regarding included files and variables. This feature will be removed <span class="keyword">in</span> version 2.12.</span><br><span class="line">Deprecation warnings can be disabled by setting deprecation_warnings=False <span class="keyword">in</span> ansible.cfg.</span><br><span class="line"> [WARNING]: Found variable using reserved name: port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : install] *****************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [nginx : config] ******************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [nginx : html] ********************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [nginx : service] *****************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [httpd : install httpd] ***********************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : config] ******************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : config6] *****************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : index.html] **************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [httpd : service start] ***********************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [nginx : restart service] **********************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=5    changed=3    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=6    changed=5    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=6    changed=5    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h3 id="roles中tags的使用"><a href="#roles中tags的使用" class="headerlink" title="roles中tags的使用"></a>roles中tags的使用</h3><p>在roles的调用中也可以使用tags标签来实现按需调用</p>
<h4 id="tags在roles中的使用"><a href="#tags在roles中的使用" class="headerlink" title="tags在roles中的使用"></a>tags在roles中的使用</h4><p>延用上一步骤中的roles调用文件，对每一个roles打上标签，到需要部署nginx时，只需要运行标签为web1的roles，部署httpd时只需要运行tags为web2的roles就可以了。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim web.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#intsall web</span></span><br><span class="line">- hosts: webserver</span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line">      when: ansible_distribution_major_version == <span class="string">&quot;7&quot;</span></span><br><span class="line">      tags: web1</span><br><span class="line">    - role: httpd</span><br><span class="line">      when: ansible_distribution_major_version == <span class="string">&quot;6&quot;</span></span><br><span class="line">      tags: web2</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（十三）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--13/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89/</url>
    <content><![CDATA[<h2 id="Ansible角色的一些实战练习"><a href="#Ansible角色的一些实战练习" class="headerlink" title="Ansible角色的一些实战练习"></a>Ansible角色的一些实战练习</h2><p>本节主要针对一些服务的部署，来创建出其角色。以方便更快的掌握ansible角色的创建和使用。</p>
<h3 id="练习一"><a href="#练习一" class="headerlink" title="练习一"></a>练习一</h3><p>建立memcached角色，并实现将内存的1/4当缓存使用</p>
<span id="more"></span>

<p>1.创建角色目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建出memcached角色的结构目录</span></span><br><span class="line">[root@ansible data]<span class="comment"># mkdir -pv roles/memcadhed/&#123;templates,tasks,vars&#125;</span></span><br><span class="line">mkdir: created directory ‘roles/memcadhed’</span><br><span class="line">mkdir: created directory ‘roles/memcadhed/templates’</span><br><span class="line">mkdir: created directory ‘roles/memcadhed/tasks’</span><br><span class="line">mkdir: created directory ‘roles/memcadhed/vars’</span><br></pre></td></tr></table></figure>

<p>2.安装memeche获取配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用yum安装memcached从而获取到memcached配置文件，并将配置文件复制到templates目录下让其变为模板文件</span></span><br><span class="line">[root@ansible data]<span class="comment"># yum install memcached -y</span></span><br><span class="line">[root@ansible data]<span class="comment"># cp /etc/sysconfig/memcached roles/memcadhed/templates/memcached.j2</span></span><br></pre></td></tr></table></figure>

<p>3.修改模板文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#对memcached模板文件做修改，对CACHESIZE行做修改，使用系统内置变量ansible_memtotal_mb来代替。</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/memcadhed/templates/memcached.j2</span></span><br><span class="line">PORT=<span class="string">&quot;11211&quot;</span></span><br><span class="line">USER=<span class="string">&quot;memcached&quot;</span></span><br><span class="line">MAXCONN=<span class="string">&quot;1024&quot;</span></span><br><span class="line">CACHESIZE=<span class="string">&quot;&#123;&#123;ansible_memtotal_mb//4&#125;&#125;&quot;</span>  <span class="comment">#缓存大小使用系统内置变量</span></span><br><span class="line">OPTIONS=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>4.在tasks目录下创建各task</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在tasks目录下创建出各个任务</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/memcadhed/tasks/install.yaml</span></span><br><span class="line">- name: install</span><br><span class="line">  yum: name=memcached</span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/memcadhed/tasks/config.yaml</span></span><br><span class="line">- name: config</span><br><span class="line">  template: src=memcached.j2 dest=/etc/sysconfig/memcached</span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/memcadhed/tasks/service.yaml</span></span><br><span class="line">- name: service</span><br><span class="line">  service: name=memcached state=started</span><br></pre></td></tr></table></figure>

<p>5.在tasks目录下创建执行顺序文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在tasks目录下创建出main.yaml文件，并写入各任务的执行次序</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/memcadhed/tasks/main.yaml</span></span><br><span class="line"></span><br><span class="line">- include: install.yaml</span><br><span class="line">- include: config.yaml</span><br><span class="line">- include: service.yaml</span><br></pre></td></tr></table></figure>

<p>6.创建调用role文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在与roles目录平级的目录下创建出roles调用文件，定义调用哪一个roles</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim memcached.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment"># install memcached</span></span><br><span class="line">- hosts: webserver</span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">    - role: memcached</span><br></pre></td></tr></table></figure>

<p>7.测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -C memcached.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [memcached : install] *************************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [memcached : config] **************************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [memcached : service] *************************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=4    changed=3    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=4    changed=3    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=4    changed=3    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>8.执行roles</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook memcached.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [memcached : install] *************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [memcached : config] **************************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [memcached : service] *************************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=4    changed=3    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=4    changed=3    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=4    changed=3    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h3 id="练习（二）"><a href="#练习（二）" class="headerlink" title="练习（二）"></a>练习（二）</h3><p>在centos6上时间服务为ntp服务，而在centos7上时间服务为chrony，使用ansible在centos6主机上部署ntp服务，centos7上部署chrony。</p>
<p>1.分别创建ntp和chrony角色目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># mkdir -pv roles/&#123;ntpd,chrony&#125;/&#123;templates,tasks,vars,files,handlers&#125;</span></span><br><span class="line">mkdir: created directory ‘roles/ntpd’</span><br><span class="line">mkdir: created directory ‘roles/ntpd/templates’</span><br><span class="line">mkdir: created directory ‘roles/ntpd/tasks’</span><br><span class="line">mkdir: created directory ‘roles/ntpd/vars’</span><br><span class="line">mkdir: created directory ‘roles/ntpd/files’</span><br><span class="line">mkdir: created directory ‘roles/ntpd/handlers’</span><br><span class="line">mkdir: created directory ‘roles/chrony’</span><br><span class="line">mkdir: created directory ‘roles/chrony/templates’</span><br><span class="line">mkdir: created directory ‘roles/chrony/tasks’</span><br><span class="line">mkdir: created directory ‘roles/chrony/vars’</span><br><span class="line">mkdir: created directory ‘roles/chrony/files’</span><br><span class="line">mkdir: created directory ‘roles/chrony/handlers’</span><br></pre></td></tr></table></figure>

<p>2.准备ntpd配置文件</p>
<p>2.1对ntp配置文件修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># vim /etc/ntp.conf</span></span><br><span class="line"><span class="comment">#修改配置文件中的以下三行，将应用此配置的服务器，部署为ntp服务器</span></span><br><span class="line">restrict default kod nomodify</span><br><span class="line">restrict 192.168.73.0 mask 255.255.255.0 nomodify notrap</span><br><span class="line">server 172.22.0.1 iburst</span><br></pre></td></tr></table></figure>

<p>2.2将ntp配置文件存放至role相关目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#将更改后的配置文件放入files目录中</span></span><br><span class="line">[root@ansible data]<span class="comment"># mv ntp.conf roles/ntpd/files/</span></span><br></pre></td></tr></table></figure>

<p>3.准备chrony配置文件</p>
<p>3.1修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim /etc/chrony.conf</span></span><br><span class="line"><span class="comment">#修改配置文件中的以下行，将应用此配置的服务器，部署为chrony服务器</span></span><br><span class="line">server 192.168.73.132 iburst</span><br></pre></td></tr></table></figure>

<p>3.2将chrony配置文件存放至role相关目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># cp /etc/chrony.conf roles/chrony/files/</span></span><br></pre></td></tr></table></figure>

<p>4.创建ntpd的tasks</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#根据服务部署时所需要的步骤创建出各个任务</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/ntpd/tasks/install.yaml</span></span><br><span class="line">- name: install</span><br><span class="line">  yum: name=ntp</span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/ntpd/tasks/config.yaml       #创建添加配置文件的task</span></span><br><span class="line">- name: config</span><br><span class="line">  copy: src=ntp.conf dest=/etc/ntp.conf</span><br><span class="line">  notify: restart service                                   <span class="comment">#当配置文件发生改变时通知服务重启</span></span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/ntpd/tasks/service.yaml</span></span><br><span class="line">- name: service</span><br><span class="line">  service: name=ntpd state=started</span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/ntpd/tasks/main.yaml         #创建任务执行顺序文件。</span></span><br><span class="line">- include: install.yaml</span><br><span class="line">- include: config.yaml</span><br><span class="line">- include: service.yaml</span><br></pre></td></tr></table></figure>

<p>5.创建ntpd的handler</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在handlers目录中出创建任务执行时，触发什么事情。</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/ntpd/handlers/main.yaml</span></span><br><span class="line">- name: restart service</span><br><span class="line">  service: name=ntpd state=restarted</span><br></pre></td></tr></table></figure>

<p>6.创建chrony的tasks</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#按部署chrony服务时所需的步骤创建出各task</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/chrony/tasks/install.yaml</span></span><br><span class="line">- name: install</span><br><span class="line">  yum: name=chrony</span><br><span class="line"></span><br><span class="line">  [root@ansible data]<span class="comment"># vim roles/chrony/tasks/config.yaml               #创建添加配置文件的task</span></span><br><span class="line">- name: config</span><br><span class="line">  copy: src=chrony.conf dest=/etc/chrony.conf</span><br><span class="line">  notify: restart service                                               <span class="comment">#当配置文件发生改变时通知服务重启</span></span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/chrony/tasks/service.yaml</span></span><br><span class="line">- name: service</span><br><span class="line">  service: name=chronyd state=started</span><br><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/chrony/tasks/main.yaml                   #创建任务执行顺序文件。</span></span><br><span class="line">- include: install.yaml</span><br><span class="line">- include: config.yaml</span><br><span class="line">- include: service.yaml</span><br></pre></td></tr></table></figure>

<p>7.创建chrony的handler</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在handlers目录中出创建任务执行时，触发什么事情。</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles/chrony/handlers/main.yaml</span></span><br><span class="line">- name: restart service</span><br><span class="line">  service: name=chronyd state=restarted</span><br></pre></td></tr></table></figure>

<p>8.创建带条件判断的role调用剧本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在roles调用中对系统的版本号做出判断，当版本号为6时部署ntpd，当版本号为7时部署chrony</span></span><br><span class="line">[root@ansible data]<span class="comment"># vim roles_time.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#install ntp chorny</span></span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: ntpd</span><br><span class="line">      when: ansible_distribution_major_version == <span class="string">&quot;6&quot;</span></span><br><span class="line">    - role: chrony</span><br><span class="line">      when: ansible_distribution_major_version == <span class="string">&quot;7&quot;</span></span><br></pre></td></tr></table></figure>

<p>9.测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -C roles_time.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [ntpd : install] ******************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [ntpd : config] *******************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [ntpd : service] ******************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [chrony : install] ****************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [chrony : config] *****************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [chrony : service] ****************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [ntpd : restart service] ***********************************************************************</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=4    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=4    changed=3    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=4    changed=3    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>10.执行roles</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook  roles_time.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ***********************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [ntpd : install] ******************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [ntpd : config] *******************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [ntpd : service] ******************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [chrony : install] ****************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [chrony : config] *****************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [chrony : service] ****************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=4    changed=0    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=4    changed=0    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=4    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（二）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--2/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<h2 id="自动化运维之Ansible（二）"><a href="#自动化运维之Ansible（二）" class="headerlink" title="自动化运维之Ansible（二）"></a>自动化运维之Ansible（二）</h2><p>本文将讲述ansible的各种安装方式以及Ansible的配置文件</p>
<span id="more"></span>

<h2 id="Ansible的安装"><a href="#Ansible的安装" class="headerlink" title="Ansible的安装"></a>Ansible的安装</h2><p>ansible可以通过多种方法进行安装，yum、编译、pip和git，都能安装ansible以下演示ansible的各种安装方式</p>
<h3 id="yum安装"><a href="#yum安装" class="headerlink" title="yum安装"></a>yum安装</h3><p>ansible安装最简单的方法可以使用rpm包进行安装，因为ansible已经被收入到的EPEL源中，在配置好yum源后就可以使用yum命令直接安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#配置EPEL源</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum install epel-release -y</span></span><br><span class="line"><span class="comment">#安装ansible</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum install ansible -y</span></span><br></pre></td></tr></table></figure>

<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>编译安装ansible时需要先下载ansible的源码包，然后对其进行进行编译安装。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#下载源码包</span></span><br><span class="line">[root@localhost ~]<span class="comment"># wget https://releases.ansible.com/ansible/ansible-latest.tar.gz</span></span><br><span class="line"><span class="comment">#安装编译所需的包组</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum install python-jinja2 PyYAML python-paramiko python-babel python-crypto -y</span></span><br><span class="line"><span class="comment">#解压源码包</span></span><br><span class="line">[root@localhost ~]<span class="comment"># tar xf ansible-latest.tar.gz -C /usr/src/</span></span><br><span class="line"><span class="comment">#编译安装ansible</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cd /usr/src/ansible-2.8.4/</span></span><br><span class="line">[root@localhost ansible-2.8.4]<span class="comment"># python setup.py build</span></span><br><span class="line">[root@localhost ansible-2.8.4]<span class="comment"># python setup.py install</span></span><br><span class="line"><span class="comment">#创建出ansible的配置文件目录</span></span><br><span class="line">[root@localhost ansible-2.8.4]<span class="comment"># mkdir /etc/ansible</span></span><br><span class="line"><span class="comment">#将配置文件复制到ansible配置文件目录下</span></span><br><span class="line">[root@localhost ansible-2.8.4]<span class="comment"># cp -r examples/* /etc/ansible</span></span><br></pre></td></tr></table></figure>

<h3 id="git安装"><a href="#git安装" class="headerlink" title="git安装"></a>git安装</h3><p>使用git命令直接将github上的ansible的项目克隆下来也能进行安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#克隆项目</span></span><br><span class="line">[root@localhost ~]<span class="comment"># git clone git://github.com/ansible/ansible.git --recursive</span></span><br><span class="line"><span class="comment">#安装</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cd ./ansible</span></span><br><span class="line">[root@localhost ~]<span class="comment"># source ./hacking/env-setup</span></span><br></pre></td></tr></table></figure>

<h3 id="pip安装"><a href="#pip安装" class="headerlink" title="pip安装"></a>pip安装</h3><p>由于anisble是基于python所写，所以ansible开可以基于pip来进行安装，pip是安装python包的管理器，其功能类似于yum</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#安装epel源</span></span><br><span class="line">[root@localhost ~]<span class="comment"># epel-release</span></span><br><span class="line"><span class="comment">#安装pip安装所需要的各种包</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum install python-pip python-devel gcc glibc-devel zlib-devel rpm-build openssl-devel</span></span><br><span class="line"><span class="comment">#更新pip</span></span><br><span class="line">[root@localhost ~]<span class="comment"># pip install --upgrade pip</span></span><br><span class="line"><span class="comment">#安装ansible</span></span><br><span class="line">[root@localhost ~]<span class="comment"># pip install ansible --upgrade</span></span><br></pre></td></tr></table></figure>

<p>以上就是ansible的各种安装方法，可以任选一种进行安装</p>
<hr>
<h2 id="ansible的配置文件"><a href="#ansible的配置文件" class="headerlink" title="ansible的配置文件"></a>ansible的配置文件</h2><p>ansible安装完毕后将在主机上生成了众多的文件，以下为一些较为重要的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#配置文件</span></span><br><span class="line">/etc/ansible/ansible.cfg	<span class="comment">#主配置文件，配置ansible工作特性</span></span><br><span class="line">/etc/ansible/hosts	<span class="comment">#主机清单</span></span><br><span class="line">/etc/ansible/roles/	<span class="comment">#存放角色的目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#程序</span></span><br><span class="line">/usr/bin/ansible	<span class="comment">#主程序，临时命令执行工具</span></span><br><span class="line">/usr/bin/ansible-doc	<span class="comment">#查看配置文档，模块功能查看工具</span></span><br><span class="line">/usr/bin/ansible-galaxy	<span class="comment">#下载/上传优秀代码或Roles模块的官网平台</span></span><br><span class="line">/usr/bin/ansible-playbook	<span class="comment">#定制自动化任务，编排剧本工具</span></span><br><span class="line">/usr/bin/ansible-pull 	<span class="comment">#远程执行命令的工具</span></span><br><span class="line">/usr/bin/ansible-vault 	<span class="comment">#文件加密工具</span></span><br><span class="line">/usr/bin/ansible-console 	<span class="comment">#基于Console界面与用户交互的执行工具</span></span><br></pre></td></tr></table></figure>

<h3 id="主机清单inventory"><a href="#主机清单inventory" class="headerlink" title="主机清单inventory"></a>主机清单inventory</h3><p>ansible的主要功能在于批量的主机操作，为了便捷地使用其中的部分主机，可以在主机清单中将其分组命名。 默认的主机清单文件为/etc/ansible/hosts文件，主机清单文件可以有多个，也可以通过Dynamic Inventory来动态生成。</p>
<h4 id="主机清单格式"><a href="#主机清单格式" class="headerlink" title="主机清单格式"></a>主机清单格式</h4><p>主机清单文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中；此外，当目标主机使用了非默认的ssh端口，还可以在主机名称之后使用冒号加端口号来标明。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[websever]                      <span class="comment">#中括号中的字符为组名</span></span><br><span class="line">192.168.73.134</span><br><span class="line">192.168.73.135:9527             <span class="comment">#如果目标主机使用了非标的ssh端口可以在主机名后跟上端口号</span></span><br><span class="line">[appsever]                      </span><br><span class="line">192.168.73.134                  <span class="comment">#同一主机可以归类至不同的组中。</span></span><br><span class="line">192.168.73.[01:10]              <span class="comment">#如果主机名遵循相似的命名模式，还可以使用列表的方式来标识各主机，表示ip地址最后一位01到10的主机</span></span><br></pre></td></tr></table></figure>

<h3 id="ansible配置文件"><a href="#ansible配置文件" class="headerlink" title="ansible配置文件"></a>ansible配置文件</h3><p>ansible的配置文件为/etc/ansible/ansible.cfg，此文件一般不做改动，保持默认配置。</p>
<p>配置文件中主要内容如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[defaults]</span><br><span class="line"><span class="comment">#inventory      = /etc/ansible/hosts                        #主机列表配置文件</span></span><br><span class="line"><span class="comment">#library        = /usr/share/my_modules/                    #库文件存放目录</span></span><br><span class="line"><span class="comment">#remote_tmp     = ~/.ansible/tmp                            #临时py命令文件存放在远程主机目录</span></span><br><span class="line"><span class="comment">#local_tmp      = ~/.ansible/tmp                            #本机的临时命令执行目录</span></span><br><span class="line"><span class="comment">#forks          = 5                                         #默认的并发数</span></span><br><span class="line"><span class="comment">#sudo_user      = root                                      #默认sudo用户</span></span><br><span class="line"><span class="comment">#ask_sudo_pass = True                                       </span></span><br><span class="line"><span class="comment">#ask_pass      = True                                       #每次执行ansible命令是否询问ssh密码</span></span><br><span class="line"><span class="comment">#remote_port    = 22                                        #目标主机端口默认22</span></span><br><span class="line"><span class="comment">#host_key_checking = False                                  #检查对应服务器的host_key</span></span><br><span class="line"><span class="comment">#log_path = /var/log/ansible.log                            #日志文件</span></span><br><span class="line"><span class="comment">#module_name = command                                      #默认使用模块</span></span><br></pre></td></tr></table></figure>

<p>以上为ansible的配置文件，一般保持默认无需改变，但建议将以下配置做修改(以下所有案例都基于这3项被修改的情况)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">host_key_checking = False                           <span class="comment">#此行注释去除，否则每次将检查主机的host_key</span></span><br><span class="line">log_path = /var/<span class="built_in">log</span>/ansible.log                     <span class="comment">#将日志文件打开，方便查看操作日志</span></span><br><span class="line">module_name = shell                                 <span class="comment">#将默认的模块改为shell，command模块功能太弱</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（三）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--3/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E4%B8%89%EF%BC%89/</url>
    <content><![CDATA[<h2 id="自动化运维之Ansible（三）"><a href="#自动化运维之Ansible（三）" class="headerlink" title="自动化运维之Ansible（三）"></a>自动化运维之Ansible（三）</h2><h3 id="Ansible系列命令"><a href="#Ansible系列命令" class="headerlink" title="Ansible系列命令"></a>Ansible系列命令</h3><p>ansible有许多的命令，ansible、ansible-doc、ansible-playbook、ansible-vault、ansible-console、ansible-galaxy、ansible-pull，以下以较常用的几个命令做详细的说明。</p>
<span id="more"></span>

<h3 id="ansible-doc命令"><a href="#ansible-doc命令" class="headerlink" title="ansible-doc命令"></a>ansible-doc命令</h3><p>ansible-doc用来显示ansible中各种模块的简要帮助信息</p>
<p>语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-doc [-l|-F|-s] [options] [-t &lt;plugin <span class="built_in">type</span>&gt; ] [plugin]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-l</td>
<td>列出可用模块</td>
</tr>
<tr>
<td>-a</td>
<td>显示所有模块的文档</td>
</tr>
<tr>
<td>-s</td>
<td>显示指定模块的playbook片段</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#列出所有模块</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ansible-doc -l</span></span><br><span class="line"><span class="comment">#查看指定模块的用法</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ansible-doc ping</span></span><br><span class="line"><span class="comment">#查看指定模块的简单用法</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ansible-doc -s ping</span></span><br></pre></td></tr></table></figure>

<h3 id="ansible命令"><a href="#ansible命令" class="headerlink" title="ansible命令"></a>ansible命令</h3><p>ansible通过ssh实现配置管理、应用部署、任务执行等功能。</p>
<p>语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible &lt;host-patten&gt; [-m module_name] [-a args]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">–version</td>
<td align="left">显示版本</td>
</tr>
<tr>
<td align="left">-m module</td>
<td align="left">指定模块，默认为command，可以通过修改配置文件进行修改</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">显示详细过程 -vv -vvv可以显示更加详细的内容</td>
</tr>
<tr>
<td align="left">–list-hosts</td>
<td align="left">显示主机列表，可以缩写–list</td>
</tr>
<tr>
<td align="left">-k</td>
<td align="left">提示输入ssh连接密码，默认KEY验证</td>
</tr>
<tr>
<td align="left">-C</td>
<td align="left">检查不执行</td>
</tr>
<tr>
<td align="left">-T，–timeout=TIMEOUT</td>
<td align="left">执行命令的超时时长</td>
</tr>
<tr>
<td align="left">-u,–user=REMOTE_USER</td>
<td align="left">指定远程执行的用户</td>
</tr>
<tr>
<td align="left">-b，–become</td>
<td align="left">代替旧版的sudo其替换</td>
</tr>
<tr>
<td align="left">–become-user=USERNAME</td>
<td align="left">指定sudo的runas用户，默认为root</td>
</tr>
<tr>
<td align="left">-K,–ask-become-pass</td>
<td align="left">提示输入sudo时的口令</td>
</tr>
</tbody></table>
<h3 id="ansible的模块"><a href="#ansible的模块" class="headerlink" title="ansible的模块"></a>ansible的模块</h3><h4 id="ping模块"><a href="#ping模块" class="headerlink" title="ping模块"></a>ping模块</h4><p>ping 用来测试主机的连通性</p>
<p>使用ansible-doc命令可以查看模块用法，使用-s可以简单的查看简单相关用法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s ping</span></span><br><span class="line">- name: Try to connect to host, verify a usable python and <span class="built_in">return</span> `pong<span class="string">&#x27; on success</span></span><br><span class="line"><span class="string">  ping:</span></span><br><span class="line"><span class="string">      data:                  # Data to return for the `ping&#x27;</span> <span class="built_in">return</span> value. If this</span><br><span class="line">                               parameter is <span class="built_in">set</span> to `crash<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">                               the module will cause an</span></span><br><span class="line"><span class="string">                               exception.</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>测试1：</p>
<p>使用ping模块进行测试时报错，提示错误，因为默认为key连接由于没有配置key所以报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]# ansible 192.168.73.134 -m ping</span><br><span class="line">192.168.73.134 | UNREACHABLE! =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;msg&quot;: &quot;Failed to connect to the host via ssh: Permission denied (publickey,password).&quot;, </span><br><span class="line">    &quot;unreachable&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试2：</p>
<p>带上-k选项后</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.73.134 -m ping -k</span></span><br><span class="line">SSH password: </span><br><span class="line">192.168.73.134 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试3：</p>
<p>使用组名，由于此处只给与一次输入密码，所以要确保被管理的两台主机必须要密码相同</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m ping -k</span></span><br><span class="line">SSH password: </span><br><span class="line">192.168.73.134 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试4：</p>
<p>指定由哪个用户执行操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m ping -u masuri -k</span></span><br><span class="line">SSH password: </span><br><span class="line">192.168.73.135 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.73.134 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试5：</p>
<p>使用-b让普通用户用sudo的方法进行操作，如果没有授予sudo的权限，会失败</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m ping -u masuri -k -b</span></span><br><span class="line">SSH password: </span><br><span class="line">192.168.73.134 | FAILED! =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;module_stderr&quot;</span>: <span class="string">&quot;Shared connection to 192.168.73.134 closed.\r\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;module_stdout&quot;</span>: <span class="string">&quot;sudo: a password is required\r\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;MODULE FAILURE\nSee stdout/stderr for the exact error&quot;</span>, </span><br><span class="line">    <span class="string">&quot;rc&quot;</span>: 1</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | FAILED! =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;module_stderr&quot;</span>: <span class="string">&quot;Shared connection to 192.168.73.135 closed.\r\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;module_stdout&quot;</span>: <span class="string">&quot;sudo: a password is required\r\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;MODULE FAILURE\nSee stdout/stderr for the exact error&quot;</span>, </span><br><span class="line">    <span class="string">&quot;rc&quot;</span>: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试6：</p>
<p>分别授予sudo权限后再次测试，此次带上-K选项，表示输入sudo口令执行命令，若要不输入口令，可以在sudo的配置文件中使用NOPASSWD选项。（一般不常用）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m ping -u masuri -k -b -K</span></span><br><span class="line">SSH password: </span><br><span class="line">SUDO password[defaults to SSH password]: </span><br><span class="line">192.168.73.135 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.73.134 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上为基于密钥的验证方法，ansible真正在生产环境中使用时还是需要基于key的验证方法</p>
<p>基于key的验证方法</p>
<p>在ansible主机上创建私钥文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ssh-keygen -t rsa -P &quot;&quot; -f .ssh/id_rsa</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> .ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> .ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:UAFYDd5EBqFIyC81+UYk9DZ3lRDZ3XUkr4K/FetFu+c root@ansible</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|..ooo+*B*+=.o o.=|</span></span><br><span class="line"><span class="string">|.o =++ =...o . +.|</span></span><br><span class="line"><span class="string">|  + =+o...      .|</span></span><br><span class="line"><span class="string">| . ..oo..  .   . |</span></span><br><span class="line"><span class="string">|  . .   S . . o .|</span></span><br><span class="line"><span class="string">|           . . +.|</span></span><br><span class="line"><span class="string">|            . o..|</span></span><br><span class="line"><span class="string">|             + .o|</span></span><br><span class="line"><span class="string">|            . .oE|</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure>

<p>将公钥复制到被管理的主机</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ssh-copy-id 192.168.73.134</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: <span class="string">&quot;/root/.ssh/id_rsa.pub&quot;</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to <span class="built_in">log</span> <span class="keyword">in</span> with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="keyword">if</span> you are prompted now it is to install the new keys</span><br><span class="line">root@192.168.73.134<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Number of key(s) added: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>192.168.73.134<span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="string">and check to make sure that only the key(s) you wanted were added.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@ansible ~]# ssh-copy-id 192.168.73.135</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span></span><br><span class="line"><span class="string">root@192.168.73.135&#x27;</span>s password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">&quot;ssh &#x27;192.168.73.135&#x27;&quot;</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br></pre></td></tr></table></figure>

<p>测试7：</p>
<p>此时再使用ping模块时不再需要带任何参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m ping </span></span><br><span class="line">192.168.73.134 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="shell模块"><a href="#shell模块" class="headerlink" title="shell模块"></a>shell模块</h4><p>shell模块用于执行shell命令</p>
<p>查看shell模块简单用法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]# ansible-doc -s shell</span><br><span class="line">- name: Execute commands in nodes.</span><br><span class="line">  shell:</span><br><span class="line">      chdir:                 # cd into this directory before running the command</span><br><span class="line">      creates:               # a filename, when it already exists, this step will *not* be</span><br><span class="line">                               run.</span><br><span class="line">      executable:            # change the shell used to execute the command. Should be an</span><br><span class="line">                               absolute path to the</span><br><span class="line">                               executable.</span><br><span class="line">      free_form:             # (required) The shell module takes a free form command to</span><br><span class="line">                               run, as a string.  There&#x27;s</span><br><span class="line">                               not an actual option named</span><br><span class="line">                               &quot;free form&quot;.  See the</span><br><span class="line">                               examples!</span><br><span class="line">      removes:               # a filename, when it does not exist, this step will *not* be</span><br><span class="line">                               run.</span><br><span class="line">      stdin:                 # Set the stdin of the command directly to the specified</span><br><span class="line">                               value.</span><br><span class="line">      warn:                  # if command warnings are on in ansible.cfg, do not warn about</span><br><span class="line">                               this particular line if set</span><br><span class="line">                               to no/false.</span><br></pre></td></tr></table></figure>

<p>示例1：  </p>
<p>使用shell来修改用户口令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m shell -a &#x27;echo 123456 | passwd --stdin masuri&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Changing password <span class="keyword">for</span> user masuri.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Changing password <span class="keyword">for</span> user masuri.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br></pre></td></tr></table></figure>
<p>示例2：<br>在shell模块中使用变量时参数需要使用单引号，若使用双引号则变量指向的是本机的值</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#单引号效果</span><br><span class="line">[root@ansible ~]# ansible webserver -m shell -a &#x27;echo $HOSTNAME&#x27;</span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">web1</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">web2</span><br><span class="line">#双引号的效果</span><br><span class="line">[root@ansible ~]# ansible webserver -m shell -a &quot;echo $HOSTNAME&quot;</span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ansible</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ansible</span><br></pre></td></tr></table></figure>

<p>示例3：</p>
<p>使用shell重定向</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m shell -a &#x27;chdir=/data echo welcome to magedu &gt; test.log&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看重定向是否成功</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m shell -a &#x27;chdir=/data cat test.log&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">welcome to magedu</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">welcome to magedu</span><br></pre></td></tr></table></figure>

<p>示例4：  </p>
<p>使用sed对文件进行修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m shell -a &#x27;sed -i &quot;s/welcome to magedu/welcome to mylinuxops/&quot; /data/test.log&#x27;</span></span><br><span class="line"> [WARNING]: Consider using the replace, lineinfile or template module rather than running</span><br><span class="line"><span class="string">&#x27;sed&#x27;</span>.  If you need to use <span class="built_in">command</span> because replace, lineinfile or template is insufficient</span><br><span class="line">you can add <span class="string">&#x27;warn: false&#x27;</span> to this <span class="built_in">command</span> task or <span class="built_in">set</span> <span class="string">&#x27;command_warnings=False&#x27;</span> <span class="keyword">in</span></span><br><span class="line">ansible.cfg to get rid of this message.</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证是否修改</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m shell -a &#x27;cat /data/test.log&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">welcome to mylinuxops</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">welcome to mylinuxops</span><br></pre></td></tr></table></figure>

<h4 id="script模块"><a href="#script模块" class="headerlink" title="script模块"></a>script模块</h4><p>script 模块是在远程主机上运行ansible服务器上的脚本  </p>
<p>示例1：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># vim hello.sh      #构建出一个简单的脚本</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello world&quot;</span></span><br><span class="line">[root@ansible ~]<span class="comment"># chmod +x hello.sh</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m script -a &#x27;/root/hello.sh&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;rc&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;Shared connection to 192.168.73.134 closed.\r\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stderr_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;Shared connection to 192.168.73.134 closed.&quot;</span></span><br><span class="line">    ], </span><br><span class="line">    <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;hello world\r\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stdout_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;hello world&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;rc&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;Shared connection to 192.168.73.135 closed.\r\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stderr_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;Shared connection to 192.168.73.135 closed.&quot;</span></span><br><span class="line">    ], </span><br><span class="line">    <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;hello world\r\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stdout_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;hello world&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="copy模块"><a href="#copy模块" class="headerlink" title="copy模块"></a>copy模块</h4><p>copy 从主控端复制文件到远程主机</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">src</td>
<td align="left">本机的源文件位置</td>
</tr>
<tr>
<td align="left">dest</td>
<td align="left">目标主机存放文件位置</td>
</tr>
<tr>
<td align="left">owner</td>
<td align="left">修改属主</td>
</tr>
<tr>
<td align="left">group</td>
<td align="left">修改属组</td>
</tr>
<tr>
<td align="left">mode</td>
<td align="left">修改权限</td>
</tr>
<tr>
<td align="left">backup</td>
<td align="left">备份，copy时文件若是存在会直接覆盖</td>
</tr>
<tr>
<td align="left">content</td>
<td align="left">指定生成文件的内容</td>
</tr>
</tbody></table>
<p>示例1：</p>
<p>复制本机文件到远程主机，并修改属主，修改权限。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m copy -a &#x27;src=/etc/fstab dest=/data/fstab2 owner=masuri mode=666 backup=yes&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;e18dfdc22b5e67945358018dfcca8f1c8b25722c&quot;</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/fstab2&quot;</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;4c98128827229df5554dee614d84d607&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0666&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;masuri&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 595, </span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1556157419.7-268980429666588/source&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 1000</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;e18dfdc22b5e67945358018dfcca8f1c8b25722c&quot;</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/fstab2&quot;</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;4c98128827229df5554dee614d84d607&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0666&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;masuri&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 595, </span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1556157419.7-28176178316202/source&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 1000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例2：  </p>
<p>使用content直接生成文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m copy -a &#x27;content=&quot;hello word\nwelcome to mylinuxops\n&quot; dest=/data/test1&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;89b51930dc2793a1ea796637d25b982d1c93aa90&quot;</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/test1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;b16c04a75e320a9862568401301b6b02&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 33, </span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1556158261.88-98867568897388/source&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;89b51930dc2793a1ea796637d25b982d1c93aa90&quot;</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/test1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;b16c04a75e320a9862568401301b6b02&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 33, </span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/root/.ansible/tmp/ansible-tmp-1556158261.89-218330298518724/source&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -a &#x27;cat /data/test1&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">hello word</span><br><span class="line">welcome to mylinuxops</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">hello word</span><br><span class="line">welcome to mylinuxops</span><br></pre></td></tr></table></figure>

<h4 id="fetch模块"><a href="#fetch模块" class="headerlink" title="fetch模块"></a>fetch模块</h4><p>fetch 从远程主机提取文件至主控端，只能提取文件，若要提取目录可以将目录先打包</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">dest</td>
<td align="left">在主控端存放文件的位置</td>
</tr>
<tr>
<td align="left">src</td>
<td align="left">远程主机所要提取的文件</td>
</tr>
</tbody></table>
<p>示例1：</p>
<p>将远程主机的/etc/fstab，抓取至本地的/data</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m fetch -a &#x27;dest=/data src=/etc/fstab&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;e18dfdc22b5e67945358018dfcca8f1c8b25722c&quot;</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/192.168.73.135/etc/fstab&quot;</span>, </span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;4c98128827229df5554dee614d84d607&quot;</span>, </span><br><span class="line">    <span class="string">&quot;remote_checksum&quot;</span>: <span class="string">&quot;e18dfdc22b5e67945358018dfcca8f1c8b25722c&quot;</span>, </span><br><span class="line">    <span class="string">&quot;remote_md5sum&quot;</span>: null</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;e18dfdc22b5e67945358018dfcca8f1c8b25722c&quot;</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/192.168.73.134/etc/fstab&quot;</span>, </span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;4c98128827229df5554dee614d84d607&quot;</span>, </span><br><span class="line">    <span class="string">&quot;remote_checksum&quot;</span>: <span class="string">&quot;e18dfdc22b5e67945358018dfcca8f1c8b25722c&quot;</span>, </span><br><span class="line">    <span class="string">&quot;remote_md5sum&quot;</span>: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例2：</p>
<p>将远程/etc/目录抓取至本地的/data</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#抓取目录分两步走，先打包</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -a &#x27;tar Jcf /data/etc.tar.xz /etc&#x27;</span></span><br><span class="line"> [WARNING]: Consider using the unarchive module rather than running <span class="string">&#x27;tar&#x27;</span>.  If you need to</span><br><span class="line">use <span class="built_in">command</span> because unarchive is insufficient you can add <span class="string">&#x27;warn: false&#x27;</span> to this <span class="built_in">command</span></span><br><span class="line">task or <span class="built_in">set</span> <span class="string">&#x27;command_warnings=False&#x27;</span> <span class="keyword">in</span> ansible.cfg to get rid of this message.</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">tar: Removing leading `/<span class="string">&#x27; from member names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class="line"><span class="string">tar: Removing leading `/&#x27;</span> from member names</span><br><span class="line"></span><br><span class="line"><span class="comment">#提取打包文件</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m fetch -a &#x27;dest=/data  src=/data/etc.tar.xz&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;2c7d756eff60249623f58d2ebec290848c4dea89&quot;</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/192.168.73.135/data/etc.tar.xz&quot;</span>, </span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;b20b3a78bcfd25d09d9ce2c9b7beeba3&quot;</span>, </span><br><span class="line">    <span class="string">&quot;remote_checksum&quot;</span>: <span class="string">&quot;2c7d756eff60249623f58d2ebec290848c4dea89&quot;</span>, </span><br><span class="line">    <span class="string">&quot;remote_md5sum&quot;</span>: null</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;checksum&quot;</span>: <span class="string">&quot;c95913f7a079f6c1fb31016105b524685a21cb2d&quot;</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/192.168.73.134/data/etc.tar.xz&quot;</span>, </span><br><span class="line">    <span class="string">&quot;md5sum&quot;</span>: <span class="string">&quot;e075e6d2681d7dbedaf070ad81ebd3e3&quot;</span>, </span><br><span class="line">    <span class="string">&quot;remote_checksum&quot;</span>: <span class="string">&quot;c95913f7a079f6c1fb31016105b524685a21cb2d&quot;</span>, </span><br><span class="line">    <span class="string">&quot;remote_md5sum&quot;</span>: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="File模块"><a href="#File模块" class="headerlink" title="File模块"></a>File模块</h4><p>File模块可以设置文件的属性</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">access_time</td>
<td align="left">访问时间</td>
</tr>
<tr>
<td align="left">access_time_format</td>
<td align="left">时间格式</td>
</tr>
<tr>
<td align="left">attributes</td>
<td align="left">attr格式</td>
</tr>
<tr>
<td align="left">force</td>
<td align="left">当软连接的源文件不存在时使用</td>
</tr>
<tr>
<td align="left">group</td>
<td align="left">设置文件的属组</td>
</tr>
<tr>
<td align="left">mode</td>
<td align="left">设置文件的权限</td>
</tr>
<tr>
<td align="left">modification_time</td>
<td align="left">文件修改时间</td>
</tr>
<tr>
<td align="left">modification_time_format</td>
<td align="left">文件修改时间格式</td>
</tr>
<tr>
<td align="left">owner</td>
<td align="left">设置文件的属主</td>
</tr>
<tr>
<td align="left">path</td>
<td align="left">被管理的文件路径</td>
</tr>
<tr>
<td align="left">src</td>
<td align="left">指定软硬链接的源文件位置</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">设置文件的类型，file:文件不存在时不会被创建，link:创建软连接，hard:创建硬连接，absent:删除文件，touch:创建空文件</td>
</tr>
</tbody></table>
<p>示例1：</p>
<p>修改文件的属主，权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m file -a &#x27;path=/data/test1 owner=masuri mode=777&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0777&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;masuri&quot;</span>, </span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/data/test1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 33, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 1000</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0777&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;masuri&quot;</span>, </span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/data/test1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 33, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 1000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看属性</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ls -l /data/test1&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">-rwxrwxrwx 1 masuri root 33 Apr 25 10:11 /data/test1</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">-rwxrwxrwx 1 masuri root 33 Apr 25 10:11 /data/test1</span><br></pre></td></tr></table></figure>

<p>示例2：</p>
<p>创建硬连接,state=hard</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m file -a &#x27;src=/data/test1 name=/data/test1.log state=hard&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/test1.log&quot;</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0777&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;masuri&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 33, </span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/data/test1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;hard&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 1000</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/test1.log&quot;</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0777&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;masuri&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 33, </span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/data/test1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;hard&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 1000</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#查看文件</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ls -l /data/test1.log&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">-rwxrwxrwx 2 masuri root 33 Apr 25 10:11 /data/test1.log</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">-rwxrwxrwx 2 masuri root 33 Apr 25 10:11 /data/test1.log</span><br></pre></td></tr></table></figure>

<p>示例3：</p>
<p>创建软连接，state=link</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m file -a &#x27;src=/data/test1 name=/data/123 state=link&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/123&quot;</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0777&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 11, </span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/data/test1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;link&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/123&quot;</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0777&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 11, </span><br><span class="line">    <span class="string">&quot;src&quot;</span>: <span class="string">&quot;/data/test1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;link&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ls -l /data/123&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">lrwxrwxrwx 1 root root 11 Apr 25 10:56 /data/123 -&gt; /data/test1</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">lrwxrwxrwx 1 root root 11 Apr 25 10:56 /data/123 -&gt; /data/test1</span><br></pre></td></tr></table></figure>

<p>示例4:</p>
<p>创建空文件，state=touch</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m file -a &#x27;path=/data/test2 state=touch&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/test2&quot;</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/data/test2&quot;</span>, </span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>, </span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>, </span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;file&quot;</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ls -l /data/test2&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">-rw-r--r-- 1 root root 0 Apr 25 10:59 /data/test2</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">-rw-r--r-- 1 root root 0 Apr 25 10:59 /data/test2</span><br></pre></td></tr></table></figure>

<p>示例5：</p>
<p>删除文件，state=absent</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m file -a &#x27;path=/data/test2 state=absent&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/data/test2&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;absent&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/data/test2&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;absent&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ls -l /data/test2&#x27;</span></span><br><span class="line">192.168.73.135 | FAILED | rc=2 &gt;&gt;</span><br><span class="line">ls: cannot access /data/test2: No such file or directorynon-zero <span class="built_in">return</span> code</span><br><span class="line"></span><br><span class="line">192.168.73.134 | FAILED | rc=2 &gt;&gt;</span><br><span class="line">ls: cannot access /data/test2: No such file or directorynon-zero <span class="built_in">return</span> code</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="hostname-模块"><a href="#hostname-模块" class="headerlink" title="hostname 模块"></a>hostname 模块</h4><p>hostname 管理主机名</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">name</td>
<td align="left">设置主机名</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible 192.168.73.134 -m hostname -a &#x27;name=mylinuxops.com&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ansible_domain&quot;</span>: <span class="string">&quot;com&quot;</span>, </span><br><span class="line">        <span class="string">&quot;ansible_fqdn&quot;</span>: <span class="string">&quot;mylinuxops.com&quot;</span>, </span><br><span class="line">        <span class="string">&quot;ansible_hostname&quot;</span>: <span class="string">&quot;mylinuxops&quot;</span>, </span><br><span class="line">        <span class="string">&quot;ansible_nodename&quot;</span>: <span class="string">&quot;mylinuxops.com&quot;</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mylinuxops.com&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="cron-模块"><a href="#cron-模块" class="headerlink" title="cron 模块"></a>cron 模块</h4><p>corn 计划任务模块</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">backup</td>
<td align="left">在计划任务创建前先备份</td>
</tr>
<tr>
<td align="left">day</td>
<td align="left">天</td>
</tr>
<tr>
<td align="left">hour</td>
<td align="left">小时</td>
</tr>
<tr>
<td align="left">minute</td>
<td align="left">分钟</td>
</tr>
<tr>
<td align="left">month</td>
<td align="left">月</td>
</tr>
<tr>
<td align="left">weekday</td>
<td align="left">星期</td>
</tr>
<tr>
<td align="left">name</td>
<td align="left">计划任务的名称</td>
</tr>
<tr>
<td align="left">reboot</td>
<td align="left">重启后执行</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">absent:删除</td>
</tr>
<tr>
<td align="left">job</td>
<td align="left">计划任务的内容</td>
</tr>
<tr>
<td align="left">disabled</td>
<td align="left">启用和禁用</td>
</tr>
</tbody></table>
<p>示例1：</p>
<p>创建计划任务，每天1点备份/etc/目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m cron -a &#x27;name=backupetc hour=1 job=&quot;/usr/bin/cp -a /etc /data/`date +%F`&quot;&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;envs&quot;</span>: [], </span><br><span class="line">    <span class="string">&quot;jobs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;backupetc&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;envs&quot;</span>: [], </span><br><span class="line">    <span class="string">&quot;jobs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;backupetc&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;crontab -l&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: backupetc</span></span><br><span class="line">* 1 * * * /usr/bin/cp -a /etc /data/`date +%F`</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: backupetc</span></span><br><span class="line">* 1 * * * /usr/bin/cp -a /etc /data/`date +%F`</span><br></pre></td></tr></table></figure>

<p>示例2：</p>
<p>计划任务的禁用，disabled=true</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m cron -a &#x27;name=backupetc day=* hour=1 job=&quot;/usr/bin/cp -a /etc /data/`date +%F`&quot; disabled=true&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;envs&quot;</span>: [], </span><br><span class="line">    <span class="string">&quot;jobs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;backupetc&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;envs&quot;</span>: [], </span><br><span class="line">    <span class="string">&quot;jobs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;backupetc&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;crontab -l&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: backupetc</span></span><br><span class="line"><span class="comment">#* 1 * * * /usr/bin/cp -a /etc /data/`date +%F`</span></span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: backupetc</span></span><br><span class="line"><span class="comment">#* 1 * * * /usr/bin/cp -a /etc /data/`date +%F`</span></span><br></pre></td></tr></table></figure>

<p>示例3：  </p>
<p>计划任务的启用，disabled=false</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m cron -a &#x27;name=backupetc day=* hour=1 job=&quot;/usr/bin/cp -a /etc /data/`date +%F`&quot; disabled=false&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;envs&quot;</span>: [], </span><br><span class="line">    <span class="string">&quot;jobs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;backupetc&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;envs&quot;</span>: [], </span><br><span class="line">    <span class="string">&quot;jobs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;backupetc&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#验证：</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;crontab -l&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: backupetc</span></span><br><span class="line">* 1 * * * /usr/bin/cp -a /etc /data/`date +%F`</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: backupetc</span></span><br><span class="line">* 1 * * * /usr/bin/cp -a /etc /data/`date +%F</span><br></pre></td></tr></table></figure>

<p>示例4：</p>
<p>删除计划任务，state=absent</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m cron -a &#x27;name=backupetc day=* hour=1 job=&quot;/usr/bin/cp -a /etc /data/`date +%F`&quot; state=absent&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;envs&quot;</span>: [], </span><br><span class="line">    <span class="string">&quot;jobs&quot;</span>: []</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;envs&quot;</span>: [], </span><br><span class="line">    <span class="string">&quot;jobs&quot;</span>: []</span><br><span class="line">&#125;</span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;crontab -l&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="yum-模块"><a href="#yum-模块" class="headerlink" title="yum 模块"></a>yum 模块</h4><p>yum 包管理</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">name</td>
<td align="left">包的名字</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">present:安装(可缺省)，absent:卸载</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>按装httpd</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m yum -a &#x27;name=httpd&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">...省略...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;rpm -q httpd&#x27;</span></span><br><span class="line"> [WARNING]: Consider using the yum, dnf or zypper module rather than running <span class="string">&#x27;rpm&#x27;</span>.  If you need to use <span class="built_in">command</span></span><br><span class="line">because yum, dnf or zypper is insufficient you can add <span class="string">&#x27;warn: false&#x27;</span> to this <span class="built_in">command</span> task or <span class="built_in">set</span></span><br><span class="line"><span class="string">&#x27;command_warnings=False&#x27;</span> <span class="keyword">in</span> ansible.cfg to get rid of this message.</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">httpd-2.4.6-88.el7.centos.x86_64</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">httpd-2.4.6-88.el7.centos.x86_64</span><br></pre></td></tr></table></figure>

<p>示例2：</p>
<p>卸载httpd</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m yum -a &#x27;name=httpd state=absent&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;pkg_mgr&quot;</span>: <span class="string">&quot;yum&quot;</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;&quot;</span>, </span><br><span class="line">....省略</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;rpm -q httpd&#x27;</span></span><br><span class="line"> [WARNING]: Consider using the yum, dnf or zypper module rather than running <span class="string">&#x27;rpm&#x27;</span>.  If you need to use <span class="built_in">command</span></span><br><span class="line">because yum, dnf or zypper is insufficient you can add <span class="string">&#x27;warn: false&#x27;</span> to this <span class="built_in">command</span> task or <span class="built_in">set</span></span><br><span class="line"><span class="string">&#x27;command_warnings=False&#x27;</span> <span class="keyword">in</span> ansible.cfg to get rid of this message.</span><br><span class="line"></span><br><span class="line">192.168.73.134 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">package httpd is not installednon-zero <span class="built_in">return</span> code</span><br><span class="line"></span><br><span class="line">192.168.73.135 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">package httpd is not installednon-zero <span class="built_in">return</span> code</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="service-模块"><a href="#service-模块" class="headerlink" title="service 模块"></a>service 模块</h4><p>service 用来管理服务</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">enabled</td>
<td align="left">是否开机启动</td>
</tr>
<tr>
<td align="left">name</td>
<td align="left">服务名称</td>
</tr>
<tr>
<td align="left">runlevel</td>
<td align="left">运行在哪个级别上</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">started:启动，stopped:停止，reloaded:重读配置文件，restarted:重启服务</td>
</tr>
</tbody></table>
<p>示例1：</p>
<p>启动httpd服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m service -a &#x27;name=httpd state=started&#x27;</span></span><br><span class="line">;^H192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;httpd&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;started&quot;</span>, </span><br><span class="line">    <span class="string">&quot;status&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ActiveEnterTimestampMonotonic&quot;</span>: <span class="string">&quot;0&quot;</span>, </span><br><span class="line">        <span class="string">&quot;ActiveExitTimestampMonotonic&quot;</span>: <span class="string">&quot;0&quot;</span>, </span><br><span class="line">...省略</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible webserver  -a &#x27;ss -tnl | grep 80 &#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128         :::80                      :::*                  </span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128         :::80                      :::*                  </span><br></pre></td></tr></table></figure>

<h4 id="user-模块"><a href="#user-模块" class="headerlink" title="user 模块"></a>user 模块</h4><p>user 用户管理模块</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">name</td>
<td align="left">指定用户名</td>
</tr>
<tr>
<td align="left">system</td>
<td align="left">系统用户</td>
</tr>
<tr>
<td align="left">create_home</td>
<td align="left">创建家目录</td>
</tr>
<tr>
<td align="left">shell</td>
<td align="left">指定shell类型</td>
</tr>
<tr>
<td align="left">group</td>
<td align="left">指定主组</td>
</tr>
<tr>
<td align="left">groups</td>
<td align="left">指定附加组</td>
</tr>
<tr>
<td align="left">remove</td>
<td align="left">删除用户是删除家目录</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">absent:删除用户</td>
</tr>
<tr>
<td align="left">uid</td>
<td align="left">指定Uid号</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>创建mysql用户，为系统用户，shell类型为/sbin/nologin</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m user -a &#x27;name=mysql system=yes shell=/sbin/nologin&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;comment&quot;</span>: <span class="string">&quot;&quot;</span>, </span><br><span class="line">    <span class="string">&quot;create_home&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: 996, </span><br><span class="line">    <span class="string">&quot;home&quot;</span>: <span class="string">&quot;/home/mysql&quot;</span>, </span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mysql&quot;</span>, </span><br><span class="line">    <span class="string">&quot;shell&quot;</span>: <span class="string">&quot;/sbin/nologin&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;present&quot;</span>, </span><br><span class="line">    <span class="string">&quot;system&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 998</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;comment&quot;</span>: <span class="string">&quot;&quot;</span>, </span><br><span class="line">    <span class="string">&quot;create_home&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;group&quot;</span>: 996, </span><br><span class="line">    <span class="string">&quot;home&quot;</span>: <span class="string">&quot;/home/mysql&quot;</span>, </span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mysql&quot;</span>, </span><br><span class="line">    <span class="string">&quot;shell&quot;</span>: <span class="string">&quot;/sbin/nologin&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;present&quot;</span>, </span><br><span class="line">    <span class="string">&quot;system&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 998</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -a &#x27;getent passwd mysql&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">mysql:x:998:996::/home/mysql:/sbin/nologin</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">mysql:x:998:996::/home/mysql:/sbin/nologin</span><br></pre></td></tr></table></figure>

<p>示例2  </p>
<p>删除账号，删除账号时需要带上remove参数，默认不会删除用户的家目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible webserver -m user -a &#x27;name=mysql remove=yes state=absent&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;force&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mysql&quot;</span>, </span><br><span class="line">    <span class="string">&quot;remove&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;absent&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;userdel: mysql mail spool (/var/spool/mail/mysql) not found\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stderr_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;userdel: mysql mail spool (/var/spool/mail/mysql) not found&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.73.134 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;force&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mysql&quot;</span>, </span><br><span class="line">    <span class="string">&quot;remove&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;absent&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;userdel: mysql mail spool (/var/spool/mail/mysql) not found\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stderr_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;userdel: mysql mail spool (/var/spool/mail/mysql) not found&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ansible-console"><a href="#ansible-console" class="headerlink" title="ansible-console"></a>ansible-console</h3><p>ansible-console为可交互的ansible工具，使用交互的模式对主机列表中的主机进行操作。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible-console</span></span><br><span class="line">Welcome to the ansible console.</span><br><span class="line">Type <span class="built_in">help</span> or ? to list commands.</span><br><span class="line"></span><br><span class="line">root@all (2)[f:5]$ </span><br><span class="line"><span class="comment">#all：为当前的所有主机，切换组可以使用cd + 组名 的方式</span></span><br><span class="line"><span class="comment">#2:主机数</span></span><br><span class="line"><span class="comment">#f:5 并行执行数，设置并发数 fork + NUM</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（四）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--4/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--4/</url>
    <content><![CDATA[<h2 id="ansible的playbook"><a href="#ansible的playbook" class="headerlink" title="ansible的playbook"></a>ansible的playbook</h2><p>ansible-playbook为ansible的脚本，其是由yaml语言构成，这种语言对格式的要求非常高。</p>
<span id="more"></span>

<h3 id="yaml语言的格式要求"><a href="#yaml语言的格式要求" class="headerlink" title="yaml语言的格式要求"></a>yaml语言的格式要求</h3><ol>
<li>在单一档案中，可以用连续三个连字号(—)区分多个档案，另外，还有选择性的连续三个点号_(…)来表示档案的结尾  </li>
<li>此行开始正常写playbook的内容，一般建议写明该playbook的功能</li>
<li>使用#注释代码  </li>
<li>缩进必须统一的，不能空格和tab混用  </li>
<li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的  </li>
<li>YAML文件内容是区分大小写的，k/v的值均需大小写敏感  </li>
<li>多个k/v可以同行写也可以换行写，同行使用，分割  </li>
<li>v可以是个字符串，也可以是另一个列表  </li>
<li>一个完整的代码块功能需最少元素包括name和task  </li>
<li>一个name只能包括一个task  </li>
<li>YAML文件扩展名通常为yaml或yml</li>
</ol>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim hello.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#hello world</span></span><br><span class="line">  - host: webserver</span><br><span class="line">    remote_user: root</span><br><span class="line"></span><br><span class="line">    task:</span><br><span class="line">      - name: hello world</span><br><span class="line">        shell: /usr/bin/wall hello world</span><br></pre></td></tr></table></figure>

<h3 id="ansible-playbook示例"><a href="#ansible-playbook示例" class="headerlink" title="ansible-playbook示例"></a>ansible-playbook示例</h3><h4 id="编写部署httpd的playbook"><a href="#编写部署httpd的playbook" class="headerlink" title="编写部署httpd的playbook"></a>编写部署httpd的playbook</h4><p>1.准备好httpd配置文件，http默认的端口为80，此处将其改为8080</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim httpd.conf</span></span><br><span class="line">Listen 8080   <span class="comment">#找到listen行将默认端口修改为8080</span></span><br></pre></td></tr></table></figure>

<p>2.编写yaml文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="comment">#install httpd</span></span><br><span class="line">  - hosts: webserver</span><br><span class="line">    remote_user: root</span><br><span class="line"></span><br><span class="line">    tasks:</span><br><span class="line">      - name: install</span><br><span class="line">        yum: name=httpd</span><br><span class="line">      - name: config</span><br><span class="line">        copy: src=/data/httpd.conf dest=/etc/httpd/httpd.conf</span><br><span class="line">      - name: service</span><br><span class="line">        service: name=httpd state=started</span><br><span class="line">      - name: check</span><br><span class="line">        shell: ss -tnl | grep 8080</span><br></pre></td></tr></table></figure>

<p>3.检查是否有语法错误</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -C httpd.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [install] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [config] ***************************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [service] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=4    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=4    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>4.执行yaml脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook httpd.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [install] **************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [config] ***************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [service] **************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=4    changed=3    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=4    changed=3    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>5.校验</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ss -tnl | grep 8080&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128         :::8080                    :::*</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128         :::8080                    :::*</span><br></pre></td></tr></table></figure>

<h4 id="编写创建MySQL用户的playbook"><a href="#编写创建MySQL用户的playbook" class="headerlink" title="编写创建MySQL用户的playbook"></a>编写创建MySQL用户的playbook</h4><p>1.编写yaml文件</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> [root@ansible data]<span class="comment"># vim user.yml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#useradd</span></span><br><span class="line">  - hosts: webserver</span><br><span class="line">    remote_user: root</span><br><span class="line"></span><br><span class="line">    tasks:</span><br><span class="line">      - name: create group</span><br><span class="line">        group: name=mysql gid=3306</span><br><span class="line">      - name: create user</span><br><span class="line">        user: name=mysql uid=3306 shell=/sbin/nologlin system=yes group=mysql create_home=no</span><br></pre></td></tr></table></figure>

<p>2.检查语法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -C user.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [create group] *********************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [create user] **********************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=3    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=3    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>3.执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook  user.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [create group] *********************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [create user] **********************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=3    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=3    changed=2    unreachable=0    failed=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.验证</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;getent passwd mysql&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">mysql:x:3306:3306::/home/mysql:/sbin/nologlin</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">mysql:x:3306:3306::/home/mysql:/sbin/nologlin</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（五）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--5/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E4%BA%94%EF%BC%89/</url>
    <content><![CDATA[<h2 id="playbook中的notify和handler"><a href="#playbook中的notify和handler" class="headerlink" title="playbook中的notify和handler"></a>playbook中的notify和handler</h2><p>当执行一个playbook时，第一次执行和第二次执行效果相同，当服务的配置文件发生变化时再次安装时已经启动的服务不会重启，此时就需要使用到notify。</p>
<p>notify的action可用于在每个play的最后被触发，这样可以避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。  </p>
<p>notify是触发条件，headlers是执行的任务</p>
<span id="more"></span>

<h3 id="notify和handler的使用方法"><a href="#notify和handler的使用方法" class="headerlink" title="notify和handler的使用方法"></a>notify和handler的使用方法</h3><p>此处以上一节中的httpd为例，刚才已经启动了HTTP服务，http的端口为8080，此时再次修改httpd.conf，将端口改为80</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim /data/httpd.conf</span></span><br><span class="line">Listen 80</span><br></pre></td></tr></table></figure>

<p>2.对yaml文件进行修改，增加notify及handlers</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim httpd.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#install httpd</span></span><br><span class="line">  - hosts: webserver</span><br><span class="line">    remote_user: root</span><br><span class="line"></span><br><span class="line">    tasks:</span><br><span class="line">      - name: install</span><br><span class="line">        yum: name=httpd</span><br><span class="line">      - name: config</span><br><span class="line">        copy: src=/data/httpd.conf dest=/etc/httpd/conf/httpd.conf</span><br><span class="line">        notify: restart service         <span class="comment">#此处设置notify当再次执行playbook时，配置文件发生改变，1将触发name为&quot;restart service&quot;的handers</span></span><br><span class="line">      - name: service</span><br><span class="line">        service: name=httpd state=started</span><br><span class="line"></span><br><span class="line">    handlers:</span><br><span class="line">      - name: restart service</span><br><span class="line">        service: name=httpd state=restarted</span><br></pre></td></tr></table></figure>

<p>3.检查语法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -C httpd.yaml</span></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [install] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [config] ***************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [service] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [restart service] *******************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=5    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>4.执行playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook  httpd.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [install] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [config] ***************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [service] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [restart service] *******************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=5    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>5.验证远程服务器上的端口是否变为80</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ss -tnl |grep 80&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128         :::80                      :::*  </span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128         :::80                      :::*  </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（六）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--6/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E5%85%AD%EF%BC%89/</url>
    <content><![CDATA[<h2 id="ansible-playbook中标签的使用-tags"><a href="#ansible-playbook中标签的使用-tags" class="headerlink" title="ansible-playbook中标签的使用 tags"></a>ansible-playbook中标签的使用 tags</h2><p>在某些情况下，我们可能只需要选择性的执行playbook中的某一部分，这时候就需要用到playbook的标签(tags)功能，在playbook中添加标签可以让playbook在运行时选择性的执行被标签的内容。</p>
<span id="more"></span>

<h3 id="playbook中标签的使用"><a href="#playbook中标签的使用" class="headerlink" title="playbook中标签的使用"></a>playbook中标签的使用</h3><p>此处沿用上一节中所使用的httpd的yaml文件，再次将httpd.conf文件进行修改，上一节中httpd的端口从8080改为了80，在这里再次将端口从80改为8080。</p>
<p>修改httpd端口，将其改为8080</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim httpd.conf</span></span><br><span class="line">Listen 8080         <span class="comment">#在配置文件中找到Listen，修改为8080</span></span><br></pre></td></tr></table></figure>

<p>编辑yaml文件，对文件内的内容贴标签</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim httpd.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#install httpd</span></span><br><span class="line">  - hosts: webserver</span><br><span class="line">    remote_user: root</span><br><span class="line"></span><br><span class="line">    tasks:</span><br><span class="line">      - name: install</span><br><span class="line">        yum: name=httpd</span><br><span class="line">      - name: config</span><br><span class="line">        copy: src=/data/httpd.conf dest=/etc/httpd/conf/httpd.conf</span><br><span class="line">        notify: restart service</span><br><span class="line">        tags: config        <span class="comment">#将config段贴上标签</span></span><br><span class="line">      - name: service</span><br><span class="line">        service: name=httpd state=started</span><br><span class="line"></span><br><span class="line">    handlers:</span><br><span class="line">      - name: restart service</span><br><span class="line">        service: name=httpd state=restarted</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由于此时http服务已经安装，不需要再次安装此服务，我们只需要执行被标签的config部分就行，标签的config执行时，触发了handler的重启服务。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用ansible-playbook -t 选项指定标签名字，就能执行指定的标签</span></span><br><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -t config httpd.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [config] ***************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [restart service] *******************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=3    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=3    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>验证远程服务器端口是否被改为8080</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ss -tnl |grep 8080&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128         :::8080                    :::*</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128         :::8080                    :::*  </span><br></pre></td></tr></table></figure>

<h3 id="playbook多标签的使用"><a href="#playbook多标签的使用" class="headerlink" title="playbook多标签的使用"></a>playbook多标签的使用</h3><p>我们可以在yaml文件中使用多个不同的标签，也可以使用多个相同的标签，让playbook执行标签时一次执行多个不同的操作，从而实现按类来进行执行被标签的内容。</p>
<p>再次修改http端口将其改为80端口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@ansible data]<span class="comment"># vim httpd.conf</span></span><br><span class="line">Listen 80</span><br></pre></td></tr></table></figure>

<p>创建yaml文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim httpd.yaml</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment">#install httpd</span></span><br><span class="line">  - hosts: webserver</span><br><span class="line">    remote_user: root</span><br><span class="line"></span><br><span class="line">    tasks:</span><br><span class="line">      - name: install</span><br><span class="line">        yum: name=httpd</span><br><span class="line">      - name: config</span><br><span class="line">        copy: src=/data/httpd.conf dest=/etc/httpd/conf/httpd.conf</span><br><span class="line">        tags: config        <span class="comment">#对config贴上config标签</span></span><br><span class="line">      - name: service       <span class="comment">#service和restart service的标签相同，不再使用notify和handlers来触发服务的重启</span></span><br><span class="line">        service: name=httpd state=started</span><br><span class="line">        tags: service</span><br><span class="line">      - name: restart service</span><br><span class="line">        service: name=httpd state=restarted</span><br><span class="line">        tags: service</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由于没有了notify和handlers，再次执行playbook需要将config标签和service标签一起执行，此时playbook就会将service和restart service全部都执行一遍</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -t config -t service httpd.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [config] ***************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [service] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [restart service] ******************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=4    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=4    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>验证端口是否被更改为了80</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ss -tnl |grep 80&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128         :::80                      :::*</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128         :::80                      :::*</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（七）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--7/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E4%B8%83%EF%BC%89/</url>
    <content><![CDATA[<h2 id="Ansible-playbook中的变量"><a href="#Ansible-playbook中的变量" class="headerlink" title="Ansible-playbook中的变量"></a>Ansible-playbook中的变量</h2><p>在ansible的playbook中还可以使用变量，变量的命名必须符合其规则，仅能由字母、数字和下划线组成，且只能以字母开头。</p>
<p>Playbook中变量可以通过以下几种方法进行定义：</p>
<span id="more"></span>

<ol>
<li>Ansible setup facts中已经定义好的变量</li>
<li>主机清单中定义变量</li>
<li>命令行下使用-e选项定义变量</li>
<li>在剧本中定义变量  </li>
<li>变量定义在一个专用的变量文件中</li>
</ol>
<h3 id="ansible-setup-facts-远程主机的所有变量都可直接调用"><a href="#ansible-setup-facts-远程主机的所有变量都可直接调用" class="headerlink" title="ansible setup facts 远程主机的所有变量都可直接调用"></a>ansible setup facts 远程主机的所有变量都可直接调用</h3><p>使用ansible的setup模块可以查看远程主机上的所有变量，然后在yaml文件中直接进行调用。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible HOSTLIST -m setup</span><br></pre></td></tr></table></figure>

<p>此命令可以查看远程主机上所有已存在的各种变量，此处查看hostname的变量名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -m setup -a &#x27;filter=*hostname&#x27;</span></span><br><span class="line">192.168.73.134 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ansible_hostname&quot;</span>: <span class="string">&quot;mylinuxops&quot;</span>        <span class="comment">#此处查到hostname的变量名为ansible_hostname，在ansible的playbook中调用变量时就调用此变量名</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.73.135 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ansible_hostname&quot;</span>: <span class="string">&quot;web2&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建yaml文件，调用变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim var.yaml</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment">#test var</span></span><br><span class="line">    - hosts: webserver</span><br><span class="line">      remote_user: root</span><br><span class="line"></span><br><span class="line">      tasks:</span><br><span class="line">        - name: file</span><br><span class="line">          file: name=&#123;&#123;ansible_hostname&#125;&#125;.<span class="built_in">log</span> state=touch       <span class="comment">#此处以ansible_hostname这个变量名创建出一个文件</span></span><br></pre></td></tr></table></figure>

<p>执行yaml</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook var.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [file] *****************************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>验证，查看远程主机root目录下是否创建出以主机名为文件名的log文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ls  /root&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">mylinuxops.log          <span class="comment">#使用变量创建出的微博华北</span></span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">web2.log                <span class="comment">#使用变量创建出的文件</span></span><br></pre></td></tr></table></figure>

<h3 id="变量定义在主机清单中"><a href="#变量定义在主机清单中" class="headerlink" title="变量定义在主机清单中"></a>变量定义在主机清单中</h3><p>在ansible中变量可以预先定义在主机清单中，而主机清单中的变量又分为两种，普通变量和公共变量。</p>
<p>普通变量：主机组中主机单独定义，优先级高于公共变量  </p>
<p>公共变量：针对主机组中所有主机定义的统一变量  </p>
<p>示例：  </p>
<p>修改主机清单，在主机清单中定义变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim /etc/ansible/hosts</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.73.134 port=80      <span class="comment">#定义主机134的变量port值为80</span></span><br><span class="line">192.168.73.135 port=8080    <span class="comment">#定义主机135的变量port值为8080</span></span><br><span class="line"></span><br><span class="line">[webserver:vars]    <span class="comment">#通用变量</span></span><br><span class="line">mark=<span class="string">&quot;-&quot;</span>        <span class="comment">#定义通用变量mark的值为-</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim var.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#test var</span></span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: file</span><br><span class="line">      file: name=&#123;&#123;ansible_hostname&#125;&#125;&#123;&#123;mask&#125;&#125;&#123;&#123;port&#125;&#125;.<span class="built_in">log</span> state=touch       <span class="comment">#利用变量创建出一个以&quot;HOSTNAME-PORT.log&quot;这中格式的文件。</span></span><br></pre></td></tr></table></figure>

<p>执行playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook var.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [file] *****************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=2    changed=1    unreachable=0    failed=0  </span><br></pre></td></tr></table></figure>

<p>验证，查看root目录下文件是否被创建出来</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ls /root&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">web2-8080.log</span><br><span class="line">web2.log</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">mylinuxops-80.log</span><br><span class="line">mylinuxops.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#根据事先定义好的变量，134的主机名为mylinuxops,port值为80，创建出的文件为mylinuxops-80.log。134的主机名为web2,port值为8080，创建出的文件为mylinuxops-8080.log。</span></span><br></pre></td></tr></table></figure>

<h3 id="命令行下使用-e选项定义变量"><a href="#命令行下使用-e选项定义变量" class="headerlink" title="命令行下使用-e选项定义变量"></a>命令行下使用-e选项定义变量</h3><p>在ansible-playbook中可以使用-e选项来定义变量，</p>
<p>示例：  </p>
<p>此处依旧使用刚才的剧本，直接在命令行添加-e选项来定义变量，此处定义的变量为port，此处注意在主机清单列表中所定义的port变量没有删除，用来观察变量的优先级。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook -e port=1234 var.yaml     #在执行playbook时定义port值为1234</span></span><br><span class="line"> [WARNING]: Found variable using reserved name: port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [file] *****************************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>验证创建出的文件名的port变量的值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ls /root&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">web2-1234.log       <span class="comment">#此为新创建出的文件</span></span><br><span class="line">web2-8080.log</span><br><span class="line">web2.log</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">mylinuxops-1234.log     <span class="comment">#此为新创建出的文件</span></span><br><span class="line">mylinuxops-80.log</span><br><span class="line">mylinuxops.log</span><br></pre></td></tr></table></figure>

<p>由此可以发现，通过命令行指定的变量优先级高于主机文件中定义的变量</p>
<h3 id="剧本中定义变量"><a href="#剧本中定义变量" class="headerlink" title="剧本中定义变量"></a>剧本中定义变量</h3><p>playbook的变量可以直接定义在yaml文件中，其定义格式如下。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vars:  </span><br><span class="line">  -var1:value1  </span><br><span class="line">  -var2:value2  </span><br></pre></td></tr></table></figure>

<p>示例：  </p>
<p>在playbook中定义变量port，此处主机列表中所定义的port变量依旧没有被删除</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim var.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#test var</span></span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line">  var:</span><br><span class="line">    - port: 4321    <span class="comment">#定义port的值为4321</span></span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: file</span><br><span class="line">      file: name=&#123;&#123;ansible_hostname&#125;&#125;&#123;&#123;mark&#125;&#125;&#123;&#123;port&#125;&#125;.<span class="built_in">log</span> state=touch</span><br></pre></td></tr></table></figure>

<p>执行playbook，创建出文件。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook  var.yaml</span></span><br><span class="line"> [WARNING]: Found variable using reserved name: port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [file] *****************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>验证port定义的值的文件是否被创建</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ls /root&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">mylinuxops-1234.log</span><br><span class="line">mylinuxops-4321.log     <span class="comment">#创建出的新文件</span></span><br><span class="line">mylinuxops-80.log</span><br><span class="line">mylinuxops.log</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">web2-1234.log</span><br><span class="line">web2-4321.log          <span class="comment">#创建出的新文件</span></span><br><span class="line">web2-8080.log</span><br><span class="line">web2.log</span><br></pre></td></tr></table></figure>

<p>由于新的文件被创建出来，由此可以得出剧本中的变量优先级高于主机清单中的变量</p>
<h3 id="变量定义在一个专用的变量文件中"><a href="#变量定义在一个专用的变量文件中" class="headerlink" title="变量定义在一个专用的变量文件中"></a>变量定义在一个专用的变量文件中</h3><p>playbook的变量可以定义在一个单独的yaml文件中，然后在剧本中调用此文件从而实现变量的调用。</p>
<p>示例：  </p>
<p>创建一个存放变量的文件，在文件中定义好变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim vars.yml</span></span><br><span class="line">port: 9527      <span class="comment">#定义port的值为9527</span></span><br></pre></td></tr></table></figure>

<p>在playbook中调用变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim var.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#test var</span></span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars_files:       <span class="comment">#使用vars_files来调用vars.yml这个变量文件</span></span><br><span class="line">    - vars.yml</span><br><span class="line">  vars:             <span class="comment">#此处注意上一步中所定义的port变量以及主机列表中所定义的port并没有被清除，用来验证变量的优先级</span></span><br><span class="line">    - port: 4321</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: file</span><br><span class="line">      file: name=&#123;&#123;ansible_hostname&#125;&#125;&#123;&#123;mark&#125;&#125;&#123;&#123;port&#125;&#125;.<span class="built_in">log</span> state=touch</span><br></pre></td></tr></table></figure>

<p>执行playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible-playbook  var.yaml</span></span><br><span class="line"> [WARNING]: Found variable using reserved name: port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [file] *****************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>验证新的文件文件是否被创建</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible webserver -a &#x27;ls /root&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">web2-1234.log</span><br><span class="line">web2-4321.log</span><br><span class="line">web2-8080.log</span><br><span class="line">web2-9527.log           <span class="comment">#此为新的文件</span></span><br><span class="line">web2.log</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">mylinuxops-1234.log</span><br><span class="line">mylinuxops-4321.log</span><br><span class="line">mylinuxops-80.log</span><br><span class="line">mylinuxops-9527.log     <span class="comment">#此为新的文件</span></span><br><span class="line">mylinuxops.log</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由此可见使用变量文件定义的变量优先级高于playbook中定义的变量</p>
<p>以上就是playbook中定义变量的各种方法，变量在使用中的优先级关系为：</p>
<p>命令行-e指定 &gt; 变量文件 &gt; playbook指定 &gt; hosts文件</p>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（八）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--8/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E5%85%AB%EF%BC%89/</url>
    <content><![CDATA[<h2 id="ansible的模板template"><a href="#ansible的模板template" class="headerlink" title="ansible的模板template"></a>ansible的模板template</h2><p>在某些环境下可能会出现这种情况，比如主机A配置文件中的某个值为1，主机B配置文件中此值为2，现在需要将此值在现有的基础上再加上2，此时ansible的模板就发挥其作用了，template可以根据模块文件动态生成相对应的配置文件。</p>
<h3 id="template的格式要求"><a href="#template的格式要求" class="headerlink" title="template的格式要求"></a>template的格式要求</h3><p>template对文件的存放和命名有要求，template文件必须存放在templates目录下，并且以.j2后缀命名。  </p>
<p>yaml文件需要和templates目录平级，目录结构如下。</p>
<span id="more"></span>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># tree yaml/</span></span><br><span class="line">yaml/</span><br><span class="line">├── hello.yaml</span><br><span class="line">├── httpd.yaml</span><br><span class="line">└── templates</span><br><span class="line">    └── test.conf.j2</span><br></pre></td></tr></table></figure>

<h3 id="template的使用方法"><a href="#template的使用方法" class="headerlink" title="template的使用方法"></a>template的使用方法</h3><h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h4><p>此处以nginx为例，编写playbook为主机列表中的主机安装nginx  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># vim nginx.yml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#install nginx</span></span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: package</span><br><span class="line">      yum: name=nginx</span><br><span class="line">    - name: service</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br></pre></td></tr></table></figure>

<p>执行playbook，在hosts列表中的主机上部署nginx服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># ansible-playbook nginx.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [package] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [service] **************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=3    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h4 id="template使用示例一"><a href="#template使用示例一" class="headerlink" title="template使用示例一"></a>template使用示例一</h4><p>基础环境部署完毕，现在需要使用模板文件实现让nginx在运行时创建出cpu个数+2的进程数，模板文件的配置方法如下：  </p>
<p>1.获取nginx的配置文件，并改名为.j2后缀的文件存放在templates目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># mv nginx.conf /data/yaml/templates/nginx.conf.j2</span></span><br></pre></td></tr></table></figure>

<p>2.获取cpu个数的变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># ansible 192.168.73.134 -m setup | grep cpu</span></span><br><span class="line">        <span class="string">&quot;ansible_processor_vcpus&quot;</span>: 1,  <span class="comment">#此为定义cpu的变量</span></span><br></pre></td></tr></table></figure>

<p>3.修改模板文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible data]<span class="comment"># vim yaml/templates/nginx.conf.j2</span></span><br><span class="line">worker_processes &#123;&#123;ansible_processor_vcpus+2&#125;&#125;;  <span class="comment">#此行定义了线程数，改为变量代替</span></span><br></pre></td></tr></table></figure>

<p>4.在playbook中引用模板</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim nginx.yml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#install nginx</span></span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: package</span><br><span class="line">      yum: name=nginx</span><br><span class="line">    - name: config</span><br><span class="line">      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf        <span class="comment">#在配置文件段引用模板文件。</span></span><br><span class="line">      notify: restart service</span><br><span class="line">    - name: service</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart service</span><br><span class="line">      service: name=nginx state=restarted</span><br></pre></td></tr></table></figure>

<p>5.执行playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible-playbook nginx.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [package] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [config] ***************************************************************************************************</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [service] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [restart service] *******************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=5    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>验证线程个数是否改变</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible webserver -a &#x27;cat /etc/nginx/nginx.conf | grep work&#x27;</span></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">worker_processes 3;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">worker_processes 3;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line"></span><br><span class="line"><span class="comment">#由于此处2台主机的cpu核心书都为1，所以显示出的工作线程数为3</span></span><br></pre></td></tr></table></figure>

<h4 id="template使用实例二"><a href="#template使用实例二" class="headerlink" title="template使用实例二"></a>template使用实例二</h4><p>配置刚才所部署的nginx服务，让192.168.73.134主机上的nginx监听在80端口，192.168.73.135主机上的nginx服务监听在8080端口上。</p>
<p>1.修改模板中的端口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim templates/nginx.conf.j2</span></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       &#123;&#123;port&#125;&#125; default_server; 将此处的端口改为变量</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.修改主机文件定义port</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment">#  vim /etc/hosts</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.73.134 port=80          <span class="comment">#定义192.168.73.134主机的port变量值为80</span></span><br><span class="line">192.168.73.135 port=8080        <span class="comment">#定义192.168.73.135主机的port变量值为8080</span></span><br></pre></td></tr></table></figure>

<p>3.重新执行yaml</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible-playbook nginx.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [package] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [config] ***************************************************************************************************</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [service] **************************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [restart service] *******************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.134             : ok=4    changed=0    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>验证两台主机上nginx服务是否监听在模板中所定义的端口上</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible webserver -a &#x27;ss -tnl |grep 80&#x27;</span></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128          *:80                       *:*</span><br><span class="line">LISTEN     0      128         :::80                      :::*</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">LISTEN     0      128          *:8080                     *:*</span><br><span class="line">LISTEN     0      128         :::80                      :::*  </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化运维之Ansible（九）</title>
    <url>/2019/03/16/Ansible/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible--9/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible%EF%BC%88%E4%B9%9D%EF%BC%89/</url>
    <content><![CDATA[<h2 id="Ansible-playbook中的流控制"><a href="#Ansible-playbook中的流控制" class="headerlink" title="Ansible-playbook中的流控制"></a>Ansible-playbook中的流控制</h2><p>在ansible中的有各种流控制的机制，本节主要讲ansible流控制中的when和with_item</p>
<span id="more"></span>

<h3 id="流控制when"><a href="#流控制when" class="headerlink" title="流控制when"></a>流控制when</h3><p>在使用ansible做自动化运维的时候，大多数情况下都执行某些任务的时候都需要依赖某个变量的值或者是上一个任务的执行结果。如，根据facts信息中的系统版本相关的信息来确定使用哪种包管理器安装软件。Ansible提供when语句，可以控制任务的执行流程。</p>
<h4 id="playbook中when的使用"><a href="#playbook中when的使用" class="headerlink" title="playbook中when的使用"></a>playbook中when的使用</h4><p>when测试条件：如果需要根据变量、facts或此前任务的执行结果来作为某task执行与否的前提条件时，需要用到条件测试，通过when语句实现，在task中使用，jinja2语法。  </p>
<h4 id="when使用实战"><a href="#when使用实战" class="headerlink" title="when使用实战"></a>when使用实战</h4><p>当系统不同时，httpd的配置文件也不同，根据系统的版本来判断使用哪个httpd的配置文件</p>
<p>1.使用setup模块找远程系统中版本变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible webserver -m setup | grep distribution_major_version</span></span><br><span class="line">        <span class="string">&quot;ansible_distribution_major_version&quot;</span>: <span class="string">&quot;6&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ansible_distribution_major_version&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ansible_distribution_major_version&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br></pre></td></tr></table></figure>

<p>2.根据变量值编写yaml文件，使用when来判断变量的值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim httpd.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#install httpd</span></span><br><span class="line">  - hosts: webserver</span><br><span class="line">    remote_user: root</span><br><span class="line"></span><br><span class="line">    tasks:</span><br><span class="line">      - name: install</span><br><span class="line">        yum: name=httpd</span><br><span class="line">      - name: config</span><br><span class="line">        template: src=httpd6.conf.j2 dest=/etc/httpd/conf/httpd.conf</span><br><span class="line">        when: ansible_distribution_major_version == <span class="string">&quot;6&quot;</span>     <span class="comment">#判断系统版本的值当系统版本为6时使用http6.conf.j2的模板</span></span><br><span class="line">        notify: restart service</span><br><span class="line">      - name: config</span><br><span class="line">        template: src=httpd7.conf.j2 dest=/etc/httpd/conf/httpd.conf</span><br><span class="line">        when: ansible_distribution_major_version == <span class="string">&quot;7&quot;</span>     <span class="comment">#判断系统版本的值当系统版本为7时使用http7.conf.j2的模板</span></span><br><span class="line">        notify: restart service</span><br><span class="line">      - name: service</span><br><span class="line">        service: name=httpd state=started</span><br><span class="line"></span><br><span class="line">    handlers:</span><br><span class="line">      - name: restart service</span><br><span class="line">        service: name=httpd state=restarted</span><br></pre></td></tr></table></figure>

<p>3.修改模板文件，将监听的端口改为变量的形式</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible templates]<span class="comment"># vi httpd6.conf.j2</span></span><br><span class="line"><span class="comment">#Listen 12.34.56.78:80</span></span><br><span class="line">Listen &#123;&#123;port&#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@ansible templates]<span class="comment"># vi httpd7.conf.j2</span></span><br><span class="line"><span class="comment">#Listen 12.34.56.78:80</span></span><br><span class="line">Listen &#123;&#123;port&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.执行脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible-playbook  httpd.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [install] **************************************************************************************************</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [config] ***************************************************************************************************</span><br><span class="line">skipping: [192.168.73.134]</span><br><span class="line">skipping: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line"></span><br><span class="line">TASK [config] ***************************************************************************************************</span><br><span class="line">skipping: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [service] **************************************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line">changed: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [restart service] *******************************************************************************</span><br><span class="line">changed: [192.168.73.132]</span><br><span class="line">changed: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=5    changed=4    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=4    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=5    changed=4    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>这样在部署httpd服务时候就会更具系统的版本号使用不同的配置文件。</p>
<h3 id="with-items"><a href="#with-items" class="headerlink" title="with_items"></a>with_items</h3><p>迭代：当有需要重复行执行的任务时，可以使用迭代机制</p>
<p>对迭代项的引用，固定变量名为”item”  </p>
<p>要在task中使用with_items给定要迭代的元素列表  </p>
<p>列表格式：字符串、字典</p>
<h4 id="with-items使用示例"><a href="#with-items使用示例" class="headerlink" title="with_items使用示例"></a>with_items使用示例</h4><h5 id="使用with-items创建文件"><a href="#使用with-items创建文件" class="headerlink" title="使用with_items创建文件"></a>使用with_items创建文件</h5><p>在远程主机上创建以下多个文件，可以看出这些文件都有一个特征都是以”.log”结尾，如此只需要将之前的文件使用变量代替，然后使用with_items给定元素列表就能创建出相应的文件了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">aaa.log  </span><br><span class="line">bbb.log  </span><br><span class="line">ccc.log  </span><br></pre></td></tr></table></figure>

<p>1.创建剧本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim file.yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#touch file</span></span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: touch file</span><br><span class="line">      file: name=/data/&#123;&#123;item&#125;&#125;.<span class="built_in">log</span> state=touch     <span class="comment">#将需要重复创建的*.log文件的文件名使用item这个变量代替</span></span><br><span class="line">      with_items:     <span class="comment">#hwith_item列表中写入所有需要创建出的文件名。</span></span><br><span class="line">        - aaa</span><br><span class="line">        - bbb</span><br><span class="line">        - ccc</span><br></pre></td></tr></table></figure>

<p>2.执行剧本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible-playbook  file.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line"></span><br><span class="line">TASK [touch file] ***********************************************************************************************</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=aaa)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=aaa)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=aaa)</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=bbb)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=bbb)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=bbb)</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=ccc)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=ccc)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=ccc)</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>校验查看远程主机上的文件是否被创建</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible webserver -a &#x27;ls /data&#x27;</span></span><br><span class="line">192.168.73.132 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">aaa.log             <span class="comment">#三个文件已经被创建出来</span></span><br><span class="line">bbb.log</span><br><span class="line">ccc.log</span><br><span class="line">lost+found</span><br></pre></td></tr></table></figure>

<h5 id="使用with-items创建用户"><a href="#使用with-items创建用户" class="headerlink" title="使用with_items创建用户"></a>使用with_items创建用户</h5><p>在批量创建用户将账户时也可以使用with_items来创建用户，具体使用方法如下</p>
<p>1.创建yaml文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@ansible yaml]<span class="comment"># vim createuser.yml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#createuser</span></span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: create user</span><br><span class="line">      user: name=&#123;&#123;item&#125;&#125;   <span class="comment">#将用户名使用item变量来代替</span></span><br><span class="line">      with_items:         <span class="comment">#使用with_items来列出所有需要创建的用户</span></span><br><span class="line">        - alice</span><br><span class="line">        - bob</span><br><span class="line">        - clack</span><br></pre></td></tr></table></figure>

<p>2.执行playbook</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible-playbook createuser.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [create user] **********************************************************************************************</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=alice)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=alice)</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=alice)</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=bob)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=bob)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=bob)</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=clack)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=clack)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=clack)</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>3.验证远程主机上的用户已经被创建</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible webserver -a &#x27;getent passwd | tail -3&#x27;</span></span><br><span class="line">192.168.73.132 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">alice:x:500:500::/home/alice:/bin/bash</span><br><span class="line">bob:x:501:501::/home/bob:/bin/bash</span><br><span class="line">clack:x:502:502::/home/clack:/bin/bash</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">alice:x:3307:3307::/home/alice:/bin/bash</span><br><span class="line">bob:x:3308:3308::/home/bob:/bin/bash</span><br><span class="line">clack:x:3309:3309::/home/clack:/bin/bash</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">alice:x:3307:3307::/home/alice:/bin/bash</span><br><span class="line">bob:x:3308:3308::/home/bob:/bin/bash</span><br><span class="line">clack:x:3309:3309::/home/clack:/bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="with-items的高级用法"><a href="#with-items的高级用法" class="headerlink" title="with_items的高级用法"></a>with_items的高级用法</h3><p>当多个类型的item之间有对应的关系时，可以使用字典的形式将多个item项进行关联起来</p>
<h4 id="with-items的字典用法"><a href="#with-items的字典用法" class="headerlink" title="with_items的字典用法"></a>with_items的字典用法</h4><p>创建组和用户的对应关系，将用户关联到对应的用户组下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">USER        GROUP</span><br><span class="line">aaa         agroup</span><br><span class="line">bbb         bgroup</span><br><span class="line">ccc         cgroup</span><br></pre></td></tr></table></figure>

<p>1.编辑yaml文件，将用户名和组名做字典对应</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># vim usergroup.yaml</span></span><br><span class="line">---</span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: create group</span><br><span class="line">      group: name=&#123;&#123;item&#125;&#125;        <span class="comment">#将组名定义为变量</span></span><br><span class="line">      with_items:           <span class="comment">#将需要创建的组写在with_items下</span></span><br><span class="line">        - agroup  </span><br><span class="line">        - bgroup</span><br><span class="line">        - cgroup</span><br><span class="line">    - name: create user</span><br><span class="line">      user: name=&#123;&#123;item.name&#125;&#125; group=&#123;&#123;item.group&#125;&#125;     <span class="comment">#创建用户并和组进行关联，使用以“item.*&quot;形式的变量将用户和组进行关联起来</span></span><br><span class="line">      with_item:                  <span class="comment">#在with_items写入name和group的字典关系</span></span><br><span class="line">        - &#123; name: <span class="string">&quot;aaa&quot;</span>,group: <span class="string">&quot;agroup&quot;</span>&#125;</span><br><span class="line">        - &#123; name: <span class="string">&quot;bbb&quot;</span>,group: <span class="string">&quot;bgroup&quot;</span>&#125;</span><br><span class="line">        - &#123; name: <span class="string">&quot;ccc&quot;</span>,group: <span class="string">&quot;cgroup&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>2.执行剧本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible-playbook usergroup.yaml</span></span><br><span class="line"></span><br><span class="line">PLAY [webserver] ************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************</span><br><span class="line">ok: [192.168.73.135]</span><br><span class="line">ok: [192.168.73.132]</span><br><span class="line">ok: [192.168.73.134]</span><br><span class="line"></span><br><span class="line">TASK [create group] *********************************************************************************************</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=agroup)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=agroup)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=agroup)</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=bgroup)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=bgroup)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=bgroup)</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=cgroup)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=cgroup)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=cgroup)</span><br><span class="line"></span><br><span class="line">TASK [create user] **********************************************************************************************</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=&#123;u<span class="string">&#x27;group&#x27;</span>: u<span class="string">&#x27;agroup&#x27;</span>, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;aaa&#x27;</span>&#125;)</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=&#123;u<span class="string">&#x27;group&#x27;</span>: u<span class="string">&#x27;agroup&#x27;</span>, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;aaa&#x27;</span>&#125;)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=&#123;u<span class="string">&#x27;group&#x27;</span>: u<span class="string">&#x27;agroup&#x27;</span>, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;aaa&#x27;</span>&#125;)</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=&#123;u<span class="string">&#x27;group&#x27;</span>: u<span class="string">&#x27;bgroup&#x27;</span>, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;bbb&#x27;</span>&#125;)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=&#123;u<span class="string">&#x27;group&#x27;</span>: u<span class="string">&#x27;bgroup&#x27;</span>, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;bbb&#x27;</span>&#125;)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=&#123;u<span class="string">&#x27;group&#x27;</span>: u<span class="string">&#x27;bgroup&#x27;</span>, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;bbb&#x27;</span>&#125;)</span><br><span class="line">changed: [192.168.73.132] =&gt; (item=&#123;u<span class="string">&#x27;group&#x27;</span>: u<span class="string">&#x27;cgroup&#x27;</span>, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;ccc&#x27;</span>&#125;)</span><br><span class="line">changed: [192.168.73.134] =&gt; (item=&#123;u<span class="string">&#x27;group&#x27;</span>: u<span class="string">&#x27;cgroup&#x27;</span>, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;ccc&#x27;</span>&#125;)</span><br><span class="line">changed: [192.168.73.135] =&gt; (item=&#123;u<span class="string">&#x27;group&#x27;</span>: u<span class="string">&#x27;cgroup&#x27;</span>, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;ccc&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************</span><br><span class="line">192.168.73.132             : ok=3    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.134             : ok=3    changed=2    unreachable=0    failed=0</span><br><span class="line">192.168.73.135             : ok=3    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>校验查看远程主机上的用户是否和组进行了关联</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible yaml]<span class="comment"># ansible webserver -a &#x27;id aaa&#x27;</span></span><br><span class="line">192.168.73.132 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">uid=503(aaa) gid=503(agroup) groups=503(agroup)</span><br><span class="line"></span><br><span class="line">192.168.73.134 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">uid=3310(aaa) gid=3310(agroup) groups=3310(agroup)</span><br><span class="line"></span><br><span class="line">192.168.73.135 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">uid=3310(aaa) gid=3310(agroup) groups=3310(agroup)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Ansible</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab实现代码自动部署</title>
    <url>/2019/05/04/CICD/jenkins+gitlab/jenkins+gitlab/</url>
    <content><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><table>
<thead>
<tr>
<th align="left">Hostname</th>
<th align="left">Server</th>
<th align="left">IP</th>
<th align="left">OS</th>
</tr>
</thead>
<tbody><tr>
<td align="left">gitlab</td>
<td align="left">Gitlab</td>
<td align="left">192.168.27.11</td>
<td align="left">ubuntu 18.04.2</td>
</tr>
<tr>
<td align="left">jenkins</td>
<td align="left">Jenkins</td>
<td align="left">192.168.27.12</td>
<td align="left">ubuntu 18.04.2</td>
</tr>
<tr>
<td align="left">haproxy-1</td>
<td align="left">haproxy</td>
<td align="left">192.168.27.21</td>
<td align="left">ubuntu 18.04.2</td>
</tr>
<tr>
<td align="left">haproxy-2</td>
<td align="left">haproxy</td>
<td align="left">192.168.27.22</td>
<td align="left">ubuntu 18.04.2</td>
</tr>
<tr>
<td align="left">tomcat-1</td>
<td align="left">tomcat</td>
<td align="left">192.168.27.31</td>
<td align="left">ubuntu 18.04.2</td>
</tr>
<tr>
<td align="left">tomcat-2</td>
<td align="left">tomcat</td>
<td align="left">192.168.27.32</td>
<td align="left">ubuntu 18.04.2</td>
</tr>
</tbody></table>
<hr>
<h2 id="安装jdk环境"><a href="#安装jdk环境" class="headerlink" title="安装jdk环境"></a>安装jdk环境</h2><p>分别在jenkins、tomcat-1、tomcat-2主机上安装jdk环境</p>
<p>oracle官网下载jdk，上传到本地服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># ls</span></span><br><span class="line">jdk-8u212-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压jdk到/usr/local/src目录下，做一个软连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar xf jdk-8u212-linux-x64.tar.gz -C /usr/<span class="built_in">local</span>/src/</span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/src/jdk1.8.0_212 /usr/<span class="built_in">local</span>/jdk</span><br></pre></td></tr></table></figure>

<p>编辑/etc/profile文件添加环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># vim /etc/profile</span></span><br><span class="line"><span class="built_in">export</span> HISTTIMEFORMAT=<span class="string">&quot;%F %t `whoami` &quot;</span></span><br><span class="line"><span class="built_in">export</span> <span class="built_in">export</span> LANG=<span class="string">&quot;en_US.utf-8&quot;</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br></pre></td></tr></table></figure>

<p>重读环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>使用java命令测试jdk环境</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java version <span class="string">&quot;1.8.0_212&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_212-b10)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.212-b10, mixed mode)</span><br></pre></td></tr></table></figure>

<p>为java做各软链接，Jenkins需要在/usr/bin/下存在java否则将报错</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ln -sv /usr/<span class="built_in">local</span>/jdk/bin/java /usr/bin</span><br></pre></td></tr></table></figure>

<p>jdk环境配置完毕</p>
<h2 id="部署tomcat"><a href="#部署tomcat" class="headerlink" title="部署tomcat"></a>部署tomcat</h2><p>在tomcat-1和tomcat-2主机上部署tomcat服务</p>
<p>下载tomcat二进制包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.43/bin/apache-tomcat-8.5.43.tar.gz</span><br></pre></td></tr></table></figure>

<p>创建启动用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">useradd -u 2019 -m -s /bin/bash www</span><br></pre></td></tr></table></figure>

<p>创建apps目录将二进制安装包解压到目录内</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir /apps</span><br><span class="line">tar xf apache-tomcat-8.5.43.tar.gz -C /apps</span><br></pre></td></tr></table></figure>

<p>创建软连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ln -sv /apps/apache-tomcat-8.5.43 /apps/tomcat</span><br></pre></td></tr></table></figure>

<p>创建appdir和webdir两个目录，appdir用来保存代码的压缩包文件，webdir用来保存解压后的站点文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir /data/tomcat/tomcat_&#123;appdir,webdir/myapp&#125; -p</span><br></pre></td></tr></table></figure>

<p>修改tomcat配置文件重新指定代码目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /apps/tomcat/conf/server.xml </span><br><span class="line">      &lt;Host name=<span class="string">&quot;localhost&quot;</span>  appBase=<span class="string">&quot;/data/tomcat/tomcat_webdir&quot;</span></span><br><span class="line">            unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p>分别在两台主机上创建出测试页</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#tomcat-1</span></span><br><span class="line">root@tomcat-1:~<span class="comment"># echo &quot;welcome to mylinuxops.com tomcat-1&quot; &gt; /data/tomcat/tomcat_webdir/myapp/index.html</span></span><br><span class="line"><span class="comment">#tomcat-2</span></span><br><span class="line">root@tomcat-2:~<span class="comment"># echo &quot;welcome to mylinuxops.com tomcat-2&quot; &gt; /data/tomcat/tomcat_webdir/myapp/index.html</span></span><br></pre></td></tr></table></figure>

<p>将tomcat所有的文件属主和属组修改为www用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chown -R www.www /data/tomcat /apps/tomcat /apps/apache-tomcat-8.5.43</span><br></pre></td></tr></table></figure>

<p>使用普通用户启动tomcat</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su - www -c <span class="string">&quot;/apps/tomcat/bin/catalina.sh start&quot;</span></span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#访问tomcat-1</span></span><br><span class="line">root@tomcat-1:~<span class="comment"># curl 192.168.27.31:8080/myapp/index.html</span></span><br><span class="line">welcome to mylinuxops.com tomcat-1</span><br><span class="line"><span class="comment">#访问tomcat-2</span></span><br><span class="line">root@tomcat-1:~<span class="comment"># curl 192.168.27.32:8080/myapp/index.html</span></span><br><span class="line">welcome to mylinuxops.com tomcat-2</span><br></pre></td></tr></table></figure>

<h2 id="部署keepalived-haproxy"><a href="#部署keepalived-haproxy" class="headerlink" title="部署keepalived+haproxy"></a>部署keepalived+haproxy</h2><p>分别在27.21和27.22主机上安装keepalived和haproxy</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt install keepalived haproxy -y</span><br></pre></td></tr></table></figure>

<p>编辑keepalived配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@haproxy-1:~<span class="comment"># cp /usr/share/doc/keepalived/samples/keepalived.conf.sample /etc/keepalived/keepalived.conf</span></span><br></pre></td></tr></table></figure>

<h3 id="配置高可用"><a href="#配置高可用" class="headerlink" title="配置高可用"></a>配置高可用</h3><p>修改27.21上keepalived配置文件，配置vip</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@haproxy-1:~<span class="comment"># vim /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.27.248 dev eth0 label eth0:0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@haproxy-1:~<span class="comment"># systemctl restart keepalived</span></span><br></pre></td></tr></table></figure>

<p>修改27.22主上的keepalived配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@haproxy-2:~<span class="comment"># vim /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">  </span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 80</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.27.248 dev eth0 label eth0:0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@haproxy-2:~<span class="comment"># systemctl restart keepalived</span></span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>测试前</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#haproxy-1上有地址</span></span><br><span class="line">root@haproxy-1:~<span class="comment"># ifconfig eth0:0</span></span><br><span class="line">eth0:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.27.248  netmask 255.255.255.255  broadcast 0.0.0.0</span><br><span class="line">        ether 00:0c:29:93:86:2c  txqueuelen 1000  (Ethernet)</span><br><span class="line"><span class="comment">#haproxy-2上没有地址</span></span><br><span class="line">root@haproxy-2:~<span class="comment"># ifconfig eth0:0</span></span><br><span class="line">eth0:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        ether 00:0c:29:47:18:42  txqueuelen 1000  (Ethernet)</span><br></pre></td></tr></table></figure>
<p>将haproxy-1上的keepalived服务停止后</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#haproxy-1上没有地址</span></span><br><span class="line">root@haproxy-1:~<span class="comment"># ifconfig eth0:0</span></span><br><span class="line">eth0:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        ether 00:0c:29:93:86:2c  txqueuelen 1000  (Ethernet)</span><br><span class="line"><span class="comment">#地址漂移到haproxy-2上</span></span><br><span class="line">root@haproxy-2:~<span class="comment"># ifconfig eth0:0</span></span><br><span class="line">eth0:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.27.248  netmask 255.255.255.255  broadcast 0.0.0.0</span><br><span class="line">        ether 00:0c:29:47:18:42  txqueuelen 1000  (Ethernet)</span><br></pre></td></tr></table></figure>

<h3 id="配置haproxy"><a href="#配置haproxy" class="headerlink" title="配置haproxy"></a>配置haproxy</h3><p>分别编辑2台haproxy的配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@haproxy-2:~<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">listen myapp</span><br><span class="line">        <span class="built_in">bind</span> 192.168.27.248:80</span><br><span class="line">        mode http</span><br><span class="line">        server 192.168.27.31 192.168.27.31:8080 check inter 3s fall 3 rise 5</span><br><span class="line">        server 192.168.27.32 192.168.27.32:8080 check inter 3s fall 3 rise 5</span><br></pre></td></tr></table></figure>

<p>分别在2台haproxy上修改内核参数，启动nolocal_bind</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@haproxy-1:~<span class="comment"># echo &quot;net.ipv4.ip_nolocal_bind = 1&quot; &gt;&gt; /etc/sysctl.conf </span></span><br><span class="line">root@haproxy-1:~<span class="comment"># sysctl -p</span></span><br></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@haproxy-2:~<span class="comment"># ss -tnl | grep 80</span></span><br><span class="line">LISTEN   0         2000          192.168.27.248:80              0.0.0.0:*</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># curl 192.168.27.248/myapp/index.html</span></span><br><span class="line">welcome to mylinuxops.com tomcat-1</span><br><span class="line">root@jenkins:~<span class="comment"># curl 192.168.27.248/myapp/index.html</span></span><br><span class="line">welcome to mylinuxops.com tomcat-2</span><br></pre></td></tr></table></figure>

<h2 id="部署jenkins"><a href="#部署jenkins" class="headerlink" title="部署jenkins"></a>部署jenkins</h2><p>下载jenkins安装包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># wget https://pkg.jenkins.io/debian-stable/binary/jenkins_2.164.3_all.deb</span></span><br></pre></td></tr></table></figure>

<p>安装daemon守护进程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># apt install daemon -y</span></span><br></pre></td></tr></table></figure>

<p>安装jenkins</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># dpkg -i jenkins_2.164.3_all.deb</span></span><br></pre></td></tr></table></figure>

<p>修改jenkins配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># vim /etc/default/jenkins</span></span><br><span class="line"><span class="comment">#将启动账号设置为root</span></span><br><span class="line">JENKINS_USER=root</span><br><span class="line">JENKINS_GROUP=root</span><br><span class="line"><span class="comment"># 配置优化选项</span></span><br><span class="line">JAVA_ARGS=<span class="string">&quot;-server -Xms1g -Xmx1g -Xss512k -Xmn1g -XX:CMSInitiatingOccupancyFraction=65 -XX:+UseFastAccessorMethods -XX:+AggressiveOpts -XX:+UseBiasedLocking -XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10 -XX:NewSize=2048M -XX:MaxNewSize=2048M -XX:NewRatio=2 -XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5 -XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -Djava.awt.headless=true -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=12345 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=&quot;</span>192.168.27.12<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>重启服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># systemctl restart jenkins</span></span><br></pre></td></tr></table></figure>

<h3 id="Jenkins简单使用"><a href="#Jenkins简单使用" class="headerlink" title="Jenkins简单使用"></a>Jenkins简单使用</h3><p>使用web登录</p>
<p><img src="jenkins1.png" alt="jenkins1.png"></p>
<p>关于jenkins离线解决方法  </p>
<p>1.修改插件源地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /var/lib/jenkins/hudson.model.UpdateCenter.xml</span><br><span class="line">&lt;?xml version=<span class="string">&#x27;1.1&#x27;</span> encoding=<span class="string">&#x27;UTF-8&#x27;</span>?&gt;</span><br><span class="line">&lt;sites&gt;</span><br><span class="line">  &lt;site&gt;</span><br><span class="line">    &lt;id&gt;default&lt;/id&gt;</span><br><span class="line">    &lt;url&gt;http://updates.jenkins.io/update-center.json&lt;/url&gt;   <span class="comment">#将https改为http</span></span><br><span class="line">  &lt;/site&gt;</span><br><span class="line">&lt;/sites&gt;</span><br></pre></td></tr></table></figure>

<p>2.修改/var/lib/jenkins/updates/default.json文件将第一行的<a href="http://www.google.com改为www.baidu.com/">www.google.com改为www.baidu.com</a>  </p>
<p>3.重启jenkens服务  </p>
<p>安装插件</p>
<p><img src="jenkins2.png" alt="jenkins2.png"></p>
<p><img src="jenkins3.png" alt="jenkins3.png"></p>
<p>创建用户</p>
<p><img src="jenkins4.png" alt="jenkins4.png"></p>
<p><img src="jenkins5.png" alt="jenkins5.png"></p>
<p><img src="jenkins6.png" alt="jenkins6.png"></p>
<p>登录</p>
<p><img src="jenkins7.png" alt="jenkins7.png"></p>
<p>安装插件</p>
<p><img src="plugin1.png" alt="plugin1.png"></p>
<p><img src="plugin2.png" alt="plugin2.png"></p>
<p>按照以上方法分别安装上gitlab和blue ocean插件</p>
<h3 id="Jenkins权限管理"><a href="#Jenkins权限管理" class="headerlink" title="Jenkins权限管理"></a>Jenkins权限管理</h3><p>创建一个用户  </p>
<p><img src="user1.png" alt="user1.png"></p>
<p><img src="user2.png" alt="user2.png"></p>
<p><img src="user3.png" alt="user3.png"></p>
<p>Jenkins默认创建的用户可以执行任何操作，其权限与管理员相同，要将其权限加以控制就需要安装一个插件Role-based Authorization Strategy，将其授权的方式进行更改</p>
<p><img src="plugin3.png" alt="plugin3.png"></p>
<p>重启jenkins服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># systemctl restart jenkins</span></span><br></pre></td></tr></table></figure>

<p>更改授权方式</p>
<p><img src="secrity.png" alt="secrity.png"></p>
<p><img src="secrity1.png" alt="secrity1.png"></p>
<p>创建一个角色</p>
<p><img src="role1.png" alt="role1.png"></p>
<p><img src="role2.png" alt="role2.png"></p>
<p><img src="role3.png" alt="role3.png"></p>
<p><img src="role4.png" alt="role4.png"></p>
<p><img src="role5.png" alt="role5.png"></p>
<h3 id="jenkins邮件通知配置"><a href="#jenkins邮件通知配置" class="headerlink" title="jenkins邮件通知配置"></a>jenkins邮件通知配置</h3><p><img src="mail1.png" alt="mail1.png"></p>
<p><img src="mail2.png" alt="mail2.png"></p>
<p><img src="mail3.png" alt="mail3.png"></p>
<p><img src="mail4.png" alt="mail4.png"></p>
<h3 id="配置jenkins到gitlab拉取代码"><a href="#配置jenkins到gitlab拉取代码" class="headerlink" title="配置jenkins到gitlab拉取代码"></a>配置jenkins到gitlab拉取代码</h3><p>在jenkins服务器上生成ssh的公钥和私钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># ssh-keygen</span></span><br><span class="line"><span class="comment">#取出私钥文件内容</span></span><br><span class="line">root@jenkins:~<span class="comment"># cat .ssh/id_rsa</span></span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEpgIBAAKCAQEAs/F5AHLXxg++0+J5mRmlOUS2fUyvXsge+eHOS4ZpyiOzYucs</span><br><span class="line">O6TtCucct8Gtxe6m/rM/eOOGT5SyKnzuGPpDOBlAqjdspB+5oszEaqW5oGUjbsh1</span><br><span class="line">xTPHe2t6wAnuCf1u8YzuOgzPxnUEdgDvUVygBUYsEoCMAQ3mzjrxdkkNWCwau/1c</span><br><span class="line">mtES0TjRW7S0StqYRc0JGWmSoyb0p7oMoRVU5z1AA+UaZlE183iQOMOGIGvNirwy</span><br><span class="line">mJXy6gVADt8gcCImEfcFbFbtV0ZJymmyWrbEcEpldEjNe2VCxP8i32Cs7J6RPAvi</span><br><span class="line">W/OoVoTY1wC85xwqnawRlc3/ldkQhkP4R4lb1QIDAQABAoIBAQCtilO9WAS7UpIi</span><br><span class="line">vQey3OXY7mjlPODhEzW0ns6bTh2WwomN+A9T0oJ+AlhS7CpQexJ5D5xGVYBCHdEa</span><br><span class="line">YvQqCKptXwVbZCqVurcIyF0h0YTNqNzcSd4y+vYHFKgEr07wOYgW02kpeROlfVN5</span><br><span class="line">Dvu/RwpZK8zzZyAfIC4ZdQVMo7WH8xoaAZB9x663I5MCPJdsw2dM7I+yKhgCPC6A</span><br><span class="line">OC130m1p5kUCIc9dMMIiE4rKBYUGSv93emHvMxBiwnk7GWzml/ncxh32s1hKvXN3</span><br><span class="line">5TurFQLac2WLSn6k4sNfXgZnGpqAyoUggcwzPeAqSaH98YNStiFACsH6Q3mbnIp8</span><br><span class="line">VEyWaI+dAoGBAObfOjtQISd4ypXMFoB8Bf1srT24r0NBxxR/MJzY1FZx8pJCcbCN</span><br><span class="line">RJOIz0qkdNyXbt92bD9X4p84+0fNr2htEKzeVsizxp4HPFDn6GTWonhnikGaG/7Z</span><br><span class="line">Dq4fYRW961xdVp7iMYL2sFfEL5Yd9YpOoixU7QcZfnuPLrmVPcBO6VLvAoGBAMeH</span><br><span class="line">OJIl9EZBYx8+/GjzXXC8V95WpbvZt3TjZCegPLphEub6Ey8jeS1tl0XS+PMIaB1I</span><br><span class="line">p7TnZzxB1YnaWrqj+851LBZirwX7PRUOrtzLYd1j0iCkQMiX9KKMDeOzFEEszTj4</span><br><span class="line">3VKMPSHe7/s/qXRUzl6bpeR6NOfbmADikdEpza17AoGBAMNQKABTqqis7J3LmWG7</span><br><span class="line">Coo5rVng6wx4EkaJz4NxgDldjrwjT/Dvogs6GzvnYyHXTqnnkm4IGKVg3FwDaxhp</span><br><span class="line">5EiKlFqYlDfOoT1E4/qjBbHczj7vdC2mTWALFeQB1qI+KHCjpQVJUyf8xdE2qSoH</span><br><span class="line">mfTtJ9TwwWsgV4QS+Lm/SG6rAoGBAJvDalxdmNcH0LPh3faoljeeMRJ3niaKDngH</span><br><span class="line">1HZC12XAxpreev9/t+fI+CEgVAyWcYD66UGGrMcTtfpKJi4yOi+wtVw8adpHiiXY</span><br><span class="line">MpZXh+znMnEdCR4P0oDayTUK5jMDIKrrTQxWQpsgiUQhLM6OLhUZeWZmKMsgWQfH</span><br><span class="line">2IHrGo/lAoGBANN9mH6rUSCQqJuh462FOMkwwHozj1St37cFXCQrwHUTOV6S22u5</span><br><span class="line">eC5XWixwz3Y3hlHCdDWHQ+e7Ytw0b78Dm+R1szQQFlL6PTSUhBCyMLnlFTbSAy6n</span><br><span class="line">oF+u63iCKGeDbWiP1UGwRdEQFX+nSaU0CLLsLz9ZHKyLmWB0bUROScoD</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br><span class="line"><span class="comment">#取出公钥文件内容</span></span><br><span class="line">root@jenkins:~<span class="comment"># cat .ssh/id_rsa.pub </span></span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCz8XkActfGD77T4nmZGaU5RLZ9TK9eyB754c5LhmnKI7Ni5yw7pO0K5xy3wa3F7qb+sz9444ZPlLIqfO4Y+kM4GUCqN2ykH7mizMRqpbmgZSNuyHXFM8d7a3rACe4J/W7xjO46DM/GdQR2AO9RXKAFRiwSgIwBDebOOvF2SQ1YLBq7/Vya0RLRONFbtLRK2phFzQkZaZKjJvSnugyhFVTnPUAD5RpmUTXzeJA4w4Yga82KvDKYlfLqBUAO3yBwIiYR9wVsVu1XRknKabJatsRwSmV0SM17ZULE/yLfYKzsnpE8C+Jb86hWhNjXALznHCqdrBGVzf+V2RCGQ/hHiVvV root@jenkins</span><br></pre></td></tr></table></figure>

<p>在jenkins上配置凭据</p>
<p><img src="private1.png" alt="private1.png"></p>
<p><img src="private2.png" alt="private2.png"></p>
<p><img src="private3.png" alt="private3.png"></p>
<p>在gitlab上添加jenkins服务器的公钥，让jenkins服务器无需输入账户名和密码就能拉取数据</p>
<p><img src="public.png" alt="public.png"></p>
<p>在jenkins服务器上使用git测试能否从gitlab上免用户名和密码clone项目</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># git clone git@192.168.27.11:mylinuxops/web1.git</span></span><br></pre></td></tr></table></figure>

<p>将jenkins的公钥文件发送给2台tomcat服务器，用来免密要分发代码使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># ssh-copy-id www@192.168.27.31</span></span><br><span class="line">root@jenkins:~<span class="comment"># ssh-copy-id www@192.168.27.32</span></span><br></pre></td></tr></table></figure>

<h3 id="配置代码部署"><a href="#配置代码部署" class="headerlink" title="配置代码部署"></a>配置代码部署</h3><p>在jenkins上创建一个项目，测试能否构建项目</p>
<p><img src="test1.png" alt="test1.png"></p>
<p><img src="test2.png" alt="test2.png"></p>
<p><img src="test3.png" alt="test3.png"></p>
<p><img src="test4.png" alt="test4.png"></p>
<p><img src="test5.png" alt="test5.png"></p>
<p><img src="test6.png" alt="test6.png"></p>
<p><img src="test7.png" alt="test7.png"></p>
<p>更改构建内容测试能否将gitlab上的项目向后端的tomcat上部署</p>
<p><img src="test8.png" alt="test8.png"></p>
<p><img src="test9.png" alt="test9.png"></p>
<p><img src="test10.png" alt="test10.png"></p>
<p>测试访问keepalived</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># curl 192.168.27.248/myapp/index.html</span></span><br><span class="line">welcome to mylinuxops.com   v1</span><br><span class="line">welcome to mylinuxops.com 	v2</span><br><span class="line">welcome to mylinuxops.com 	v3</span><br><span class="line">welcome to mylinuxops.com   v4</span><br><span class="line">welcome to mylinuxops.com   v5</span><br><span class="line"><span class="comment">#内容已变更</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins给脚本传递参数</title>
    <url>/2019/05/05/CICD/jenkins%E5%90%91%E8%84%9A%E6%9C%AC%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0/jenkins%E5%90%91%E8%84%9A%E6%9C%AC%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0/</url>
    <content><![CDATA[<h2 id="使用选项参数传递参数"><a href="#使用选项参数传递参数" class="headerlink" title="使用选项参数传递参数"></a>使用选项参数传递参数</h2><p>新建一个任务</p>
<p><img src="arg1.png" alt="arg1.png"></p>
<p><img src="arg2.png" alt="arg2.png"></p>
<p><img src="arg3.png" alt="arg3.png"></p>
<p>编写脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~<span class="comment"># vim test.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$2</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$3</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------------&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == <span class="string">&quot;GROUP1&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        IP_LIST=<span class="string">&quot;192.168.27.31&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$1</span> == <span class="string">&quot;GROUP2&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        IP_LIST=<span class="string">&quot;192.168.27.32&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$1</span> == <span class="string">&quot;GROUPALL&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        IP_LIST=<span class="string">&quot;192.168.27.32 192.168.27.31&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;IP_LIST&#125;</span>;<span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$&#123;node_ip&#125;</span>,<span class="string">&quot;---------&gt;&quot;</span></span><br><span class="line"><span class="keyword">done</span> </span><br></pre></td></tr></table></figure>

<p>构建</p>
<p><img src="build.png" alt="build.png"></p>
<h2 id="使用字符参数传递参数"><a href="#使用字符参数传递参数" class="headerlink" title="使用字符参数传递参数"></a>使用字符参数传递参数</h2><p>修改任务，新增一个字符参数</p>
<p><img src="arg4.png" alt="arg4.png"></p>
<p><img src="arg5.png" alt="arg5.png"></p>
<p><img src="arg6.png" alt="arg6.png"></p>
<p>修改脚本添加从gitlab上克隆哪个分支的项目</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == <span class="string">&quot;GROUP1&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        IP_LIST=<span class="string">&quot;192.168.27.31&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$1</span> == <span class="string">&quot;GROUP2&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        IP_LIST=<span class="string">&quot;192.168.27.32&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$1</span> == <span class="string">&quot;GROUPALL&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        IP_LIST=<span class="string">&quot;192.168.27.32 192.168.27.31&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;IP_LIST&#125;</span>;<span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$&#123;node_ip&#125;</span>,<span class="string">&quot;---------&gt;&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">branch=<span class="variable">$2</span></span><br><span class="line"><span class="built_in">cd</span> /data/git &amp;&amp; rm -rf web1</span><br><span class="line">git <span class="built_in">clone</span> -b <span class="variable">$&#123;branch&#125;</span> git@192.168.27.11:mylinuxops/web1.git</span><br></pre></td></tr></table></figure>

<p>构建</p>
<p><img src="build1.png" alt="build1.png"></p>
<p>查看控制台输出</p>
<p><img src="log.png" alt="log.png"></p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins构建后关联操作</title>
    <url>/2019/05/05/CICD/jenkins%E6%9E%84%E5%BB%BA%E5%90%8E%E5%85%B3%E8%81%94%E6%93%8D%E4%BD%9C/Jenkins%E6%9E%84%E5%BB%BA%E5%90%8E%E5%85%B3%E8%81%94%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>jenkins可以在执行构建后再进行执行相关联的操作，比如发邮件通知、构建下一个任务等等</p>
<p><img src="and.png" alt="and.png"></p>
<h2 id="配置方法"><a href="#配置方法" class="headerlink" title="配置方法"></a>配置方法</h2><p><img src="1.png" alt="1.png"></p>
<p><img src="2.png" alt="2.png"></p>
<p><img src="3.png" alt="3.png"></p>
<p>以下为构建后再构建其他工程为例</p>
<p><img src="4.png" alt="4.png"></p>
<p><img src="5.png" alt="5.png"></p>
<p><img src="6.png" alt="6.png"></p>
<p>再次执行构建任务时，当第一个任务执行完毕后会自动执行相关联的第二个任务，一般在一个大服务中使用，将每个小服务分离开，当第一个服务配置完毕后自动触发下一个服务（酌情使用）。</p>
<p><img src="7.png" alt="7.png"></p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins的pipline</title>
    <url>/2019/05/04/CICD/jenkins%E7%9A%84pipline/jenkins%E7%9A%84pipline/</url>
    <content><![CDATA[<h2 id="pipline简介"><a href="#pipline简介" class="headerlink" title="pipline简介"></a>pipline简介</h2><p>官方介绍；<a href="https://jenkins.io/2.0/">https://jenkins.io/2.0/</a></p>
<p>pipline是帮助Jenkins实现CI到CD转变的重要角色，是运行在jenkins2.X版本的核心插件，简单来说Pipline就是一套运行于Jenkins上的工作流框架，将原本独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂发布流程，从而实现单个任务很难实现的复杂流程编排和任务可视化，pipline的实现方式是一套Groovy DSL，任何发布流程都可以表述为一段Groovy脚本。</p>
<h2 id="pipline语法"><a href="#pipline语法" class="headerlink" title="pipline语法"></a>pipline语法</h2><p>Stage：阶段，一个pipline可以划分为若干个stage，每个stage都是一个操作，比如clone代码、代码编译、代码测试和代码部署，阶段是一个逻辑分组，可以跨多个node执行。</p>
<p>Node：节点，每个node都是一个jenkins节点，可以是jenkin smaster也可以是jenkins agent，node是执行step的具体服务器。</p>
<p>Step：步骤，step是jenkinspipline最基本的操作单元，从在服务器创建目录到构建容器镜像，由各类Jenkins插件提供实现，例如：sh “make”</p>
<h2 id="pipline优势"><a href="#pipline优势" class="headerlink" title="pipline优势"></a>pipline优势</h2><p>可持续性：jenkins的重启或者中断后不影响已经执行的PiplineJob</p>
<p>支持暂停：pipline可以选择停止并等待人工输入或批准后再继续执行。</p>
<p>可扩展：通过groovy的编程更容易的扩展插件。</p>
<p>并行执行：通过groovy脚本可以实现step，stage间的并行执行，和更复杂的相互依赖关系。</p>
<h2 id="pipline使用方法"><a href="#pipline使用方法" class="headerlink" title="pipline使用方法"></a>pipline使用方法</h2><h3 id="简单的输出一个hello-world"><a href="#简单的输出一个hello-world" class="headerlink" title="简单的输出一个hello world"></a>简单的输出一个hello world</h3><p><img src="hello1.png" alt="hello1.png"></p>
<p><img src="hello2.png" alt="hello2.png"></p>
<p><img src="hello3.png" alt="hello3.png"></p>
<p><img src="hello4.png" alt="hello4.png"></p>
<p><img src="hello5.png" alt="hello5.png"></p>
<h3 id="测试流水线"><a href="#测试流水线" class="headerlink" title="测试流水线"></a>测试流水线</h3><p>修改流水线脚本，写入以下测试代码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node &#123;</span><br><span class="line">    stage(<span class="string">&quot;clone 代码&quot;</span>)&#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;代码 clone&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&quot;代码构建&quot;</span>)&#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;代码构建&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&quot;代码测试&quot;</span>)&#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;代码测试&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&quot;代码部署&quot;</span>)&#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;代码部署&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="pip1.png" alt="pip1.png"></p>
<p>再次进行构建，流水线发生了变化</p>
<p><img src="pip2.png" alt="pip2.png"></p>
<h3 id="流水线语法生成器的使用"><a href="#流水线语法生成器的使用" class="headerlink" title="流水线语法生成器的使用"></a>流水线语法生成器的使用</h3><p><img src="yf1.png" alt="yf1.png"></p>
<p><img src="yf2.png" alt="yf2.png"></p>
<p><img src="yf3.png" alt="yf3.png"></p>
<p>在控制台上查看输出</p>
<p><img src="yf4.png" alt="yf4.png"></p>
<p>去slave-2上查看项目是否被克隆下来</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@slave-2:~<span class="comment"># ll /var/lib/jenkins/workspace/pipline-test/</span></span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x 3 root root 4096 Jul 24 05:31 ./</span><br><span class="line">drwxr-xr-x 4 root root 4096 Jul 24 05:31 ../</span><br><span class="line">drwxr-xr-x 8 root root 4096 Jul 24 05:31 .git/</span><br><span class="line">-rw-r--r-- 1 root root  154 Jul 24 05:31 index.html</span><br><span class="line"><span class="comment">#项目已经被克隆</span></span><br></pre></td></tr></table></figure>

<p>继续编写流水线脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">&quot;jenkins-slave-2&quot;</span>)&#123;       <span class="comment">#将流水线强制指定在某个slave节点上</span></span><br><span class="line">  stage(<span class="string">&quot;clone 代码&quot;</span>)&#123;</span><br><span class="line">    sh <span class="string">&#x27;cd /var/lib/jenkins/workspace/pipline-test &amp;&amp; rm -rf ./*&#x27;</span></span><br><span class="line">    git credentialsId: <span class="string">&#x27;38462a8a-5efd-4d9b-8ed5-06b021bd01e9&#x27;</span>, url: <span class="string">&#x27;git@192.168.27.11:mylinuxops/web1.git&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;代码 clone完成&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stage(<span class="string">&quot;代码打包&quot;</span>)&#123;</span><br><span class="line">    sh <span class="string">&#x27;cd  /var/lib/jenkins/workspace/pipline-test &amp;&amp; tar czvf code.tar.gz  ./index.html&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;代码打包完成&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  stage(<span class="string">&quot;停止tomcat服务&quot;</span>)&#123;</span><br><span class="line">    sh <span class="string">&#x27;ssh www@192.168.27.31 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span></span><br><span class="line">    sh <span class="string">&#x27;ssh www@192.168.27.32 &quot;/etc/init.d/tomcat stop&quot;&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  stage(<span class="string">&quot;代码复制&quot;</span>)&#123;</span><br><span class="line">    sh <span class="string">&#x27;cd /var/lib/jenkins/workspace/pipline-test &amp;&amp; scp  code.tar.gz www@192.168.27.31:/data/tomcat/tomcat_appdir/&#x27;</span></span><br><span class="line">    sh <span class="string">&#x27;cd /var/lib/jenkins/workspace/pipline-test &amp;&amp; scp  code.tar.gz www@192.168.27.32:/data/tomcat/tomcat_appdir/&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  stage(<span class="string">&quot;代码部署&quot;</span>)&#123;</span><br><span class="line">    sh <span class="string">&#x27;ssh www@192.168.27.31 &quot;cd /data/tomcat/tomcat_appdir/ &amp;&amp; rm -rf /data/tomcat/tomcat_webdir/myapp/*  &amp;&amp; tar xvf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/ &quot;&#x27;</span></span><br><span class="line">    sh <span class="string">&#x27;ssh www@192.168.27.32 &quot;cd /data/tomcat/tomcat_appdir/ &amp;&amp; rm -rf /data/tomcat/tomcat_webdir/myapp/*  &amp;&amp; tar xvf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/ &quot;&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  stage(<span class="string">&quot;启动tomcat服务&quot;</span>)&#123;</span><br><span class="line">    sh <span class="string">&#x27;ssh www@192.168.27.32 &quot;/etc/init.d/tomcat start&quot;&#x27;</span></span><br><span class="line">    sh <span class="string">&#x27;ssh www@192.168.27.32 &quot;/etc/init.d/tomcat start&quot;&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于此处使用的是分布式的jenkins还需要做好与后端tomcat的免密钥认证</p>
<p>slave-1与后端服务器做免密钥认证</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@slave-1:~<span class="comment"># ssh-keygen</span></span><br><span class="line">root@slave-1:~<span class="comment"># ssh-copy-id www@192.168.27.31</span></span><br><span class="line">root@slave-1:~<span class="comment"># ssh-copy-id www@192.168.27.32</span></span><br></pre></td></tr></table></figure>

<p>slave-2与后端tomcat做免密钥认证</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@slave-2:~<span class="comment"># ssh-keygen</span></span><br><span class="line">root@slave-2:~<span class="comment"># ssh-copy-id www@192.168.27.31</span></span><br><span class="line">root@slave-2:~<span class="comment"># ssh-copy-id www@192.168.27.32</span></span><br></pre></td></tr></table></figure>

<p>将脚本写入流水线脚本中</p>
<p><img src="script.png" alt="script.png"></p>
<p>执行构建</p>
<p><img src="build.png" alt="build.png"></p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins分布式部署</title>
    <url>/2019/05/05/CICD/jenkins%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F/Jenkins%E5%88%86%E5%B8%83%E5%BC%8F%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<p>单台的job数量是有上线的，单台jenkins执行几十上百速度就会慢，此时就会部署一个Master多个node节点，master上配置多个任务，nodes上去执行各个任务，或者让测试环境的job执行在测试的node节点上，生产的job执行在生产的node上及那个其分离开。</p>
<p>node节点在执行job时会先去gitlab上拉取代码，对其进行编译，编译完成打包后向后端web服务器去部署，master不再执行操作，只用来分配各种job。</p>
<h2 id="分布式Jenkins配置方式"><a href="#分布式Jenkins配置方式" class="headerlink" title="分布式Jenkins配置方式"></a>分布式Jenkins配置方式</h2><p>jenkins配置分布式前提条件</p>
<p>1.确保slave的时间必须要和master的时间相同</p>
<p>2.slave上的java环境需要和master上相同</p>
<p>环境准备</p>
<table>
<thead>
<tr>
<th align="left">hostname</th>
<th align="left">ip</th>
<th align="left">os</th>
</tr>
</thead>
<tbody><tr>
<td align="left">master</td>
<td align="left">192.168.27.12</td>
<td align="left">ubuntu 18.04.2</td>
</tr>
<tr>
<td align="left">slave-1</td>
<td align="left">192.168.27.13</td>
<td align="left">ubuntu 18.04.2</td>
</tr>
<tr>
<td align="left">slave-2</td>
<td align="left">192.168.27.14</td>
<td align="left">ubuntu 18.04.2</td>
</tr>
</tbody></table>
<p>在所有的服务器上进行时间同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ntpdate 172.20.0.1</span><br></pre></td></tr></table></figure>
<h3 id="配置2台slave的java环境"><a href="#配置2台slave的java环境" class="headerlink" title="配置2台slave的java环境"></a>配置2台slave的java环境</h3><p>配置java环境</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@slave-1:~<span class="comment"># ls</span></span><br><span class="line">jdk-8u212-linux-x64.tar.gz</span><br><span class="line">root@slave-1:~<span class="comment"># tar xf jdk-8u212-linux-x64.tar.gz -C /usr/local/src/</span></span><br><span class="line">root@slave-1:~<span class="comment"># ln -sv /usr/local/src/jdk1.8.0_212 /usr/local/jdk</span></span><br></pre></td></tr></table></figure>

<p>配置环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@slave-1:~<span class="comment"># vim /etc/profile</span></span><br><span class="line"><span class="built_in">export</span> HISTTIMEFORMAT=<span class="string">&quot;%F %T `whoami` &quot;</span></span><br><span class="line"><span class="built_in">export</span> <span class="built_in">export</span> LANG=<span class="string">&quot;en_US.utf-8&quot;</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br></pre></td></tr></table></figure>

<p>jenkins要求在/usr/bin目录下必须有java，创建一个软连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@slave-1:~<span class="comment"># ln /usr/local/jdk/bin/java /usr/bin/</span></span><br></pre></td></tr></table></figure>

<h3 id="配置slave"><a href="#配置slave" class="headerlink" title="配置slave"></a>配置slave</h3><p>分别在slave上创建出jenkins的工作目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@slave-1:~<span class="comment"># mkdir -pv /var/lib/jenkins/workspace</span></span><br><span class="line"><span class="comment">#工作目录的位置是在master上的配置文件中指定的</span></span><br><span class="line"><span class="comment">#root@master:~# vim /etc/default/jenkins </span></span><br><span class="line"><span class="comment">#JENKINS_HOME=/var/lib/$NAME</span></span><br></pre></td></tr></table></figure>

<p>在工作目录下配置软连接，slave上线时会检查工作目录下是否有java</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@slave-1:~<span class="comment"># mkdir /var/lib/jenkins/jdk/bin</span></span><br><span class="line">root@slave-1:~<span class="comment"># ln -sv /usr/local/jdk/bin/java /var/lib/jenkins/jdk/bin/</span></span><br></pre></td></tr></table></figure>

<h3 id="添加节点"><a href="#添加节点" class="headerlink" title="添加节点"></a>添加节点</h3><p><img src="1.png" alt="1.png"></p>
<p><img src="2.png" alt="2.png"></p>
<p><img src="3.png" alt="3.png"></p>
<p><img src="4.png" alt="4.png"></p>
<p><img src="5.png" alt="5.png"></p>
<p><img src="6.png" alt="6.png"></p>
<p>按照此方法将slave-2也加入节点</p>
<p><img src="7.png" alt="7.png"></p>
<p>分布式jenkins部署完毕</p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins构建触发器</title>
    <url>/2019/05/04/CICD/jenkins%E8%A7%A6%E5%8F%91%E5%99%A8/Jenkins%E6%9E%84%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8/</url>
    <content><![CDATA[<p>当gitlab上代码发生变更时，jenkins自动将代码部署到服务器上，常用于测试环境</p>
<h2 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h2><p>在gitlab上创建一个新的开发分支</p>
<p><img src="jenkins1.png" alt="jenkins1.png"></p>
<p><img src="jenkins2.png" alt="jenkins2.png"></p>
<p>在jenkins上安装插件</p>
<p><img src="plugin1.png" alt="plugin1.png"></p>
<p><img src="plugin2.png" alt="plugin2.png"></p>
<p>插件安装完毕后需要对jenkins的配置做一些更改：</p>
<p>1.允许登录用户可以做任何事情</p>
<p>2.关闭跨站伪造保护</p>
<p><img src="config1.png" alt="config1.png"></p>
<p><img src="config2.png" alt="config2.png"></p>
<p>新建一个开发分支的任务</p>
<p><img src="new1.png" alt="new1.png"></p>
<p>生成一个token值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@jenkins:~<span class="comment"># openssl rand -hex 12</span></span><br><span class="line">2d6f3d9475277d20545a4182</span><br></pre></td></tr></table></figure>

<p>填入token值</p>
<p><img src="new2.png" alt="new2.png"></p>
<p><img src="new3.png" alt="new3.png"></p>
<p><img src="new4.png" alt="new4.png"></p>
<p>测试访问连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#jenkins的地址、job和token拼出的连接，一旦访问此连接将触发构建</span></span><br><span class="line">root@jenkins:~<span class="comment"># curl 192.168.27.12:8080/job/mylinu_develop/build?token=2d6f3d9475277d20545a4182</span></span><br></pre></td></tr></table></figure>

<p>url测试通过后将其写入gitlab</p>
<p><img src="git1.png" alt="git1.png"></p>
<p><img src="git2.png" alt="git2.png"></p>
<p>在Jenkins上修改构建的脚本</p>
<p><img src="build.png" alt="build.png"></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>对开发分克隆</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@gitlab:~<span class="comment"># git clone -b develop http://192.168.27.11/mylinuxops/web1.git</span></span><br><span class="line">Cloning into <span class="string">&#x27;web1&#x27;</span>...</span><br><span class="line">Username <span class="keyword">for</span> <span class="string">&#x27;http://192.168.27.11&#x27;</span>: masuri</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">&#x27;http://masuri@192.168.27.11&#x27;</span>: </span><br><span class="line">remote: Enumerating objects: 15, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (15/15), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (8/8), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 15 (delta 1), reused 15 (delta 1)</span><br><span class="line">Unpacking objects: 100% (15/15), <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>

<p>重新修改后再次提交</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@gitlab:~/web1<span class="comment"># cat index.html </span></span><br><span class="line">welcome to mylinuxops.com	v1</span><br><span class="line">welcome to mylinuxops.com	v2</span><br><span class="line">welcome to mylinuxops.com	v3</span><br><span class="line">welcome to mylinuxops.com	v4</span><br><span class="line">welcome to mylinuxops.com	v5</span><br><span class="line">welcome to mylinuxops.com	v6</span><br><span class="line">root@gitlab:~/web1<span class="comment"># git add ./*</span></span><br><span class="line">root@gitlab:~/web1<span class="comment"># git commit -m &quot;v6&quot;</span></span><br><span class="line">[develop 3c3104b] v6</span><br><span class="line"> 1 file changed, 6 insertions(+), 6 deletions(-)</span><br><span class="line">root@gitlab:~/web1<span class="comment"># git push</span></span><br><span class="line">Username <span class="keyword">for</span> <span class="string">&#x27;http://192.168.27.11&#x27;</span>: masuri</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">&#x27;http://masuri@192.168.27.11&#x27;</span>: </span><br><span class="line">Counting objects: 3, <span class="keyword">done</span>.</span><br><span class="line">Delta compression using up to 12 threads.</span><br><span class="line">Compressing objects: 100% (2/2), <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (3/3), 275 bytes | 275.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Total 3 (delta 1), reused 0 (delta 0)</span><br><span class="line">remote: </span><br><span class="line">remote: To create a merge request <span class="keyword">for</span> develop, visit:</span><br><span class="line">remote:   http://192.168.27.11/mylinuxops/web1/merge_requests/new?merge_request%5Bsource_branch%5D=develop</span><br><span class="line">remote: </span><br><span class="line">To http://192.168.27.11/mylinuxops/web1.git</span><br><span class="line">   7b5ebd9..3c3104b  develop -&gt; develop</span><br></pre></td></tr></table></figure>

<p>触发了自动部署，后端服务器上已经变为v6版本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@gitlab:~/web1<span class="comment"># curl 192.168.27.248/myapp/index.html</span></span><br><span class="line">welcome to mylinuxops.com	v1</span><br><span class="line">welcome to mylinuxops.com	v2</span><br><span class="line">welcome to mylinuxops.com	v3</span><br><span class="line">welcome to mylinuxops.com	v4</span><br><span class="line">welcome to mylinuxops.com	v5</span><br><span class="line">welcome to mylinuxops.com	v6</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins视图</title>
    <url>/2019/05/05/CICD/jenkins%E8%A7%86%E5%9B%BE/jenkins%E8%A7%86%E5%9B%BE/</url>
    <content><![CDATA[<p>视图可用于归档 job 进行分组显示，比如将一个业务的视图放在一个视图显示</p>
<h2 id="pipeline视图"><a href="#pipeline视图" class="headerlink" title="pipeline视图"></a>pipeline视图</h2><p>pipeline视图需要安装build pipeline插件</p>
<p><img src="view1.png" alt="view1.png"></p>
<p>创建视图</p>
<p><img src="view2.png" alt="view2.png"></p>
<p><img src="view3.png" alt="view3.png"></p>
<p><img src="view4.png" alt="view4.png"></p>
<h2 id="列表视图"><a href="#列表视图" class="headerlink" title="列表视图"></a>列表视图</h2><p>列表视图使用场景比较多，用于将一个业务的job保存至一个列表视图进行分类管理，即不同业务的job放在不同的列表视图中。</p>
<p><img src="list1.png" alt="list1.png"></p>
<p><img src="list2.png" alt="list2.png"></p>
<p>最终job1的视图中有2个任务</p>
<p><img src="list3.png" alt="list3.png"></p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins代码质量检测</title>
    <url>/2019/05/05/CICD/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E6%A3%80%E6%B5%8B/Jenkins%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E6%A3%80%E6%B5%8B/</url>
    <content><![CDATA[<h2 id="代码质量检测"><a href="#代码质量检测" class="headerlink" title="代码质量检测"></a>代码质量检测</h2><p>官方网站：<a href="http://www.sonarqube.org/">http://www.sonarqube.org/</a></p>
<p>SonarQube是一个用于代码质量管理的开放平台，通过插件机制，SonarQube可以集成不同的测试工具，代码分析工具，以及持续集成工具，例如 Hudson/Jenkins 等。</p>
<p>下载地址：<a href="https://www.sonarqube.org/downloads/">https://www.sonarqube.org/downloads/</a></p>
<h3 id="七个维度检测代码质量"><a href="#七个维度检测代码质量" class="headerlink" title="七个维度检测代码质量"></a>七个维度检测代码质量</h3><p>复杂度分布：代码复杂度过高将难以理解</p>
<p>重复代码：程序中包含大量复制、粘贴的代码而导致代码臃肿，sonar 可以展示源码中重复严重的地方</p>
<p>单元测试统计：统计并展示单元测试覆盖率，开发或测试可以清楚测试代码的覆盖情况</p>
<p>代码规则检查：检查代码是否符合规范</p>
<p>注释率：若代码注释过少，特别是人员变动后，其他人接手比较难接手；若过多，又不利于阅读潜在的Bug：检测潜在的 bug</p>
<p>结构与设计：找出循环，展示包与包、类与类之间的依赖、检查程序之间耦合度</p>
<h2 id="sonar-sever端配置"><a href="#sonar-sever端配置" class="headerlink" title="sonar-sever端配置"></a>sonar-sever端配置</h2><p>配置java环境</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@slave-1:~<span class="comment"># ls</span></span><br><span class="line">jdk-8u212-linux-x64.tar.gz</span><br><span class="line">root@slave-1:~<span class="comment"># tar xf jdk-8u212-linux-x64.tar.gz -C /usr/local/src/</span></span><br><span class="line">root@slave-1:~<span class="comment"># ln -sv /usr/local/src/jdk1.8.0_212 /usr/local/jdk</span></span><br></pre></td></tr></table></figure>

<p>配置环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@slave-1:~<span class="comment"># vim /etc/profile</span></span><br><span class="line"><span class="built_in">export</span> HISTTIMEFORMAT=<span class="string">&quot;%F %T `whoami` &quot;</span></span><br><span class="line"><span class="built_in">export</span> LANG=<span class="string">&quot;en_US.utf-8&quot;</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br></pre></td></tr></table></figure>

<p>由于sonarqube 7.9.1LTS不再支持MySQL此处使用sonarqube 6.9lts版</p>
<p>下载安装包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-6.7.7.zip</span></span><br></pre></td></tr></table></figure>

<p>创建用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># useradd -s /bin/bash -m sonarqube</span></span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># unzip sonarqube-6.7.7.zip -d /usr/local/src/</span></span><br></pre></td></tr></table></figure>

<p>做个软连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># ln -sv /usr/local/src/sonarqube-6.7.7 /usr/local/sonarqube</span></span><br></pre></td></tr></table></figure>

<p>修改属主属组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># chown sonarqube.sonarqube /usr/local/src/sonarqube-6.7.7 /usr/local/sonarqube -R</span></span><br></pre></td></tr></table></figure>

<p>修改内核参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># vim /etc/sysctl.conf </span></span><br><span class="line">vm.max_map_count = 262144</span><br><span class="line">fs.file-max = 65536</span><br></pre></td></tr></table></figure>

<p>开启最大限制数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># vim /etc/security/limits.conf </span></span><br><span class="line">sonarqube       -       nofile  65536</span><br><span class="line">sonarqube       -       nproc   2048</span><br></pre></td></tr></table></figure>

<p>重启服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

<p>安装数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># apt install mysql-server -y</span></span><br></pre></td></tr></table></figure>

<p>创建数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt;  create database sonar default character <span class="built_in">set</span> utf8 collate utf8_general_ci;</span><br></pre></td></tr></table></figure>

<p>授权用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON sonar.* TO <span class="string">&#x27;sonar&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;111111&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>测试能否连接数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># mysql -usonar -p111111</span></span><br></pre></td></tr></table></figure>

<p>修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># grep &quot;^[a-Z]&quot; /usr/local/sonarqube/conf/sonar.properties</span></span><br><span class="line">sonar.jdbc.username=sonar</span><br><span class="line">sonar.jdbc.password=111111</span><br><span class="line">sonar.jdbc.url=jdbc:mysql://192.168.27.10:3306/sonar?useUnicode=<span class="literal">true</span>&amp;characterEncoding=utf8&amp;rewriteBatchedStatements=<span class="literal">true</span>&amp;useConfigs=maxPerformance&amp;useSSL=<span class="literal">false</span></span><br><span class="line">sonar.web.host=0.0.0.0</span><br><span class="line">sonar.web.port=9000</span><br></pre></td></tr></table></figure>

<p>切换用户启动sonar</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># su - sonarqube</span></span><br><span class="line">sonarqube@mylinuxops:~$ /usr/<span class="built_in">local</span>/sonarqube/bin/linux-x86-64/sonar.sh start</span><br></pre></td></tr></table></figure>

<p>监控日志确保sonar起来了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:/usr/<span class="built_in">local</span>/sonarqube/logs<span class="comment"># tail -f /usr/local/sonarqube/logs/sonar.log </span></span><br><span class="line">2019.07.24 08:49:38 INFO  app[][o.s.a.p.ProcessLauncherImpl] Launch process[[key=<span class="string">&#x27;es&#x27;</span>, ipcIndex=1, logFilenamePrefix=es]] from [/usr/<span class="built_in">local</span>/src/sonarqube-6.7.7/elasticsearch]: /usr/<span class="built_in">local</span>/src/sonarqube-6.7.7/elasticsearch/bin/elasticsearch -Epath.conf=/usr/<span class="built_in">local</span>/src/sonarqube-6.7.7/temp/conf/es</span><br><span class="line">2019.07.24 08:49:38 INFO  app[][o.s.a.SchedulerImpl] Waiting <span class="keyword">for</span> Elasticsearch to be up and running</span><br><span class="line">2019.07.24 08:49:38 INFO  app[][o.e.p.PluginsService] no modules loaded</span><br><span class="line">2019.07.24 08:49:38 INFO  app[][o.e.p.PluginsService] loaded plugin [org.elasticsearch.transport.Netty4Plugin]</span><br><span class="line">2019.07.24 08:49:44 INFO  app[][o.s.a.SchedulerImpl] Process[es] is up</span><br><span class="line">2019.07.24 08:49:44 INFO  app[][o.s.a.p.ProcessLauncherImpl] Launch process[[key=<span class="string">&#x27;web&#x27;</span>, ipcIndex=2, logFilenamePrefix=web]] from [/usr/<span class="built_in">local</span>/src/sonarqube-6.7.7]: /usr/<span class="built_in">local</span>/src/jdk1.8.0_212/jre/bin/java -Djava.awt.headless=<span class="literal">true</span> -Dfile.encoding=UTF-8 -Djava.io.tmpdir=/usr/<span class="built_in">local</span>/src/sonarqube-6.7.7/temp -Xmx512m -Xms128m -XX:+HeapDumpOnOutOfMemoryError -cp ./lib/common/*:./lib/server/*:/usr/<span class="built_in">local</span>/src/sonarqube-6.7.7/lib/jdbc/mysql/mysql-connector-java-5.1.42.jar org.sonar.server.app.WebServer /usr/<span class="built_in">local</span>/src/sonarqube-6.7.7/temp/sq-process2953956436611591567properties</span><br><span class="line">2019.07.24 08:51:00 INFO  app[][o.s.a.SchedulerImpl] Process[web] is up</span><br><span class="line">2019.07.24 08:51:00 INFO  app[][o.s.a.p.ProcessLauncherImpl] Launch process[[key=<span class="string">&#x27;ce&#x27;</span>, ipcIndex=3, logFilenamePrefix=ce]] from [/usr/<span class="built_in">local</span>/src/sonarqube-6.7.7]: /usr/<span class="built_in">local</span>/src/jdk1.8.0_212/jre/bin/java -Djava.awt.headless=<span class="literal">true</span> -Dfile.encoding=UTF-8 -Djava.io.tmpdir=/usr/<span class="built_in">local</span>/src/sonarqube-6.7.7/temp -Xmx512m -Xms128m -XX:+HeapDumpOnOutOfMemoryError -cp ./lib/common/*:./lib/server/*:./lib/ce/*:/usr/<span class="built_in">local</span>/src/sonarqube-6.7.7/lib/jdbc/mysql/mysql-connector-java-5.1.42.jar org.sonar.ce.app.CeServer /usr/<span class="built_in">local</span>/src/sonarqube-6.7.7/temp/sq-process3854353664142540391properties</span><br><span class="line">2019.07.24 08:51:26 INFO  app[][o.s.a.SchedulerImpl] Process[ce] is up          <span class="comment">#确保起来</span></span><br><span class="line">2019.07.24 08:51:26 INFO  app[][o.s.a.SchedulerImpl] SonarQube is up            <span class="comment">#确保起来</span></span><br></pre></td></tr></table></figure>

<p>使用浏览器登录</p>
<p><img src="sonar1.png" alt="sonar1.png"></p>
<p><img src="sonar2.png" alt="sonar2.png"></p>
<p>更改语言为中文</p>
<p><img src="sonar3.png" alt="sonar3.png"></p>
<p>server端配置完成</p>
<h2 id="sonar-scanner配置"><a href="#sonar-scanner配置" class="headerlink" title="sonar-scanner配置"></a>sonar-scanner配置</h2><p>sonar的扫描器需要和jenkins配置在一起</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~<span class="comment"># ls</span></span><br><span class="line">sonar-scanner-cli-4.0.0.1744-linux.zip</span><br></pre></td></tr></table></figure>

<p>解压文件，创建软连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~<span class="comment"># unzip sonar-scanner-cli-4.0.0.1744-linux.zip -d /usr/local/src/</span></span><br><span class="line">root@master:~<span class="comment"># ln -sv /usr/local/src/sonar-scanner-4.0.0.1744-linux/ /usr/local/sonar-scanner</span></span><br></pre></td></tr></table></figure>

<p>修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~<span class="comment"># vim /usr/local/sonar-scanner/conf/sonar-scanner.properties </span></span><br><span class="line"><span class="comment">#----- Default SonarQube server</span></span><br><span class="line">sonar.host.url=http://192.168.27.10:9000</span><br><span class="line"></span><br><span class="line"><span class="comment">#----- Default source code encoding</span></span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<p>配置完毕</p>
<h2 id="测试php"><a href="#测试php" class="headerlink" title="测试php"></a>测试php</h2><p>上传演示代码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~<span class="comment"># ls</span></span><br><span class="line">sonar-examples-master.zip</span><br><span class="line">root@master:~<span class="comment"># unzip sonar-examples-master.zip </span></span><br></pre></td></tr></table></figure>

<p>测试php</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~<span class="comment"># cd sonar-examples-master/projects/languages/php/php-sonar-runner</span></span><br><span class="line">root@master:~/sonar-examples-master/projects/languages/php/php-sonar-runner<span class="comment"># ll</span></span><br><span class="line">total 24</span><br><span class="line">drwxr-xr-x 3 root root 4096 Jul 25  2016 ./</span><br><span class="line">drwxr-xr-x 4 root root 4096 Jul 25  2016 ../</span><br><span class="line">-rw-r--r-- 1 root root  453 Jul 25  2016 README.md</span><br><span class="line">-rw-r--r-- 1 root root  331 Jul 25  2016 sonar-project.properties       <span class="comment">#此为配置文件，在测试的代码目录下必须要有此文件</span></span><br><span class="line">drwxr-xr-x 2 root root 4096 Jul 25  2016 src/</span><br><span class="line">-rw-r--r-- 1 root root  272 Jul 25  2016 validation.txt</span><br></pre></td></tr></table></figure>

<p>编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~/sonar-examples-master/projects/languages/php/php-sonar-runner<span class="comment"># vim sonar-project.properties </span></span><br><span class="line"><span class="comment"># Required metadata</span></span><br><span class="line">sonar.projectKey=org.sonarqube:php-simple-sq-scanner            </span><br><span class="line">sonar.projectName=PHP :: Simple Project :: SonarQube Scanner</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line"><span class="comment"># Comma-separated paths to directories with sources (required)</span></span><br><span class="line">sonar.sources=src       <span class="comment">#代码的目录</span></span><br><span class="line"><span class="comment"># Language</span></span><br><span class="line">sonar.language=php      <span class="comment">#所要检测的语言</span></span><br><span class="line"><span class="comment"># Encoding of the source files</span></span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<p>在当前目录下执行扫描</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~/sonar-examples-master/projects/languages/php/php-sonar-runner<span class="comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span></span><br><span class="line"><span class="comment">#扫描完完成后会生成一个连接</span></span><br><span class="line">INFO: ANALYSIS SUCCESSFUL, you can browse http://192.168.27.10:9000/dashboard/index/org.sonarqube:php-simple-sq-scanner</span><br></pre></td></tr></table></figure>

<p>使用浏览器访问就可以看到代码质量了</p>
<p><img src="sonar4.png" alt="sonar4.png"></p>
<h2 id="使用jenkins自动扫描代码"><a href="#使用jenkins自动扫描代码" class="headerlink" title="使用jenkins自动扫描代码"></a>使用jenkins自动扫描代码</h2><p><img src="project1.png" alt="project1.png"></p>
<p><img src="project2.png" alt="project2.png"></p>
<p>在项目中创建一个文件</p>
<p><img src="project3.png" alt="project3.png"></p>
<p>将像目录克隆到本地</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~<span class="comment"># git clone git@192.168.27.11:mylinuxops/python.git</span></span><br></pre></td></tr></table></figure>

<p>将扫描配置文件和python代码复制到项目目录内</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~<span class="comment"># cp sonar-examples-master/projects/languages/python/python-sonar-runner/sonar-project.properties python/</span></span><br><span class="line">root@master:~<span class="comment"># cp -a sonar-examples-master/projects/languages/python/python-sonar-runner/src python/</span></span><br></pre></td></tr></table></figure>

<p>修改扫描配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~/python<span class="comment"># vim sonar-project.properties </span></span><br><span class="line"><span class="comment"># Required metadata</span></span><br><span class="line">sonar.projectKey=python</span><br><span class="line">sonar.projectName=Python</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line"><span class="comment"># Comma-separated paths to directories with sources (required)</span></span><br><span class="line">sonar.sources=src</span><br><span class="line"><span class="comment"># Language</span></span><br><span class="line">sonar.language=py</span><br><span class="line"><span class="comment"># Encoding of the source files</span></span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<p>将代码提交到gitlab</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@master:~/python<span class="comment"># git add ./*</span></span><br><span class="line">root@master:~/python<span class="comment"># git commit -m &quot;v2&quot;</span></span><br><span class="line">root@master:~/python<span class="comment"># git push</span></span><br></pre></td></tr></table></figure>

<p>在jenkins上安装插件</p>
<p><img src="plugin.png" alt="plugin.png"></p>
<p>配置扫描器</p>
<p><img src="config1.png" alt="config1.png"></p>
<p><img src="config2.png" alt="config2.png"></p>
<p><img src="config3.png" alt="config3.png"></p>
<p><img src="config4.png" alt="config4.png"></p>
<p>配置代码质量检测</p>
<p><img src="jc1.png" alt="jc1.png"></p>
<p>扫描器配置参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sonar.projectKey=python</span><br><span class="line">sonar.projectName=python</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line">sonar.sources=src</span><br><span class="line">sonar.language=py</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<p><img src="jc2.png" alt="jc2.png"></p>
<p><img src="jc3.png" alt="jc3.png"></p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>apache虚拟主机</title>
    <url>/2019/04/20/Httpd/Apache%20%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%8A%80%E6%9C%AF/Apache%20%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%8A%80%E6%9C%AF/</url>
    <content><![CDATA[<p>某些小型公司为了提供站点给用户访问，而去购买了一台服务器，但是站点访问量又不大，这样就造成了资源的浪费。为了避免不必要的资源浪费，大多数的主机供应商，通常将多个访问量较小的站点存放在一台主机上对外进行服务，这里就需要用到虚拟主机的技术。</p>
<p>apache虚拟主机的实现可以基于3种方式实现</p>
<ol>
<li>基于端口的不同实现</li>
<li>基于IP的不同实现</li>
<li>基于虚拟主机头的不同实现<span id="more"></span></li>
</ol>
<hr>
<h2 id="一、基于端口的不同实现虚拟主机"><a href="#一、基于端口的不同实现虚拟主机" class="headerlink" title="一、基于端口的不同实现虚拟主机"></a>一、基于端口的不同实现虚拟主机</h2><p>基于端口就是将每个站点的以端口为标识进行区分开，但是这样做优缺点，访问时需要输入IP加端口号</p>
<h3 id="1-创建配置文件"><a href="#1-创建配置文件" class="headerlink" title="1.创建配置文件"></a>1.创建配置文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/httpd/conf.d/vhosts.conf</span></span><br><span class="line">Listen 8001                     <span class="comment">#分别建立不同的端口用于给不同的虚拟主机服务</span></span><br><span class="line">Listen 8002</span><br><span class="line">Listen 8003</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8001&gt;</span><br><span class="line">DocumentRoot <span class="string">&quot;/data/html/a&quot;</span></span><br><span class="line">&lt;directory <span class="string">&quot;/data/html/a&quot;</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8002&gt;</span><br><span class="line">DocumentRoot <span class="string">&quot;/data/html/b&quot;</span></span><br><span class="line">&lt;directory <span class="string">&quot;/data/html/b&quot;</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8003&gt;</span><br><span class="line">DocumentRoot <span class="string">&quot;/data/html/c&quot;</span></span><br><span class="line">&lt;directory <span class="string">&quot;/data/html/c&quot;</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-为虚拟主机创建目录及站点主页"><a href="#2-为虚拟主机创建目录及站点主页" class="headerlink" title="2.为虚拟主机创建目录及站点主页"></a>2.为虚拟主机创建目录及站点主页</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/httpd/conf.d/vhosts.conf</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># mkdir /data/html/&#123;a,b,c&#125; -pv</span></span><br><span class="line">mkdir: created directory ‘/data/html’</span><br><span class="line">mkdir: created directory ‘/data/html/a’</span><br><span class="line">mkdir: created directory ‘/data/html/b’</span><br><span class="line">mkdir: created directory ‘/data/html/c’</span><br><span class="line"></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># echo &quot;www.a.com&quot; &gt; /data/html/a/index.html</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># echo &quot;www.b.com&quot; &gt; /data/html/b/index.html</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># echo &quot;www.c.com&quot; &gt; /data/html/c/index.html</span></span><br></pre></td></tr></table></figure>

<h3 id="3-重启服务测试"><a href="#3-重启服务测试" class="headerlink" title="3.重启服务测试"></a>3.重启服务测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># systemctl restart httpd</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># curl 192.168.73.111:8001       #访问8001端口时，访问的站点为a.com</span></span><br><span class="line">www.a.com</span><br><span class="line">[root@mylinuxops ~]<span class="comment"># curl 192.168.73.111:8002       #访问8002端口时，访问的站点为b.com</span></span><br><span class="line">www.b.com</span><br><span class="line">[root@mylinuxops ~]<span class="comment"># curl 192.168.73.111:8003       #访问8003端口时，访问的站点为c.com</span></span><br><span class="line">www.c.com</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、基于IP实现虚拟主机"><a href="#二、基于IP实现虚拟主机" class="headerlink" title="二、基于IP实现虚拟主机"></a>二、基于IP实现虚拟主机</h2><p>基于IP就是将每个站点绑在不同的IP地址上来实现，缺点是需要手上有多个公网的IP</p>
<h3 id="1-为主机配置多个ip地址"><a href="#1-为主机配置多个ip地址" class="headerlink" title="1.为主机配置多个ip地址"></a>1.为主机配置多个ip地址</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># ip a a 192.168.73.112/24 dev ens33</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># ip a a 192.168.73.113/24 dev ens33</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># ip a show ens33</span></span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:3e:ba:5c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.73.111/24 brd 192.168.73.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.73.112/24 scope global secondary ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.73.113/24 scope global secondary ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe3e:ba5c/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h3 id="2-修改配置文件"><a href="#2-修改配置文件" class="headerlink" title="2.修改配置文件"></a>2.修改配置文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/httpd/conf.d/vhosts.conf</span></span><br><span class="line">&lt;VirtualHost 192.168.73.111:80&gt;</span><br><span class="line">DocumentRoot <span class="string">&quot;/data/html/a&quot;</span></span><br><span class="line">&lt;directory <span class="string">&quot;/data/html/a&quot;</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 192.168.73.112:80&gt;</span><br><span class="line">DocumentRoot <span class="string">&quot;/data/html/b&quot;</span></span><br><span class="line">&lt;directory <span class="string">&quot;/data/html/b&quot;</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 192.168.73.113:80&gt;</span><br><span class="line">DocumentRoot <span class="string">&quot;/data/html/c&quot;</span></span><br><span class="line">&lt;directory <span class="string">&quot;/data/html/c&quot;</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-重启服务测试-1"><a href="#3-重启服务测试-1" class="headerlink" title="3.重启服务测试"></a>3.重启服务测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># systemctl restart httpd</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># curl 192.168.73.111</span></span><br><span class="line">www.a.com</span><br><span class="line">[root@mylinuxops ~]<span class="comment"># curl 192.168.73.112</span></span><br><span class="line">www.b.com</span><br><span class="line">[root@mylinuxops ~]<span class="comment"># curl 192.168.73.113</span></span><br><span class="line">www.c.com</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、基于虚拟主机头的不同实现"><a href="#三、基于虚拟主机头的不同实现" class="headerlink" title="三、基于虚拟主机头的不同实现"></a>三、基于虚拟主机头的不同实现</h2><p>基于虚拟主机头，是根据http报文头中，ServerName的不同来实现根据不同的访问请求，返回不同的资源。</p>
<h3 id="1-修改配置文件"><a href="#1-修改配置文件" class="headerlink" title="1.修改配置文件"></a>1.修改配置文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/httpd/conf.d/vhosts.conf</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">ServerName www.a.com                    <span class="comment">#在每个虚拟主机的配置中加入ServerName来标识不同</span></span><br><span class="line">DocumentRoot <span class="string">&quot;/data/html/a&quot;</span></span><br><span class="line">&lt;directory <span class="string">&quot;/data/html/a&quot;</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">ServerName www.b.com</span><br><span class="line">DocumentRoot <span class="string">&quot;/data/html/b&quot;</span></span><br><span class="line">&lt;directory <span class="string">&quot;/data/html/b&quot;</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">ServerName www.c.com</span><br><span class="line">DocumentRoot <span class="string">&quot;/data/html/c&quot;</span></span><br><span class="line">&lt;directory <span class="string">&quot;/data/html/c&quot;</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-修改hosts文件，指定DNS"><a href="#2-修改hosts文件，指定DNS" class="headerlink" title="2.修改hosts文件，指定DNS"></a>2.修改hosts文件，指定DNS</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.73.111 www.a.com www.b.com www.c.com</span><br></pre></td></tr></table></figure>

<h3 id="3-重启服务测试-2"><a href="#3-重启服务测试-2" class="headerlink" title="3.重启服务测试"></a>3.重启服务测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># curl www.a.com</span></span><br><span class="line">www.a.com</span><br><span class="line">[root@mylinuxops ~]<span class="comment"># curl www.b.com</span></span><br><span class="line">www.b.com</span><br><span class="line">[root@mylinuxops ~]<span class="comment"># curl www.c.com</span></span><br><span class="line">www.c.com</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>http各版本协议区别</title>
    <url>/2019/04/15/Httpd/Http%E5%90%84%E7%89%88%E6%9C%AC%E5%8D%8F%E8%AE%AE%E5%8C%BA%E5%88%AB/Http%E5%90%84%E7%89%88%E6%9C%AC%E5%8D%8F%E8%AE%AE%E5%8C%BA%E5%88%AB/</url>
    <content><![CDATA[<h2 id="1-0和1-1区别"><a href="#1-0和1-1区别" class="headerlink" title="1.0和1.1区别"></a>1.0和1.1区别</h2><table>
<thead>
<tr>
<th align="left">区别</th>
<th align="left">http1.0</th>
<th align="left">http2.0</th>
</tr>
</thead>
<tbody><tr>
<td align="left">缓存处理</td>
<td align="left">主要使用hearder中的if-Modified-since，Expires（过期时间）来做为缓存判断的标准</td>
<td align="left">则引入了更多的缓存控制策略例如Entity tag，If-Unmodified-Since, If-Match, If-None-Match等更多可供选择的缓存头来控制缓存策略</td>
</tr>
<tr>
<td align="left">带宽优化及网络连接的使用</td>
<td align="left">存在一些浪费带宽的现象，例如客户端只是需要某 个对象的一部分，而服务器却将整个对象送过来了，并且不支持断点续传功能</td>
<td align="left">在 请求头引入了range头域，它允许只请求资源的某个部分，即返回码是206（Partial Content）， 方便了开发者自由的选择以便于充分利用带宽和连接</td>
</tr>
<tr>
<td align="left">错误通知的管理</td>
<td align="left"></td>
<td align="left">新增24个状态响应码</td>
</tr>
<tr>
<td align="left">Host头处理</td>
<td align="left">在HTTP1.0中认为每台服务器都绑定一个唯一的IP地址，因此，请求消息中的 URL并没有传递主机名（hostname）</td>
<td align="left">。HTTP1.1的请 求消息和响应消息都应支持Host头域，且请求消息中如果没有Host头域会报告一个错误（400 Bad Request）</td>
</tr>
<tr>
<td align="left">长连接</td>
<td align="left">不支持持久连接每次请求都需要要3次握手</td>
<td align="left">在一个tcp连接上可以传送多个http请求和相应</td>
</tr>
</tbody></table>
<h2 id="1-1和2-0区别"><a href="#1-1和2-0区别" class="headerlink" title="1.1和2.0区别"></a>1.1和2.0区别</h2><p>1.头信息和数据体都是二进制，称为头信息帧和数据帧<br>2.支持复用的tcp连接，在一个连接里，客户端和浏览器都可以同时发送请求或回应，并且不用按顺序对应，避免”队头堵塞”，此双方的实施通信称为多工<br>3.引入都信息压缩机制，头信息使用gzip或compress压缩后在发送;客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，不发送同样字段，只发送索引号，提高速度<br>4.允许服务器未经请求，主动向客户端发送资源，即服务器推送。</p>
<h2 id="http工作机制"><a href="#http工作机制" class="headerlink" title="http工作机制"></a>http工作机制</h2><p>客户端发起请求，dns对域名进行解析，获取到IP地址后，客户点和服务器端进行建立起连接，服务器收到请求后对请求进行处理，以get为例，服务器收到get请求，就去硬盘上加载客户端所需要的请求到http服务器中，http在响应客户端时在资源的头部加上http报文头部，构建成响应报文，在响应报文头部封装tcp头，封装ip头，封装数据链路层头然后发至用户，用户得到报文后，拆除所有头部得到http页面，服务器端将刚才用户访问的信息记录至访问日志中。</p>
<h2 id="web服务器响应模型"><a href="#web服务器响应模型" class="headerlink" title="web服务器响应模型"></a>web服务器响应模型</h2><ol>
<li><p>单进程I/O模型:服务器端开启一个进程为客户端进行服务，并且一次只处理一个请求，只有当前一个请求被处理完才会处理下一个请求，多个请求被串行响应。</p>
</li>
<li><p>多进程I/O模型:同时启动多个进程，每个进程响应一个用户请求</p>
</li>
<li><p>复用I/O模型:开启一个进程，同时响应多个请求，复用IO模型又分为多线程模型和事件驱动模型</p>
<p> 多线程模型:一个进程生成多个线程，每个线程响应一个用户请求</p>
<p> 时间驱动：一个进程同时能响应多个用户请求</p>
</li>
<li><p>复用的多进程I/O模型:一次启动多个进程，每个进程又同时启用多个线程来响应用户请求。</p>
</li>
</ol>
<h2 id="响应码"><a href="#响应码" class="headerlink" title="响应码"></a>响应码</h2><table>
<thead>
<tr>
<th align="left">响应码</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">200</td>
<td align="left">成功，请求数据通过响应报文的entity-body部分发送;OK</td>
</tr>
<tr>
<td align="left">301</td>
<td align="left">请求的URL指向的资源已经被删除；但在响应报文中通过首部Location指明了资源现在所处的新位置；Moved Permanently</td>
</tr>
<tr>
<td align="left">302</td>
<td align="left">响应报文Location指明资源临时新位置Moved Temporarily</td>
</tr>
<tr>
<td align="left">304</td>
<td align="left">客户端发出了条件式请求，但服务器上的资源未曾发生改变，则通过响应此响应状态码通知客户端；Not Modified</td>
</tr>
<tr>
<td align="left">401</td>
<td align="left">需要输入账号和密码认证方能访问资源；Unauthorized</td>
</tr>
<tr>
<td align="left">403</td>
<td align="left">请求被禁止；Forbidden</td>
</tr>
<tr>
<td align="left">404</td>
<td align="left">服务器无法找到客户端请求的资源；Not Found</td>
</tr>
<tr>
<td align="left">500</td>
<td align="left">服务器内部错误；Internal Server Error</td>
</tr>
<tr>
<td align="left">502</td>
<td align="left">代理服务器从后端服务器收到了一条伪响应，如无法连接到网关；Bad Gateway</td>
</tr>
<tr>
<td align="left">503</td>
<td align="left">服务不可用，临时服务器维护或过载，服务器无法处理请求</td>
</tr>
<tr>
<td align="left">504</td>
<td align="left">网关超时</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>互联网LAMP架构实现（一）</title>
    <url>/2019/04/21/Httpd/LAMP%E9%AB%98%E7%BA%A7%E6%9E%B6%E6%9E%84/LAMP%E9%AB%98%E7%BA%A7%E6%9E%B6%E6%9E%84/</url>
    <content><![CDATA[<p>在互联网上架构如下图所示，本节将演示如何实现以下架构并安装wordpress，此处以DNS作为高可用和负载均衡。</p>
<span id="more"></span>

<p><img src="lamp.png" alt="lamp.png"></p>
<table>
<thead>
<tr>
<th align="left">主机类型</th>
<th align="left">主机名</th>
<th align="left">系统</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Client</td>
<td align="left">Clinet</td>
<td align="left">Fedora30</td>
<td align="left">192.168.73.153</td>
</tr>
<tr>
<td align="left">DNS</td>
<td align="left">DNS</td>
<td align="left">CentOS7.6</td>
<td align="left">192.168.73.101</td>
</tr>
<tr>
<td align="left">HTTPD+PHP</td>
<td align="left">HTTPD</td>
<td align="left">CentOS7.6</td>
<td align="left">192.168.73.110</td>
</tr>
<tr>
<td align="left">HTTPD+PHP</td>
<td align="left">HTTPD2</td>
<td align="left">CentOS7.6</td>
<td align="left">192.168.73.111</td>
</tr>
<tr>
<td align="left">NFS</td>
<td align="left">nfs</td>
<td align="left">CentOS7.6</td>
<td align="left">192.168.73.120</td>
</tr>
<tr>
<td align="left">MySQL</td>
<td align="left">Master</td>
<td align="left">CentOS7.6</td>
<td align="left">192.168.73.130</td>
</tr>
<tr>
<td align="left">MySQL</td>
<td align="left">Slave1</td>
<td align="left">CentOS7.6</td>
<td align="left">192.168.73.131</td>
</tr>
<tr>
<td align="left">MySQL</td>
<td align="left">Slave2</td>
<td align="left">CentOS7.6</td>
<td align="left">192.168.73.132</td>
</tr>
</tbody></table>
<h2 id="一、搭建MySQL主从"><a href="#一、搭建MySQL主从" class="headerlink" title="一、搭建MySQL主从"></a>一、搭建MySQL主从</h2><p>在所有MySQL服务器安装MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install mariadb-server -y</span><br></pre></td></tr></table></figure>

<h3 id="Master节点操作"><a href="#Master节点操作" class="headerlink" title="Master节点操作"></a>Master节点操作</h3><p>1.配置主节点服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=/data/bin/mysql-bin</span><br><span class="line">binlog-format=row</span><br></pre></td></tr></table></figure>

<p>2.创建二进制日志目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mkdir /data/bin</span></span><br><span class="line">[root@master ~]<span class="comment"># chown -R mysql.mysql /data/bin</span></span><br><span class="line">[root@master ~]<span class="comment"># chmod 700 /data/bin</span></span><br></pre></td></tr></table></figure>

<p>3.启动MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<p>4.创建一个用来主从复制的账号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -e &quot;GRANT REPLICATION SLAVE ON *.* TO &#x27;repluser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;111111&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<p>5.查看二进制日志，记录日志大小</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -e &quot;SHOW MASTER LOGS;&quot;</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |     26753 |</span><br><span class="line">| mysql-bin.000002 |    921736 |</span><br><span class="line">| mysql-bin.000003 |       402 |</span><br><span class="line">+------------------+-----------+</span><br></pre></td></tr></table></figure>

<h3 id="Slave1节点操作"><a href="#Slave1节点操作" class="headerlink" title="Slave1节点操作"></a>Slave1节点操作</h3><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@slave1 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only</span><br></pre></td></tr></table></figure>

<p>2.启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@slave1 ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<p>3.CHANGE MASTER TO</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@slave1 ~]<span class="comment"># mysql</span></span><br><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO   MASTER_HOST=<span class="string">&#x27;192.168.73.130&#x27;</span>,   MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,   MASTER_PASSWORD=<span class="string">&#x27;111111&#x27;</span>,   MASTER_PORT=3306,   MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000003&#x27;</span>,   MASTER_LOG_POS=402;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>4.查看slave状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.73.130</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 402</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 402</span><br><span class="line">              Relay_Log_Space: 245</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 0</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure>

<p>5.启动复制线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>6.查看slave状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.130</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 402</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 529</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 402</span><br><span class="line">              Relay_Log_Space: 825</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure>

<p>7.测试</p>
<p>主节点导入测试表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql &lt; hellodb_innodb.sql</span></span><br></pre></td></tr></table></figure>

<p>8.slave1节点查看</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@slave1 ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>Slave1节点搭建完毕</p>
<h3 id="Slave2节点操作"><a href="#Slave2节点操作" class="headerlink" title="Slave2节点操作"></a>Slave2节点操作</h3><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@slave2 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=3</span><br><span class="line">read-only</span><br></pre></td></tr></table></figure>

<p>2.启动MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@slave2 ~]<span class="comment"># systemctl restart mariadb</span></span><br></pre></td></tr></table></figure>

<p>3.CHANGE MASTER TO</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@slave2 ~]<span class="comment"># mysql</span></span><br><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO   MASTER_HOST=<span class="string">&#x27;192.168.73.130&#x27;</span>,   MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,   MASTER_PASSWORD=<span class="string">&#x27;111111&#x27;</span>,   MASTER_PORT=3306,   MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000003&#x27;</span>,   MASTER_LOG_POS=402;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>4.查看slave状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.73.130</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 402</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 402</span><br><span class="line">              Relay_Log_Space: 245</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 0</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure>

<p>5.启动复制线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>6.查看数据库是否同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>数据库主从搭建完毕</p>
<h2 id="二、搭建HTTPD-PHP"><a href="#二、搭建HTTPD-PHP" class="headerlink" title="二、搭建HTTPD+PHP"></a>二、搭建HTTPD+PHP</h2><p>分别在两台httpd主机上安装httpd和php-fpm</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install httpd php-fpm php-mysql -y</span><br></pre></td></tr></table></figure>

<h3 id="配置httpd服务器"><a href="#配置httpd服务器" class="headerlink" title="配置httpd服务器"></a>配置httpd服务器</h3><p>1.查看fcgi相关模块是否启用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># httpd -M | grep proxy</span></span><br><span class="line"> proxy_module (shared)                      <span class="comment">#已经启用</span></span><br><span class="line"> proxy_ajp_module (shared)</span><br><span class="line"> proxy_balancer_module (shared)</span><br><span class="line"> proxy_connect_module (shared)</span><br><span class="line"> proxy_express_module (shared)</span><br><span class="line"> proxy_fcgi_module (shared)                 <span class="comment">#已经启用</span></span><br><span class="line"> proxy_fdpass_module (shared)</span><br><span class="line"> proxy_ftp_module (shared)</span><br><span class="line"> proxy_http_module (shared)</span><br><span class="line"> proxy_scgi_module (shared)</span><br><span class="line"> proxy_wstunnel_module (shared)</span><br></pre></td></tr></table></figure>

<p>2.修改httpd配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">    DirectoryIndex index.php index.html</span><br><span class="line"></span><br><span class="line">addtype application/x-httpd-php .php</span><br><span class="line">addtype applictaion/x-httpd-php-source .phps</span><br><span class="line">proxyrequests off</span><br><span class="line">proxyPassMatch ^/(.*\.php)$ unix:/var/run/php.sock|fcgi://localhost/data/<span class="built_in">test</span>/<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">&lt;Virtualhost *:80&gt;</span><br><span class="line">servername blog.mylinuxops.com</span><br><span class="line">Documentroot /data/<span class="built_in">test</span></span><br><span class="line">&lt;directory /data/<span class="built_in">test</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line">&lt;/Virtualhost&gt;</span><br></pre></td></tr></table></figure>

<p>3.修改php-fpm配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># vim /etc/php-fpm.d/www.conf</span></span><br><span class="line">;listen = 127.0.0.1:9000</span><br><span class="line">listen = /var/run/php.sock</span><br><span class="line">listen.mode = 0666</span><br><span class="line">;listen.allowed_clients = 127.0.0.1</span><br></pre></td></tr></table></figure>

<p>4.修改php.ini中时区</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># vim /etc/php.ini</span></span><br><span class="line">date.timezone = Asia/Shanghai</span><br></pre></td></tr></table></figure>

<p>5.启动httpd、php-fpm</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># systemctl start httpd php-fpm</span></span><br></pre></td></tr></table></figure>

<p>6.创建测试页</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># mkdir /data/test</span></span><br><span class="line">[root@httpd ~]<span class="comment"># vim /data/test/index.php</span></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$dsn</span>=<span class="string">&#x27;mysql:host=192.168.73.130;dbname=test&#x27;</span>;</span><br><span class="line"><span class="variable">$username</span>=<span class="string">&#x27;repluser&#x27;</span>; <span class="variable">$passwd</span>=<span class="string">&#x27;111111&#x27;</span>;</span><br><span class="line"><span class="variable">$dbh</span>=new PDO(<span class="variable">$dsn</span>,<span class="variable">$username</span>,<span class="variable">$passwd</span>);</span><br><span class="line">var_dump(<span class="variable">$dbh</span>);</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>7.测试</p>
<p><img src="1.png" alt="1.png"></p>
<h3 id="配置httpd2服务器"><a href="#配置httpd2服务器" class="headerlink" title="配置httpd2服务器"></a>配置httpd2服务器</h3><p>1.从httpd服务器将httpd配置文件及php-fpm配置文件复制至httpd2</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># scp /etc/httpd/conf/httpd.conf  192.168.73.111:/etc/httpd/conf/httpd.conf</span></span><br><span class="line">[root@httpd ~]<span class="comment"># scp /etc/php-fpm.d/www.conf 192.168.73.111:/etc/php-fpm.d/www.conf</span></span><br></pre></td></tr></table></figure>

<p>2.启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd2 ~]<span class="comment"># systemctl start httpd php-fpm</span></span><br></pre></td></tr></table></figure>

<p>3.创建测试页</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># mkdir /data/test</span></span><br><span class="line">[root@httpd ~]<span class="comment"># vim /data/test/index.php</span></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$dsn</span>=<span class="string">&#x27;mysql:host=192.168.73.130;dbname=test&#x27;</span>;</span><br><span class="line"><span class="variable">$username</span>=<span class="string">&#x27;repluser&#x27;</span>; <span class="variable">$passwd</span>=<span class="string">&#x27;111111&#x27;</span>;</span><br><span class="line"><span class="variable">$dbh</span>=new PDO(<span class="variable">$dsn</span>,<span class="variable">$username</span>,<span class="variable">$passwd</span>);</span><br><span class="line">var_dump(<span class="variable">$dbh</span>);</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>4.测试</p>
<p><img src="2.png" alt="2.png"></p>
<h2 id="配置dns服务器"><a href="#配置dns服务器" class="headerlink" title="配置dns服务器"></a>配置dns服务器</h2><p>1.安装bind服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns ~]<span class="comment"># yum install bind -y</span></span><br></pre></td></tr></table></figure>

<p>2.修改主配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns ~]<span class="comment"># vim /etc/named.conf</span></span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">//      listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line"></span><br><span class="line">//      allow-query     &#123; localhost; &#125;;</span><br></pre></td></tr></table></figure>

<p>3.添加区域记录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns ~]<span class="comment"># vim /etc/named.rfc1912.zones</span></span><br><span class="line">zone <span class="string">&quot;mylinuxops.com&quot;</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> master;</span><br><span class="line">        file <span class="string">&quot;mylinuxops.com.zone&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>4.创建区域数据库文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns etc]<span class="comment"># cp -p /var/named/named.localhost /var/named/mylinuxops.com.zone</span></span><br><span class="line">[root@dns etc]<span class="comment"># vim /var/named/mylinuxops.com.zone</span></span><br><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@       IN SOA  master admin.mylinuxops.com (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      master</span><br><span class="line">master  A       192.168.73.101</span><br><span class="line">www     A       192.168.73.110</span><br><span class="line">www     A       192.168.73.111</span><br></pre></td></tr></table></figure>

<p>5.检查语法错误</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns etc]<span class="comment"># named-checkconf</span></span><br><span class="line">[root@dns etc]<span class="comment"># named-checkzone mylinuxops.com /var/named/mylinuxops.com.zone</span></span><br><span class="line">zone mylinuxops.com/IN: loaded serial 0</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>6.启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns etc]<span class="comment"># systemctl start named</span></span><br></pre></td></tr></table></figure>

<p>7.测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns etc]<span class="comment"># dig www.mylinuxops.com @192.168.73.101</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-72.el7 &lt;&lt;&gt;&gt; www.mylinuxops.com @192.168.73.101</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 10093</span></span><br><span class="line"><span class="string">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;www.mylinuxops.com.        IN    A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">www.mylinuxops.com.    86400    IN    A    192.168.73.111</span></span><br><span class="line"><span class="string">www.mylinuxops.com.    86400    IN    A    192.168.73.110</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; AUTHORITY SECTION:</span></span><br><span class="line"><span class="string">mylinuxops.com.        86400    IN    NS    master.mylinuxops.com.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ADDITIONAL SECTION:</span></span><br><span class="line"><span class="string">master.mylinuxops.com.    86400    IN    A    192.168.73.101</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 0 msec</span></span><br><span class="line"><span class="string">;; SERVER: 192.168.73.101#53(192.168.73.101)</span></span><br><span class="line"><span class="string">;; WHEN: Fri May 17 06:00:35 CST 2019</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 116</span></span><br></pre></td></tr></table></figure>

<h2 id="配置NFS服务"><a href="#配置NFS服务" class="headerlink" title="配置NFS服务"></a>配置NFS服务</h2><p>1.创建出需要共享的目录，修改权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir /data/test/</span></span><br><span class="line">[root@localhost ~]<span class="comment"># setfacl -R -m u:nfsnobody:rwx /data/test</span></span><br></pre></td></tr></table></figure>

<p>2.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/exports</span></span><br><span class="line">/data/<span class="built_in">test</span> *(rw)</span><br></pre></td></tr></table></figure>

<p>3.在httpd挂载nfs</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># showmount -e 192.168.73.120</span></span><br><span class="line">Export list <span class="keyword">for</span> 192.168.73.120:</span><br><span class="line">/data/<span class="built_in">test</span> *</span><br><span class="line">[root@httpd ~]<span class="comment"># mount 192.168.73.120:/data/test /data/test</span></span><br></pre></td></tr></table></figure>

<p>4.在httpd2上挂载nfs</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd2 ~]<span class="comment"># showmount -e 192.168.73.120</span></span><br><span class="line">Export list <span class="keyword">for</span> 192.168.73.120:</span><br><span class="line">/data/<span class="built_in">test</span> *</span><br><span class="line">[root@httpd2 ~]<span class="comment"># mount 192.168.73.120:/data/test /data/test</span></span><br></pre></td></tr></table></figure>

<p>5.在/data/test中创建测试页</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$dsn</span>=<span class="string">&#x27;mysql:host=192.168.73.130;dbname=test&#x27;</span>;</span><br><span class="line"><span class="variable">$username</span>=<span class="string">&#x27;repluser&#x27;</span>; <span class="variable">$passwd</span>=<span class="string">&#x27;111111&#x27;</span>;</span><br><span class="line"><span class="variable">$dbh</span>=new PDO(<span class="variable">$dsn</span>,<span class="variable">$username</span>,<span class="variable">$passwd</span>);</span><br><span class="line">var_dump(<span class="variable">$dbh</span>);</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h2 id="客户端测试"><a href="#客户端测试" class="headerlink" title="客户端测试"></a>客户端测试</h2><p>1.测试DNS</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># dig www.mylinuxops.com</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.5-P4-RedHat-9.11.5-13.P4.fc30 &lt;&lt;&gt;&gt; www.mylinuxops.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 37179</span></span><br><span class="line"><span class="string">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;www.mylinuxops.com.        IN    A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">www.mylinuxops.com.    86400    IN    A    192.168.73.111</span></span><br><span class="line"><span class="string">www.mylinuxops.com.    86400    IN    A    192.168.73.110</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; AUTHORITY SECTION:</span></span><br><span class="line"><span class="string">mylinuxops.com.        86400    IN    NS    master.mylinuxops.com.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ADDITIONAL SECTION:</span></span><br><span class="line"><span class="string">master.mylinuxops.com.    86400    IN    A    192.168.73.101</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 0 msec</span></span><br><span class="line"><span class="string">;; SERVER: 192.168.73.101#53(192.168.73.101)</span></span><br><span class="line"><span class="string">;; WHEN: Thu May 16 22:54:46 CST 2019</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 116</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@localhost ~]# dig www.mylinuxops.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">; &lt;&lt;&gt;&gt; DiG 9.11.5-P4-RedHat-9.11.5-13.P4.fc30 &lt;&lt;&gt;&gt; www.mylinuxops.com</span></span><br><span class="line"><span class="string">;; global options: +cmd</span></span><br><span class="line"><span class="string">;; Got answer:</span></span><br><span class="line"><span class="string">;; -&gt;&gt;HEADER&lt;&lt;- opcode</span>: QUERY, status: NOERROR, id: 63256</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 2</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;www.mylinuxops.com.        IN    A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">www.mylinuxops.com.    86400    IN    A    192.168.73.110</span><br><span class="line">www.mylinuxops.com.    86400    IN    A    192.168.73.111</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">mylinuxops.com.        86400    IN    NS    master.mylinuxops.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">master.mylinuxops.com.    86400    IN    A    192.168.73.101</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 192.168.73.101<span class="comment">#53(192.168.73.101)</span></span><br><span class="line">;; WHEN: Thu May 16 22:54:47 CST 2019</span><br><span class="line">;; MSG SIZE  rcvd: 116</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.测试站点访问</p>
<p><img src="t1.png" alt="t1.png"></p>
<h2 id="测试安装wordpress"><a href="#测试安装wordpress" class="headerlink" title="测试安装wordpress"></a>测试安装wordpress</h2><p>1.解压wordpress到/data/test</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># tar wordpress-5.0.3-zh_CN.tar.gz -C /data/test/</span></span><br></pre></td></tr></table></figure>

<p>2.创建wordpress所需数据库及账户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -e &quot;CREATE DATABASE wordpress&quot;</span></span><br><span class="line">[root@master ~]<span class="comment"># mysql -e &quot;GRANT ALL ON wordpress.* TO &#x27;wpuser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;111111&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<p>3.修改wordpress配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># cp /data/test/wordpress/wp-config-sample.php /data/test/wordpress/wp-config.php</span></span><br><span class="line">[root@httpd ~]<span class="comment"># vim /data/test/wordpress/wp-config.php</span></span><br><span class="line">// ** MySQL 设置 - 具体信息来自您正在使用的主机 ** //</span><br><span class="line">/** WordPress数据库的名称 */</span><br><span class="line">define(<span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;wordpress&#x27;</span>);</span><br><span class="line"></span><br><span class="line">/** MySQL数据库用户名 */</span><br><span class="line">define(<span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;wpuser&#x27;</span>);</span><br><span class="line"></span><br><span class="line">/** MySQL数据库密码 */</span><br><span class="line">define(<span class="string">&#x27;DB_PASSWORD&#x27;</span>, <span class="string">&#x27;111111&#x27;</span>);</span><br><span class="line"></span><br><span class="line">/** MySQL主机 */</span><br><span class="line">define(<span class="string">&#x27;DB_HOST&#x27;</span>, <span class="string">&#x27;192.168.73.130&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>4.在客户端测试访问</p>
<p><img src="t2.png" alt="t2.png"></p>
<p><img src="t3.png" alt="t3.png"></p>
]]></content>
      <categories>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>httpd基本配置和参数</title>
    <url>/2019/04/19/Httpd/httpd%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/httpd%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>本节将讲述httpd的相关配置文件以及一些常见配置的使用方法</p>
<span id="more"></span>

<h2 id="一、httpd相关的文件和目录"><a href="#一、httpd相关的文件和目录" class="headerlink" title="一、httpd相关的文件和目录"></a>一、httpd相关的文件和目录</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/etc/httpd/conf.modules.d   <span class="comment">#此目录存放了模块的配置文件，模块是否启用</span></span><br><span class="line">/etc/httpd/conf/httpd.conf  <span class="comment">#httpd的主配置文件</span></span><br><span class="line">/etc/httpd/conf.d           <span class="comment">#httpd配置文件存放目录此目录下以.conf结尾的都为httpd配置文件</span></span><br><span class="line">/usr/lib64/httpd/modules    <span class="comment">#httpd模块相关的文件</span></span><br><span class="line">/usr/sbin/apachectl         <span class="comment">#httpd启动程序，和systemctl start|stop|... httpd相同</span></span><br><span class="line">/usr/sbin/httpd</span><br><span class="line">/var/<span class="built_in">log</span>/httpd              <span class="comment">#存放了httpd的日志，access_log访问日志，error_log错误日志</span></span><br><span class="line">/var/www/html               <span class="comment">#httpd站点网页存放目录</span></span><br><span class="line">/etc/httpd/run/httpd.pid    <span class="comment">#httpd的主进程文件，里面存放了httpd的进程编号</span></span><br></pre></td></tr></table></figure>

<h2 id="二、httpd的帮助文档包"><a href="#二、httpd的帮助文档包" class="headerlink" title="二、httpd的帮助文档包"></a>二、httpd的帮助文档包</h2><p>安装httpd-manual，启动httpd服务口可以在本地查看httpd相关的帮助</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># yum install httpd-manual -y</span></span><br></pre></td></tr></table></figure>

<h2 id="三、httpd常见配置"><a href="#三、httpd常见配置" class="headerlink" title="三、httpd常见配置"></a>三、httpd常见配置</h2><p>httpd安装后启动服务，并配置为开机自动启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># systemctl enable httpd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl start httpd</span></span><br></pre></td></tr></table></figure>

<h3 id="1-ServerTokens"><a href="#1-ServerTokens" class="headerlink" title="1.ServerTokens"></a>1.ServerTokens</h3><p>配置服务器响应报文头部中显示服务器类型和版本号</p>
<table>
<thead>
<tr>
<th align="left">可用选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Full</td>
<td align="left">显示所有信息</td>
</tr>
<tr>
<td align="left">Prod</td>
<td align="left">显示类型</td>
</tr>
<tr>
<td align="left">Major</td>
<td align="left">显示类型，主版本号</td>
</tr>
<tr>
<td align="left">Minor</td>
<td align="left">显示类型，主版本号，次版本号，跟新次数</td>
</tr>
<tr>
<td align="left">OS</td>
<td align="left">显示类型，主版本号，次版本号，跟新次数，系统类型</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>Prod在实际生产环境中显示的越少越好，如果要不显示需要对代码修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">ServerTokens Prod</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload httpd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># curl -I 192.168.73.110</span></span><br><span class="line">Server: Apache</span><br></pre></td></tr></table></figure>

<h3 id="2-Listen"><a href="#2-Listen" class="headerlink" title="2.Listen"></a>2.Listen</h3><p>监听的端口和地址，可以监听在多各端口和地址上，需要写多行</p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Listen PORT</td>
<td align="left">监听所有地址的某端口</td>
</tr>
<tr>
<td align="left">Listen IP:PORT</td>
<td align="left">监听所有地址的ip和端口</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">Listen 192.168.73.110:80</span><br><span class="line">Listen 172.22.144.83:8080</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl restart httpd                 #端口修改后需要重启服务</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ss -tnl | grep 80</span></span><br><span class="line">LISTEN     0      128    172.22.144.83:8080                     *:*  </span><br><span class="line">LISTEN     0      128    192.168.73.110:80                       *:*  </span><br></pre></td></tr></table></figure>

<h3 id="3-KeepAlive"><a href="#3-KeepAlive" class="headerlink" title="3.KeepAlive"></a>3.KeepAlive</h3><p>持久连接，此选项默认开启，需要和KeepAliveTimeout结合使用</p>
<p>KeepAlive选项</p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">On</td>
<td align="left">开启</td>
</tr>
<tr>
<td align="left">Off</td>
<td align="left">关闭</td>
</tr>
</tbody></table>
<p>KeepAliveTimeout num[ms]超时时长默认为5秒  </p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">KeepAlive On</span><br><span class="line">KeepAliveTimeout 10</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload httpd</span></span><br></pre></td></tr></table></figure>

<h3 id="4-DocumentRoot-“-path”"><a href="#4-DocumentRoot-“-path”" class="headerlink" title="4.DocumentRoot “/path”"></a>4.DocumentRoot “/path”</h3><p>定义网页文档存放路径</p>
<p>文档路径映射，指向的路径为URL路径的起始位置，默认路径为”/var/www/html”在http2.2上只需修改此项就能访问，2.4以上修改后还需要对目录授权。</p>
<p>示例：将映射路径指向别处</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">DocumentRoot <span class="string">&quot;/data/html&quot;</span></span><br><span class="line">&lt;Directory <span class="string">&quot;/data/html&quot;</span>&gt;       定义对目录授权</span><br><span class="line">    Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir /data/html</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chmod 755 /data/html/</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo &quot;&lt;h1&gt;welcome to www.mylinuxops.com&lt;/h1&gt;&quot; &gt; /data/html/index.html</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl restart httpd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># curl 192.168.73.110</span></span><br><span class="line">&lt;h1&gt;welcome to www.mylinuxops.com&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<h3 id="5-DirectoryIndex-定义站点主页面"><a href="#5-DirectoryIndex-定义站点主页面" class="headerlink" title="5.DirectoryIndex 定义站点主页面"></a>5.DirectoryIndex 定义站点主页面</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DirectoryIndex index.html   <span class="comment">#当访问某网站时不需要指定文件，默认找index.html</span></span><br></pre></td></tr></table></figure>

<h3 id="6-站点的访问控制机制"><a href="#6-站点的访问控制机制" class="headerlink" title="6.站点的访问控制机制"></a>6.站点的访问控制机制</h3><p>可以基于两种机制指明对哪些资源进行何种访问控制。  </p>
<p>访问控制机制有两种，可以基于客户端来源地址和用户账号。  </p>
<p>可以进行访问控制的资源：  </p>
<p>文件系统路径：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Directory <span class="string">&quot;/path&quot;</span>&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;File <span class="string">&quot;/path/file&quot;</span>&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/File&gt;</span><br><span class="line"></span><br><span class="line">&lt;FileMatch <span class="string">&quot;PATTERN&quot;</span>&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/FileMatch&gt;</span><br></pre></td></tr></table></figure>

<p>URL路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Location <span class="string">&quot;&quot;</span>&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">&lt;LocationMatch <span class="string">&quot;&quot;</span>&gt;</span><br><span class="line">...</span><br><span class="line">&lt;LocationMatch&gt;</span><br></pre></td></tr></table></figure>

<h3 id="7-对资源的访问控制"><a href="#7-对资源的访问控制" class="headerlink" title="7.对资源的访问控制"></a>7.对资源的访问控制</h3><h4 id="7-1-Options"><a href="#7-1-Options" class="headerlink" title="7.1 Options"></a>7.1 Options</h4><p>options后面跟了1个或多个以空白字符分割的选项列表在选项前+，—表示增加或删除指定选项，该选项会应用在目录下的所有子目录，若子目录中有AllowOverRide选项则会由AllowOverRide中定义的选项来覆盖当前的选项。</p>
<table>
<thead>
<tr>
<th align="left">options</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">all</td>
<td align="left">全部允许</td>
</tr>
<tr>
<td align="left">none</td>
<td align="left">全部禁用</td>
</tr>
<tr>
<td align="left">indexes</td>
<td align="left">要访问的URL路径下不存在与定义的主页面资源相符的资源文件时，返回索引列表给用户</td>
</tr>
<tr>
<td align="left">FollowSymlinks</td>
<td align="left">允许访问符号连接文件所指向的源文件</td>
</tr>
</tbody></table>
<p>生产中不建议将indexes启用有安全风险  </p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Directory <span class="string">&quot;/data/html&quot;</span>&gt;</span><br><span class="line">    options all     <span class="comment">#启用所有选项</span></span><br><span class="line">    Require all grant</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Directory <span class="string">&quot;/data/html&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    options all -indexes    <span class="comment">#启用所有选项，除了indexes</span></span><br><span class="line">    Require all grant</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Directory <span class="string">&quot;/data/html&quot;</span>&gt;</span><br><span class="line">    options indexes followsymlinks    <span class="comment">#启用indexes和followSymlinks</span></span><br><span class="line">    Require all grant</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<h4 id="7-2-AllowOverRide"><a href="#7-2-AllowOverRide" class="headerlink" title="7.2 AllowOverRide"></a>7.2 AllowOverRide</h4><p>这个功能需要在目录下创建一个.htaccess的文件，在文件中定义启用哪些访问控制选项，然后使用allowoverride来启用这些选项或禁用这些选项，.htaccess中的选项启用之后会覆盖之前的配置指令</p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">all</td>
<td align="left">.htaccess中所有指令都有效</td>
</tr>
<tr>
<td align="left">none</td>
<td align="left">.htaccess中所有中指令都无效</td>
</tr>
<tr>
<td align="left">AuthConfig</td>
<td align="left"></td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost html]<span class="comment"># cat /data/html/.htaccess</span></span><br><span class="line">options indexes followsymLinks</span><br><span class="line">&lt;Directory <span class="string">&quot;/data/html&quot;</span>&gt;</span><br><span class="line">    AllowOverride all</span><br><span class="line">    Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<h4 id="7-3-基于ip的访问控制"><a href="#7-3-基于ip的访问控制" class="headerlink" title="7.3 基于ip的访问控制"></a>7.3 基于ip的访问控制</h4><p>无明确授权的目录，默认拒绝  </p>
<p>Require all granted:允许所有访问  </p>
<p>Require all denied:拒绝所有访问</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Directory <span class="string">&quot;/data/html&quot;</span>&gt;</span><br><span class="line">options indexes followsymlinks</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<h5 id="控制特定的IP访问"><a href="#控制特定的IP访问" class="headerlink" title="控制特定的IP访问"></a>控制特定的IP访问</h5><p>Require ip IPADDR:授权指定的IP访问  </p>
<p><em><strong>需要将其嵌套在&lt;requireany&gt;…&lt;\requireany&gt;之内定义，先将所有访问拒绝，再允许某ip访问</strong></em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Directory <span class="string">&quot;/data/html&quot;</span>&gt;</span><br><span class="line">options indexes followsymlinks</span><br><span class="line">&lt;requireany&gt;</span><br><span class="line">Require all denied</span><br><span class="line">Require ip 192.168.73.111</span><br><span class="line">&lt;/requireany&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p>Require not ip IPADDR:授权特定ip拒绝访问  </p>
<p><em><strong>需要将其嵌套再&lt;requireall&gt;…&lt;\requireall&gt;之内定义，允许所有访问，然后拒绝某ip访问</strong></em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Directory <span class="string">&quot;/data/html&quot;</span>&gt;</span><br><span class="line">options indexes followsymlinks</span><br><span class="line">&lt;requireall&gt;</span><br><span class="line">Require all granted</span><br><span class="line">Require not ip  192.168.73.111</span><br><span class="line">&lt;/requireall&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<h5 id="控制特定的主机访问"><a href="#控制特定的主机访问" class="headerlink" title="控制特定的主机访问"></a>控制特定的主机访问</h5><p>用法与控制ip相同</p>
<p>Require host HOSTNAME:授权特定主机访问</p>
<p>Require not host HOSTNAME:拒绝特定主机访问</p>
<p>HOSTNAME可以时特定的主机（FQDN），或指定域名下的所有主机（domin.tld）</p>
<h3 id="8-日志设定"><a href="#8-日志设定" class="headerlink" title="8.日志设定"></a>8.日志设定</h3><p>日志分为访问日志和错误日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/var/<span class="built_in">log</span>/httpd/error_log        <span class="comment">#错误日志</span></span><br><span class="line">/var/<span class="built_in">log</span>/httpd/access_log       <span class="comment">#访问日志</span></span><br></pre></td></tr></table></figure>

<h4 id="8-1错误日志"><a href="#8-1错误日志" class="headerlink" title="8.1错误日志"></a>8.1错误日志</h4><p>错误日志的默认级别为 warn</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">ErrorLog <span class="string">&quot;logs/error_log&quot;</span>       <span class="comment">#此行定义了错误日志的位置</span></span><br><span class="line"><span class="comment"># LogLevel: Control the number of messages logged to the error_log.</span></span><br><span class="line"><span class="comment"># Possible values include: debug, info, notice, warn, error, crit,</span></span><br><span class="line"><span class="comment"># alert, emerg.                 #注释行说明了错误日志由低到高的级别，级别越低记录的内容越多。</span></span><br><span class="line">LogLevel warn                   <span class="comment">#此行定义了错误日志的级别</span></span><br></pre></td></tr></table></figure>

<h4 id="8-2访问日志"><a href="#8-2访问日志" class="headerlink" title="8.2访问日志"></a>8.2访问日志</h4><p>在配置文件中定义了可选的各种访问日志格式，可以以选用配置文件中定义的格式也可以自定义访问日志格式。</p>
<p>访问日志需要定义2行</p>
<p>1.Logformat 日志格式 定义名</p>
<p>2.Customlog 定义名</p>
<p>其中格式有多各字段组成</p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">定义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">%h</td>
<td align="left">客户端的IP地址</td>
</tr>
<tr>
<td align="left">%l</td>
<td align="left">远程用户，启用mod_ident才有效，通常为”-“</td>
</tr>
<tr>
<td align="left">%u</td>
<td align="left">验证远程用户，登陆访问时显示，非登录访问时显示”-“</td>
</tr>
<tr>
<td align="left">%t</td>
<td align="left">访问的时间，为GMT时间</td>
</tr>
<tr>
<td align="left">%r</td>
<td align="left">请求的方法，url及版本号</td>
</tr>
<tr>
<td align="left">%&gt;s</td>
<td align="left">相应状态码</td>
</tr>
<tr>
<td align="left">%b</td>
<td align="left">相应报文大小</td>
</tr>
<tr>
<td align="left">%{Referer}i</td>
<td align="left">从哪个连接跳转来</td>
</tr>
<tr>
<td align="left">%{User-Agent}i</td>
<td align="left">使用的什么浏览器</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#配置文件中定义格式</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">LogFormat <span class="string">&quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined</span><br><span class="line">Customlog combined</span><br><span class="line"><span class="comment">#访问日志中查看格式</span></span><br><span class="line">[root@localhost ~]<span class="comment"># tail -1 /var/log/httpd/access_log</span></span><br><span class="line">192.168.73.1 - - [10/May/2019:15:18:50 +0800] <span class="string">&quot;GET /doc/ HTTP/1.1&quot;</span> 200 884 <span class="string">&quot;http://192.168.73.110/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.131 Safari/537.36&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="9-AddDefaultCharset"><a href="#9-AddDefaultCharset" class="headerlink" title="9.AddDefaultCharset"></a>9.AddDefaultCharset</h3><p>设定默认字符集</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># vim /app/httpd24/conf/httpd.conf</span></span><br><span class="line">AddDefaultCharset utf8mb4                       <span class="comment">#设定默认字符集为utf8mb4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@CentOS6 ~]<span class="comment"># curl -I 192.168.73.100</span></span><br><span class="line">...</span><br><span class="line">Content-Type: text/html; charset=utf8mb4        <span class="comment">#显示头部信息为utf8mb4</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="10-alias"><a href="#10-alias" class="headerlink" title="10.alias"></a>10.alias</h3><p>定义路径别名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># vim /app/httpd24/conf/httpd.conf</span></span><br><span class="line"><span class="built_in">alias</span> /bbs /data/bbsdir         <span class="comment">#定义/bbs 为/data/bbsdir的别名</span></span><br><span class="line">&lt;directory /data/bbsdir&gt;        <span class="comment">#</span></span><br><span class="line">require all granted</span><br><span class="line">&lt;/directory&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建相应目录及站点文件</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment"># mkdir /data/bbsdir</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment"># echo &quot;welcome to mylinuxops.com&quot; &gt; /data/bbsdir/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重启服务测试</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment"># apachectl restart</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.73.100/bbs</span></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//IETF//DTD HTML 2.0//EN&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;301 Moved Permanently&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Moved Permanently&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;The document has moved &lt;a href=<span class="string">&quot;http://192.168.73.100/bbs/&quot;</span>&gt;here&lt;/a&gt;.&lt;/p&gt;    <span class="comment">#访问/bbs时跳转到/bbs/</span></span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br><span class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.73.100/bbs/                                      #访问/bbs/时直接显示</span></span><br><span class="line">welcome to mylinuxops.com</span><br></pre></td></tr></table></figure>

<h3 id="11-用户的访问控制"><a href="#11-用户的访问控制" class="headerlink" title="11.用户的访问控制"></a>11.用户的访问控制</h3><p>用户的访问控制分为两步</p>
<h4 id="11-1认证质询"><a href="#11-1认证质询" class="headerlink" title="11.1认证质询"></a>11.1认证质询</h4><p>认证质询：WWW-Authenticate</p>
<p>响应码：401</p>
<p>先拒绝客户端请求，说明需要客户端提供账号和密码。</p>
<h4 id="11-2认证"><a href="#11-2认证" class="headerlink" title="11.2认证"></a>11.2认证</h4><p>认证Authorization</p>
<p>客户端将账号和密码填入后再次发送请求报文，通过认证，则服务器发送相应的资源</p>
<p>认证的方式分为两种：</p>
<p>basic:明文</p>
<p>digest:消息摘要</p>
<h4 id="11-3安全域"><a href="#11-3安全域" class="headerlink" title="11.3安全域"></a>11.3安全域</h4><p>需要用户认证后方能访问的路径；应该托管过名称对其进行表示，以便于报纸用户认证的原因</p>
<h4 id="11-4用户的账号和密码"><a href="#11-4用户的账号和密码" class="headerlink" title="11.4用户的账号和密码"></a>11.4用户的账号和密码</h4><p>用户的账号用来访问某服务时用到的认证标识</p>
<p>账号和密码可以存放在文本中，sql数据库中，ldap目录，nis等存储中</p>
<p>用户和账号使用htpasswd命令生成</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">htpasswd [OPTIONS] /PATH/TO/HTPASSWD_FILE username</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">options</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-c</td>
<td align="left">自动创建文件，在第一次创建用户时使用，反复使用会覆盖之前的用户</td>
</tr>
<tr>
<td align="left">-p</td>
<td align="left">使用明文密码</td>
</tr>
<tr>
<td align="left">-m</td>
<td align="left">使用md5加密格式</td>
</tr>
<tr>
<td align="left">-d</td>
<td align="left">CRYPT格式加密（默认）</td>
</tr>
<tr>
<td align="left">-s</td>
<td align="left">sha格式加密</td>
</tr>
<tr>
<td align="left">-D</td>
<td align="left">删除指定用户</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>基于用户的验证</p>
<p>一、指定哪些用户可以访问</p>
<p>1.创建4个用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># htpasswd -c /etc/httpd/conf.d/.htpasswd tom</span></span><br><span class="line">New password:</span><br><span class="line">Re-type new password:</span><br><span class="line">Adding password <span class="keyword">for</span> user tom</span><br><span class="line">[root@localhost ~]<span class="comment"># htpasswd  /etc/httpd/conf.d/.htpasswd alice</span></span><br><span class="line">New password:</span><br><span class="line">Re-type new password:</span><br><span class="line">Adding password <span class="keyword">for</span> user alice</span><br><span class="line">[root@localhost ~]<span class="comment"># htpasswd  /etc/httpd/conf.d/.htpasswd jack</span></span><br><span class="line">New password:</span><br><span class="line">Re-type new password:</span><br><span class="line">Adding password <span class="keyword">for</span> user jack</span><br><span class="line">[root@localhost ~]<span class="comment"># htpasswd  /etc/httpd/conf.d/.htpasswd masuri</span></span><br><span class="line">New password:</span><br><span class="line">Re-type new password:</span><br><span class="line">Adding password <span class="keyword">for</span> user masuri</span><br></pre></td></tr></table></figure>

<p>2.修改.htpasswd的权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># chmod 600 /etc/httpd/conf.d/.htpasswd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># setfacl -m u:apache:r /etc/httpd/conf.d/.htpasswd</span></span><br></pre></td></tr></table></figure>

<p>3.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf.d/test.conf</span></span><br><span class="line">&lt;Directory <span class="string">&quot;/www/html&quot;</span>&gt;</span><br><span class="line">Authtype basic</span><br><span class="line">AuthName <span class="string">&quot;login&quot;</span></span><br><span class="line">AuthUserFile /etc/httpd/conf.d/.htpasswd</span><br><span class="line">AuthGroupFile /etc/httpd/conf.d/group</span><br><span class="line">Require user tom alice              <span class="comment">#授权tom 和 alice可以通过认证访问</span></span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p>4.重启服务测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># systemctl restart httpd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># curl -u tom:111111 192.168.73.111</span></span><br><span class="line">this is admin page</span><br><span class="line">[root@localhost ~]<span class="comment"># curl -u alice:111111 192.168.73.111</span></span><br><span class="line">this is admin page</span><br><span class="line">[root@localhost ~]<span class="comment"># curl -u masuri:111111 192.168.73.111        #masuri用户没有授权无法访问</span></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//IETF//DTD HTML 2.0//EN&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;401 Unauthorized&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Unauthorized&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;This server could not verify that you</span><br><span class="line">are authorized to access the document</span><br><span class="line">requested.  Either you supplied the wrong</span><br><span class="line">credentials (e.g., bad password), or your</span><br><span class="line">browser doesn<span class="string">&#x27;t understand how to supply</span></span><br><span class="line"><span class="string">the credentials required.&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>

<p>二、指定列表内的所用用户都可以访问</p>
<p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf.d/test.conf</span></span><br><span class="line">&lt;Directory <span class="string">&quot;/www/html&quot;</span>&gt;</span><br><span class="line">Authtype basic</span><br><span class="line">AuthName <span class="string">&quot;login&quot;</span></span><br><span class="line">AuthUserFile /etc/httpd/conf.d/.htpasswd</span><br><span class="line">AuthGroupFile /etc/httpd/conf.d/group</span><br><span class="line">Require valid-user                                  <span class="comment">#修改为Require valid-user</span></span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p>2.重启读配置文件测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># systemctl reload httpd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># curl -u masuri:111111 192.168.73.111</span></span><br><span class="line">this is admin page</span><br><span class="line">[root@localhost ~]<span class="comment"># curl -u alice:111111 192.168.73.111</span></span><br><span class="line">this is admin page</span><br><span class="line">[root@localhost ~]<span class="comment"># curl -u tom:111111 192.168.73.111</span></span><br><span class="line">this is admin page</span><br><span class="line">[root@localhost ~]<span class="comment"># curl -u jack:111111 192.168.73.111</span></span><br><span class="line">this is admin page</span><br></pre></td></tr></table></figure>

<p>基于组的访问控制</p>
<p>在基于用户的访问控制基础上，还能进行基于组的访问，将用户进行分组，让某些组内的成员可以访问。首先需要定义一个组名和组成员相对应的文件，然后在配置文件中授权。</p>
<p>示例：</p>
<p>1.创建组成员对应关系的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf.d/group</span></span><br><span class="line">g1:alice tom</span><br><span class="line">g2:jack masuri</span><br></pre></td></tr></table></figure>

<p>2.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf.d/test.conf</span></span><br><span class="line">&lt;Directory <span class="string">&quot;/www/html&quot;</span>&gt;</span><br><span class="line">Authtype basic</span><br><span class="line">AuthName <span class="string">&quot;login&quot;</span></span><br><span class="line">AuthUserFile /etc/httpd/conf.d/.htpasswd</span><br><span class="line">AuthGroupFile /etc/httpd/conf.d/group                   <span class="comment">#指定组文件对应关系</span></span><br><span class="line">Require group g2                                        <span class="comment">#定义g2组成员可以访问</span></span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p>3.重读配置文件测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># systemctl reload httpd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># curl -u tom:111111 192.168.73.111</span></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//IETF//DTD HTML 2.0//EN&quot;</span>&gt;          <span class="comment">#组1的tom无法访问</span></span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;401 Unauthorized&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Unauthorized&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;This server could not verify that you</span><br><span class="line">are authorized to access the document</span><br><span class="line">requested.  Either you supplied the wrong</span><br><span class="line">credentials (e.g., bad password), or your</span><br><span class="line">browser doesn<span class="string">&#x27;t understand how to supply</span></span><br><span class="line"><span class="string">the credentials required.&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">[root@localhost ~]# curl -u jack:111111 192.168.73.111</span></span><br><span class="line"><span class="string">this is admin page                                          #组2的jack可以访问</span></span><br></pre></td></tr></table></figure>

<p>其他认证</p>
<p>远程客户端和用户验证的控制</p>
<p>satisfy ALL|ANY</p>
<p>|参数|说明|<br>|all|客户端的IP和用户验证都通过才能访问|<br>|any|客户端的IP和用户验证有一个通过就能访问|</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf.d/test.conf</span></span><br><span class="line">&lt;Directory <span class="string">&quot;/www/html&quot;</span>&gt;</span><br><span class="line">Authtype basic</span><br><span class="line">AuthName <span class="string">&quot;login&quot;</span></span><br><span class="line">AuthUserFile /etc/httpd/conf.d/.htpasswd</span><br><span class="line">Require valid-user</span><br><span class="line">&lt;Requireall&gt;</span><br><span class="line">Require all granted</span><br><span class="line">Require not ip 192.168.73.111</span><br><span class="line">&lt;/Requireall&gt;</span><br><span class="line">satisfy any</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="12-共享家目录"><a href="#12-共享家目录" class="headerlink" title="12.共享家目录"></a>12.共享家目录</h3><p>要共享家目录需要开启模块mod_userdir.so</p>
<p>1.查看模块是否开启</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># httpd -M | grep userdir</span></span><br><span class="line"> userdir_module (shared)</span><br></pre></td></tr></table></figure>

<p>2.修改与家目录相关的配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/httpd/conf.d/userdir.conf</span></span><br><span class="line">&lt;IfModule mod_userdir.c&gt;</span><br><span class="line">    UserDir public_html</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory <span class="string">&quot;/home/masuri/public_html&quot;</span>&gt;</span><br><span class="line">require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p>3.创建public_html目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># mkdir /home/masuri/public_html</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># echo &quot;this is masuri&#x27;s home&quot; &gt; /home/masuri/public_html/index.html</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># setfacl -m u:apache:x /home/masuri</span></span><br></pre></td></tr></table></figure>

<p>4.重读配置文件测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># curl -L 192.168.73.111/~masuri</span></span><br><span class="line">this is masuri<span class="string">&#x27;s home</span></span><br></pre></td></tr></table></figure>

<p>安全相关</p>
<p>共享家目录时需要认证登陆，否则谁都能够登陆不够安全</p>
<p>1.在家目录下创建.htaccess文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /home/masuri/public_html/.htaccess</span></span><br><span class="line">AuthType basic</span><br><span class="line">AuthName <span class="string">&quot;login home&quot;</span></span><br><span class="line">AuthUserFile <span class="string">&quot;/home/masuri/public_html/.htpasswd&quot;</span></span><br><span class="line">Require user masuri</span><br><span class="line">~</span><br></pre></td></tr></table></figure>

<p>2.创建可以用于认证的用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># htpasswd -c /home/masuri/public_html/.htpasswd masuri</span></span><br><span class="line">New password:</span><br><span class="line">Re-type new password:</span><br><span class="line">Adding password <span class="keyword">for</span> user masuri</span><br></pre></td></tr></table></figure>

<p>3.修改userdir的配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/httpd/conf.d/userdir.conf</span></span><br><span class="line">&lt;Directory <span class="string">&quot;/home/masuri/public_html&quot;</span>&gt;</span><br><span class="line">AllowOverRide authconfig</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p>3.重读配置文件测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># curl -L 192.168.73.111/~masuri         #不使用账户名和密码登陆</span></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//IETF//DTD HTML 2.0//EN&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;401 Unauthorized&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Unauthorized&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;This server could not verify that you</span><br><span class="line">are authorized to access the document</span><br><span class="line">requested.  Either you supplied the wrong</span><br><span class="line">credentials (e.g., bad password), or your</span><br><span class="line">browser doesn<span class="string">&#x27;t understand how to supply</span></span><br><span class="line"><span class="string">the credentials required.&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@mylinuxops ~]# curl -u masuri:111111 -L 192.168.73.111/~masuri        #使用账户名和密码登陆</span></span><br><span class="line"><span class="string">this is masuri&#x27;</span>s home</span><br></pre></td></tr></table></figure>

<h3 id="13-ServerSignature"><a href="#13-ServerSignature" class="headerlink" title="13.ServerSignature"></a>13.ServerSignature</h3><p>当客户请求的网页不存在时，服务器将产生错误文档，如果打开了ServerSignature选项，错误文档的最后一行将包含服务器的名字、Apache的版本等信息，如果不对为显示这些信息，就可以将这些参数设置为off，设置为Email，将显示ServerAdmin的Email提示</p>
<h3 id="14-status页面"><a href="#14-status页面" class="headerlink" title="14.status页面"></a>14.status页面</h3><p>要查看服务器的状态页面，需要加载mod_status.so模块</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># httpd -M | grep status</span></span><br><span class="line"> status_module (shared)</span><br></pre></td></tr></table></figure>

<p>修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">&lt;Location <span class="string">&quot;/status&quot;</span>&gt;</span><br><span class="line">SetHandler server-status</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>

<p>重启服务访问</p>
<p><img src="httpstatus.png" alt="httpstatus.png"></p>
<p>注意：此页面最好也进行认证登陆</p>
<h3 id="15-httpd的压缩"><a href="#15-httpd的压缩" class="headerlink" title="15.httpd的压缩"></a>15.httpd的压缩</h3><p>网络上的CDN是根据流量来收费的，所以数据需要进行压缩，从而来节省成本</p>
<p>压缩需要mod_deflate模块</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># httpd -M | grep deflate</span></span><br><span class="line"> deflate_module (shared)</span><br></pre></td></tr></table></figure>

<p>适用场景：<br>(1)节约带宽，额外消耗CPU；同时，可能有些较老浏览器不支持</p>
<p>(2) 压缩适于压缩的资源，例如文本文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LoadModule deflate_module modules/mod_deflate.so</span><br><span class="line">SetOutputFilter DEFLATE SetOutputFilter DEFLATE</span><br><span class="line"><span class="comment"># Restrict compression to these MIME</span></span><br><span class="line">types AddOutputFilterByType DEFLATE text/plain  </span><br><span class="line">AddOutputFilterByType DEFLATE text/html</span><br><span class="line">AddOutputFilterByType DEFLATE application/xhtml+xml</span><br><span class="line">AddOutputFilterByType DEFLATE text/xml</span><br><span class="line">AddOutputFilterByType DEFLATE application/xml</span><br><span class="line">AddOutputFilterByType DEFLATE application/x-javascript</span><br><span class="line">AddOutputFilterByType DEFLATE text/javascript</span><br><span class="line">AddOutputFilterByType DEFLATE text/css</span><br><span class="line">DeflateCompressionLevel 9   <span class="comment">#设定默认压缩级别1-9，9级别最高</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>https及http重定向https</title>
    <url>/2019/04/20/Httpd/https%E5%8F%8A%E9%87%8D%E5%AE%9A%E5%90%91/https%E5%8F%8A%E9%87%8D%E5%AE%9A%E5%90%91/</url>
    <content><![CDATA[<p>http在网络上传输时是明文的，很容易被网络上的黑客抓取到敏感信息，由此产生了加密的http称为https(http over ssl)</p>
<p>要使用https服务器端先要去互联网上的CA申请证书，获取证书后对apache服务加以配置就能使用https加密通讯，HTTPS所使用的端口为443</p>
<span id="more"></span>
<p>https的通信过程</p>
<p><img src="https.png" alt="https.png"></p>
<hr>
<h2 id="https的实现"><a href="#https的实现" class="headerlink" title="https的实现"></a>https的实现</h2><p>实验环境</p>
<p>准备主机2台，1台充当CA，1台为https服务器</p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">ip地址</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CA</td>
<td align="left">192.168.73.111</td>
</tr>
<tr>
<td align="left">mylinuxops.com</td>
<td align="left">192.168.73.110</td>
</tr>
</tbody></table>
<h2 id="配置https"><a href="#配置https" class="headerlink" title="配置https"></a>配置https</h2><p>1.启用ssl模块</p>
<p>要使用https需要启用ssl模块，系统默认没有启动用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># httpd -M | grep ssl</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># yum install mod_ssl -y</span></span><br></pre></td></tr></table></figure>

<p>2.在CA服务器上为CA创建目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ca ~]<span class="comment"># mkdir /data/ssl</span></span><br><span class="line">[root@ca ~]<span class="comment"># cd /data/ssl</span></span><br></pre></td></tr></table></figure>

<p>3.生成ca的私钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ca ssl]<span class="comment"># (umask 066;openssl genrsa 2048 &gt; cakey.pem)</span></span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">.........+++</span><br><span class="line">.+++</span><br><span class="line">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure>

<p>4.ca生成自签名证书</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ca ssl]<span class="comment"># openssl req -new -x509 -key cakey.pem -out cacert.pem -days 3650</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:Beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:Beijing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:Magedu</span><br><span class="line">Organizational Unit Name (eg, section) []:devops</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:ca.magedu.com</span></span><br><span class="line"><span class="string">Email Address []:</span></span><br></pre></td></tr></table></figure>

<p>5.在CA上为http服务器生成私钥及证书申请</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ca ssl]<span class="comment"># openssl req -newkey rsa:1024 -nodes -keyout httpd.key &gt; httpd.csr</span></span><br><span class="line">Generating a 1024 bit RSA private key</span><br><span class="line">...........................++++++</span><br><span class="line">..............................++++++</span><br><span class="line">writing new private key to <span class="string">&#x27;httpd.key&#x27;</span></span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:Beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:Beijing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:Magedu</span><br><span class="line">Organizational Unit Name (eg, section) []:devops</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:www.mylinuxops.com</span></span><br><span class="line"><span class="string">Email Address []:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please enter the following &#x27;</span>extra<span class="string">&#x27; attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:</span></span><br><span class="line"><span class="string">An optional company name []:</span></span><br></pre></td></tr></table></figure>

<p>6.为http服务器签发证书</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ca ssl]<span class="comment"># openssl x509 -req -in httpd.csr -CA cacert.pem -CAkey cakey.pem -set_serial 01 &gt; httpd.crt</span></span><br><span class="line">Signature ok</span><br><span class="line">subject=/C=CN/ST=Beijing/L=Beijing/O=Magedu/OU=devops/CN=www.mylinuxops.com</span><br><span class="line">Getting CA Private Key</span><br></pre></td></tr></table></figure>

<p>7.将http服务器的证书，私钥以及ca的证书传送给http服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ca ssl]<span class="comment"># mkdir ssl</span></span><br><span class="line">[root@ca ssl]<span class="comment"># mv cacert.pem ssl</span></span><br><span class="line">[root@ca ssl]<span class="comment"># cp httpd.crt ssl</span></span><br><span class="line">[root@ca ssl]<span class="comment"># cp httpd.key ssl</span></span><br><span class="line"></span><br><span class="line">[root@ca ssl]<span class="comment"># scp -r ssl 192.168.73.110:/etc/httpd/</span></span><br><span class="line">The authenticity of host <span class="string">&#x27;192.168.73.110 (192.168.73.110)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:H78OrQs4fEjmzvJWz50ZfCAoneEVPNqdEB2xLho24/A.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is MD5:c5:9f:19:c2:3e:63:b0:60:a8:a9:34:46:37:dd:7f:ba.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>192.168.73.110<span class="string">&#x27; (ECDSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">root@192.168.73.110&#x27;</span>s password:</span><br><span class="line">cacert.pem                                                                  100% 1330   972.8KB/s   00:00</span><br><span class="line">httpd.crt                                                                   100% 1029   838.1KB/s   00:00</span><br><span class="line">httpd.key                                                                   100%  916     1.5MB/s   00:00</span><br></pre></td></tr></table></figure>

<p>8.配置HTTP服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops httpd]<span class="comment"># vim /etc/httpd/conf.d/ssl.conf</span></span><br><span class="line"></span><br><span class="line">&lt;VirtualHost _default_:443&gt;</span><br><span class="line">    servername www.mylinuxops.com           <span class="comment">#写入servername</span></span><br><span class="line">    documentroot /data/html                 <span class="comment">#站点根路径</span></span><br><span class="line">    &lt;directory /data/html&gt;                  <span class="comment">#授权</span></span><br><span class="line">        require all granted</span><br><span class="line">    &lt;/directory&gt;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    SSLCertificateFile /etc/httpd/ssl/httpd.crt</span><br><span class="line">    SSLCertificateKeyFile /etc/httpd/ssl/httpd.key</span><br><span class="line">    SSLCertificateChainFile /etc/httpd/ssl/cacert.pem</span><br><span class="line">    ...</span><br><span class="line">&lt;/virtualHost&gt;</span><br></pre></td></tr></table></figure>

<p>9.创建站点目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># mkdir /data/html</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># echo &quot;www.mylinuxops.com&quot; &gt; /data/html/index.html</span></span><br></pre></td></tr></table></figure>

<p>10.重启服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># systemctl restart httpd</span></span><br></pre></td></tr></table></figure>

<p>11.测试</p>
<p>在CA上对http服务器进行测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#先修改hosts文件，为www.mylinuxops.com做名称解析</span></span><br><span class="line">[root@ca ssl]<span class="comment"># vim /etc/hosts</span></span><br><span class="line"></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.73.110 www.mylinuxops.com</span><br><span class="line"></span><br><span class="line">[root@ca ssl]<span class="comment"># curl --cacert cacert.pem https://www.mylinuxops.com  #带上证书可以访问</span></span><br><span class="line">www.mylinuxops.com</span><br><span class="line">[root@ca ssl]<span class="comment"># curl  https://www.mylinuxops.com     #不带证书报错</span></span><br><span class="line">curl: (60) Peer<span class="string">&#x27;s certificate issuer has been marked as not trusted by the user.</span></span><br><span class="line"><span class="string">More details here: http://curl.haxx.se/docs/sslcerts.html</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">curl performs SSL certificate verification by default, using a &quot;bundle&quot;</span></span><br><span class="line"><span class="string"> of Certificate Authority (CA) public keys (CA certs). If the default</span></span><br><span class="line"><span class="string"> bundle file isn&#x27;</span>t adequate, you can specify an alternate file</span><br><span class="line"> using the --cacert option.</span><br><span class="line">If this HTTPS server uses a certificate signed by a CA represented <span class="keyword">in</span></span><br><span class="line"> the bundle, the certificate verification probably failed due to a</span><br><span class="line"> problem with the certificate (it might be expired, or the name might</span><br><span class="line"> not match the domain name <span class="keyword">in</span> the URL).</span><br><span class="line">If you<span class="string">&#x27;d like to turn off curl&#x27;</span>s verification of the certificate, use</span><br><span class="line"> the -k (or --insecure) option.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="http重定向"><a href="#http重定向" class="headerlink" title="http重定向"></a>http重定向</h2><p>客户端向服务器端发送一个http请求，服务器端收到http请求后发现客户端请求的地址链接已经发生改变，然后服务器端返回一个301/302的重定向状态码，并把重定向后的地址发送给客户端，客户端取得新的地址后再次使用新的地址访问服务器。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Redirect [status] URL-path URL</span><br><span class="line">status:</span><br><span class="line">    Permanent       <span class="comment">#永久重定向返回状态码301 （表示此URL以后不再使用）</span></span><br><span class="line">    Temp            <span class="comment">#临时重定向放回状态码302</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>将http重定向至https</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/httpd/conf.d/vhost.conf</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    servername www.mylinuxops.com</span><br><span class="line">    Documentroot /data/html</span><br><span class="line">    &lt;directory <span class="string">&quot;/data/html&quot;</span>&gt;</span><br><span class="line">        options all</span><br><span class="line">        require all granted</span><br><span class="line">    &lt;/directory&gt;</span><br><span class="line">    redirect temp / https://www.mylinuxops.com/</span><br><span class="line">&lt;/virtualhost&gt;</span><br><span class="line">~</span><br><span class="line">[root@mylinuxops ~]<span class="comment"># systemctl restart httpd</span></span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ca ssl]<span class="comment"># curl -kL  http://www.mylinuxops.com</span></span><br><span class="line">www.mylinuxops.com</span><br><span class="line">[root@ca ssl]<span class="comment"># curl   http://www.mylinuxops.com</span></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//IETF//DTD HTML 2.0//EN&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;302 Found&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Found&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;The document has moved &lt;a href=<span class="string">&quot;https://www.mylinuxops.com/&quot;</span>&gt;here&lt;/a&gt;.&lt;/p&gt;               <span class="comment">#服务器返回的跳转的地址</span></span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="HSTS重定向"><a href="#HSTS重定向" class="headerlink" title="HSTS重定向"></a>HSTS重定向</h2><p>当客户端每次重复请求一个已经被重定向的资源时，服务器需要反复的向客户端发送新的地址，这无形中造成了带宽的浪费，于是HSTS就出现了。当服务器端配置支持HSTS后，会给客户端浏览器返回的HTTP首部中携带HSTS字段，浏览器获取到信息后，会将所有的HTTP访问请求在浏览器内部做307跳转，而无需任何网络过程。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/httpd/conf.d/vhost.conf</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    servername www.mylinuxops.com</span><br><span class="line">    Documentroot /data/html</span><br><span class="line">    &lt;directory <span class="string">&quot;/data/html&quot;</span>&gt;</span><br><span class="line">        options all</span><br><span class="line">        require all granted</span><br><span class="line">    &lt;/directory&gt;</span><br><span class="line">    <span class="comment">#redirect temp / https://www.mylinuxops.com/</span></span><br><span class="line">    Header always <span class="built_in">set</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000&quot;</span>          <span class="comment">#设定最长保存时间</span></span><br><span class="line">    RewriteEngine on                                                        <span class="comment">#启动引擎</span></span><br><span class="line">    RewriteRule ^(/.*)$ https://%&#123;HTTP_HOST&#125;<span class="variable">$1</span> [redirect=302]               <span class="comment">#定义重定向规则</span></span><br><span class="line">&lt;/virtualhost&gt;</span><br><span class="line">~</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ca ssl]<span class="comment"># curl -I http://www.mylinuxops.com</span></span><br><span class="line">HTTP/1.1 302 Found</span><br><span class="line">Date: Mon, 13 May 2019 06:54:57 GMT</span><br><span class="line">Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips</span><br><span class="line">Strict-Transport-Security: max-age=31536000                         <span class="comment">#保存31536000秒</span></span><br><span class="line">Location: https://www.mylinuxops.com/                               <span class="comment">#重定向至https</span></span><br><span class="line">Content-Type: text/html; charset=iso-8859-1</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>编译安装LAMP(php-fpm)</title>
    <url>/2019/04/20/Httpd/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85LAMP(php-fpm)/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85LAMP(php-fpm)/</url>
    <content><![CDATA[<h2 id="编译安装LAMP-php-fpm"><a href="#编译安装LAMP-php-fpm" class="headerlink" title="编译安装LAMP(php-fpm)"></a>编译安装LAMP(php-fpm)</h2><p>本节将演示如何以编译的方式实现LAMP(php-fpm)的环境搭建，由于php使用的php-fpm模式所以可以将php和apache服务器分开安装。</p>
<span id="more"></span>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>php主机1台，apache主机1台，MySQL主机1台</p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">系统</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">httpd</td>
<td align="left">centos7</td>
<td align="left">192.168.73.110</td>
</tr>
<tr>
<td align="left">php</td>
<td align="left">centos7</td>
<td align="left">192.168.73.111</td>
</tr>
<tr>
<td align="left">mysql</td>
<td align="left">centos7</td>
<td align="left">192.168.73.112</td>
</tr>
</tbody></table>
<h2 id="一、编译httpd"><a href="#一、编译httpd" class="headerlink" title="一、编译httpd"></a>一、编译httpd</h2><p>安装编译所需的软件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># yum install gcc gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel zlib-devel vim lrzsz tree screen lsof tcpdump wget ntpdate net-tools iotop bc zip unzip nfs-utils expat-devel -y</span></span><br></pre></td></tr></table></figure>

<p>1.解压源码包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># tar xf httpd-2.4.39.tar.bz2</span></span><br><span class="line">[root@httpd ~]<span class="comment"># tar xf apr-util-1.6.1.tar.gz</span></span><br><span class="line">[root@httpd ~]<span class="comment"># tar xf apr-1.7.0.tar.gz</span></span><br></pre></td></tr></table></figure>

<p>2.对apr、apr-util建软连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># mv apr-util-1.6.1 httpd-2.4.39/srclib/apr-util</span></span><br><span class="line">[root@httpd ~]<span class="comment"># mv apr-1.7.0 httpd-2.4.39/srclib/apr</span></span><br></pre></td></tr></table></figure>

<p>3.编译httpd</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># cd httpd-2.4.39</span></span><br><span class="line">[root@httpd httpd-2.4.39]<span class="comment"># ./configure  --prefix=/app/httpd24  --enable-so  --enable-ssl  --enable-cgi --enable-rewrite  --with-zlib  --with-pcre  --with-included-apr=/root/httpd-2.4.39/srclib/  --enable-modules=most  --enable-mpms-shared=all  --with-mpm=prefork</span></span><br></pre></td></tr></table></figure>

<p>4.安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd httpd-2.4.39]<span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>

<p>5.创建apache用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd httpd-2.4.39]<span class="comment"># useradd -r -s /sbin/nologin apache</span></span><br></pre></td></tr></table></figure>

<p>6.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd httpd-2.4.39]<span class="comment"># vim /app/httpd24/conf/httpd.conf</span></span><br><span class="line">User apache</span><br><span class="line">Group apache</span><br></pre></td></tr></table></figure>

<p>7.配置环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd httpd-2.4.39]<span class="comment"># echo &#x27;PATH=/app/httpd24/bin:$PATH&#x27; &gt; /etc/profile.d/httpd.sh</span></span><br><span class="line">[root@httpd httpd-2.4.39]<span class="comment"># source /etc/profile.d/httpd.sh</span></span><br></pre></td></tr></table></figure>

<p>8.设置开机启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd httpd-2.4.39]<span class="comment"># echo &quot;/app/httpd24/bin/apachectl start&quot; &gt;&gt; /etc/rc.d/rc.local</span></span><br><span class="line">[root@httpd httpd-2.4.39]<span class="comment"># chmod +x /etc/rc.d/rc.local</span></span><br></pre></td></tr></table></figure>

<h2 id="二、编译安装MySQL"><a href="#二、编译安装MySQL" class="headerlink" title="二、编译安装MySQL"></a>二、编译安装MySQL</h2><p>1.安装编译所需要的软件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mysql ~]<span class="comment"># yum install bison bison-devel zlib-devel libcurl-devel libarchive-devel boostdevel gcc gcc-c++ cmake ncurses-devel gnutls-devel libxml2-devel openssldevel libevent-devel libaio-devel -y</span></span><br></pre></td></tr></table></figure>

<p>2.解压缩源码包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mysql ~]<span class="comment"># tar xf mariadb-10.2.23.tar.gz -C /data</span></span><br></pre></td></tr></table></figure>

<p>3.编译</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mysql ~]<span class="comment"># cd /data/mariadb-10.2.23/</span></span><br><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># cmake . \</span></span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/app/mysql \</span><br><span class="line">-DMYSQL_DATADIR=/data/mysql/ \</span><br><span class="line">-DSYSCONFDIR=/etc/mysql \</span><br><span class="line">-DMYSQL_USER=mysql \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITHOUT_MROONGA_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_DEBUG=0 \</span><br><span class="line">-DWITH_READLINE=1 \</span><br><span class="line">-DWITH_SSL=system \</span><br><span class="line">-DWITH_ZLIB=system \</span><br><span class="line">-DWITH_LIBWRAP=0 \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/data/mysql/mysql.sock \</span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci</span><br></pre></td></tr></table></figure>

<p>4.安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mysql ~]<span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>

<p>5.创建用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mysql ~]<span class="comment"># useradd -r -s /sbin/nologin mysql</span></span><br></pre></td></tr></table></figure>

<p>6.创建数据库目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># mkdir /data/mysql</span></span><br><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># chown -R mysql.mysql /data/mysql</span></span><br><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># chmod 700 /data/mysql</span></span><br></pre></td></tr></table></figure>

<p>7.初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># /app/mysql/scripts/mysql_install_db --user=mysql --datadir=/data/mysql</span></span><br></pre></td></tr></table></figure>

<p>8.复制配置文件并修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># mkdir /etc/mysql</span></span><br><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># cp /app/mysql/support-files/my-huge.cnf /etc/mysql/my.cnf</span></span><br><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># vim /etc/mysql/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/data/mysql</span><br></pre></td></tr></table></figure>

<p>9.配置开机启动脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># cp support-files/mysql.server /etc/init.d/mysqld</span></span><br><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># chmod +x /etc/init.d/mysqld</span></span><br><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># chkconfig --add mysqld</span></span><br></pre></td></tr></table></figure>

<p>10.为MySQL配置环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mysql mariadb-10.2.23]<span class="comment"># echo &#x27;PATH=/app/mysql/bin:$PATH&#x27; &gt; /etc/profile.d/mysql.sh</span></span><br><span class="line">[root@mysql mariadb-10.2.23]<span class="comment">#. /etc/profile.d/mysql.sh</span></span><br></pre></td></tr></table></figure>

<h2 id="三、编译安装php-fpm"><a href="#三、编译安装php-fpm" class="headerlink" title="三、编译安装php-fpm"></a>三、编译安装php-fpm</h2><p>安装编译所需软件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@php php-7.3.5]<span class="comment"># yum install libxml2-devel -y</span></span><br></pre></td></tr></table></figure>

<p>1.解压php</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@php ~]<span class="comment"># tar xf php-7.3.5.tar.bz2</span></span><br></pre></td></tr></table></figure>

<p>2.编译php</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@php ~]<span class="comment"># cd php-7.3.5</span></span><br><span class="line">[root@php php-7.3.5]<span class="comment"># ./configure</span></span><br><span class="line">--prefix=/app/php  </span><br><span class="line">--enable-mysqlnd  </span><br><span class="line">--with-mysqli=mysqlnd  </span><br><span class="line">--with-pdo-mysql=mysqlnd  </span><br><span class="line">--with-openssl  </span><br><span class="line">--with-freetype-dir  </span><br><span class="line">--with-jpeg-dir  </span><br><span class="line">--with-png-dir  </span><br><span class="line">--with-zlib  </span><br><span class="line">--with-libxml-dir=/usr  </span><br><span class="line">--with-config-file-path=/etc  </span><br><span class="line">--with-config-file-scan-dir=/etc/php.d  </span><br><span class="line">--enable-mbstring</span><br><span class="line">--enable-xml  </span><br><span class="line">--enable-sockets  </span><br><span class="line">--enable-fpm</span><br><span class="line">--enable-maintainer-zts  </span><br><span class="line">--disable-fileinfo</span><br></pre></td></tr></table></figure>

<p>3.安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@php php-7.3.5]<span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>

<p>4.复制配置文件模板并修改时区</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@php php-7.3.5]<span class="comment"># cp php.ini-production /etc/php.ini</span></span><br><span class="line">[root@php ~]<span class="comment"># sed -i &#x27;/;date.tim/s@.*@data.timezone = &quot;Asia/Shanghai&quot;@&#x27; /etc/php.ini </span></span><br></pre></td></tr></table></figure>

<p>5.复制服务脚本模板，修改权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@php php-7.3.5]<span class="comment"># cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</span></span><br><span class="line">[root@php php-7.3.5]<span class="comment"># chmod +x /etc/init.d/php-fpm</span></span><br></pre></td></tr></table></figure>

<p>6.复制配置文件模板</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cp /app/php/etc/php-fpm.conf.default /app/php/etc/php-fpm.conf</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cp /app/php/etc/php-fpm.d/www.conf.default /app/php/etc/php-fpm.d/www.conf</span></span><br></pre></td></tr></table></figure>

<h3 id="LAMP配置"><a href="#LAMP配置" class="headerlink" title="LAMP配置"></a>LAMP配置</h3><p>1、修改httpd配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@httpd ~]<span class="comment"># sed -i &#x27;/mod_proxy.so/s/#\(.*\)/\1/&#x27; /app/httpd24/conf/httpd.conf</span></span><br><span class="line">[root@httpd ~]<span class="comment"># sed -i &#x27;/fcgi.so/s/#\(.*\)/\1/&#x27; /app/httpd24/conf/httpd.conf</span></span><br><span class="line">[root@httpd ~]<span class="comment"># cat &lt; EOF &gt;&gt; /app/httpd24/conf/httpd.conf</span></span><br><span class="line">&gt; addtype application/x-httpd-php .php</span><br><span class="line">&gt; addtype application/x-httpd-php-source .phps</span><br><span class="line">&gt; ProxyRequests Off</span><br><span class="line">&gt; ProxyPassMatch ^/(.*\.php)$ fcgi://192.168.73.111:9000/data/<span class="built_in">test</span>/<span class="variable">$1</span></span><br><span class="line">&gt; EOF</span><br><span class="line">[root@localhost ~]<span class="comment"># sed -i &#x27;/  DirectoryIndex/s/.*/    DirectoryIndex index.php index.html/p&#x27; /app/httpd24/conf/httpd.conf</span></span><br></pre></td></tr></table></figure>

<p>2.修改php配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># sed -i &#x27;/^listen/s/.*/listen = 9000/&#x27; /app/php/etc/php-fpm.d/www.conf</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed -i &#x27;/listen.allow/s/\(.*\)/;\1/&#x27; /app/php/etc/php-fpm.d/www.conf</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>基于UDS的LAMP</title>
    <url>/2019/04/19/Httpd/%E5%9F%BA%E4%BA%8EUDS%E7%9A%84LAMP/%E5%9F%BA%E4%BA%8EUDS%E7%9A%84LAMP/</url>
    <content><![CDATA[<p>本节将演示如何基于UDS(Uninx Domain Socket)来配置LAMP</p>
<h2 id="UDS-Unix-Domain-Socket"><a href="#UDS-Unix-Domain-Socket" class="headerlink" title="UDS(Unix Domain Socket)"></a>UDS(Unix Domain Socket)</h2><p>Unix domain socket 又叫 IPC(inter-process communication 进程间通信) socket，用于实现同一主机上的进程间通信。socket 原本是为网络通讯设计的，但后来在 socket 的框架上发展出一种 IPC 机制，就是 UNIX domain socket。虽然网络 socket 也可用于同一台主机的进程间通讯(通过 loopback 地址 127.0.0.1)，但是 UNIX domain socket 用于 IPC 更有效率：不需要经过网络协议栈，不需要打包拆包、计算校验和、维护序号和应答等，只是将应用层数据从一个进程拷贝到另一个进程。这是因为，IPC 机制本质上是可靠的通讯，而网络协议是为不可靠的通讯设计的。</p>
<p>UNIX domain socket 是全双工的，API 接口语义丰富，相比其它 IPC 机制有明显的优越性，目前已成为使用最广泛的 IPC 机制，比如 X Window 服务器和 GUI 程序之间就是通过 UNIX domain socket 通讯的。</p>
<p>Unix domain socket 是 POSIX 标准中的一个组件，所以不要被名字迷惑，linux 系统也是支持它的。</p>
<span id="more"></span>

<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>准备2台主机</p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">IP</th>
<th align="left">APP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">192.168.73.110</td>
<td align="left">http php-fpm</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">192.168.73.111</td>
<td align="left">mariadb</td>
</tr>
</tbody></table>
<h2 id="安装LAMP"><a href="#安装LAMP" class="headerlink" title="安装LAMP"></a>安装LAMP</h2><p>1.在主机A上安装http、php-fpm、php-mysql</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># yum install httpd php-fpm php-mysql -y</span></span><br></pre></td></tr></table></figure>

<p>2.确保proxy_modules.so和fcgi_mod是启用的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># httpd -M | grep proxy</span></span><br><span class="line"> proxy_module (shared)</span><br><span class="line"> proxy_fcgi_module (shared)</span><br></pre></td></tr></table></figure>

<p>3.修改http配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DirectoryIndex index.php index.html</span><br><span class="line">Addtype application/x-httpd-php .php</span><br><span class="line">addtype application/x-httpd-php-source .phps</span><br><span class="line">Proxyrequests off</span><br><span class="line">ProxyPassMatch ^/(.*\.php)$ unix:/var/run/php.sock|fcgi://localhost/data/<span class="built_in">test</span>/<span class="variable">$1</span>   <span class="comment">#当远程主机访问.php结尾的文件时，httpd通过php套接文件转发给本机的php-fpm</span></span><br></pre></td></tr></table></figure>

<p>4.修改php-fpm配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/php-fpm.d/www.conf</span></span><br><span class="line">;listen = 127.0.0.1:9000</span><br><span class="line">listen = /var/run/php.sock  <span class="comment">#由于httpd和php-fpm在同一台主机所以监听在sock接口上</span></span><br><span class="line"></span><br><span class="line">;listen.allowed_clients = 127.0.0.1</span><br><span class="line"></span><br><span class="line">listen.mode = 0666</span><br><span class="line"></span><br><span class="line">user = apache</span><br><span class="line">group = apache</span><br></pre></td></tr></table></figure>

<p>5.启动php-fpm和httpd服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># systemctl start php-fpm httpd</span></span><br></pre></td></tr></table></figure>

<p>6.创建测试页</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir /data/test</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /data/test/index.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>7.测试</p>
<p><img src="UDS.png" alt="UDS.png"></p>
<p>8.在B主机上安装MySQL</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># yum install mariadb-server -y</span></span><br></pre></td></tr></table></figure>

<p>9.启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># systemctl start mariadb-server</span></span><br></pre></td></tr></table></figure>

<p>10.创建测试用账号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; grant all on *.* to <span class="built_in">test</span>@<span class="string">&#x27;192.168.73.110&#x27;</span> identified by <span class="string">&#x27;111111&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>11.在http服务器上创建测试页</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /data/test/index.php</span></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$dsn</span>=<span class="string">&#x27;mysql:host=192.168.73.111;dbname=test&#x27;</span>;</span><br><span class="line"><span class="variable">$username</span>=<span class="string">&#x27;test&#x27;</span>; <span class="variable">$passwd</span>=<span class="string">&#x27;111111&#x27;</span>;</span><br><span class="line"><span class="variable">$dbh</span>=new PDO(<span class="variable">$dsn</span>,<span class="variable">$username</span>,<span class="variable">$passwd</span>);</span><br><span class="line">var_dump(<span class="variable">$dbh</span>);</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>编译安装httpd2.4</title>
    <url>/2019/04/18/Httpd/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85httpd2.4/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85httpd2.4/</url>
    <content><![CDATA[<h2 id="源码编译安装httpd2-4"><a href="#源码编译安装httpd2-4" class="headerlink" title="源码编译安装httpd2.4"></a>源码编译安装httpd2.4</h2><p>由于在CentOS6上默认安装的httpd版本为2.2，并且所使用的apr及apr-util版本也过老，所以在CentOS6上安装httpd时需要对其进行编译安装，以下将演示编译安装httpd，以及使用ansible来编译安装httpd2.4两种方法。</p>
<span id="more"></span>

<h2 id="CentOS-6-10源码编译httpd2-4-39"><a href="#CentOS-6-10源码编译httpd2-4-39" class="headerlink" title="CentOS 6.10源码编译httpd2.4.39"></a>CentOS 6.10源码编译httpd2.4.39</h2><h3 id="编译环境准备"><a href="#编译环境准备" class="headerlink" title="编译环境准备"></a>编译环境准备</h3><table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">系统</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">centos6.10</td>
</tr>
</tbody></table>
<p>编译所需的httpd、apr、apr-util</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apr-1.7.0.tar.gz</span><br><span class="line">apr-util-1.6.1.tar.gz</span><br><span class="line">httpd-2.4.39.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="编译安装httpd2-4"><a href="#编译安装httpd2-4" class="headerlink" title="编译安装httpd2.4"></a>编译安装httpd2.4</h3><p>1.安装编译所需要的软件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># yum install gcc gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel zlib-devel vim lrzsz tree screen lsof tcpdump wget ntpdate net-tools iotop bc zip unzip nfs-utils expat-devel -y</span></span><br></pre></td></tr></table></figure>

<p>2.解压所有压缩包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># tar -xf apr-util-1.6.1.tar.gz</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment"># tar -xf apr-1.7.0.tar.gz</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment"># tar -xf httpd-2.4.39.tar.gz</span></span><br></pre></td></tr></table></figure>

<p>3.将apr及apr-util复制到httpd-2.4.39/srclib目录中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># cp -a apr-1.7.0 httpd-2.4.39/srclib/apr</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment"># cp -a apr-util-1.6.1 httpd-2.4.39/srclib/apr-util</span></span><br></pre></td></tr></table></figure>

<p>4.编译httpd</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># cd httpd-2.4.39</span></span><br><span class="line">[root@CentOS6 httpd-2.4.39]<span class="comment"># ./configure  --prefix=/app/httpd24  --enable-so  --enable-ssl  --enable-cgi --enable-rewrite  --with-zlib  --with-pcre  --with-included-apr=/root/httpd-2.4.39/srclib/  --enable-modules=most  --enable-mpms-shared=all  --with-mpm=prefork</span></span><br></pre></td></tr></table></figure>

<p>5.安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 httpd-2.4.39]<span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>

<p>6.为httpd创建系统用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># useradd -r -s /sbin/nologin apache</span></span><br></pre></td></tr></table></figure>

<p>7.修改配置文件，将httpd运行的用户和组改为apache</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># vim /app/httpd24/conf/httpd.conf</span></span><br><span class="line">User apache</span><br><span class="line">Group apache</span><br></pre></td></tr></table></figure>

<p>8.配置环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># echo &quot;PATH=/app/httpd24/bin:$PATH&quot; &gt; /etc/profile.d/httpd24.sh</span></span><br></pre></td></tr></table></figure>

<p>9.设置为开机启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment"># vim /etc/rc.d/rc.local</span></span><br><span class="line">/app/httpd24/bin/apachectl start</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ansible-编译安装httpd"><a href="#ansible-编译安装httpd" class="headerlink" title="ansible 编译安装httpd"></a>ansible 编译安装httpd</h2><h3 id="一、创建角色目录结构"><a href="#一、创建角色目录结构" class="headerlink" title="一、创建角色目录结构"></a>一、创建角色目录结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># mkdir -pv roles/httpd2.4/&#123;tasks,files,vars,templates,handlers&#125;</span></span><br><span class="line">mkdir: created directory ‘roles’</span><br><span class="line">mkdir: created directory ‘roles/httpd2.4’</span><br><span class="line">mkdir: created directory ‘roles/httpd2.4/tasks’</span><br><span class="line">mkdir: created directory ‘roles/httpd2.4/files’</span><br><span class="line">mkdir: created directory ‘roles/httpd2.4/vars’</span><br><span class="line">mkdir: created directory ‘roles/httpd2.4/templates’</span><br><span class="line">mkdir: created directory ‘roles/httpd2.4/handlers’</span><br></pre></td></tr></table></figure>

<h3 id="二、创建task"><a href="#二、创建task" class="headerlink" title="二、创建task"></a>二、创建task</h3><p>进入tasks目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cd /data/roles/httpd2.4/tasks/</span></span><br></pre></td></tr></table></figure>

<p>1.为httpserver创建安装目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim createdir.yaml</span></span><br><span class="line">- name: Create dir</span><br><span class="line">  file: path=/app state=directory</span><br></pre></td></tr></table></figure>

<p>2.解压httpd,apr,apr-util到远程主机</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim ungzhttpd.yaml</span></span><br><span class="line">- name: ungz httpd24</span><br><span class="line">  unarchive: src=httpd.tar.gz dest=/app copy=yes</span><br><span class="line">- name: ungz apr to srclib</span><br><span class="line">  unarchive: src=apr.tar.gz dest=/app/httpd-2.4.39/srclib copy=yes</span><br><span class="line">- name: ungz apr-util to srclib</span><br><span class="line">  unarchive: src=apr-util.tar.gz dest=/app/httpd-2.4.39/srclib copy=yes</span><br></pre></td></tr></table></figure>

<p>3.对解压后的apr.tar.gz及apr-util.tar.gz做软连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim links.yaml</span></span><br><span class="line">- name: link apr-util</span><br><span class="line">  file: src=/app/httpd-2.4.39/srclib/apr-util-1.6.1 dest=/app/httpd-2.4.39/srclib/apr-util state=link</span><br><span class="line">- name: link apr</span><br><span class="line">  file: src=/app/httpd-2.4.39/srclib/apr-1.7.0 dest=/app/httpd-2.4.39/srclib/apr state=link</span><br></pre></td></tr></table></figure>

<p>4.编译httpd</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim configure.yaml</span></span><br><span class="line">- name: configer httpd</span><br><span class="line">  shell: /app/httpd-2.4.39/configure  --prefix=/app/httpd24  --enable-so  --enable-ssl  --enable-cgi --enable-rewrite  --with-zlib  --with-pcre  --with-included-apr=/root/httpd-2.4.39/srclib/  --enable-modules=most  --enable-mpms-shared=all  --with-mpm=prefork</span><br></pre></td></tr></table></figure>

<p>5.make</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim make.yaml</span></span><br><span class="line">- name: make</span><br><span class="line">  shell: make</span><br></pre></td></tr></table></figure>

<p>6.make install</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim install.yaml</span></span><br><span class="line">- name: install</span><br><span class="line">  shell: make install</span><br></pre></td></tr></table></figure>

<p>7.设置开机自启</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim chkconf.yaml</span></span><br><span class="line">- name: chkconfig</span><br><span class="line">  lineinfile: path=/etc/rc.d/rc.local insertafter=<span class="string">&quot;^touch.*&quot;</span> line=<span class="string">&quot;/app/httpd24/bin/apachectl start&quot;</span></span><br></pre></td></tr></table></figure>

<p>8.添加apache用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim useradd.yaml</span></span><br><span class="line">- name: add user</span><br><span class="line">  user: name=apache  system=yes shell=/sbin/nologin create_home=no</span><br></pre></td></tr></table></figure>

<p>9.调用模板文件生成环境变量及httpd配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim template.yaml</span></span><br><span class="line">- name: httpd config</span><br><span class="line">  template: src=httpd.conf.j2 dest=/app/httpd24/conf/httpd.conf</span><br><span class="line">- name: Path</span><br><span class="line">  template: src=httpd.sh.j2 dest=/etc/profile.d/httpd.sh</span><br></pre></td></tr></table></figure>

<p>10.读取环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim source.yaml</span></span><br><span class="line">- name: <span class="built_in">source</span> path</span><br><span class="line">  shell: <span class="built_in">source</span> /etc/profile.d/httpd.sh</span><br></pre></td></tr></table></figure>

<p>11.启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim service.yaml</span></span><br><span class="line">- name: start service</span><br><span class="line">  shell: apachectl start</span><br></pre></td></tr></table></figure>

<p>12.创建main.yaml</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tasks]<span class="comment"># vim main.yaml</span></span><br><span class="line">- include: createdir.yaml</span><br><span class="line">- include: ungzhttpd.yaml</span><br><span class="line">- include: links.yaml</span><br><span class="line">- include: configure.yaml</span><br><span class="line">- include: make.yaml</span><br><span class="line">- include: install.yaml</span><br><span class="line">- include: chkconf.yaml</span><br><span class="line">- include: useradd.yaml</span><br><span class="line">- include: template.yaml</span><br><span class="line">- include: source.yaml</span><br><span class="line">- include: service.yaml</span><br></pre></td></tr></table></figure>

<h3 id="三、创建playbook"><a href="#三、创建playbook" class="headerlink" title="三、创建playbook"></a>三、创建playbook</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># vim role_httpd.yaml</span></span><br><span class="line">[root@localhost tasks]<span class="comment"># cd /data</span></span><br><span class="line">[root@localhost data]<span class="comment"># vim role_httpd.yaml</span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">    - role: httpd2.4</span><br></pre></td></tr></table></figure>

<h3 id="四、目录结构"><a href="#四、目录结构" class="headerlink" title="四、目录结构"></a>四、目录结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># tree /data</span></span><br><span class="line">/data</span><br><span class="line">├── role_httpd.yaml</span><br><span class="line">└── roles</span><br><span class="line">    └── httpd2.4</span><br><span class="line">        ├── files                           <span class="comment">#此目录下存放所有需要解压的包，注意去掉版本号</span></span><br><span class="line">        │   ├── apr.tar.gz</span><br><span class="line">        │   ├── apr-util.tar.gz</span><br><span class="line">        │   └── httpd.tar.gz</span><br><span class="line">        ├── handlers</span><br><span class="line">        ├── tasks</span><br><span class="line">        │   ├── chkconf.yaml</span><br><span class="line">        │   ├── configure.yaml</span><br><span class="line">        │   ├── createdir.yaml</span><br><span class="line">        │   ├── install.yaml</span><br><span class="line">        │   ├── links.yaml</span><br><span class="line">        │   ├── main.yaml</span><br><span class="line">        │   ├── make.yaml</span><br><span class="line">        │   ├── service.yaml</span><br><span class="line">        │   ├── source.yaml</span><br><span class="line">        │   ├── template.yaml</span><br><span class="line">        │   ├── ungzhttpd.yaml</span><br><span class="line">        │   └── useradd.yaml</span><br><span class="line">        ├── templates                       <span class="comment">#此目录下存放配置文件和环境变量的模板文件</span></span><br><span class="line">        │   ├── httpd.conf.j2</span><br><span class="line">        │   └── httpd.sh.j2</span><br><span class="line">        └── vars</span><br></pre></td></tr></table></figure>

<h3 id="五、执行playbook"><a href="#五、执行playbook" class="headerlink" title="五、执行playbook"></a>五、执行playbook</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ansible]<span class="comment"># ansible-playbook role_httpd.yaml</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>Kubernetes基础</title>
    <url>/2019/05/03/Kubernetes/Kubernetes%E5%9F%BA%E7%A1%80/Kubernetes%E5%9F%BA%E7%A1%80/</url>
    <content><![CDATA[<p>k8s是将一组主机上的内存、cpu、硬盘等资源，整合为一个大的资源池。当需要运行容器时，用户不需要指定其运行再哪个主机上，只需要向k8s的接口提出请求，然后由k8s自行调度运行到一个最适合其运行的宿主机上作为容器运行起来。用户无需再面对一个个独立的主机，只需要向k8s资源池的接口提出请求即可。</p>
<p>若用户需要运行两个容器，且2个容器间需要通信，k8s则会抽象出一些组件。当一个服务容器启动时，会注册到k8s的注册中心，当第二个容器启动后要访问第一个容器时，先向k8s的注册中心查询服务，而后直接拿着查询获得的地址直接请求即可。</p>
<p>当所创建的实例无法承载客户端的请求时，传统的做法是，加服务器部署服务接入负载均均衡。而k8s则为自动扩展一个容器，然后自动加入到负载均衡中。当然可以手动介入。</p>
<p>k8s的自动扩容也可以为纯自动模式的，只需要在各个容器前加一个控制器用来监控控制器下面容器的数量要完全符合用户的请求。我们还可以在此控制器之前再加一层控制器，此二层控制器接入到监控系统上去，监控系统用来监控容器的CPU、内存等容量，当发现容器内资源不足时，自动指挥其一级控制器进行添加实例。当容器的CPU和内存使用率低于一定指标后，k8s会自动删除一些实例。从而实现自动扩缩容。</p>
<p>&lt;– more –&gt;</p>
<h3 id="控制器相关"><a href="#控制器相关" class="headerlink" title="控制器相关"></a>控制器相关</h3><p>在k8s上有2种控制器，<code>controller</code>和<code>operator</code>。</p>
<ul>
<li>controller：为简单的控制器</li>
<li>operator：为复杂的、能单独管理应用集群的控制器。</li>
</ul>
<h3 id="k8s运行流程"><a href="#k8s运行流程" class="headerlink" title="k8s运行流程"></a>k8s运行流程</h3><p>当需要在k8s集群上运行容器时，首先需要先创建出一个控制器，并告诉控制器需要干什么（如运行3个nginx容器），其会自己调用k8s的api，更具用户需要创建的容器的要求，如镜像、容器数等等，在k8s上创建出相应的容器。</p>
<h3 id="k8s节点的角色"><a href="#k8s节点的角色" class="headerlink" title="k8s节点的角色"></a>k8s节点的角色</h3><p>k8s的节点分为2类角色，第一类角色为Master，第二类为worker。</p>
<ul>
<li>Master Node：主要用来管理集群中的所有Worker Node，包括Master Node自己。</li>
<li>Worker Node：主要为集群中的工作节点，所有的容器均会运行在此节点上。</li>
</ul>
<h3 id="k8s的组件"><a href="#k8s的组件" class="headerlink" title="k8s的组件"></a>k8s的组件</h3><p>k8s在Master和Worker上的组件拥有各种组件。</p>
<ul>
<li><p>Master Node:</p>
</li>
<li><p>API server：用来提供API</p>
</li>
<li><p>Controller Manager：控制器管理器，负责管理各种各样的控制器。</p>
</li>
<li><p>Scheduler：调度器</p>
</li>
<li><p>Etcd：强一致的分分布式注册中心，KV存储服务器，此为Master的状态存储。</p>
</li>
<li><p>Worker Node：</p>
</li>
<li><p>kubelet：用来和master建立通信，始终watch着API server，执行Master所下发的任务。</p>
</li>
<li><p>kube-proxy：代理服务组件。</p>
</li>
<li><p>continer engine：容器引擎，docker或其他。</p>
</li>
</ul>
<p>Worker Node上的三个组件和API server建立关联关系，他们都是API server的客户端，他们不和Master的其他组件建立交互。所以API server为整体的交互中心，但是API server除了交互不做其他事情，真正做事情的是Controller Manager。</p>
<h3 id="k8s各组件的工作流程"><a href="#k8s各组件的工作流程" class="headerlink" title="k8s各组件的工作流程"></a>k8s各组件的工作流程</h3><p>当用户请求创建容器时，API server接收到请求将其写入<code>etcd</code>中，<code>Controller Manager</code>和<code>Scheduler</code>根据<code>API server</code>中保存的所有<code>worker</code>节点 的相关状态和用户所需要创建的容器的相关要求，选出最优的节点发送给<code>API server</code>。各<code>worker</code>节点 上的<code>kubelet</code> 始终watch着<code>API server</code>，当查看到有和自己节点相关的创建容器请求时，自动在自己的<code>worker</code>节点上创建出相应的容器。</p>
<p><img src="" alt="k8s工作流程"></p>
]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>DNS服务</title>
    <url>/2019/03/14/Linux%E5%9F%BA%E7%A1%80/DNS%E6%9C%8D%E5%8A%A1/DNS%E6%9C%8D%E5%8A%A1/</url>
    <content><![CDATA[<h2 id="DNS服务"><a href="#DNS服务" class="headerlink" title="DNS服务"></a>DNS服务</h2><p>DNS全称为Domain Name Service 应用层协议，其架构为C/S架构，在tcp和udp的53号端口。</p>
<p>DNS的实现是BIND(Bekerley Internat Name Domain)</p>
<p>DNS的作用是把域名解析为ip地址，在本地的/etc/hosts文件也能做到域名解析的作用，但不方便管理，只适合小型的企业环境和集群的环境中使用。</p>
<span id="more"></span>

<h3 id="DNS解析"><a href="#DNS解析" class="headerlink" title="DNS解析"></a>DNS解析</h3><p>DNS的查询类型分为两种：递归查询和迭代查询</p>
<p>递归查询：当主机去访问网络中的dns服务器时，其查询的类型为递归查询</p>
<p>迭代查询：当网路中的服务器向dns服务查询FQDN时，dns服务器会从先去向根服务器查询，根服务器会传回一个顶级域所在的位置，然后dns服务器再向顶级域进行查询，顶级域再传回一个二级域的地址，dns服务器再去向二级域查询，最后获得所要查询的FQDN对应的主机的ip地址。这个过程为迭代查询</p>
<p>名称服务器：用来解析本域内的名称的主机，全世界共有13组根服务器。</p>
<h3 id="Bind的相关配置文件"><a href="#Bind的相关配置文件" class="headerlink" title="Bind的相关配置文件"></a>Bind的相关配置文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/etc/named.conf			<span class="comment">#服务器的配置文件</span></span><br><span class="line">/var/named				<span class="comment">#DNS数据库路径</span></span><br><span class="line">/usr/lib/systemd/system/named.service		<span class="comment">#服务文件</span></span><br><span class="line">/var/named/named.ca		<span class="comment">#互联网上13个根DNS服务器地址</span></span><br></pre></td></tr></table></figure>

<p>DNS服务虽然监听在tcp和udp的53号端口，但却依赖于udp的53号端口。</p>
<h3 id="DNS配置文件"><a href="#DNS配置文件" class="headerlink" title="DNS配置文件"></a>DNS配置文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/named.conf </span></span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">// named.conf</span><br><span class="line">//</span><br><span class="line">// Provided by Red Hat <span class="built_in">bind</span> package to configure the ISC BIND named(8) DNS</span><br><span class="line">// server as a caching only nameserver (as a localhost DNS resolver only).</span><br><span class="line">//</span><br><span class="line">// See /usr/share/doc/<span class="built_in">bind</span>*/sample/ <span class="keyword">for</span> example named configuration files.</span><br><span class="line">//</span><br><span class="line">// See the BIND Administrator<span class="string">&#x27;s Reference Manual (ARM) for details about the</span></span><br><span class="line"><span class="string">// configuration located in /usr/share/doc/bind-&#123;version&#125;/Bv9ARM.html</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">options &#123;</span></span><br><span class="line"><span class="string">        listen-on port 53 &#123; localhost; &#125;;           #此行为监听的ip地址，使用any或注释此行表示监听所有ip地址</span></span><br><span class="line"><span class="string">        listen-on-v6 port 53 &#123; ::1; &#125;;</span></span><br><span class="line"><span class="string">        directory       &quot;/var/named&quot;;               #此外数据库文件</span></span><br><span class="line"><span class="string">        dump-file       &quot;/var/named/data/cache_dump.db&quot;;</span></span><br><span class="line"><span class="string">        statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span></span><br><span class="line"><span class="string">        memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span></span><br><span class="line"><span class="string">        recursing-file  &quot;/var/named/data/named.recursing&quot;;</span></span><br><span class="line"><span class="string">        secroots-file   &quot;/var/named/data/named.secroots&quot;;</span></span><br><span class="line"><span class="string">        allow-query     &#123; localhost; &#125;;             #此行表示的是允许网络中的哪些主机来进行DNS查询。使用any或注释表示允许所有主机来查询。也可以将其设置成网段，来允许网络中某网段来查询。0.0.0.0/0 格式</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /* </span></span><br><span class="line"><span class="string">         - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.</span></span><br><span class="line"><span class="string">         - If you are building a RECURSIVE (caching) DNS server, you need to enable </span></span><br><span class="line"><span class="string">           recursion. </span></span><br><span class="line"><span class="string">         - If your recursive DNS server has a public IP address, you MUST enable access </span></span><br><span class="line"><span class="string">           control to limit queries to your legitimate users. Failing to do so will</span></span><br><span class="line"><span class="string">           cause your server to become part of large scale DNS amplification </span></span><br><span class="line"><span class="string">           attacks. Implementing BCP38 within your network would greatly</span></span><br><span class="line"><span class="string">           reduce such attack surface </span></span><br><span class="line"><span class="string">        */</span></span><br><span class="line"><span class="string">        recursion yes;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        dnssec-enable yes;</span></span><br><span class="line"><span class="string">        dnssec-validation yes;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /* Path to ISC DLV key */</span></span><br><span class="line"><span class="string">        bindkeys-file &quot;/etc/named.iscdlv.key&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        managed-keys-directory &quot;/var/named/dynamic&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        pid-file &quot;/run/named/named.pid&quot;;</span></span><br><span class="line"><span class="string">        session-keyfile &quot;/run/named/session.key&quot;;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">logging &#123;</span></span><br><span class="line"><span class="string">        channel default_debug &#123;</span></span><br><span class="line"><span class="string">                file &quot;data/named.run&quot;;</span></span><br><span class="line"><span class="string">                severity dynamic;</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">zone &quot;.&quot; IN &#123;</span></span><br><span class="line"><span class="string">        type hint;</span></span><br><span class="line"><span class="string">        file &quot;named.ca&quot;;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">include &quot;/etc/named.rfc1912.zones&quot;;</span></span><br><span class="line"><span class="string">include &quot;/etc/named.root.key&quot;;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>DNS</tag>
      </tags>
  </entry>
  <entry>
    <title>DNS转发</title>
    <url>/2019/03/14/Linux%E5%9F%BA%E7%A1%80/DNS%E8%BD%AC%E5%8F%91/DNS%E8%BD%AC%E5%8F%91/</url>
    <content><![CDATA[<h2 id="DNS转发"><a href="#DNS转发" class="headerlink" title="DNS转发"></a>DNS转发</h2><p>dns转发分为2种，全局转发和特定区域转发。</p>
<p>全局转发是对非本机所负责解析区域的请求，全部转发给指定的服务器。</p>
<p>特定区域转发是仅转发对特定的区域的请求，比全局转发优先级高。</p>
<p>转发分为2种模式：first和only  </p>
<p>first模式：先到本地DNS查找，若本地dns查找不到记录，去其他的dns服务器查找，若其他dns服务器也没有，直接去根服务器查找   </p>
<p>only模式：先到本地DNS查找，若本地dns查找不到记录，去其他的dns服务器查找，若其他dns服务器也没有，直接放弃。</p>
<span id="more"></span>

<hr>
<h3 id="全局转发的only模式"><a href="#全局转发的only模式" class="headerlink" title="全局转发的only模式"></a>全局转发的only模式</h3><p>准备客户机一台，dns服务器两台，将dns1服务器的转发地址者设置为dns2，dns1有两个网卡一个是内网，一个是外网，dns2只有一个连接内网的网卡</p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">ip</th>
</tr>
</thead>
<tbody><tr>
<td align="left">client</td>
<td align="left">192.168.73.120</td>
</tr>
<tr>
<td align="left">dns1</td>
<td align="left">192.168.73.10    172.22.145.220</td>
</tr>
<tr>
<td align="left">dns2</td>
<td align="left">192.168.73.30</td>
</tr>
</tbody></table>
<p>分别在dns1、dns2上配置dns服务  </p>
<p>在dns2上部署配置dns</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns2 ~]<span class="comment"># yum install bind -y</span></span><br><span class="line">[root@dns2 ~]<span class="comment"># vim /etc/named.conf </span></span><br><span class="line">options &#123;</span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;       <span class="comment">#此行注释</span></span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//      allow-query     &#123; localhost; &#125;;         <span class="comment">#此行注释</span></span><br></pre></td></tr></table></figure>

<p>dns2启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns2 ~]<span class="comment"># systemctl start named</span></span><br></pre></td></tr></table></figure>

<p>dns1主机上部署dns服务并设置dns转发，转发模式为only</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;           <span class="comment">#注释</span></span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//      allow-query     &#123; localhost; &#125;;             <span class="comment">#注释</span></span><br><span class="line">        forward         only;                       <span class="comment">#转发模式设置为only</span></span><br><span class="line">        forwarders      &#123;192.168.73.30;&#125;;           <span class="comment">#转发地址设置为dns2主机</span></span><br><span class="line"></span><br><span class="line">        dnssec-enable no;                           <span class="comment">#设置转发时需要关闭dnssec相关</span></span><br><span class="line"></span><br><span class="line">        dnssec-validation no;                       <span class="comment">#设置转发时需要关闭dnssec相关</span></span><br></pre></td></tr></table></figure>

<p>在client主机上去解析<a href="http://www.baidu.com/">www.baidu.com</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># dig www.baidu.com @192.168.192.10</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-72.el7 &lt;&lt;&gt;&gt; www.baidu.com @192.168.192.10</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; connection timed out; no servers could be reached</span><br></pre></td></tr></table></figure>

<p>转发模式为only的情况下，无法解析到<a href="http://www.baidu.com的地址./">www.baidu.com的地址。</a></p>
<hr>
<h3 id="全局转发的first模式"><a href="#全局转发的first模式" class="headerlink" title="全局转发的first模式"></a>全局转发的first模式</h3><p>将dns1设置为first模式下的转发</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns1 ~]<span class="comment"># vim /etc/named.conf </span></span><br><span class="line">options &#123;</span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//      allow-query     &#123; localhost; &#125;;</span><br><span class="line">        forward         first;                  <span class="comment">#修改为first</span></span><br><span class="line">        forwarders      &#123;192.168.73.30;&#125;;</span><br></pre></td></tr></table></figure>

<p>重读配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@dns1 ~]<span class="comment"># rndc reload</span></span><br><span class="line">server reload successful</span><br></pre></td></tr></table></figure>

<p>在client上进行测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># dig www.baidu.com @192.168.73.10</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-72.el7 &lt;&lt;&gt;&gt; www.baidu.com @192.168.73.10</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 44783</span></span><br><span class="line"><span class="string">;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 5, ADDITIONAL: 6</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;www.baidu.com.			IN	A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">www.baidu.com.		1200	IN	CNAME	www.a.shifen.com.</span></span><br><span class="line"><span class="string">www.a.shifen.com.	300	IN	A	61.135.169.121</span></span><br><span class="line"><span class="string">www.a.shifen.com.	300	IN	A	61.135.169.125</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; AUTHORITY SECTION:</span></span><br><span class="line"><span class="string">a.shifen.com.		1199	IN	NS	ns2.a.shifen.com.</span></span><br><span class="line"><span class="string">a.shifen.com.		1199	IN	NS	ns5.a.shifen.com.</span></span><br><span class="line"><span class="string">a.shifen.com.		1199	IN	NS	ns4.a.shifen.com.</span></span><br><span class="line"><span class="string">a.shifen.com.		1199	IN	NS	ns3.a.shifen.com.</span></span><br><span class="line"><span class="string">a.shifen.com.		1199	IN	NS	ns1.a.shifen.com.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ADDITIONAL SECTION:</span></span><br><span class="line"><span class="string">ns1.a.shifen.com.	1199	IN	A	61.135.165.224</span></span><br><span class="line"><span class="string">ns2.a.shifen.com.	1199	IN	A	220.181.57.142</span></span><br><span class="line"><span class="string">ns3.a.shifen.com.	1199	IN	A	112.80.255.253</span></span><br><span class="line"><span class="string">ns4.a.shifen.com.	1199	IN	A	14.215.177.229</span></span><br><span class="line"><span class="string">ns5.a.shifen.com.	1199	IN	A	180.76.76.95</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 2835 msec</span></span><br><span class="line"><span class="string">;; SERVER: 192.168.73.10#53(192.168.73.10)</span></span><br><span class="line"><span class="string">;; WHEN: Tue Apr 23 23:30:16 CST 2019</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 271</span></span><br></pre></td></tr></table></figure>

<p>此时服务器返回的为dns1从网络上其他dns所解析到的地址</p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>DNS</tag>
      </tags>
  </entry>
  <entry>
    <title>Inode Table</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/Inode%E8%A1%A8/inode_table/</url>
    <content><![CDATA[<h1 id="Inode-Table"><a href="#Inode-Table" class="headerlink" title="Inode Table"></a>Inode Table</h1><p>inode表内存储了文件的元数据，包括文件权限、属主属组、文件大小、访问时间、修改时间、元数据变更时间和真正的数据存储位置的指向。</p>
<span id="more"></span>

<p><img src="inode.jpg" alt="inode结构表"></p>
<h3 id="执行cp、rm、mv操做文件在磁盘上的变化"><a href="#执行cp、rm、mv操做文件在磁盘上的变化" class="headerlink" title="执行cp、rm、mv操做文件在磁盘上的变化"></a>执行cp、rm、mv操做文件在磁盘上的变化</h3><p>cp：分配一个空的inode号，在inode表中生成新条目在目录中创建一个目录项，将名称与inode编号关联拷贝数据生成新文件  </p>
<p>rm：链接数递减，释放inode号，把数据块标记为空闲。删除目录项，数据不会马上被删除，当另一个文件使用数据块时将被覆盖  </p>
<p>mv：移动的目标和源在同一文件系统，用新的文件名创建相对应的新目录项，删除旧的文件名，不影响磁盘上的数据位置，若源和目标不在同一文件系统，mv执行效果相当于cp+rm</p>
<h3 id="硬链接"><a href="#硬链接" class="headerlink" title="硬链接"></a>硬链接</h3><p>硬链接就是在同一文件系统内，不同名字，inode号和磁盘数据位置相同的一种文件。当硬链接被创建时文件的链接数+1，当文件被删除时，链接数-1，当链接数为0时，该文件被删除，硬链接不能跨分区。</p>
<p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ln filename [linkname]</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># ll passwd</span></span><br><span class="line">-rw-r--r-- 1 root root 2265 Mar  9 13:32 passwd     链接数为1</span><br><span class="line">[root@centos7 data]<span class="comment"># ln passwd passwd1</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ll passwd passwd1</span></span><br><span class="line">-rw-r--r-- 2 root root 2265 Mar  9 13:32 passwd</span><br><span class="line">-rw-r--r-- 2 root root 2265 Mar  9 13:32 passwd1    链接数为2，其余都一样</span><br></pre></td></tr></table></figure>

<h3 id="软链接："><a href="#软链接：" class="headerlink" title="软链接："></a>软链接：</h3><p>软链接是一个链接指向另一个文件，他可以对目录进行链接，也可以跨分区创建，其文件大小为指向的路径字符串的长度，创建或删除不会增加或减少目标文件inode的引用计数。  </p>
<p>命令格式：  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -s filename [linkname]</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># ln -s ../data/passwd /passwd</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ll passwd /passwd</span></span><br><span class="line">-rw-r--r-- 2 root root 2265 Mar  9 13:32 passwd</span><br><span class="line">lrwxrwxrwx 1 root root    6 Mar  9 19:53 /passwd -&gt; ../data/passwd     </span><br></pre></td></tr></table></figure>

<p>注意：软链接使用相对路径时，是相对于链接文件的相对路径，Linux系统内的软链接都是相对路径，所以在创建软链接时推荐使用相对路径。</p>
<p>软硬链接的区别:</p>
<table>
<thead>
<tr>
<th align="left">区别</th>
<th align="left">软链接</th>
<th align="left">硬链接</th>
</tr>
</thead>
<tbody><tr>
<td align="left">文件</td>
<td align="left">不同的文件</td>
<td align="left">同一个文件</td>
</tr>
<tr>
<td align="left">inode号</td>
<td align="left">不同</td>
<td align="left">相同</td>
</tr>
<tr>
<td align="left">能否跨分区</td>
<td align="left">能</td>
<td align="left">不能</td>
</tr>
<tr>
<td align="left">链接数</td>
<td align="left">不增加</td>
<td align="left">增加</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>LVM逻辑卷和文件系统</title>
    <url>/2019/03/05/Linux%E5%9F%BA%E7%A1%80/LVM%E9%80%BB%E8%BE%91%E5%8D%B7%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/LVM%E9%80%BB%E8%BE%91%E5%8D%B7%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<h2 id="LVM逻辑卷和文件系统"><a href="#LVM逻辑卷和文件系统" class="headerlink" title="LVM逻辑卷和文件系统"></a>LVM逻辑卷和文件系统</h2><p>逻辑卷的组成是，集成各种空间组合成物理卷，然后集合物理卷组合成一个卷组，然后在卷组上创建逻辑卷。</p>
<p>所以要创建逻辑卷首先需要创建物理卷，然后组合物理卷创建卷组，最后创建可以使用的逻辑卷。</p>
<span id="more"></span>  

<hr>
<h2 id="逻辑卷创建方式"><a href="#逻辑卷创建方式" class="headerlink" title="逻辑卷创建方式"></a>逻辑卷创建方式</h2><p>以下为逻辑卷的创建方式</p>
<h3 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h3><p>1.一个mbr分区的5G空间(sdb1)<br>2.一个gpt分区的5G空间(sdc1)<br>3.一个未分区的磁盘(sdd)  </p>
<h3 id="创建实验环境"><a href="#创建实验环境" class="headerlink" title="创建实验环境"></a>创建实验环境</h3><p>1.建立一个mbr分区的5G空间(sdb1)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># fdisk /dev/sdb</span></span><br><span class="line">Welcome to fdisk (util-linux 2.23.2).</span><br><span class="line"></span><br><span class="line">Changes will remain <span class="keyword">in</span> memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table</span><br><span class="line">Building a new DOS disklabel with disk identifier 0x8898f839.</span><br><span class="line"><span class="comment">#选择n创建一个5G新分区</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition <span class="built_in">type</span>:</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p): </span><br><span class="line">Using default response p</span><br><span class="line">Partition number (1-4, default 1): </span><br><span class="line">First sector (2048-20971519, default 2048): </span><br><span class="line">Using default value 2048</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (2048-20971519, default 20971519): +5G</span><br><span class="line">Partition 1 of <span class="built_in">type</span> Linux and of size 5 GiB is <span class="built_in">set</span></span><br><span class="line"><span class="comment">#将标签设置为LVM</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): t</span><br><span class="line">Selected partition 1</span><br><span class="line">Hex code (<span class="built_in">type</span> L to list all codes): 8e</span><br><span class="line">Changed <span class="built_in">type</span> of partition <span class="string">&#x27;Linux&#x27;</span> to <span class="string">&#x27;Linux LVM&#x27;</span></span><br><span class="line"><span class="comment">#查看将要生成的设备</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): p</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 10.7 GB, 10737418240 bytes, 20971520 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0x8898f839</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sdb1            2048    10487807     5242880   8e  Linux LVM</span><br><span class="line"><span class="comment">#确认无误写入磁盘</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br><span class="line"><span class="comment">#查看是否同步到内存中</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># lsblk</span></span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  200G  0 disk </span><br><span class="line">├─sda1   8:1    0    1G  0 part /boot</span><br><span class="line">├─sda2   8:2    0  100G  0 part /</span><br><span class="line">├─sda3   8:3    0   50G  0 part /data</span><br><span class="line">├─sda4   8:4    0    1K  0 part </span><br><span class="line">└─sda5   8:5    0    2G  0 part [SWAP]</span><br><span class="line">sdb      8:16   0   10G  0 disk </span><br><span class="line">└─sdb1   8:17   0    5G  0 part </span><br><span class="line">sdc      8:32   0   10G  0 disk </span><br><span class="line">sdd      8:48   0   10G  0 disk </span><br><span class="line">sr0     11:0    1   10G  0 rom  </span><br><span class="line"><span class="comment">#mbr分区的5G空间创建完毕</span></span><br></pre></td></tr></table></figure>

<p>2.建立一个gpt分区的5G空间</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用gdisk创建gpt分区</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># gdisk /dev/sdc</span></span><br><span class="line">GPT fdisk (gdisk) version 0.8.10</span><br><span class="line"></span><br><span class="line">Partition table scan:</span><br><span class="line">  MBR: not present</span><br><span class="line">  BSD: not present</span><br><span class="line">  APM: not present</span><br><span class="line">  GPT: not present</span><br><span class="line"></span><br><span class="line">Creating new GPT entries.</span><br><span class="line"><span class="comment">#创建一个新分区</span></span><br><span class="line">Command (? <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition number (1-128, default 1): </span><br><span class="line">First sector (34-20971486, default = 2048) or &#123;+-&#125;size&#123;KMGTP&#125;: </span><br><span class="line">Last sector (2048-20971486, default = 20971486) or &#123;+-&#125;size&#123;KMGTP&#125;: +5G</span><br><span class="line">Current <span class="built_in">type</span> is <span class="string">&#x27;Linux filesystem&#x27;</span></span><br><span class="line"><span class="comment">#调整分区标签为LVM</span></span><br><span class="line">Hex code or GUID (L to show codes, Enter = 8300): 8e00 </span><br><span class="line">Changed <span class="built_in">type</span> of partition to <span class="string">&#x27;Linux LVM&#x27;</span></span><br><span class="line"><span class="comment">#查看下将要创建的分区信息</span></span><br><span class="line">Command (? <span class="keyword">for</span> <span class="built_in">help</span>): p</span><br><span class="line">Disk /dev/sdc: 20971520 sectors, 10.0 GiB</span><br><span class="line">Logical sector size: 512 bytes</span><br><span class="line">Disk identifier (GUID): 56C9AA2B-2D21-45A5-A422-882476BA60A6</span><br><span class="line">Partition table holds up to 128 entries</span><br><span class="line">First usable sector is 34, last usable sector is 20971486</span><br><span class="line">Partitions will be aligned on 2048-sector boundaries</span><br><span class="line">Total free space is 10485693 sectors (5.0 GiB)</span><br><span class="line"></span><br><span class="line">Number  Start (sector)    End (sector)  Size       Code  Name</span><br><span class="line">   1            2048        10487807   5.0 GiB     8E00  Linux LVM</span><br><span class="line"><span class="comment">#将信息写入磁盘</span></span><br><span class="line">Command (? <span class="keyword">for</span> <span class="built_in">help</span>): w</span><br><span class="line"></span><br><span class="line">Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING</span><br><span class="line">PARTITIONS!!</span><br><span class="line"></span><br><span class="line">Do you want to proceed? (Y/N): y</span><br><span class="line">OK; writing new GUID partition table (GPT) to /dev/sdc.</span><br><span class="line">The operation has completed successfully.</span><br><span class="line"><span class="comment">#查看设置是否同步入内存</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># lsblk</span></span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  200G  0 disk </span><br><span class="line">├─sda1   8:1    0    1G  0 part /boot</span><br><span class="line">├─sda2   8:2    0  100G  0 part /</span><br><span class="line">├─sda3   8:3    0   50G  0 part /data</span><br><span class="line">├─sda4   8:4    0    1K  0 part </span><br><span class="line">└─sda5   8:5    0    2G  0 part [SWAP]</span><br><span class="line">sdb      8:16   0   10G  0 disk </span><br><span class="line">└─sdb1   8:17   0    5G  0 part </span><br><span class="line">sdc      8:32   0   10G  0 disk </span><br><span class="line">└─sdc1   8:33   0    5G  0 part </span><br><span class="line">sdd      8:48   0   10G  0 disk </span><br><span class="line">sr0     11:0    1   10G  0 rom  </span><br><span class="line"><span class="comment">#gpt分区sd1的5G空间创建完毕</span></span><br></pre></td></tr></table></figure>

<p>3.一个未分区的磁盘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#未分区磁盘sdd已经存在无需创建</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># lsblk</span></span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  200G  0 disk </span><br><span class="line">├─sda1   8:1    0    1G  0 part /boot</span><br><span class="line">├─sda2   8:2    0  100G  0 part /</span><br><span class="line">├─sda3   8:3    0   50G  0 part /data</span><br><span class="line">├─sda4   8:4    0    1K  0 part </span><br><span class="line">└─sda5   8:5    0    2G  0 part [SWAP]</span><br><span class="line">sdb      8:16   0   10G  0 disk </span><br><span class="line">└─sdb1   8:17   0    5G  0 part </span><br><span class="line">sdc      8:32   0   10G  0 disk </span><br><span class="line">└─sdc1   8:33   0    5G  0 part </span><br><span class="line">sdd      8:48   0   10G  0 disk </span><br><span class="line">sr0     11:0    1   10G  0 rom  </span><br></pre></td></tr></table></figure>

<p><em><strong>至此实验环境搭建完毕</strong></em></p>
<hr>
<h3 id="创建LVM"><a href="#创建LVM" class="headerlink" title="创建LVM"></a>创建LVM</h3><ul>
<li>1.创建物理卷（PV）</li>
</ul>
<p>将3块磁盘空间全部转换为物理卷（PV）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># pvcreate /dev/sd&#123;b1,c1,d&#125;</span></span><br><span class="line">  Physical volume <span class="string">&quot;/dev/sdb1&quot;</span> successfully created.</span><br><span class="line">  Physical volume <span class="string">&quot;/dev/sdc1&quot;</span> successfully created.</span><br><span class="line">  Physical volume <span class="string">&quot;/dev/sdd&quot;</span> successfully created.</span><br><span class="line">  [root@centos7 data]<span class="comment"># pvs</span></span><br><span class="line">  PV         VG  Fmt  Attr PSize  PFree </span><br><span class="line">  /dev/sdb1  vg0 lvm2 a--  &lt;5.00g &lt;5.00g</span><br><span class="line">  /dev/sdc1  vg0 lvm2 a--  &lt;5.00g &lt;5.00g</span><br><span class="line">  /dev/sdd       lvm2 ---  10.00g 10.00g</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>2.创建卷组（vg）</li>
</ul>
<p>出于后期增加卷组考虑此处先使用2块磁盘空间组成vg  </p>
<p>将mbr分区的sdb1和gpt分区的sdc1组成卷组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># vgcreate vg0 /dev/sd&#123;b1,c1&#125;</span></span><br><span class="line">  Volume group <span class="string">&quot;vg0&quot;</span> successfully created</span><br><span class="line">[root@centos7 data]<span class="comment"># vgs</span></span><br><span class="line">  VG  <span class="comment">#PV #LV #SN Attr   VSize VFree</span></span><br><span class="line">  vg0   2   0   0 wz--n- 9.99g 9.99g</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>3.创建逻辑卷（lv）</li>
</ul>
<p>1.创建一个6G的逻辑卷,一个3G的逻辑卷</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># lvcreate -n test1 -L 6G vg0</span></span><br><span class="line">  Logical volume <span class="string">&quot;test1&quot;</span> created.</span><br><span class="line">[root@centos7 data]<span class="comment"># lvcreate -n test2 -L 3G vg0</span></span><br><span class="line">  Logical volume <span class="string">&quot;test2&quot;</span> created.</span><br><span class="line">[root@centos7 data]<span class="comment"># lvs</span></span><br><span class="line">  LV    VG  Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  test1 vg0 -wi-a----- 6.00g                                                    </span><br><span class="line">  test2 vg0 -wi-a----- 3.00g            </span><br></pre></td></tr></table></figure>

<p><em><strong>至此2个逻辑卷已经创建完成。接下来需要在逻辑卷上创建文件系统了</strong></em></p>
<hr>
<h3 id="创建文件系统"><a href="#创建文件系统" class="headerlink" title="创建文件系统"></a>创建文件系统</h3><p>文件系统有很多种类，此处以xfs和ext4为例进行建立  </p>
<h4 id="ext4文件系统"><a href="#ext4文件系统" class="headerlink" title="ext4文件系统"></a>ext4文件系统</h4><p>1.在/dev/vg0/test1上建立ext4</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># mkfs.ext4 -L &#x27;test1&#x27; /dev/vg0/test1</span></span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem label=test1</span><br><span class="line">OS <span class="built_in">type</span>: Linux</span><br><span class="line">Block size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Fragment size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">393216 inodes, 1572864 blocks</span><br><span class="line">78643 blocks (5.00%) reserved <span class="keyword">for</span> the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=1610612736</span><br><span class="line">48 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">8192 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">	32768, 98304, 163840, 229376, 294912, 819200, 884736</span><br><span class="line"></span><br><span class="line">Allocating group tables: <span class="keyword">done</span>                            </span><br><span class="line">Writing inode tables: <span class="keyword">done</span>                            </span><br><span class="line">Creating journal (32768 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2.将ext4文件系统挂载至/data/test1下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># mkdir test1</span></span><br><span class="line">[root@centos7 data]<span class="comment"># mount /dev/vg0/test1 /data/test1/</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cd /data/test1/</span></span><br><span class="line">[root@centos7 test1]<span class="comment"># ls</span></span><br><span class="line">lost+found</span><br><span class="line">[root@centos7 test1]<span class="comment"># findmnt /data/test1</span></span><br><span class="line">TARGET      SOURCE                FSTYPE OPTIONS</span><br><span class="line">/data/test1 /dev/mapper/vg0-test1 ext4   rw,relatime,data=ordered</span><br></pre></td></tr></table></figure>

<h4 id="xfs文件系统"><a href="#xfs文件系统" class="headerlink" title="xfs文件系统"></a>xfs文件系统</h4><p>1.在/dev/vg0/tset2上建立xfs文件系统。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 test1]<span class="comment"># findmnt /data/test1</span></span><br><span class="line">TARGET      SOURCE                FSTYPE OPTIONS</span><br><span class="line">/data/test1 /dev/mapper/vg0-test1 ext4   rw,relatime,data=ordered</span><br><span class="line">[root@centos7 test1]<span class="comment"># mkfs.xfs -L &quot;test2&quot; /dev/vg0/test2</span></span><br><span class="line">meta-data=/dev/vg0/test2         isize=512    agcount=4, agsize=196608 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=0, sparse=0</span><br><span class="line">data     =                       bsize=4096   blocks=786432, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line"><span class="built_in">log</span>      =internal <span class="built_in">log</span>           bsize=4096   blocks=2560, version=2</span><br><span class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure>
<p>2.将文件系统挂载至/data/test2下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 test1]<span class="comment"># mkdir /data/test2</span></span><br><span class="line">[root@centos7 test1]<span class="comment"># mount /dev/vg0/test2 /data/test2</span></span><br><span class="line">[root@centos7 test1]<span class="comment"># findmnt /data/test2</span></span><br><span class="line">TARGET      SOURCE                FSTYPE OPTIONS</span><br><span class="line">/data/test2 /dev/mapper/vg0-test2 xfs    rw,relatime,attr2,inode64,noquota</span><br></pre></td></tr></table></figure>

<p><em><strong>2个文件系统已经创建完毕,由于后续实验需求现在两个磁盘上分别创建几个文件</strong></em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 test1]<span class="comment"># touch file&#123;1..10&#125;</span></span><br><span class="line">[root@centos7 test1]<span class="comment"># ls</span></span><br><span class="line">file1  file10  file2  file3  file4  file5  file6  file7  file8  file9  lost+found</span><br><span class="line">[root@centos7 test1]<span class="comment"># cd ../test2</span></span><br><span class="line">[root@centos7 test2]<span class="comment"># touch file&#123;a..j&#125;</span></span><br><span class="line">[root@centos7 test2]<span class="comment"># ls</span></span><br><span class="line">filea  fileb  filec  filed  filee  filef  fileg  fileh  filei  filej</span><br></pre></td></tr></table></figure>

<h3 id="逻辑卷的容量增加和减少"><a href="#逻辑卷的容量增加和减少" class="headerlink" title="逻辑卷的容量增加和减少"></a>逻辑卷的容量增加和减少</h3><h4 id="一、分别对逻辑卷test1及test2增加1G容量"><a href="#一、分别对逻辑卷test1及test2增加1G容量" class="headerlink" title="一、分别对逻辑卷test1及test2增加1G容量"></a>一、分别对逻辑卷test1及test2增加1G容量</h4><p>1.查看卷组的相关信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 test2]<span class="comment"># vgdisplay</span></span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               vg0</span><br><span class="line">  System ID             </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        2</span><br><span class="line">  Metadata Sequence No  3</span><br><span class="line">  VG Access             <span class="built_in">read</span>/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                2</span><br><span class="line">  Open LV               2</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                2</span><br><span class="line">  Act PV                2</span><br><span class="line">  VG Size               9.99 GiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              2558</span><br><span class="line">  Alloc PE / Size       2304 / 9.00 GiB</span><br><span class="line">  Free  PE / Size       254 / 1016.00 MiB</span><br><span class="line">  VG UUID               4CadZ4-W3dV-kjNa-leu2-u6jd-YMeq-o54JVU</span><br></pre></td></tr></table></figure>

<p><em><strong>此时卷组中只剩下不足1G容量需要增加物理卷才能满足需求</strong></em>  </p>
<p>2.对vg0增加物理卷，将刚才未加入卷组的sdd加入卷组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 test2]<span class="comment"># vgextend vg0 /dev/sdd</span></span><br><span class="line">  Volume group <span class="string">&quot;vg0&quot;</span> successfully extended</span><br><span class="line"><span class="comment">#查看卷组情况，此时已经有10.99G空闲</span></span><br><span class="line">[root@centos7 test2]<span class="comment"># vgs</span></span><br><span class="line">  VG  <span class="comment">#PV #LV #SN Attr   VSize   VFree  </span></span><br><span class="line">  vg0   3   2   0 wz--n- &lt;19.99g &lt;10.99g</span><br></pre></td></tr></table></figure>

<p>3.对ext文件系统的逻辑卷test1进行扩容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 test2]<span class="comment"># lvextend -r -L +1G /dev/vg0/test1</span></span><br><span class="line">  Size of logical volume vg0/test1 changed from 6.00 GiB (1536 extents) to 7.00 GiB (1792 extents).</span><br><span class="line">  Logical volume vg0/test1 successfully resized.</span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem at /dev/mapper/vg0-test1 is mounted on /data/test1; on-line resizing required</span><br><span class="line">old_desc_blocks = 1, new_desc_blocks = 1</span><br><span class="line">The filesystem on /dev/mapper/vg0-test1 is now 1835008 blocks long.</span><br><span class="line"><span class="comment">#查看是否成功</span></span><br><span class="line">[root@centos7 test2]<span class="comment"># lvs</span></span><br><span class="line">  LV    VG  Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  test1 vg0 -wi-ao---- 7.00g                                                    </span><br><span class="line">  test2 vg0 -wi-ao---- 3.00g      </span><br></pre></td></tr></table></figure>

<p>4.对xfs文件系统的逻辑卷test2进行扩容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 test2]<span class="comment"># lvextend -r -L +1G /dev/vg0/test2</span></span><br><span class="line">  Size of logical volume vg0/test2 changed from 3.00 GiB (768 extents) to 4.00 GiB (1024 extents).</span><br><span class="line">  Logical volume vg0/test2 successfully resized.</span><br><span class="line">meta-data=/dev/mapper/vg0-test2  isize=512    agcount=4, agsize=196608 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=0 spinodes=0</span><br><span class="line">data     =                       bsize=4096   blocks=786432, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line"><span class="built_in">log</span>      =internal               bsize=4096   blocks=2560, version=2</span><br><span class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br><span class="line">data blocks changed from 786432 to 1048576</span><br><span class="line"><span class="comment">#查看是否扩容成空</span></span><br><span class="line">[root@centos7 test2]<span class="comment"># lvs</span></span><br><span class="line">  LV    VG  Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  test1 vg0 -wi-ao---- 7.00g                                                    </span><br><span class="line">  test2 vg0 -wi-ao---- 4.00g    </span><br></pre></td></tr></table></figure>

<p>5.查看文件系统内的文件是否丢失</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 test2]<span class="comment"># cd /data</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ls test1 test2</span></span><br><span class="line">test1:</span><br><span class="line">file1  file10  file2  file3  file4  file5  file6  file7  file8  file9  lost+found</span><br><span class="line"></span><br><span class="line">test2:</span><br><span class="line">filea  fileb  filec  filed  filee  filef  fileg  fileh  filei  filej</span><br></pre></td></tr></table></figure>

<p><em><strong>对逻辑卷做扩容可以在线操作并且不会造成数据丢失的</strong></em></p>
<h4 id="二、对逻辑卷做缩减"><a href="#二、对逻辑卷做缩减" class="headerlink" title="二、对逻辑卷做缩减"></a>二、对逻辑卷做缩减</h4><p>逻辑卷是否能缩减取决于文件系统是否支持，XFS文件系统不支持缩减，所以此处以ext4为例，将逻辑卷test1缩减至4G，<em><strong>对文件系统做缩减需要先对其内的数据做备份防止数据丢失</strong></em>  </p>
<p>1.逻辑卷缩减首先要将设备离线</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># umount /data/test1</span></span><br></pre></td></tr></table></figure>

<p>2.对逻辑卷缩减前首先先要将文件系统的空间缩减</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#缩减文件系统至4G</span></span><br><span class="line">[root@centos7 data]<span class="comment"># resize2fs /dev/vg0/test1 4G</span></span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Please run <span class="string">&#x27;e2fsck -f /dev/vg0/test1&#x27;</span> first.</span><br><span class="line"><span class="comment">#缩减文件前需要先对文件系统做检查，所以此处提示先对文件系统做检查</span></span><br><span class="line">[root@centos7 data]<span class="comment"># e2fsck -f /dev/vg0/test1</span></span><br><span class="line">e2fsck 1.42.9 (28-Dec-2013)</span><br><span class="line">Pass 1: Checking inodes, blocks, and sizes</span><br><span class="line">Pass 2: Checking directory structure</span><br><span class="line">Pass 3: Checking directory connectivity</span><br><span class="line">Pass 4: Checking reference counts</span><br><span class="line">Pass 5: Checking group summary information</span><br><span class="line">test1: 21/458752 files (0.0% non-contiguous), 68479/1835008 blocks</span><br><span class="line">[root@centos7 data]<span class="comment"># resize2fs /dev/vg0/test1 4G</span></span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Resizing the filesystem on /dev/vg0/test1 to 1048576 (4k) blocks.</span><br><span class="line">The filesystem on /dev/vg0/test1 is now 1048576 blocks long.</span><br><span class="line"><span class="comment">#缩减成功</span></span><br></pre></td></tr></table></figure>

<p>3.对逻辑卷进行缩减</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># lvreduce -L 4G /dev/vg0/test1 </span></span><br><span class="line">  WARNING: Reducing active logical volume to 4.00 GiB.</span><br><span class="line">  THIS MAY DESTROY YOUR DATA (filesystem etc.)</span><br><span class="line">Do you really want to reduce vg0/test1? [y/n]: y</span><br><span class="line">  Size of logical volume vg0/test1 changed from 7.00 GiB (1792 extents) to 4.00 GiB (1024 extents).</span><br><span class="line">  Logical volume vg0/test1 successfully resized.</span><br><span class="line"><span class="comment">#逻辑卷缩减成功</span></span><br></pre></td></tr></table></figure>

<p>4.挂载文件系统，查看内部数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># mount /dev/vg0/test1 /data/test1</span></span><br><span class="line">[root@centos7 data]<span class="comment"># findmnt /data/test1</span></span><br><span class="line">TARGET      SOURCE                FSTYPE OPTIONS</span><br><span class="line">/data/test1 /dev/mapper/vg0-test1 ext4   rw,relatime,data=ordered</span><br><span class="line">[root@centos7 data]<span class="comment"># cd test1</span></span><br><span class="line">[root@centos7 test1]<span class="comment"># ls</span></span><br><span class="line">file1  file10  file2  file3  file4  file5  file6  file7  file8  file9  lost+found</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux基础命令</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/Linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/Linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h2 id="Linux基础命令"><a href="#Linux基础命令" class="headerlink" title="Linux基础命令"></a>Linux基础命令</h2><span id="more"></span>

<h3 id="1-alias-命令别名"><a href="#1-alias-命令别名" class="headerlink" title="1. alias 命令别名"></a>1. alias 命令别名</h3><p>命令格式：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">alias</span> [-p] [name[=value] ...]</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># alias cdnet=&#x27;cd /etc/sysconfig/network-scripts/&#x27;</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cdnet</span></span><br><span class="line">[root@centos7 network-scripts]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>注意：alias命令所定义的别名只在当先shell环境内有效，退出后就会自动失效，若要使别名永久有效需要将其写入用户家目录下的.bashrc或者/etc/bashrc（此文件对全局有效不推荐）文件中。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim .bashrc </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User specific aliases and functions</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> rm=<span class="string">&#x27;rm -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> cp=<span class="string">&#x27;cp -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> mv=<span class="string">&#x27;mv -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> cdnet=<span class="string">&#x27;cd /etc/sysconfig/network-scripts/&#x27;</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">        . /etc/bashrc</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>注意：取消别名方法unalias COMMAND</p>
<h3 id="2-bc-计算器"><a href="#2-bc-计算器" class="headerlink" title="2. bc 计算器"></a>2. bc 计算器</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bc [ -hlwsqv ] [long-options] [  file ... ]</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># bc</span></span><br><span class="line">bc 1.06.95</span><br><span class="line">Copyright 1991-1994, 1997, 1998, 2000, 2004, 2006 Free Software Foundation, Inc.</span><br><span class="line">This is free software with ABSOLUTELY NO WARRANTY.</span><br><span class="line">For details <span class="built_in">type</span> `warranty<span class="string">&#x27;. </span></span><br><span class="line"><span class="string">1+2                 输入需要计算的数字</span></span><br><span class="line"><span class="string">3                   显示结果</span></span><br><span class="line"><span class="string">obase=2             输出2进制，做2进制转换</span></span><br><span class="line"><span class="string">10                  </span></span><br><span class="line"><span class="string">1010                </span></span><br><span class="line"><span class="string">obase=16            输出16进制</span></span><br><span class="line"><span class="string">ibase=10            输入10进制</span></span><br><span class="line"><span class="string">16</span></span><br><span class="line"><span class="string">10</span></span><br><span class="line"><span class="string">^C                  ctrl+c退出bc计算器</span></span><br><span class="line"><span class="string">(interrupt) Exiting bc.</span></span><br></pre></td></tr></table></figure>

<h3 id="3-cal-显示当前月份"><a href="#3-cal-显示当前月份" class="headerlink" title="3. cal 显示当前月份"></a>3. cal 显示当前月份</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cal [options] [[[day] month] year</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cal           不带参数显示当前月</span></span><br><span class="line">     March 2019     </span><br><span class="line">Su Mo Tu We Th Fr Sa</span><br><span class="line">                1  2</span><br><span class="line"> 3  4  5  6  7  8  9</span><br><span class="line">10 11 12 13 14 15 16</span><br><span class="line">17 18 19 20 21 22 23</span><br><span class="line">24 25 26 27 28 29 30</span><br><span class="line">31</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cal 2019       带年份显示全年月份</span></span><br><span class="line">                               2019                               </span><br><span class="line"></span><br><span class="line">       January               February                 March       </span><br><span class="line">Su Mo Tu We Th Fr Sa   Su Mo Tu We Th Fr Sa   Su Mo Tu We Th Fr Sa</span><br><span class="line">       1  2  3  4  5                   1  2                   1  2</span><br><span class="line"> 6  7  8  9 10 11 12    3  4  5  6  7  8  9    3  4  5  6  7  8  9</span><br><span class="line">13 14 15 16 17 18 19   10 11 12 13 14 15 16   10 11 12 13 14 15 16</span><br><span class="line">20 21 22 23 24 25 26   17 18 19 20 21 22 23   17 18 19 20 21 22 23</span><br><span class="line">27 28 29 30 31         24 25 26 27 28         24 25 26 27 28 29 30</span><br><span class="line">                                              31</span><br><span class="line">        April                   May                   June        </span><br><span class="line">Su Mo Tu We Th Fr Sa   Su Mo Tu We Th Fr Sa   Su Mo Tu We Th Fr Sa</span><br><span class="line">    1  2  3  4  5  6             1  2  3  4                      1</span><br><span class="line"> 7  8  9 10 11 12 13    5  6  7  8  9 10 11    2  3  4  5  6  7  8</span><br><span class="line">14 15 16 17 18 19 20   12 13 14 15 16 17 18    9 10 11 12 13 14 15</span><br><span class="line">21 22 23 24 25 26 27   19 20 21 22 23 24 25   16 17 18 19 20 21 22</span><br><span class="line">28 29 30               26 27 28 29 30 31      23 24 25 26 27 28 29</span><br><span class="line">                                              30</span><br><span class="line">        July                  August                September     </span><br><span class="line">Su Mo Tu We Th Fr Sa   Su Mo Tu We Th Fr Sa   Su Mo Tu We Th Fr Sa</span><br><span class="line">    1  2  3  4  5  6                1  2  3    1  2  3  4  5  6  7</span><br><span class="line"> 7  8  9 10 11 12 13    4  5  6  7  8  9 10    8  9 10 11 12 13 14</span><br><span class="line">14 15 16 17 18 19 20   11 12 13 14 15 16 17   15 16 17 18 19 20 21</span><br><span class="line">21 22 23 24 25 26 27   18 19 20 21 22 23 24   22 23 24 25 26 27 28</span><br><span class="line">28 29 30 31            25 26 27 28 29 30 31   29 30</span><br><span class="line"></span><br><span class="line">       October               November               December      </span><br><span class="line">Su Mo Tu We Th Fr Sa   Su Mo Tu We Th Fr Sa   Su Mo Tu We Th Fr Sa</span><br><span class="line">       1  2  3  4  5                   1  2    1  2  3  4  5  6  7</span><br><span class="line"> 6  7  8  9 10 11 12    3  4  5  6  7  8  9    8  9 10 11 12 13 14</span><br><span class="line">13 14 15 16 17 18 19   10 11 12 13 14 15 16   15 16 17 18 19 20 21</span><br><span class="line">20 21 22 23 24 25 26   17 18 19 20 21 22 23   22 23 24 25 26 27 28</span><br><span class="line">27 28 29 30 31         24 25 26 27 28 29 30   29 30 31</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cal 5 2019        显示指定年月</span></span><br><span class="line">      May 2019      </span><br><span class="line">Su Mo Tu We Th Fr Sa</span><br><span class="line">          1  2  3  4</span><br><span class="line"> 5  6  7  8  9 10 11</span><br><span class="line">12 13 14 15 16 17 18</span><br><span class="line">19 20 21 22 23 24 25</span><br><span class="line">26 27 28 29 30 31</span><br></pre></td></tr></table></figure>

<h3 id="4-clock-显示硬件时间同hwclock"><a href="#4-clock-显示硬件时间同hwclock" class="headerlink" title="4. clock 显示硬件时间同hwclock"></a>4. clock 显示硬件时间同hwclock</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hwclock [<span class="keyword">function</span>] [option...]  </span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-s</td>
<td align="left">以硬件时间为准修改系统时间</td>
</tr>
<tr>
<td align="left">-w</td>
<td align="left">以系统时间为准修改硬件时间</td>
</tr>
</tbody></table>
<p>示例：  </p>
<p>以硬件时间为准修改系统时间</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># date</span></span><br><span class="line">Tue Mar  5 14:30:30 CST 2019</span><br><span class="line">[root@centos7 ~]<span class="comment"># clock</span></span><br><span class="line">Fri 08 Mar 2019 02:33:42 PM CST  -0.758330 seconds</span><br><span class="line">[root@centos7 ~]<span class="comment"># clock -s</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># date</span></span><br><span class="line">Fri Mar  8 14:34:04 CST 2019</span><br></pre></td></tr></table></figure>

<p>以系统时间为准修改硬件时间</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># date &quot;030212102019.20&quot;</span></span><br><span class="line">Sat Mar  2 12:10:20 CST 2019</span><br><span class="line">[root@centos7 ~]<span class="comment"># clock -w</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># clock</span></span><br><span class="line">Sat 02 Mar 2019 12:10:55 PM CST  -0.678871 seconds</span><br></pre></td></tr></table></figure>

<h3 id="5-date-系统时间"><a href="#5-date-系统时间" class="headerlink" title="5. date 系统时间"></a>5. date 系统时间</h3><p>命令格式：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">date [OPTION]... [+FORMAT]</span><br><span class="line">date [-u|--utc|--universal] [MMDDhhmm[[CC]YY][.ss]]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-d</td>
<td align="left">显示指定的日期</td>
</tr>
<tr>
<td align="left">-s</td>
<td align="left">设置系统时间</td>
</tr>
<tr>
<td align="left">%F</td>
<td align="left">显示格式为 年-月-日</td>
</tr>
<tr>
<td align="left">%T</td>
<td align="left">显示格式为 小时:分钟:秒</td>
</tr>
<tr>
<td align="left">%H</td>
<td align="left">显示小时0-24</td>
</tr>
<tr>
<td align="left">%M</td>
<td align="left">显示分钟0-60</td>
</tr>
<tr>
<td align="left">%S</td>
<td align="left">显示秒0-60</td>
</tr>
<tr>
<td align="left">%m</td>
<td align="left">显示月份1-12</td>
</tr>
<tr>
<td align="left">%y</td>
<td align="left">显示两位年份</td>
</tr>
<tr>
<td align="left">%Y</td>
<td align="left">显示四位年份</td>
</tr>
<tr>
<td align="left">%D</td>
<td align="left">显示时间为 日/月/年</td>
</tr>
<tr>
<td align="left">%s</td>
<td align="left">显示从1970年1月1日至今的秒数</td>
</tr>
</tbody></table>
<p>示例：    </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># date +&quot;%Y-%m-%d %H:%M:%S&quot;     分别用参数显示</span></span><br><span class="line">2019-03-02 12:41:58</span><br><span class="line">[root@centos7 ~]<span class="comment"># date +&quot;%F %T&quot;                 用%F和%T显示</span></span><br><span class="line">2019-03-02 12:44:11</span><br><span class="line">[root@centos7 ~]<span class="comment"># date -s &quot;2019-03-08 15:19:20&quot;</span></span><br><span class="line">Fri Mar  8 15:19:20 CST 2019</span><br></pre></td></tr></table></figure>

<h3 id="6-cat-查看文本文件内容"><a href="#6-cat-查看文本文件内容" class="headerlink" title="6. cat 查看文本文件内容"></a>6. cat 查看文本文件内容</h3><p>命令格式：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat [OPTION]... [FILE]...</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/issue</span></span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br><span class="line">on  \l</span><br><span class="line">hostname is \n</span><br><span class="line">time9 is \t</span><br></pre></td></tr></table></figure>

<h3 id="7-enable-启用和禁用内部命令"><a href="#7-enable-启用和禁用内部命令" class="headerlink" title="7. enable 启用和禁用内部命令"></a>7. enable 启用和禁用内部命令</h3><p>命令格式： </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">enable</span> [-a] [-dnps] [-f filename] [name ...]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-n command</td>
<td align="left">禁用内部命令</td>
</tr>
<tr>
<td align="left">command</td>
<td align="left">启用内部命令</td>
</tr>
<tr>
<td align="left">-n</td>
<td align="left">查看所有禁用命令</td>
</tr>
</tbody></table>
<p>示例：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># enable -n type        禁用type</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># type ytpe             type命令已经无法使用</span></span><br><span class="line">bash: <span class="built_in">type</span>: <span class="built_in">command</span> not found...</span><br><span class="line">[root@centos7 ~]<span class="comment"># enable -n             查看被禁用的命令</span></span><br><span class="line"><span class="built_in">enable</span> -n <span class="built_in">type</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># enable type           启用type</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># type type</span></span><br><span class="line"><span class="built_in">type</span> is a shell <span class="built_in">builtin</span></span><br></pre></td></tr></table></figure>

<h3 id="8-echo-回显命令"><a href="#8-echo-回显命令" class="headerlink" title="8. echo 回显命令"></a>8. echo 回显命令</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> [SHORT-OPTION]... [STRING]...</span><br><span class="line"><span class="built_in">echo</span> LONG-OPTION</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-n</td>
<td align="left">不自动换行</td>
</tr>
<tr>
<td align="left">-e</td>
<td align="left">对字符进行转义</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo -n &quot;hello world&quot;         回显后不换行</span></span><br><span class="line">hello world[root@centos7 ~]<span class="comment"># </span></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo -e &quot;hello\tworld&quot;        将\t进行转义</span></span><br><span class="line">hello	world</span><br></pre></td></tr></table></figure>

<h3 id="9-hash-显示hash缓存"><a href="#9-hash-显示hash缓存" class="headerlink" title="9. hash 显示hash缓存"></a>9. hash 显示hash缓存</h3><p>命令格式： </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">hash</span> [-lr] [-p filename] [-dt] [name]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">–l</td>
<td align="left">显示hash缓存，可作为输入使用</td>
</tr>
<tr>
<td align="left">–p path name</td>
<td align="left">将命令全路径path起别名为name</td>
</tr>
<tr>
<td align="left">–t name</td>
<td align="left">打印缓存中name的路径</td>
</tr>
<tr>
<td align="left">–d name</td>
<td align="left">清除name缓存</td>
</tr>
<tr>
<td align="left">–r</td>
<td align="left">清除缓存</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># hash -l                       显示hash缓存</span></span><br><span class="line"><span class="built_in">builtin</span> <span class="built_in">hash</span> -p /usr/bin/cat cat</span><br><span class="line"><span class="built_in">builtin</span> <span class="built_in">hash</span> -p /usr/bin/date date</span><br><span class="line"><span class="built_in">builtin</span> <span class="built_in">hash</span> -p /usr/bin/man man</span><br><span class="line"><span class="built_in">builtin</span> <span class="built_in">hash</span> -p /usr/bin/<span class="built_in">cd</span> <span class="built_in">cd</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># hash -p /usr/bin/cd cd1       将cd1定义成cd的别名</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd1 /</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /boot</span></span><br><span class="line">[root@centos7 boot]<span class="comment"># </span></span><br><span class="line"></span><br><span class="line">[root@centos7 boot]<span class="comment"># hash -t cd                 打印哈希表中的cd路径</span></span><br><span class="line">/usr/bin/<span class="built_in">cd</span></span><br><span class="line"></span><br><span class="line">[root@centos7 boot]<span class="comment"># hash                       </span></span><br><span class="line">hits	<span class="built_in">command</span></span><br><span class="line">   2	/usr/bin/cat</span><br><span class="line">  10	/usr/bin/date</span><br><span class="line">   4	/usr/bin/man</span><br><span class="line">   1	/usr/bin/<span class="built_in">cd</span></span><br><span class="line">   3	/usr/bin/ls</span><br><span class="line">   2	/usr/bin/<span class="built_in">cd</span></span><br><span class="line">[root@centos7 boot]<span class="comment"># hash -d ls                 删除哈希表中的ls命令</span></span><br><span class="line">[root@centos7 boot]<span class="comment"># hash</span></span><br><span class="line">hits	<span class="built_in">command</span></span><br><span class="line">   2	/usr/bin/cat</span><br><span class="line">  10	/usr/bin/date</span><br><span class="line">   4	/usr/bin/man</span><br><span class="line">   1	/usr/bin/<span class="built_in">cd</span></span><br><span class="line">   2	/usr/bin/<span class="built_in">cd</span></span><br><span class="line"></span><br><span class="line">[root@centos7 boot]<span class="comment"># hash -r                    清空哈希表</span></span><br><span class="line">[root@centos7 boot]<span class="comment"># hash</span></span><br><span class="line"><span class="built_in">hash</span>: <span class="built_in">hash</span> table empty</span><br></pre></td></tr></table></figure>

<p>注意：系统初始hash表为空，当外部命令执行时，默认会从PATH路径下寻找该命令，找到后会将这条命令的路径记录到hash表中，当再次使用该命令时，shell解释器首先会查看hash表，存在将执行之，如果不存在，将会去PATH路径下寻找，利用hash缓存表可大大提高命令的调用速率</p>
<h3 id="10-hostname-显示当前主机名"><a href="#10-hostname-显示当前主机名" class="headerlink" title="10. hostname 显示当前主机名"></a>10. hostname 显示当前主机名</h3><p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 boot]<span class="comment"># hostname</span></span><br><span class="line">centos7.localdomain</span><br></pre></td></tr></table></figure>

<h3 id="11-id-显示用户id号"><a href="#11-id-显示用户id号" class="headerlink" title="11. id 显示用户id号"></a>11. id 显示用户id号</h3><p>命令格式：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">id [OPTION]... [USER]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-u</td>
<td align="left">显示用户uid</td>
</tr>
<tr>
<td align="left">-g</td>
<td align="left">显示用户gid</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># id -u root            显示用户id</span></span><br><span class="line">0</span><br><span class="line">[root@centos7 ~]<span class="comment"># id -g root            显示用用户组id</span></span><br><span class="line">0</span><br><span class="line">[root@centos7 ~]<span class="comment"># id root               显示用户所有id号信息</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="12-ifconfig-查看网络信息"><a href="#12-ifconfig-查看网络信息" class="headerlink" title="12. ifconfig 查看网络信息"></a>12. ifconfig 查看网络信息</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ifconfig [-v] [-a] [-s] [interface]</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ifconfig ens33    </span></span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.172.133  netmask 255.255.255.0  broadcast 192.168.172.255</span><br><span class="line">        inet6 fe80::e15f:40c5:2115:bc3c  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:63:21:a6  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 7540  bytes 619380 (604.8 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 4780  bytes 647319 (632.1 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>

<h3 id="13-shutdown-关机"><a href="#13-shutdown-关机" class="headerlink" title="13. shutdown 关机"></a>13. shutdown 关机</h3><p>命令格式：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shutdown [OPTIONS...] [TIME] [WALL...]</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>关机、重启、断电</p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-H</td>
<td align="left">断电</td>
</tr>
<tr>
<td align="left">-P</td>
<td align="left">关机</td>
</tr>
<tr>
<td align="left">-r</td>
<td align="left">重启</td>
</tr>
<tr>
<td align="left">-K</td>
<td align="left">不关机、重启、或断电仅发送消息</td>
</tr>
<tr>
<td align="left">-c</td>
<td align="left">取消</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># shutdown -H 5 &quot;5分钟后断电&quot;</span></span><br><span class="line">Shutdown scheduled <span class="keyword">for</span> Sat 2019-03-09 20:15:21 CST, use <span class="string">&#x27;shutdown -c&#x27;</span> to cancel.</span><br><span class="line">[root@centos7 data]<span class="comment">#</span></span><br><span class="line">Broadcast message from root@centos7.localdomain (Sat 2019-03-09 20:10:21 CST):</span><br><span class="line"></span><br><span class="line">5分钟后断电</span><br><span class="line">The system is going down <span class="keyword">for</span> system halt at Sat 2019-03-09 20:15:21 CST!</span><br><span class="line"></span><br><span class="line">[root@centos7 data]<span class="comment"># shutdown -c</span></span><br><span class="line">[root@centos7 data]<span class="comment">#</span></span><br><span class="line">Broadcast message from root@centos7.localdomain (Sat 2019-03-09 20:10:55 CST):</span><br><span class="line"></span><br><span class="line">The system shutdown has been cancelled at Sat 2019-03-09 20:11:55 CST!</span><br></pre></td></tr></table></figure>

<h3 id="14-screen"><a href="#14-screen" class="headerlink" title="14. screen"></a>14. screen</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">screen [ -options ] [ cmd [ args ] ]</span><br><span class="line">screen -r [[pid.]tty[.host]]</span><br><span class="line">screen -r sessionowner/[[pid.]tty[.host]]</span><br></pre></td></tr></table></figure>

<p>说明：  </p>
<p>开启一个终端</p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-S</td>
<td align="left">创建一个会话</td>
</tr>
<tr>
<td align="left">-X</td>
<td align="left">加入会话</td>
</tr>
<tr>
<td align="left">-ls</td>
<td align="left">查看当前开启的会话</td>
</tr>
<tr>
<td align="left">-r</td>
<td align="left">返回暂离的会话</td>
</tr>
</tbody></table>
<p>示例：  </p>
<p>创建一个help的会话</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># screen -S help</span></span><br></pre></td></tr></table></figure>

<p>显示已创建的会话</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># screen -ls</span></span><br><span class="line">There is a screen on:</span><br><span class="line">        55725.help      (Attached)</span><br><span class="line">1 Socket <span class="keyword">in</span> /var/run/screen/S-root.</span><br></pre></td></tr></table></figure>

<p>暂离会话  </p>
<p>按ctrl+a,d</p>
<p>返回help会话</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># screen -r help</span></span><br></pre></td></tr></table></figure>

<h3 id="15-timedatectl-时区设置"><a href="#15-timedatectl-时区设置" class="headerlink" title="15. timedatectl 时区设置"></a>15. timedatectl 时区设置</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">timedatectl [OPTIONS...] &#123;COMMAND&#125;</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>查看设置修改时区</p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">status</td>
<td align="left">状态</td>
</tr>
<tr>
<td align="left">set-timezone</td>
<td align="left">设置时区</td>
</tr>
<tr>
<td align="left">list-timezone</td>
<td align="left">显示所有时区</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>显示时区</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># timedatectl status</span></span><br><span class="line">      Local time: Sat 2019-03-09 21:10:04 CST</span><br><span class="line">  Universal time: Sat 2019-03-09 13:10:04 UTC</span><br><span class="line">        RTC time: Sun 2019-03-03 10:37:44</span><br><span class="line">       Time zone: Asia/Shanghai (CST, +0800)</span><br><span class="line">     NTP enabled: no</span><br><span class="line">NTP synchronized: no</span><br><span class="line"> RTC <span class="keyword">in</span> <span class="built_in">local</span> TZ: no</span><br><span class="line">      DST active: n/a</span><br></pre></td></tr></table></figure>

<p>显示所有时区</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># timedatectl list-timezones </span></span><br><span class="line">Africa/Abidjan</span><br><span class="line">Africa/Accra</span><br><span class="line">Africa/Addis_Ababa</span><br><span class="line">Africa/Algiers</span><br><span class="line">Africa/Asmara</span><br><span class="line">Africa/Bamako</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>设置时区</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># timedatectl set-timezone Africa/Abidjan</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># timedatectl status </span></span><br><span class="line">      Local time: Sat 2019-03-09 13:13:53 GMT</span><br><span class="line">  Universal time: Sat 2019-03-09 13:13:53 UTC</span><br><span class="line">        RTC time: Sun 2019-03-03 10:41:33</span><br><span class="line">       Time zone: Africa/Abidjan (GMT, +0000)</span><br><span class="line">     NTP enabled: no</span><br><span class="line">NTP synchronized: no</span><br><span class="line"> RTC <span class="keyword">in</span> <span class="built_in">local</span> TZ: no</span><br><span class="line">      DST active: n/a</span><br></pre></td></tr></table></figure>

<h3 id="16-touch-创建空文件"><a href="#16-touch-创建空文件" class="headerlink" title="16. touch 创建空文件"></a>16. touch 创建空文件</h3><p>命令格式：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">touch [OPTION]... FILE...</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>创建空文件</p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-a</td>
<td align="left">仅改变atime和ctime</td>
</tr>
<tr>
<td align="left">-m</td>
<td align="left">仅改变mtime和ctime</td>
</tr>
<tr>
<td align="left">-t [[CC]YY]MMDDhhmm[.ss]</td>
<td align="left">指定atime和mtime的时间戳</td>
</tr>
<tr>
<td align="left">-c</td>
<td align="left">如果文件不存在，则不予创建</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>改变atime和ctime</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># stat passwd</span></span><br><span class="line">  File: ‘passwd’</span><br><span class="line">  Size: 2265      	Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 803h/2051d	Inode: 1051        Links: 2</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2019-03-09 05:32:01.845537779 +0000</span><br><span class="line">Modify: 2019-03-09 05:32:01.845537779 +0000</span><br><span class="line">Change: 2019-03-09 11:43:48.513061240 +0000</span><br><span class="line"> Birth: -</span><br><span class="line">[root@centos7 data]<span class="comment"># touch -a passwd</span></span><br><span class="line">[root@centos7 data]<span class="comment"># stat passwd</span></span><br><span class="line">  File: ‘passwd’</span><br><span class="line">  Size: 2265      	Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 803h/2051d	Inode: 1051        Links: 2</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2019-03-09 13:34:38.486974628 +0000</span><br><span class="line">Modify: 2019-03-09 05:32:01.845537779 +0000</span><br><span class="line">Change: 2019-03-09 13:34:38.486974628 +0000</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure>

<p>改变mtime和ctime</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># touch -m passwd</span></span><br><span class="line">[root@centos7 data]<span class="comment"># stat passwd</span></span><br><span class="line">  File: ‘passwd’</span><br><span class="line">  Size: 2265      	Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 803h/2051d	Inode: 1051        Links: 2</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2019-03-09 13:34:38.486974628 +0000</span><br><span class="line">Modify: 2019-03-09 13:37:00.490969902 +0000</span><br><span class="line">Change: 2019-03-09 13:37:00.490969902 +0000</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure>

<p>修改atime和mtime</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># stat passwd</span></span><br><span class="line">  File: ‘passwd’</span><br><span class="line">  Size: 2265      	Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 803h/2051d	Inode: 1051        Links: 2</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2019-01-01 10:10:00.000000000 +0000</span><br><span class="line">Modify: 2019-01-01 10:10:00.000000000 +0000</span><br><span class="line">Change: 2019-03-09 13:38:54.820966097 +0000</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure>

<h3 id="17-type"><a href="#17-type" class="headerlink" title="17.type"></a>17.type</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">type</span> COMMAND</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>查看命令是内部或外部命令</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># type man</span></span><br><span class="line">man is hashed (/usr/bin/man)</span><br><span class="line">[root@centos7 data]<span class="comment"># type type</span></span><br><span class="line"><span class="built_in">type</span> is a shell <span class="built_in">builtin</span></span><br></pre></td></tr></table></figure>

<h3 id="18-tty"><a href="#18-tty" class="headerlink" title="18.tty"></a>18.tty</h3><p>命令格式：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tty [OPTION]...</span><br></pre></td></tr></table></figure>

<p>打印当前终端名称</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># tty</span></span><br><span class="line">/dev/pts/1</span><br></pre></td></tr></table></figure>

<h3 id="19-uname"><a href="#19-uname" class="headerlink" title="19.uname"></a>19.uname</h3><p>命令格式： </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">uname [OPTION]...</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>显示系统信息</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-a</td>
<td>显示所有信息</td>
</tr>
<tr>
<td>-r</td>
<td>显示内核信息</td>
</tr>
<tr>
<td></td>
<td>显示所有信息</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># uname -a</span></span><br><span class="line">Linux centos7.localdomain 3.10.0-957.el7.x86_64 <span class="comment">#1 SMP Thu Nov 8 23:39:32 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">[root@centos7 data]<span class="comment"># uname -r</span></span><br><span class="line">3.10.0-957.el7.x86_64</span><br></pre></td></tr></table></figure>

<h3 id="20-who"><a href="#20-who" class="headerlink" title="20.who"></a>20.who</h3><p>命令格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">who [OPTION]... [ FILE | ARG1 ARG2 ]</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>查看有哪些用户登录  </p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># who</span></span><br><span class="line">root     tty1         2019-03-08 05:08</span><br><span class="line">root     pts/0        2019-03-09 11:42 (192.168.1.188)</span><br><span class="line">root     pts/1        2019-03-09 12:54 (192.168.172.1)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="21-w"><a href="#21-w" class="headerlink" title="21.w"></a>21.w</h3><p>命令格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">w [options] user [...]</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>显示当前有哪些用户登录并且在干什么</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># w</span></span><br><span class="line"> 14:07:04 up 19:45,  3 users,  load average: 0.00, 0.01, 0.05</span><br><span class="line">USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT</span><br><span class="line">root     tty1                      Fri05    2:25m  1.62s  1.62s -bash</span><br><span class="line">root     pts/0    192.168.1.188    11:42    1:56m  0.13s  0.13s -bash</span><br><span class="line">root     pts/1    192.168.172.1    12:54    0.00s  0.25s  0.01s w</span><br></pre></td></tr></table></figure>

<h3 id="22-which"><a href="#22-which" class="headerlink" title="22.which"></a>22.which</h3><p>命令格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">which [options] [--] programname [...]</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>查看命令全路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># which man</span></span><br><span class="line">/usr/bin/man</span><br></pre></td></tr></table></figure>

<h3 id="23-whereis"><a href="#23-whereis" class="headerlink" title="23.whereis"></a>23.whereis</h3><p>命令格式：  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whereis [options] [-BMS directory... -f] name...</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>查看二级制程序路径和帮助手册</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># whereis who</span></span><br><span class="line">who: /usr/bin/who /usr/share/man/man1/who.1.gz /usr/share/man/man1p/who.1p.gz</span><br></pre></td></tr></table></figure>

<h3 id="24-whoami"><a href="#24-whoami" class="headerlink" title="24.whoami"></a>24.whoami</h3><p>命令格式: </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whoami [OPTION]...</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>打印当前用户名</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># whoami</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux帮助获取</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/Linux%E5%B8%AE%E5%8A%A9%E8%8E%B7%E5%8F%96/Linux%E5%B8%AE%E5%8A%A9%E8%8E%B7%E5%8F%96/</url>
    <content><![CDATA[<p>Linxu帮助获取方法有许多种类,在获取帮助信息时，内部命令和外部命令的获取方式是有区别的：  </p>
<span id="more"></span>

<p>内部命令：  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">help COMMAND</span><br></pre></td></tr></table></figure>

<p>外部命令：有以下几种途径  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 通过命令自带的帮助信息  </span><br><span class="line">   COMMAND --<span class="built_in">help</span>  </span><br><span class="line">   COMMAND -h</span><br><span class="line">2. 使用手册(manual)  </span><br><span class="line">   man COMMAND</span><br><span class="line">3. 信息页</span><br><span class="line">   info COMMAND 支持信息页中的超链接。</span><br><span class="line">4. 程序自身的帮助文档，有README、INSTALL、Changelog等。  </span><br><span class="line">   此类文档目录：/usr/share/doc</span><br><span class="line">5. 程序的官方文档</span><br><span class="line">6. 发行版官方文档</span><br><span class="line">7. google</span><br></pre></td></tr></table></figure>

<h3 id="man命令的使用方法"><a href="#man命令的使用方法" class="headerlink" title="man命令的使用方法"></a><em><strong>man命令的使用方法</strong></em></h3><p>命令格式：  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">man [章节] COMMAND  </span><br></pre></td></tr></table></figure>

<p>章节共有9个每个章节代表不同的内容  </p>
<table>
<thead>
<tr>
<th align="center">章节号</th>
<th align="left">内容</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="left">用户命令（使用者在shell环境中可以操作的指令）</td>
</tr>
<tr>
<td align="center">2</td>
<td align="left">系统调用（系统核心可以调用的函数和工具）</td>
</tr>
<tr>
<td align="center">3</td>
<td align="left">c库调用（常用的函数和函数库）</td>
</tr>
<tr>
<td align="center">4</td>
<td align="left">设备文件及特殊文件</td>
</tr>
<tr>
<td align="center">5</td>
<td align="left">配置文件格式</td>
</tr>
<tr>
<td align="center">6</td>
<td align="left">游戏</td>
</tr>
<tr>
<td align="center">7</td>
<td align="left">杂项</td>
</tr>
<tr>
<td align="center">8</td>
<td align="left">管理类的命令</td>
</tr>
<tr>
<td align="center">9</td>
<td align="left">Linux内核API</td>
</tr>
</tbody></table>
<p>man的内容分成几个部分   </p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">说名</th>
</tr>
</thead>
<tbody><tr>
<td align="left">NAME</td>
<td align="left">简单的指令名称及说明</td>
</tr>
<tr>
<td align="left">SYNOPSIS</td>
<td align="left">指令的语法</td>
</tr>
<tr>
<td align="left">DESCRIPTION</td>
<td align="left">指令的完整说明</td>
</tr>
<tr>
<td align="left">OPTIONS</td>
<td align="left">指令的相关选项及说明</td>
</tr>
<tr>
<td align="left">COMMANDS</td>
<td align="left">程序在执行时可下达的指令</td>
</tr>
<tr>
<td align="left">FILES</td>
<td align="left">这个程序资料可以参考的其他档案</td>
</tr>
<tr>
<td align="left">SEE ALSO</td>
<td align="left">一些可以参考的和指令相关的其他内容</td>
</tr>
<tr>
<td align="left">EXAMPLE</td>
<td align="left">一些可以参考的范例</td>
</tr>
</tbody></table>
<p>man命令的一些简单操作方法  </p>
<table>
<thead>
<tr>
<th align="left">按键</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">空格</td>
<td align="left">向文件尾部翻一屏</td>
</tr>
<tr>
<td align="left">b</td>
<td align="left">向文件首部翻一屏</td>
</tr>
<tr>
<td align="left">d</td>
<td align="left">向文件尾部翻半屏</td>
</tr>
<tr>
<td align="left">u</td>
<td align="left">向文件首部翻半屏</td>
</tr>
<tr>
<td align="left">j</td>
<td align="left">向文件尾部翻一行</td>
</tr>
<tr>
<td align="left">k</td>
<td align="left">向文件首部翻一行</td>
</tr>
<tr>
<td align="left">q</td>
<td align="left">退出</td>
</tr>
<tr>
<td align="left">数字#</td>
<td align="left">跳转到第#行</td>
</tr>
<tr>
<td align="left">1G</td>
<td align="left">跳转到文件首部</td>
</tr>
<tr>
<td align="left">G</td>
<td align="left">跳转到文件尾部</td>
</tr>
</tbody></table>
<p>man文件内搜索关键字的方法  </p>
<table>
<thead>
<tr>
<th align="left">按键</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">/KEYWORD</td>
<td align="left">在文档内从当前位置向尾部搜索KEYWORD关键字，并且不区分大小写</td>
</tr>
<tr>
<td align="left">?KEYWORD</td>
<td align="left">在文档内从当前位置向首部搜索KEYWORD关键字，兵器不区分大小写</td>
</tr>
<tr>
<td align="left">n</td>
<td align="left">按照与搜索关键字方向相同的方法，查找下一个关键字</td>
</tr>
<tr>
<td align="left">N</td>
<td align="left">按照与搜索关键字方向相反的方向，查找下一个关键字</td>
</tr>
</tbody></table>
<p>man命令的一些相关选项  </p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-f COMMAND</td>
<td>搜索系统中哪些与COMMAND相关的章节</td>
</tr>
<tr>
<td>-k COMMAND</td>
<td>搜索与关键字有关的帮助文件</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># man -f passwd   此命令同whatis passwd</span></span><br><span class="line">passwd (1)           - update user<span class="string">&#x27;s authentication tokens</span></span><br><span class="line"><span class="string">sslpasswd (1ssl)     - compute password hashes</span></span><br><span class="line"><span class="string">passwd (5)           - password file</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 ~]# man -k passwd    </span></span><br><span class="line"><span class="string">chpasswd (8)         - update passwords in batch mode</span></span><br><span class="line"><span class="string">fgetpwent_r (3)      - get passwd file entry reentrantly</span></span><br><span class="line"><span class="string">getpwent_r (3)       - get passwd file entry reentrantly</span></span><br><span class="line"><span class="string">gpasswd (1)          - administer /etc/group and /etc/gshadow</span></span><br><span class="line"><span class="string">grub2-mkpasswd-pbkdf2 (1) - Generate a PBKDF2 password hash.</span></span><br><span class="line"><span class="string">lpasswd (1)          - Change group or user password</span></span><br></pre></td></tr></table></figure>

<p>注意：<br>使用-k,-f选项时首先需要建立资料库才行，此时需要执行mandb(Centos7),makewhatis(makewhatis)</p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux文件的查找</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/Linux%E6%96%87%E4%BB%B6%E7%9A%84%E6%9F%A5%E6%89%BE/Linux%E6%96%87%E4%BB%B6%E7%9A%84%E6%9F%A5%E6%89%BE/</url>
    <content><![CDATA[<h2 id="Linux文件查找"><a href="#Linux文件查找" class="headerlink" title="Linux文件查找"></a>Linux文件查找</h2><p>在windows中文件的查找可以通过资源管理器进行查找，在Linux中则需要使用命令行进行查找，命令行中的查找命令有2种locate和find</p>
<span id="more"></span>

<hr>
<h3 id="locate"><a href="#locate" class="headerlink" title="locate"></a>locate</h3><p>locate 命令查找的是数据库文件并非实时查找需要updatedb更新数据库文件。</p>
<p>命令语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">locate [OPTION]... PATTERN...</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-i</td>
<td align="left">不区分大小写</td>
</tr>
<tr>
<td align="left">-n N</td>
<td align="left">只列举前N个匹配项目</td>
</tr>
<tr>
<td align="left">-r</td>
<td align="left">使用基本正则表达式</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 etc]<span class="comment"># locate -n 5 .conf</span></span><br><span class="line">/etc/GeoIP.conf</span><br><span class="line">/etc/GeoIP.conf.default</span><br><span class="line">/etc/asound.conf</span><br><span class="line">/etc/brltty.conf</span><br><span class="line">/etc/chrony.conf</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="find"><a href="#find" class="headerlink" title="find"></a>find</h3><p>find命令不同于locate是实时查找文件，通过遍历路径来查找文件</p>
<p>命令语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find [-H] [-L] [-P] [-D debugopts] [-Olevel] [path...] [expression]</span><br></pre></td></tr></table></figure>

<h4 id="常用选项类型"><a href="#常用选项类型" class="headerlink" title="常用选项类型"></a>常用选项类型</h4><ul>
<li>根据属主、属组查找：</li>
</ul>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-user USERNAME</td>
<td align="left">查找属主为指定用户(UID)的文件</td>
</tr>
<tr>
<td align="left">-group GRPNAME</td>
<td align="left">查找属组为指定组(GID)的文件</td>
</tr>
<tr>
<td align="left">-uid UserID</td>
<td align="left">查找属主为指定的UID号的文件</td>
</tr>
<tr>
<td align="left">-gid GroupID</td>
<td align="left">查找属组为指定的GID号的文件</td>
</tr>
<tr>
<td align="left">-nouser</td>
<td align="left">查找没有属主的文件</td>
</tr>
<tr>
<td align="left">-nogroup</td>
<td align="left">查找没有属组的文件</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>查找/var目录下属主为root，且属组为mail的所有文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># find /var -user root -group mail -ls</span></span><br><span class="line"> 26050    0 drwxrwxr-x   2 root     mail           31 Mar  5 21:13 /var/spool/mail</span><br></pre></td></tr></table></figure>

<ul>
<li>根据文件类型查找:</li>
</ul>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-type TYPE</td>
<td>按问文件的类型进行查找</td>
</tr>
</tbody></table>
<h4 id="文件类型："><a href="#文件类型：" class="headerlink" title="文件类型："></a>文件类型：</h4><table>
<thead>
<tr>
<th>TYPE</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>f</td>
<td>普通文件</td>
</tr>
<tr>
<td>d</td>
<td>目录文件</td>
</tr>
<tr>
<td>l</td>
<td>符号链接文件</td>
</tr>
<tr>
<td>s</td>
<td>套接字文件</td>
</tr>
<tr>
<td>b</td>
<td>块设备文件</td>
</tr>
<tr>
<td>c</td>
<td>块设备文件</td>
</tr>
<tr>
<td>p</td>
<td>管道文件</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>显⽰/etc下的所有⽬录⽂件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find /etc -typd d</span><br><span class="line">[root@centos7 ~]<span class="comment"># find /etc -type d</span></span><br><span class="line">/etc</span><br><span class="line">/etc/fonts</span><br><span class="line">/etc/fonts/conf.d</span><br><span class="line">/etc/grub.d</span><br><span class="line">/etc/X11</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="组合条件："><a href="#组合条件：" class="headerlink" title="组合条件："></a>组合条件：</h4><table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-a</td>
<td>与</td>
</tr>
<tr>
<td>-o</td>
<td>或</td>
</tr>
<tr>
<td>-not或!</td>
<td>非</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>查找/var目录下不属于root、lp、gdm的所有文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># find /var -not \( -user root -o -user lp -o -user gdm \)</span></span><br><span class="line">/var/tmp/abrt</span><br><span class="line">/var/lib/colord</span><br><span class="line">/var/lib/colord/icc</span><br><span class="line">/var/lib/colord/mapping.db</span><br><span class="line">/var/lib/colord/storage.db</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="根据文件大小来查找："><a href="#根据文件大小来查找：" class="headerlink" title="根据文件大小来查找："></a>根据文件大小来查找：</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-size [+|-]<span class="comment">#UNIT  </span></span><br><span class="line"><span class="comment"># 常用单位：k, M, G，c（byte）  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#UNIT: (#-1, #]  </span></span><br><span class="line"><span class="comment"># 如：6k 表示(5k,6k]  </span></span><br><span class="line"></span><br><span class="line">-<span class="comment">#UNIT：[0,#-1]  </span></span><br><span class="line"><span class="comment"># 如：-6k 表示[0,5k]  </span></span><br><span class="line"></span><br><span class="line">+<span class="comment">#UNIT：(#,∞)  </span></span><br><span class="line"><span class="comment"># 如：+6k 表示(6k,∞)  </span></span><br></pre></td></tr></table></figure>

<p>示例：  </p>
<p>查找/etc目录下大于1M且类型为普通文件的所有文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># find /etc -size +1M  -type f</span></span><br><span class="line">/etc/selinux/targeted/active/policy.kern</span><br><span class="line">/etc/selinux/targeted/contexts/files/file_contexts.bin</span><br><span class="line">/etc/selinux/targeted/policy/policy.31</span><br><span class="line">/etc/udev/hwdb.bin</span><br><span class="line">/etc/brltty/zh-tw.ctb</span><br></pre></td></tr></table></figure>

<h4 id="根据时间戳："><a href="#根据时间戳：" class="headerlink" title="根据时间戳："></a>根据时间戳：</h4><p>以“天”为单位  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-atime [+|-]<span class="comment">#,  </span></span><br><span class="line"><span class="comment">#: [#,#+1)  </span></span><br><span class="line">+<span class="comment">#: [#+1,∞]  </span></span><br><span class="line">-<span class="comment">#: [0,#)  </span></span><br><span class="line">-mtime  </span><br><span class="line">-ctime </span><br></pre></td></tr></table></figure>

<p>以“分钟”为单位  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-amin  </span><br><span class="line">-mmin  </span><br><span class="line">-cmin </span><br></pre></td></tr></table></figure>

<p>示例：  </p>
<p>查找当前系统上没有属主或属组，且最近一个周内曾被访问过的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># userdel masuri</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># find / -atime -7 -nouser -nogroup</span></span><br><span class="line">find: ‘/proc/58064/task/58064/fd/5’: No such file or directory</span><br><span class="line">find: ‘/proc/58064/task/58064/fdinfo/5’: No such file or directory</span><br><span class="line">find: ‘/proc/58064/fd/6’: No such file or directory</span><br><span class="line">find: ‘/proc/58064/fdinfo/6’: No such file or directory</span><br><span class="line">/home/masuri</span><br><span class="line">/home/masuri/.mozilla</span><br><span class="line">/home/masuri/.mozilla/extensions</span><br><span class="line">/home/masuri/.mozilla/plugins</span><br></pre></td></tr></table></figure>

<h4 id="根据权限查找："><a href="#根据权限查找：" class="headerlink" title="根据权限查找："></a>根据权限查找：</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-perm [/|-]MODE  </span><br><span class="line">MODE: 精确权限匹配  </span><br><span class="line">/MODE：任何一类(u,g,o)对象的权限中只要能一位匹配即可，或关系，+从centos7开始淘汰  </span><br><span class="line">-MODE：每一类对象都必须同时拥有指定权限，与关系</span><br><span class="line"> 0 表示不关注  </span><br></pre></td></tr></table></figure>

<p>示例：  </p>
<p>查找/etc目录下所有用户都没有写权限的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># find /etc -not -perm /222 -ls</span></span><br></pre></td></tr></table></figure>

<p>查找/etc目录下至少有一类用户没有写权限的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># find /etc -not -perm -222 -ls</span></span><br></pre></td></tr></table></figure>

<p>查找/etc目录下，所有用户都有写行权限的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># find /etc -perm -222 -ls</span></span><br><span class="line">316079    0 lrwxrwxrwx   1 root     root           20 Mar  5 21:08 /etc/rc.d/rc0.d/K50netconsole -&gt; ../init.d/netconsole</span><br><span class="line">68345130    0 lrwxrwxrwx   1 root     root           17 Mar  5 21:08 /etc/rc.d/rc1.d/K90network -&gt; ../init.d/network</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>查找/etc目录下任何一类用户有写权限的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># find /etc -perm /222 -ls</span></span><br><span class="line">1100932    8 -rwxr-xr-x   1 root     root         5861 Apr 11  2018 /etc/smartmontools/smartd_warning.sh</span><br><span class="line">135846118    4 -rw-r--r--   1 root     root            1 Oct 31 01:10 /etc/at.deny</span><br><span class="line">202851786    0 drwxr-xr-x   3 root     root           24 Mar  5 21:10 /etc/kernel</span><br><span class="line">1100988    0 drwxr-xr-x   2 root     root           42 Mar  5 21:10 /etc/kernel/postinst.d</span><br><span class="line">1100989    4 -rwxr-xr-x   1 root     root         1676 Nov  3 01:40 /etc/kernel/postinst.d/51-dracut-rescue-postinst.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="处理动作"><a href="#处理动作" class="headerlink" title="处理动作"></a>处理动作</h4><table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-print</td>
<td>默认的处理动作，显示至屏幕</td>
</tr>
<tr>
<td>-ls</td>
<td>类似于对查找到的文件执行“ls -l”命令</td>
</tr>
<tr>
<td>-delete</td>
<td>删除查找到的文件</td>
</tr>
<tr>
<td>-fls file</td>
<td>查找到的所有文件的长格式信息保存至指定文件中</td>
</tr>
<tr>
<td>-ok COMMAND {} ;</td>
<td>对查找到的每个文件执行由COMMAND指定的命令，对于每个文件执行命令之前，都会交互式要求用户确认</td>
</tr>
<tr>
<td>-exec COMMAND {} ;</td>
<td>对查找到的每个文件执行由COMMAND指定的命令</td>
</tr>
<tr>
<td>{}</td>
<td>用于引用查找到的文件名称自身</td>
</tr>
</tbody></table>
<p>find传递查找到的文件至后面指定的命令时，查找到所有符合条件的文件一次性传递给后面的命令</p>
<p>示例:  </p>
<p>查看当前⽬录下30天以前.log结尾、⼤于1G的⽂件，并把它移动到/tmp下？</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find . -ctime +30 -size +1G -name <span class="string">&quot;*.log&quot;</span> -<span class="built_in">exec</span> mv &#123;&#125; /tmp \;</span><br></pre></td></tr></table></figure>

<p>参数替换xargs  </p>
<p>由于很多命令不支持管道|来传递参数，xargs用于产生某个命令的参数，xargs</p>
<p>可以读入 stdin 的数据，并且以空格符或回车符将 stdin 的数据分隔成为参数</p>
<p>许多命令不能接受过多参数，命令执行可能会失败，xargs可以解决  </p>
<p>注意：文件名或者是其他意义的名词内含有空格符的情况  </p>
<p>find和xargs的组合：find | xargs COMMAND  </p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux文件系统</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<h2 id="Linux文件系统结构"><a href="#Linux文件系统结构" class="headerlink" title="Linux文件系统结构"></a>Linux文件系统结构</h2><p>Linux的文件系统为一个单根的倒置树状结构，文件系统从根目录下开始。</p>
<p>如下图所示：</p>
<span id="more"></span>

<p><img src="2.png"></p>
<p>Linux文件系统严格区分字符大小写，abcd,Abcd,ABCD,此类文件名所指的是各不相同的文件。  </p>
<h3 id="Linux文件系统中的文件类型"><a href="#Linux文件系统中的文件类型" class="headerlink" title="Linux文件系统中的文件类型"></a>Linux文件系统中的文件类型</h3><table>
<thead>
<tr>
<th align="center">符号</th>
<th align="center">含义</th>
<th align="center">颜色</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-</td>
<td align="center">普通文件</td>
<td align="center">白色</td>
</tr>
<tr>
<td align="center">d</td>
<td align="center">目录文件</td>
<td align="center">蓝色</td>
</tr>
<tr>
<td align="center">b</td>
<td align="center">块文件</td>
<td align="center">黄色</td>
</tr>
<tr>
<td align="center">c</td>
<td align="center">字符设备</td>
<td align="center">黄色</td>
</tr>
<tr>
<td align="center">l</td>
<td align="center">符号链接文件</td>
<td align="center">浅蓝色</td>
</tr>
<tr>
<td align="center">p</td>
<td align="center">管道文件</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">s</td>
<td align="center">套接字文件</td>
<td align="center">紫色</td>
</tr>
</tbody></table>
<p>修改此类文件颜色方法：编辑/etc/DIR_COLORS  </p>
<h3 id="Linux文件系统结构-LSB-Linux-Standard-Base"><a href="#Linux文件系统结构-LSB-Linux-Standard-Base" class="headerlink" title="Linux文件系统结构(LSB Linux Standard Base)"></a>Linux文件系统结构(LSB Linux Standard Base)</h3><table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>/boot</td>
<td>用来存放内核，引导加载器的目录</td>
</tr>
<tr>
<td>/bin</td>
<td>所有用户使用的命令</td>
</tr>
<tr>
<td>/sbin</td>
<td>管理类命令存放的位置</td>
</tr>
<tr>
<td>/lib</td>
<td>存放库文件以及内核模块文件</td>
</tr>
<tr>
<td>/lib64</td>
<td>存放64位库文件</td>
</tr>
<tr>
<td>/etc</td>
<td>配置文件存放的目录</td>
</tr>
<tr>
<td>/home</td>
<td>存放普通用户家目录的位置</td>
</tr>
<tr>
<td>/root</td>
<td>管理员的家目录</td>
</tr>
<tr>
<td>/media</td>
<td>便携式设备的挂载点</td>
</tr>
<tr>
<td>/mnt</td>
<td>临时文件系统的挂载点</td>
</tr>
<tr>
<td>/dev</td>
<td>设备文件及特殊文件位置</td>
</tr>
<tr>
<td>/opt</td>
<td>第三方应用程序安装位置</td>
</tr>
<tr>
<td>/srv</td>
<td>系统上运行服务所用到的数据</td>
</tr>
<tr>
<td>/tmp</td>
<td>临时文件存放位置</td>
</tr>
<tr>
<td>/usr</td>
<td>二级根目录此目录内文件与根下大致相同</td>
</tr>
<tr>
<td>/var</td>
<td>用来存放可变的数据</td>
</tr>
<tr>
<td>/proc</td>
<td>用于输出内核与进程信息相关的虚拟文件系统</td>
</tr>
<tr>
<td>/sys</td>
<td>用于输出当前系统上硬件设备相关信息的虚拟翁建系统</td>
</tr>
<tr>
<td>/selinux</td>
<td>安全策略信息的存放位置</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 7网卡名修改</title>
    <url>/2019/03/07/Linux%E5%9F%BA%E7%A1%80/centos7%E7%BD%91%E5%8D%A1%E5%90%8D%E6%9B%B4%E6%94%B9/centos7%E7%BD%91%E5%8D%A1%E5%90%8D%E6%9B%B4%E6%94%B9/</url>
    <content><![CDATA[<h2 id="CentOS-7网卡名修改"><a href="#CentOS-7网卡名修改" class="headerlink" title="CentOS 7网卡名修改"></a>CentOS 7网卡名修改</h2><p>CentOS7网卡名与CentOS6不同，然而7的早期版本与最新的版本的网卡名又有所不同，在生产环境中，为了实现自动化管理，首先要实现全部标准化，所以要将网卡名同一设置为和CentOS6相同的ethN的格式，具体的修改方法如下：  </p>
<span id="more"></span>

<p>1.首先修改/etc/default/grub文件,在GRUB_CMDLINE_LINUX行最后添加net.ifnames=0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># vim /etc/default/grub </span></span><br><span class="line">GRUB_TIMEOUT=5</span><br><span class="line">GRUB_DISTRIBUTOR=<span class="string">&quot;<span class="subst">$(sed &#x27;s, release .*$,,g&#x27; /etc/system-release)</span>&quot;</span></span><br><span class="line">GRUB_DEFAULT=saved</span><br><span class="line">GRUB_DISABLE_SUBMENU=<span class="literal">true</span></span><br><span class="line">GRUB_TERMINAL_OUTPUT=<span class="string">&quot;console&quot;</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;crashkernel=auto rhgb quiet net.ifnames=0&quot;</span></span><br><span class="line">GRUB_DISABLE_RECOVERY=<span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<p>2.使用grub2-mkconfig命令重新生成/boot/grub2/grub.cfg文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]<span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg </span></span><br><span class="line">Generating grub configuration file ...</span><br><span class="line">Found linux image: /boot/vmlinuz-3.10.0-957.el7.x86_64</span><br><span class="line">Found initrd image: /boot/initramfs-3.10.0-957.el7.x86_64.img</span><br><span class="line">Found linux image: /boot/vmlinuz-0-rescue-30905c0f8bf344f4af5b53a826370629</span><br><span class="line">Found initrd image: /boot/initramfs-0-rescue-30905c0f8bf344f4af5b53a826370629.img</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>3.重启后主机网卡已改为传统的ethN模式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mylinuxops ~]# ifconfig</span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.172.130  netmask 255.255.255.0  broadcast 192.168.172.255</span><br><span class="line">        inet6 fe80::68e7:2a55:44f4:593  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:63:21:a6  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 4  bytes 806 (806.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 37  bytes 5389 (5.2 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>cobbler自动化安装操作系统</title>
    <url>/2019/03/10/Linux%E5%9F%BA%E7%A1%80/cobbler%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AE%89%E8%A3%85/cobbler%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<h2 id="cobbler自动安装操作系统"><a href="#cobbler自动安装操作系统" class="headerlink" title="cobbler自动安装操作系统"></a>cobbler自动安装操作系统</h2><p>cobbler是快速网络安装linux操作系统的服务，支持众多的Linux发行版：Red Hat、Fedora、CentOS、Debian、Ubuntu和SuSE，也可以支持网络安装windows</p>
<span id="more"></span>

<h3 id="一、配置yum源"><a href="#一、配置yum源" class="headerlink" title="一、配置yum源"></a>一、配置yum源</h3><p>cobbler所在的源是epel源所以先配置yum源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/yum.repos.d/base.repo</span></span><br><span class="line">[base]</span><br><span class="line">name=base</span><br><span class="line">baseurl=file:///mnt</span><br><span class="line">gpgcheck=0</span><br><span class="line">[epel]</span><br><span class="line">name=epel</span><br><span class="line">baseurl=http://mirrors.sohu.com/fedora-epel/7/x86_64</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure>

<h3 id="二、安装cobbler和dhcp服务"><a href="#二、安装cobbler和dhcp服务" class="headerlink" title="二、安装cobbler和dhcp服务"></a>二、安装cobbler和dhcp服务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum install cobbler dhcp -y</span></span><br></pre></td></tr></table></figure>

<h3 id="三、启动相关服务并设置为开机启动"><a href="#三、启动相关服务并设置为开机启动" class="headerlink" title="三、启动相关服务并设置为开机启动"></a>三、启动相关服务并设置为开机启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># systemctl enable rsyncd httpd tftp cobblerd dhcpd</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl start rsyncd httpd tftp cobblerd</span></span><br></pre></td></tr></table></figure>

<h3 id="四、配置cobbler"><a href="#四、配置cobbler" class="headerlink" title="四、配置cobbler"></a>四、配置cobbler</h3><p>1.使用cobbler check查看所需配置的内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@centos7 ~]<span class="comment"># cobbler check</span></span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line"></span><br><span class="line">1 : The <span class="string">&#x27;server&#x27;</span> field <span class="keyword">in</span> /etc/cobbler/settings must be <span class="built_in">set</span> to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP <span class="keyword">for</span> the boot server as reachable by all machines that will use it.</span><br><span class="line">2 : For PXE to be functional, the <span class="string">&#x27;next_server&#x27;</span> field <span class="keyword">in</span> /etc/cobbler/settings must be <span class="built_in">set</span> to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.</span><br><span class="line">3 : change <span class="string">&#x27;disable&#x27;</span> to <span class="string">&#x27;no&#x27;</span> <span class="keyword">in</span> /etc/xinetd.d/tftp</span><br><span class="line">4 : Some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run <span class="string">&#x27;cobbler get-loaders&#x27;</span> to download them, or, <span class="keyword">if</span> you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files <span class="keyword">in</span> this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The <span class="string">&#x27;cobbler get-loaders&#x27;</span> <span class="built_in">command</span> is the easiest way to resolve these requirements.</span><br><span class="line">5 : debmirror package is not installed, it will be required to manage debian deployments and repositories</span><br><span class="line">6 : The default password used by the sample templates <span class="keyword">for</span> newly installed machines (default_password_crypted <span class="keyword">in</span> /etc/cobbler/settings) is still <span class="built_in">set</span> to <span class="string">&#x27;cobbler&#x27;</span> and should be changed, try: <span class="string">&quot;openssl passwd -1 -salt &#x27;random-phrase-here&#x27; &#x27;your-password-here&#x27;&quot;</span> to generate new one</span><br><span class="line">7 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them</span><br><span class="line"></span><br><span class="line">Restart cobblerd and <span class="keyword">then</span> run <span class="string">&#x27;cobbler sync&#x27;</span> to apply changes.</span><br></pre></td></tr></table></figure>

<p>2.在/etc/cobbler/setting文件中查找到以下几项并进行修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server: 192.168.73.120                  <span class="comment">#cobbler的服务器地址</span></span><br><span class="line">next_server: 192.168.73.120             <span class="comment">#tftp服务器地址</span></span><br><span class="line">default_password_crypted: <span class="string">&quot;$1$JZoCUmJG<span class="variable">$PaPdl</span>.tq3OW6KEXZbUaBP.&quot;</span>      <span class="comment">#修改默认密码</span></span><br><span class="line">manage_dhcp: 1                          <span class="comment">#dhcpg管理设置为1</span></span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">3.下载boot-loaders</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">[root@centos7 ~]<span class="comment"># cobbler get-loaders</span></span><br></pre></td></tr></table></figure>

<p>4.修改cobbler的dhcp模板文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/cobbler/dhcp.template</span></span><br><span class="line">...上面省略...</span><br><span class="line">subnet 192.168.73.0 netmask 255.255.255.0 &#123;                       <span class="comment">#修改网段</span></span><br><span class="line">     option routers             192.168.73.254;                   <span class="comment">#指定网关</span></span><br><span class="line">     option domain-name-servers 1.1.1.1;                          <span class="comment">#指定dns</span></span><br><span class="line">     option subnet-mask         255.255.255.0;                    <span class="comment">#指定子网掩码</span></span><br><span class="line">     range dynamic-bootp        192.168.73.1 192.168.73.100;      <span class="comment">#指定地址池</span></span><br><span class="line">     default-lease-time         21600;</span><br><span class="line">     max-lease-time             43200;</span><br><span class="line">     next-server                <span class="variable">$next_server</span>;</span><br><span class="line">     class <span class="string">&quot;pxeclients&quot;</span> &#123;</span><br><span class="line">          match <span class="keyword">if</span> substring (option vendor-class-identifier, 0, 9) = <span class="string">&quot;PXEClient&quot;</span>;</span><br><span class="line">          <span class="keyword">if</span> option pxe-system-type = 00:02 &#123;</span><br><span class="line">                  filename <span class="string">&quot;ia64/elilo.efi&quot;</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> option pxe-system-type = 00:06 &#123;</span><br><span class="line">                  filename <span class="string">&quot;grub/grub-x86.efi&quot;</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> option pxe-system-type = 00:07 &#123;</span><br><span class="line">                  filename <span class="string">&quot;grub/grub-x86_64.efi&quot;</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> option pxe-system-type = 00:09 &#123;</span><br><span class="line">                  filename <span class="string">&quot;grub/grub-x86_64.efi&quot;</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  filename <span class="string">&quot;pxelinux.0&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">...下面省略...</span><br></pre></td></tr></table></figure>

<p>5.将cobbler的DHCP文件进行同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cobbler sync</span></span><br></pre></td></tr></table></figure>

<p>6.重启cobbler服务以及DHCP服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart cobblerd</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl start dhcpd</span></span><br></pre></td></tr></table></figure>

<h3 id="五、为cobbler配置系统镜像文件"><a href="#五、为cobbler配置系统镜像文件" class="headerlink" title="五、为cobbler配置系统镜像文件"></a>五、为cobbler配置系统镜像文件</h3><p>1.将光盘挂载至一个空目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mount /dev/sr0 /mnt</span></span><br></pre></td></tr></table></figure>

<p>2.将光盘内文件复制入cobbler，此步骤是将光盘的的文件复制至/var/www/cobbler/ks_mirror/目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cobbler import --path=/mnt --name=Centos-6.10 --arch=x86_64</span></span><br></pre></td></tr></table></figure>

<p>由于cobbler自带了KS文件，所以现在已经能够实现自动化安装系统了，若要实现使用自己定制的KS文件，来实现自动化安装看下面的补充。</p>
<hr>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>在实际生产环境中可能需要安装各种不同的定制化的系统，此时就需要准备各种不同的ks文件，并将文件与相对应的系统关联起来。</p>
<h3 id="一、准备ks文件"><a href="#一、准备ks文件" class="headerlink" title="一、准备ks文件"></a>一、准备ks文件</h3><p>1.ks文件可以在图形化界面通过system-config-kickstart进行生成，也手写(不建议)或使用已经装好的系统中，/root/anaconda-ks.cfg进行修改。此处以最小化安装ks文件为例。</p>
<p>此处需要注意的是在ks文件中使用network安装，要将url的路径设置为cobbler的内置变量$tree</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Use network installation</span></span><br><span class="line">url --url=<span class="variable">$tree</span></span><br></pre></td></tr></table></figure>

<p>2.ks6mini.cfg文件内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim ks6.cfg</span></span><br><span class="line"><span class="comment">#platform=x86, AMD64, or Intel EM64T</span></span><br><span class="line"><span class="comment">#version=DEVEL</span></span><br><span class="line"><span class="comment"># Firewall configuration</span></span><br><span class="line">firewall --disabled</span><br><span class="line"><span class="comment"># Install OS instead of upgrade</span></span><br><span class="line">install</span><br><span class="line"><span class="comment"># Use network installation</span></span><br><span class="line">url --url=<span class="variable">$tree</span></span><br><span class="line"><span class="comment"># Root password</span></span><br><span class="line">rootpw --iscrypted $1$6oVXZR1R<span class="variable">$QOASc6inirmHCZmQ</span>.W9Hg0</span><br><span class="line"><span class="comment"># System authorization information</span></span><br><span class="line">auth  --useshadow  --passalgo=sha512</span><br><span class="line"><span class="comment"># Use text mode install</span></span><br><span class="line">text</span><br><span class="line"><span class="comment"># System keyboard</span></span><br><span class="line">keyboard us</span><br><span class="line"><span class="comment"># System language</span></span><br><span class="line">lang en_US</span><br><span class="line"><span class="comment"># SELinux configuration</span></span><br><span class="line">selinux --disabled</span><br><span class="line"><span class="comment"># Do not configure the X Window System</span></span><br><span class="line">skipx</span><br><span class="line"><span class="comment"># Installation logging level</span></span><br><span class="line">logging --level=info</span><br><span class="line"><span class="comment"># Reboot after installation</span></span><br><span class="line">reboot</span><br><span class="line"><span class="comment"># System timezone</span></span><br><span class="line">timezone  Asia/Shanghai</span><br><span class="line"><span class="comment"># Network information</span></span><br><span class="line">network  --bootproto=dhcp --device=eth0 --onboot=on</span><br><span class="line"><span class="comment"># System bootloader configuration</span></span><br><span class="line">bootloader --location=mbr</span><br><span class="line"><span class="comment"># Clear the Master Boot Record</span></span><br><span class="line">zerombr</span><br><span class="line"><span class="comment"># Partition clearing information</span></span><br><span class="line">clearpart --all --initlabel </span><br><span class="line"><span class="comment"># Disk partitioning information</span></span><br><span class="line">part /boot --fstype=<span class="string">&quot;ext4&quot;</span> --size=200</span><br><span class="line">part / --fstype=<span class="string">&quot;ext4&quot;</span> --size=20000</span><br><span class="line">part swap --fstype=<span class="string">&quot;swap&quot;</span> --size=1024</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">@core</span><br><span class="line"></span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h3 id="二、将ks文件复制到cobbler的ks的仓库中"><a href="#二、将ks文件复制到cobbler的ks的仓库中" class="headerlink" title="二、将ks文件复制到cobbler的ks的仓库中"></a>二、将ks文件复制到cobbler的ks的仓库中</h3><p>cobbler有自带的ks仓库，其目录在/var/lib/cobbler/kickstarts/，将所准备好的ks文件复制到此目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cp ks6mini.cfg /var/lib/cobbler/kickstarts/</span></span><br></pre></td></tr></table></figure>

<h3 id="三、将ks文件与cobbler中的系统镜像相关联"><a href="#三、将ks文件与cobbler中的系统镜像相关联" class="headerlink" title="三、将ks文件与cobbler中的系统镜像相关联"></a>三、将ks文件与cobbler中的系统镜像相关联</h3><p>1.首先查看下cobbler仓库中的ks文件关联列表以及cobbler中所存在的系统镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cobbler profile list          #此命令可以查看ks关联安装列表</span></span><br><span class="line">   Centos-6.10-x86_64                           <span class="comment">#此为刚才创建的安装列表</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cobbler distro list           #此命令可以查看所存在的系统镜像</span></span><br><span class="line">   Centos-6.10-x86_64                           <span class="comment">#此为刚才导入的镜像</span></span><br></pre></td></tr></table></figure>

<p>2.将ks6mini.cfg文件进行关联</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cobbler profile add --name=Centos-6.10-mini-x86_64 --distro=Centos-6.10-x86_64 --ks=/var/lib/cobbler/kickstarts/ks6mini.cfg</span></span><br><span class="line"><span class="comment">#--name:指定新的安装列表的名称</span></span><br><span class="line"><span class="comment">#--distro:指定所要关联的镜像名称</span></span><br><span class="line"><span class="comment">#--ks:指定ks文件所在的路径</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cobbler profile list          #查看安装列表</span></span><br><span class="line">   Centos-6.10-mini-x86_64                      <span class="comment">#此为刚才所关联的项</span></span><br><span class="line">   Centos-6.10-x86_64</span><br></pre></td></tr></table></figure>

<p>3.删除ks关联</p>
<p>由于cobbler所自带的关联安装方法，并不是我们想要的，所以我们需要将其从列表中删除，删除方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cobbler profile remove --name=Centos-6.10-x86_64      #删除列表</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cobbler profile list</span></span><br><span class="line">   Centos-6.10-mini-x86_64                                              <span class="comment">#此时只剩下mini</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="基于web的cobbler管理"><a href="#基于web的cobbler管理" class="headerlink" title="基于web的cobbler管理"></a>基于web的cobbler管理</h2><p>由于文本形式的cobbler的管理不太友好，我们也可以使用基于web的管理方法</p>
<h3 id="一、安装cobbler-web"><a href="#一、安装cobbler-web" class="headerlink" title="一、安装cobbler-web"></a>一、安装cobbler-web</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 mnt]<span class="comment"># yum install cobbler-web -y</span></span><br></pre></td></tr></table></figure>

<h3 id="二、重启httpd服务"><a href="#二、重启httpd服务" class="headerlink" title="二、重启httpd服务"></a>二、重启httpd服务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 mnt]<span class="comment"># systemctl restart httpd</span></span><br></pre></td></tr></table></figure>

<h3 id="三、此时已经能访问cobbler的web界面"><a href="#三、此时已经能访问cobbler的web界面" class="headerlink" title="三、此时已经能访问cobbler的web界面"></a>三、此时已经能访问cobbler的web界面</h3><p>cobbler_web是基于ssl的，所以需要使用https协议，访问地址为：<a href="https://xxx.xxx.xxx.xxx/cobbler_web">https://XXX.XXX.XXX.XXX/cobbler_web</a></p>
<p><img src="cobbler_web.png" alt="cobbler_web.png"></p>
<h2 id="cobbler-web的账户和密码"><a href="#cobbler-web的账户和密码" class="headerlink" title="cobbler_web的账户和密码"></a>cobbler_web的账户和密码</h2><p>cobbler默认账户和密码都为cobbler，此密码不够安全，我们需要对其加以修改。  </p>
<h3 id="一、authn-configfile验证方法"><a href="#一、authn-configfile验证方法" class="headerlink" title="一、authn_configfile验证方法"></a>一、authn_configfile验证方法</h3><p>cobbler的验证文件存放在/etc/cobbler/modules.conf内部详细的说明了各种验证方法，默认的验证方法为configfile。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 mnt]<span class="comment"># cat /etc/cobbler/modules.conf</span></span><br><span class="line"><span class="comment"># cobbler module configuration file</span></span><br><span class="line"><span class="comment"># =================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># authentication: </span></span><br><span class="line"><span class="comment"># what users can log into the WebUI and Read-Write XMLRPC?</span></span><br><span class="line"><span class="comment"># choices:</span></span><br><span class="line"><span class="comment">#    authn_denyall    -- no one (default)</span></span><br><span class="line"><span class="comment">#    authn_configfile -- use /etc/cobbler/users.digest (for basic setups)</span></span><br><span class="line"><span class="comment">#    authn_passthru   -- ask Apache to handle it (used for kerberos)</span></span><br><span class="line"><span class="comment">#    authn_ldap       -- authenticate against LDAP</span></span><br><span class="line"><span class="comment">#    authn_spacewalk  -- ask Spacewalk/Satellite (experimental)</span></span><br><span class="line"><span class="comment">#    authn_pam        -- use PAM facilities</span></span><br><span class="line"><span class="comment">#    authn_testing    -- username/password is always testing/testing (debug)</span></span><br><span class="line"><span class="comment">#    (user supplied)  -- you may write your own module</span></span><br><span class="line"><span class="comment"># WARNING: this is a security setting, do not choose an option blindly.</span></span><br><span class="line"><span class="comment"># for more information:</span></span><br><span class="line"><span class="comment"># https://github.com/cobbler/cobbler/wiki/Cobbler-web-interface</span></span><br><span class="line"><span class="comment"># https://github.com/cobbler/cobbler/wiki/Security-overview</span></span><br><span class="line"><span class="comment"># https://github.com/cobbler/cobbler/wiki/Kerberos</span></span><br><span class="line"><span class="comment"># https://github.com/cobbler/cobbler/wiki/Ldap</span></span><br><span class="line"></span><br><span class="line">[authentication]</span><br><span class="line">module = authn_configfile</span><br></pre></td></tr></table></figure>

<p>添加用户和删除用户</p>
<p>auth_confile的用户名和密码存放在/etc/cobbler/users.digest中使用一下命令可以创建Cobbler的用户和密码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 mnt]<span class="comment"># htdigest /etc/cobbler/users.digest Cobbler admin   #注意此处Cobbler的C必须为大写</span></span><br><span class="line">Adding user admin <span class="keyword">in</span> realm cobbler</span><br><span class="line">New password: </span><br><span class="line">Re-type new password: </span><br></pre></td></tr></table></figure>

<p>Cobbler删除用户只需要在/etc/cobbler/users.digest中找到用户相对应的行将其删除。</p>
<h3 id="二、authn-pam的验证方法"><a href="#二、authn-pam的验证方法" class="headerlink" title="二、authn_pam的验证方法"></a>二、authn_pam的验证方法</h3><p>1.修改验证文件/etc/cobbler/modules.conf中的authentication项，pam验证方法的用户名和密码存放在/etc/cobbler/users.conf文件中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[authentication]</span><br><span class="line">module = authn_pam</span><br></pre></td></tr></table></figure>

<p>2.基于pam验证的用户名和密码的创建</p>
<p>创建一个Linux用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 mnt]<span class="comment"># useradd -s /sbin/nologin cobbleradmin</span></span><br><span class="line">[root@centos7 mnt]<span class="comment"># echo 111111 | passwd --stdin cobbleradmin</span></span><br><span class="line">Changing password <span class="keyword">for</span> user cobbleradmin.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br></pre></td></tr></table></figure>

<p>此时可以使用Linxu账户进行登陆cobbler_web</p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>自动化安装系统</tag>
      </tags>
  </entry>
  <entry>
    <title>fstab排错</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/fstab%E6%8E%92%E9%94%99/fstab%E6%8E%92%E9%94%99/</url>
    <content><![CDATA[<h2 id="Fstab排错"><a href="#Fstab排错" class="headerlink" title="Fstab排错"></a>Fstab排错</h2><p>fstab文件中所配置的挂载设备出现配置出错时将导致系统无法启动，以下分别演示centos6 和centos7挂载出错时的修复方法</p>
<span id="more"></span>

<h3 id="一、CentOS6环境"><a href="#一、CentOS6环境" class="headerlink" title="一、CentOS6环境"></a>一、CentOS6环境</h3><p>1.创建错误环境</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># vim /etc/fstab</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line"><span class="comment"># Created by anaconda on Tue Mar  5 13:07:05 2019</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;</span></span><br><span class="line"><span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">UUID=3fa49288-1c40-4e74-ad2c-a32fefedf20f /                       ext4    defaults        1 1</span><br><span class="line">UUID=5f0da078-420b-be5b-95ce5a8a2efc /boot                   ext4    defaults        1 2           此行的UUID原本为5f0da078-2991-420b-be5b-95ce5a8a2efc</span><br><span class="line">UUID=bf0d1aa-83e5-4127-9e59-a4fc7aa9dbb9 /data                   ext4    defaults        1 2      此行的UUID原本为5bf0d1aa-83e5-4127-9e59-a4fc7aa9dbb9</span><br><span class="line">UUID=07895eae-ecf4-4a48-9c4a-668e407fc70a swap                    swap    defaults        0 0</span><br><span class="line">tmpfs                   /dev/shm                tmpfs   defaults        0 0</span><br><span class="line">devpts                  /dev/pts                devpts  gid=5,mode=620  0 0</span><br><span class="line">sysfs                   /sys                    sysfs   defaults        0 0</span><br><span class="line">proc                    /proc                   proc    defaults        0 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>保存退出重启  </p>
<p>2.排错</p>
<p>此时两行uuid报错，要求输入root口令登录排错</p>
<p><img src="1.png" alt="1.png"></p>
<p>登录后进入/etc/fstab对文件进行修改，发现此时文件处于只读状态。</p>
<p><img src="3.png" alt="3.png"></p>
<p>CentOS6在对根挂载时默认使用的是只读挂载，所以需要对/重新挂载并设置读写属性</p>
<p><img src="4.png" alt="4.png"></p>
<p>重新进入fstab对UUID进行修复。</p>
<p><img src="5.png" alt="5.png"></p>
<p>重启后重新进入系统</p>
<p>注意：此处实验使用的是将文件直接修复，也可以把错误的行注销，或者将最后一位检查次序设置为0不做检查。等进入系统后再做修复。</p>
<h3 id="二、CentOS7环境"><a href="#二、CentOS7环境" class="headerlink" title="二、CentOS7环境"></a>二、CentOS7环境</h3><p>1.创建环境</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/fstab</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line"><span class="comment"># Created by anaconda on Tue Mar  5 21:07:19 2019</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;</span></span><br><span class="line"><span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">UUID=45490aa4-cf29-420d-a606-af32688b6707 /                       xfs     defaults        0 0</span><br><span class="line">UUID=x15dcd896-b7cf-48d0-b8bd-4c0b0f2c62b2 /boot                   xfs     defaults        0 0       此处正确UUID为 15dcd896-b7cf-48d0-b8bd-4c0b0f2c62b2</span><br><span class="line">UUID=4b6e1813-2c46-402a-869a-02cbbcb76ade /data                   xfs     defaults        0 0</span><br><span class="line">UUID=0995b444-48c1-4423-92bc-2deda0d3c082 swap                    swap    defaults        0 0                                       </span><br></pre></td></tr></table></figure>

<p>保存重启</p>
<p>2.排错</p>
<p>重启后已出现错误</p>
<p><img src="c1.png" alt="c1.png"></p>
<p>输入root口令，登录系统</p>
<p><img src="c2.png" alt="c2.png"></p>
<p>修改/etc/fstab，直接将错误的那行注释掉</p>
<p><img src="c3.png" alt="c3.png"></p>
<p>保存重启，此时已经能够正常进入系统</p>
<p><img src="c4.png" alt="c4.png"></p>
<p>登录系统后将/etc/fstab的参数修改正确</p>
<p><img src="c5.png" alt="c5.png"></p>
<p>注意：CentOS7与6的区别在于emergency模式下，7是可读可写，6只能读需要重新挂载，7的fstab最后一位检查次序设置为0时没有用无法让系统不检查需要直接注释掉错误行或者直接修复错误。</p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>系统修复</tag>
      </tags>
  </entry>
  <entry>
    <title>ssh服务</title>
    <url>/2019/03/12/Linux%E5%9F%BA%E7%A1%80/openssh/openssh/</url>
    <content><![CDATA[<h2 id="SSH服务"><a href="#SSH服务" class="headerlink" title="SSH服务"></a>SSH服务</h2><p>ssh名字为secure shell，目前使用的版本号为2，所使用的端口号为tcp的22号端口，可以实现安全的远程登录。  </p>
<p>ssh协议版本有v1版和v2版本:  </p>
<p>v1是基于CRC-32做MAC，不安全，无法防止中间人攻击。  </p>
<p>V2版本双方主机协议选择安全的MAC方式基于DH算法做密钥交换，基于RSA或DSA实现身份认证  </p>
<p>ssh具体的软件实现为：Openssh和dropbear</p>
<span id="more"></span>

<hr>
<h2 id="OpenSSH"><a href="#OpenSSH" class="headerlink" title="OpenSSH"></a>OpenSSH</h2><p>openssh是ssh的一种实现，它能允许远程系统经验证地加密安全访问。当用户远程连接ssh服务器时，会复制ssh服务器/etc/ssh/ssh_host_ecdsa_key.pub文件中的公钥到客户机的~/.ssh/know_hosts中。下次连接时会自动匹配相应私钥，不能匹配的将拒绝连接  </p>
<p>ssh软件的组成  </p>
<p>openssh是由openssh、openssh-clients、openssh-server这几个包组成。  </p>
<p>由于ssh是基于C/S结构，所以它分别有客户端的配置和服务器端的配置。</p>
<h2 id="openssh客户端"><a href="#openssh客户端" class="headerlink" title="openssh客户端"></a>openssh客户端</h2><h3 id="一、配置文件"><a href="#一、配置文件" class="headerlink" title="一、配置文件"></a>一、配置文件</h3><p>ssh客户端的配置存放在/etc/ssh/ssh_config文件内，一般客户端的配置文件不做修改，使用默认配置，但其中有几项选项稍作了解。</p>
<p>1.StrictHostKeyChecking</p>
<p>当客户端第一次访问服务器时，客户端会询问所访问的主机是否是你真正想想要访问的主机。默认是每次都会询问，当设置为no时，不会再询问。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">StrictHostKeyChecking no</span><br></pre></td></tr></table></figure>

<p>2.port</p>
<p>此项为连接服务器时的端口号。默认为22号端口，当服务器的ssh服务的端口为非标时，将配置文件的port进行修改，也可以使用ssh -p PORT来指定端口号。</p>
<p>修改配置文件方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">port 9527    <span class="comment">#找到port行修改为指定端口</span></span><br></pre></td></tr></table></figure>
<p>手动指定端口号方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssh root@192.168.73.133 -p 9527</span></span><br></pre></td></tr></table></figure>

<h3 id="二、ssh的用户登陆方式"><a href="#二、ssh的用户登陆方式" class="headerlink" title="二、ssh的用户登陆方式"></a>二、ssh的用户登陆方式</h3><p>ssh有2中登录方式，一种是基于口令的登陆方式，另一种是基于Key的登登录方式。</p>
<h4 id="基于口令的登陆方式"><a href="#基于口令的登陆方式" class="headerlink" title="基于口令的登陆方式"></a>基于口令的登陆方式</h4><p>基于口令的登陆方式依赖于ssh命令</p>
<p>ssh的使用方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh [option] [user@]host [COMMAND]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-p port</td>
<td align="left">指定远程服务器监听的端口</td>
</tr>
<tr>
<td align="left">-b</td>
<td align="left">指定连接的源IP</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">调试模式</td>
</tr>
<tr>
<td align="left">-C</td>
<td align="left">压缩方式</td>
</tr>
<tr>
<td align="left">-X</td>
<td align="left">支持x11转发</td>
</tr>
<tr>
<td align="left">-t</td>
<td align="left">强制伪tty分配</td>
</tr>
</tbody></table>
<p>常用选项示例:  </p>
<p>-p：可以用来指定连接远程主机的端口号，常用在服务器端口号为非标的情况下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssh root@192.168.73.133 -p 9527</span></span><br></pre></td></tr></table></figure>

<p>-C:压缩方法连接，常用在带宽较小的情况下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssh -C root@192.168.73.133</span></span><br></pre></td></tr></table></figure>

<p>-X:支持x11转发功能  </p>
<p>x11转发功能可以实现将远程的主机的图形化桌面拉取到本机，从而实现图形操作。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssh -X root@192.168.73.133</span></span><br></pre></td></tr></table></figure>

<p>-t:强制伪tty分配  </p>
<p>强制伪tty分配使用的场合为有a、b、c、d,4台主机，a要去连接d，但d,c,b只能通过单线去连接，a无法直接连接到的d,需要b,c上依次登录才能登录到d,使用-t选项可以实现一条命令直接登录至d主机</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssh -t 192.168.73.132 ssh -t 192.168.73.133 ssh 192.168.73.134</span></span><br><span class="line">root@192.168.73.132<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">The authenticity of host &#x27;</span>192.168.73.133 (192.168.73.133)<span class="string">&#x27; can&#x27;</span>t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:YNlH0VBV0kp4lAClVvfMWVx/bHcbKKHXQwyd13d+MME.</span><br><span class="line">ECDSA key fingerprint is MD5:8a:1c:3d:c2:04:b1:be:05:95:33:9e:16:e8:ad:6c:25.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="string">&#x27;192.168.73.133&#x27;</span> (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.73.133<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">The authenticity of host &#x27;</span>192.168.73.134 (192.168.73.134)<span class="string">&#x27; can&#x27;</span>t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:YNlH0VBV0kp4lAClVvfMWVx/bHcbKKHXQwyd13d+MME.</span><br><span class="line">ECDSA key fingerprint is MD5:8a:1c:3d:c2:04:b1:be:05:95:33:9e:16:e8:ad:6c:25.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="string">&#x27;192.168.73.134&#x27;</span> (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.73.134<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Last failed login: Tue Apr 16 11:41:25 CST 2019 from 192.168.73.133 on ssh:notty</span></span><br><span class="line"><span class="string">There was 1 failed login attempt since the last successful login.</span></span><br><span class="line"><span class="string">Last login: Tue Apr 16 07:15:03 2019 from 192.168.73.1</span></span><br></pre></td></tr></table></figure>

<h3 id="基于密钥方式的登录"><a href="#基于密钥方式的登录" class="headerlink" title="基于密钥方式的登录"></a>基于密钥方式的登录</h3><h4 id="一、交互式方法实现密钥登录"><a href="#一、交互式方法实现密钥登录" class="headerlink" title="一、交互式方法实现密钥登录"></a>一、交互式方法实现密钥登录</h4><p>1.先在本机生成私钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:7s3nPNrHugMdkip+8ozUvE2pYeUnvGGhylzVHMhaPMk root@centos7.localdomain</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|                 |</span></span><br><span class="line"><span class="string">|         + o     |</span></span><br><span class="line"><span class="string">|          E..    |</span></span><br><span class="line"><span class="string">|         oo+..   |</span></span><br><span class="line"><span class="string">|        S.+oo.   |</span></span><br><span class="line"><span class="string">|      .+.*.o.    |</span></span><br><span class="line"><span class="string">|     ...O O...   |</span></span><br><span class="line"><span class="string">|     +oB.X B+ o  |</span></span><br><span class="line"><span class="string">|      =+* *+**   |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure>

<p>2.将密钥文件发送给远端的主机</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssh-copy-id root@192.168.73.132</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: <span class="string">&quot;/root/.ssh/id_rsa.pub&quot;</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to <span class="built_in">log</span> <span class="keyword">in</span> with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="keyword">if</span> you are prompted now it is to install the new keys</span><br><span class="line">root@192.168.73.132<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Permission denied, please try again.</span></span><br><span class="line"><span class="string">root@192.168.73.132&#x27;</span>s password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">&quot;ssh &#x27;root@192.168.73.132&#x27;&quot;</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br></pre></td></tr></table></figure>
<h4 id="二、非交互式方法实现密钥登陆"><a href="#二、非交互式方法实现密钥登陆" class="headerlink" title="二、非交互式方法实现密钥登陆"></a>二、非交互式方法实现密钥登陆</h4><p>1.生成密钥，存放在~/.ssh/id_rsa</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssth-keygen - rsa -N &quot;&quot; -f ~/.ssh/id_rs</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:q+dIP5AXsmfJT71CleOlW8pR27c/SBdDJaRBK/n3ibo root@centos7.localdomain</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|           .o.o o|</span></span><br><span class="line"><span class="string">|           . + o |</span></span><br><span class="line"><span class="string">|          o o..  |</span></span><br><span class="line"><span class="string">|      . .  o+ oo |</span></span><br><span class="line"><span class="string">|       =So +.=.oo|</span></span><br><span class="line"><span class="string">|      + *.o =o+o+|</span></span><br><span class="line"><span class="string">|      .=.+ ..Bo.+|</span></span><br><span class="line"><span class="string">|     . +o o *. o |</span></span><br><span class="line"><span class="string">|      ooo. E.   +|</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure>

<p>2.复制密钥至远程主机</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssh-copy-id 192.168.73.128</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: <span class="string">&quot;/root/.ssh/id_rsa.pub&quot;</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to <span class="built_in">log</span> <span class="keyword">in</span> with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="keyword">if</span> you are prompted now it is to install the new keys</span><br><span class="line">root@192.168.73.128<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Number of key(s) added: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>192.168.73.128<span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="string">and check to make sure that only the key(s) you wanted were added.</span></span><br></pre></td></tr></table></figure>

<p>注意：key验证必须保证key的安全，若私钥文件被偷走，别人可以利用私钥文件进行免密登陆，为防止密钥被别人盗走后被别人免密登陆，可以对私钥进行加密。</p>
<p>3.密钥的加密</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 .ssh]<span class="comment"># ssh-keygen -t rsa -P &quot;111111&quot; -f ~/.ssh/id_rsa     #创建密钥时对密钥进行加密</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:+kwhjUafA73ra7CoTaR59wemYBSGMummrZbHwubPUlI root@centos7.localdomain</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">| . .             |</span></span><br><span class="line"><span class="string">|+ . o  .         |</span></span><br><span class="line"><span class="string">|.o . .o .        |</span></span><br><span class="line"><span class="string">| o E.. = o       |</span></span><br><span class="line"><span class="string">|o.... + S        |</span></span><br><span class="line"><span class="string">|...=o..oo+       |</span></span><br><span class="line"><span class="string">|..B.ooo=o.       |</span></span><br><span class="line"><span class="string">|.B.*..o*. .      |</span></span><br><span class="line"><span class="string">|+.*+.  .*o       |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 .ssh]# ssh-copy-id 192.168.73.128                         #将密钥复制到远程主机</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span></span><br><span class="line"><span class="string">The authenticity of host &#x27;</span>192.168.73.128 (192.168.73.128)<span class="string">&#x27; can&#x27;</span>t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:YNlH0VBV0kp4lAClVvfMWVx/bHcbKKHXQwyd13d+MME.</span><br><span class="line">ECDSA key fingerprint is MD5:8a:1c:3d:c2:04:b1:be:05:95:33:9e:16:e8:ad:6c:25.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span> connecting (yes/no)? yes</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to <span class="built_in">log</span> <span class="keyword">in</span> with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="keyword">if</span> you are prompted now it is to install the new keys</span><br><span class="line">root@192.168.73.128<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Number of key(s) added: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>192.168.73.128<span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="string">and check to make sure that only the key(s) you wanted were added.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 .ssh]# ssh 192.168.73.128</span></span><br><span class="line"><span class="string">Enter passphrase for key &#x27;</span>/root/.ssh/id_rsa<span class="string">&#x27;:                       #再次登陆时要求输入密钥的密码</span></span><br><span class="line"><span class="string">Last login: Tue Apr 16 21:15:58 2019 from 192.168.73.132</span></span><br></pre></td></tr></table></figure>
<p>由于每次需要输入密码太过麻烦，也可以使用代理，先输一次密码，只有所有登陆时所需要的输入的密码都由代理来输入，达到免密的方法<br>4.ssh-agent代理的使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 .ssh]<span class="comment"># ssh-agent bash         #运行代理</span></span><br><span class="line">[root@centos7 .ssh]<span class="comment"># ssh-add                #将密钥通过命令添加给代理</span></span><br><span class="line">Enter passphrase <span class="keyword">for</span> /root/.ssh/id_rsa: </span><br><span class="line">Identity added: /root/.ssh/id_rsa (/root/.ssh/id_rsa)</span><br><span class="line">[root@centos7 .ssh]<span class="comment"># ssh 192.168.73.128</span></span><br><span class="line">Last login: Tue Apr 16 21:21:40 2019 from 192.168.73.128        <span class="comment">#再次实现免密登陆</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h4 id="三、集群模式下的基于key验证。"><a href="#三、集群模式下的基于key验证。" class="headerlink" title="三、集群模式下的基于key验证。"></a>三、集群模式下的基于key验证。</h4><p>假设有3台设备，要实现相互间key验证登陆，那我们就需要依次坐在每台主机上，执行创建密钥和公钥分发的操作，由于此方法过于繁琐，有没有更加便捷的方法呢？  </p>
<p>实现思路：3台主机公用一个公私钥</p>
<p>1.现在一台主机上创建私钥文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mkdir .ssh</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ssh-keygen -P &quot;&quot; -t rsa  -f .ssh/id_rsa</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> .ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> .ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:+pUkZANYvXQPGCF2VC5dpF7FNnZvLVyZZRNg7Av33f8 root@centos7.localdomain</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|     o=o==..++ooB|</span></span><br><span class="line"><span class="string">|    .. ++ooo.o=++|</span></span><br><span class="line"><span class="string">|       .=o+oo+ +o|</span></span><br><span class="line"><span class="string">|       o.+ o.oo +|</span></span><br><span class="line"><span class="string">|        S o o ooo|</span></span><br><span class="line"><span class="string">|       . o . . .o|</span></span><br><span class="line"><span class="string">|      .   o     .|</span></span><br><span class="line"><span class="string">|       . .      .|</span></span><br><span class="line"><span class="string">|        .       E|</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure>

<p>2.对自己创建authorized_keys文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssh-copy-id 192.168.73.128</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: <span class="string">&quot;/root/.ssh/id_rsa.pub&quot;</span></span><br><span class="line">The authenticity of host <span class="string">&#x27;192.168.73.128 (192.168.73.128)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:YNlH0VBV0kp4lAClVvfMWVx/bHcbKKHXQwyd13d+MME.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is MD5:8a:1c:3d:c2:04:b1:be:05:95:33:9e:16:e8:ad:6c:25.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span></span><br><span class="line"><span class="string">root@192.168.73.128&#x27;</span>s password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">&quot;ssh &#x27;192.168.73.128&#x27;&quot;</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br></pre></td></tr></table></figure>
<p>3.将整个.ssh目录分发给另外两台主机</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># scp -rp .ssh 192.168.73.132:/root/</span></span><br><span class="line">root@192.168.73.132<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">id_rsa                                                                 100% 1675     1.3MB/s   00:00    </span></span><br><span class="line"><span class="string">id_rsa.pub                                                             100%  406   389.1KB/s   00:00    </span></span><br><span class="line"><span class="string">known_hosts                                                            100%  352   536.8KB/s   00:00    </span></span><br><span class="line"><span class="string">authorized_keys                                                        100%  406   660.1KB/s   00:00    </span></span><br><span class="line"><span class="string">[root@centos7 ~]# scp .ssh 192.168.73.133:/root/</span></span><br><span class="line"><span class="string">The authenticity of host &#x27;</span>192.168.73.133 (192.168.73.133)<span class="string">&#x27; can&#x27;</span>t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:YNlH0VBV0kp4lAClVvfMWVx/bHcbKKHXQwyd13d+MME.</span><br><span class="line">ECDSA key fingerprint is MD5:8a:1c:3d:c2:04:b1:be:05:95:33:9e:16:e8:ad:6c:25.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="string">&#x27;192.168.73.133&#x27;</span> (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.73.133<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">.ssh: not a regular file</span></span><br><span class="line"><span class="string">[root@centos7 ~]# scp -rp .ssh 192.168.73.133:/root/</span></span><br><span class="line"><span class="string">root@192.168.73.133&#x27;</span>s password: </span><br><span class="line">id_rsa                                                                 100% 1675     1.2MB/s   00:00    </span><br><span class="line">id_rsa.pub                                                             100%  406   365.0KB/s   00:00    </span><br><span class="line">known_hosts                                                            100%  528     1.1MB/s   00:00    </span><br><span class="line">authorized_keys                                                        100%  406   619.8KB/s   00:00    </span><br></pre></td></tr></table></figure>
<p>4.登录测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ssh 192.168.73.133</span></span><br><span class="line">Last login: Tue Apr 16 06:23:20 2019</span><br><span class="line">[root@centos7 ~]<span class="comment"># ssh 192.168.73.132</span></span><br><span class="line">Last login: Tue Apr 16 13:50:51 2019 from 192.168.73.1</span><br><span class="line">[root@centos7 ~]<span class="comment"># ssh 192.168.73.128</span></span><br><span class="line">Last login: Tue Apr 16 21:50:38 2019 from 192.168.73.1</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>OpenSSH</tag>
      </tags>
  </entry>
  <entry>
    <title>SSH端口转发</title>
    <url>/2019/03/12/Linux%E5%9F%BA%E7%A1%80/openssh%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/openssh%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/</url>
    <content><![CDATA[<h2 id="SSH端口转发"><a href="#SSH端口转发" class="headerlink" title="SSH端口转发"></a>SSH端口转发</h2><p>SSH会自动加密和解密所有SSH客户端与服务端之间的网络数据。但是ssh还能够将其他TCP端口的网络数据通过SSH连接来转发，并自动提供了相应的加密及解密服务。这一过程也被叫做隧道，这是应为SSH为其他TCP链接提供了一个安全的通道来进行传输而得名。例如，Telnet,SMTP,LDAP这些TCP应用均能够从中得益，避免了用户名，密码以及隐私信息的明文传输。而于此同时，如果工作环境中的防火请限制了一些些网络端口的使用，但是允许SSh的连接，也能够通过将tcp端口转发来使用ssh进行通讯。</p>
<span id="more"></span>

<p>SSH端口转发能够提供两大功能：</p>
<p>1.加密SSH Client端至SSH Server端之间的通讯数据。</p>
<p>2.突破防火墙的限制完成一些之前无法家里的TCP连接。</p>
<hr>
<p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -L localport: remotehost:remotehostport sshserver</span><br><span class="line">ssh -R localport:remotehost:remotehostport sshserver</span><br><span class="line">ssh -D localport root@sshserver -fNg</span><br><span class="line"></span><br><span class="line">localport:本地端口  </span><br><span class="line">remotehost:目标主机  </span><br><span class="line">remotehostport:目标主机端口  </span><br><span class="line">sshserver:ssh服务器  </span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-f</td>
<td align="left">后台启用</td>
</tr>
<tr>
<td align="left">-N</td>
<td align="left">不打开远程shell,处于等待状态</td>
</tr>
<tr>
<td align="left">-g</td>
<td align="left">启用网关功能</td>
</tr>
<tr>
<td align="left">-L</td>
<td align="left">本地转发</td>
</tr>
<tr>
<td align="left">-R</td>
<td align="left">远程转发</td>
</tr>
<tr>
<td align="left">-D</td>
<td align="left">动态端口转发</td>
</tr>
</tbody></table>
<hr>
<h2 id="本地转发实现"><a href="#本地转发实现" class="headerlink" title="本地转发实现"></a>本地转发实现</h2><p>有A、B、C三台主机，主机C为telnet服务器且只能由主机B去连接，主机B为ssh服务器，实现坐在主机A上通过telnet服务直接去连接主机C</p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">192.168.73.128</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">192.168.73.132</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">192.168.73.133</td>
</tr>
</tbody></table>
<p>在主机C上安装telnet服务并启用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostc ~]<span class="comment"># yum install telnet-server -y</span></span><br><span class="line">[root@hostc ~]<span class="comment"># systemctl start telnet.socket </span></span><br></pre></td></tr></table></figure>

<p>在主机C上将主机A加入防火墙</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostc ~]<span class="comment"># iptables -A INPUT -s 192.168.73.128 -j REJECT</span></span><br></pre></td></tr></table></figure>

<p>环境准备完毕</p>
<h3 id="配置本地转发"><a href="#配置本地转发" class="headerlink" title="配置本地转发"></a>配置本地转发</h3><p>在主机A上执行下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hosta ~]<span class="comment">#  ssh -L 12345:192.168.73.133:23 192.168.73.132 -fN</span></span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hosta ~]<span class="comment"># telnet 127.0.0.1 12345</span></span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line"></span><br><span class="line">Kernel 3.10.0-957.el7.x86_64 on an x86_64</span><br><span class="line">hostc login: masuri</span><br><span class="line">Password: </span><br><span class="line">Last login: Wed Apr 17 00:55:35 from ::ffff:192.168.73.132</span><br><span class="line">[masuri@hostc ~]$ </span><br></pre></td></tr></table></figure>

<hr>
<h2 id="远程转发实现"><a href="#远程转发实现" class="headerlink" title="远程转发实现"></a>远程转发实现</h2><p>主机A被防火墙阻挡无法直接访问主机B和主机C，主机B可以访问主机A和主机C，此时主机A若要访问主机C，就需要主机B先去访问主机A为其建立起通道。</p>
<h3 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h3><table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">192.168.73.128</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">192.168.73.132</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">192.168.73.133</td>
</tr>
</tbody></table>
<p>在主机C上将主机A加入防火墙</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostc ~]<span class="comment"># iptables -A INPUT -s 192.168.73.128 -j REJECT</span></span><br></pre></td></tr></table></figure>

<p>在主机B上将主机A加入防火墙</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostb ~]<span class="comment"># iptables -A INPUT -s 192.168.73.128 -j REJECT</span></span><br></pre></td></tr></table></figure>

<p>实验环境准备完毕</p>
<h3 id="配置远程转发"><a href="#配置远程转发" class="headerlink" title="配置远程转发"></a>配置远程转发</h3><p>在主机B上去访问主机A，为其建立起通道</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostb ~]<span class="comment"># ssh -R 9527:192.168.73.133:23 192.168.73.128 -fN</span></span><br><span class="line">root@192.168.73.128<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">[root@hostb ~]# </span></span><br><span class="line"><span class="string">#此时本机的9527和A主机的9527端口已经建立起连接</span></span><br></pre></td></tr></table></figure>

<p>在主机A上使用telenet访问本机的9527端口来连接主机C</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hosta ~]<span class="comment"># telnet 127.0.0.1 9527</span></span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line"></span><br><span class="line">Kernel 3.10.0-957.el7.x86_64 on an x86_64</span><br><span class="line">hostc login: masuri</span><br><span class="line">Password: </span><br><span class="line">Last login: Wed Apr 17 01:01:49 from ::ffff:192.168.73.132</span><br><span class="line">[masuri@hostc ~]$ </span><br></pre></td></tr></table></figure>

<hr>
<h2 id="动态端口转发（适用于Linux翻墙）"><a href="#动态端口转发（适用于Linux翻墙）" class="headerlink" title="动态端口转发（适用于Linux翻墙）"></a>动态端口转发（适用于Linux翻墙）</h2><p>当访问本机的1080端口号，自动将请求发送给虚拟机，虚拟机带为转发请求去访问网站，网站接受到请求，返回页面给虚拟机，虚拟机再转发给本机。</p>
<h3 id="环境准备-2"><a href="#环境准备-2" class="headerlink" title="环境准备"></a>环境准备</h3><p>主机A无法访问到主机C，主机A能和主机B，主机B能访问主机C</p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">192.168.73.128</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">192.168.73.132</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">192.168.73.133</td>
</tr>
</tbody></table>
<p>在主机C上将主机A加入防火墙</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostc ~]<span class="comment"># iptables -A INPUT -s 192.168.73.128 -j REJECT</span></span><br></pre></td></tr></table></figure>

<p>在主机C上建立http服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostc ~]<span class="comment"># yum install httpd -y</span></span><br><span class="line">[root@hostc html]<span class="comment"># echo &quot;www.mylinuxops.com&quot; &gt; index.html</span></span><br><span class="line">[root@hostc html]<span class="comment"># systemctl start httpd</span></span><br></pre></td></tr></table></figure>

<p>在主机A上访问主机C</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hosta ~]<span class="comment"># curl 192.168.73.133</span></span><br><span class="line">curl: (7) Failed connect to 192.168.73.133:80; Connection refused</span><br></pre></td></tr></table></figure>

<p>环境预备完毕</p>
<h3 id="配置动态端口转发"><a href="#配置动态端口转发" class="headerlink" title="配置动态端口转发"></a>配置动态端口转发</h3><p>在主机A上将主机B设置为代理服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hosta ~]<span class="comment"># ssh -D 1080 root@192.168.73.132 -fNg</span></span><br><span class="line">root@192.168.73.132<span class="string">&#x27;s password: </span></span><br></pre></td></tr></table></figure>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>在主机A使用本机的1080端口位去访问主机C的httpd服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hosta ~]<span class="comment"># curl --socks5 127.0.0.1:1080 192.168.73.133</span></span><br><span class="line">www.mylinuxops.com</span><br></pre></td></tr></table></figure>

<p>此方法可以实现翻墙，不过仅限于主机b和主机C为linux系统，以下实现当主机A为windows系统时也能访问主机C</p>
<hr>
<h2 id="动态端口转发（适用于windows翻墙）"><a href="#动态端口转发（适用于windows翻墙）" class="headerlink" title="动态端口转发（适用于windows翻墙）"></a>动态端口转发（适用于windows翻墙）</h2><h3 id="环境准备-3"><a href="#环境准备-3" class="headerlink" title="环境准备"></a>环境准备</h3><p>主机A无法访问到主机C，主机A能和主机B，主机B能访问主机C</p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">192.168.73.128</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">192.168.73.132</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">192.168.73.133</td>
</tr>
</tbody></table>
<p>在主机C上将主机A加入防火墙</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostc ~]<span class="comment"># iptables -A INPUT -s 192.168.73.128 -j REJECT</span></span><br></pre></td></tr></table></figure>

<p>在主机C上建立http服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostc ~]<span class="comment"># yum install httpd -y</span></span><br><span class="line">[root@hostc html]<span class="comment"># echo &quot;www.mylinuxops.com&quot; &gt; index.html</span></span><br><span class="line">[root@hostc html]<span class="comment"># systemctl start httpd</span></span><br></pre></td></tr></table></figure>

<p>在主机A上访问主机C</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hosta ~]<span class="comment"># curl 192.168.73.133</span></span><br><span class="line">curl: (7) Failed connect to 192.168.73.133:80; Connection refused</span><br></pre></td></tr></table></figure>

<p>环境预备完毕</p>
<h3 id="配置动态端口转发-1"><a href="#配置动态端口转发-1" class="headerlink" title="配置动态端口转发"></a>配置动态端口转发</h3><p>在主机B上开启sshd的网关功</p>
<p>修改/etc/ssh/sshd_config文件，将GatewayPorts项修改为yes</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostb ~]<span class="comment"># vim /etc/ssh/sshd_config </span></span><br><span class="line">GatewayPorts yes</span><br></pre></td></tr></table></figure>

<p>在主机B上打开本地端口作为网关实现端口转发</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostb ~]<span class="comment"># vim /etc/ssh/sshd_config </span></span><br><span class="line">[root@hostb ~]<span class="comment"># ssh -gD 9527 localhost</span></span><br><span class="line">root@localhost<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Last failed login: Wed Apr 17 03:25:53 CST 2019 from 192.168.73.128 on ssh:notty</span></span><br><span class="line"><span class="string">There was 1 failed login attempt since the last successful login.</span></span><br><span class="line"><span class="string">Last login: Wed Apr 17 03:12:13 2019 from 192.168.73.1</span></span><br><span class="line"><span class="string">[root@hostb ~]#</span></span><br></pre></td></tr></table></figure>

<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><p>在主机A上将主机B作为代理服务器去访问A</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hosta ~]<span class="comment"># curl --socks5 192.168.73.132:9527 192.168.73.133 </span></span><br><span class="line">www.mylinuxops.com</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>OpenSSH</tag>
      </tags>
  </entry>
  <entry>
    <title>pxe自动化安装系统</title>
    <url>/2019/03/11/Linux%E5%9F%BA%E7%A1%80/pxe%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F/pxe%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<h2 id="pxe自动化安装系统"><a href="#pxe自动化安装系统" class="headerlink" title="pxe自动化安装系统"></a>pxe自动化安装系统</h2><p>pxe自动化安装，所需要的服务有：dhcp服务器，tftp服务器，http服务器 </p>
<p>pxe自动化安装，所需要的包组及相关安装文件有：syslinux以及自动化安装系统所需的应答文件selinux</p>
<span id="more"></span>

<hr>
<p>实验说明： </p>
<p>本次实验以一台CentOS7作为dhcp服务器，tftp服务器，以及http服务器向本网段内的主机提供自动化安装CentOS系统  </p>
<p>准备工作：  </p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">系统</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CentOS7</td>
<td align="left">CentOS7</td>
<td align="left">192.168.73.120</td>
</tr>
</tbody></table>
<hr>
<h3 id="一、安装dhcp服务、tftp-server服务、httpd服务及syslinux包组"><a href="#一、安装dhcp服务、tftp-server服务、httpd服务及syslinux包组" class="headerlink" title="一、安装dhcp服务、tftp-server服务、httpd服务及syslinux包组"></a>一、安装dhcp服务、tftp-server服务、httpd服务及syslinux包组</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum install dhcp tftp-server httpd syslinux -y</span></span><br></pre></td></tr></table></figure>
<h3 id="二、创建应答文件"><a href="#二、创建应答文件" class="headerlink" title="二、创建应答文件"></a>二、创建应答文件</h3><p>1.使用system-config-kickstart生成ks6.cfg</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># system-config-kickstart</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim ks6.cfg</span></span><br><span class="line"><span class="comment">#platform=x86, AMD64, or Intel EM64T</span></span><br><span class="line"><span class="comment">#version=DEVEL</span></span><br><span class="line"><span class="comment"># Firewall configuration</span></span><br><span class="line">firewall --disabled</span><br><span class="line"><span class="comment"># Install OS instead of upgrade</span></span><br><span class="line">install</span><br><span class="line"><span class="comment"># Use network installation</span></span><br><span class="line">url --url=<span class="string">&quot;http://192.168.73.120/centos/6/os/x86_64&quot;</span></span><br><span class="line"><span class="comment"># Root password</span></span><br><span class="line">rootpw --iscrypted $1$6oVXZR1R<span class="variable">$QOASc6inirmHCZmQ</span>.W9Hg0</span><br><span class="line"><span class="comment"># System authorization information</span></span><br><span class="line">auth  --useshadow  --passalgo=sha512</span><br><span class="line"><span class="comment"># Use text mode install</span></span><br><span class="line">text</span><br><span class="line"><span class="comment"># System keyboard</span></span><br><span class="line">keyboard us</span><br><span class="line"><span class="comment"># System language</span></span><br><span class="line">lang en_US</span><br><span class="line"><span class="comment"># SELinux configuration</span></span><br><span class="line">selinux --disabled</span><br><span class="line"><span class="comment"># Do not configure the X Window System</span></span><br><span class="line">skipx</span><br><span class="line"><span class="comment"># Installation logging level</span></span><br><span class="line">logging --level=info</span><br><span class="line"><span class="comment"># Reboot after installation</span></span><br><span class="line">reboot</span><br><span class="line"><span class="comment"># System timezone</span></span><br><span class="line">timezone  Asia/Shanghai</span><br><span class="line"><span class="comment"># Network information</span></span><br><span class="line">network  --bootproto=dhcp --device=eth0 --onboot=on</span><br><span class="line"><span class="comment"># System bootloader configuration</span></span><br><span class="line">bootloader --location=mbr</span><br><span class="line"><span class="comment"># Clear the Master Boot Record</span></span><br><span class="line">zerombr</span><br><span class="line"><span class="comment"># Partition clearing information</span></span><br><span class="line">clearpart --all --initlabel </span><br><span class="line"><span class="comment"># Disk partitioning information</span></span><br><span class="line">part /boot --fstype=<span class="string">&quot;ext4&quot;</span> --size=200</span><br><span class="line">part / --fstype=<span class="string">&quot;ext4&quot;</span> --size=20000</span><br><span class="line">part swap --fstype=<span class="string">&quot;swap&quot;</span> --size=1024</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">@core</span><br><span class="line"></span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>2.复制ks6.cfg为ks7.cfg，并修改部分参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cp ks6.cfg ks7.cfg</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim ks7.cfg</span></span><br><span class="line"><span class="comment">#platform=x86, AMD64, or Intel EM64T</span></span><br><span class="line"><span class="comment">#version=DEVEL</span></span><br><span class="line"><span class="comment"># Firewall configuration</span></span><br><span class="line">firewall --disabled</span><br><span class="line"><span class="comment"># Install OS instead of upgrade</span></span><br><span class="line">install</span><br><span class="line"><span class="comment"># Use network installation</span></span><br><span class="line">url --url=<span class="string">&quot;http://192.168.73.120/centos/7/os/x86_64&quot;</span>    <span class="comment">#将url改为7的url</span></span><br><span class="line"><span class="comment"># Root password</span></span><br><span class="line">rootpw --iscrypted $1$6oVXZR1R<span class="variable">$QOASc6inirmHCZmQ</span>.W9Hg0</span><br><span class="line"><span class="comment"># System authorization information</span></span><br><span class="line">auth  --useshadow  --passalgo=sha512</span><br><span class="line"><span class="comment"># Use text mode install</span></span><br><span class="line">text</span><br><span class="line"><span class="comment"># System keyboard</span></span><br><span class="line">keyboard us</span><br><span class="line"><span class="comment"># System language</span></span><br><span class="line">lang en_US</span><br><span class="line"><span class="comment"># SELinux configuration</span></span><br><span class="line">selinux --disabled</span><br><span class="line"><span class="comment"># Do not configure the X Window System</span></span><br><span class="line">skipx</span><br><span class="line"><span class="comment"># Installation logging level</span></span><br><span class="line">logging --level=info</span><br><span class="line"><span class="comment"># Reboot after installation</span></span><br><span class="line">reboot</span><br><span class="line"><span class="comment"># System timezone</span></span><br><span class="line">timezone  Asia/Shanghai</span><br><span class="line"><span class="comment"># Network information</span></span><br><span class="line">network  --bootproto=dhcp --device=ens33 --onboot=on      <span class="comment">#将网卡名修改为ens33</span></span><br><span class="line"><span class="comment"># System bootloader configuration</span></span><br><span class="line">bootloader --location=mbr</span><br><span class="line"><span class="comment"># Clear the Master Boot Record</span></span><br><span class="line">zerombr</span><br><span class="line"><span class="comment"># Partition clearing information</span></span><br><span class="line">clearpart --all --initlabel </span><br><span class="line"><span class="comment"># Disk partitioning information</span></span><br><span class="line">part /boot --fstype=<span class="string">&quot;ext4&quot;</span> --size=200</span><br><span class="line">part / --fstype=<span class="string">&quot;ext4&quot;</span> --size=20000</span><br><span class="line">part swap --fstype=<span class="string">&quot;swap&quot;</span> --size=1024</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">@core</span><br><span class="line"></span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h3 id="三、配置httpd服务"><a href="#三、配置httpd服务" class="headerlink" title="三、配置httpd服务"></a>三、配置httpd服务</h3><p>1.创建http目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mkdir -pv /var/www/html/&#123;centos/&#123;6,7&#125;/os/x86_64,ksdir&#125;</span></span><br><span class="line">mkdir: created directory ‘/var/www/html/centos’</span><br><span class="line">mkdir: created directory ‘/var/www/html/centos/6’</span><br><span class="line">mkdir: created directory ‘/var/www/html/centos/6/os’</span><br><span class="line">mkdir: created directory ‘/var/www/html/centos/6/os/x86_64’</span><br><span class="line">mkdir: created directory ‘/var/www/html/centos/7’</span><br><span class="line">mkdir: created directory ‘/var/www/html/centos/7/os’</span><br><span class="line">mkdir: created directory ‘/var/www/html/centos/7/os/x86_64’</span><br><span class="line">mkdir: created directory ‘/var/www/html/ksdir’</span><br></pre></td></tr></table></figure>

<p>2.将CentOS6及7的光盘文件挂在至相关的目录下(工作中可以直接将光盘镜像复制至目录下)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># lsblk | grep sr</span></span><br><span class="line">sr0     11:0    1   10G  0 rom  /mnt</span><br><span class="line">sr1     11:1    1  3.7G  0 rom  </span><br><span class="line">[root@centos7 ~]<span class="comment"># mount /dev/sr0 /var/www/html/centos/7/os/x86_64/</span></span><br><span class="line">mount: /dev/sr0 is write-protected, mounting read-only</span><br><span class="line">[root@centos7 ~]<span class="comment"># mount /dev/sr1 /var/www/html/centos/6/os/x86_64/</span></span><br><span class="line">mount: /dev/sr1 is write-protected, mounting read-only</span><br><span class="line">[root@centos7 ~]<span class="comment"># lsblk | grep sr</span></span><br><span class="line">sr0     11:0    1   10G  0 rom  /var/www/html/centos/7/os/x86_64</span><br><span class="line">sr1     11:1    1  3.7G  0 rom  /var/www/html/centos/6/os/x86_64</span><br></pre></td></tr></table></figure>

<p>3.将准备好的应答文件复制至目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cp ks6.cfg /var/www/html/ksdir</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cp ks7.cfg /var/www/html/ksdir</span></span><br></pre></td></tr></table></figure>

<p>4.启动httpd服务，并设置为开机自动启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># systemctl start httpd</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl enable httpd</span></span><br></pre></td></tr></table></figure>

<h3 id="四、配置tftp服务器"><a href="#四、配置tftp服务器" class="headerlink" title="四、配置tftp服务器"></a>四、配置tftp服务器</h3><p>1.在tftp工作目录下创建出相关的文件目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mkdir -pv /var/lib/tftpboot/&#123;kernel&#123;6,7&#125;,pxelinux.cfg&#125;</span></span><br><span class="line">mkdir: created directory ‘/var/lib/tftpboot/kernel6’</span><br><span class="line">mkdir: created directory ‘/var/lib/tftpboot/kernel7’</span><br><span class="line">mkdir: created directory ‘/var/lib/tftpboot/pxelinux.cfg’</span><br></pre></td></tr></table></figure>

<p>2.将centos6和centos7的内核及虚拟文件系统复制至tftp工作目录下的相对应kernel目录中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 tftpboot]<span class="comment"># cd /var/lib/tftpboot/kernel6</span></span><br><span class="line">[root@centos7 kernel6]<span class="comment"># cp /var/www/html/centos/6/os/x86_64/isolinux/vmlinuz .</span></span><br><span class="line">[root@centos7 kernel6]<span class="comment"># cp /var/www/html/centos/6/os/x86_64/isolinux/initrd.img .</span></span><br><span class="line">[root@centos7 kernel6]<span class="comment"># cd /var/lib/tftpboot/kernel7</span></span><br><span class="line">[root@centos7 kernel7]<span class="comment"># cp /var/www/html/centos/7/os/x86_64/isolinux/vmlinuz .</span></span><br><span class="line">[root@centos7 kernel7]<span class="comment"># cp /var/www/html/centos/7/os/x86_64/isolinux/initrd.img .</span></span><br></pre></td></tr></table></figure>

<p>3.复制启动相关的文件至tftp工作目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 kernel7]<span class="comment"># cd /var/lib/tftpboot/</span></span><br><span class="line">[root@centos7 tftpboot]<span class="comment"># cp /usr/share/syslinux/menu.c32 .</span></span><br><span class="line">[root@centos7 tftpboot]<span class="comment"># cp /usr/share/syslinux/pxelinux.0 .</span></span><br></pre></td></tr></table></figure>

<p>4.复制光盘上的菜单文件至/var/lib/tftpboot/pxelinux.cfg目录下改名为default，修改此文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 tftpboot]<span class="comment"># cp /var/www/html/centos/7/os/x86_64/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default</span></span><br><span class="line">[root@centos7 tftpboot]<span class="comment"># vim /var/lib/tftpboot/pxelinux.cfg/default</span></span><br><span class="line">default menu.c32            <span class="comment">#将此行改为menu.c32</span></span><br><span class="line">timeout 600</span><br><span class="line"></span><br><span class="line">menu title CentOS install</span><br><span class="line"></span><br><span class="line">label linux 6</span><br><span class="line">  menu label Install CentOS ^6</span><br><span class="line">  kernel kernel6/vmlinuz    <span class="comment">#此处为centos6内核所在的路径</span></span><br><span class="line">  append initrd=kernel6/initrd.img ks=http://192.168.73.120/ksdir/ks6.cfg               <span class="comment">#指定KS文件在网络中的位置</span></span><br><span class="line"></span><br><span class="line">label linux 7</span><br><span class="line">  menu label Install CentOS ^7</span><br><span class="line">  kernel kernel7/vmlinuz    <span class="comment">#此处为centos7内核所在的路径</span></span><br><span class="line">  append initrd=kernel7/initrd.img ks=http://192.168.73.120/ksdir/ks7.cfg               <span class="comment">#指定KS文件在网路中的位置</span></span><br><span class="line"></span><br><span class="line">label <span class="built_in">local</span></span><br><span class="line">  menu label Boot from ^<span class="built_in">local</span> drive</span><br><span class="line">  localboot 0xffff</span><br></pre></td></tr></table></figure>

<p>5.查看下目录结构</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 tftpboot]<span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── centos6</span><br><span class="line">│   ├── initrd.img</span><br><span class="line">│   └── vmlinuz</span><br><span class="line">├── centos7</span><br><span class="line">│   ├── initrd.img</span><br><span class="line">│   └── vmlinuz</span><br><span class="line">├── menu.c32</span><br><span class="line">├── pxelinux.0</span><br><span class="line">└── pxelinux.cfg</span><br><span class="line">    └── default</span><br></pre></td></tr></table></figure>

<p>6.启动tftp服务，并设置为开机启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># systemctl start tftp</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl enable tftp</span></span><br></pre></td></tr></table></figure>

<h3 id="五、配置dhcp服务"><a href="#五、配置dhcp服务" class="headerlink" title="五、配置dhcp服务"></a>五、配置dhcp服务</h3><p>1.由于dhcpd默认的配置文件为空，此处将dhcpd的样板配置文件复制后加以修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cp /usr/share/doc/dhcp-4.2.5/dhcpd.conf.example /etc/dhcp/dhcpd.conf</span></span><br><span class="line">cp: overwrite ‘/etc/dhcp/dhcpd.conf’? y</span><br></pre></td></tr></table></figure>

<p>2.配置dhcp服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/dhcp/dhcpd.conf</span></span><br><span class="line"><span class="comment"># option definitions common to all supported networks...</span></span><br><span class="line">option domain-name <span class="string">&quot;mylinuxops.com&quot;</span>;                <span class="comment">#指定预添加域名</span></span><br><span class="line">option domain-name-servers 114.114.114.114;         <span class="comment">#指定DNS服务器</span></span><br><span class="line"></span><br><span class="line">default-lease-time 6000;</span><br><span class="line">max-lease-time 72000;</span><br><span class="line"></span><br><span class="line">...中间省略...</span><br><span class="line"></span><br><span class="line"><span class="comment"># No service will be given on this subnet, but declaring it helps the </span></span><br><span class="line"><span class="comment"># DHCP server to understand the network topology.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#subnet 10.152.187.0 netmask 255.255.255.0 &#123;    #注释</span></span><br><span class="line"><span class="comment">#&#125;                                              #注释</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is a very basic subnet declaration.</span></span><br><span class="line"></span><br><span class="line">subnet 192.168.73.0 netmask 255.255.255.224 &#123;</span><br><span class="line">  range 192.168.73.1 192.168.73.100;        <span class="comment">#指定dhcp地址池</span></span><br><span class="line">  option routers 192.168.73.254;            <span class="comment">#指定网关</span></span><br><span class="line">  filename <span class="string">&quot;pxelinux.0&quot;</span>;                    <span class="comment">#指定启动文件</span></span><br><span class="line">  next-server 192.168.73.120;               <span class="comment">#指定tftp服务器路径</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.启动dhcp服务器，并设置为开机自动启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># systemctl start dhcpd</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl enable dhcpd</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/dhcpd.service to /usr/lib/systemd/system/dhcpd.service.</span><br></pre></td></tr></table></figure>

<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>以上为pxe自动化安装的全过程，有几点细节需要注意：</p>
<p>1.所有服务部署完毕，进行测试之前，确保网络中没有其他的DHCP服务，避免产生干扰。</p>
<p>2.centos7在自动化安装时需要1G以上的内存空间。</p>
<p>3.安装时注意物理磁盘的大小以及ks文件中的磁盘大小 ，确保有足够的空间进行安装。</p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>自动化安装系统</tag>
      </tags>
  </entry>
  <entry>
    <title>sshd的配置和优化</title>
    <url>/2019/03/12/Linux%E5%9F%BA%E7%A1%80/sshd%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/sshd%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
    <content><![CDATA[<h2 id="sshd的配置和优化"><a href="#sshd的配置和优化" class="headerlink" title="sshd的配置和优化"></a>sshd的配置和优化</h2><p>sshd服务器端的配置文件为/etc/ssh_config  </p>
<span id="more"></span>

<h3 id="配置文件中的一些常用参数"><a href="#配置文件中的一些常用参数" class="headerlink" title="配置文件中的一些常用参数"></a>配置文件中的一些常用参数</h3><table>
<thead>
<tr>
<th align="left">常用参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">port</td>
<td align="left">监听端口号</td>
</tr>
<tr>
<td align="left">ListenAddress ip</td>
<td align="left">监听的IP地址</td>
</tr>
<tr>
<td align="left">LoginGraceTime</td>
<td align="left">发起连接后多少时间内必须登录超时断开连接</td>
</tr>
<tr>
<td align="left">PermitRootLogin</td>
<td align="left">是否允许root登录</td>
</tr>
<tr>
<td align="left">StrictModes</td>
<td align="left">检查.ssh/文件的所有者，权限等</td>
</tr>
<tr>
<td align="left">MaxAuthTries</td>
<td align="left">最大密码尝试次数</td>
</tr>
<tr>
<td align="left">MaxSessions</td>
<td align="left">同一连接的最大绘会话数</td>
</tr>
<tr>
<td align="left">PubkeyAuthentication</td>
<td align="left">基于Key验证</td>
</tr>
<tr>
<td align="left">PermitEmptyPasswords</td>
<td align="left">是否使用空口令登录</td>
</tr>
<tr>
<td align="left">PasswordAuthentication</td>
<td align="left">基于口令验证</td>
</tr>
<tr>
<td align="left">GatewayPorts</td>
<td align="left">ssh服务监听所使用的端口当网关使用</td>
</tr>
<tr>
<td align="left">ClientAliveInterval</td>
<td align="left">间隔多久客户端和服务器端没有操作就断开连接</td>
</tr>
<tr>
<td align="left">ClientAliveCountMax</td>
<td align="left">和上面那项一起使用为检查的次数</td>
</tr>
<tr>
<td align="left">UseDNS</td>
<td align="left">是否使用名称解析</td>
</tr>
<tr>
<td align="left">GSSAPIAuthentication</td>
<td align="left">GSSAPI的认证</td>
</tr>
<tr>
<td align="left">MaxStartups</td>
<td align="left">未验证的最大连接数</td>
</tr>
<tr>
<td align="left">Banner</td>
<td align="left">登录前提示</td>
</tr>
<tr>
<td align="left">AllowUsers</td>
<td align="left">允许哪些用户登录（白名单）</td>
</tr>
<tr>
<td align="left">DenyUsers</td>
<td align="left">不允许哪些用户登录（黑名单）</td>
</tr>
<tr>
<td align="left">AllowGroups</td>
<td align="left">允许哪些组登录（白名单）</td>
</tr>
<tr>
<td align="left">DenyGroups</td>
<td align="left">不允许哪些组登录（黑名单）</td>
</tr>
</tbody></table>
<h3 id="配置详细用法"><a href="#配置详细用法" class="headerlink" title="配置详细用法"></a>配置详细用法</h3><p>1.port  </p>
<p>在生产环境中建议将此端口改为非标准端口，防止被人恶意猜测密码。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line">Port 2222</span><br><span class="line">[root@HostA ~]<span class="comment"># service sshd restart</span></span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#此时sshd服务已经监听在2222端口上</span></span><br><span class="line">[root@HostA ~]<span class="comment"># lsof -i:2222</span></span><br><span class="line">COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">sshd    2424 root    3u  IPv4  13945      0t0  TCP *:EtherNet/IP-1 (LISTEN)</span><br><span class="line">sshd    2424 root    4u  IPv6  13947      0t0  TCP *:EtherNet/IP-1 (LISTEN)</span><br></pre></td></tr></table></figure>

<p>2.LinstenAddress  </p>
<p>若本机有多个ip地址，可以指定用哪个地址提供sshd服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line">Port 2222</span><br><span class="line">ListenAddress 172.22.27.12</span><br><span class="line">[root@HostA ~]<span class="comment"># service sshd restart</span></span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#此时sshd服务监听在172.22.27.124的2222端口上</span></span><br><span class="line">[root@HostA ~]<span class="comment"># ss -tnl |grep 2222</span></span><br><span class="line">LISTEN     0      128           172.22.27.124:2222                     *:*  </span><br></pre></td></tr></table></figure>

<p>3.LoginGraceTime  </p>
<p>此项表示有多少用户发起ssh连接后多少时间内必须输入密码登录，否则断开连接默认为2分钟</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#LoginGraceTime 2m</span></span><br></pre></td></tr></table></figure>

<p>4.PermitRootLogin</p>
<p>是否允许root用户登录，在生产环境中，最好禁止root用户直接登录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line">Port 2222</span><br><span class="line">ListenAddress 172.22.27.12</span><br><span class="line">PermitRootLogin no </span><br><span class="line"></span><br><span class="line">重启sshd服务</span><br><span class="line">[root@HostA ~]<span class="comment"># service sshd restart</span></span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#此时使用root账户已经无法登录</span></span><br><span class="line">[root@HostA ~]<span class="comment"># ssh -p 2222 root@172.22.27.124</span></span><br><span class="line">The authenticity of host <span class="string">&#x27;[172.22.27.124]:2222 ([172.22.27.124]:2222)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">RSA key fingerprint is 46:d8:67:07:f3:51:87:95:2c:d7:4b:27:ce:85:a2:ed.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>[172.22.27.124]:2222<span class="string">&#x27; (RSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">root@172.22.27.124&#x27;</span>s password: </span><br><span class="line">Permission denied, please try again.</span><br><span class="line">root@172.22.27.124<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Permission denied, please try again.</span></span><br><span class="line"><span class="string">root@172.22.27.124&#x27;</span>s password: </span><br><span class="line">Permission denied (publickey,password).</span><br></pre></td></tr></table></figure>

<p>5.MaxAuthTries</p>
<p>最大密码尝试次数默认为3次，尝试次数为此项后的值的一半</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line"><span class="comment">#MaxAuthTries 6</span></span><br></pre></td></tr></table></figure>

<p>6.MaxSessions</p>
<p>同一连接的最大会话个数，默认为10个</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line">MaxSessions 3</span><br><span class="line"></span><br><span class="line">重启服务</span><br><span class="line">[root@HostA ~]<span class="comment"># service sshd restart</span></span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">此时克隆会话时最多只能克隆3个在多就会拒绝</span><br></pre></td></tr></table></figure>

<p>7.PubkeyAuthentication</p>
<p>基于Key验证，登录时使用密钥验证，此项默认开启生产环境中最好使用key验证。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line"><span class="comment">#PubkeyAuthentication yes</span></span><br></pre></td></tr></table></figure>

<p>8.PermitEmptyPasswords</p>
<p>是否使用空口令登录，生产环境中使用空口令登录是非常危险的，所以此处默认也是禁止的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line"><span class="comment">#PermitEmptyPasswords no</span></span><br></pre></td></tr></table></figure>

<p>9.PasswordAuthentication</p>
<p>基于口令验证，默认为开启。生产环境中建议禁用口令登录。只开启密钥登陆</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line">PasswordAuthentication yes</span><br></pre></td></tr></table></figure>

<p>10.GatewayPorts  </p>
<p>ssh服务监听所使用的端口当网关使用  </p>
<p>此项用法可参考端口转发</p>
<p>11.ClientAliveInterval和ClientAliveCountMax</p>
<p>ClientAliveInterval:连接后多久没有操作则断开</p>
<p>ClientAliveCountMax:检测几次后发现没有操作断开，此项和上一项结合一起使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line"><span class="comment">#ClientAliveInterval 0             #0表示不限制时间</span></span><br><span class="line"><span class="comment">#ClientAliveCountMax 3</span></span><br></pre></td></tr></table></figure>

<p>11.UseDNS和GSSAPIAuthentication  </p>
<p>此处2项建议关闭，能加速ssh的连接速度</p>
<p>12.MaxStartups  </p>
<p>未验证的最大连接数，默认的10:30:100表示，ssh连接进入前10个链接能全部连接上，当连接数大于10个就以30%的纪律随机拒绝登陆，连接数超过100个全部拒绝</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line">MaxStartups 10:30:100</span><br></pre></td></tr></table></figure>

<p>12.Banner  </p>
<p>登录前提示，在选项后跟上路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config</span></span><br><span class="line">Banner /data/hello</span><br><span class="line">[root@HostA ~]<span class="comment"># echo hello &gt; /data/hello    #创建一个hello的文件</span></span><br><span class="line"><span class="comment">#重启服务</span></span><br><span class="line">[root@HostA ~]<span class="comment"># service sshd restart</span></span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root@HostA ~]<span class="comment"># ssh -p 2222 masuri@172.22.27.124</span></span><br><span class="line">hello                                       <span class="comment">#所创建的登录前提示</span></span><br><span class="line">masuri@172.22.27.124<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>13、AllowUsers、DenyUsers、AllowGroups、DenyGroups  </p>
<p>此处4项为用户和组的黑白名单</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ssh/sshd_config </span></span><br><span class="line">DenyUsers wang                      <span class="comment">#将wang用户加入黑名单</span></span><br><span class="line"><span class="comment">#重启服务</span></span><br><span class="line">[root@HostA ~]<span class="comment"># service sshd restart</span></span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@HostA ~]<span class="comment"># useradd wang</span></span><br><span class="line">[root@HostA ~]<span class="comment"># echo 111111 | passwd --stdin wang</span></span><br><span class="line">Changing password <span class="keyword">for</span> user wang.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line"><span class="comment">#此时wang用户无法登陆</span></span><br><span class="line">[root@HostA ~]<span class="comment"># ssh -p 2222  wang@172.22.27.124</span></span><br><span class="line">hello</span><br><span class="line">wang@172.22.27.124<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Permission denied, please try again.</span></span><br><span class="line"><span class="string">wang@172.22.27.124&#x27;</span>s password: </span><br><span class="line">Permission denied, please try again.</span><br><span class="line">wang@172.22.27.124<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Permission denied (publickey,password).</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="生产环境中ssh服务最佳实践"><a href="#生产环境中ssh服务最佳实践" class="headerlink" title="生产环境中ssh服务最佳实践"></a>生产环境中ssh服务最佳实践</h2><p>1.建议使用非默认端口  </p>
<p>修改port    </p>
<p>2.禁止使用protocol version 1   </p>
<p>Protocol 2  </p>
<p>3.限制可登录用户</p>
<p>AllowUsers、DenyUsers、AllowGroups、DenyGroups   </p>
<p>4.设定空闲会话超时时长  </p>
<p>ClientAliveInterval和ClientAliveCountMax  </p>
<p>5.利用防火墙设置ssh访问策略  </p>
<p>设置iptables策略  </p>
<p>6.仅监听特定的IP地址  </p>
<p>修改Listen  </p>
<p>7.基于口令认证时，使用强密码策略  </p>
<p>使用难以猜测的随机口令，长度越长约好，并定期修改。  </p>
<p>8.使用基于密钥的认证  </p>
<p>使用密钥登陆，不使用口令  </p>
<p>9.禁止使用空密码  </p>
<p>PermitEmptyPasswords no  </p>
<p>10.禁止root用户直接登录  </p>
<p>PermitRootLogin  </p>
<p>11.限制ssh的访问频度和并发在线数    </p>
<p>MaxStartups   </p>
<p>12.经常分析日志    </p>
<p>sshd的日志文件为/var/log/secure </p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>OpenSSH</tag>
      </tags>
  </entry>
  <entry>
    <title>swap分区</title>
    <url>/2019/03/05/Linux%E5%9F%BA%E7%A1%80/swap%E5%88%86%E5%8C%BA/swap%E5%88%86%E5%8C%BA/</url>
    <content><![CDATA[<h2 id="swap分区"><a href="#swap分区" class="headerlink" title="swap分区"></a>swap分区</h2><p>swap交换分区是系统RAM的补充，Swap分区支持虚拟内存。当没有足够的RAM保存系统处理的数据时会将数据写入swap分区，当系统缺乏swap空间时，内核会因RAM内存耗尽而终止进程。配置过多swap空间会造成存储设备处于分配状态但闲置，造成浪费，过多swap空间还会掩盖内存泄露，所以swap分区可以根据物理内存的大小来分配，物理内存过小时可以设置为物理内存的2倍，随着物理内存的逐渐增大，swap的倍数可以逐渐递减。</p>
<span id="more"></span>

<p>在实际生产中不建议使用swap分区来当内存使用，毕竟磁盘的性能要弱于内存数倍</p>
<p>以下为演示swap分区的各种创建方法：</p>
<h2 id="一、将分区创建为swap"><a href="#一、将分区创建为swap" class="headerlink" title="一、将分区创建为swap"></a>一、将分区创建为swap</h2><h3 id="1-划分分区"><a href="#1-划分分区" class="headerlink" title="1.划分分区"></a>1.划分分区</h3><p>新增一块硬盘sdb，对sdb进行分区</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># fdisk /dev/sdb</span></span><br><span class="line">Welcome to fdisk (util-linux 2.23.2).</span><br><span class="line"></span><br><span class="line">Changes will remain <span class="keyword">in</span> memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table</span><br><span class="line">Building a new DOS disklabel with disk identifier 0x9446b510.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition <span class="built_in">type</span>:</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p): </span><br><span class="line">Using default response p</span><br><span class="line">Partition number (1-4, default 1): </span><br><span class="line">First sector (2048-41943039, default 2048): </span><br><span class="line">Using default value 2048</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (2048-41943039, default 41943039): +1G</span><br><span class="line">Partition 1 of <span class="built_in">type</span> Linux and of size 1 GiB is <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): t</span><br><span class="line">Selected partition 1</span><br><span class="line">Hex code (<span class="built_in">type</span> L to list all codes): 82</span><br><span class="line">Changed <span class="built_in">type</span> of partition <span class="string">&#x27;Linux&#x27;</span> to <span class="string">&#x27;Linux swap / Solaris&#x27;</span></span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure>

<h3 id="2-创建swap文件系统"><a href="#2-创建swap文件系统" class="headerlink" title="2.创建swap文件系统"></a>2.创建swap文件系统</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mkswap /dev/sdb1</span></span><br><span class="line">Setting up swapspace version 1, size = 1048572 KiB</span><br><span class="line">no label, UUID=7d411e84-9e3e-416a-99a1-b81973b0001b</span><br></pre></td></tr></table></figure>

<h3 id="3-将swap文件系统写入fstab"><a href="#3-将swap文件系统写入fstab" class="headerlink" title="3.将swap文件系统写入fstab"></a>3.将swap文件系统写入fstab</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/fstab</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line"><span class="comment"># Created by anaconda on Tue Mar  5 21:07:19 2019</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;</span></span><br><span class="line"><span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">UUID=45490aa4-cf29-420d-a606-af32688b6707 /                       xfs     defaults        0 0</span><br><span class="line">UUID=17dcd896-b7cf-48d0-b8bd-4c0b0f2c62b2 /boot                   xfs     defaults        0 0</span><br><span class="line">UUID=4b6e1813-2c46-402a-869a-02cbbcb76ade /data                   xfs     defaults        0 0</span><br><span class="line">UUID=0995b444-48c1-4423-92bc-2deda0d3c082 swap                    swap    defaults        0 0</span><br><span class="line">UUID=7d411e84-9e3e-416a-99a1-b81973b0001b swap                  swap    defaults   0 0</span><br></pre></td></tr></table></figure>

<p>注意：pri=5为swap分区的优先级，由于此处使用的为新硬盘，磁盘最外圈的读写速度为最快所以将优先级调为5，比系统安装时的swap等级高</p>
<h3 id="4-挂载swap"><a href="#4-挂载swap" class="headerlink" title="4.挂载swap"></a>4.挂载swap</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># swapon /dev/sdb1</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># swapon -s</span></span><br><span class="line">Filename				Type		Size	Used	Priority</span><br><span class="line">/dev/sda5                              	partition	2097148	0	-2</span><br><span class="line">/dev/sdb1                              	partition	1048572	0	-3</span><br></pre></td></tr></table></figure>

<p>注意：由于此处使用的为新硬盘，磁盘最外圈的读写速度最快所以将优先级调至比sda5高，此处数字越大优先级越高</p>
<h3 id="5-调优先级"><a href="#5-调优先级" class="headerlink" title="5.调优先级"></a>5.调优先级</h3><p>首先需要将挂载的swap卸载</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># swapoff /dev/sdb1</span></span><br></pre></td></tr></table></figure>

<p>修改/etc/fstab文件,将default修改为5，比sda5的-2高就行。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UUID=7d411e84-9e3e-416a-99a1-b81973b0001b swap                  swap    pri=5   0 0</span><br></pre></td></tr></table></figure>

<p>重新挂载swap</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># swapon -a</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># swapon -s</span></span><br><span class="line">Filename				Type		Size	Used	Priority</span><br><span class="line">/dev/sda5                              	partition	2097148	0	-2</span><br><span class="line">/dev/sdb1                              	partition	1048572	0	5</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、将文件创建为swap"><a href="#二、将文件创建为swap" class="headerlink" title="二、将文件创建为swap"></a>二、将文件创建为swap</h2><p>由于某些场景下系统在创建时没有创建swap分区，并且系统上也没有多余的空间创建swap分区，此时可以考虑使用用文件来创建swap分区，具体操作方法如下：</p>
<h3 id="1-创建一个文件"><a href="#1-创建一个文件" class="headerlink" title="1.创建一个文件"></a>1.创建一个文件</h3><p>使用dd创建一个文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># dd if=/dev/zero of=swapfile bs=1M count=1024</span></span><br><span class="line">1024+0 records <span class="keyword">in</span></span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB) copied, 5.02973 s, 213 MB/s</span><br></pre></td></tr></table></figure>

<h3 id="2-对swapfile文件创建swap文件系统"><a href="#2-对swapfile文件创建swap文件系统" class="headerlink" title="2.对swapfile文件创建swap文件系统"></a>2.对swapfile文件创建swap文件系统</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mkswap swapfile </span></span><br><span class="line">Setting up swapspace version 1, size = 1048572 KiB</span><br><span class="line">no label, UUID=c7c8d93d-862b-48b1-aeb3-1390dbf2d6db</span><br></pre></td></tr></table></figure>

<h3 id="3-挂载swapfile文件"><a href="#3-挂载swapfile文件" class="headerlink" title="3.挂载swapfile文件"></a>3.挂载swapfile文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># swapon -a</span></span><br><span class="line">swapon: /root/swapfile: insecure permissions 0644, 0600 suggested.</span><br><span class="line">[root@centos7 ~]<span class="comment"># swapon -s</span></span><br><span class="line">Filename				Type		Size	Used	Priority</span><br><span class="line">/dev/sda5                              	partition	2097148	0	-2</span><br><span class="line">/dev/sdb1                              	partition	1048572	0	5</span><br><span class="line">/root/swapfile                         	file	1048572	0	-3</span><br></pre></td></tr></table></figure>

<p>注意：此处的报警为权限问题，0644的权限会造成其他用户可以读其中的内容所以此处需要将其权限设置为600</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># chmod 600 swapfile </span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ll swapfile </span></span><br><span class="line">-rw------- 1 root root 1073741824 Mar 26 05:48 swapfile</span><br></pre></td></tr></table></figure>

<p>注意：由于使用的是文件来作为swap，在使用到swap时系统需要先去磁盘上找到此文件，所以速度较慢，另外文件在磁盘上所在的位置是未知的，所以所创建的Swap的性能未必有创建系统时所建的swap性能好，</p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>TCP/IP的三次握手和四次分手</title>
    <url>/2019/03/06/Linux%E5%9F%BA%E7%A1%80/tcp%E7%9A%84%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E5%88%86%E6%89%8B/tcp%E7%9A%84%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E5%88%86%E6%89%8B/</url>
    <content><![CDATA[<h2 id="tcp连接三次握手"><a href="#tcp连接三次握手" class="headerlink" title="tcp连接三次握手"></a>tcp连接三次握手</h2><p>客户端发起链接SYN置为1其余5位置为0，并发送序号seq=x，客户端状态从close变为SYN-SENT</p>
<p>服务器端收到客户端的请求返回SYN=1，ACK=1，发送序号seq=y和确认序号ack=x+1，服务器状态由LISTEN变为SYN-RCVD。</p>
<p>客户端收到服务器端的相应后 返回ACK=1,seq=x+1，确认序号ack=y+1,客户端状态从SYN-SENT变为ESTAB-LISHED，服务器端收到客户端的回应后状态也变为ESTAB-LISTHED双方建立链接。</p>
<p><img src="%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png"></p>
<h2 id="tcp连接断开时的四次分手"><a href="#tcp连接断开时的四次分手" class="headerlink" title="tcp连接断开时的四次分手"></a>tcp连接断开时的四次分手</h2><p>建立连接后，客户端和服务器都处于ESTABLISED状态。这时，客户端发起断开连接的请求：</p>
<ol>
<li><p>客户端向服务器发送 FIN 数据包，进入FIN_WAIT_1状态。表示完成任务需要断开连接。</p>
</li>
<li><p>服务器收到数据包后，检测到设置了 FIN 标志位，知道要断开连接，于是向客户端发送“确认包”，进入CLOSE_WAIT状态。</p>
</li>
</ol>
<p>注意：服务器收到请求后并不是立即断开连接，而是先向客户端发送“确认包”，告诉它我知道了，我需要准备一下才能断开连接。</p>
<ol start="3">
<li><p>客户端收到“确认包”后进入FIN_WAIT_2状态，等待服务器准备完毕后再次发送数据包。</p>
</li>
<li><p>等待片刻后，服务器准备完毕，可以断开连接，于是再主动向客户端发送 FIN 包，告诉它我准备好了，断开连接吧。然后进入LAST_ACK状态。</p>
</li>
<li><p>客户端收到服务器的 FIN 包后，再向服务器发送 ACK 包，告诉它你断开连接吧。然后进入TIME_WAIT状态。</p>
</li>
<li><p>服务器收到客户端的 ACK 包后，就断开连接，关闭套接字，进入CLOSED状态。</p>
</li>
</ol>
<p><img src="%E5%9B%9B%E6%AC%A1%E5%88%86%E6%89%8B.png"></p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>网络</tag>
      </tags>
  </entry>
  <entry>
    <title>主机名修改</title>
    <url>/2019/03/07/Linux%E5%9F%BA%E7%A1%80/%E4%B8%BB%E6%9C%BA%E5%90%8D%E4%BF%AE%E6%94%B9/%E4%B8%BB%E6%9C%BA%E5%90%8D%E4%BF%AE%E6%94%B9/</url>
    <content><![CDATA[<h2 id="Linux主机名修改"><a href="#Linux主机名修改" class="headerlink" title="Linux主机名修改"></a>Linux主机名修改</h2><p>由于CentOS6和CentOS7修改主机名的方法是不同的所以此处分别展示如何在CentOS6 和 CentOS7上分别修改主机名。  </p>
<p>生产环境中通常需要使用不同的主机名来区分生产环境中的不同主机，此时就涉及到了主机名的修改，由于CentOS6和CentOS7修改主机名的方法是不同的，此处分别展示如何在CentOS6 和 CentOS7上分别修改主机名。  </p>
<span id="more"></span>

<p>此处以将主机名修改为mylinuxops.com为例 </p>
<h3 id="一、CentOS6修改主机名"><a href="#一、CentOS6修改主机名" class="headerlink" title="一、CentOS6修改主机名"></a>一、CentOS6修改主机名</h3><p>1.修改配置文件/etc/sysconfig/network</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># vim /etc/sysconfig/network</span></span><br><span class="line">NETWORKING=yes</span><br><span class="line">HOSTNAME=mylinuxops.com</span><br></pre></td></tr></table></figure>

<p>2.修改/etc/hosts在127.0.0.1后添加主机名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 mylinuxops.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br></pre></td></tr></table></figure>

<p>3.若要使主机名临时有效可以使用hostname HOSTNAME 来修改，但此命令执行后命令提示符所显示的不会马上生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># hostname mylinuxops.com</span></span><br></pre></td></tr></table></figure>

<p>4.若要使其立即生效可以使用exec bash 命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># exec bash</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="二、CentOS7修改主机名"><a href="#二、CentOS7修改主机名" class="headerlink" title="二、CentOS7修改主机名"></a>二、CentOS7修改主机名</h3><p>CentOS7修改主机名的方法与CentOS6不同可以直接通过hostnamectl命令去修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># hostnamectl set-hostname mylinuxops.com</span></span><br><span class="line"><span class="comment">#hostnameclt命令修改主机名后不会直接生效</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># hostname</span></span><br><span class="line">mylinuxops.com</span><br><span class="line"><span class="comment">#若要立即生效可以使用exec bash</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># exec bash</span></span><br><span class="line">[root@mylinuxops ~]<span class="comment"># </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>破解root口令</title>
    <url>/2019/03/09/Linux%E5%9F%BA%E7%A1%80/%E4%BF%AE%E6%94%B9root%E5%8F%A3%E4%BB%A4/%E7%A0%B4%E8%A7%A3root%E5%8F%A3%E4%BB%A4/</url>
    <content><![CDATA[<h2 id="破解root口令"><a href="#破解root口令" class="headerlink" title="破解root口令"></a>破解root口令</h2><p>在生产环境中有时可能会遇到root口令丢失，遗忘挥着前任没有交接密码的情况，此时就需要进行破解root密码，centos6和centos7的口令破解方法略微不同，以下为演示6和7上破解密码的方法。</p>
<span id="more"></span>

<h3 id="centos6破解口令"><a href="#centos6破解口令" class="headerlink" title="centos6破解口令"></a>centos6破解口令</h3><p>centos6破解口令比较简单，由于单用户模式不需要密码就能登录root账户，所以只需要使用单用户模式登录就能轻易破解</p>
<p>1.重启机器在内核选择么模式下选中要启动的内核然后按a</p>
<p><img src="1.png" alt="1.png"></p>
<p>2.在行的尾部追加一个1，s，S，或者single，进入单用户模式</p>
<p><img src="2.png" alt="2.png"></p>
<p>3.进入单用户模式后修改密码</p>
<p><img src="3.png" alt="3.png"></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>由于centos6破解root账户的方法过于简单，可以在选择内核界面时设置密码，不让普通用户可以随意选择启动模式。具体操作方法如下:  </p>
<p>1.先使用grub-md5-crypt创建相应的密钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># grub-md5-crypt</span></span><br><span class="line">Password: </span><br><span class="line">Retype password: </span><br><span class="line">$1$tjgZK0<span class="variable">$LWWBkM5dUP7EilY4</span>/8AgE1</span><br></pre></td></tr></table></figure>

<p>2.对/boot/grub/grub.conf文件进行修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /boot/grub/grub.con</span><br><span class="line">default=0</span><br><span class="line">timeout=5</span><br><span class="line">password --md5 $1$tjgZK0<span class="variable">$LWWBkM5dUP7EilY4</span>/8AgE1     <span class="comment">#添加password参数指定加密方式 然后将刚才加密后的密码写后面</span></span><br><span class="line">splashimage=(hd0,0)/grub/splash.xpm.gz</span><br><span class="line">hiddenmenu</span><br><span class="line">title CentOS 6 (2.6.32-754.el6.x86_64)</span><br><span class="line">        root (hd0,0)</span><br><span class="line">        kernel /vmlinuz-2.6.32-754.el6.x86_64 ro root=UUID=3fa49288-1c40-4e74-ad2c-a32fefedf20f rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</span><br><span class="line">        initrd /initramfs-2.6.32-754.el6.x86_64.img                                                  </span><br></pre></td></tr></table></figure>

<p>3.重启  </p>
<p>再次进入内核选择的界面，此时按a键已经没有反应，提示按p键输入密码</p>
<p><img src="4.png" alt="4.png"></p>
<hr>
<h3 id="破解centos7口令"><a href="#破解centos7口令" class="headerlink" title="破解centos7口令"></a>破解centos7口令</h3><p>1.重启在内核选择界面按下e进行修改</p>
<p><img src="5.png" alt="5.png"></p>
<p>2.在linux16这行输入rd.bread执行打断的操作</p>
<p><img src="6.png" alt="6.png"></p>
<p>3.查看挂载信息</p>
<p><img src="7.png" alt="7.png"></p>
<p>4.由于是只读模式挂载的所以需要重新进行挂载</p>
<p><img src="8.png" alt="8.png"></p>
<p>5.切根然后更改密码</p>
<p><img src="9.png" alt="9.png"></p>
<p>此处需要注意，如果开启了SElinux则需要在最后加上touch /.autorelable 命令</p>
<h3 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h3><p>CentOS7和CentOS6相同也可以在内核选择界面进行加密，加密方法如下。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># grub2-setpassword </span></span><br><span class="line">Enter password: </span><br><span class="line">Confirm password: </span><br></pre></td></tr></table></figure>
<p>重启查看效果</p>
<p><img src="10.png" alt="10.png"></p>
<p><img src="11.png" alt="11.png"></p>
<p>使用grub2-setpassword加密是在/boot/grub2/目录下建了一个user.cfg的文件，里面存放了加密后的密码，如果要取消加密可以直接删除此文件。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /boot/grub2/user.cfg </span></span><br><span class="line">GRUB2_PASSWORD=grub.pbkdf2.sha512.10000.9CBEDC98BA0FD021487FCB20848F01CFB6A5D9F0446AD090DB4B4D23FEC9E176783A0870EA874F031457F0F4D63306BB5752BAC208C9FF75AAB9CFF65192CF7A.F57E4253D3A42A08A08CBF99EB61E97A135134818F79ADB67A9470B62091C43E93BCEF49BC5EECCFD14FD910C6CACECFC97E7C5AE6BA7AD5AD8C55011AA21AAF</span><br><span class="line">[root@centos7 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>/boot目录删除恢复</title>
    <url>/2019/03/07/Linux%E5%9F%BA%E7%A1%80/%E5%88%A0%E9%99%A4boot/%E5%88%A0%E9%99%A4boot/</url>
    <content><![CDATA[<h2 id="boot目录删除恢复"><a href="#boot目录删除恢复" class="headerlink" title="boot目录删除恢复"></a>boot目录删除恢复</h2><p>以下为分别演示在CentOS 6和CentOS 7上boot目录被删除后出现的报错以及修复的方法</p>
<span id="more"></span>

<h3 id="CentOS6删除-boot"><a href="#CentOS6删除-boot" class="headerlink" title="CentOS6删除/boot"></a>CentOS6删除/boot</h3><p>一、删除/boot目录下内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># rm -rf /boot/</span></span><br><span class="line">rm: cannot remove `/boot<span class="string">&#x27;: Device or resource busy</span></span><br><span class="line"><span class="string">[root@centos6 boot]# sync</span></span><br></pre></td></tr></table></figure>
<p>二、查看错误状态</p>
<p><img src="1.png" alt="1.png"></p>
<p>三、修复</p>
<p>修复思路，由于/boot下存放的文件为开机启动所需要的内核、虚拟文件系统、以及grub的1，1.5，以及2阶段的文件，所以修复时需要将这些文件全部创建出来。</p>
<p>1.使用救援光盘登录系统。  </p>
<p>此步骤省略</p>
<p>2.切换根至硬盘根目录下，挂载光盘至/mnt目录下 </p>
<p><img src="2.png" alt="2.png"> </p>
<p>3.复制内核文件至/boot目录下，并在/boot目录下创建虚拟文件系统。  </p>
<p><img src="3.png" alt="3.png"></p>
<p>4.修复GRUB的各个阶段  </p>
<p><img src="4.png" alt="4.png"></p>
<p>5.由于grub-install修复了grub的各阶段但没有grub的配置文件，所以需要手动写配置文件。</p>
<p><img src="5.png" alt="5.png"></p>
<p><img src="6.png" alt="6.png"></p>
<p>注意：kenerl和initrd次序绝对不能错，次序错误会导致系统不能正常启动  </p>
<p>修复完毕，重启能正常进入系统</p>
<p><img src="7.png" alt="7.png"></p>
<hr>
<h3 id="CentOS7-删除boot恢复"><a href="#CentOS7-删除boot恢复" class="headerlink" title="CentOS7 删除boot恢复"></a>CentOS7 删除boot恢复</h3><p>一、执行破坏操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 /]<span class="comment"># rm -rf boot</span></span><br><span class="line">rm: cannot remove ‘boot’: Device or resource busy</span><br><span class="line">[root@centos7 boot]<span class="comment"># sync</span></span><br></pre></td></tr></table></figure>

<p>二、重启查看效果</p>
<p><img src="8.png" alt="8.png"></p>
<p>三、修复  </p>
<p>1.重启进入救援模式  </p>
<p>由于救援模式下把系统的根挂载至了/mnt/sysroot下所以需要先切换根，然后挂载光盘文件至mnt目录下，安装内核。在使用grub2-install安装grub2。</p>
<p><img src="9.png" alt="9.png"></p>
<p>grub2安装完毕此时还缺少启动所需要的grub.cfg文件，所以需要使用grub2-mkconfig来生成此文件</p>
<p><img src="10.png" alt="10.png"></p>
<p>重启后正常进入系统</p>
<p><img src="11.png" alt="11.png"></p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>grub修复</tag>
      </tags>
  </entry>
  <entry>
    <title>fstab和boot目录删除及恢复方法</title>
    <url>/2019/03/07/Linux%E5%9F%BA%E7%A1%80/%E5%88%A0%E9%99%A4fstab%E5%8F%8Aboot/%E5%88%A0%E9%99%A4fstab%E5%8F%8Aboot/</url>
    <content><![CDATA[<h2 id="fstab和boot目录删除及恢复方法"><a href="#fstab和boot目录删除及恢复方法" class="headerlink" title="fstab和boot目录删除及恢复方法"></a>fstab和boot目录删除及恢复方法</h2><p>以下为演示当fstab和boot都丢失时的错误状态以及恢复的方法</p>
<span id="more"></span>

<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>删除/etc/fstab,/boot目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># rm -rf /etc/fstab /boot</span></span><br><span class="line">rm: cannot remove `/boot<span class="string">&#x27;: Device or resource busy</span></span><br><span class="line"><span class="string">[root@centos6 ~]# sync</span></span><br></pre></td></tr></table></figure>

<p>重启查看故障状态</p>
<p><img src="1.png" alt="1.png"></p>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>1.启动光盘救援模式</p>
<p>由于/etc/fstab文件被删除此时系统找不到硬盘相对应的挂载位置所以此处提示没有Linux分区</p>
<p><img src="2.png" alt="2.png"></p>
<p>2.查看下所有硬盘分区信息</p>
<p>发现所有磁盘分区信息均能看见，此时可以判断/dev/sda1为boot目录，/dev/sda2为根目录。</p>
<p><img src="3.png" alt="3.png"></p>
<p>3.手动将硬盘分区挂载</p>
<p><img src="4.png" alt="4.png"></p>
<p>4.将根切换至硬盘的根目录，并创建fstab文件</p>
<p><img src="5.png" alt="5.png"></p>
<p><img src="6.png" alt="6.png"></p>
<p>5.重启后再次进入救援模式，查看系统的根目录是否能被正常找到。</p>
<p><img src="7.png" alt="7.png"></p>
<p>此时救援光盘上的系统已经能够正常识别磁盘的根文件系统系统</p>
<hr>
<p>接下来要执行的为修复内核和grub的过程：</p>
<p>1.切换根至硬盘目录下，挂载光盘至/mnt目录下 </p>
<p><img src="a.png" alt="a.png"> </p>
<p>2.复制内核文件至/boot目录下，并在/boot目录下创建虚拟文件系统。  </p>
<p><img src="b.png" alt="b.png"></p>
<p>3.修复GRUB的各个阶段  </p>
<p><img src="c.png" alt="c.png"></p>
<p>4.由于grub-install修复了grub的各阶段但没有grub的配置文件，所以需要手动写配置文件。</p>
<p><img src="d.png" alt="d.png"></p>
<p><img src="e.png" alt="e.png"></p>
<p>注意：kenerl和initrd次序绝对不能错，次序错误会导致系统不能正常启动  </p>
<p>修复完毕，重启能正常进入系统</p>
<p><img src="f.png" alt="f.png"></p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>grub修复</tag>
      </tags>
  </entry>
  <entry>
    <title>删除initramfs修复</title>
    <url>/2019/03/07/Linux%E5%9F%BA%E7%A1%80/%E5%88%A0%E9%99%A4initramfs/%E5%88%A0%E9%99%A4initramfs-xxx.img/</url>
    <content><![CDATA[<h2 id="删除initramfs修复"><a href="#删除initramfs修复" class="headerlink" title="删除initramfs修复"></a>删除initramfs修复</h2><p>以下操作为演示initramfs被删除后的报错，以及修复的方法。</p>
<span id="more"></span>

<h3 id="一、删除initramfs文件"><a href="#一、删除initramfs文件" class="headerlink" title="一、删除initramfs文件"></a>一、删除initramfs文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 boot]<span class="comment"># rm initramfs-2.6.32-754.el6.x86_64.img </span></span><br><span class="line">rm: remove regular file `initramfs-2.6.32-754.el6.x86_64.img<span class="string">&#x27;? y</span></span><br><span class="line"><span class="string">[root@centos6 boot]# ls</span></span><br><span class="line"><span class="string">config-2.6.32-754.el6.x86_64  lost+found                        vmlinuz-2.6.32-754.el6.x86_64</span></span><br><span class="line"><span class="string">efi                           symvers-2.6.32-754.el6.x86_64.gz</span></span><br><span class="line"><span class="string">grub                          System.map-2.6.32-754.el6.x86_64</span></span><br></pre></td></tr></table></figure>

<h3 id="二、重启查看报错。"><a href="#二、重启查看报错。" class="headerlink" title="二、重启查看报错。"></a>二、重启查看报错。</h3><p><img src="initramfs.png" alt="initramfs.png"></p>
<h3 id="三、修复错误"><a href="#三、修复错误" class="headerlink" title="三、修复错误"></a>三、修复错误</h3><p>1.进入救援模式</p>
<p><img src="cs6.png" alt="cs6.png"></p>
<p><img src="cs62.png" alt="cs62.png"></p>
<p><img src="cs63.png" alt="cs63.png"></p>
<p><img src="cs64.png" alt="cs64.png"></p>
<p><img src="cs65.png" alt="cs65.png"></p>
<p><img src="cs66.png" alt="cs66.png"></p>
<p><img src="cs67.png" alt="cs67.png"></p>
<p>2.修复错误 </p>
<p>切换根目录至硬盘目录</p>
<p><img src="%E4%BF%AE%E5%A4%8D1.png" alt="修复1.png"></p>
<p>cd至/boot目录下，然后使用mkinitrd命令对initramfs文件进行修复，mkinitrd命令需要带上系统内核的版本号所以此处使用<code>uname -r</code>来获取版本号</p>
<p><img src="%E4%BF%AE%E5%A4%8D2.png" alt="修复2.png"></p>
<p>重启机器</p>
<p><img src="%E4%BF%AE%E5%A4%8D3.png" alt="修复3.png"></p>
<h3 id="四、重启后正常进入系统"><a href="#四、重启后正常进入系统" class="headerlink" title="四、重启后正常进入系统"></a>四、重启后正常进入系统</h3><p><img src="%E6%AD%A3%E5%B8%B8.png" alt="正常.png"></p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>grub修复</tag>
      </tags>
  </entry>
  <entry>
    <title>删除vmlinuz-xxx.img修复</title>
    <url>/2019/03/07/Linux%E5%9F%BA%E7%A1%80/%E5%88%A0%E9%99%A4vmlinuz/%E5%88%A0%E9%99%A4vmlinuz-xxx/</url>
    <content><![CDATA[<h2 id="删除vmlinuz-xxx-img修复"><a href="#删除vmlinuz-xxx-img修复" class="headerlink" title="删除vmlinuz-xxx.img修复"></a>删除vmlinuz-xxx.img修复</h2><p>以下为演示vmlinuz内核文件丢失后的报错以及修复的过程</p>
<span id="more"></span>

<h3 id="一、删除vmlinuz-xxx-img"><a href="#一、删除vmlinuz-xxx-img" class="headerlink" title="一、删除vmlinuz-xxx.img"></a>一、删除vmlinuz-xxx.img</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># rm /boot/vmlinuz-2.6.32-754.el6.x86_64</span></span><br><span class="line">rm: remove regular file `/boot/vmlinuz-2.6.32-754.el6.x86_64<span class="string">&#x27;? y</span></span><br><span class="line"><span class="string">[root@centos6 ~]# ls /boot</span></span><br><span class="line"><span class="string">config-2.6.32-754.el6.x86_64  initramfs-2.6.32-754.el6.x86_64.img  System.map-2.6.32-754.el6.x86_64</span></span><br><span class="line"><span class="string">efi                           lost+found</span></span><br><span class="line"><span class="string">grub                          symvers-2.6.32-754.el6.x86_64.gz</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h3 id="二、重启后查看报错"><a href="#二、重启后查看报错" class="headerlink" title="二、重启后查看报错"></a>二、重启后查看报错</h3><p>内核丢失报错状态为下图</p>
<p><img src="%E6%8A%A5%E9%94%99%E7%8A%B6%E6%80%81.png" alt="报错状态.png"></p>
<h3 id="三、修复"><a href="#三、修复" class="headerlink" title="三、修复"></a>三、修复</h3><p>1.进入光盘救援模式  </p>
<p>2.修复错误</p>
<p>修复方法，由于内核文件光盘上也存有一份，所以将光盘下的内核文件复制一份至boot就可以恢复。</p>
<p><img src="%E4%BF%AE%E5%A4%8D.png"></p>
<p>3.重启 </p>
<p>重启后已经正常进入系统</p>
<p><img src="%E6%AD%A3%E5%B8%B8.png" alt="正常.png"></p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>grub修复</tag>
      </tags>
  </entry>
  <entry>
    <title>加密和安全</title>
    <url>/2019/03/09/Linux%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/</url>
    <content><![CDATA[<h2 id="加密和安全"><a href="#加密和安全" class="headerlink" title="加密和安全"></a>加密和安全</h2><p>常见的加密算法有和协议有对称加密，公钥加密，单向加密和认证协议</p>
<span id="more"></span>

<h3 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h3><p>对称加密，在加密和解密时使用的是同一个密钥</p>
<p>常见的对称加密有：DES,3DES,AES,Blowfish,Twofish,IDEA,RC6,CAST5</p>
<h4 id="对称密钥加密和解密的过程："><a href="#对称密钥加密和解密的过程：" class="headerlink" title="对称密钥加密和解密的过程："></a>对称密钥加密和解密的过程：</h4><p>数据发送方A和数据接收方B在发送数据前先通过某种渠道约定好密钥，然后A将明文的数据使用对称密钥进行加密，然后将加密后的数据发送给B，B接受到数据后使用相同的密钥对数据进行解密然后获取相应的数据  </p>
<h4 id="通过上述的加密和解密过程可以了解到这种加密的方法有以以下这些特点："><a href="#通过上述的加密和解密过程可以了解到这种加密的方法有以以下这些特点：" class="headerlink" title="通过上述的加密和解密过程可以了解到这种加密的方法有以以下这些特点："></a>通过上述的加密和解密过程可以了解到这种加密的方法有以以下这些特点：</h4><p>1.数据加密和解密时使用同一组密钥  </p>
<p>2.数据加密和机密时使用时间短效率高  </p>
<p>3.将原始数据分割成固定大小的块，逐个进行加密  </p>
<h4 id="不难看出对称加密的缺点也是非常的明显："><a href="#不难看出对称加密的缺点也是非常的明显：" class="headerlink" title="不难看出对称加密的缺点也是非常的明显："></a>不难看出对称加密的缺点也是非常的明显：</h4><p>1.密钥过多:每一个数据对应的都需要使用一个不同的密钥进行加密，产生过多的密钥  </p>
<p>2.密钥分发:密钥在分发的过程种存在安全性问题  </p>
<p>3.数据的来源无法确认:由于谁都能对数据加同一密钥所以数据的来源性无法确认  </p>
<h3 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h3><p>非对称加密的密钥是成对的出现的，其分为公钥和私钥  </p>
<p>公钥(Public key):公开给所有人  </p>
<p>私钥(Secret key):自己留存，必须保证其私密性  </p>
<p>常见的非对称加密的算法有：RSA(加密，数字签名)，DSA(数字签名)，ELGaml  </p>
<h4 id="非对称加密的加解密和实现数字签名的过程："><a href="#非对称加密的加解密和实现数字签名的过程：" class="headerlink" title="非对称加密的加解密和实现数字签名的过程："></a>非对称加密的加解密和实现数字签名的过程：</h4><p>数据的发送方A和接收方B各生成一队密钥:A方公钥Pa、私钥Sa，B方公钥Pb、私钥Sb  </p>
<p>A方在传送明文数据前先使用自己的私钥(Sa)对数据进行加密，再使用B方的公钥(Pb)对加密后的数据再次加密，然后将数据传送给B，B方接受到数据后，先使用自己的私钥(Sb)对加密的数据进行解密，然后再使用A的公钥(Pa)再次对数据进行解密以此来确认数据确实是由A发送而来。  </p>
<h4 id="通过该流程可以发现非对称加密有以下特点："><a href="#通过该流程可以发现非对称加密有以下特点：" class="headerlink" title="通过该流程可以发现非对称加密有以下特点："></a>通过该流程可以发现非对称加密有以下特点：</h4><p>用公钥加密的数据，只能由与之相对应的私钥进行解密，反之亦然。  </p>
<p>通过其特性可以实现以下功能：  </p>
<p>1.可以实现数字签名，让接受可以确认数据发送方的身份  </p>
<p>2.可以实现对称密钥的交换，发送方可以使用对方的公钥加密一个对称密钥然后发送给对方  </p>
<p>3.由于非对称加密的解密的时间比较长，所以只适合较小数据的加密  </p>
<h4 id="由此可见其缺点是非常明显的："><a href="#由此可见其缺点是非常明显的：" class="headerlink" title="由此可见其缺点是非常明显的："></a>由此可见其缺点是非常明显的：</h4><p>1.非对称密钥的长度非常的长。  </p>
<p>2.非对称加密在解密时的效率非常的低下  </p>
<h3 id="单向散列-hash算法"><a href="#单向散列-hash算法" class="headerlink" title="单向散列(hash算法)"></a>单向散列(hash算法)</h3><p>hash算法又叫数据摘要，这种算法无法被逆推，可以确保数据的完整性，确保数据没有被篡改，用来做完整性校验。hash算法类似于指纹。  </p>
<p>常见算法: md5: 128bits、sha1: 160bits、sha224、sha256、sha384、sha512  </p>
<p>示例：  </p>
<p>将一窜字符定向给file1，然后对file1进行一系列操作并用md5sum进行提取指纹信息查看。  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo abcdefg &gt; file1</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># md5sum file1                  </span></span><br><span class="line">020861c8c3fe177da19a7e9539a5dbac  file1     <span class="comment">#对刚创建的file1文件提取数据摘要</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cp file1 file2</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># md5sum file2</span></span><br><span class="line">020861c8c3fe177da19a7e9539a5dbac  file2     <span class="comment">#复制file1命名为file2再提取数据摘要与file1做比较</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo 1 &gt;&gt; file2</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># md5sum file2</span></span><br><span class="line">7f01eb26bac5f3a716b77cb702d85184  file2     <span class="comment">#给file2添加点数据然后提取数据摘要再次和上一次的file2的数据摘要作比较</span></span><br></pre></td></tr></table></figure>
<p>通过上述示例可以发现，文件名的改变对数据的摘要信息毫无影响，但当数据的内容发生改变时，所提取出来的数据摘要将发生天翻地覆的变法。数据的完整性校验就是通过此种方法来实现的。 </p>
<h4 id="所以单向散列有以下的特点："><a href="#所以单向散列有以下的特点：" class="headerlink" title="所以单向散列有以下的特点："></a>所以单向散列有以下的特点：</h4><p>1.任意长度输入，固定长度输出  </p>
<p>2.若修改数据，指纹也会改变  </p>
<p>3.无法从指纹中重新生成数据  </p>
<p>根据其特点可以实现数据完整性这一功能。  </p>
<h3 id="数字签名"><a href="#数字签名" class="headerlink" title="数字签名"></a>数字签名</h3><p>通过上述3种加密方法的特点，我们可以实现出一种既能进行加密又能确保解密高效性，并且缺保数据的完整性的方法，这种方法称为数字签名。</p>
<h4 id="数字签名的实现方法："><a href="#数字签名的实现方法：" class="headerlink" title="数字签名的实现方法："></a>数字签名的实现方法：</h4><p>发送数据发送方用hash算法从数据中生成数据摘要,然后用自己的私人密钥对这个摘要进行加密，这个加密后的摘要将作为数据数字签名和报文一起发送给接收方，接收方首先用与发送方一样的hash算法从接收到的原始数据中计算出数据摘要，接着再用发送方的公用密钥来对数据附加的数字签名进行解密，如果这两个摘要相同、那么接收方就能确认该数字签名是发送方的。  </p>
<h4 id="数字签名有两种功效："><a href="#数字签名有两种功效：" class="headerlink" title="数字签名有两种功效："></a>数字签名有两种功效：</h4><p>1.能确定数据确实是由发送方签名并发出来的，因为别人假冒不了发送方的签名。  </p>
<p>2.数字签名能确定数据的完整性。因为数字签名的特点是它代表了数据的特征，数据如果发生改变，数字摘要的值也将发生变化。不同的数据将得到不同的数字摘要。 一次数字签名涉及到一个hash算法、发送者的公钥、发送者的私钥。</p>
<hr>
<h2 id="非对称密钥实验"><a href="#非对称密钥实验" class="headerlink" title="非对称密钥实验"></a>非对称密钥实验</h2><p>实验目的：</p>
<p>对文件进行非对称加解密  </p>
<p>实验准备：</p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">OS</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">CentOS7</td>
<td align="left">192.168.172.134</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">CentOS7</td>
<td align="left">192.168.172.134</td>
</tr>
</tbody></table>
<hr>
<h3 id="一、分别在2台主机上生成公钥和私钥"><a href="#一、分别在2台主机上生成公钥和私钥" class="headerlink" title="一、分别在2台主机上生成公钥和私钥"></a>一、分别在2台主机上生成公钥和私钥</h3><p>1.在主机A上生成公私钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostA ~]<span class="comment"># gpg --gen-key</span></span><br><span class="line">gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line">gpg: directory `/root/.gnupg<span class="string">&#x27; created</span></span><br><span class="line"><span class="string">gpg: new configuration file `/root/.gnupg/gpg.conf&#x27;</span> created</span><br><span class="line">gpg: WARNING: options <span class="keyword">in</span> `/root/.gnupg/gpg.conf<span class="string">&#x27; are not yet active during this run</span></span><br><span class="line"><span class="string">gpg: keyring `/root/.gnupg/secring.gpg&#x27;</span> created</span><br><span class="line">gpg: keyring `/root/.gnupg/pubring.gpg<span class="string">&#x27; created</span></span><br><span class="line"><span class="string">Please select what kind of key you want:</span></span><br><span class="line"><span class="string">   (1) RSA and RSA (default)</span></span><br><span class="line"><span class="string">   (2) DSA and Elgamal</span></span><br><span class="line"><span class="string">   (3) DSA (sign only)</span></span><br><span class="line"><span class="string">   (4) RSA (sign only)</span></span><br><span class="line"><span class="string">Your selection? 1                                   #选择所要生成的非对称密钥类型</span></span><br><span class="line"><span class="string">RSA keys may be between 1024 and 4096 bits long.</span></span><br><span class="line"><span class="string">What keysize do you want? (2048) 1024               #先择密钥的长度</span></span><br><span class="line"><span class="string">Requested keysize is 1024 bits</span></span><br><span class="line"><span class="string">Please specify how long the key should be valid.</span></span><br><span class="line"><span class="string">         0 = key does not expire</span></span><br><span class="line"><span class="string">      &lt;n&gt;  = key expires in n days</span></span><br><span class="line"><span class="string">      &lt;n&gt;w = key expires in n weeks</span></span><br><span class="line"><span class="string">      &lt;n&gt;m = key expires in n months</span></span><br><span class="line"><span class="string">      &lt;n&gt;y = key expires in n years</span></span><br><span class="line"><span class="string">Key is valid for? (0)                               #指定密钥的有效期限</span></span><br><span class="line"><span class="string">Key does not expire at all</span></span><br><span class="line"><span class="string">Is this correct? (y/N) y                            #确认密钥有效期为永久有效</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GnuPG needs to construct a user ID to identify your key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Real name: hostA                                    #输入非对称密钥所对应的主机名</span></span><br><span class="line"><span class="string">Email address: </span></span><br><span class="line"><span class="string">Comment: </span></span><br><span class="line"><span class="string">You selected this USER-ID:</span></span><br><span class="line"><span class="string">    &quot;hostA&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o   #确认密钥信息</span></span><br><span class="line"><span class="string">You need a Passphrase to protect your secret key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You don&#x27;</span>t want a passphrase - this is probably a *bad* idea!</span><br><span class="line">I will <span class="keyword">do</span> it anyway.  You can change your passphrase at any time,</span><br><span class="line">using this program with the option <span class="string">&quot;--edit-key&quot;</span>.</span><br><span class="line"></span><br><span class="line">We need to generate a lot of random bytes. It is a good idea to perform</span><br><span class="line">some other action (<span class="built_in">type</span> on the keyboard, move the mouse, utilize the</span><br><span class="line">disks) during the prime generation; this gives the random number</span><br><span class="line">generator a better chance to gain enough entropy.</span><br><span class="line">We need to generate a lot of random bytes. It is a good idea to perform</span><br><span class="line">some other action (<span class="built_in">type</span> on the keyboard, move the mouse, utilize the</span><br><span class="line">disks) during the prime generation; this gives the random number</span><br><span class="line">generator a better chance to gain enough entropy.</span><br><span class="line">gpg: /root/.gnupg/trustdb.gpg: trustdb created</span><br><span class="line">gpg: key 4B9A0B62 marked as ultimately trusted</span><br><span class="line">public and secret key created and signed.</span><br><span class="line"></span><br><span class="line">gpg: checking the trustdb</span><br><span class="line">gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model</span><br><span class="line">gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u</span><br><span class="line">pub   1024R/4B9A0B62 2019-04-12</span><br><span class="line">      Key fingerprint = E128 AD1F E1D5 5B0D C66C  FD45 4786 0C63 4B9A 0B62</span><br><span class="line">uid                  hostA</span><br><span class="line">sub   1024R/DD37BA59 2019-04-12</span><br><span class="line"></span><br><span class="line"><span class="comment">#非对称密生成完毕</span></span><br><span class="line">[root@hostA ~]<span class="comment"># cd .gnupg/</span></span><br><span class="line">[root@hostA .gnupg]<span class="comment"># ll</span></span><br><span class="line">total 28</span><br><span class="line">-rw------- 1 root root 7680 Apr 13 05:36 gpg.conf</span><br><span class="line">drwx------ 2 root root    6 Apr 13 05:37 private-keys-v1.d</span><br><span class="line">-rw------- 1 root root  649 Apr 13 05:37 pubring.gpg        <span class="comment">#公钥文件</span></span><br><span class="line">-rw------- 1 root root  649 Apr 13 05:37 pubring.gpg~       <span class="comment">#公钥的备份</span></span><br><span class="line">-rw------- 1 root root  600 Apr 13 05:37 random_seed</span><br><span class="line">-rw------- 1 root root 1313 Apr 13 05:37 secring.gpg        <span class="comment">#私钥文件</span></span><br><span class="line">srwxr-xr-x 1 root root    0 Apr 13 05:37 S.gpg-agent</span><br><span class="line">-rw------- 1 root root 1280 Apr 13 05:37 trustdb.gpg</span><br></pre></td></tr></table></figure>

<p>2.B主机上生成公私钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostB ~]<span class="comment"># gpg --gen-key</span></span><br><span class="line">gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line">gpg: directory `/root/.gnupg<span class="string">&#x27; created</span></span><br><span class="line"><span class="string">gpg: new configuration file `/root/.gnupg/gpg.conf&#x27;</span> created</span><br><span class="line">gpg: WARNING: options <span class="keyword">in</span> `/root/.gnupg/gpg.conf<span class="string">&#x27; are not yet active during this run</span></span><br><span class="line"><span class="string">gpg: keyring `/root/.gnupg/secring.gpg&#x27;</span> created</span><br><span class="line">gpg: keyring `/root/.gnupg/pubring.gpg<span class="string">&#x27; created</span></span><br><span class="line"><span class="string">Please select what kind of key you want:</span></span><br><span class="line"><span class="string">   (1) RSA and RSA (default)</span></span><br><span class="line"><span class="string">   (2) DSA and Elgamal</span></span><br><span class="line"><span class="string">   (3) DSA (sign only)</span></span><br><span class="line"><span class="string">   (4) RSA (sign only)</span></span><br><span class="line"><span class="string">Your selection? 1</span></span><br><span class="line"><span class="string">RSA keys may be between 1024 and 4096 bits long.</span></span><br><span class="line"><span class="string">What keysize do you want? (2048) 1024</span></span><br><span class="line"><span class="string">Requested keysize is 1024 bits</span></span><br><span class="line"><span class="string">Please specify how long the key should be valid.</span></span><br><span class="line"><span class="string">         0 = key does not expire</span></span><br><span class="line"><span class="string">      &lt;n&gt;  = key expires in n days</span></span><br><span class="line"><span class="string">      &lt;n&gt;w = key expires in n weeks</span></span><br><span class="line"><span class="string">      &lt;n&gt;m = key expires in n months</span></span><br><span class="line"><span class="string">      &lt;n&gt;y = key expires in n years</span></span><br><span class="line"><span class="string">Key is valid for? (0) </span></span><br><span class="line"><span class="string">Key does not expire at all</span></span><br><span class="line"><span class="string">Is this correct? (y/N) y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GnuPG needs to construct a user ID to identify your key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Real name: hostB</span></span><br><span class="line"><span class="string">Email address: </span></span><br><span class="line"><span class="string">Comment: </span></span><br><span class="line"><span class="string">You selected this USER-ID:</span></span><br><span class="line"><span class="string">    &quot;hostB&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o</span></span><br><span class="line"><span class="string">You need a Passphrase to protect your secret key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You don&#x27;</span>t want a passphrase - this is probably a *bad* idea!</span><br><span class="line">I will <span class="keyword">do</span> it anyway.  You can change your passphrase at any time,</span><br><span class="line">using this program with the option <span class="string">&quot;--edit-key&quot;</span>.</span><br><span class="line"></span><br><span class="line">We need to generate a lot of random bytes. It is a good idea to perform</span><br><span class="line">some other action (<span class="built_in">type</span> on the keyboard, move the mouse, utilize the</span><br><span class="line">disks) during the prime generation; this gives the random number</span><br><span class="line">generator a better chance to gain enough entropy.</span><br><span class="line">We need to generate a lot of random bytes. It is a good idea to perform</span><br><span class="line">some other action (<span class="built_in">type</span> on the keyboard, move the mouse, utilize the</span><br><span class="line">disks) during the prime generation; this gives the random number</span><br><span class="line">generator a better chance to gain enough entropy.</span><br><span class="line">gpg: /root/.gnupg/trustdb.gpg: trustdb created</span><br><span class="line">gpg: key 77A790ED marked as ultimately trusted</span><br><span class="line">public and secret key created and signed.</span><br><span class="line"></span><br><span class="line">gpg: checking the trustdb</span><br><span class="line">gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model</span><br><span class="line">gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u</span><br><span class="line">pub   1024R/77A790ED 2019-04-12</span><br><span class="line">      Key fingerprint = 34E9 51E2 0720 1186 FC26  6BED 5FDF ABE5 77A7 90ED</span><br><span class="line">uid                  hostB</span><br><span class="line">sub   1024R/3108F051 2019-04-12</span><br><span class="line"></span><br><span class="line">[root@hostB ~]<span class="comment"># ll .gnupg/</span></span><br><span class="line">total 28</span><br><span class="line">-rw------- 1 root root 7680 Apr 13 05:50 gpg.conf</span><br><span class="line">drwx------ 2 root root    6 Apr 13 05:50 private-keys-v1.d</span><br><span class="line">-rw------- 1 root root  649 Apr 13 05:51 pubring.gpg</span><br><span class="line">-rw------- 1 root root  649 Apr 13 05:51 pubring.gpg~</span><br><span class="line">-rw------- 1 root root  600 Apr 13 05:51 random_seed</span><br><span class="line">-rw------- 1 root root 1313 Apr 13 05:51 secring.gpg</span><br><span class="line">srwxr-xr-x 1 root root    0 Apr 13 05:50 S.gpg-agent</span><br><span class="line">-rw------- 1 root root 1280 Apr 13 05:51 trustdb.gpg</span><br><span class="line">公私钥文件已生成</span><br></pre></td></tr></table></figure>

<h3 id="二、主机A、B互换公钥文件"><a href="#二、主机A、B互换公钥文件" class="headerlink" title="二、主机A、B互换公钥文件"></a>二、主机A、B互换公钥文件</h3><p>1导出主机A公钥发送给B</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostA .gnupg]<span class="comment"># gpg -a --export -o hostA.pubkey        #导出公钥文件。</span></span><br><span class="line">[root@hostA .gnupg]<span class="comment"># cat hostA.pubkey </span></span><br><span class="line">-----BEGIN PGP PUBLIC KEY BLOCK-----</span><br><span class="line">Version: GnuPG v2.0.22 (GNU/Linux)</span><br><span class="line"></span><br><span class="line">mI0EXLEFGgEEALt/ZGwt9ZnkvzI0Ah0DJMFqYPbeTfLWtckiL/tKdkQShaA8pTqS</span><br><span class="line">ckAdeKRY1NRskKsInek3dD+V32n3PG8tTF8ZIQ6TpK8PgB/E+fKH2ftFQFchU+F8</span><br><span class="line">2lsJ0VKf7ILQ6Yre4mVeGo4HCwrJg+E6gEPspaajCyB4BIgApNzqmxNVABEBAAG0</span><br><span class="line">BWhvc3RBiLkEEwECACMFAlyxBRoCGwMHCwkIBwMCAQYVCAIJCgsEFgIDAQIeAQIX</span><br><span class="line">gAAKCRBHhgxjS5oLYj3RBACFK1NjY29XFnu2ZqpM6bSLLp5sf7fbKvUTUEhitXSo</span><br><span class="line">LB607v88KZoUFdcSQf9v+02KytzC1usW8P0NlevhwCJSRpcaO29GyXKnN07jsQAG</span><br><span class="line">J2TUDR91hgcFZ/j2mcZal+WlgwSQr0Skv4GojTpme/n00DVbZzGGL7QBiTH/45AZ</span><br><span class="line">pbiNBFyxBRoBBAC+rfAizsp3qturv4QXwjguar9HuXWffap7nFaQKUAC8S+a2EyG</span><br><span class="line">RcBvWci0sNXx9HJE4/61ExPF84TR4uc8fRkzWYb6sfPGwBxDFH5e9igPifwyEuqk</span><br><span class="line">QPO3eezRX5bNwLMSXyesUFCeJZ3Qy6BYV6S8vDJbjj6RYwWlLRUJv4rlHwARAQAB</span><br><span class="line">iJ8EGAECAAkFAlyxBRoCGwwACgkQR4YMY0uaC2IkvwP/ckneRcvcYqTCeINVPlqD</span><br><span class="line">ltUC3jn5U1Nu/dZKwt15R7l68Qr0ARBO8SuLlMH7wjBQ/c6grwohfdcXCqZN2gVq</span><br><span class="line">wWl2yamOpeOD4EqwnvaPGtP8t9j2gwGvM905NJRng8Ep+IOlqlNeljKjICLyNzmj</span><br><span class="line">rkRjxcSdDrQgIYZgH84hXZU=</span><br><span class="line">=4MIm</span><br><span class="line">-----END PGP PUBLIC KEY BLOCK-----</span><br><span class="line">[root@hostA .gnupg]<span class="comment"># scp hostA.pubkey root@192.168.172.138:/root/.gnupg</span></span><br><span class="line">The authenticity of host <span class="string">&#x27;192.168.172.138 (192.168.172.138)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:YNlH0VBV0kp4lAClVvfMWVx/bHcbKKHXQwyd13d+MME.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is MD5:8a:1c:3d:c2:04:b1:be:05:95:33:9e:16:e8:ad:6c:25.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>192.168.172.138<span class="string">&#x27; (ECDSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">root@192.168.172.138&#x27;</span>s password: </span><br><span class="line">hostA.pubkey                                         100%  984   808.9KB/s   00:00    </span><br></pre></td></tr></table></figure>

<p>2导出主机B公钥发送给A</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostB ~]<span class="comment"># gpg -a --export -o hostB.pubkey</span></span><br><span class="line">[root@hostB ~]<span class="comment"># cat hostB.pubkey</span></span><br><span class="line">-----BEGIN PGP PUBLIC KEY BLOCK-----</span><br><span class="line">Version: GnuPG v2.0.22 (GNU/Linux)</span><br><span class="line"></span><br><span class="line">mI0EXLEIRwEEAJwjA3oD/GMvu7WvBfp6ZOaRnLxkebI0nVQt5PFOukiDxKDMtn4L</span><br><span class="line">dcuja0JlP4F/MJpxx2pacuNODG/gV1Tu+5iOzxp1+/xJXrWjh0e+MCk3ubivQ5gj</span><br><span class="line">L9TOSbePb/gzRR89F2BexKq6dkVYgiWUZ0205p/qBOMT49Xos9JQ02qlABEBAAG0</span><br><span class="line">BWhvc3RCiLkEEwECACMFAlyxCEcCGwMHCwkIBwMCAQYVCAIJCgsEFgIDAQIeAQIX</span><br><span class="line">gAAKCRBf36vld6eQ7Xb7A/4kpjrW/JC14J0ZuMggFoI340ZZUOlT2f7JKvS+bAQK</span><br><span class="line">FXOgko6RblHo3PdaD+SimHDhzWibr0q05jpT0OlFP9PphgNfzBaUla/9v4heXcA5</span><br><span class="line">Rsg+J7Z5dbblz4Fe9Hn6uuFJX6PEV00SCVZ1JBOesj4JZuufNTpU09iC8gkl2ntj</span><br><span class="line">YLiNBFyxCEcBBACx6zvb6aH3mybpyqR2kdke0sAsof9sPVrv2UeHS5SSLe2qk38V</span><br><span class="line">GmTwuqLhkvhWrPX9jZza17uauWHItjLl2Xx6VKul4pUA9EPih9rOWTsmHQPhEUnW</span><br><span class="line">ZYVgt50Xn4YOjDaQiislS+AuR3XxeD4eaBtRatzMMQO/ibRV4EWXx6JLvQARAQAB</span><br><span class="line">iJ8EGAECAAkFAlyxCEcCGwwACgkQX9+r5XenkO2rFAP/UgUJ3lYn9rKlnNwsgnqL</span><br><span class="line">c38c6BovdzOveiYt+21QBQ5HElhRI/gZkpIiNi8pze1laaRzduTOj/23rNM5i3Cg</span><br><span class="line">uJulPnMBGLx2s57EuevO34mml+A6pBUIe3ETJhtv8/L3XH5wiMzVEyuzIJuLBA4c</span><br><span class="line">tt+3WYpY9rNUVeuLcHVd7vQ=</span><br><span class="line">=/T8O</span><br><span class="line">-----END PGP PUBLIC KEY BLOCK-----     </span><br><span class="line">[root@hostB ~]<span class="comment"># scp hostB.pubkey root@192.168.172.134:/root/.gnupg/</span></span><br><span class="line">The authenticity of host <span class="string">&#x27;192.168.172.134 (192.168.172.134)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:YNlH0VBV0kp4lAClVvfMWVx/bHcbKKHXQwyd13d+MME.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is MD5:8a:1c:3d:c2:04:b1:be:05:95:33:9e:16:e8:ad:6c:25.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>192.168.172.134<span class="string">&#x27; (ECDSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">root@192.168.172.134&#x27;</span>s password: </span><br><span class="line">hostB.pubkey                                         100%  984   861.8KB/s   00:00  </span><br></pre></td></tr></table></figure>

<p>3.主机A、B分别导入公钥  </p>
<p>主机A导入公钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostA .gnupg]<span class="comment"># gpg --import hostB.pubkey           #导入hostB的公钥</span></span><br><span class="line">gpg: key 77A790ED: public key <span class="string">&quot;hostB&quot;</span> imported</span><br><span class="line">gpg: Total number processed: 1</span><br><span class="line">gpg:               imported: 1  (RSA: 1)</span><br><span class="line">[root@hostA .gnupg]<span class="comment"># gpg --list-key                      #查看公钥列表</span></span><br><span class="line">/root/.gnupg/pubring.gpg</span><br><span class="line">------------------------</span><br><span class="line">pub   1024R/4B9A0B62 2019-04-12</span><br><span class="line">uid                  hostA</span><br><span class="line">sub   1024R/DD37BA59 2019-04-12</span><br><span class="line"></span><br><span class="line">pub   1024R/77A790ED 2019-04-12</span><br><span class="line">uid                  hostB</span><br><span class="line">sub   1024R/3108F051 2019-04-12</span><br></pre></td></tr></table></figure>

<p>主机B导入公钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostB ~]<span class="comment"># cd .gnupg/</span></span><br><span class="line">[root@hostB .gnupg]<span class="comment"># gpg --import hostA.pubkey </span></span><br><span class="line">gpg: key 4B9A0B62: public key <span class="string">&quot;hostA&quot;</span> imported</span><br><span class="line">gpg: Total number processed: 1</span><br><span class="line">gpg:               imported: 1  (RSA: 1)</span><br><span class="line">[root@hostB .gnupg]<span class="comment"># gpg --list-key </span></span><br><span class="line">/root/.gnupg/pubring.gpg</span><br><span class="line">------------------------</span><br><span class="line">pub   1024R/77A790ED 2019-04-12</span><br><span class="line">uid                  hostB</span><br><span class="line">sub   1024R/3108F051 2019-04-12</span><br><span class="line"></span><br><span class="line">pub   1024R/4B9A0B62 2019-04-12</span><br><span class="line">uid                  hostA</span><br><span class="line">sub   1024R/DD37BA59 2019-04-12</span><br></pre></td></tr></table></figure>

<h3 id="三、测试"><a href="#三、测试" class="headerlink" title="三、测试"></a>三、测试</h3><p>1.使用主机A对文件进行非对称加密，发送给主机B</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@hostA data]# echo &quot;hello,i am hostA&quot; &gt; file1</span><br><span class="line">[root@hostA data]# gpg -e -r hostB file1</span><br><span class="line">gpg: 3108F051: There is no assurance this key belongs to the named user</span><br><span class="line"></span><br><span class="line">pub  1024R/3108F051 2019-04-12 hostB</span><br><span class="line"> Primary key fingerprint: 34E9 51E2 0720 1186 FC26  6BED 5FDF ABE5 77A7 90ED</span><br><span class="line">      Subkey fingerprint: 57FD 2BBD D2B0 8EE4 9BCA  74A5 2091 0199 3108 F051</span><br><span class="line"></span><br><span class="line">It is NOT certain that the key belongs to the person named</span><br><span class="line">in the user ID.  If you *really* know what you are doing,</span><br><span class="line">you may answer the next question with yes.</span><br><span class="line"></span><br><span class="line">Use this key anyway? (y/N) y</span><br><span class="line">[root@hostA data]# scp file1.gpg root@192.168.172.138:/data</span><br><span class="line">root@192.168.172.138&#x27;s password: </span><br><span class="line">file1.gpg                                            100%  225    87.2KB/s   00:00    </span><br></pre></td></tr></table></figure>

<p>2.解密查看其中内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostB data]<span class="comment"># gpg -o file1 file1.gpg </span></span><br><span class="line">gpg: encrypted with 1024-bit RSA key, ID 3108F051, created 2019-04-12</span><br><span class="line">      <span class="string">&quot;hostB&quot;</span></span><br><span class="line">[root@hostB data]<span class="comment"># cat file1</span></span><br><span class="line">hello,i am hostA</span><br></pre></td></tr></table></figure>

<h3 id="四、清除密钥"><a href="#四、清除密钥" class="headerlink" title="四、清除密钥"></a>四、清除密钥</h3><p>1.清除公钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostA data]<span class="comment"># gpg --delete-key hostB             #删除hostB的公钥</span></span><br><span class="line">gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pub  1024R/77A790ED 2019-04-12 hostB</span><br><span class="line"></span><br><span class="line">Delete this key from the keyring? (y/N) y</span><br><span class="line"></span><br><span class="line">[root@hostA data]<span class="comment"># gpg --list-key                     #查看密钥列表此时已经没有hostB了</span></span><br><span class="line">/root/.gnupg/pubring.gpg</span><br><span class="line">------------------------</span><br><span class="line">pub   1024R/4B9A0B62 2019-04-12</span><br><span class="line">uid                  hostA</span><br><span class="line">sub   1024R/DD37BA59 2019-04-12</span><br><span class="line"></span><br><span class="line">[root@hostA ~]<span class="comment"># ll .gnupg/</span></span><br><span class="line">total 40</span><br><span class="line">-rw------- 1 root root  649 Apr 13 05:48 192.168.172.138</span><br><span class="line">-rw------- 1 root root 7680 Apr 13 05:36 gpg.conf</span><br><span class="line">-rw-r--r-- 1 root root  984 Apr 13 06:02 hostA.pubkey</span><br><span class="line">-rw-r--r-- 1 root root  984 Apr 13 06:06 hostB.pubkey</span><br><span class="line">drwx------ 2 root root    6 Apr 13 05:37 private-keys-v1.d</span><br><span class="line">-rw------- 1 root root  649 Apr 13 06:32 pubring.gpg</span><br><span class="line">-rw------- 1 root root 1298 Apr 13 06:09 pubring.gpg~             <span class="comment">#hostB的密钥虽然被清除但是仍可以用此文件恢复</span></span><br><span class="line">-rw------- 1 root root  600 Apr 13 06:15 random_seed</span><br><span class="line">-rw------- 1 root root 1313 Apr 13 05:37 secring.gpg</span><br><span class="line">srwxr-xr-x 1 root root    0 Apr 13 05:37 S.gpg-agent</span><br><span class="line">-rw------- 1 root root 1280 Apr 13 05:37 trustdb.gpg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.删除自己的公钥和私钥</p>
<p>要删除自己的公钥必须先清除私钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hostA ~]<span class="comment"># gpg --delete-secret-key hostA                  #删除自己的私钥</span></span><br><span class="line">gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sec  1024R/4B9A0B62 2019-04-12 hostA</span><br><span class="line"></span><br><span class="line">Delete this key from the keyring? (y/N) y</span><br><span class="line">This is a secret key! - really delete? (y/N) y</span><br><span class="line">[root@hostA ~]<span class="comment"># gpg --delete-key hostA                         #删除自己的私钥</span></span><br><span class="line">gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pub  1024R/4B9A0B62 2019-04-12 hostA</span><br><span class="line"></span><br><span class="line">Delete this key from the keyring? (y/N) y</span><br><span class="line">[root@hostA ~]<span class="comment"># rm -rf .gnupg/                                 #将/root/.gnupg目录删除</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>security</tag>
      </tags>
  </entry>
  <entry>
    <title>磁盘分区表的备份、删除和恢复</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/%E5%A4%87%E4%BB%BD%E5%88%A0%E9%99%A4%E6%81%A2%E5%A4%8Dmbr/%E5%88%A0%E9%99%A4%E5%A4%87%E4%BB%BDmbr%E5%88%86%E5%8C%BA%E8%A1%A8/</url>
    <content><![CDATA[<h2 id="磁盘分区表的备份、删除和恢复"><a href="#磁盘分区表的备份、删除和恢复" class="headerlink" title="磁盘分区表的备份、删除和恢复"></a>磁盘分区表的备份、删除和恢复</h2><h3 id="简要说明"><a href="#简要说明" class="headerlink" title="简要说明"></a>简要说明</h3><p>MBR分区磁盘的分区表信息存放在硬盘0磁道第0个扇区内总共512字节，前446字节为bootloader。中间64位为磁盘分区表信息，每个分区信息占16个字节，总计存放4个分区。(这段就是需要备份出来的数据)最后的aa55为结束标志位。</p>
<span id="more"></span>

<hr>
<h3 id="一、分区表的备份"><a href="#一、分区表的备份" class="headerlink" title="一、分区表的备份"></a>一、分区表的备份</h3><p>首先先查看下硬盘前512字节，从2080开启时至aa55前的64字节就是我们需要备份的磁盘分区表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># hexdump -n 512 /dev/sda</span></span><br><span class="line">0000000 63eb 1090 d08e 00bc b8b0 0000 d88e c08e</span><br><span class="line">0000010 befb 7c00 00bf b906 0200 a4f3 21ea 0006</span><br><span class="line">0000020 be00 07be 0438 0b75 c683 8110 fefe 7507</span><br><span class="line">0000030 ebf3 b416 b002 bb01 7c00 80b2 748a 8b01</span><br><span class="line">0000040 024c 13cd 00ea 007c eb00 00fe 0000 0000</span><br><span class="line">0000050 0000 0000 0000 0000 0000 8000 0001 0000</span><br><span class="line">0000060 0000 0000 faff 9090 c2f6 7480 f605 70c2</span><br><span class="line">0000070 0274 80b2 79ea 007c 3100 8ec0 8ed8 bcd0</span><br><span class="line">0000080 2000 a0fb 7c64 ff3c 0274 c288 be52 7c05</span><br><span class="line">0000090 41b4 aabb cd55 5a13 7252 813d 55fb 75aa</span><br><span class="line">00000a0 8337 01e1 3274 c031 4489 4004 4488 89ff</span><br><span class="line">00000b0 0244 04c7 0010 8b66 5c1e 667c 5c89 6608</span><br><span class="line">00000c0 1e8b 7c60 8966 0c5c 44c7 0006 b470 cd42</span><br><span class="line">00000d0 7213 bb05 7000 76eb 08b4 13cd 0d73 845a</span><br><span class="line">00000e0 0fd2 de83 be00 7d85 82e9 6600 b60f 88c6</span><br><span class="line">00000f0 ff64 6640 4489 0f04 d1b6 e2c1 8802 88e8</span><br><span class="line">0000100 40f4 4489 0f08 c2b6 e8c0 6602 0489 a166</span><br><span class="line">0000110 7c60 0966 75c0 664e 5ca1 667c d231 f766</span><br><span class="line">0000120 8834 31d1 66d2 74f7 3b04 0844 377d c1fe</span><br><span class="line">0000130 c588 c030 e8c1 0802 88c1 5ad0 c688 00bb</span><br><span class="line">0000140 8e70 31c3 b8db 0201 13cd 1e72 c38c 1e60</span><br><span class="line">0000150 00b9 8e01 31db bff6 8000 c68e f3fc 1fa5</span><br><span class="line">0000160 ff61 5a26 be7c 7d80 03eb 8fbe e87d 0034</span><br><span class="line">0000170 94be e87d 002e 18cd feeb 5247 4255 0020</span><br><span class="line">0000180 6547 6d6f 4800 7261 2064 6944 6b73 5200</span><br><span class="line">0000190 6165 0064 4520 7272 726f 0a0d bb00 0001</span><br><span class="line">00001a0 0eb4 10cd 3cac 7500 c3f4 0000 0000 0000</span><br><span class="line">00001b0 0000 0000 0000 0000 b4f0 000a 0000 2080         <span class="comment">#2080:分区表开始</span></span><br><span class="line">00001c0 0021 aa83 8228 0800 0000 0000 0020 aa00</span><br><span class="line">00001d0 8229 fe83 ffff 0800 0020 0000 0c80 fe00         </span><br><span class="line">00001e0 ffff fe83 ffff 0800 0ca0 0000 0640 fe00         </span><br><span class="line">00001f0 ffff fe05 ffff 0800 12e0 f800 061f aa55         <span class="comment">#061f:分区表结束</span></span><br><span class="line">0000200</span><br></pre></td></tr></table></figure>

<p>1.使用dd命令将硬盘分区表的信息备份出来。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># dd if=/dev/sda of=mbr.bak bs=1 count=64 skip=446  复制sda的内的信息，复制方法为跳过前446个字节</span></span><br><span class="line">64+0 records <span class="keyword">in</span></span><br><span class="line">64+0 records out</span><br><span class="line">64 bytes (64 B) copied, 0.000224581 s, 285 kB/s</span><br></pre></td></tr></table></figure>

<p>2.查看下所备份出来的数据，然后将其备份至远程主机上，也可以将其复制到U盘进行备份，此处以远程主机为例。  </p>
<p>查看备份数据，确保备份数据的正确性</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># hexdump mbr.bak                   #确保备份出来的数据没有错误</span></span><br><span class="line">0000000 2080 0021 aa83 8228 0800 0000 0000 0020</span><br><span class="line">0000010 aa00 8229 fe83 ffff 0800 0020 0000 0c80</span><br><span class="line">0000020 fe00 ffff fe83 ffff 0800 0ca0 0000 0640</span><br><span class="line">0000030 fe00 ffff fe05 ffff 0800 12e0 f800 061f</span><br><span class="line">0000040</span><br></pre></td></tr></table></figure>

<p>将文件备份至远程主机，并登录远程主机查看下数据。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># scp mbr.bak root@192.168.172.140:/root</span></span><br><span class="line">The authenticity of host <span class="string">&#x27;192.168.172.140 (192.168.172.140)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">RSA key fingerprint is SHA256:gPedPBi+OsdkYR+Y7j26ViQWSi4lIPU4cViDPImib0A.</span></span><br><span class="line"><span class="string">RSA key fingerprint is MD5:46:d8:67:07:f3:51:87:95:2c:d7:4b:27:ce:85:a2:ed.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>192.168.172.140<span class="string">&#x27; (RSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">root@192.168.172.140&#x27;</span>s password: </span><br><span class="line">mbr.bak                                                          100%   64    51.9KB/s   00:00    </span><br><span class="line">[root@centos7 ~]<span class="comment"># ssh root@192.168.172.140</span></span><br><span class="line">root@192.168.172.140<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Last login: Sat Mar 23 20:48:30 2019</span></span><br><span class="line"><span class="string">[root@centos6 ~]# ls</span></span><br><span class="line"><span class="string">anaconda-ks.cfg  install.log  install.log.syslog  mbr.bak</span></span><br><span class="line"><span class="string">[root@centos6 ~]# hexdump mbr.bak </span></span><br><span class="line"><span class="string">0000000 2080 0021 aa83 8228 0800 0000 0000 0020</span></span><br><span class="line"><span class="string">0000010 aa00 8229 fe83 ffff 0800 0020 0000 0c80</span></span><br><span class="line"><span class="string">0000020 fe00 ffff fe83 ffff 0800 0ca0 0000 0640</span></span><br><span class="line"><span class="string">0000030 fe00 ffff fe05 ffff 0800 12e0 f800 061f</span></span><br><span class="line"><span class="string">0000040</span></span><br></pre></td></tr></table></figure>

<p>注意：千万不要把备份文件放在本机，否则当分区表被破坏后，磁盘将无法读取内部的任何数据，存放在本地的备份毫无意义。</p>
<hr>
<h3 id="二、删除和恢复"><a href="#二、删除和恢复" class="headerlink" title="二、删除和恢复"></a>二、删除和恢复</h3><h4 id="1-清空磁盘分区表"><a href="#1-清空磁盘分区表" class="headerlink" title="1.清空磁盘分区表"></a>1.清空磁盘分区表</h4><p>将446字节后的64字节清空</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># dd if=/dev/zero of=/dev/sda bs=1 count=64 seek=446</span></span><br><span class="line">64+0 records <span class="keyword">in</span></span><br><span class="line">64+0 records out</span><br><span class="line">64 bytes (64 B) copied, 0.000366417 s, 175 kB/s</span><br><span class="line">[root@centos7 ~]<span class="comment"># reboot</span></span><br></pre></td></tr></table></figure>

<p>至此，磁盘分区已被破坏重启后将无法进入系统。重启。   </p>
<h4 id="2-恢复MBR分区表"><a href="#2-恢复MBR分区表" class="headerlink" title="2.恢复MBR分区表"></a>2.恢复MBR分区表</h4><p>1.重启后显示没有磁盘</p>
<p><img src="1.png" alt="1.png"></p>
<p>2.重启选择光盘模式</p>
<p><img src="2.png" alt="2.png"></p>
<p>3.选择Troubleshooting</p>
<p><img src="3.png" alt="3.png"></p>
<p>4.选择Rescue a CentOS System进入救援模式</p>
<p><img src="4.png" alt="4.png"></p>
<p>5.选择1 continue</p>
<p><img src="5.png" alt="5.png"></p>
<p>6.此时主机没有网络地址无法从远程主机获取备份文件。所以先给本地主机配置IP地址</p>
<p><img src="6.png" alt="6.png"></p>
<p>7.获取地址后将远程主机上的mbr.bak文件拉取至本机</p>
<p><img src="7.png" alt="7.png"></p>
<p>8.将备份的分区表重新恢复至/dev/sda内，然后重启</p>
<p><img src="8.png" alt="8.png"></p>
<p>9.此时注意已经都能正常启动。</p>
<p><img src="9.png" alt="9.png"></p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>系统修复</tag>
      </tags>
  </entry>
  <entry>
    <title>互联网DNS架构的实现</title>
    <url>/2019/03/14/Linux%E5%9F%BA%E7%A1%80/%E5%AE%9E%E7%8E%B0Internet-dns%E6%9E%B6%E6%9E%84/%E5%AE%9E%E7%8E%B0Internet-dns%E6%9E%B6%E6%9E%84/</url>
    <content><![CDATA[<h2 id="互联网DNS架构的实现"><a href="#互联网DNS架构的实现" class="headerlink" title="互联网DNS架构的实现"></a>互联网DNS架构的实现</h2><p>互联网中dns的架构为下图所示，当本地的DNS服务器无法解析域名时就会向互联网上的dns服务器去迭代查询，直到找到相应的服务器位置。</p>
<span id="more"></span>

<p><img src="dns%E7%BB%93%E6%9E%84.png" alt="dns结构.png"></p>
<p>以下为具体的实现方式</p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">OS</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">www</td>
<td align="left">centos6</td>
<td align="left">192.168.73.2</td>
</tr>
<tr>
<td align="left">client</td>
<td align="left">centos6</td>
<td align="left">192.168.73.3</td>
</tr>
<tr>
<td align="left">mylinuxopsdns1</td>
<td align="left">centos7</td>
<td align="left">192.168.73.10</td>
</tr>
<tr>
<td align="left">mylinuxopsdns2</td>
<td align="left">centos7</td>
<td align="left">192.168.73.20</td>
</tr>
<tr>
<td align="left">comdns</td>
<td align="left">centos7</td>
<td align="left">192.168.73.30</td>
</tr>
<tr>
<td align="left">rootdns</td>
<td align="left">centos7</td>
<td align="left">192.168.73.40</td>
</tr>
<tr>
<td align="left">ldns</td>
<td align="left">centos7</td>
<td align="left">192.168.73.50</td>
</tr>
</tbody></table>
<hr>
<h3 id="一、在www主机上部署httpd服务"><a href="#一、在www主机上部署httpd服务" class="headerlink" title="一、在www主机上部署httpd服务"></a>一、在www主机上部署httpd服务</h3><h4 id="1-启动httpd服务"><a href="#1-启动httpd服务" class="headerlink" title="1.启动httpd服务"></a>1.启动httpd服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># service httpd start</span></span><br><span class="line">Starting httpd: httpd: apr_sockaddr_info_get() failed <span class="keyword">for</span> www</span><br><span class="line">httpd: Could not reliably determine the server<span class="string">&#x27;s fully qualified domain name, using 127.0.0.1 for ServerName</span></span><br><span class="line"><span class="string">                                                           [  OK  ]</span></span><br></pre></td></tr></table></figure>

<h4 id="2-为http主机创建一个主页"><a href="#2-为http主机创建一个主页" class="headerlink" title="2.为http主机创建一个主页"></a>2.为http主机创建一个主页</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># echo &quot;&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;&quot; &gt; /var/www/html/index.html</span></span><br></pre></td></tr></table></figure>

<h4 id="3-测试"><a href="#3-测试" class="headerlink" title="3.测试"></a>3.测试</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># curl 192.168.73.2</span></span><br><span class="line">&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<h3 id="二、配置mylinuxopsdns1"><a href="#二、配置mylinuxopsdns1" class="headerlink" title="二、配置mylinuxopsdns1"></a>二、配置mylinuxopsdns1</h3><h4 id="1-安装bind服务"><a href="#1-安装bind服务" class="headerlink" title="1.安装bind服务"></a>1.安装bind服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># yum install bind -y</span></span><br></pre></td></tr></table></figure>

<h4 id="2-启动服务应设置为开机启动"><a href="#2-启动服务应设置为开机启动" class="headerlink" title="2.启动服务应设置为开机启动"></a>2.启动服务应设置为开机启动</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># systemctl start named</span></span><br><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># systemctl enable named</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/named.service to /usr/lib/systemd/system/named.service.</span><br></pre></td></tr></table></figure>

<h4 id="3-修改dns主配置文件"><a href="#3-修改dns主配置文件" class="headerlink" title="3.修改dns主配置文件"></a>3.修改dns主配置文件</h4><p>将监听地址和允许访问的主机注释</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//      allow-query     &#123; localhost; &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="4-修改区域配置文件，添加区域记录"><a href="#4-修改区域配置文件，添加区域记录" class="headerlink" title="4.修改区域配置文件，添加区域记录"></a>4.修改区域配置文件，添加区域记录</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># vim /etc/named.rfc1912.zones </span></span><br><span class="line">zone <span class="string">&quot;mylinuxops.com&quot;</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> master;</span><br><span class="line">        file <span class="string">&quot;mylinuxops.com.zone&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="5-创建区域数据库文件"><a href="#5-创建区域数据库文件" class="headerlink" title="5.创建区域数据库文件"></a>5.创建区域数据库文件</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># cp -p /var/named/&#123;named.localhost,mylinuxops.com.zone&#125;</span></span><br><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># vim /var/named/mylinuxops.com.zone</span></span><br><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@       IN SOA  master admin.mylinuxops.com (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      master</span><br><span class="line">        NS      slave</span><br><span class="line">master  A       192.168.73.10</span><br><span class="line">slave   A       192.168.73.20</span><br><span class="line">www     A       192.168.73.2</span><br></pre></td></tr></table></figure>

<h4 id="6-检查语法错误"><a href="#6-检查语法错误" class="headerlink" title="6.检查语法错误"></a>6.检查语法错误</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># named-checkconf </span></span><br><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># named-checkzone mylinuxops.com /var/named/mylinuxops.com.zone </span></span><br><span class="line">zone mylinuxops.com/IN: loaded serial 0</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h4 id="7-重读配置文件"><a href="#7-重读配置文件" class="headerlink" title="7.重读配置文件"></a>7.重读配置文件</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># rndc reload</span></span><br></pre></td></tr></table></figure>

<h4 id="8-在client主机上测试"><a href="#8-在client主机上测试" class="headerlink" title="8.在client主机上测试"></a>8.在client主机上测试</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@client ~]<span class="comment"># dig www.mylinuxops.com @192.168.73.10</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.68.rc1.el6 &lt;&lt;&gt;&gt; www.mylinuxops.com @192.168.73.10</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 24888</span></span><br><span class="line"><span class="string">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;www.mylinuxops.com.		IN	A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">www.mylinuxops.com.	86400	IN	A	192.168.73.2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; AUTHORITY SECTION:</span></span><br><span class="line"><span class="string">mylinuxops.com.		86400	IN	NS	master.mylinuxops.com.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ADDITIONAL SECTION:</span></span><br><span class="line"><span class="string">master.mylinuxops.com.	86400	IN	A	192.168.73.10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 1 msec</span></span><br><span class="line"><span class="string">;; SERVER: 192.168.73.10#53(192.168.73.10)</span></span><br><span class="line"><span class="string">;; WHEN: Fri Apr 19 04:23:08 2019</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 89</span></span><br></pre></td></tr></table></figure>

<h3 id="三、配置dns从服务器mylinuxopsdns2"><a href="#三、配置dns从服务器mylinuxopsdns2" class="headerlink" title="三、配置dns从服务器mylinuxopsdns2"></a>三、配置dns从服务器mylinuxopsdns2</h3><h4 id="1-安装bind服务-1"><a href="#1-安装bind服务-1" class="headerlink" title="1.安装bind服务"></a>1.安装bind服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns2 ~]<span class="comment"># yum install bind -y</span></span><br></pre></td></tr></table></figure>

<h4 id="2-启动dns服务设置为开机自动启动"><a href="#2-启动dns服务设置为开机自动启动" class="headerlink" title="2.启动dns服务设置为开机自动启动"></a>2.启动dns服务设置为开机自动启动</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns2 ~]<span class="comment"># systemctl start named</span></span><br><span class="line">[root@mylinuxopsdns2 ~]<span class="comment"># systemctl enable named</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/named.service to /usr/lib/systemd/system/named.service.</span><br></pre></td></tr></table></figure>

<h4 id="3-修改主配置文件"><a href="#3-修改主配置文件" class="headerlink" title="3.修改主配置文件"></a>3.修改主配置文件</h4><p>将端口行和允许访问的主机注释</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns2 ~]<span class="comment"># vim /etc/named.conf </span></span><br><span class="line">options &#123;</span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//      allow-query     &#123; localhost; &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="4-修改区域配置文件"><a href="#4-修改区域配置文件" class="headerlink" title="4.修改区域配置文件"></a>4.修改区域配置文件</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns2 ~]<span class="comment"># vim /etc/named.rfc1912.zones </span></span><br><span class="line">zone <span class="string">&quot;mylinuxops.com&quot;</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> slave;</span><br><span class="line">        masters &#123;192.168.73.10;&#125;;</span><br><span class="line">        file <span class="string">&quot;slaves/mylinuxops.zone&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="5-检查语法错误"><a href="#5-检查语法错误" class="headerlink" title="5.检查语法错误"></a>5.检查语法错误</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns2 ~]<span class="comment"># named-checkconf</span></span><br></pre></td></tr></table></figure>

<h4 id="6-重读配置文件"><a href="#6-重读配置文件" class="headerlink" title="6.重读配置文件"></a>6.重读配置文件</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns2 ~]<span class="comment"># rndc reload</span></span><br></pre></td></tr></table></figure>

<h4 id="7-查看区域数据库文件是否已经被拉取到本地"><a href="#7-查看区域数据库文件是否已经被拉取到本地" class="headerlink" title="7.查看区域数据库文件是否已经被拉取到本地"></a>7.查看区域数据库文件是否已经被拉取到本地</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ll /var/named/slaves/</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 named named 298 Apr 23 04:40 mylinuxops.zone</span><br></pre></td></tr></table></figure>

<h4 id="8-安全加固"><a href="#8-安全加固" class="headerlink" title="8.安全加固"></a>8.安全加固</h4><p>由于主从dns服务器都没有对能拉取区域数据库的主机加以限制，这样是非常不安全的，所以需要对主机的安全行进行加固</p>
<h5 id="8-1对从服务器主配置文件修改，添加allow-transfer"><a href="#8-1对从服务器主配置文件修改，添加allow-transfer" class="headerlink" title="8.1对从服务器主配置文件修改，添加allow-transfer"></a>8.1对从服务器主配置文件修改，添加allow-transfer</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns2 ~]<span class="comment"># vim /etc/named.conf </span></span><br><span class="line">options &#123;</span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">        allow-transfer  &#123;none;&#125;;</span><br><span class="line">//      allow-query     &#123; localhost; &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@mylinuxopsdns2 ~]<span class="comment"># rndc reload</span></span><br><span class="line">server reload successful</span><br></pre></td></tr></table></figure>

<h5 id="8-2对主服务器主配置文件修改，添加allow-transfer只允许从服务来拉取数据"><a href="#8-2对主服务器主配置文件修改，添加allow-transfer只允许从服务来拉取数据" class="headerlink" title="8.2对主服务器主配置文件修改，添加allow-transfer只允许从服务来拉取数据"></a>8.2对主服务器主配置文件修改，添加allow-transfer只允许从服务来拉取数据</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># vim /etc/named.conf </span></span><br><span class="line">options &#123;</span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">        allow-transfer  &#123;192.168.73.20;&#125;;</span><br><span class="line">//      allow-query     &#123; localhost; &#125;;</span><br><span class="line"></span><br><span class="line">[root@mylinuxopsdns1 ~]<span class="comment"># rndc reload</span></span><br><span class="line">server reload successful</span><br></pre></td></tr></table></figure>

<h3 id="四、搭建com域dns服务器"><a href="#四、搭建com域dns服务器" class="headerlink" title="四、搭建com域dns服务器"></a>四、搭建com域dns服务器</h3><h4 id="1-安装dns服务"><a href="#1-安装dns服务" class="headerlink" title="1.安装dns服务"></a>1.安装dns服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@comdns ~]<span class="comment"># yum install bind -y</span></span><br></pre></td></tr></table></figure>
<h4 id="2-修改dns主配置文件"><a href="#2-修改dns主配置文件" class="headerlink" title="2.修改dns主配置文件"></a>2.修改dns主配置文件</h4><p>将监听的ip和允许访问的主机行注释</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@comdns ~]<span class="comment"># vim /etc/named.conf </span></span><br><span class="line">options &#123;</span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//      allow-query     &#123; localhost; &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="3-修改区域文件添加com域"><a href="#3-修改区域文件添加com域" class="headerlink" title="3.修改区域文件添加com域"></a>3.修改区域文件添加com域</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@comdns ~]<span class="comment"># vim /etc/named.rfc1912.zones</span></span><br><span class="line">zone <span class="string">&quot;com&quot;</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> master;</span><br><span class="line">        file <span class="string">&quot;com.zone&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="4-创建区域数据库文件"><a href="#4-创建区域数据库文件" class="headerlink" title="4.创建区域数据库文件"></a>4.创建区域数据库文件</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@comdns ~]<span class="comment"># cp -p /var/named/&#123;named.localhost,com.zone&#125;</span></span><br><span class="line">[root@comdns ~]<span class="comment"># vim /var/named/com.zone</span></span><br><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@       IN SOA  master admin.mylinuxops.com.  (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">                NS      master</span><br><span class="line">mylinuxops      NS      ns1</span><br><span class="line">mylinuxops      NS      ns2</span><br><span class="line">master          A       192.168.73.30</span><br><span class="line">ns1             A       192.168.73.10</span><br><span class="line">ns2             A       192.168.73.20</span><br></pre></td></tr></table></figure>

<h4 id="5-检查配置文件语法"><a href="#5-检查配置文件语法" class="headerlink" title="5.检查配置文件语法"></a>5.检查配置文件语法</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@comdns ~]<span class="comment"># named-checkconf </span></span><br><span class="line">[root@comdns ~]<span class="comment"># named-checkzone com /var/named/com.zone </span></span><br><span class="line">zone com/IN: loaded serial 0</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h4 id="6-启动服务"><a href="#6-启动服务" class="headerlink" title="6.启动服务"></a>6.启动服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@comdns ~]<span class="comment"># systemctl restart named</span></span><br></pre></td></tr></table></figure>

<h4 id="7-测试"><a href="#7-测试" class="headerlink" title="7.测试"></a>7.测试</h4><p>在client端进行测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@clinet ~]<span class="comment"># dig www.mylinuxops.com @192.168.73.30</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-72.el7 &lt;&lt;&gt;&gt; www.mylinuxops.com @192.168.73.30</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 47115</span></span><br><span class="line"><span class="string">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;www.mylinuxops.com.		IN	A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">www.mylinuxops.com.	86400	IN	A	192.168.73.2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; AUTHORITY SECTION:</span></span><br><span class="line"><span class="string">mylinuxops.com.		86400	IN	NS	ns2.com.</span></span><br><span class="line"><span class="string">mylinuxops.com.		86400	IN	NS	ns1.com.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ADDITIONAL SECTION:</span></span><br><span class="line"><span class="string">ns1.com.		86400	IN	A	192.168.73.10</span></span><br><span class="line"><span class="string">ns2.com.		86400	IN	A	192.168.73.20</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 6 msec</span></span><br><span class="line"><span class="string">;; SERVER: 192.168.73.30#53(192.168.73.30)</span></span><br><span class="line"><span class="string">;; WHEN: Tue Apr 23 17:25:07 CST 2019</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 131</span></span><br></pre></td></tr></table></figure>

<h3 id="五、搭建root域上的dns服务"><a href="#五、搭建root域上的dns服务" class="headerlink" title="五、搭建root域上的dns服务"></a>五、搭建root域上的dns服务</h3><h4 id="1-安装dns服务-1"><a href="#1-安装dns服务-1" class="headerlink" title="1.安装dns服务"></a>1.安装dns服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@rootdns ~]<span class="comment"># yum install bind -y</span></span><br></pre></td></tr></table></figure>

<h4 id="2-修改主配置文件"><a href="#2-修改主配置文件" class="headerlink" title="2.修改主配置文件"></a>2.修改主配置文件</h4><p>将监听地址和允许访问的主机行注释，修改最底下的根域</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@rootdns ~]<span class="comment"># vim /etc/named.conf</span></span><br><span class="line">options &#123;</span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//      allow-query     &#123; localhost; &#125;;</span><br><span class="line">....</span><br><span class="line">zone <span class="string">&quot;.&quot;</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> master;</span><br><span class="line">        file <span class="string">&quot;root.zone&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="3-创建根域数据库"><a href="#3-创建根域数据库" class="headerlink" title="3.创建根域数据库"></a>3.创建根域数据库</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@rootdns ~]<span class="comment"># cp -p /var/named/&#123;named.localhost,root.zone&#125;</span></span><br><span class="line">[root@rootdns ~]<span class="comment"># vim /var/named/root.zone</span></span><br><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@       IN SOA  ns1 admin.mylinuxops.com. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      ns1</span><br><span class="line">com     NS      master</span><br><span class="line">ns1     A       192.168.73.40</span><br><span class="line">master  A       192.168.73.30</span><br></pre></td></tr></table></figure>

<h4 id="4-检查语法错误"><a href="#4-检查语法错误" class="headerlink" title="4.检查语法错误"></a>4.检查语法错误</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@rootdns ~]<span class="comment"># named-checkconf </span></span><br><span class="line">[root@rootdns ~]<span class="comment"># named-checkzone . /var/named/root.zone </span></span><br><span class="line">zone ./IN: loaded serial 0</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h4 id="5-启动dns服务"><a href="#5-启动dns服务" class="headerlink" title="5.启动dns服务"></a>5.启动dns服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@rootdns ~]<span class="comment"># systemctl start named</span></span><br><span class="line">[root@rootdns ~]<span class="comment"># systemctl enable named</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/named.service to /usr/lib/systemd/system/named.service.</span><br></pre></td></tr></table></figure>

<h4 id="6-测试"><a href="#6-测试" class="headerlink" title="6.测试"></a>6.测试</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># dig www.mylinuxops.com @192.168.73.40</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-72.el7 &lt;&lt;&gt;&gt; www.mylinuxops.com @192.168.73.40</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 38921</span></span><br><span class="line"><span class="string">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;www.mylinuxops.com.		IN	A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">www.mylinuxops.com.	86400	IN	A	192.168.73.2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; AUTHORITY SECTION:</span></span><br><span class="line"><span class="string">mylinuxops.com.		85104	IN	NS	ns1.com.</span></span><br><span class="line"><span class="string">mylinuxops.com.		85104	IN	NS	ns2.com.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ADDITIONAL SECTION:</span></span><br><span class="line"><span class="string">ns1.com.		85104	IN	A	192.168.73.10</span></span><br><span class="line"><span class="string">ns2.com.		85104	IN	A	192.168.73.20</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 2 msec</span></span><br><span class="line"><span class="string">;; SERVER: 192.168.73.40#53(192.168.73.40)</span></span><br><span class="line"><span class="string">;; WHEN: Tue Apr 23 17:59:09 CST 2019</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 131</span></span><br></pre></td></tr></table></figure>

<h3 id="六、配置本地DNS"><a href="#六、配置本地DNS" class="headerlink" title="六、配置本地DNS"></a>六、配置本地DNS</h3><h4 id="1-安装dns服务-2"><a href="#1-安装dns服务-2" class="headerlink" title="1.安装dns服务"></a>1.安装dns服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ldns ~]<span class="comment"># yum install bind -y</span></span><br></pre></td></tr></table></figure>

<h4 id="2-修改本地DNS的主配置文件"><a href="#2-修改本地DNS的主配置文件" class="headerlink" title="2.修改本地DNS的主配置文件"></a>2.修改本地DNS的主配置文件</h4><p>将监听地址和允许访问的主机注释，将dnssec相关的两项关闭</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ldns ~]<span class="comment"># vim /etc/named.conf </span></span><br><span class="line">options &#123;</span><br><span class="line">//      listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//      allow-query     &#123; localhost; &#125;;</span><br><span class="line">....</span><br><span class="line">        dnssec-enable no;</span><br><span class="line">        dnssec-validation no;</span><br></pre></td></tr></table></figure>

<h4 id="3-修改本地的根数据文件"><a href="#3-修改本地的根数据文件" class="headerlink" title="3.修改本地的根数据文件"></a>3.修改本地的根数据文件</h4><p>将根数据库文件指向rootdns所在的地址，其余的全部删除</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ldns ~]<span class="comment"># vim /var/named/named.ca</span></span><br><span class="line">.                       518400  IN      NS      a.root-servers.net.</span><br><span class="line">a.root-servers.net.     3600000 IN      A       192.168.73.40</span><br></pre></td></tr></table></figure>

<h3 id="七、在client进行测试"><a href="#七、在client进行测试" class="headerlink" title="七、在client进行测试"></a>七、在client进行测试</h3><h4 id="1-配置client端的网卡将其dns指向本地的dns服务器"><a href="#1-配置client端的网卡将其dns指向本地的dns服务器" class="headerlink" title="1.配置client端的网卡将其dns指向本地的dns服务器"></a>1.配置client端的网卡将其dns指向本地的dns服务器</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@client ~]<span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-ens33 </span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">NAME=ens33</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=on</span><br><span class="line">IPADDR=192.168.73.3</span><br><span class="line">PREFIX=24</span><br><span class="line">DNS1=192.168.73.50</span><br></pre></td></tr></table></figure>

<h4 id="2-重启服务"><a href="#2-重启服务" class="headerlink" title="2.重启服务"></a>2.重启服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># systemctl restart network</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line"><span class="comment"># Generated by NetworkManager</span></span><br><span class="line">nameserver 192.168.73.50</span><br></pre></td></tr></table></figure>

<h4 id="3-测试访问www-mylinuxops-com"><a href="#3-测试访问www-mylinuxops-com" class="headerlink" title="3.测试访问www.mylinuxops.com"></a>3.测试访问<a href="http://www.mylinuxops.com/">www.mylinuxops.com</a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># curl www.mylinuxops.com</span></span><br><span class="line">&lt;h1&gt;welcome to mylinuxops.com&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>DNS</tag>
      </tags>
  </entry>
  <entry>
    <title>私有CA建立和证书申请</title>
    <url>/2019/03/09/Linux%E5%9F%BA%E7%A1%80/%E5%BB%BA%E7%AB%8B%E7%A7%81%E6%9C%89ca/%E5%BB%BA%E7%AB%8B%E7%A7%81%E6%9C%89CA/</url>
    <content><![CDATA[<h2 id="私有CA建立和证书生申请"><a href="#私有CA建立和证书生申请" class="headerlink" title="私有CA建立和证书生申请"></a>私有CA建立和证书生申请</h2><p>CA在创建时有规定的格式，详细需要参考/etc/pki/tls/openssl.cnf此文件存放了CA相关的一些配置信息。</p>
<span id="more"></span>

<p>以下为比较重要的2个相关配置：</p>
<p>1.此段为CA的详细目录结构</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">####################################################################</span></span><br><span class="line">[ ca ]</span><br><span class="line">default_ca      = CA_default            <span class="comment"># The default ca section</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####################################################################</span></span><br><span class="line">[ CA_default ]</span><br><span class="line"></span><br><span class="line">dir             = /etc/pki/CA           <span class="comment"># Where everything is kept</span></span><br><span class="line">certs           = <span class="variable">$dir</span>/certs            <span class="comment"># Where the issued certs are kept</span></span><br><span class="line">crl_dir         = <span class="variable">$dir</span>/crl              <span class="comment"># Where the issued crl are kept</span></span><br><span class="line">database        = <span class="variable">$dir</span>/index.txt        <span class="comment"># database index file.</span></span><br><span class="line"><span class="comment">#unique_subject = no                    # Set to &#x27;no&#x27; to allow creation of</span></span><br><span class="line">                                        <span class="comment"># several ctificates with same subject.</span></span><br><span class="line">new_certs_dir   = <span class="variable">$dir</span>/newcerts         <span class="comment"># default place for new certs.</span></span><br><span class="line"></span><br><span class="line">certificate     = <span class="variable">$dir</span>/cacert.pem       <span class="comment"># The CA certificate</span></span><br><span class="line">serial          = <span class="variable">$dir</span>/serial           <span class="comment"># The current serial number</span></span><br><span class="line">crlnumber       = <span class="variable">$dir</span>/crlnumber        <span class="comment"># the current crl number</span></span><br><span class="line">                                        <span class="comment"># must be commented out to leave a V1 CRL</span></span><br><span class="line">crl             = <span class="variable">$dir</span>/crl.pem          <span class="comment"># The current CRL</span></span><br><span class="line">private_key     = <span class="variable">$dir</span>/private/cakey.pem<span class="comment"># The private key</span></span><br><span class="line">RANDFILE        = <span class="variable">$dir</span>/private/.rand    <span class="comment"># private random number file</span></span><br><span class="line"></span><br><span class="line">x509_extensions = usr_cert              <span class="comment"># The extentions to add to the cert</span></span><br></pre></td></tr></table></figure>

<p>2.此段为证书签署的相关规则，其中标记为match的表示客户端在提交证书签署申请时必须和CA相同的部分。若要不同也可以修改policy规则</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># A few difference way of specifying how similar the request should look</span></span><br><span class="line"><span class="comment"># For type CA, the listed attributes must be the same, and the optional</span></span><br><span class="line"><span class="comment"># and supplied fields are just that :-)</span></span><br><span class="line">policy          = policy_match             <span class="comment">#此处若修改为policy_anything就能实现客户端申请证书时countryName、stateOrProvinceName、organizationName和CA不同也能签署。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For the CA policy</span></span><br><span class="line">[ policy_match ]</span><br><span class="line">countryName             = match</span><br><span class="line">stateOrProvinceName     = match</span><br><span class="line">organizationName        = match</span><br><span class="line">organizationalUnitName  = optional</span><br><span class="line">commonName              = supplied</span><br><span class="line">emailAddress            = optional</span><br><span class="line"></span><br><span class="line"><span class="comment"># For the &#x27;anything&#x27; policy</span></span><br><span class="line"><span class="comment"># At this point in time, you must list all acceptable &#x27;object&#x27;</span></span><br><span class="line"><span class="comment"># types.</span></span><br><span class="line">[ policy_anything ]</span><br><span class="line">countryName             = optional</span><br><span class="line">stateOrProvinceName     = optional</span><br><span class="line">localityName            = optional</span><br><span class="line">organizationName        = optional</span><br><span class="line">organizationalUnitName  = optional</span><br><span class="line">commonName              = supplied</span><br><span class="line">emailAddress            = optional</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="一、创建私有CA"><a href="#一、创建私有CA" class="headerlink" title="一、创建私有CA"></a>一、创建私有CA</h3><p>1.生成证书索引数据库文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># touch index.txt</span></span><br></pre></td></tr></table></figure>

<p>2.指定证书颁发序列号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># echo 01 &gt; serial</span></span><br></pre></td></tr></table></figure>

<p>3.生成私钥  </p>
<p>私钥必须存放在/etc/pki/CA/private下取名为cakey.pem</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># (umask 066;openssl genrsa -out private/cakey.pem 4096)       #生成私钥，指定长度为4096位</span></span><br><span class="line">Generating RSA private key, 4096 bit long modulus</span><br><span class="line">.........................................++</span><br><span class="line">.....................++</span><br><span class="line">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure>

<p>4.生成自签证书</p>
<p>自签证书的存放位置和命名也有规定，必须存放在/etc/pki/CA/下，取名为cacert.pem </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 3650     #生成自签证书，指定有效时长为3650天</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:beijing  </span><br><span class="line">Locality Name (eg, city) [Default City]:beijing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:magedu</span><br><span class="line">Organizational Unit Name (eg, section) []:ops</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:ca.magedu.com</span></span><br><span class="line"><span class="string">Email Address []:</span></span><br></pre></td></tr></table></figure>

<h3 id="二、客户端申请证书"><a href="#二、客户端申请证书" class="headerlink" title="二、客户端申请证书"></a>二、客户端申请证书</h3><p>1.在客户端生成私钥文件</p>
<p>客户端的私钥一般在需要生成私钥的应用下生成</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># (umask 066;openssl genrsa -out test.key 1024)</span></span><br><span class="line">Generating RSA private key, 1024 bit long modulus</span><br><span class="line">....................................................................................................................++++++</span><br><span class="line">.....++++++</span><br><span class="line">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure>

<p>2.利用私钥生成证书签署请求</p>
<p>签署请求中Country Name、State or Provice Name、Organization Name必须相同。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># openssl req -new -key test.key -out test.csr</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:beijing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:magedu</span><br><span class="line">Organizational Unit Name (eg, section) []:ops</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:www.mylinuxops.com</span></span><br><span class="line"><span class="string">Email Address []:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please enter the following &#x27;</span>extra<span class="string">&#x27; attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:</span></span><br><span class="line"><span class="string">An optional company name []:</span></span><br></pre></td></tr></table></figure>

<p>3.将证书签署请求发给CA</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># scp test.csr 192.168.73.132:/tmp</span></span><br><span class="line">The authenticity of host <span class="string">&#x27;192.168.73.132 (192.168.73.132)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:YNlH0VBV0kp4lAClVvfMWVx/bHcbKKHXQwyd13d+MME.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is MD5:8a:1c:3d:c2:04:b1:be:05:95:33:9e:16:e8:ad:6c:25.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>192.168.73.132<span class="string">&#x27; (ECDSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">root@192.168.73.132&#x27;</span>s password: </span><br><span class="line">test.csr                                                               100%  660   220.9KB/s   00:00    </span><br></pre></td></tr></table></figure>

<h3 id="三、CA服务器端签署证书"><a href="#三、CA服务器端签署证书" class="headerlink" title="三、CA服务器端签署证书"></a>三、CA服务器端签署证书</h3><p>CA服务器签署证书时，需要指定证书有效时长</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># openssl ca -in /tmp/test.csr -out certs/test.crt -days 365</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Apr 15 22:42:33 2019 GMT</span><br><span class="line">            Not After : Apr 14 22:42:33 2020 GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = CN</span><br><span class="line">            stateOrProvinceName       = beijing</span><br><span class="line">            organizationName          = magedu</span><br><span class="line">            organizationalUnitName    = ops</span><br><span class="line">            commonName                = www.mylinuxops.com</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                6F:FE:2A:6D:CA:54:71:43:EC:58:54:8B:94:8E:92:BC:04:9B:6D:91</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:EE:25:E6:80:F8:8A:68:3F:E5:5E:C4:38:FB:1C:B9:93:C9:2B:5B:AD</span><br><span class="line"></span><br><span class="line">Certificate is to be certified until Apr 14 22:42:33 2020 GMT (365 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure>

<h3 id="四、其他"><a href="#四、其他" class="headerlink" title="四、其他"></a>四、其他</h3><p>1.查看证书中的信息：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># openssl x509 -in certs/test.crt -noout -text</span></span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C=CN, ST=beijing, L=beijing, O=magedu, OU=ops, CN=ca.magedu.com</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Apr 15 22:42:33 2019 GMT</span><br><span class="line">            Not After : Apr 14 22:42:33 2020 GMT</span><br><span class="line">        Subject: C=CN, ST=beijing, O=magedu, OU=ops, CN=www.mylinuxops.com</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (1024 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:d1:ab:99:29:51:31:e8:2d:69:e6:04:25:89:61:</span><br><span class="line">                    2d:81:71:c6:cf:b0:a2:a2:8a:94:6f:b3:ab:40:fa:</span><br><span class="line">                    1f:da:40:33:7b:46:0f:f7:61:21:18:be:3b:5d:b8:</span><br><span class="line">                    18:a2:8a:9e:99:66:9c:9c:7c:68:2e:ab:73:00:87:</span><br><span class="line">                    3a:91:aa:b5:a0:f0:2c:ec:d0:f2:44:15:86:74:2a:</span><br><span class="line">                    39:d0:64:42:a8:d5:69:ca:c2:79:a1:5a:e3:c9:dc:</span><br><span class="line">                    6e:9e:1e:ab:89:cf:47:62:57:67:17:d3:9f:09:4f:</span><br><span class="line">                    0d:ed:f3:b7:d1:99:b0:49:95:99:25:0b:70:30:ef:</span><br><span class="line">                    a2:72:8d:42:90:8b:51:bb:41</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                6F:FE:2A:6D:CA:54:71:43:EC:58:54:8B:94:8E:92:BC:04:9B:6D:91</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:EE:25:E6:80:F8:8A:68:3F:E5:5E:C4:38:FB:1C:B9:93:C9:2B:5B:AD</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         a0:b9:ac:ef:a6:cb:9c:af:99:5b:f8:f2:dd:f4:0b:dc:63:51:</span><br><span class="line">         99:16:3d:b9:53:91:5e:e5:61:f0:9d:85:cb:57:19:b8:fd:fd:</span><br><span class="line">         6e:3a:9c:f2:2a:d0:69:90:89:ff:75:90:20:f6:25:d0:d2:f9:</span><br><span class="line">         4f:23:34:fd:b7:3c:25:00:7c:a3:7f:f3:14:2b:54:54:3e:cf:</span><br><span class="line">         19:fa:80:48:b2:f3:3a:c7:cf:20:7a:91:3e:43:6f:88:2d:36:</span><br><span class="line">         9a:50:23:12:d1:0c:fa:78:c3:3a:7e:90:85:b1:ba:a8:4a:f0:</span><br><span class="line">         c9:a1:6c:e9:7c:ff:e5:8a:f1:30:8d:36:33:1c:22:03:5b:37:</span><br><span class="line">         73:95:a8:6f:2d:68:42:5d:78:e2:9c:24:c4:b2:f7:59:37:1e:</span><br><span class="line">         af:90:ea:1e:bc:73:d7:95:83:42:64:f5:e1:fb:45:e6:9c:e3:</span><br><span class="line">         2b:04:6f:de:d0:de:01:d9:dc:af:9c:47:2d:31:5e:c3:71:6d:</span><br><span class="line">         23:a6:f3:e0:77:65:c9:a3:39:c0:f2:c5:d2:21:df:84:64:<span class="built_in">cd</span>:</span><br><span class="line">         0f:4b:19:ea:b4:d5:75:2a:52:54:38:e4:d6:6a:e0:9e:61:c6:</span><br><span class="line">         3a:04:21:cb:d5:2f:c9:f3:21:15:a6:bf:48:ea:06:f4:a8:20:</span><br><span class="line">         43:49:e9:e5:d5:c6:74:06:6a:53:c6:31:48:08:89:6f:af:9a:</span><br><span class="line">         aa:d7:62:e3:9b:60:f2:55:1e:0d:e0:e2:ab:02:76:ab:f0:2f:</span><br><span class="line">         c5:39:fe:11:e3:1d:51:19:96:2d:57:6b:a6:d1:97:8d:fb:cb:</span><br><span class="line">         4f:08:b5:29:af:c8:b8:c7:c9:32:7d:a6:30:ee:ad:c7:13:af:</span><br><span class="line">         d9:9f:c4:09:f1:57:6b:aa:66:de:ad:28:c9:ea:a3:52:26:9b:</span><br><span class="line">         29:e2:0a:14:30:c5:fb:06:70:89:69:f2:5a:de:49:bd:4a:f3:</span><br><span class="line">         af:20:f0:b6:c5:97:37:9a:b4:35:03:5e:75:6c:a0:82:1e:bb:</span><br><span class="line">         0c:68:fe:f4:ee:06:3b:0a:2e:e1:72:0c:b1:32:f4:f3:0f:c0:</span><br><span class="line">         ee:66:1e:5b:9b:e5:02:72:8a:f4:f8:94:3b:c3:85:5f:53:38:</span><br><span class="line">         47:b4:47:61:1a:a1:fd:36:9d:40:81:0a:65:37:47:ad:9e:d5:</span><br><span class="line">         a3:0f:58:87:d5:2f:7f:b5:bc:15:e8:cc:f4:16:c0:67:fa:a2:</span><br><span class="line">         b6:f1:2b:4e:5d:ac:8f:fe:c5:20:3a:b5:49:18:5d:be:29:01:</span><br><span class="line">         67:5f:2f:e9:77:31:34:5c:e2:12:78:1c:a2:c8:3a:67:d1:90:</span><br><span class="line">         3b:24:ed:49:68:5d:c4:f3:f7:8f:4c:bf:02:88:15:3b:11:90:</span><br><span class="line">         9e:f0:<span class="built_in">fc</span>:d2:41:48:8b:6c:53:22:8d:b0:1b:53:67:05:dc:f5:</span><br><span class="line">         72:37:19:1b:05:24:4b:3b</span><br></pre></td></tr></table></figure>

<p>2.查看指定编号的证书状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># openssl ca -status 01</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">01=Valid (V)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="CA证书的吊销"><a href="#CA证书的吊销" class="headerlink" title="CA证书的吊销"></a>CA证书的吊销</h2><p>1.在客户机上查看索要吊销的证书的serial和subject</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 certs]<span class="comment"># openssl x509 -in test.crt -noout -serial -subject</span></span><br><span class="line">serial=01</span><br><span class="line">subject= /C=CN/ST=beijing/O=magedu/OU=ops/CN=www.mylinuxops.com</span><br></pre></td></tr></table></figure>

<p>2.根据客户端所提交的信息，在CA服务器端比对index.txt内的信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># cat index.txt</span></span><br><span class="line">V	200414224233Z		01	unknown	/C=CN/ST=beijing/O=magedu/OU=ops/CN=www.mylinuxops.com         </span><br></pre></td></tr></table></figure>

<p>3.吊销证书</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># openssl ca -revoke /etc/pki/CA/newcerts/01.pem </span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Revoking Certificate 01.</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure>

<p>4.指定第一个证书吊销的编号（第一次执行吊销时需要执行此步骤）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># echo 01 &gt; /etc/pki/CA/crlnumber</span></span><br></pre></td></tr></table></figure>

<p>5.生成证书吊销列表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># openssl ca -gencrl -out /etc/pki/CA/crl.pem</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br></pre></td></tr></table></figure>

<p>6.查看证书吊销列表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 CA]<span class="comment"># openssl crl -in crl.pem -noout -text</span></span><br><span class="line">Certificate Revocation List (CRL):</span><br><span class="line">        Version 2 (0x1)</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: /C=CN/ST=beijing/L=beijing/O=magedu/OU=ops/CN=ca.magedu.com</span><br><span class="line">        Last Update: Apr 16 08:41:46 2019 GMT</span><br><span class="line">        Next Update: May 16 08:41:46 2019 GMT</span><br><span class="line">        CRL extensions:</span><br><span class="line">            X509v3 CRL Number: </span><br><span class="line">                1</span><br><span class="line">Revoked Certificates:</span><br><span class="line">    Serial Number: 01</span><br><span class="line">        Revocation Date: Apr 16 08:38:37 2019 GMT</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         a3:07:8f:b4:a8:ec:76:fb:d1:6c:88:f6:1d:ba:e6:79:5e:19:</span><br><span class="line">         59:3a:38:8d:26:d0:15:d2:22:b1:2f:a5:b0:b0:<span class="built_in">fc</span>:49:11:00:</span><br><span class="line">         0a:2a:93:22:8d:44:ec:18:c9:5d:ad:66:60:32:36:8a:55:77:</span><br><span class="line">         03:9e:fb:51:b4:8e:9d:b7:d8:3b:d1:da:64:9e:ae:9f:5a:04:</span><br><span class="line">         19:69:f6:e9:de:94:75:92:f4:f4:33:b6:2b:e9:8e:27:dd:40:</span><br><span class="line">         9f:90:11:0f:36:d4:4a:ef:af:55:08:ec:87:81:c6:7c:38:02:</span><br><span class="line">         fb:e2:d9:77:61:dc:2a:2c:61:c5:36:aa:6e:34:59:77:fe:47:</span><br><span class="line">         81:6d:02:15:e5:4b:f2:1f:ae:b3:e0:2e:5e:49:9d:c1:51:f9:</span><br><span class="line">         2e:69:d5:5f:9b:26:25:20:d9:88:ac:30:94:e2:25:e5:ee:17:</span><br><span class="line">         f4:62:ca:ea:be:af:aa:7a:07:e7:e5:91:24:80:cc:52:9b:30:</span><br><span class="line">         e2:3e:59:66:2a:77:28:7b:6a:10:99:a3:a3:27:30:17:a1:94:</span><br><span class="line">         49:bb:ae:eb:7f:53:d9:07:a5:0c:8f:b0:97:0a:cb:42:d8:37:</span><br><span class="line">         22:d9:0b:48:5e:a9:a0:13:78:0d:71:5b:76:25:11:f2:62:7b:</span><br><span class="line">         e7:a5:f5:52:03:a6:25:ea:3a:da:d6:37:5a:55:ed:89:3e:67:</span><br><span class="line">         6f:b7:d7:a9:75:94:e8:17:af:cc:87:ed:bb:4d:19:3c:ee:af:</span><br><span class="line">         a5:4d:fe:5e:f9:80:7a:16:4d:8c:99:36:77:75:e7:81:03:05:</span><br><span class="line">         92:91:01:5c:5e:d7:d0:d3:2b:ef:62:<span class="built_in">cd</span>:20:5b:1b:40:30:29:</span><br><span class="line">         41:83:c6:7b:cc:29:2a:c3:6c:76:88:ed:a8:ac:be:83:00:7b:</span><br><span class="line">         56:c6:de:97:cf:6a:a5:bd:38:1e:84:b1:00:37:e5:85:15:eb:</span><br><span class="line">         86:51:f8:51:f6:e4:7e:2e:25:e2:8b:10:7d:3e:a6:4d:e5:bd:</span><br><span class="line">         cb:8b:1e:2f:71:60:83:e5:75:1b:91:87:90:39:4a:67:88:87:</span><br><span class="line">         51:d3:b9:ff:0a:f6:36:3c:ba:a0:ae:32:6d:48:d7:e0:3d:20:</span><br><span class="line">         06:b5:ae:05:74:ab:13:84:49:dc:d7:91:c3:48:38:2d:b3:e9:</span><br><span class="line">         b7:f0:13:9d:54:44:f1:5c:52:35:95:f5:da:9c:85:62:3f:28:</span><br><span class="line">         3a:c1:8a:32:e9:f6:f6:93:d2:40:7f:8a:71:20:6e:04:2f:2f:</span><br><span class="line">         33:2b:ac:2a:bb:33:b1:09:4d:4b:67:69:a9:48:a7:a7:a4:cb:</span><br><span class="line">         7e:61:fb:3e:85:dd:1f:99:8b:35:d6:7d:75:9d:34:61:84:8e:</span><br><span class="line">         46:39:e7:4b:09:e3:00:44:69:24:73:ac:37:82:73:1b:42:0d:</span><br><span class="line">         1f:60:5a:e7:47:6c:5f:a6</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="创建私有CA脚本"><a href="#创建私有CA脚本" class="headerlink" title="创建私有CA脚本"></a>创建私有CA脚本</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">PS3=<span class="string">&quot;plese choose a nember: &quot;</span></span><br><span class="line">select menu <span class="keyword">in</span> 创建CA 申请证书 签发证书 退出;<span class="keyword">do</span></span><br><span class="line">        <span class="keyword">case</span> <span class="variable">$menu</span> <span class="keyword">in</span></span><br><span class="line">        创建CA)</span><br><span class="line">                <span class="built_in">cd</span> /etc/pki/CA</span><br><span class="line">                touch serial</span><br><span class="line">                <span class="built_in">echo</span> 01 &gt; index.txt</span><br><span class="line">                (<span class="built_in">umask</span> 066;openssl genrsa -out private/cakey.pem 4096)</span><br><span class="line">                openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 3650 &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">                CN</span></span><br><span class="line"><span class="string">                beijing</span></span><br><span class="line"><span class="string">                beijing</span></span><br><span class="line"><span class="string">                magedu</span></span><br><span class="line"><span class="string">                ca.magedu.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                EOF</span></span><br><span class="line">                ;;</span><br><span class="line">        申请证书)</span><br><span class="line">                <span class="built_in">read</span> -p <span class="string">&quot;please input your need crt appdir: &quot;</span> APPDIR</span><br><span class="line">                <span class="built_in">read</span> -p <span class="string">&quot;please input your need crt app name: &quot;</span> NAME</span><br><span class="line">                <span class="built_in">read</span> -p <span class="string">&quot;please input CA server ip: &quot;</span> IP</span><br><span class="line">                <span class="built_in">cd</span> <span class="variable">$APPDIR</span></span><br><span class="line">                (unmask 066;openssl genrsa -out <span class="variable">$NAME</span>.key 2048)</span><br><span class="line">                openssl req -new -key <span class="variable">$&#123;NAME&#125;</span>.key -out <span class="variable">$&#123;NAME&#125;</span>.csr</span><br><span class="line">                scp <span class="variable">$&#123;NAME&#125;</span>.csr <span class="variable">$&#123;IP&#125;</span>:/tmp</span><br><span class="line">                <span class="built_in">unset</span> IP</span><br><span class="line">                ;;</span><br><span class="line">        签发证书)</span><br><span class="line">                <span class="built_in">read</span> -p <span class="string">&quot;please input client ip: &quot;</span> IP</span><br><span class="line">                NAME=`<span class="built_in">cd</span> /tmp;ls *.csr`</span><br><span class="line">                openssl ca -<span class="keyword">in</span> /tmp/<span class="variable">$&#123;NAME&#125;</span>.csr -out /etc/pki/CA/certs/<span class="variable">$&#123;NAME&#125;</span>.crt</span><br><span class="line">                rm -rf /tmp/*.csr</span><br><span class="line">                scp /etc/pki/CA/certs/<span class="variable">$&#123;NAME&#125;</span>.crt <span class="variable">$IP</span>:/tmp</span><br><span class="line">                <span class="built_in">unset</span> IP</span><br><span class="line">                ;;</span><br><span class="line">        退出)</span><br><span class="line">                <span class="built_in">break</span></span><br><span class="line">                ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">~  </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>OpenSSL</tag>
      </tags>
  </entry>
  <entry>
    <title>迁移数据至逻辑卷和LVM快照</title>
    <url>/2019/03/05/Linux%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E8%87%B3%E9%80%BB%E8%BE%91%E5%8D%B7%E5%92%8Clvm%E5%BF%AB%E7%85%A7/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E8%87%B3%E9%80%BB%E8%BE%91%E5%8D%B7%E5%92%8C%E9%80%BB%E8%BE%91%E5%8D%B7%E5%BF%AB%E7%85%A7/</url>
    <content><![CDATA[<h2 id="迁移数据至逻辑卷和LVM快照"><a href="#迁移数据至逻辑卷和LVM快照" class="headerlink" title="迁移数据至逻辑卷和LVM快照"></a>迁移数据至逻辑卷和LVM快照</h2><p>在生产中又有可能遇到数据需要从原先的磁盘中迁移到逻辑卷中，此时就会涉及到数据的迁移，以下将演示如何将叔叔从一个磁盘上迁移到逻辑卷中以及如何对逻辑卷创建快照，恢复快照。</p>
<span id="more"></span>

<h3 id="迁移数据至逻辑卷"><a href="#迁移数据至逻辑卷" class="headerlink" title="迁移数据至逻辑卷"></a>迁移数据至逻辑卷</h3><p>1.首先创建一个逻辑卷</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># pvcreate /dev/sd&#123;b,c&#125;</span></span><br><span class="line">  Physical volume <span class="string">&quot;/dev/sdb&quot;</span> successfully created.</span><br><span class="line">  Physical volume <span class="string">&quot;/dev/sdc&quot;</span> successfully created.</span><br><span class="line">[root@centos7 ~]<span class="comment"># vgcreate testvg /dev/sd&#123;b,c&#125;</span></span><br><span class="line">  Volume group <span class="string">&quot;testvg&quot;</span> successfully created</span><br><span class="line">[root@centos7 ~]<span class="comment"># lvcreate -n testlv -L 5G testvg </span></span><br><span class="line">  Logical volume <span class="string">&quot;testlv&quot;</span> created.</span><br></pre></td></tr></table></figure>

<p>2.将磁盘格式化为ext4分区格式</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mkfs.ext4 /dev/testvg/testlv </span></span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem label=</span><br><span class="line">OS <span class="built_in">type</span>: Linux</span><br><span class="line">Block size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Fragment size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">327680 inodes, 1310720 blocks</span><br><span class="line">65536 blocks (5.00%) reserved <span class="keyword">for</span> the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=1342177280</span><br><span class="line">40 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">8192 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">	32768, 98304, 163840, 229376, 294912, 819200, 884736</span><br><span class="line"></span><br><span class="line">Allocating group tables: <span class="keyword">done</span>                            </span><br><span class="line">Writing inode tables: <span class="keyword">done</span>                            </span><br><span class="line">Creating journal (32768 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span> </span><br></pre></td></tr></table></figure>

<p>3.挂载逻辑卷设备至临时目录，并复制需要迁移的数据。(以下以home家目录为例进行数据迁移)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mkdir /testdir</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mount /dev/testvg/testlv /testdir/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cp -a /home/. /testdir/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /testdir</span></span><br><span class="line">lost+found  masuri</span><br></pre></td></tr></table></figure>
<p>4.卸载设备，移除原家目录下的内容。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 home]<span class="comment"># mv /home/* /tmp/</span></span><br><span class="line">[root@centos7 testdir]<span class="comment"># umount /testdir/</span></span><br></pre></td></tr></table></figure>

<p>5.将lvm设备挂载至/home完成数据迁移，由于用户家目录再启动时需要开机时挂载所以此处需要将其写入配置文件，并挂载</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 home]<span class="comment"># vim /etc/fstab</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line"><span class="comment"># Created by anaconda on Tue Mar  5 21:07:19 2019</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;</span></span><br><span class="line"><span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">UUID=45490aa4-cf29-420d-a606-af32688b6707 /                       xfs     defaults        0 0</span><br><span class="line">UUID=15dcd896-b7cf-48d0-b8bd-4c0b0f2c62b2 /boot                   xfs     defaults        0 0</span><br><span class="line">UUID=4b6e1813-2c46-402a-869a-02cbbcb76ade /data                   xfs     defaults        0 0</span><br><span class="line">UUID=0995b444-48c1-4423-92bc-2deda0d3c082 swap                    swap    defaults        0 0</span><br><span class="line">UUID=a3fa2d53-91c4-4af5-9ee4-c63500dbaaf2 /home                   ext4    defaults        0 0</span><br><span class="line">~</span><br><span class="line">~</span><br><span class="line"><span class="comment">#挂载设备</span></span><br><span class="line">[root@centos7 home]<span class="comment"># mount -a</span></span><br><span class="line"><span class="comment">#查看设备是否挂载</span></span><br><span class="line">[root@centos7 home]<span class="comment"># lsblk</span></span><br><span class="line">NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda               8:0    0  200G  0 disk </span><br><span class="line">├─sda1            8:1    0    1G  0 part /boot</span><br><span class="line">├─sda2            8:2    0  100G  0 part /</span><br><span class="line">├─sda3            8:3    0   50G  0 part /data</span><br><span class="line">├─sda4            8:4    0    1K  0 part </span><br><span class="line">└─sda5            8:5    0    2G  0 part [SWAP]</span><br><span class="line">sdb               8:16   0   20G  0 disk </span><br><span class="line">└─testvg-testlv 253:0    0    5G  0 lvm  /home</span><br><span class="line">sdc               8:32   0   20G  0 disk </span><br><span class="line">sr0              11:0    1   10G  0 rom  </span><br><span class="line"><span class="comment">#查看lvm中的数据是否存在</span></span><br><span class="line">[root@centos7 home]<span class="comment"># cd /home</span></span><br><span class="line">[root@centos7 home]<span class="comment"># ls</span></span><br><span class="line">lost+found  masuri</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="lvm快照"><a href="#lvm快照" class="headerlink" title="lvm快照"></a>lvm快照</h2><p>lvm快照的原理是在和需要拍摄快照的逻辑卷的同一卷组上创建一个空白逻辑卷并标识当前的时间，当原逻辑卷内的某数据发生改变时，首先会在此数据未发生改变前复制一份至快照卷。当需要用到快照时，系统会将快照卷内的数据全部复制回逻辑卷，并将逻辑卷内拍摄快后建立的数据全部删除。快照卷的大小一般为逻辑卷内数据的大小，过大无意义，过小可能会造成数据的丢失。</p>
<h3 id="1-创建快照卷"><a href="#1-创建快照卷" class="headerlink" title="1.创建快照卷"></a>1.创建快照卷</h3><p>此处以刚才创建的逻辑卷/dev/testvg/testlv为例，创建快照</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 home]<span class="comment"># lvcreate -n home_snap -s -L 100M /dev/testvg/testlv  </span></span><br><span class="line">Logical volume <span class="string">&quot;home_snap&quot;</span> created.</span><br><span class="line"><span class="comment">#查看快照卷是否创建</span></span><br><span class="line">[root@centos7 home]<span class="comment"># lvs</span></span><br><span class="line">  LV        VG     Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  home_snap testvg swi-a-s--- 100.00m      testlv 0.01                                   </span><br><span class="line">  testlv    testvg owi-aos---   5.00g                                                    </span><br></pre></td></tr></table></figure>
<h3 id="2-使用快照对逻辑卷恢复"><a href="#2-使用快照对逻辑卷恢复" class="headerlink" title="2.使用快照对逻辑卷恢复"></a>2.使用快照对逻辑卷恢复</h3><p>在对逻辑卷恢复之前先将逻辑卷内的数据进行一些修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cd /home</span></span><br><span class="line">[root@centos7 home]<span class="comment"># ls</span></span><br><span class="line">lost+found  masuri</span><br><span class="line">[root@centos7 home]<span class="comment"># touch file&#123;1..5&#125;</span></span><br><span class="line">[root@centos7 home]<span class="comment"># ls</span></span><br><span class="line">file1  file2  file3  file4  file5  lost+found  masuri</span><br></pre></td></tr></table></figure>

<p>恢复快照，恢复快照前需要将逻辑卷卸载</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># umount /home/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># lvconvert --merge /dev/testvg/home_snap </span></span><br><span class="line">  Merging of volume testvg/home_snap started.</span><br><span class="line">  testvg/testlv: Merged: 100.00%</span><br></pre></td></tr></table></figure>

<p>挂载逻辑卷查看数据是否恢复</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mount -a</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /home</span></span><br><span class="line">[root@centos7 home]<span class="comment"># ls</span></span><br><span class="line">lost+found  masuri</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>文件管理类命令</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E7%B1%BB%E5%91%BD%E4%BB%A4/%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E7%B1%BB%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h2 id="文件管理类命令"><a href="#文件管理类命令" class="headerlink" title="文件管理类命令"></a>文件管理类命令</h2><h3 id="1-pwd-显示当前工作目录"><a href="#1-pwd-显示当前工作目录" class="headerlink" title="1.pwd 显示当前工作目录"></a>1.pwd 显示当前工作目录</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">pwd</span> [OPTION]...</span><br></pre></td></tr></table></figure>

<p>说明：  </p>
<p>打印当前工作目录  </p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-P</td>
<td align="left">显示真实的物理路径</td>
</tr>
<tr>
<td align="left">-L</td>
<td align="left">显示链接路径(默认)</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 bin]<span class="comment"># ll -d /bin      /bin为/usr/bin的软链接</span></span><br><span class="line">lrwxrwxrwx. 1 root root 7 Mar  5 21:08 /bin -&gt; usr/bin</span><br><span class="line">[root@centos7 bin]<span class="comment"># pwd          默认直接显示链接路径</span></span><br><span class="line">/bin</span><br><span class="line">[root@centos7 bin]<span class="comment"># pwd -P      显示真实的物理路径而不是链接路径</span></span><br><span class="line">/usr/bin</span><br></pre></td></tr></table></figure>

<p>补充：  </p>
<p>绝对路径：绝对路径是指从根开始到所要指定的文件的完整的路径名称，从/开始写路径  </p>
<p>相对路径：相对路径是指相对于当前工作目录到目标目录的位置所表示出的一种路径方法，不从/开始写路径  </p>
<p>basename:基名  </p>
<p>dirname:路径名  </p>
<p>示例:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 bin]<span class="comment"># cd /etc/sysconfig/      完整路径名</span></span><br><span class="line">[root@centos7 sysconfig]<span class="comment"># cd ../../home     相对路径名</span></span><br><span class="line">[root@centos7 home]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[root@centos7 bin]<span class="comment"># basename /etc/sysconfig/            取出路径中的基名</span></span><br><span class="line">sysconfig</span><br><span class="line">[root@centos7 bin]<span class="comment"># dirname /etc/sysconfig/             取出路径中的目录名</span></span><br><span class="line">/etc</span><br></pre></td></tr></table></figure>

<h3 id="2-cd-改变目录"><a href="#2-cd-改变目录" class="headerlink" title="2. cd 改变目录"></a>2. cd 改变目录</h3><p>命令格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /PATH/TO/DIRNAME</span><br></pre></td></tr></table></figure>

<p>说明： </p>
<p>改变当前工作目录  </p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-P</td>
<td align="left">改变目录到物理路径的目录而非链接</td>
</tr>
</tbody></table>
<p>示例：  </p>
<p>以/bin目录为例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 bin]<span class="comment"># cd /bin </span></span><br><span class="line">[root@centos7 bin]<span class="comment"># pwd</span></span><br><span class="line">/bin</span><br><span class="line">[root@centos7 bin]<span class="comment"># cd -P /bin      跳转至物理路径</span></span><br><span class="line">[root@centos7 bin]<span class="comment"># pwd</span></span><br><span class="line">/usr/bin</span><br></pre></td></tr></table></figure>

<h3 id="3-ls-显示目录内容"><a href="#3-ls-显示目录内容" class="headerlink" title="3. ls 显示目录内容"></a>3. ls 显示目录内容</h3><p>命令格式：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ls [OPTION]... [FILE]...</span><br></pre></td></tr></table></figure>

<p>说明：  </p>
<p>显示目录下的内容  </p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-a</td>
<td align="left">包含隐藏文件</td>
</tr>
<tr>
<td align="left">-l</td>
<td align="left">显示额外的信息</td>
</tr>
<tr>
<td align="left">-h</td>
<td align="left">文件大小显示为可读的信息</td>
</tr>
<tr>
<td align="left">-R</td>
<td align="left">目录递归通过</td>
</tr>
<tr>
<td align="left">-ld</td>
<td align="left">目录和符号链接信息</td>
</tr>
<tr>
<td align="left">-1</td>
<td align="left">文件分行显示</td>
</tr>
<tr>
<td align="left">–S</td>
<td align="left">按从大到小排序</td>
</tr>
<tr>
<td align="left">–t</td>
<td align="left">按mtime排序</td>
</tr>
<tr>
<td align="left">–u</td>
<td align="left">配合-t选项，显示并按atime从新到旧排序</td>
</tr>
<tr>
<td align="left">–U</td>
<td align="left">按目录存放顺序显示</td>
</tr>
<tr>
<td align="left">–X</td>
<td align="left">按文件后缀排序</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 /]<span class="comment"># ls -a             显示目录下所有文件包括隐藏文件</span></span><br><span class="line">.   bin   data  etc   lib    media  opt   root  sbin  sys      tmp  var</span><br><span class="line">..  boot  dev   home  lib64  mnt    proc  run   srv   testdir  usr</span><br><span class="line"></span><br><span class="line">[root@centos7 /]<span class="comment"># ls -l             显示文件的详细信息</span></span><br><span class="line">total 20</span><br><span class="line">lrwxrwxrwx.   1 root root    7 Mar  5 21:08 bin -&gt; usr/bin</span><br><span class="line">dr-xr-xr-x.   5 root root 4096 Mar  5 21:14 boot</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@centos7 /]<span class="comment"># ls -R /home       递归显示文件</span></span><br><span class="line">/home:</span><br><span class="line">masuri</span><br><span class="line"></span><br><span class="line">/home/masuri:</span><br><span class="line"></span><br><span class="line">[root@centos7 /]<span class="comment"># ls -ld /home      显示目录自身属性</span></span><br><span class="line">drwxr-xr-x. 3 root root 20 Mar  5 21:13 /home</span><br><span class="line"></span><br><span class="line">[root@centos7 /]<span class="comment"># ls -1             文件在一列中显示</span></span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@centos7 /]<span class="comment"># ls -lS            按照文件大小从大到小显示</span></span><br><span class="line">total 20</span><br><span class="line">drwxr-xr-x. 138 root root 8192 Mar  8 16:27 etc</span><br><span class="line">dr-xr-xr-x.   5 root root 4096 Mar  5 21:14 boot</span><br><span class="line">drwxrwxrwt.  14 root root 4096 Mar  8 15:56 tmp</span><br><span class="line">drwxr-xr-x   19 root root 3300 Mar  7 16:10 dev</span><br><span class="line">drwxr-xr-x   36 root root 1200 Mar  8 13:11 run</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@centos7 /]<span class="comment"># ls -lt            按照文件的修改时间从新到旧进行显示</span></span><br><span class="line">total 20</span><br><span class="line">dr-xr-xr-x   13 root root    0 Mar  8 16:54 sys</span><br><span class="line">drwxr-xr-x. 138 root root 8192 Mar  8 16:27 etc</span><br><span class="line">drwxrwxrwt.  14 root root 4096 Mar  8 15:56 tmp</span><br><span class="line">dr-xr-x---.   5 root root  242 Mar  8 15:55 root</span><br><span class="line">drwxr-xr-x   36 root root 1200 Mar  8 13:11 run</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@centos7 /]<span class="comment"># ls -lut           按照访问时间从新到旧排序</span></span><br><span class="line">total 20</span><br><span class="line">drwxr-xr-x   19 root root 3300 Mar  8 16:54 dev</span><br><span class="line">drwxr-xr-x.   3 root root   42 Mar  8 16:54 data</span><br><span class="line">drwxr-xr-x. 138 root root 8192 Mar  8 16:44 etc</span><br><span class="line">drwxr-xr-x.  13 root root  155 Mar  8 15:56 usr</span><br><span class="line">dr-xr-x---.   5 root root  242 Mar  8 15:56 root</span><br><span class="line">lrwxrwxrwx.   1 root root    7 Mar  8 13:08 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx.   1 root root    9 Mar  8 13:08 lib64 -&gt; usr/lib64</span><br><span class="line">drwxr-xr-x.  20 root root  282 Mar  7 15:06 var</span><br><span class="line">dr-xr-xr-x  150 root root    0 Mar  7 14:01 proc</span><br><span class="line"></span><br><span class="line">[root@centos7 /]<span class="comment"># ls -U             按字母顺序排序</span></span><br><span class="line">boot  dev   run  etc   var  usr  sbin  lib64  media  opt  testdir</span><br><span class="line">data  proc  sys  root  tmp  bin  lib   home   mnt    srv</span><br><span class="line"></span><br><span class="line">[root@centos7 data]<span class="comment"># ls -X          按照后缀归类</span></span><br><span class="line">aa  -h  a.sh  b.sh  c.txt  d.txt  e.txt  f.txt  test.txt</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ls -lh            将文件大小显示为可读的信息</span></span><br><span class="line">total 8.0K</span><br><span class="line">-rw-r--r-- 1 root root    0 Mar  7 15:31 342</span><br><span class="line">-rw-r--r-- 1 root root  132 Mar  8 15:55 <span class="built_in">echo</span></span><br><span class="line">---------- 1 root root 1.3K Mar  7 15:35 shadow</span><br></pre></td></tr></table></figure>

<h3 id="4-stat-查看文件状态"><a href="#4-stat-查看文件状态" class="headerlink" title="4.stat 查看文件状态"></a>4.stat 查看文件状态</h3><p>命令格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">stat /PATH/TO/FILE</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>显示文件的元数据  </p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 bin]<span class="comment"># stat /etc/passwd</span></span><br><span class="line">  File: ‘/etc/passwd’</span><br><span class="line">  Size: 2265            Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 802h/2050d      Inode: 135090575   Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2019-03-08 13:08:40.974021999 +0800</span><br><span class="line">Modify: 2019-03-05 21:13:55.465984891 +0800</span><br><span class="line">Change: 2019-03-05 21:13:55.465984891 +0800</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure>

<p>其他：  </p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">atime</td>
<td align="left">访问时间，当文件被读时时间发生改变</td>
</tr>
<tr>
<td align="left">mtime</td>
<td align="left">修改时间，当文件内容被修改时时间发生改变</td>
</tr>
<tr>
<td align="left">ctime</td>
<td align="left">状态时间，当文件元数据发生改变时时间会发生改变</td>
</tr>
</tbody></table>
<h3 id="5-cp-复制命令"><a href="#5-cp-复制命令" class="headerlink" title="5. cp 复制命令"></a>5. cp 复制命令</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp [OPTION]... [-T] SOURCE DEST</span><br><span class="line">cp [OPTION]... SOURCE... DIRECTORY</span><br><span class="line">cp [OPTION]... -t DIRECTORY SOURCE...</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>复制文件或目录到目标目录  </p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-i</td>
<td align="left">交互式覆盖前提示</td>
</tr>
<tr>
<td align="left">-n</td>
<td align="left">不覆盖</td>
</tr>
<tr>
<td align="left">-r,-R</td>
<td align="left">递归复制目录及内部所有内容</td>
</tr>
<tr>
<td align="left">-a</td>
<td align="left">归档，相当于-dR –preserv=all</td>
</tr>
<tr>
<td align="left">-d</td>
<td align="left">不复制源文件，只复制链接名</td>
</tr>
<tr>
<td align="left">-p</td>
<td align="left">等同于–preserv=mode,ownership,timestamp</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">显示详细过程</td>
</tr>
<tr>
<td align="left">-f</td>
<td align="left">强制</td>
</tr>
<tr>
<td align="left">-u</td>
<td align="left">–update只复制源比目标更新文件或目录不存在的文件</td>
</tr>
<tr>
<td align="left">-b</td>
<td align="left">目标存在，覆盖前先备份，形式为filename~</td>
</tr>
<tr>
<td align="left">–bakup=numbered</td>
<td align="left">目标存在，覆盖前先备份加数字后缀</td>
</tr>
</tbody></table>
<p>示例：  </p>
<p>复制文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># cp /etc/passwd .</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">passwd</span><br></pre></td></tr></table></figure>

<p>覆盖文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># cp  -i /etc/passwd .</span></span><br><span class="line">cp: overwrite ‘./passwd’? y</span><br><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">passwd</span><br></pre></td></tr></table></figure>

<p>当文件存在时不覆盖文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># cp /etc/issue .</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">issue  passwd</span><br><span class="line">[root@centos7 data]<span class="comment"># echo &quot;hello world&quot; &gt;&gt; /etc/issue</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat /etc/issue</span></span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br><span class="line">on  \l</span><br><span class="line">hostname is \n</span><br><span class="line">time is \t</span><br><span class="line"></span><br><span class="line">hello world</span><br><span class="line">[root@centos7 data]<span class="comment"># cp -n /etc/issue .</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat ./issue</span></span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br><span class="line">on  \l</span><br><span class="line">hostname is \n</span><br><span class="line">time is \t</span><br></pre></td></tr></table></figure>

<p>递归复制</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># cp -r /etc /data</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ls /data/etc</span></span><br><span class="line">abrt                        exports             kdump.conf                PackageKit        services</span><br><span class="line">adjtime                     exports.d           kernel                    </span><br><span class="line">...</span><br><span class="line">[root@centos7 data]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>复制链接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># cp -d /bin .</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ll</span></span><br><span class="line">total 20</span><br><span class="line">lrwxrwxrwx   1 root root    7 Mar  9 13:22 bin -&gt; usr/bin</span><br></pre></td></tr></table></figure>

<p>备份后复制1</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">bin  etc  issue  passwd</span><br><span class="line">[root@centos7 data]<span class="comment"># cp -b /etc/passwd .</span></span><br><span class="line">cp: overwrite ‘./passwd’? y</span><br><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">bin  etc  issue  passwd  passwd~        将原文件备份为passwd~</span><br></pre></td></tr></table></figure>

<p>注意：此方法备份后若再次备份会将passwd~覆盖  </p>
<p>备份后复制2</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># cp --backup=numbered /etc/passwd .</span></span><br><span class="line">cp: overwrite ‘./passwd’? y</span><br><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">bin  etc  issue  passwd  passwd~  passwd.~1~</span><br></pre></td></tr></table></figure>

<p>注意：用此方法备份后若再次备份不会覆盖上一次的备份内容而是新生成一个.<del>#</del>后缀的文件进行备份然后再复制  </p>
<p>其他：</p>
<table>
<thead>
<tr>
<th align="left">源\目标</th>
<th align="left">不存在</th>
<th align="left">存在且为文件</th>
<th align="left">存在且为目录</th>
</tr>
</thead>
<tbody><tr>
<td align="left">一个文件</td>
<td align="left">新建DEST,并将STC中内容填充至DEST中</td>
<td align="left">将SRC中的内容覆盖至DEST中</td>
<td align="left">在DEST下新建与原文件同名的文件，并将SRC中内容填充至新文件中</td>
</tr>
<tr>
<td align="left">多个文件</td>
<td align="left">error</td>
<td align="left">error</td>
<td align="left">在DEST下新建与原文件同名的文件，并将原文件内容复制进新文件中</td>
</tr>
<tr>
<td align="left">目录</td>
<td align="left">创建指定DEST同名目录，复制SRC目录中所有文件至DEST下</td>
<td align="left">error</td>
<td align="left">在DEST下新建与原目录同名的目录，并将SRC中的内容复制到新目录中</td>
</tr>
</tbody></table>
<h3 id="6-mv移动"><a href="#6-mv移动" class="headerlink" title="6. mv移动"></a>6. mv移动</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mv [OPTION]... [-T] SOURCE DEST</span><br><span class="line">mv [OPTION]... SOURCE... DIRECTORY</span><br><span class="line">mv [OPTION]... -t DIRECTORY SOURCE...</span><br></pre></td></tr></table></figure>

<p>说明：      </p>
<p>移动或重命名文件   </p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-i</td>
<td align="left">交互式</td>
</tr>
<tr>
<td align="left">-f</td>
<td align="left">强制</td>
</tr>
<tr>
<td align="left">-b</td>
<td align="left">目标存在先备份后在移动</td>
</tr>
<tr>
<td align="left">-u</td>
<td align="left">–update只移动源比目标更新文件或不存在的文件</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">显示详细过程</td>
</tr>
</tbody></table>
<p>示例:  </p>
<p>移动文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># mkdir test</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">bin  etc  issue  passwd  passwd~  passwd.~1~  <span class="built_in">test</span></span><br><span class="line">[root@centos7 data]<span class="comment"># mv issue test</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ls /data/test</span></span><br><span class="line">issue</span><br></pre></td></tr></table></figure>

<p>备份后移动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># cp /etc/issue .</span></span><br><span class="line">[root@centos7 data]<span class="comment"># mv -b issue test</span></span><br><span class="line">mv: overwrite ‘<span class="built_in">test</span>/issue’? y</span><br><span class="line">[root@centos7 data]<span class="comment"># ls /data/test</span></span><br><span class="line">issue  issue~       &lt;---备份后的文件</span><br></pre></td></tr></table></figure>

<h3 id="7-rm-删除"><a href="#7-rm-删除" class="headerlink" title="7. rm 删除"></a>7. rm 删除</h3><p>命令格式：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rm [OPTION]... FILE...</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>删除(慎用)  </p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-i</td>
<td align="left">交互式</td>
</tr>
<tr>
<td align="left">-f</td>
<td align="left">强制删除</td>
</tr>
<tr>
<td align="left">-r</td>
<td align="left">递归</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>强制递归删除</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># rm -rf /data/test</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">bin  etc  passwd  passwd~  passwd.~1~</span><br></pre></td></tr></table></figure>

<p><em><strong>注意:</strong></em>  </p>
<p>生产环境中建议将不用的数据移动到一个专用目录中，不建议直接使用rm命令删除，可以将rm定义为mv的别名具体操作如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># mkdir /hsz</span></span><br><span class="line">[root@centos7 data]<span class="comment"># echo &#x27;alias rm=&#x27;mv -t /hsz&#x27;&#x27; &gt;&gt; ~/.bashrc</span></span><br><span class="line">[root@centos7 data]<span class="comment"># . ~/.bashrc</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">bin  etc  passwd  passwd~  passwd.~1~</span><br><span class="line">[root@centos7 data]<span class="comment"># rm bin</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">etc  passwd  passwd~  passwd.~1~</span><br><span class="line">[root@centos7 data]<span class="comment"># ls /hsz</span></span><br><span class="line">bin</span><br><span class="line">[root@centos7 data]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="8-tree-显示目录树"><a href="#8-tree-显示目录树" class="headerlink" title="8.tree 显示目录树"></a>8.tree 显示目录树</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tree  [-acdfghilnpqrstuvxACDFQNSUX] [-L level [-R]] [-H baseHREF] [-T title] [-o filename] [--nolinks] [-P pattern] [-I pattern] [--inodes] [--device] [--noreport] [--dirsfirst] [--version] [--<span class="built_in">help</span>] [--filelimit <span class="comment">#] [--si] [--prune]  [--du] [--timefmt format] [directory ...]</span></span><br></pre></td></tr></table></figure>

<p>说明：<br>显示目录树结构  </p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-d</td>
<td align="left">只显示目录</td>
</tr>
<tr>
<td align="left">-L level</td>
<td align="left">显示指定的层级数目</td>
</tr>
<tr>
<td align="left">-P pattern</td>
<td align="left">只显示指定pattern匹配到的路径</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 /]<span class="comment"># tree /data</span></span><br><span class="line">/data</span><br><span class="line">├── passwd</span><br><span class="line">├── passwd~</span><br><span class="line">└── passwd.~1~</span><br></pre></td></tr></table></figure>

<h3 id="9-mkdir-创建目录"><a href="#9-mkdir-创建目录" class="headerlink" title="9.mkdir 创建目录"></a>9.mkdir 创建目录</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir [OPTION]... DIRECTORY...</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>创建目录  </p>
<table>
<thead>
<tr>
<th align="left">选型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-p</td>
<td align="left">当上级目录不存在时自动创建上级目录</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">显示详细信息</td>
</tr>
<tr>
<td align="left">-m MODE</td>
<td align="left">创建目录时指定权限</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>创建多级目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 /]<span class="comment"># mkdir -pv /test1/test2/test3</span></span><br><span class="line">mkdir: created directory ‘/test1’</span><br><span class="line">mkdir: created directory ‘/test1/test2’</span><br><span class="line">mkdir: created directory ‘/test1/test2/test3’</span><br></pre></td></tr></table></figure>

<p>创建目录并添加权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 /]<span class="comment"># mkdir -m 777 /data/test4</span></span><br><span class="line">[root@centos7 /]<span class="comment"># ll -d /data/test4</span></span><br><span class="line">drwxrwxrwx 2 root root 6 Mar  9 14:42 /data/test4</span><br></pre></td></tr></table></figure>

<h3 id="10-rmdir-删除空目录"><a href="#10-rmdir-删除空目录" class="headerlink" title="10. rmdir 删除空目录"></a>10. rmdir 删除空目录</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rmdir [OPTION]... DIRECTORY...</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>删除空目录  </p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-p</td>
<td align="left">递归删除父空目录</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">显示详细信息</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># rmdir -pv /test/test1/test2/test3</span></span><br><span class="line">rmdir: removing directory, ‘/<span class="built_in">test</span>/test1/test2/test3’</span><br><span class="line">rmdir: removing directory, ‘/<span class="built_in">test</span>/test1/test2’</span><br><span class="line">rmdir: removing directory, ‘/<span class="built_in">test</span>/test1’</span><br><span class="line">rmdir: removing directory, ‘/<span class="built_in">test</span>’</span><br><span class="line">rmdir: removing directory, ‘/’</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>文件通配符</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/%E6%96%87%E4%BB%B6%E9%80%9A%E9%85%8D%E7%AC%A6/%E6%96%87%E4%BB%B6%E9%80%9A%E9%85%8D%E7%AC%A6/</url>
    <content><![CDATA[<h2 id="文件统配符"><a href="#文件统配符" class="headerlink" title="文件统配符"></a>文件统配符</h2><p>通配符是一种特殊语句，用来模糊搜索文件。当查找文件夹时，可以使用它来代替一个或多个真正字符；当不知道真正字符或者懒得输入完整名字时，常常使用通配符代替一个或多个真正的字符。</p>
<span id="more"></span>

<h3 id="常用的文件通配符"><a href="#常用的文件通配符" class="headerlink" title="常用的文件通配符"></a>常用的文件通配符</h3><table>
<thead>
<tr>
<th align="left">符号</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">*</td>
<td align="left">匹配零个或多个字符</td>
</tr>
<tr>
<td align="left">?</td>
<td align="left">匹配任意单个字符</td>
</tr>
<tr>
<td align="left">~</td>
<td align="left">当前用户家目录</td>
</tr>
<tr>
<td align="left">~masuri</td>
<td align="left">用户masuri家目录</td>
</tr>
<tr>
<td align="left">~+</td>
<td align="left">当前工作目录</td>
</tr>
<tr>
<td align="left">~-</td>
<td align="left">前一个工作目录</td>
</tr>
<tr>
<td align="left">[0-9]</td>
<td align="left">匹配数字范围</td>
</tr>
<tr>
<td align="left">[a-z]</td>
<td align="left">匹配小写字母</td>
</tr>
<tr>
<td align="left">[A-Z]</td>
<td align="left">匹配大写字母</td>
</tr>
<tr>
<td align="left">[wang]</td>
<td align="left">匹配列表中的任意字符</td>
</tr>
<tr>
<td align="left">[^wang]</td>
<td align="left">匹配除列表中字符外的任意字符</td>
</tr>
<tr>
<td align="left">[:digit:]</td>
<td align="left">任意数字，相当于0-9</td>
</tr>
<tr>
<td align="left">[:lower:]</td>
<td align="left">任意小写字母</td>
</tr>
<tr>
<td align="left">[:upper:]</td>
<td align="left">任意大写字母</td>
</tr>
<tr>
<td align="left">[:alpha:]</td>
<td align="left">任意大小写字母</td>
</tr>
<tr>
<td align="left">[:alnum:]</td>
<td align="left">任意字母或数字</td>
</tr>
<tr>
<td align="left">[:blank:]</td>
<td align="left">水平空白字符</td>
</tr>
<tr>
<td align="left">[:space:]</td>
<td align="left">水平或垂直空白字符</td>
</tr>
<tr>
<td align="left">[:punct:]</td>
<td align="left">标点符号</td>
</tr>
<tr>
<td align="left">[:print:]</td>
<td align="left">可打印字符</td>
</tr>
<tr>
<td align="left">[:cntrl:]</td>
<td align="left">控制字符</td>
</tr>
<tr>
<td align="left">[:graph:]</td>
<td align="left">图形字符</td>
</tr>
<tr>
<td align="left">[:xdigit:]</td>
<td align="left">十六进制字符</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>文本处理三剑客之awk</title>
    <url>/2019/03/11/Linux%E5%9F%BA%E7%A1%80/%E6%96%87%E6%9C%AC%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/%E6%96%87%E6%9C%AC%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BAWK/</url>
    <content><![CDATA[<h2 id="awk简介"><a href="#awk简介" class="headerlink" title="awk简介"></a>awk简介</h2><p>awk是一个优良的文本处理工具，是Linux中文本三剑客之一，awk的名字取自于其创始人Alfred Aho、Peter Weinberger和Brain Kernighan三人姓式的首字母。  </p>
<p>awk的功能及其强大，可以进行式样装入、流控制、数学运算符、进程控制语句甚至内置的变量和函数，他具备了一个完整语言所应有的几乎所有特性。</p>
<span id="more"></span>

<h3 id="awk语法"><a href="#awk语法" class="headerlink" title="awk语法"></a>awk语法</h3><p>awk程序由BEGIN语句块、能够使用模式匹配的通用语句块、END语句块，共3部分组成</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk [option] <span class="string">&#x27;[BEGIN&#123;action;...&#125;]pattern&#123;action;...&#125;[END&#123;action;...&#125;]&#x27;</span> file</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-F</td>
<td align="left">指定分隔符</td>
</tr>
<tr>
<td align="left">-f</td>
<td align="left">指定awk程序文件</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">变量赋值，每个变量都需要使用-v var=value来赋值</td>
</tr>
</tbody></table>
<h3 id="awk工作原理"><a href="#awk工作原理" class="headerlink" title="awk工作原理"></a>awk工作原理</h3><p>1.执行BEGIN{action;…}语句块中的语句BEGIN语句块在awk开始从输入流中读取的行之前被执行，这是个可选的语句块。<br>2.从文件或标准输入中读取一行，然后执行pattern{action;…}语句块，它逐行扫描文件，从第一行到最后一行重复这个过程，直到文件全部被读取完毕。<br>3.当读至输入流末尾时，执行END{action;…}语句块。END语句块，在awk从输入流种读取完所有的行之后再执行，比如打印所有行的分析结果这里信息汇总都是在END语句中完成，它也是个可选语句块</p>
<h2 id="awk基本用法"><a href="#awk基本用法" class="headerlink" title="awk基本用法"></a>awk基本用法</h2><p>awk最简单的使用方法为:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk [option] <span class="string">&#x27;pattern&#123;action;...&#125;&#x27;</span> file</span><br></pre></td></tr></table></figure>
<h3 id="一、print"><a href="#一、print" class="headerlink" title="一、print"></a>一、print</h3><p>print的参数可以是变量、数值或字符串。字符串必须用双引号引用，参数用逗号分隔。如果没有逗号，参数就串联在一起，无法区分。这里逗号的作用与输出文件的分隔符所用是一样的，只是后者是空格而已。当pattern不指定时默认打印文件中所有的行。  </p>
<p>示例1：打印/etc/fstab中的每一行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;print $0&#125;&#x27; /etc/fstab</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line"><span class="comment"># Created by anaconda on Tue Mar  5 21:07:19 2019</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;</span></span><br><span class="line"><span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">UUID=45490aa4-cf29-420d-a606-af32688b6707 /                       xfs     defaults        0 0</span><br><span class="line">UUID=15dcd896-b7cf-48d0-b8bd-4c0b0f2c62b2 /boot                   xfs     defaults        0 0</span><br><span class="line">UUID=4b6e1813-2c46-402a-869a-02cbbcb76ade /data                   xfs     defaults        0 0</span><br><span class="line">UUID=0995b444-48c1-4423-92bc-2deda0d3c082 swap                    swap    defaults        0 0</span><br></pre></td></tr></table></figure>

<h3 id="二、awk变量"><a href="#二、awk变量" class="headerlink" title="二、awk变量"></a>二、awk变量</h3><p>awk有内置变量和自定义变量  </p>
<p><strong>内置变量有FS、OFS、RS、ORS、NF、FNR、FILENAME、ARGC、ARGV</strong></p>
<h4 id="1-FS-设置输入域分隔符，等价于命令行选项-F"><a href="#1-FS-设置输入域分隔符，等价于命令行选项-F" class="headerlink" title="1.FS:设置输入域分隔符，等价于命令行选项-F"></a>1.FS:设置输入域分隔符，等价于命令行选项-F</h4><p>示例1：使用变量FS指定分隔符，取出/etc/fstab的第1第3列</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -v FS=: &#x27;&#123;print $1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line">root 0</span><br><span class="line">bin 1</span><br><span class="line">daemon 2</span><br><span class="line">...以下省略...</span><br></pre></td></tr></table></figure>

<p>示例2：使用选项-F指定分隔符，取出/etc/fstab的第1第3列</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F&quot;:&quot; &#x27;&#123;print $1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line">root 0</span><br><span class="line">bin 1</span><br><span class="line">daemon 2</span><br><span class="line">...以下省略...</span><br></pre></td></tr></table></figure>

<p>示例3：用正则表达式当分隔符取出分区利用率</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># df | awk -F&quot;[[:space:]]+|%&quot; &#x27;&#123;print $5&#125;&#x27;</span></span><br><span class="line">Use</span><br><span class="line">15</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">2</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">17</span><br></pre></td></tr></table></figure>

<p>示例4：变量在action中也能被引用,在第一个域和第3个域之间加:号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -v FS=: &#x27;&#123;print $1,FS,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line">root : 0</span><br><span class="line">bin : 1</span><br><span class="line">daemon : 2</span><br><span class="line">...以下省略...</span><br></pre></td></tr></table></figure>

<h4 id="2-OFS-设置输出时域分隔符，默认为空白"><a href="#2-OFS-设置输出时域分隔符，默认为空白" class="headerlink" title="2.OFS:设置输出时域分隔符，默认为空白"></a>2.OFS:设置输出时域分隔符，默认为空白</h4><p>示例1：以:为分隔符分隔字段，输出时以+++为分隔符，取出/etc/passwd第1第2字段</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -v FS=: -v OFS=+++ &#x27;&#123;print $1,$2&#125;&#x27; /etc/passwd</span></span><br><span class="line">root+++x</span><br><span class="line">bin+++x</span><br><span class="line">daemon+++x</span><br><span class="line">...以下省略...</span><br></pre></td></tr></table></figure>

<h4 id="3-RS-设置记录分隔符"><a href="#3-RS-设置记录分隔符" class="headerlink" title="3.RS:设置记录分隔符"></a>3.RS:设置记录分隔符</h4><p>当记录的分割符指定为某符号时，从字符开始至记录分隔符的字符串为一条记录，记录的条数和行数无关。  </p>
<p>示例1：创建一个文本指定;为分隔符查看记录情况。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat a.txt</span></span><br><span class="line">a,b,c;1,2,3,4,;aa,bb,cc</span><br><span class="line">zz,yy,xxx;122,444,2322;AA</span><br><span class="line">BB,CC</span><br></pre></td></tr></table></figure>

<p>以上面文件内容为例，以分号为记录的分隔符，此文件一共有5条记录。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -v RS=&quot;;&quot; &#x27;&#123;print $0&#125;&#x27; a.txt</span></span><br><span class="line">a,b,c</span><br><span class="line">1,2,3,4,</span><br><span class="line">aa,bb,cc            <span class="comment">#此行与下一行为一条记录中间隐藏了一个换行符</span></span><br><span class="line">zz,yy,xxx</span><br><span class="line">122,444,2322</span><br><span class="line">AA                  <span class="comment">#此行与下一行为一条记录中间隐藏了一个换行符</span></span><br><span class="line">BB,CC</span><br></pre></td></tr></table></figure>

<h4 id="4-ORS-设置输出时记录分隔符"><a href="#4-ORS-设置输出时记录分隔符" class="headerlink" title="4.ORS:设置输出时记录分隔符"></a>4.ORS:设置输出时记录分隔符</h4><p>ORS变量指定输出时的记录分隔符为什么符号。</p>
<p>示例：</p>
<p>依旧为a.txt文件，设置分隔符为,号，纪录分隔符为;号，输出时设置记录分分隔符为___，取出第一字段。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat a.txt</span></span><br><span class="line">a,b,c;1,2,3,4,;aa,bb,cc</span><br><span class="line">zz,yy,xxx;122,444,2322;AA</span><br><span class="line">BB,CC</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># awk -F, -v RS=&quot;;&quot; -v ORS=&quot;___&quot; &#x27;&#123;print $1&#125;&#x27; a.txt</span></span><br><span class="line">a___1___aa___122___AA       </span><br><span class="line">BB___</span><br></pre></td></tr></table></figure>

<h4 id="5-NF-域数"><a href="#5-NF-域数" class="headerlink" title="5.NF:域数"></a>5.NF:域数</h4><p>NF可以查看一条记录内有多少个域,也可以用来查看倒数第N个字符为什么</p>
<p>示例1：</p>
<p>以/etc/passwd为例，以:号为分隔符查看每行的字段数量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;&#123;print NF&#125;&#x27; /etc/passwd</span></span><br><span class="line">7</span><br><span class="line">7</span><br><span class="line">7</span><br><span class="line">...以下省略...</span><br></pre></td></tr></table></figure>

<p>示例2：</p>
<p>查看/etc/passwd文件内，以:为分隔符，倒数第2个字段的内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;&#123;print $(NF-1)&#125;&#x27; /etc/passwd</span></span><br><span class="line">/root</span><br><span class="line">/bin</span><br><span class="line">/sbin</span><br><span class="line">...以下省略...</span><br></pre></td></tr></table></figure>

<h4 id="6-NR-记录数"><a href="#6-NR-记录数" class="headerlink" title="6.NR:记录数"></a>6.NR:记录数</h4><p>NR变量为已读文件的记录数</p>
<p>示例1：</p>
<p>以;为记录符，在a.txt的文件的每条记录前加上记录行。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat a.txt</span></span><br><span class="line">a,b,c;1,2,3,4,;aa,bb,cc</span><br><span class="line">zz,yy,xxx;122,444,2322;AA</span><br><span class="line">BB,CC</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk -v RS=&quot;;&quot; &#x27;&#123;print NR,$0&#125;&#x27; a.txt </span></span><br><span class="line">1 a,b,c</span><br><span class="line">2 1,2,3,4,</span><br><span class="line">3 aa,bb,cc</span><br><span class="line">zz,yy,xxx</span><br><span class="line">4 122,444,2322</span><br><span class="line">5 AA</span><br><span class="line">BB,CC</span><br></pre></td></tr></table></figure>

<p>NR变量还可以合并计数多个文件的记录</p>
<p>示例2：查看/etc/fstab和/etc/issue总共有多少记录号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;print NR&#125;&#x27; /etc/fstab /etc/issue</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">...中间省略...</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td></tr></table></figure>

<h4 id="7-FNR：文件的记录数"><a href="#7-FNR：文件的记录数" class="headerlink" title="7.FNR：文件的记录数"></a>7.FNR：文件的记录数</h4><p>FNR变量为每个文件分别记录记录数。  </p>
<p>示例：查看/etc/fstab和/etc/issue的记录数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;print FNR&#125;&#x27; /etc/fstab /etc/issue</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">...中间省略...</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<h4 id="8-FILENAME-文件名"><a href="#8-FILENAME-文件名" class="headerlink" title="8.FILENAME:文件名"></a>8.FILENAME:文件名</h4><p>FILENAME变量为输出文件名  </p>
<p>示例：在匹配到的行后面加上文件名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;print $0,FILENAME&#125;&#x27; /etc/passwd</span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash /etc/passwd</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin /etc/passwd</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin /etc/passwd</span><br><span class="line">...以下省略...</span><br></pre></td></tr></table></figure>

<h4 id="9-ARGC-命令行参数个数"><a href="#9-ARGC-命令行参数个数" class="headerlink" title="9.ARGC:命令行参数个数"></a>9.ARGC:命令行参数个数</h4><p>ARGC变量存放的为参数个数。  </p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;print ARGC&#125;&#x27; /etc/issue</span></span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">2           </span><br></pre></td></tr></table></figure>

<p>显示为2个参数，是哪两个参数呢？看下面那个函数</p>
<h4 id="10-ARGV-查看命令行参数"><a href="#10-ARGV-查看命令行参数" class="headerlink" title="10.ARGV:查看命令行参数"></a>10.ARGV:查看命令行参数</h4><p>ARGV变量为一个数组里面存放的为awk的每个参数</p>
<p>示例：</p>
<p>打印每一个参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;print ARGV[1]&#125;&#x27; /etc/issue</span></span><br><span class="line">/etc/issue</span><br><span class="line">/etc/issue</span><br><span class="line">/etc/issue</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;print ARGV[0]&#125;&#x27; /etc/issue</span></span><br><span class="line">awk</span><br><span class="line">awk</span><br><span class="line">awk</span><br></pre></td></tr></table></figure>

<h3 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h3><p>自定义变量的赋值有2种方法  </p>
<h4 id="1-v-var-value"><a href="#1-v-var-value" class="headerlink" title="1.-v var=value"></a>1.-v var=value</h4><p>示例1：输出变量在每行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -v title=ceo -F: &#x27;&#123;print title&quot;:&quot;$1&#125;&#x27; /etc/passwd</span></span><br><span class="line">ceo:root</span><br><span class="line">ceo:bin</span><br><span class="line">ceo:daemon</span><br><span class="line">ceo:adm</span><br><span class="line">ceo:lp</span><br></pre></td></tr></table></figure>
<h5 id="2-可以直接在program中直接定义"><a href="#2-可以直接在program中直接定义" class="headerlink" title="2.可以直接在program中直接定义"></a>2.可以直接在program中直接定义</h5><p>把变量放在{}内赋值时，变量值必须要加双引号，变量必须先赋值再引用，次序错误会导致第一次匹配到的行没有值  </p>
<p>示例1：在每个用户前加上ceo</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;&#123;title=&quot;ceo&quot;; print title&quot;:&quot;$1&#125;&#x27; /etc/passwd</span></span><br><span class="line">ceo:root</span><br><span class="line">ceo:bin</span><br><span class="line">ceo:daemon</span><br><span class="line">ceo:adm</span><br><span class="line">ceo:lp</span><br><span class="line">ceo:sync</span><br></pre></td></tr></table></figure>

<p>示例2：调用脚本文件  </p>
<p>awk ‘{action}’ 单引号内的脚本可以存放在文件内被调用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat 2.txt</span></span><br><span class="line">&#123;title=<span class="string">&quot;ceo&quot;</span>;<span class="built_in">print</span> title<span class="string">&quot;:&quot;</span><span class="variable">$1</span>&#125;</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk -F: -f 2.txt /etc/passwd</span></span><br><span class="line">ceo:root</span><br><span class="line">ceo:bin</span><br><span class="line">ceo:daemon</span><br></pre></td></tr></table></figure>

<h3 id="三、printf"><a href="#三、printf" class="headerlink" title="三、printf"></a>三、printf</h3><p>printf格式化输出：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">&quot;FORMAT&quot;</span> ,item1,item2,...</span><br></pre></td></tr></table></figure>

<p>使用printf时，需要注意以下3点：</p>
<ol>
<li><p>使用printf时必须指定FORMAT，</p>
</li>
<li><p>printf不会自动换行，需要显式给出换行控制符\n</p>
</li>
<li><p>FORMAT中需要分别为后面每个item指定格式符</p>
</li>
</ol>
<p>printf的格式符有以下：</p>
<table>
<thead>
<tr>
<th align="left">格式符</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">%c</td>
<td align="left">显示字符的ASCII码</td>
</tr>
<tr>
<td align="left">%d,%i</td>
<td align="left">显示十进制整数</td>
</tr>
<tr>
<td align="left">%e，%E</td>
<td align="left">显示科学计数法数值</td>
</tr>
<tr>
<td align="left">%f</td>
<td align="left">显示浮点数</td>
</tr>
<tr>
<td align="left">%g</td>
<td align="left">以科学计数法或浮点形式显示数值</td>
</tr>
<tr>
<td align="left">%s</td>
<td align="left">显示字符串</td>
</tr>
<tr>
<td align="left">%u</td>
<td align="left">无符号整数</td>
</tr>
<tr>
<td align="left">%%</td>
<td align="left">显示%自身</td>
</tr>
<tr>
<td align="left">printf中除了格式符还有修饰符：</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">修饰符</td>
<td align="left">说明</td>
</tr>
<tr>
<td align="left">:-</td>
<td align="left">:-</td>
</tr>
<tr>
<td align="left">#[.#]</td>
<td align="left">第一个数字控制显示的宽度；第二个#标识小数点后精度，%3.1f</td>
</tr>
<tr>
<td align="left">-</td>
<td align="left">左对齐（默认为右对齐）%-15s</td>
</tr>
<tr>
<td align="left">+</td>
<td align="left">显示数值的正负值符号%+d</td>
</tr>
</tbody></table>
<p>示例1：</p>
<p>%d打印整数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo 100.222 | awk &#x27;&#123;printf &quot;this is %d&quot; ,$0&quot;\n&quot;&#125;&#x27;</span></span><br><span class="line">this is 100</span><br></pre></td></tr></table></figure>

<p>示例2：</p>
<p>格式符有几个对应的item项就要就几个否则语法错误</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo &quot;123.455 221.245&quot; | awk &#x27;&#123;printf &quot;this is %d %d&quot; ,$1,$2&#125;&#x27;</span></span><br><span class="line">this is 123 221</span><br></pre></td></tr></table></figure>

<p>示例3：</p>
<p>%f可以打印小数，默认输出的为6位。也可以指定小数位。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo &quot;123.455 221.245&quot; | awk &#x27;&#123;printf &quot;this is %f&quot; ,$1&#125;&#x27;</span></span><br><span class="line">this is 123.455000</span><br><span class="line"><span class="comment">#指定小数位用法</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo &quot;123.455 221.245&quot; | awk &#x27;&#123;printf &quot;this is %.3f&quot; ,$1&#125;&#x27;</span></span><br><span class="line">this is 123.455</span><br></pre></td></tr></table></figure>

<p>示例4：</p>
<p>.之前的数字为长度（默认右对齐）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo &quot;123.455 221.245&quot; | awk &#x27;&#123;printf &quot;this is %10.3f %10.3f&quot; ,$1,$2&#125;&#x27;        </span></span><br><span class="line">this is    123.455    221.245</span><br></pre></td></tr></table></figure>

<p>示例5：</p>
<p>指定左对齐，在%后面加上-</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo &quot;123.222 345.23&quot; |awk &#x27;&#123;printf &quot;this is %-10.3f %-10.3f&quot;,$1,$2&#125;&#x27;</span></span><br><span class="line">this is 123.222    345.230   </span><br></pre></td></tr></table></figure>

<h3 id="四、操作符"><a href="#四、操作符" class="headerlink" title="四、操作符"></a>四、操作符</h3><p>awk还支持各种操作符如算数操作符、字符串操作符、赋值操作符、比较操作符、模式匹配操作符</p>
<h4 id="1-算数操作符"><a href="#1-算数操作符" class="headerlink" title="1.算数操作符"></a>1.算数操作符</h4><p>算数操作符有+、-、*、/、^、%，如：</p>
<p>x+y,x-y,x*y,x/y,x^y,x%y</p>
<p>示例1：</p>
<p>简单的算术运算</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;I=20;J=10;M=I+J;print M&#125;&#x27;</span></span><br><span class="line">30</span><br></pre></td></tr></table></figure>

<p>示例2：</p>
<p>-x:转换为负数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;I=20;I=-I;print I&#125;&#x27;</span></span><br><span class="line">-20</span><br></pre></td></tr></table></figure>

<h4 id="2-赋值操作符："><a href="#2-赋值操作符：" class="headerlink" title="2.赋值操作符："></a>2.赋值操作符：</h4><p>赋值操作符有：=，+=，-=，*=，/=，%=，^=,++,–</p>
<p>示例1：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;I=10;I+=2;print I&#125;&#x27;</span></span><br><span class="line">12</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;I=10;I-=2;print I&#125;&#x27;</span></span><br><span class="line">8</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;I=10;I*=2;print I&#125;&#x27;</span></span><br><span class="line">20</span><br></pre></td></tr></table></figure>

<h4 id="3-比较操作符和模式匹配符"><a href="#3-比较操作符和模式匹配符" class="headerlink" title="3.比较操作符和模式匹配符"></a>3.比较操作符和模式匹配符</h4><p>比较操作符和模式匹配符常用在awk的行过滤pattern中，Pattern为空时所有都符合条件</p>
<p>pattern中可以添加比较符号和模式匹配</p>
<p>比较符号有：==(等于)，!=(不等于)，&gt;(大于)，&gt;=(大于等于)，&lt;(小于)，&lt;=(小于等于)</p>
<p>模式匹配符：<del>(符号左边内容是否右边匹配内容，包含内容)，!</del>(符号左边内容的是否不匹配右边内容)</p>
<p>模式匹配时可以使用正则表达式！</p>
<p>3.1比较操作符示例</p>
<p>示例1:</p>
<p>取出连接主机的IP</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ss -tn | awk -F&quot; +|:&quot; &#x27;NR&gt;1&#123;print $(NF-2)&#125;&#x27; </span></span><br><span class="line">192.168.172.1</span><br></pre></td></tr></table></figure>

<p>示例2:</p>
<p>取出用户列表中UID大于1000的用户和ID</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;$3&gt;1000&#123;print $1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line">nfsnobody 65534</span><br></pre></td></tr></table></figure>

<p>示例3:</p>
<p>取出ip地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ifconfig | awk &#x27;NR==2&#123;print $2&#125;&#x27;</span></span><br><span class="line">192.168.172.129</span><br></pre></td></tr></table></figure>

<p>示例4:</p>
<p>取出分区利用率大于10的设备</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># df | awk -F&quot; +|%&quot; &#x27;/\/dev\/sd/ &amp;&amp; $5&gt;10&#123;print $1,$5&#125;&#x27;</span></span><br><span class="line">/dev/sda1 17</span><br></pre></td></tr></table></figure>

<p>3.2模式匹配示例  </p>
<p>示例1：匹配第一列为/dev/sd开头行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># df | awk &#x27;/\/dev\/sd/&#123;print $1&#125;&#x27;</span></span><br><span class="line">/dev/sda2</span><br><span class="line">/dev/sda3</span><br><span class="line">/dev/sda1</span><br></pre></td></tr></table></figure>

<p>示例2：匹配/etc/fstab非#开头的行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;!/^#/&#x27; /etc/fstab </span></span><br><span class="line"></span><br><span class="line">UUID=45490aa4-cf29-420d-a606-af32688b6707 /                       xfs     defaults        0 0</span><br><span class="line">UUID=15dcd896-b7cf-48d0-b8bd-4c0b0f2c62b2 /boot                   xfs     defaults        0 0</span><br><span class="line">UUID=4b6e1813-2c46-402a-869a-02cbbcb76ade /data                   xfs     defaults        0 0</span><br><span class="line">UUID=0995b444-48c1-4423-92bc-2deda0d3c082 swap                    swap    defaults        0 0</span><br></pre></td></tr></table></figure>

<h4 id="4-逻辑操作符"><a href="#4-逻辑操作符" class="headerlink" title="4.逻辑操作符"></a>4.逻辑操作符</h4><p>逻辑操作符：与&amp;&amp;，或||，非！  </p>
<p>示例1：  </p>
<p>取出/etc/passwd非nologin结尾的行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;!/nologin$/&#x27; /etc/passwd</span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">sync:x:5:0:sync:/sbin:/bin/sync</span><br><span class="line">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">masuri:x:1000:1000:masuri:/home/masuri:/bin/bash</span><br></pre></td></tr></table></figure>

<p>示例2：  </p>
<p>取出分区利用率大于10的设备名和分区利用率</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># df | awk -F&quot; +|%&quot; &#x27;/\/dev\/sd/ &amp;&amp; $5&gt;10&#123;print $1,$5&#125;&#x27;</span></span><br><span class="line">/dev/sda1 17</span><br></pre></td></tr></table></figure>

<p>示例3：  </p>
<p>取出连接数前3的IP地址  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># netstat -tn | awk -F&quot; +|:&quot; &#x27;/ESTABLISHED/&#123;print $6&#125;&#x27; | sort | uniq -c | sort -nr | head -3</span></span><br></pre></td></tr></table></figure>

<h4 id="5-三目表达式"><a href="#5-三目表达式" class="headerlink" title="5.三目表达式"></a>5.三目表达式</h4><p>三目表达式格式：  </p>
<p>selector?if-ture-expression:if-false-expression  </p>
<p>判断selector是否为真，如果为真则执行if-ture语句，不为真则执行if-false语句。  </p>
<p>示例1：  </p>
<p>在Uid大于等于1000的用户前添加commom user，小于1000的添加system user  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;$3&gt;=1000?USER=&quot;COMMOM USER:&quot;:USER=&quot;SYSTEM USER:&quot;&#123;print USER$1&#125;&#x27; /etc/passwd</span></span><br><span class="line">SYSTEM USER:root</span><br><span class="line">SYSTEM USER:bin</span><br><span class="line">...中间省略...</span><br><span class="line">SYSTEM USER:ntp</span><br><span class="line">SYSTEM USER:tcpdump</span><br><span class="line">COMMOM USER:masuri</span><br></pre></td></tr></table></figure>

<h3 id="五、PATTERN部分总结"><a href="#五、PATTERN部分总结" class="headerlink" title="五、PATTERN部分总结"></a>五、PATTERN部分总结</h3><p>PATTEN:awk在执行时会根据pattern条件，过滤匹配的行，再做处理。  </p>
<p>pattern的条件可以有以下几种：  </p>
<h4 id="1-空"><a href="#1-空" class="headerlink" title="1.空"></a>1.空</h4><p>如果pattern部分为空，则默认匹配每一行    </p>
<p>示例：打印所有行  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;print $0&#125;&#x27; /etc/fstab</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line"><span class="comment"># Created by anaconda on Tue Mar  5 21:07:19 2019</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;</span></span><br><span class="line"><span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">UUID=45490aa4-cf29-420d-a606-af32688b6707 /                       xfs     defaults        0 0</span><br><span class="line">UUID=15dcd896-b7cf-48d0-b8bd-4c0b0f2c62b2 /boot                   xfs     defaults        0 0</span><br><span class="line">UUID=4b6e1813-2c46-402a-869a-02cbbcb76ade /data                   xfs     defaults        0 0</span><br><span class="line">UUID=0995b444-48c1-4423-92bc-2deda0d3c082 swap                    swap    defaults        0 0</span><br></pre></td></tr></table></figure>

<h4 id="2-正则表达式"><a href="#2-正则表达式" class="headerlink" title="2.正则表达式"></a>2.正则表达式</h4><p>/regular expression/:仅处理能够被模式匹配到的行，需要用//括起来  </p>
<p>示例：找出/etc/passwd中以g开头的行的第1字段和第3字段  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;/^g/&#123;print $1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line">games 12</span><br><span class="line">gluster 993</span><br><span class="line">geoclue 992</span><br><span class="line">gdm 42</span><br><span class="line">gnome-initial-setup 989</span><br></pre></td></tr></table></figure>

<h4 id="3-关系表达式"><a href="#3-关系表达式" class="headerlink" title="3.关系表达式"></a>3.关系表达式</h4><p>relational expression: 关系表达式，结果为“真”才会被处理  </p>
<p>真和假的定义：  </p>
<p>3.1真：结果为非0值，非空字符串    </p>
<p>示例1: 当有值时为真，输出所有。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># seq 3 | awk &#x27;2&#x27;</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>示例2：当数字为负数时，输出也为真</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># seq 3 | awk &#x27;&quot;-1&quot;&#x27;</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>示例3：当中间的数字为空格时也为真</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># seq 3 | awk &#x27;&quot; &quot;&#x27;</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>3.2假：结果为空字符串或0值，假则不会被处理  </p>
<p>示例1：当值为空和0时不做输出  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># seq 5 | awk &#x27;&quot;&quot;&#x27;</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># seq 5 | awk &#x27;0&#x27;</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>示例2：在awk中不加字符不添加双引号表示为变量，变量为空和0时也为假，变量中有值时为真</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># seq 5 | awk &#x27;i&#x27;               #变量中没有值，假</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># seq 5 | awk -v i=1 &#x27;i&#x27;        #变量中有值，真，输出结果</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<h4 id="4-行范围"><a href="#4-行范围" class="headerlink" title="4.行范围"></a>4.行范围</h4><p>pattern可以使用行范围进行匹配  </p>
<p>/pat1/,/pat2/ 不支持直接给出数字格式   </p>
<p>示例：打印b开头的行到f开头的行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;/^b/,/^f/&#x27; /etc/passwd</span></span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class="line">sync:x:5:0:sync:/sbin:/bin/sync</span><br><span class="line">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">mail:x:8:12:mail:/var/spool/mail:/sbin/nologin</span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br><span class="line">games:x:12:100:games:/usr/games:/sbin/nologin</span><br><span class="line">ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin</span><br></pre></td></tr></table></figure>

<h4 id="5-BEGIN-END模式"><a href="#5-BEGIN-END模式" class="headerlink" title="5.BEGIN/END模式"></a>5.BEGIN/END模式</h4><p>BEGIN{}：仅在开始处理文件中的文本之前执行一次  </p>
<p>END{}：仅在文本处理完成之后执行一  </p>
<p>示例1：使用BEGIN来添加表头，做格式化输出。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;BEGIN&#123;print &quot;|USERNAME                       |UID\n------------------------------------&quot;&#125;&#123;printf &quot;|%-30s |%-10d\n--------------------------------------\n&quot;,$1,$3&#125;&#x27; /etc/passwd </span></span><br><span class="line">|USERNAME                       |UID</span><br><span class="line">------------------------------------</span><br><span class="line">|root                           |0         </span><br><span class="line">--------------------------------------</span><br><span class="line">|bin                            |1         </span><br><span class="line">--------------------------------------</span><br><span class="line">|daemon                         |2         </span><br><span class="line">--------------------------------------</span><br><span class="line">|adm                            |3         </span><br><span class="line">--------------------------------------</span><br><span class="line">|lp                             |4         </span><br><span class="line">--------------------------------------</span><br><span class="line">|sync                           |5         </span><br><span class="line">--------------------------------------</span><br><span class="line">|shutdown                       |6         </span><br></pre></td></tr></table></figure>

<h3 id="六、awk控制语句"><a href="#六、awk控制语句" class="headerlink" title="六、awk控制语句"></a>六、awk控制语句</h3><p>流程控制语句是任何程序设计语言都不能缺少的部分。任何好的语言都有一些执行流程控制的语句。awk提供的完备的流程控制语句类似于C语言，这给我们编程带来了极大的方便。  </p>
<p>awk控制语句有：if-else，while循环，do-while循环，for循环，break，continue，delete array[index]，delete array,exit</p>
<h4 id="1-if-else"><a href="#1-if-else" class="headerlink" title="1.if-else"></a>1.if-else</h4><p>使用场景：对awk取得的整行或某个字段做条件判断</p>
<p>语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(condition)&#123;statement;…&#125;[<span class="keyword">else</span> statement]    </span><br><span class="line"><span class="keyword">if</span>(condition1)&#123;statement1&#125;<span class="keyword">else</span> <span class="keyword">if</span>(condition2)&#123;statement2&#125;<span class="keyword">else</span>&#123;statement3&#125; </span><br></pre></td></tr></table></figure>

<p>示例：1.打印出/etc/passwd下uid大于1000的行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;&#123;if($3&gt;1000)print $0&#125;&#x27; /etc/passwd</span></span><br><span class="line">nfsnobody:x:65534:65534:Anonymous NFS User:/var/lib/nfs:/sbin/nologin</span><br></pre></td></tr></table></figure>

<p>示例2：如果Uid为偶数则打印出uid和用户名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;&#123;if($3%2==0)print $1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line">root 0</span><br><span class="line">daemon 2</span><br><span class="line">lp 4</span><br><span class="line">shutdown 6</span><br><span class="line">mail 8</span><br><span class="line">games 12</span><br><span class="line">ftp 14</span><br><span class="line">systemd-network 192</span><br><span class="line">libstoragemgmt 998</span><br><span class="line">rpc 32</span><br><span class="line">saslauth 996</span><br><span class="line">rtkit 172</span><br><span class="line">nfsnobody 65534</span><br><span class="line">unbound 994</span><br><span class="line">geoclue 992</span><br><span class="line">saned 990</span><br><span class="line">gdm 42</span><br><span class="line">sshd 74</span><br><span class="line">avahi 70</span><br><span class="line">ntp 38</span><br><span class="line">tcpdump 72</span><br><span class="line">masuri 1000</span><br></pre></td></tr></table></figure>

<p>示例3：考试成绩判断，60及格，80分还行，80分以上真棒，60以下不及格</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -v score=80 &#x27;BEGIN&#123;if(score&lt;60)&#123;print &quot;no pass&quot;&#125;else if(score&lt;=80)&#123;print &quot;just so so&quot;&#125;else if(score&gt;80)&#123;print &quot;good&quot;&#125;&#125;&#x27;</span></span><br><span class="line">just so so</span><br></pre></td></tr></table></figure>

<h4 id="2-while循环"><a href="#2-while循环" class="headerlink" title="2.while循环"></a>2.while循环</h4><p>使用场景：  </p>
<ol>
<li><p>对一行内的多个字段逐一类似处理时使用  </p>
</li>
<li><p>对数组中的各元素逐一处理时使用    </p>
</li>
</ol>
<p>语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span>(condition)&#123;statement;...&#125;</span><br></pre></td></tr></table></figure>

<p>条件为真进入循环，条件为假退出循环。</p>
<p>示例1：打印/etc/password第一行每一字段的长度</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;NR==1&#123;i=1;while(i&lt;=NF)&#123;print $i,length($i);i++&#125;&#125;&#x27; etc/passwd</span></span><br><span class="line">root 4</span><br><span class="line">x 1</span><br><span class="line">0 1</span><br><span class="line">0 1</span><br><span class="line">root 4</span><br><span class="line">/root 5</span><br><span class="line">/bin/bash 9</span><br></pre></td></tr></table></figure>

<p>示例2：取出最大值和最小值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F, &#x27;&#123;max=$1;mix=$1;i=1;while(i&lt;=NF)&#123;if($i&gt;max)&#123;max=$i&#125;;if($i&lt;mix)&#123;mix=$i&#125;;i++&#125;;print mix,max&#125;&#x27; test1 </span></span><br><span class="line">207 31976</span><br></pre></td></tr></table></figure>

<p>示例3：1+2+3+..+100</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;i=1;while(i&lt;=100)&#123;sum+=i;i++&#125;print sum&#125;&#x27;</span></span><br><span class="line">5050</span><br></pre></td></tr></table></figure>

<h4 id="3-for循环"><a href="#3-for循环" class="headerlink" title="3.for循环"></a>3.for循环</h4><p>常用语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(expr1;expr2;expr3)&#123;statement;...&#125;</span><br></pre></td></tr></table></figure>

<p>特殊用法：便利数组中的元素</p>
<p>语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(i <span class="keyword">in</span> arrary)&#123;<span class="keyword">for</span> body&#125;</span><br></pre></td></tr></table></figure>

<p>示例1：for循环1+到100</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;for(i=1;i&lt;=100;i++)&#123;sum+=i&#125;print sum&#125;&#x27;</span></span><br><span class="line">5050</span><br></pre></td></tr></table></figure>

<h4 id="4-break和continue"><a href="#4-break和continue" class="headerlink" title="4.break和continue"></a>4.break和continue</h4><p>break为提前结束循环</p>
<p>continue为提前结束本次循环，进入下一次循环  </p>
<p>示例：将1到100的偶数相加</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;for(i=1;i&lt;=100;i++)&#123;if(i%2==0)&#123;sum+=i&#125;&#125;print sum&#125;&#x27;</span></span><br><span class="line">2550</span><br></pre></td></tr></table></figure>

<p>1-100的偶数相加，当i=50时跳出不加，继续执行后续循环</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;for(i=1;i&lt;=100;i++)&#123;if(i==50)&#123;continue&#125;;if(i%2==0)&#123;sum+=i&#125;&#125;print sum&#125;&#x27;</span></span><br><span class="line">2500</span><br></pre></td></tr></table></figure>

<p>1-100的偶数相加，当i=50时跳出所有循环</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;for(i=1;i&lt;=100;i++)&#123;if(i==50)&#123;break&#125;;if(i%2==0)&#123;sum+=i&#125;&#125;print sum&#125;&#x27;</span></span><br><span class="line">600</span><br></pre></td></tr></table></figure>

<h4 id="5-next"><a href="#5-next" class="headerlink" title="5.next"></a>5.next</h4><p>next是提前结束对本行的处理直接进入下一行的处理，break跳出的是awk自身的循环。</p>
<p>示例：</p>
<p>打印Uid为偶数的行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F: &#x27;&#123;if($3%2==!0)&#123;next&#125;print $1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line">root 0</span><br><span class="line">daemon 2</span><br><span class="line">lp 4</span><br><span class="line">shutdown 6</span><br><span class="line">mail 8</span><br><span class="line">games 12</span><br><span class="line">ftp 14</span><br><span class="line">systemd-network 192</span><br><span class="line">libstoragemgmt 998</span><br><span class="line">rpc 32</span><br><span class="line">saslauth 996</span><br><span class="line">rtkit 172</span><br><span class="line">nfsnobody 65534</span><br><span class="line">unbound 994</span><br><span class="line">geoclue 992</span><br><span class="line">saned 990</span><br><span class="line">gdm 42</span><br><span class="line">sshd 74</span><br><span class="line">avahi 70</span><br><span class="line">ntp 38</span><br><span class="line">tcpdump 72</span><br><span class="line">masuri 1000</span><br></pre></td></tr></table></figure>

<h3 id="七、awk数组"><a href="#七、awk数组" class="headerlink" title="七、awk数组"></a>七、awk数组</h3><p>awk数组为关联数组：array[index-expression]  </p>
<p>index-expression为数组下标  </p>
<p>数组在使用时需注意以下几点：  </p>
<ol>
<li><p>数组下标可使用任意字符串;字符串要使用双引号括起来  </p>
</li>
<li><p>如果某数组元素事先不存在，在引用时，awk会自动创建此元素，并将其初始化为“空串”  </p>
</li>
<li><p>若要判断数组中是否存在某元素，要时用“index in array”格式进行遍历</p>
</li>
</ol>
<p>示例：给数组赋值，和输出数组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;arr[&quot;ceo&quot;]=&quot;mage&quot;;arr[&quot;cto&quot;]=&quot;laowang&quot;;print arr[&quot;ceo&quot;]&#125;&#x27;</span></span><br><span class="line">mage</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;arr[&quot;ceo&quot;]=&quot;mage&quot;;arr[&quot;cto&quot;]=&quot;laowang&quot;;print arr[&quot;cto&quot;]&#125;&#x27;</span></span><br><span class="line">laowang</span><br></pre></td></tr></table></figure>

<p>若要遍历数组中的每个元素，要使用for循环 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(var <span class="keyword">in</span> array)&#123;for-body&#125;  </span><br></pre></td></tr></table></figure>

<p>注意：var会遍历arry的每个索引</p>
<p>示例：遍历数组，可以先将数组下标赋给i</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;arr[&quot;ceo&quot;]=&quot;mage&quot;;arr[&quot;cto&quot;]=&quot;laowang&quot;;for(i in arr)&#123;print arr[i]&#125;&#125;&#x27;</span></span><br><span class="line">mage</span><br><span class="line">laowang</span><br></pre></td></tr></table></figure>

<p>示例2：数组的其他用法：去重</p>
<p>创建一个文件输入以下内容，然后执行awk命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat f1.txt </span></span><br><span class="line">aa</span><br><span class="line">bb</span><br><span class="line">cc</span><br><span class="line">aa</span><br><span class="line">11</span><br><span class="line">22</span><br><span class="line">11</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;!line[$0]++&#x27; f1.txt</span></span><br><span class="line">aa</span><br><span class="line">bb</span><br><span class="line">cc</span><br><span class="line">11</span><br><span class="line">22</span><br></pre></td></tr></table></figure>

<p>此方法比较绕，读入第一行aa作为数组line的下标，此时数组内的值为空“假”取反后为真打印此行，然后再执行++，此时line内的值为1，当再次遇到aa的行时，数组line[aa]内有值1，取反后为假不输出，然后再++此时[aa]内值为2</p>
<p>验证：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;!line[$0]++;print $0,line[$0]&#125;&#x27; f1.txt</span></span><br><span class="line">aa 1</span><br><span class="line">bb 1</span><br><span class="line">cc 1</span><br><span class="line">aa 2</span><br><span class="line">11 1</span><br><span class="line">22 1</span><br><span class="line">11 2</span><br></pre></td></tr></table></figure>

<p>示例：数组的高级用法  </p>
<p>取连接状态数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># netstat -tna | awk &#x27;/^tcp/&#123;state[$NF]++&#125;END&#123;for(i in state)&#123;print i,state[i]&#125;&#125;&#x27;       #state[$NF]++表示将最后一个字段作为数组的下标，然后对里面的值+1，当再次遇到相同的下标时，再次加1</span></span><br><span class="line">LISTEN 11</span><br><span class="line">ESTABLISHED 1</span><br></pre></td></tr></table></figure>

<p>统计每个ip的连接次数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;ip[$1]++&#125;END&#123;for(i in ip)&#123;print i,ip[i]&#125;&#125;&#x27; access_log </span></span><br><span class="line">172.20.0.200 1482</span><br><span class="line">172.20.21.121 2</span><br><span class="line">172.20.30.91 29</span><br><span class="line">172.16.102.29 864</span><br><span class="line">172.20.0.76 1565</span><br><span class="line">172.20.9.9 15</span><br><span class="line">172.20.1.125 463</span><br><span class="line">172.20.61.11 2</span><br><span class="line">172.20.73.73 198</span><br><span class="line">172.20.107.222 3</span><br><span class="line">172.20.0.222 2834</span><br><span class="line">172.20.111.240 4</span><br></pre></td></tr></table></figure>

<p>取出连接数排名前10的ip</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;&#123;ip[$1]++&#125;END&#123;for(i in ip)&#123;print ip[i],i&#125;&#125;&#x27; access_log | sort -nr | head</span></span><br><span class="line">4870 172.20.116.228</span><br><span class="line">3429 172.20.116.208</span><br><span class="line">2834 172.20.0.222</span><br><span class="line">2613 172.20.112.14</span><br><span class="line">2267 172.20.0.227</span><br><span class="line">2262 172.20.116.179</span><br><span class="line">2259 172.20.65.65</span><br><span class="line">1565 172.20.0.76</span><br><span class="line">1482 172.20.0.200</span><br><span class="line">1110 172.20.28.145</span><br></pre></td></tr></table></figure>

<p>小练习：</p>
<p>统计男女生的平均分数</p>
<table>
<thead>
<tr>
<th align="left">name</th>
<th align="left">score</th>
<th align="left">gender</th>
</tr>
</thead>
<tbody><tr>
<td align="left">a</td>
<td align="left">100</td>
<td align="left">m</td>
</tr>
<tr>
<td align="left">b</td>
<td align="left">99</td>
<td align="left">f</td>
</tr>
<tr>
<td align="left">c</td>
<td align="left">80</td>
<td align="left">m</td>
</tr>
<tr>
<td align="left">d</td>
<td align="left">98</td>
<td align="left">f</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -F&quot; +&quot; &#x27;NR&gt;1&#123;num[$3]++;sum[$3]+=$2&#125;END&#123;for(i in sum)print i,sum[i]/num[i]&#125;&#x27; score </span></span><br><span class="line">m 90</span><br><span class="line">f 98.5</span><br></pre></td></tr></table></figure>

<h3 id="八、字符串处理"><a href="#八、字符串处理" class="headerlink" title="八、字符串处理"></a>八、字符串处理</h3><p>1.length([s]):返回字符串的长度</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;print length(&quot;abc&quot;)&#125;&#x27;</span></span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>2.sub(r,s,[t]):对t字符串搜索r表示的模式匹配的内容，并替换为s所表示的内容(只替换第一次匹配到的)</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo &quot;2008:08:08 08:08:08&quot; | awk &#x27;&#123;sub(/:/,&quot;-&quot;,$1);print $0&#125;&#x27;</span></span><br><span class="line">2008-08:08 08:08:08</span><br></pre></td></tr></table></figure>

<p>3.gsub(r,s,[t]):对t字符串搜索r表示的模式匹配的内容，并全部替换为s所表示的内容</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo &quot;2008:08:08 08:08:08&quot; | awk &#x27;&#123;gsub(/:/,&quot;-&quot;,$1);print $0&#125;&#x27;</span></span><br><span class="line">2008-08-08 08:08:08</span><br></pre></td></tr></table></figure>

<p>4.splits(s,arry,[r]):以r为分隔符，切割字符串，并将切割后的字符串保存至array做表示的数组中，第一个索引值为1，第二个索引值为2，…</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo &quot;2008:08:08 08:08:08&quot; | awk &#x27;&#123;split($0,arr,&quot;:&quot;);&#125;END&#123;for(i in arr)&#123;print i,arr[i]&#125;&#125;&#x27;</span></span><br><span class="line">4 08</span><br><span class="line">5 08</span><br><span class="line">1 2008</span><br><span class="line">2 08</span><br><span class="line">3 08 08</span><br></pre></td></tr></table></figure>

<p>用函数来实现ip连接次数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;/^ESTAB/&#123;split($NF,ip,&quot;:&quot;);count[ip[1]]++&#125;END&#123;for(i in count)&#123;print i,count[i]&#125;&#125;&#x27; ss.log </span></span><br><span class="line">192.168.172.1 465</span><br></pre></td></tr></table></figure>

<h3 id="九、自定义函数"><a href="#九、自定义函数" class="headerlink" title="九、自定义函数"></a>九、自定义函数</h3><p>语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> name (parameter,parameter,...)&#123;</span><br><span class="line">            statements</span><br><span class="line">            <span class="built_in">return</span> experssion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>awk函数定义方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat fun.awk </span></span><br><span class="line"><span class="comment">#!/bin/awk -f</span></span><br><span class="line"><span class="keyword">function</span> max(x,y)&#123;      <span class="comment">#x,y为行参</span></span><br><span class="line">	x&gt;y?var=x:var=y</span><br><span class="line">	<span class="built_in">return</span> var</span><br><span class="line">&#125;</span><br><span class="line">BEGIN&#123;<span class="built_in">print</span> max(a,b)&#125;   <span class="comment">#a,b为实参</span></span><br></pre></td></tr></table></figure>

<p>awk函数调用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -v a=40 -v b=50 -f fun.awk</span></span><br><span class="line">50</span><br><span class="line">[root@centos7 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h3 id="十、awk中调用shell命令"><a href="#十、awk中调用shell命令" class="headerlink" title="十、awk中调用shell命令"></a>十、awk中调用shell命令</h3><p>system命令：空格是awk中的字符串连接符，如果system中需要使用awk中的变量可以使用空格分隔，或者说除了awk的变量外其他一律用“”引用起来  </p>
<p>示例1：调用系统命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;system(hostname)&#125;&#x27;</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;system(&quot;hostname&quot;)&#125;&#x27;</span></span><br><span class="line">centos7.localdomain</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;system(&quot;echo hello&quot;)&#125;&#x27;</span></span><br><span class="line">hello</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk &#x27;BEGIN&#123;system(&quot;ls&quot;)&#125;&#x27;</span></span><br><span class="line">1.txt	    access.log	     f1.txt   initial-setup-ks.cfg  ss.log</span><br><span class="line">access_log  anaconda-ks.cfg  fun.awk  ss.lg		    test1</span><br><span class="line">[root@centos7 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>示例2：输出变量的方法 </p>
<p>调用双引号输出变量时，变量必须放在双引号外，如果放在双引号内，变量只会被当作字符输出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk -v var=hello &#x27;BEGIN&#123;system(&quot;echo var&quot;)&#125;&#x27;</span></span><br><span class="line">var</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk -v var=hello &#x27;BEGIN&#123;system(&quot;echo&quot;var)&#125;&#x27;   #echo后必须有空格</span></span><br><span class="line">sh: echohello: <span class="built_in">command</span> not found</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk -v var=hello &#x27;BEGIN&#123;system(&quot;echo&quot; var)&#125;&#x27;  #并且空格必须再双引号内</span></span><br><span class="line">sh: echohello: <span class="built_in">command</span> not found</span><br><span class="line">[root@centos7 ~]<span class="comment"># awk -v var=hello &#x27;BEGIN&#123;system(&quot;echo &quot;var)&#125;&#x27;</span></span><br><span class="line">hello</span><br></pre></td></tr></table></figure>

<h3 id="十一、awk脚本"><a href="#十一、awk脚本" class="headerlink" title="十一、awk脚本"></a>十一、awk脚本</h3><p>awk脚本格式：</p>
<ol>
<li><p>脚本后缀为.awk  </p>
</li>
<li><p>脚本首行加上#!/bin/awk -f  </p>
</li>
<li><p>给脚本添加执行权限  </p>
</li>
</ol>
<p>示例： </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat test.awk 查看脚本内容</span></span><br><span class="line"><span class="comment">#!/bin/awk -f</span></span><br><span class="line"><span class="comment">#this is test awk script</span></span><br><span class="line">&#123;<span class="keyword">if</span>(<span class="variable">$3</span>&gt;1000)<span class="built_in">print</span> <span class="variable">$1</span>,<span class="variable">$3</span>&#125;</span><br><span class="line">[root@centos7 ~]<span class="comment"># chmod +x test.awk </span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ./test.awk -F: /etc/passwd</span></span><br><span class="line">nfsnobody 65534</span><br></pre></td></tr></table></figure>

<h3 id="十二、向awk脚本传递参数"><a href="#十二、向awk脚本传递参数" class="headerlink" title="十二、向awk脚本传递参数"></a>十二、向awk脚本传递参数</h3><p>使用格式：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awkfile var=value var2=value2 ... inputfile</span><br></pre></td></tr></table></figure>

<p>注意：在BEGIN过程中不可用。直到首行输入完成以后，变量才可用。可以通过-v参数，让awk在执行BIGIN之前得到变量的值。命令行中每一个指定的变量都需要一个-v参数。  </p>
<p>示例：</p>
<p>创建一个脚本，此处以上一个脚本为例进行修改。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat test.awk      #查看脚本内容</span></span><br><span class="line"><span class="comment">#!/bin/awk -f</span></span><br><span class="line"><span class="comment">#this is test awk script</span></span><br><span class="line"><span class="variable">$3</span>&gt;=min &amp;&amp; <span class="variable">$3</span>&lt;=max&#123;<span class="built_in">print</span> <span class="variable">$1</span>,<span class="variable">$3</span>&#125;   ，j   <span class="comment">#其中min和max为位置参数，$1,$3表示awk所要扫描的文件中的字段。此处以/etc/passwd为例，就是对应的用户名和UID</span></span><br><span class="line"> </span><br><span class="line">[root@centos7 ~]<span class="comment"># ./test.awk -F: min=10 max=20 /etc/passwd  #找出uid再10-20之间的行</span></span><br><span class="line">operator 11</span><br><span class="line">games 12</span><br><span class="line">ftp 14</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>awk</tag>
      </tags>
  </entry>
  <entry>
    <title>文本三剑客之sed</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/%E6%96%87%E6%9C%AC%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/%E6%96%87%E6%9C%AC%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/</url>
    <content><![CDATA[<h2 id="文本三剑客之sed"><a href="#文本三剑客之sed" class="headerlink" title="文本三剑客之sed"></a>文本三剑客之sed</h2><p>sed是一种流编辑器，它一次处理一行内容。处理时，把当前处理的行存储在临时缓冲区中，称为“模式空间”（pattern space），接着用sed命令处理缓冲区中的内容，处理完成后，把缓冲区的内容送往屏幕。然后读入下行，执行下一个循环。如果没有使诸如‘D’的特殊命令，那会在两个循环之间清空模式空间，但不会清空保留空间。这样不断重复，直到文件末尾。文件内容并没有改变，除非你使用重定向存储输出。</p>
<span id="more"></span>


<h2 id="sed命令格式"><a href="#sed命令格式" class="headerlink" title="sed命令格式"></a>sed命令格式</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed [OPTION]... <span class="string">&#x27;script&#x27;</span> [input-file]...</span><br></pre></td></tr></table></figure>

<h3 id="sed命令的常用option"><a href="#sed命令的常用option" class="headerlink" title="sed命令的常用option"></a>sed命令的常用option</h3><table>
<thead>
<tr>
<th>option</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-n</td>
<td>不输出模式空间内容到屏幕，即不自动打印</td>
</tr>
<tr>
<td>-e</td>
<td>多点编辑</td>
</tr>
<tr>
<td>-f /PATH/SCRIPT_FILE</td>
<td>从指定文件中读取编辑脚本</td>
</tr>
<tr>
<td>-r</td>
<td>支持扩展正则表达式</td>
</tr>
<tr>
<td>-i.xxx</td>
<td>备份源文件并编辑，xxx可以时任意字符为源文件备份的后缀</td>
</tr>
</tbody></table>
<h3 id="script部分"><a href="#script部分" class="headerlink" title="script部分"></a>script部分</h3><p>sed的scripte部分由地址定界+编辑命令组成</p>
<h4 id="地址定界"><a href="#地址定界" class="headerlink" title="地址定界"></a>地址定界</h4><table>
<thead>
<tr>
<th>地址定界</th>
<th>example</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>不给地址</td>
<td>空</td>
<td>对全文进行处理</td>
</tr>
<tr>
<td>单地址</td>
<td>#</td>
<td>指定的行（#表示数字）</td>
</tr>
<tr>
<td></td>
<td>$</td>
<td>最后一行</td>
</tr>
<tr>
<td></td>
<td>/pattern/</td>
<td>被此模式匹配到的行</td>
</tr>
<tr>
<td>地址范围</td>
<td>#,#</td>
<td>从第几行到第几行（#为数字）</td>
</tr>
<tr>
<td></td>
<td>#,+#</td>
<td>从第几行开始往后+多少行</td>
</tr>
<tr>
<td></td>
<td>/pat1/,/pat2/</td>
<td>从被第一个模式匹配到的行开始到被第二个模式匹配到的行结束</td>
</tr>
<tr>
<td></td>
<td>#,/pat1/</td>
<td>还支持指定行和模式的混用，从第几行开始到模式匹配到的行结束</td>
</tr>
<tr>
<td>~:步进</td>
<td>1~2</td>
<td>奇数行，从第一行开始步进2</td>
</tr>
<tr>
<td></td>
<td>2~2</td>
<td>偶数行，从第二行开始步进1</td>
</tr>
</tbody></table>
<h4 id="编辑命令"><a href="#编辑命令" class="headerlink" title="编辑命令"></a>编辑命令</h4><table>
<thead>
<tr>
<th>编辑命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>d</td>
<td>删除模式空间匹配的行，并立即启用下一轮循环</td>
</tr>
<tr>
<td>p</td>
<td>打印当前模式空间内容，追加到默认输出之后</td>
</tr>
<tr>
<td>a[\]text</td>
<td>在指定行后面追加文本，支持使用\n实现多行追加</td>
</tr>
<tr>
<td>i[\]text</td>
<td>在行前面插入文本</td>
</tr>
<tr>
<td>c[\]text</td>
<td>替换行为单行或多行文本</td>
</tr>
<tr>
<td>w /path/file</td>
<td>保存模式匹配的行至指定文件</td>
</tr>
<tr>
<td>r /path/file</td>
<td>读取指定文件的文本至模式空间中匹配到的行后</td>
</tr>
<tr>
<td>=</td>
<td>为模式空间中的行打印行号</td>
</tr>
<tr>
<td>!</td>
<td>模式空间中匹配行取反处理</td>
</tr>
</tbody></table>
<h4 id="搜索替代"><a href="#搜索替代" class="headerlink" title="搜索替代"></a>搜索替代</h4><table>
<thead>
<tr>
<th>编辑命令</th>
<th>替换标记</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>s///</td>
<td></td>
<td>查找替换,支持使用其它分隔符，s@@@，s###</td>
</tr>
<tr>
<td></td>
<td>g</td>
<td>行内全局替换</td>
</tr>
<tr>
<td></td>
<td>p</td>
<td>显示替换成功的行</td>
</tr>
<tr>
<td></td>
<td>w /PATH/TO/FILE</td>
<td>将替换成功的行保存至文件中</td>
</tr>
</tbody></table>
<h2 id="sed-的使用"><a href="#sed-的使用" class="headerlink" title="sed 的使用"></a>sed 的使用</h2><h3 id="sed-地址定界使用方法"><a href="#sed-地址定界使用方法" class="headerlink" title="sed 地址定界使用方法"></a>sed 地址定界使用方法</h3><p>1.sed命令默认输出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#sed命令会将读取到模式空间中的内容自动打印，此功能可以使用-n关闭</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed &#x27;&#x27; /etc/issue</span></span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># sed -n &#x27;&#x27; /etc/issue	#使用-n将其关闭，此时没有指定地址边界和编辑命令所以没有输出</span></span><br><span class="line">[root@localhost ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>2.sed的编辑命令p</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用编辑命令p将内容打印</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed &#x27;p&#x27; /etc/issue</span></span><br><span class="line">\S</span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br><span class="line">Kernel \r on an \m</span><br><span class="line"></span><br><span class="line"><span class="comment">#由于没有将模式空间内的自动打印关闭，当使用编辑命令p时又将内容打印了一遍，将模式空间的自动答应关闭</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed -n &#x27;p&#x27; /etc/issue</span></span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br><span class="line"></span><br><span class="line"><span class="comment">#现在输出的行没有重复的了，由于没有指定地址边界默认打印全部的行</span></span><br></pre></td></tr></table></figure>

<p>3.对行做过滤，可以使用行号加上编辑命令p将其打印</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#打印/etc/passwd的第10行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed -n &#x27;10p&#x27; /etc/passwd</span></span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br><span class="line"><span class="comment">#验证下，使用head和tail来过滤出第10行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># head -10 /etc/passwd |tail -1</span></span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br></pre></td></tr></table></figure>

<p>4.使用模式匹配来指定行进行打印</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#将/etc/fstab中以#开头的行打印出来</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed -n &#x27;/^#/p&#x27; /etc/fstab </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line"><span class="comment"># Created by anaconda on Tue Jul  2 18:57:58 2019</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;</span></span><br><span class="line"><span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>5.sed接收标准输入的内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#过滤出df命令中以/dev/sd开头的行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># df | sed -n &#x27;/^\/dev\/sd/p&#x27;</span></span><br><span class="line">/dev/sda1                 1038336  148728    889608  15% /boot</span><br></pre></td></tr></table></figure>

<p>6.使用$可以取出文件的最后一行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#取出/etc/passwd中的最后一行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed -n &#x27;$p&#x27; /etc/passwd</span></span><br><span class="line">wang:x:1008:1008::/home/wang:/bin/bash</span><br></pre></td></tr></table></figure>

<p>7.使用”!”可以对匹配条件进行取反</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#取出/etc/issue中非第一行的内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed -n &#x27;1!p&#x27; /etc/issue</span></span><br><span class="line">Kernel \r on an \m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>8.sed行范围匹配</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#找出/etc/fstab中a开头的行到s开头的行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed -n &#x27;/^a/,/^s/p&#x27; /etc/passwd</span></span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class="line">sync:x:5:0:sync:/sbin:/bin/sync</span><br></pre></td></tr></table></figure>

<p>9.步进的用法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#打印出单数行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># seq 10 | sed -n &#x27;1~2p&#x27;</span></span><br><span class="line">1</span><br><span class="line">3</span><br><span class="line">5</span><br><span class="line">7</span><br><span class="line">9</span><br><span class="line"><span class="comment">#打印出双数行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># seq 10 | sed -n &#x27;2~2p&#x27;</span></span><br><span class="line">2</span><br><span class="line">4</span><br><span class="line">6</span><br><span class="line">8</span><br><span class="line">10</span><br></pre></td></tr></table></figure>

<h3 id="sed的编辑命令使用"><a href="#sed的编辑命令使用" class="headerlink" title="sed的编辑命令使用"></a>sed的编辑命令使用</h3><p>1.删除d的使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#打印出/etc/fstab中所有非#开头的行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed &#x27;/^#/d&#x27; /etc/fstab</span></span><br><span class="line"></span><br><span class="line">/dev/mapper/centos-root /                       xfs     defaults        0 0</span><br><span class="line">UUID=b6396a3a-ccd8-444b-867b-1865c9ebc982 /boot                   xfs     defaults        0 0</span><br></pre></td></tr></table></figure>

<p>2.追加a，在某行之后追加内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#对/etc/fstab中所有#开头的行后面追加横线</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed &#x27;/^#/a-------&#x27; /etc/fstab</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">-------</span><br><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line">-------</span><br><span class="line"><span class="comment"># Created by anaconda on Tue Jul  2 18:57:58 2019</span></span><br><span class="line">-------</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">-------</span><br><span class="line"><span class="comment"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;</span></span><br><span class="line">-------</span><br><span class="line"><span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line">-------</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">-------</span><br><span class="line">/dev/mapper/centos-root /                       xfs     defaults        0 0</span><br><span class="line">UUID=b6396a3a-ccd8-444b-867b-1865c9ebc982 /boot                   xfs     defaults        0 0</span><br></pre></td></tr></table></figure>

<p>3.使用sed添加变量和命令的用法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用sed追加的内容为变量时需要使用3个单引号将其括起来</span></span><br><span class="line">[root@localhost ~]<span class="comment"># seq 3 | sed &#x27;a\&#x27;&#x27;&#x27;$USER&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">1</span><br><span class="line">root</span><br><span class="line">2</span><br><span class="line">root</span><br><span class="line">3</span><br><span class="line">root</span><br><span class="line"><span class="comment">#和使用变量相同使用3个单引号将命令包起来，再使用反向单引号将要执行的命令放在中间</span></span><br><span class="line">[root@localhost ~]<span class="comment"># seq 3 | sed &#x27;a\&#x27;&#x27;&#x27;`hostname`&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">1</span><br><span class="line">localhost.localdomain</span><br><span class="line">2</span><br><span class="line">localhost.localdomain</span><br><span class="line">3</span><br><span class="line">localhost.localdomain</span><br></pre></td></tr></table></figure>

<p>4.在匹配的行之间插入内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># seq 3 | sed &#x27;i\abc&#x27;</span></span><br><span class="line">abc</span><br><span class="line">1</span><br><span class="line">abc</span><br><span class="line">2</span><br><span class="line">abc</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>5.将指定的行进行替换</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># seq 3 | sed &#x27;c\abc&#x27;</span></span><br><span class="line">abc</span><br><span class="line">abc</span><br><span class="line">abc</span><br></pre></td></tr></table></figure>

<p>6.将满足条件的行存放到某文件中，使用w /PATH/TO/FILE</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># seq 10 | sed -n &#x27;3,6w /data/seq&#x27;	#将第3-6行存放到文件内</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /data/seq 		#验证下</span></span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td></tr></table></figure>

<p>7.将文件内容读入到匹配的行后</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#读取/etc/issue放到每行后面</span></span><br><span class="line">[root@localhost ~]<span class="comment"># seq 3 | sed &#x27;r /etc/issue&#x27;</span></span><br><span class="line">1</span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br><span class="line"></span><br><span class="line">3</span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>8.在每行之前打印出行号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># sed &#x27;=&#x27; /etc/issue</span></span><br><span class="line">1</span><br><span class="line">\S</span><br><span class="line">2</span><br><span class="line">Kernel \r on an \m</span><br><span class="line">3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="搜索替换的使用"><a href="#搜索替换的使用" class="headerlink" title="搜索替换的使用"></a>搜索替换的使用</h3><p>1.后向引用在搜索替代中的使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#搜索替代中使用到正则表达式时需要使用-r</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo abc | sed -r &#x27;s/(a)bc/\1/&#x27;</span></span><br><span class="line">a</span><br><span class="line">[root@localhost ~]<span class="comment"># echo abc | sed -r &#x27;s/((a)bc)/\1/&#x27;</span></span><br><span class="line">abc</span><br><span class="line">[root@localhost ~]<span class="comment"># echo abc | sed -r &#x27;s/((a)bc)/\2/&#x27;</span></span><br><span class="line">a</span><br></pre></td></tr></table></figure>

<p>2.在/etc/default/grub中net.ifnames=0的最后插入字符</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># sed -r &#x27;6s/(.*)&quot;$/\1 abc&quot;/&#x27; /etc/default/grub </span></span><br><span class="line">GRUB_TIMEOUT=5</span><br><span class="line">GRUB_DISTRIBUTOR=<span class="string">&quot;<span class="subst">$(sed &#x27;s, release .*$,,g&#x27; /etc/system-release)</span>&quot;</span></span><br><span class="line">GRUB_DEFAULT=saved</span><br><span class="line">GRUB_DISABLE_SUBMENU=<span class="literal">true</span></span><br><span class="line">GRUB_TERMINAL_OUTPUT=<span class="string">&quot;console&quot;</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;crashkernel=auto rd.lvm.lv=centos/root biosdevname=0 net.ifnames=0 abc&quot;</span></span><br><span class="line">GRUB_DISABLE_RECOVERY=<span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<p>3.取出/etc/sysconfig/network-scripts/中的基名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># echo /etc/sysconfig/network-scripts/ | sed -r &#x27;s@(.*/)[^/]+/?$@\1@&#x27;</span></span><br><span class="line">/etc/sysconfig/</span><br></pre></td></tr></table></figure>

<p>4.使用sed取出网卡地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ifconfig eth0 | sed -nr &#x27;2s/[^0-9]+([0-9.]+).*/\1/p&#x27;</span></span><br><span class="line">192.168.27.20</span><br></pre></td></tr></table></figure>





]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>时间服务和chrony</title>
    <url>/2019/03/13/Linux%E5%9F%BA%E7%A1%80/%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5/%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5%E5%92%8Cchrony/</url>
    <content><![CDATA[<h2 id="时间服务和chrony"><a href="#时间服务和chrony" class="headerlink" title="时间服务和chrony"></a>时间服务和chrony</h2><p>多主机协作工作时，各个主机的时间同步很总要，时间不一致会造成很多重要应用的故障，如：加密协议，日志，集群等，利用NTP协议使网络中的各个计算机时间达到同步。目前NTP协议属于运维基础架构中必备的基本服务之一。</p>
<span id="more"></span>

<h3 id="时间同步实现：ntp-chrony"><a href="#时间同步实现：ntp-chrony" class="headerlink" title="时间同步实现：ntp,chrony"></a>时间同步实现：ntp,chrony</h3><p>ntp将系统时间和世界协调时UTC同步，精度在局域网内可达到0.1ms，在互联网上绝大多数的地方精度可以达到1-50ms。目前CentOS6上所使用的就是ntp服务。</p>
<p>chrony为CentOS7上所使用的时间服务，其同步的速度比ntp更快。</p>
<hr>
<h2 id="ntp服务的部署"><a href="#ntp服务的部署" class="headerlink" title="ntp服务的部署"></a>ntp服务的部署</h2><p>主机A从互联网上的主机同步时间并作为局域网内的时间服务器使用，主机B自动去向主机A同步时间</p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>准备A、B、两台主机</p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">系统</th>
<th align="left">ip</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">CentOS6</td>
<td align="left">192.168.73.137</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">CentOS6</td>
<td align="left">192.168.73.136</td>
</tr>
</tbody></table>
<p>将主机B的时间调慢</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostB ~]<span class="comment"># date -s &quot;-10 days&quot;</span></span><br><span class="line">Sun Apr  7 10:50:51 CST 2019</span><br><span class="line">[root@HostB ~]<span class="comment"># date</span></span><br><span class="line">Sun Apr  7 10:50:58 CST 2019</span><br></pre></td></tr></table></figure>

<p>查看下主机A时间</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># date</span></span><br><span class="line">Wed Apr 17 10:53:35 CST 2019</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="配置ntp服务"><a href="#配置ntp服务" class="headerlink" title="配置ntp服务"></a>配置ntp服务</h3><h4 id="一、将主机A设置为时间服务器"><a href="#一、将主机A设置为时间服务器" class="headerlink" title="一、将主机A设置为时间服务器"></a>一、将主机A设置为时间服务器</h4><p>1.修改/etc/ntp</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># vim /etc/ntp.conf </span></span><br><span class="line">...</span><br><span class="line"><span class="comment">#restrict default kod nomodify notrap nopeer noquery        #将文件中的此行注释，或者修改为下面行</span></span><br><span class="line">restrict default kod nomodify                               </span><br><span class="line">...</span><br><span class="line"><span class="comment">#server 0.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 3.centos.pool.ntp.org iburst</span></span><br><span class="line">server 172.22.0.1 iburst                                    <span class="comment">#将时间服务器指向外部的时间服务器。</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>2.将主机A与外网的时间服务器同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># ntpdate 172.22.0.1</span></span><br><span class="line">18 Apr 10:27:53 ntpdate[3825]: adjust time server 172.22.0.1 offset 0.004437 sec</span><br></pre></td></tr></table></figure>

<p>3.启动ntp服务，将ntp服务设置为开机启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostA ~]<span class="comment"># service ntpd start</span></span><br><span class="line">Starting ntpd:                                             [  OK  ]</span><br><span class="line">[root@HostA ~]<span class="comment"># chkconfig ntpd on</span></span><br></pre></td></tr></table></figure>

<h4 id="二、修改主机B配置文件修改为自动和主机A同步时间"><a href="#二、修改主机B配置文件修改为自动和主机A同步时间" class="headerlink" title="二、修改主机B配置文件修改为自动和主机A同步时间"></a>二、修改主机B配置文件修改为自动和主机A同步时间</h4><p>1.修改配置文件，将时间服务器指向主机A</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#server 0.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 3.centos.pool.ntp.org iburst</span></span><br><span class="line">server 192.168.73.140 iburst                                <span class="comment">#添加此行</span></span><br></pre></td></tr></table></figure>

<p>2.启动服务。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@HostB ~]<span class="comment"># service ntpd start</span></span><br><span class="line">Starting ntpd:                                             [  OK  ]</span><br><span class="line">[root@HostB ~]<span class="comment"># date                                        #由于ntp服务同步速度较慢，需要很长一段时间才能同步使劲按</span></span><br><span class="line">Mon Apr  8 10:34:43 CST 2019</span><br><span class="line">[root@HostB ~]<span class="comment"># service ntpd restart</span></span><br><span class="line">Shutting down ntpd:                                        [  OK  ]</span><br><span class="line">Starting ntpd:                                             [  OK  ]</span><br><span class="line">[root@HostB ~]<span class="comment"># date                                        #再次重启服务，此时时间已经自动同步。</span></span><br><span class="line">Thu Apr 18 10:34:54 CST 2019</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="chrony的部署"><a href="#chrony的部署" class="headerlink" title="chrony的部署"></a>chrony的部署</h2><p>此处以刚才配置的主机A为互联网中的时间服务器，主机7A从主机A同步时间并作为局域网内的时间服务器使用，主机7B自动去向主机7A同步时间</p>
<h3 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h3><p>准备7A、7B、两台主机</p>
<table>
<thead>
<tr>
<th align="left">主机名</th>
<th align="left">系统</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">7A</td>
<td align="left">CentOS7</td>
<td align="left">192.168.73.150</td>
</tr>
<tr>
<td align="left">7B</td>
<td align="left">CentOS7</td>
<td align="left">192.168.73.139</td>
</tr>
</tbody></table>
<h4 id="一、配置时间服务器"><a href="#一、配置时间服务器" class="headerlink" title="一、配置时间服务器"></a>一、配置时间服务器</h4><p>1.修改主机7A配置文件修改/etc/chrony.conf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@7a ~]<span class="comment"># vim /etc/chrony.conf</span></span><br><span class="line">...</span><br><span class="line">server 192.168.73.140 iburst    <span class="comment">#添加此行指向网络中的时间服务器</span></span><br><span class="line">...</span><br><span class="line">allow 192.168.73.0/24           <span class="comment">#添加当自己为时间服务器时允许访问的网段</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">local</span> stratum 10                <span class="comment">#此行前的注释去掉</span></span><br></pre></td></tr></table></figure>

<p>2.启动chronyd服务，并设置为开机启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@7a ~]<span class="comment"># systemctl start chronyd.service</span></span><br><span class="line">[root@7a ~]<span class="comment"># systemctl enable chronyd.service</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/chronyd.service to /usr/lib/systemd/system/chronyd.service.</span><br></pre></td></tr></table></figure>

<h4 id="二、配置局域网中的服务器，将时间服务器指向为7A"><a href="#二、配置局域网中的服务器，将时间服务器指向为7A" class="headerlink" title="二、配置局域网中的服务器，将时间服务器指向为7A"></a>二、配置局域网中的服务器，将时间服务器指向为7A</h4><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@7b ~]<span class="comment"># vim /etc/chrony.conf </span></span><br><span class="line"><span class="comment">#server 0.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment">#server 3.centos.pool.ntp.org iburst</span></span><br><span class="line">server 192.168.73.150 iburst                <span class="comment">#添加此行</span></span><br></pre></td></tr></table></figure>

<p>2.启动chrony服务，并设置为开机自动启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@7b ~]<span class="comment"># systemctl start chronyd</span></span><br><span class="line">[root@7b ~]<span class="comment"># systemctl enable chronyd</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/chronyd.service to /usr/lib/systemd/system/chronyd.service.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.查看时间同步情况</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@7b ~]<span class="comment"># chronyc sources</span></span><br><span class="line">210 Number of sources = 1</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample               </span><br><span class="line">===============================================================================</span><br><span class="line">^* 192.168.73.150                5   6   177    31    +50us[  +77us] +/-  218ms</span><br><span class="line">[root@7b ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>标准I/O和管道</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/%E6%A0%87%E5%87%86IO%E5%92%8C%E7%AE%A1%E9%81%93/%E6%A0%87%E5%87%86IO%E5%92%8C%E7%AE%A1%E9%81%93/</url>
    <content><![CDATA[<h2 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h2><p>在linux系统里每打开一个文件，就会响应开启一个文件描述符(fd)。</p>
<span id="more"></span>

<p>文件描述符的具体位置：</p>
<p>打开/var/log/message</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># tail -f /var/log/messages </span></span><br><span class="line">Mar 11 20:37:36 centos7 NetworkManager[6246]: &lt;info&gt;  [1552307856.6123] dhcp4 (ens33):   nameserver <span class="string">&#x27;192.168.172.1&#x27;</span></span><br><span class="line">Mar 11 20:37:36 centos7 NetworkManager[6246]: &lt;info&gt;  [1552307856.6123] dhcp4 (ens33):   domain name <span class="string">&#x27;localdomain&#x27;</span></span><br><span class="line">Mar 11 20:37:36 centos7 NetworkManager[6246]: &lt;info&gt;  [1552307856.6123] dhcp4 (ens33): state changed bound -&gt; bound</span><br><span class="line">Mar 11 20:37:36 centos7 dbus[6238]: [system] Activating via systemd: service name=<span class="string">&#x27;org.freedesktop.nm_dispatcher&#x27;</span> unit=<span class="string">&#x27;dbus-org.freedesktop.nm-dispatcher.service&#x27;</span></span><br><span class="line">Mar 11 20:37:36 centos7 dhclient[19931]: bound to 192.168.172.136 -- renewal <span class="keyword">in</span> 791 seconds.</span><br></pre></td></tr></table></figure>

<p>另起一个终端，在/proc中找到tail相对应的进程，进入fd目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 21099]<span class="comment"># cd /proc/`pidof tail`/fd</span></span><br><span class="line">[root@centos7 fd]<span class="comment"># ll</span></span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Mar 11 20:42 0 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Mar 11 20:42 1 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Mar 11 20:42 2 -&gt; /dev/pts/0</span><br><span class="line">lr-x------ 1 root root 64 Mar 11 20:42 3 -&gt; /var/<span class="built_in">log</span>/messages   <span class="comment">#此为打开的文件，3就是文件描述符</span></span><br><span class="line">lr-x------ 1 root root 64 Mar 11 20:42 4 -&gt; anon_inode:inotify</span><br></pre></td></tr></table></figure>

<p>在Linux中有3个标准的I/O描述符</p>
<p>0:标准输入：键盘输入，也可用文件输入</p>
<p>1:标准输出：默认输出当前端口，也可通过重定向输出至文件或其他终端。</p>
<p>2:错误输出：默认输出当前端口，也可通过重定向输出至文件或其他终端。</p>
<hr>
<h2 id="标准输出重定向：-gt"><a href="#标准输出重定向：-gt" class="headerlink" title="标准输出重定向： &gt;"></a>标准输出重定向： &gt;</h2><p>标准输出重定向是将要输出到当前tty的内容重新输出到其他的位置，重定向的位置可以是一个文件也可以是其他的tty。</p>
<p>需要注意的是标准输出重定向”&gt;”在输出内容时会覆盖文件内的内容。如果要对某文件进行追加内容，则需使用”&gt;&gt;”将输出重定向到文件内。</p>
<h3 id="标准输出的一些使用方法："><a href="#标准输出的一些使用方法：" class="headerlink" title="标准输出的一些使用方法："></a>标准输出的一些使用方法：</h3><h4 id="使用标准输出清空文件"><a href="#使用标准输出清空文件" class="headerlink" title="使用标准输出清空文件"></a>使用标准输出清空文件</h4><p>使用标准输出清空文件有两种方法：</p>
<p>1.使用/dev/null清空文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#当前目录下有个list的文件，大小为24b</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ll list.txt</span></span><br><span class="line">-rw-r--r-- 1 root root 24 Mar 11 20:58 list.txt</span><br><span class="line"><span class="comment">#使用/dev/null对list文件做重定向后再次观察</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat /dev/null &gt; list.txt</span></span><br><span class="line"><span class="comment">#文件的内容被清空，/dev下的null为Linux系统中的黑洞，可以回收任何东西。</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ll list.txt</span></span><br><span class="line">-rw-r--r-- 1 root root 0 Mar 11 20:59 list.txt</span><br></pre></td></tr></table></figure>
<p>2.直接使用重定向”&gt;”清空文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># ll list.txt </span></span><br><span class="line">-rw-r--r-- 1 root root 24 Mar 11 21:02 list.txt</span><br><span class="line">[root@centos7 data]<span class="comment"># &gt; list.txt     #次命令相当于echo了一个空字符重定向到了一个文件内</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ll list.txt</span></span><br><span class="line">-rw-r--r-- 1 root root 0 Mar 11 21:02 list.txt</span><br></pre></td></tr></table></figure>
<p>注意：使用此方法清空文件时，在某些shell中不支持</p>
<h4 id="使用标准输出创建文件"><a href="#使用标准输出创建文件" class="headerlink" title="使用标准输出创建文件"></a>使用标准输出创建文件</h4><p>标准输出可以创建空文件，实现方法如下：<br>1.使用&gt;来创建文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># ls		#当前目录为空目录</span></span><br><span class="line">[root@centos7 data]<span class="comment"># &gt; test</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ll</span></span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar 11 21:15 <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h4 id="“-gt-”和”-gt-gt-”的区别"><a href="#“-gt-”和”-gt-gt-”的区别" class="headerlink" title="“&gt;”和”&gt;&gt;”的区别"></a>“&gt;”和”&gt;&gt;”的区别</h4><p>由于用&gt;创建文件时，如果文件存在则会清空文件，为防止误操作，所以使用&gt;&gt;来创建空文件，此时即使文件存在也不会被覆盖，只会在文件后追加空行。</p>
<p>1.使用”&gt;&gt;”创建空文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># &gt;&gt; test</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ll test</span></span><br><span class="line">-rw-r--r-- 1 root root 0 Mar 11 21:24 <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<p>2.重定向创建文件时，若文件存在：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># ll test </span></span><br><span class="line">-rw-r--r-- 1 root root 17 Mar 11 21:28 <span class="built_in">test</span></span><br><span class="line">[root@centos7 data]<span class="comment"># &gt; test</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ll test</span></span><br><span class="line">-rw-r--r-- 1 root root 0 Mar 11 21:28 <span class="built_in">test</span>   <span class="comment">#文件被清空</span></span><br></pre></td></tr></table></figure>

<p>若要在使用标准输出时，文件不被覆盖可以使用以下设置</p>
<p>1.set -C ：无法覆盖，但可以追加。但使用&gt;|符号时扔可强制覆盖</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># set -C</span></span><br><span class="line">[root@centos7 data]<span class="comment"># echo &quot;hello word&quot; &gt; test       </span></span><br><span class="line">-bash: <span class="built_in">test</span>: cannot overwrite existing file         <span class="comment">#无法覆盖</span></span><br><span class="line">[root@centos7 data]<span class="comment"># echo &quot;hello word&quot; &gt;| test      #强制覆盖</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat test</span></span><br><span class="line">hello word</span><br><span class="line">[root@centos7 data]<span class="comment"># echo &quot;hello word&quot; &gt;&gt; test      #追加</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat test</span></span><br><span class="line">hello word</span><br><span class="line">hello word</span><br></pre></td></tr></table></figure>

<p>2.set +C ：可以覆盖。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># echo &quot;hi&quot; &gt; test</span></span><br><span class="line">-bash: <span class="built_in">test</span>: cannot overwrite existing file</span><br><span class="line">[root@centos7 data]<span class="comment"># set +C</span></span><br><span class="line">[root@centos7 data]<span class="comment"># echo hi &gt; test</span></span><br><span class="line">[root@centos7 data]<span class="comment"># echo test</span></span><br><span class="line"><span class="built_in">test</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="标准错误重定向：2-gt"><a href="#标准错误重定向：2-gt" class="headerlink" title="标准错误重定向：2&gt;"></a>标准错误重定向：2&gt;</h2><p>在文件描述符中2表示标准错误输出，所以错误重定向为：”2&gt;”</p>
<h3 id="错误重定向使用方法"><a href="#错误重定向使用方法" class="headerlink" title="错误重定向使用方法"></a>错误重定向使用方法</h3><p>先演示下标准的错误输出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># ls /error		#使用ls查看根目录下的error目录，但根目录下没有error这个目录，所以报错了</span></span><br><span class="line">ls: cannot access /error: No such file or directory		<span class="comment">#报错以标准输出的方式显示在了屏幕上</span></span><br></pre></td></tr></table></figure>
<p>使用错误重定向将错误信息输出到一个文件内</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># ls /error 2&gt; error.log  #这时候错误没有输出在屏幕上</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat  error.log			#查看下文件内的内容 </span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="标准输出和错误输出合并重定向"><a href="#标准输出和错误输出合并重定向" class="headerlink" title="标准输出和错误输出合并重定向"></a>标准输出和错误输出合并重定向</h2><p>将标准输出和错误输出合并后重定向到一个文件内的方法</p>
<h3 id="方法1："><a href="#方法1：" class="headerlink" title="方法1："></a>方法1：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">right error &gt; /path/to/file 2&gt;&amp;1</span><br><span class="line"><span class="comment">#把标准输出输出到file，再把错误输出的转变为标准输出一起输出到file</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 /]<span class="comment"># ls /data /error  &gt; /data/test 2&gt;&amp;1 </span></span><br><span class="line">[root@centos7 /]<span class="comment"># cat /data/test</span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br><span class="line">/data:</span><br><span class="line">right</span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h3 id="方法2："><a href="#方法2：" class="headerlink" title="方法2："></a>方法2：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">right error 2&gt; /path/to/file &gt;&amp;2</span><br><span class="line"><span class="comment">#把错误输出输出到file，再把标准输出转变为错误输出一起输出到file</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 /]<span class="comment"># ls /data /error  2&gt; /data/test &gt;&amp;2 </span></span><br><span class="line">[root@centos7 /]<span class="comment"># cat /data/test </span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br><span class="line">/data:</span><br><span class="line">right</span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h3 id="方法3："><a href="#方法3：" class="headerlink" title="方法3："></a>方法3：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">right error &amp;&gt; /path/to/file</span><br><span class="line"><span class="comment">#把正确的输出和错误的输出一起输出到 file</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 /]<span class="comment"># ls /data /error  &amp;&gt; /data/test</span></span><br><span class="line">[root@centos7 /]<span class="comment"># cat /data/test </span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br><span class="line">/data:</span><br><span class="line">right</span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h3 id="方法4："><a href="#方法4：" class="headerlink" title="方法4："></a>方法4：</h3><p>多条命令的执行结果存入一个文件内需要使用()</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># (hostname;uname -r) &gt; file2</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat file2</span></span><br><span class="line">centos7.localdomain</span><br><span class="line">3.10.0-957.el7.x86_64</span><br></pre></td></tr></table></figure>

<p>所以以下写法也能实现合并正确和错误输出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(right error 2&gt;&amp;1)&gt; /path/to/file</span><br><span class="line"><span class="comment">#将错误输出转换为正确的一起输出至file</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># (ls /data /error 2&gt;&amp;1) &gt; /data/file</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat /data/file</span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br><span class="line">/data:</span><br><span class="line">file</span><br></pre></td></tr></table></figure>
<h3 id="方法5："><a href="#方法5：" class="headerlink" title="方法5："></a>方法5：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(right error &gt;&amp;2) 2&gt; /path/to/file</span><br><span class="line"><span class="comment">#将正确输出转换为错误的一同输出至file</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># (ls /data /error &gt;&amp;2) 2&gt; /data/file</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat /data/file </span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br><span class="line">/data:</span><br><span class="line">file</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="单行重定向和多行重定向"><a href="#单行重定向和多行重定向" class="headerlink" title="单行重定向和多行重定向"></a>单行重定向和多行重定向</h2><h4 id="单行重定向"><a href="#单行重定向" class="headerlink" title="单行重定向"></a>单行重定向</h4><p>单行重定向是将内容逐行传输给一个文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; file</span><br></pre></td></tr></table></figure>

<h4 id="多行重定向"><a href="#多行重定向" class="headerlink" title="多行重定向"></a>多行重定向</h4><p>多行重定向是先输入每一行的内容然后一起定向到一个文件内</p>
<p>cat &lt;&lt; eof &gt; file 其中eof为文件结束符</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat &lt;&lt; eof &gt; file1</span></span><br><span class="line">&gt; hello word</span><br><span class="line">&gt; <span class="variable">$HOSTNAME</span></span><br><span class="line">&gt; eof</span><br><span class="line">[root@centos7 ~]<span class="comment"># cat file1</span></span><br><span class="line">hello word</span><br><span class="line">centos7.localdomain</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="管道"><a href="#管道" class="headerlink" title="管道 |"></a>管道 |</h2><p>管道就是将前一项命令的结果当作后一项命令的输入</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#将echo输出abc传送给后一条命令进行大小写的转换</span></span><br><span class="line">[root@centos7 data]<span class="comment"># echo abc | tr a-z A-Z</span></span><br><span class="line">ABC</span><br></pre></td></tr></table></figure>

<p>管道无法实现将错误命令结果也传递到后一项命令中要实现的话需要使用|&amp;符号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># asdf sdf | tr a-z A-Z</span></span><br><span class="line">bash: asdf: <span class="built_in">command</span> not found...</span><br><span class="line">Similar <span class="built_in">command</span> is: <span class="string">&#x27;sadf&#x27;</span></span><br><span class="line">[root@centos7 data]<span class="comment"># asdf sdf |&amp; tr a-z A-Z</span></span><br><span class="line">BASH: ASDF: COMMAND NOT FOUND...</span><br><span class="line">SIMILAR COMMAND IS: <span class="string">&#x27;SADF&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="Tee命令："><a href="#Tee命令：" class="headerlink" title="Tee命令："></a>Tee命令：</h4><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tee [OPTION]... [FILE]...</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>从标准输入读取数据分别输出至标准输出和文件中</p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-a</td>
<td align="left">追加</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>1.将输出分别输出到标准输出和文件中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># echo &#123;a..d&#125; | tee test</span></span><br><span class="line">a b c d				<span class="comment">#标准输出的内容</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat test</span></span><br><span class="line">a b c d				<span class="comment">#文件中的内容</span></span><br></pre></td></tr></table></figure>

<p>2.tee命令默认在输出结果保存至文件中是会覆盖上一次的内容可以使用-a进行追加操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 data]<span class="comment"># cat test</span></span><br><span class="line">a b c d				<span class="comment">#当前文件中的内容为abcd</span></span><br><span class="line">[root@centos7 data]<span class="comment"># echo &#123;1..3&#125; | tee test</span></span><br><span class="line">1 2 3				<span class="comment">#再次输出一个123</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat test</span></span><br><span class="line">1 2 3				<span class="comment">#再次查看文件中原先的abcd被覆盖</span></span><br><span class="line">[root@centos7 data]<span class="comment"># echo &#123;a..d&#125; | tee -a test</span></span><br><span class="line">a b c d				<span class="comment">#使用-a选项在文件中追加内容</span></span><br><span class="line">[root@centos7 data]<span class="comment"># cat test</span></span><br><span class="line">1 2 3				<span class="comment">#文件中的123和abcd全部被保留下来</span></span><br><span class="line">a b c d</span><br></pre></td></tr></table></figure>

<h4 id="tr命令："><a href="#tr命令：" class="headerlink" title="tr命令："></a>tr命令：</h4><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tr [OPTION]... SET1 [SET2]</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>转换或删除字符</p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-t</td>
<td align="left">对位替换</td>
</tr>
<tr>
<td align="left">-d</td>
<td align="left">删除</td>
</tr>
<tr>
<td align="left">-c</td>
<td align="left">取反</td>
</tr>
<tr>
<td align="left">-s</td>
<td align="left">压缩</td>
</tr>
</tbody></table>
<p>示例:</p>
<p>1.当SET1比SET2位数多时，SET1最后一位自动替换SET2的最后一位</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tr &#x27;abcd&#x27; &#x27;123&#x27;</span></span><br><span class="line">abcdd</span><br><span class="line">12333</span><br></pre></td></tr></table></figure>

<p>2.要防止上述情况发生可以使用-t选项对位替换</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tr -t &#x27;abcd&#x27; &#x27;123&#x27;</span></span><br><span class="line">abcddd</span><br><span class="line">123ddd</span><br></pre></td></tr></table></figure>

<p>3.-d对被SET1匹配中的内容进行删除</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tr -d &#x27;abc&#x27;</span></span><br><span class="line">abcde</span><br><span class="line">de</span><br></pre></td></tr></table></figure>

<p>4.-c将除SET1以外的内容替换成SET2，在使用-c时需要用ctrl+d来执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tr -c &#x27;abc&#x27; &#x27;d&#x27;</span></span><br><span class="line">abcdefg</span><br><span class="line">abcddddd[root@centos7 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>配合-d可以实现删除除了SET1之外的字符</p>
<p>5.-s将连续且相同的字符压缩</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tr -s &#x27;abc&#x27;</span></span><br><span class="line">aaaaaaaaabbbbbbbccccccccdabd</span><br><span class="line">abcdabd</span><br></pre></td></tr></table></figure>

<p>6.在使用tr命令时还能使用通配符的方法进行替换</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># echo &quot;abcdef&quot; &gt; test</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># tr &#x27;[:lower:]&#x27; &#x27;[:upper:]&#x27; &lt; test</span></span><br><span class="line">ABCDEF</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>busybox</title>
    <url>/2019/03/08/Linux%E5%9F%BA%E7%A1%80/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85busybox/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85busybox/</url>
    <content><![CDATA[<h2 id="BusyBox"><a href="#BusyBox" class="headerlink" title="BusyBox"></a>BusyBox</h2><p>BusyBox 是一个集成了三百多个最常用Linux命令和工具的软件。BusyBox 包含了一些简单的工具，例如ls、cat和echo等等，还包含了一些更大、更复杂的工具，例grep、find、mount以及telnet。有些人将 BusyBox 称为 Linux 工具里的瑞士军刀。简单的说BusyBox就好像是个大工具箱，它集成压缩了 Linux 的许多工具和命令，也包含了 Android 系统的自带的shell。</p>
<span id="more"></span>

<h3 id="源码编译busybox"><a href="#源码编译busybox" class="headerlink" title="源码编译busybox"></a>源码编译busybox</h3><h4 id="一、下载源码包"><a href="#一、下载源码包" class="headerlink" title="一、下载源码包"></a>一、下载源码包</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># wget https://busybox.net/downloads/busybox-1.30.1.tar.bz2</span></span><br><span class="line">--2019-04-12 00:50:43--  https://busybox.net/downloads/busybox-1.30.1.tar.bz2</span><br><span class="line">Resolving busybox.net (busybox.net)...</span><br></pre></td></tr></table></figure>

<h4 id="二、解压源码包"><a href="#二、解压源码包" class="headerlink" title="二、解压源码包"></a>二、解压源码包</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tar xf busybox-1.30.1.tar.bz2 </span></span><br></pre></td></tr></table></figure>

<h4 id="三、进入busybox目录，执行make-menuconfig命令"><a href="#三、进入busybox目录，执行make-menuconfig命令" class="headerlink" title="三、进入busybox目录，执行make menuconfig命令"></a>三、进入busybox目录，执行make menuconfig命令</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cd busybox-1.30.1/</span></span><br><span class="line">[root@centos7 busybox-1.30.1]<span class="comment"># make menuconfig</span></span><br></pre></td></tr></table></figure>

<p>手动选择选择所需要的模块</p>
<p><img src="1.png" alt="1.png"></p>
<p><img src="2.png" alt="2.png"></p>
<p>保存退出，此时在此目录下多出了一个.config的文件，里面保存的为刚才的配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 busybox-1.30.1]<span class="comment"># l.</span></span><br><span class="line">.  ..  .config  .indent.pro  .kconfig.d  .kernelrelease</span><br></pre></td></tr></table></figure>

<h4 id="四、使用make生成二进制文件"><a href="#四、使用make生成二进制文件" class="headerlink" title="四、使用make生成二进制文件"></a>四、使用make生成二进制文件</h4><p>在使用前先安装相应的工具</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 busybox-1.30.1]<span class="comment"># yum install gcc gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel zlib-devel libmcrypt-devel glibc-static ncurses-devel -y</span></span><br></pre></td></tr></table></figure>

<p>使用make生成二进制文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 busybox-1.30.1]<span class="comment"># make</span></span><br></pre></td></tr></table></figure>

<h4 id="五、编译完成，测试"><a href="#五、编译完成，测试" class="headerlink" title="五、编译完成，测试"></a>五、编译完成，测试</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 busybox-1.30.1]<span class="comment"># ./busybox ls /</span></span><br><span class="line">bin    data   etc    lib    media  opt    root   sbin   sys    usr</span><br><span class="line">boot   dev    home   lib64  mnt    proc   run    srv    tmp    var</span><br></pre></td></tr></table></figure>

<h4 id="六、使用make-install"><a href="#六、使用make-install" class="headerlink" title="六、使用make install"></a>六、使用make install</h4><p>使用make install 生成一个_install文件夹，里面存放各种软链接，指向为busybox，将_install移走就能使用了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 busybox-1.30.1]<span class="comment"># make install</span></span><br></pre></td></tr></table></figure>

<h4 id="七、测试"><a href="#七、测试" class="headerlink" title="七、测试"></a>七、测试</h4><p>将_install移动至/data/rootfs，由于没有bash无法切根所以需要创建一个bash的软链接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 busybox-1.30.1]<span class="comment"># mv _install/ /data/rootfs</span></span><br><span class="line">[root@centos7 busybox-1.30.1]<span class="comment"># cd /data/rootfs</span></span><br><span class="line">[root@centos7 rootfs]<span class="comment"># cd bin/</span></span><br><span class="line">[root@centos7 bin]<span class="comment"># ln -s busybox ./bash</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>编译安装linux-5.07内核</title>
    <url>/2019/03/08/Linux%E5%9F%BA%E7%A1%80/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85linux%E5%86%85%E6%A0%B8/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%855.07%E5%86%85%E6%A0%B8/</url>
    <content><![CDATA[<h2 id="编译安装linux-5-07内核"><a href="#编译安装linux-5-07内核" class="headerlink" title="编译安装linux-5.07内核"></a>编译安装linux-5.07内核</h2><p>在生产环境中某些软件依赖于较新的内核，此时就需要将内核进行升级，以下为演示手动编译安装较新的5.07内核的方法。</p>
<span id="more"></span>

<h3 id="一、下载内核"><a href="#一、下载内核" class="headerlink" title="一、下载内核"></a>一、下载内核</h3><p>至内核官方网站下载内核<a href="http://www.kernel.org/">www.kernel.org</a></p>
<h3 id="二、解压内核文件"><a href="#二、解压内核文件" class="headerlink" title="二、解压内核文件"></a>二、解压内核文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tar xf linux-5.0.7.tar.xz </span></span><br></pre></td></tr></table></figure>

<h3 id="三、准备-config文件"><a href="#三、准备-config文件" class="headerlink" title="三、准备.config文件"></a>三、准备.config文件</h3><p>由于内核编译需要依靠.config这个配置文件，可以在系统自带的config文件的基础上进行修改，系统自带的config文件在/boot目录下，需要将其复制到内核解压的目录下并改名为.config </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cp /boot/config-3.10.0-957.el7.x86_64 ~/linux-5.0.7/.config</span></span><br></pre></td></tr></table></figure>

<h3 id="四、安装编译内核所需要的一些工具"><a href="#四、安装编译内核所需要的一些工具" class="headerlink" title="四、安装编译内核所需要的一些工具"></a>四、安装编译内核所需要的一些工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum install gcc gcc-c++ glibc glibc-devel pcre pcre-devel ncurses-devel flex bison-devel bison perl-Test-Fatal  openssl-devel elfutils-libelf-devel -y</span></span><br></pre></td></tr></table></figure>

<h3 id="五、执行make-menuconfig命令"><a href="#五、执行make-menuconfig命令" class="headerlink" title="五、执行make menuconfig命令"></a>五、执行make menuconfig命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 linux-5.0.7]<span class="comment"># make menuconfig</span></span><br></pre></td></tr></table></figure>

<p>以下开始进入编译内核选项</p>
<p><img src="1.png" alt="1.png"></p>
<p><img src="2.png" alt="2.png"></p>
<p><img src="3.png" alt="3.png"></p>
<p><img src="4.png" alt="4.png"></p>
<p><img src="5.png" alt="5.png"></p>
<p><img src="6.png" alt="6.png"></p>
<h3 id="六、开始编译"><a href="#六、开始编译" class="headerlink" title="六、开始编译"></a>六、开始编译</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 linux-5.0.7]<span class="comment"># make -j 12</span></span><br></pre></td></tr></table></figure>

<h3 id="七、执行make-modules-install"><a href="#七、执行make-modules-install" class="headerlink" title="七、执行make modules_install"></a>七、执行make modules_install</h3><p>执行make modules_install 在/lib/modules目录下生成新的内核模块</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 linux-5.0.7]<span class="comment"># make modules_install</span></span><br></pre></td></tr></table></figure>
<h3 id="八、生成内核"><a href="#八、生成内核" class="headerlink" title="八、生成内核"></a>八、生成内核</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 linux-5.0.7]<span class="comment"># make install</span></span><br><span class="line">Makefile:159: warning: overriding recipe <span class="keyword">for</span> target `Makefile<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Makefile:125: warning: ignoring old recipe for target `Makefile&#x27;</span></span><br><span class="line">sh ./arch/x86/boot/install.sh 5.0.7-Masuri arch/x86/boot/bzImage \</span><br><span class="line">	System.map <span class="string">&quot;/boot&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="九、重启选择5-07内核"><a href="#九、重启选择5-07内核" class="headerlink" title="九、重启选择5.07内核"></a>九、重启选择5.07内核</h3><p>重启选择新的内核</p>
<p><img src="7.png" alt="7.png"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[masuri@centos7 ~]$ uname -r</span><br><span class="line">5.0.7-Masuri</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="内核的卸载"><a href="#内核的卸载" class="headerlink" title="内核的卸载"></a>内核的卸载</h2><h3 id="一、删除-lib-modules下相应的内核文件"><a href="#一、删除-lib-modules下相应的内核文件" class="headerlink" title="一、删除/lib/modules下相应的内核文件"></a>一、删除/lib/modules下相应的内核文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># rm -rf /lib/modules/5.0.7-Masuri/</span></span><br></pre></td></tr></table></figure>
<h3 id="二、删除boot下的相关内核文件"><a href="#二、删除boot下的相关内核文件" class="headerlink" title="二、删除boot下的相关内核文件"></a>二、删除boot下的相关内核文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># rm -rf /boot/*-5.0.7-*</span></span><br></pre></td></tr></table></figure>
<h3 id="三、清理grub2"><a href="#三、清理grub2" class="headerlink" title="三、清理grub2"></a>三、清理grub2</h3><p>此时/boot/grub2/grub.cfg中还有残留的版本信息，需要将其清理干净</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">menuentry <span class="string">&#x27;CentOS Linux (5.0.7-Masuri) 7 (Core)&#x27;</span> --class centos --class gnu-linux --class gnu --class os --unrestricted <span class="variable">$menuentry_id_option</span> <span class="string">&#x27;gnulinux-3.10.0-957.el7.x86_64-advanced-45490aa4-cf29-420d-a606-af32688b6707&#x27;</span> &#123;</span><br><span class="line">        load_video</span><br><span class="line">        <span class="built_in">set</span> gfxpayload=keep</span><br><span class="line">        insmod gzio</span><br><span class="line">        insmod part_msdos</span><br><span class="line">        insmod xfs</span><br><span class="line">        <span class="built_in">set</span> root=<span class="string">&#x27;hd0,msdos1&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> [ x<span class="variable">$feature_platform_search_hint</span> = xy ]; <span class="keyword">then</span></span><br><span class="line">          search --no-floppy --fs-uuid --<span class="built_in">set</span>=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint=<span class="string">&#x27;hd0,msdos1&#x27;</span>  15dcd896-b7cf-48d0-b8bd-4c0b0f2c62b2</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          search --no-floppy --fs-uuid --<span class="built_in">set</span>=root 15dcd896-b7cf-48d0-b8bd-4c0b0f2c62b2</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        linux16 /vmlinuz-5.0.7-Masuri root=UUID=45490aa4-cf29-420d-a606-af32688b6707 ro crashkernel=auto rhgb quiet LANG=en_US.UTF-8</span><br><span class="line">        initrd16 /initramfs-5.0.7-Masuri.img</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>清理方法使用grub2-mkconfig重新生成新的grub.cfg文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>若要使用ntfs文件系统，可以不必重新编译内核，只需要安装ntfs-3g包就行，此包在epel源中。</p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>多网卡绑定</title>
    <url>/2019/03/06/Linux%E5%9F%BA%E7%A1%80/%E7%BD%91%E5%8D%A1%E7%BB%91%E5%AE%9A/bonding/</url>
    <content><![CDATA[<h2 id="多网卡绑定"><a href="#多网卡绑定" class="headerlink" title="多网卡绑定"></a>多网卡绑定</h2><p>生产环境中将多块网卡绑定同一IP地址对外提供服务，可以实现高可用或者负载均衡。直接给两块网卡设置同一IP地址是不可以的。通过bonding，虚拟一块网卡对外提供连接，物理网卡被修改为相同的MAC地址 。</p>
<span id="more"></span>

<h2 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h2><p>centos7主机一台、网卡设备2块。</p>
<p>此次实验通过两种方式来实现bonding，第一种为修改配置文件，第二种为命令行。</p>
<h3 id="修改配置文件实现bonding"><a href="#修改配置文件实现bonding" class="headerlink" title="修改配置文件实现bonding"></a>修改配置文件实现bonding</h3><p>一、创建band0配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-bond0</span></span><br><span class="line">DEVICE=bond0</span><br><span class="line">IPADDR=192.168.172.100</span><br><span class="line">PREFIX=24</span><br><span class="line">BONDING_OPTS=<span class="string">&#x27;miimon=100 mode=1&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>二、配置第一块网卡</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#vim /etc/sysconfig/network-scripts/ifcfg-ens33</span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">MASTER=bond0</span><br><span class="line">SLAVE=yes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三、配置第二块网卡</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-ens37</span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">DEVICE=ens37</span><br><span class="line">ONBOOT=yes</span><br><span class="line">MASTER=bond0</span><br><span class="line">SLAVE=yes</span><br></pre></td></tr></table></figure>

<p>四、重启网络服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart network</span></span><br></pre></td></tr></table></figure>

<p>五、查看bond状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /proc/net/bonding/bond0 </span></span><br><span class="line">Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)</span><br><span class="line"></span><br><span class="line">Bonding Mode: fault-tolerance (active-backup)</span><br><span class="line">Primary Slave: None</span><br><span class="line">Currently Active Slave: ens33</span><br><span class="line">MII Status: up</span><br><span class="line">MII Polling Interval (ms): 100</span><br><span class="line">Up Delay (ms): 0</span><br><span class="line">Down Delay (ms): 0</span><br><span class="line"></span><br><span class="line">Slave Interface: ens33</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 1000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 00:0c:29:63:21:a6</span><br><span class="line">Slave queue ID: 0</span><br><span class="line"></span><br><span class="line">Slave Interface: ens37</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 1000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 00:0c:29:63:21:b0</span><br><span class="line">Slave queue ID: 0</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="命令行实现bonding"><a href="#命令行实现bonding" class="headerlink" title="命令行实现bonding"></a>命令行实现bonding</h3><p>一、创建bond0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection add con-name bond0 ifname bond0 type bond mode active-backup ipv4.method manual ipv4.addresses 192.168.172.100</span></span><br><span class="line">Connection <span class="string">&#x27;bond0&#x27;</span> (6a323a49-1f74-4424-aa90-8dde22bba989) successfully added.</span><br></pre></td></tr></table></figure>

<p>二、将ens33及ens37加入bond0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection add type bond-slave ifname ens33 master bond0 </span></span><br><span class="line">Connection <span class="string">&#x27;bond-slave-ens33&#x27;</span> (ecacd740-fe79-43a8-9c99-190d17663d01) successfully added.</span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection add type bond-slave ifname ens37 master bond0 </span></span><br><span class="line">Connection <span class="string">&#x27;bond-slave-ens37&#x27;</span> (ea66c3cf-66b5-4438-ad97-058d70c25c28) successfully added.</span><br></pre></td></tr></table></figure>

<p>三、将ens33及ens37关联至bond0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection up bond-slave-ens33</span></span><br><span class="line">Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/6)</span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection up bond-slave-ens37</span></span><br><span class="line">Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/7)</span><br></pre></td></tr></table></figure>

<p>四、启用bond0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection up bond0</span></span><br></pre></td></tr></table></figure>

<p>五、查看bonding状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /proc/net/bonding/bond0 </span></span><br><span class="line">Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)</span><br><span class="line"></span><br><span class="line">Bonding Mode: fault-tolerance (active-backup)</span><br><span class="line">Primary Slave: None</span><br><span class="line">Currently Active Slave: ens33</span><br><span class="line">MII Status: up</span><br><span class="line">MII Polling Interval (ms): 100</span><br><span class="line">Up Delay (ms): 0</span><br><span class="line">Down Delay (ms): 0</span><br><span class="line"></span><br><span class="line">Slave Interface: ens33</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 1000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 00:0c:29:63:21:a6</span><br><span class="line">Slave queue ID: 0</span><br><span class="line"></span><br><span class="line">Slave Interface: ens37</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 1000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 00:0c:29:63:21:b0</span><br><span class="line">Slave queue ID: 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="删除bonding"><a href="#删除bonding" class="headerlink" title="删除bonding"></a>删除bonding</h4><p>1.禁用bond0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection down bond0</span></span><br><span class="line">Connection <span class="string">&#x27;bond0&#x27;</span> successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/8)</span><br></pre></td></tr></table></figure>

<p>2.删除bond相关链接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection delete bond0</span></span><br><span class="line">Connection <span class="string">&#x27;bond0&#x27;</span> (6a323a49-1f74-4424-aa90-8dde22bba989) successfully deleted.</span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection delete bond-slave-ens33</span></span><br><span class="line">Connection <span class="string">&#x27;bond-slave-ens33&#x27;</span> (ecacd740-fe79-43a8-9c99-190d17663d01) successfully deleted.</span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection delete bond-slave-ens37</span></span><br><span class="line">Connection <span class="string">&#x27;bond-slave-ens37&#x27;</span> (ea66c3cf-66b5-4438-ad97-058d70c25c28) successfully deleted.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>网络</tag>
      </tags>
  </entry>
  <entry>
    <title>网桥Bridge</title>
    <url>/2019/03/05/Linux%E5%9F%BA%E7%A1%80/%E7%BD%91%E6%A1%A5bridge/%E7%BD%91%E6%A1%A5bridge/</url>
    <content><![CDATA[<h2 id="网桥Bridge"><a href="#网桥Bridge" class="headerlink" title="网桥Bridge"></a>网桥Bridge</h2><p>网桥将两个相似的网络连接起来，并对网络数据的流通进行管理。它工作于数据链路层，不但能扩展网络的距离或范围，而且可提高网络的性能、可靠性和安全性。网络1 和网络2 通过网桥连接后，网桥接收网络1 发送的数据包，检查数据包中的地址，如果地址属于网络1 ，它就将其放弃，相反，如果是网络2 的地址，它就继续发送给网络2.这样可利用网桥隔离信息，将同一个网络号划分成多个网段（属于同一个网络号），隔离出安全网段，防止其他网段内的用户非法访问。由于网络的分段，各网段相对独立（属于同一个网络号），一个网段的故障不会影响到另一个网段的运行。</p>
<span id="more"></span>

<h3 id="网桥实现"><a href="#网桥实现" class="headerlink" title="网桥实现"></a>网桥实现</h3><p>将一台Linux主机配置为网桥，将两台在不同了网络，ip地址却在同一网段的设备连接起来  </p>
<h3 id="实验准备"><a href="#实验准备" class="headerlink" title="实验准备"></a>实验准备</h3><p>准备3台虚拟机，主机A配置一块网卡，主机B配置一块网卡，主机Bridge配置2块网卡  </p>
<p>主机A在vmnet2网络</p>
<p><img src="A.png" alt="A.png"></p>
<p>主机B在vmnet3网络</p>
<p><img src="B.png" alt="B.png"></p>
<p>Bridge两个口一个连接vmnet2网络，另一个连接vmnet3网络</p>
<p><img src="bridge.png" alt="bridge.png"></p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">en33</th>
<th align="left">ens37</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">192.168.10.10</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">192.168.10.11</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Bridge</td>
<td align="left">无地址</td>
<td align="left">无地址</td>
</tr>
</tbody></table>
<hr>
<h3 id="一、先分别为主机A和主机B配置ip地址"><a href="#一、先分别为主机A和主机B配置ip地址" class="headerlink" title="一、先分别为主机A和主机B配置ip地址"></a>一、先分别为主机A和主机B配置ip地址</h3><p>1.为主机A网卡配置地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-ens33 </span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">NAME=ens33</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.10.10</span><br><span class="line">PREFIX=24</span><br><span class="line"><span class="comment">#重启网络服务</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart network</span></span><br><span class="line"><span class="comment">#查看地址是否配置成功</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ip addr show ens33</span></span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:0f:f4:54 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.10.10/24 brd 192.168.10.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe0f:f454/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.为主机B网卡配置地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-ens33 </span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">NAME=ens33</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.10.11</span><br><span class="line">PREFIX=24</span><br><span class="line"><span class="comment">#重启网络服务</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart network</span></span><br><span class="line"><span class="comment">#查看网卡配置是否成功</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ip addr show ens33</span></span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:48:5f:06 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.10.11/24 brd 192.168.10.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe48:5f06/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>3.此时虽然主机A与主机B在同一个网段，但他们不在同一个物理网络，所以无法连通</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ping 192.168.10.11</span></span><br><span class="line">PING 192.168.10.11 (192.168.10.11) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 192.168.10.11 ping statistics ---</span><br><span class="line">5 packets transmitted, 0 received, 100% packet loss, time 4001ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="二、在主机Bridge上进行桥接设置"><a href="#二、在主机Bridge上进行桥接设置" class="headerlink" title="二、在主机Bridge上进行桥接设置"></a>二、在主机Bridge上进行桥接设置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建网桥设备br0</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># brctl addbr br0</span></span><br><span class="line"><span class="comment">#将ens33添加入br0</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># brctl addif br0 ens33</span></span><br><span class="line"><span class="comment">#将ens37添加入br0</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># brctl addif br0 ens37</span></span><br><span class="line"><span class="comment">#启用网桥设备br0</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ip link set br0 up</span></span><br><span class="line"><span class="comment">#查看网桥设备状态，是否已经学习到主机A和B的mac地址</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># brctl showmacs br0</span></span><br><span class="line">port no	mac addr		is <span class="built_in">local</span>?	ageing timer</span><br><span class="line">  1	00:0c:29:0f:f4:54	no		 269.63         此为主机A的mac地址</span><br><span class="line">  2	00:0c:29:48:5f:06	no		 273.98         此为主机B的mac地址</span><br><span class="line">  1	00:0c:29:b6:86:9f	yes		   0.00</span><br><span class="line">  1	00:0c:29:b6:86:9f	yes		   0.00</span><br><span class="line">  2	00:0c:29:b6:86:a9	yes		   0.00</span><br><span class="line">  2	00:0c:29:b6:86:a9	yes		   0.00</span><br></pre></td></tr></table></figure>

<p>至此网桥已经全部配置完成  </p>
<h3 id="三、测试"><a href="#三、测试" class="headerlink" title="三、测试"></a>三、测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看当前主机地址</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ip a s ens33</span></span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:0f:f4:54 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.10.10/24 brd 192.168.10.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe0f:f454/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="comment">#ping远程192.168.10.11主机查看是否能连通</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ping 192.168.10.11</span></span><br><span class="line">PING 192.168.10.11 (192.168.10.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.10.11: icmp_seq=1 ttl=64 time=0.700 ms</span><br><span class="line">64 bytes from 192.168.10.11: icmp_seq=2 ttl=64 time=1.95 ms</span><br><span class="line">64 bytes from 192.168.10.11: icmp_seq=3 ttl=64 time=1.88 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.10.11 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2002ms</span><br><span class="line">rtt min/avg/max/mdev = 0.700/1.514/1.958/0.577 ms</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="网桥的删除"><a href="#网桥的删除" class="headerlink" title="网桥的删除"></a>网桥的删除</h3><p>删除网桥需要先禁用网桥然后将网桥上的接口全部删除，最后删除网桥设备  </p>
<p>1.先禁用网桥设备</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ip link set br0 down</span></span><br></pre></td></tr></table></figure>

<p>2.删除网桥上接口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># brctl delif br0 ens33</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># brctl delif br0 ens37</span></span><br></pre></td></tr></table></figure>

<p>3.将网桥设备br0删除</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># brctl delbr br0</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>网络</tag>
      </tags>
  </entry>
  <entry>
    <title>网络组team</title>
    <url>/2019/03/06/Linux%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C%E7%BB%84team/%E7%BD%91%E7%BB%9C%E7%BB%84team/</url>
    <content><![CDATA[<h2 id="网络组team"><a href="#网络组team" class="headerlink" title="网络组team"></a>网络组team</h2><p>网络组是centos7上新出的一个技术，它的作用和bonding类似，是将多个网卡聚合在一起方法，从而实现冗错和提高吞吐量，不同于旧版中bonding技术，网路组提供更好的性能和扩展性，它是由内核驱动和teamd守护进程实现。  </p>
<span id="more"></span>

<p>网路组可以工作在多种模式(runner)    </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">broadcast   </span><br><span class="line">roundrobin     </span><br><span class="line">activebackup   </span><br><span class="line">loadbalance   </span><br><span class="line">lacp (implements the 802.3ad Link Aggregation Control Protocol)   </span><br></pre></td></tr></table></figure>

<hr>
<h3 id="网络组team实现"><a href="#网络组team实现" class="headerlink" title="网络组team实现"></a>网络组team实现</h3><p>准备一台CentOS7主机，网卡2块。</p>
<h4 id="创建网络组"><a href="#创建网络组" class="headerlink" title="创建网络组"></a>创建网络组</h4><p>1.创建网路网</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection add con-name team0 ifname team0 type team ipv4.method manual ipv4.addresses 192.168.172.100 config &#x27;&#123;&quot;runner&quot;:&#123;&quot;name&quot;:&quot;loadbalance&quot;&#125;&#125;&#x27;</span></span><br><span class="line">Connection <span class="string">&#x27;team0&#x27;</span> (24db0099-b9fa-4aae-ace0-9421e3c69278) successfully added.</span><br></pre></td></tr></table></figure>

<p>2.添加物理网卡</p>
<p>分别将ens33和ens37添加至网路组内</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection add con-name team0-ens33 ifname ens33 type team-slave master team0</span></span><br><span class="line">Connection <span class="string">&#x27;team0-ens33&#x27;</span> (0d00650a-e379-4c70-9f62-ba268af1a208) successfully added.</span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection add con-name team0-ens37 ifname ens37 type team-slave master team0</span></span><br><span class="line">Connection <span class="string">&#x27;team0-ens37&#x27;</span> (2916ab1f-2e3c-477b-aaaf-52dfaecaaeb7) successfully added.</span><br></pre></td></tr></table></figure>

<p>3.将物理网卡和网络组关联起来</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#由于刚才只是将物理网卡添加至网络组内，所以此时team0-ens33和team0-ens37并未启用</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection</span></span><br><span class="line">NAME                UUID                                  TYPE      DEVICE </span><br><span class="line">ens33               fca2f13f-7310-4595-bbb1-e6d0e3662aff  ethernet  ens33  </span><br><span class="line">team0               24db0099-b9fa-4aae-ace0-9421e3c69278  team      team0  </span><br><span class="line">virbr0              803d85ba-4e80-470f-bcf5-1b22b5653026  bridge    virbr0 </span><br><span class="line">Wired connection 1  3f019cd5-7685-3368-960c-101e35cd6ce7  ethernet  ens37  </span><br><span class="line">team0-ens33         0d00650a-e379-4c70-9f62-ba268af1a208  ethernet  --     </span><br><span class="line">team0-ens37         2916ab1f-2e3c-477b-aaaf-52dfaecaaeb7  ethernet  --   </span><br><span class="line"><span class="comment">#将网络组内的物理网卡关联起来</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection up team0-ens33</span></span><br><span class="line">Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/7)</span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection up team0-ens37</span></span><br><span class="line">Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/8)</span><br><span class="line"><span class="comment">#此时team-ens33和team-ens37都已经启用，网络组创建成功</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection </span></span><br><span class="line">NAME                UUID                                  TYPE      DEVICE </span><br><span class="line">team0               24db0099-b9fa-4aae-ace0-9421e3c69278  team      team0  </span><br><span class="line">team0-ens33         0d00650a-e379-4c70-9f62-ba268af1a208  ethernet  ens33  </span><br><span class="line">team0-ens37         2916ab1f-2e3c-477b-aaaf-52dfaecaaeb7  ethernet  ens37  </span><br><span class="line">virbr0              803d85ba-4e80-470f-bcf5-1b22b5653026  bridge    virbr0 </span><br><span class="line">ens33               fca2f13f-7310-4595-bbb1-e6d0e3662aff  ethernet  --     </span><br><span class="line">Wired connection 1  3f019cd5-7685-3368-960c-101e35cd6ce7  ethernet  --   </span><br></pre></td></tr></table></figure>

<p>4.查看网络组状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># teamdctl team0 state</span></span><br><span class="line">setup:</span><br><span class="line">  runner: loadbalance</span><br><span class="line">ports:</span><br><span class="line">  ens33</span><br><span class="line">    link watches:</span><br><span class="line">      link summary: up</span><br><span class="line">      instance[link_watch_0]:</span><br><span class="line">        name: ethtool</span><br><span class="line">        link: up</span><br><span class="line">        down count: 0</span><br><span class="line">  ens37</span><br><span class="line">    link watches:</span><br><span class="line">      link summary: up</span><br><span class="line">      instance[link_watch_0]:</span><br><span class="line">        name: ethtool</span><br><span class="line">        link: up</span><br><span class="line">        down count: 0</span><br></pre></td></tr></table></figure>

<h4 id="网络组的删除"><a href="#网络组的删除" class="headerlink" title="网络组的删除"></a>网络组的删除</h4><p>1.删除相关配置文件  </p>
<p>由于nmcli命令在执行时会自动生成网卡的配置文件，所以删除网路组时需要将相应的配置文件进行删除</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># rm -vf /etc/sysconfig/network-scripts/ifcfg-team0*</span></span><br><span class="line">removed ‘/etc/sysconfig/network-scripts/ifcfg-team0’</span><br><span class="line">removed ‘/etc/sysconfig/network-scripts/ifcfg-team0-ens33’</span><br><span class="line">removed ‘/etc/sysconfig/network-scripts/ifcfg-team0-ens37’</span><br></pre></td></tr></table></figure>

<p>2.取消相关网卡的关联</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#将网络组中的ens33及ens37取消关联</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection down team0-ens33</span></span><br><span class="line">Connection <span class="string">&#x27;team0-ens33&#x27;</span> successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/7)</span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection down team0-ens37</span></span><br><span class="line">Connection <span class="string">&#x27;team0-ens37&#x27;</span> successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/8)</span><br><span class="line"><span class="comment">#删除链接ens33和ens37</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection delete team0-ens33</span></span><br><span class="line">Connection <span class="string">&#x27;team0-ens33&#x27;</span> (0d00650a-e379-4c70-9f62-ba268af1a208) successfully deleted.</span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection delete team0-ens37</span></span><br><span class="line">Connection <span class="string">&#x27;team0-ens37&#x27;</span> (2916ab1f-2e3c-477b-aaaf-52dfaecaaeb7) successfully deleted.</span><br></pre></td></tr></table></figure>

<p>3.将网路组删除</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#先禁用网路组</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection down team0 </span></span><br><span class="line">Connection <span class="string">&#x27;team0&#x27;</span> successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/6)</span><br><span class="line"><span class="comment">#将网路组删除</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection delete team0 </span></span><br><span class="line">Connection <span class="string">&#x27;team0&#x27;</span> (24db0099-b9fa-4aae-ace0-9421e3c69278) successfully deleted.</span><br></pre></td></tr></table></figure>

<p>此时网路组已经从主机上删除</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># nmcli connection </span></span><br><span class="line">NAME                UUID                                  TYPE      DEVICE </span><br><span class="line">ens33               fca2f13f-7310-4595-bbb1-e6d0e3662aff  ethernet  ens33  </span><br><span class="line">virbr0              803d85ba-4e80-470f-bcf5-1b22b5653026  bridge    virbr0 </span><br><span class="line">Wired connection 1  3f019cd5-7685-3368-960c-101e35cd6ce7  ethernet  ens37  </span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>网络</tag>
      </tags>
  </entry>
  <entry>
    <title>自制Linux系统</title>
    <url>/2019/03/08/Linux%E5%9F%BA%E7%A1%80/%E8%87%AA%E5%88%B6Linux/%E8%87%AA%E5%88%B6linux/</url>
    <content><![CDATA[<h2 id="自制Linux系统"><a href="#自制Linux系统" class="headerlink" title="自制Linux系统"></a>自制Linux系统</h2><p>以下为使用现有的Linux系统对其制作出一个小型的Linux系统</p>
<span id="more"></span>

<h3 id="一、新增一块硬盘作为自制Linux的系统盘"><a href="#一、新增一块硬盘作为自制Linux的系统盘" class="headerlink" title="一、新增一块硬盘作为自制Linux的系统盘"></a>一、新增一块硬盘作为自制Linux的系统盘</h3><p><img src="1.png" alt="1.png"></p>
<h3 id="二、在新增硬盘上进行分区"><a href="#二、在新增硬盘上进行分区" class="headerlink" title="二、在新增硬盘上进行分区"></a>二、在新增硬盘上进行分区</h3><p>分区1为boot大小1G</p>
<p>分区2为/大小为10G</p>
<p>分区3为swap大小为2G</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># fdisk /dev/sdb</span></span><br><span class="line">Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel</span><br><span class="line">Building a new DOS disklabel with disk identifier 0xc06ac594.</span><br><span class="line">Changes will remain <span class="keyword">in</span> memory only, until you decide to write them.</span><br><span class="line">After that, of course, the previous content won<span class="string">&#x27;t be recoverable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">WARNING: DOS-compatible mode is deprecated. It&#x27;</span>s strongly recommended to</span><br><span class="line">         switch off the mode (<span class="built_in">command</span> <span class="string">&#x27;c&#x27;</span>) and change display units to</span><br><span class="line">         sectors (<span class="built_in">command</span> <span class="string">&#x27;u&#x27;</span>).</span><br><span class="line"><span class="comment">#新建一个分区作为BOOT分区</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Command action</span><br><span class="line">   e   extended</span><br><span class="line">   p   primary partition (1-4)</span><br><span class="line">p</span><br><span class="line">Partition number (1-4): 1</span><br><span class="line">First cylinder (1-2610, default 1): </span><br><span class="line">Using default value 1</span><br><span class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (1-2610, default 2610): +1G</span><br><span class="line"><span class="comment">#新建一个分区作为/分区</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Command action</span><br><span class="line">   e   extended</span><br><span class="line">   p   primary partition (1-4)</span><br><span class="line">p</span><br><span class="line">Partition number (1-4): 2</span><br><span class="line">First cylinder (133-2610, default 133): </span><br><span class="line">Using default value 133</span><br><span class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (133-2610, default 2610): +10G</span><br><span class="line"><span class="comment">#新建一个分区作为swap分区</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Command action</span><br><span class="line">   e   extended</span><br><span class="line">   p   primary partition (1-4)</span><br><span class="line">p</span><br><span class="line">Partition number (1-4): 3</span><br><span class="line">First cylinder (1439-2610, default 1439): </span><br><span class="line">Using default value 1439</span><br><span class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (1439-2610, default 2610): +2G</span><br><span class="line"><span class="comment">#更改SWAP分区标签</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): t</span><br><span class="line">Partition number (1-4): 3</span><br><span class="line">Hex code (<span class="built_in">type</span> L to list codes): 82</span><br><span class="line">Changed system <span class="built_in">type</span> of partition 3 to 82 (Linux swap / Solaris)</span><br><span class="line"><span class="comment">#查看下所创建的分区是否正确</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): p</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 21.5 GB, 21474836480 bytes</span><br><span class="line">255 heads, 63 sectors/track, 2610 cylinders</span><br><span class="line">Units = cylinders of 16065 * 512 = 8225280 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk identifier: 0xc06ac594</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sdb1               1         132     1060258+  83  Linux</span><br><span class="line">/dev/sdb2             133        1438    10490445   83  Linux</span><br><span class="line">/dev/sdb3            1439        1700     2104515   82  Linux swap / Solaris</span><br><span class="line"><span class="comment">#确认无误写入磁盘</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure>

<h3 id="三、对3个分区创建文件系统"><a href="#三、对3个分区创建文件系统" class="headerlink" title="三、对3个分区创建文件系统"></a>三、对3个分区创建文件系统</h3><p>1.sdb1使用ext4文件系统</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># mkfs.ext4 /dev/sdb1</span></span><br><span class="line">mke2fs 1.41.12 (17-May-2010)</span><br><span class="line">Filesystem label=</span><br><span class="line">OS <span class="built_in">type</span>: Linux</span><br><span class="line">Block size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Fragment size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">66384 inodes, 265064 blocks</span><br><span class="line">13253 blocks (5.00%) reserved <span class="keyword">for</span> the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=272629760</span><br><span class="line">9 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">7376 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">	32768, 98304, 163840, 229376</span><br><span class="line"></span><br><span class="line">Writing inode tables: <span class="keyword">done</span>                            </span><br><span class="line">Creating journal (8192 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">This filesystem will be automatically checked every 21 mounts or</span><br><span class="line">180 days, whichever comes first.  Use tune2fs -c or -i to override.</span><br></pre></td></tr></table></figure>

<p>2./使用ext4系统</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># mkfs.ext4 /dev/sdb2</span></span><br><span class="line">mke2fs 1.41.12 (17-May-2010)</span><br><span class="line">Filesystem label=</span><br><span class="line">OS <span class="built_in">type</span>: Linux</span><br><span class="line">Block size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Fragment size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">655776 inodes, 2622611 blocks</span><br><span class="line">131130 blocks (5.00%) reserved <span class="keyword">for</span> the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=2688548864</span><br><span class="line">81 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">8096 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632</span><br><span class="line"></span><br><span class="line">Writing inode tables: <span class="keyword">done</span>                            </span><br><span class="line">Creating journal (32768 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">This filesystem will be automatically checked every 31 mounts or</span><br><span class="line">180 days, whichever comes first.  Use tune2fs -c or -i to override.</span><br></pre></td></tr></table></figure>

<p>3.sdb3使用swap系统</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># mkswap /dev/sdb3</span></span><br><span class="line">Setting up swapspace version 1, size = 2104508 KiB</span><br><span class="line">no label, UUID=2ae55ed1-8e5c-4d45-853d-1a4c94badfc2</span><br></pre></td></tr></table></figure>

<h3 id="四、对分区进行挂载"><a href="#四、对分区进行挂载" class="headerlink" title="四、对分区进行挂载"></a>四、对分区进行挂载</h3><p>把sdb1挂载在/mnt/boot下，sdb2挂载在/mnt/sysroot下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 /]<span class="comment"># mkdir /mnt/boot</span></span><br><span class="line">[root@centos6 /]<span class="comment"># mount /dev/sdb1 /mnt/boot</span></span><br><span class="line">[root@centos6 /]<span class="comment"># mkdir /mnt/sysroot</span></span><br><span class="line">[root@centos6 /]<span class="comment"># mount /dev/sdb2 /mnt/sysroot</span></span><br></pre></td></tr></table></figure>

<h3 id="五、在-mnt-sysroot下创建相应的根文件系统目录"><a href="#五、在-mnt-sysroot下创建相应的根文件系统目录" class="headerlink" title="五、在/mnt/sysroot下创建相应的根文件系统目录"></a>五、在/mnt/sysroot下创建相应的根文件系统目录</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 sysroot]<span class="comment"># cd /mnt/sysroot/</span></span><br><span class="line">[root@centos6 sysroot]<span class="comment"># for i in `ls /`;do mkdir $i;done </span></span><br><span class="line">[root@centos6 sysroot]<span class="comment"># ls</span></span><br><span class="line">bin   data  etc   lib    lost+found  misc  net  proc  sbin     srv  tmp  var</span><br><span class="line">boot  dev   home  lib64  media       mnt   opt  root  selinux  sys  usr</span><br><span class="line">[root@centos6 sysroot]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h3 id="六、将内核文件和虚拟文件系统复制到-mnt-boot目录下"><a href="#六、将内核文件和虚拟文件系统复制到-mnt-boot目录下" class="headerlink" title="六、将内核文件和虚拟文件系统复制到/mnt/boot目录下"></a>六、将内核文件和虚拟文件系统复制到/mnt/boot目录下</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 sysroot]<span class="comment"># cp /boot/vmlinuz-2.6.32-754.el6.x86_64 /mnt/boot/</span></span><br><span class="line">[root@centos6 sysroot]<span class="comment"># cp /boot/initramfs-2.6.32-754.el6.x86_64.img /mnt/boot/</span></span><br></pre></td></tr></table></figure>

<h3 id="七、安装Grub写入grub配置文件"><a href="#七、安装Grub写入grub配置文件" class="headerlink" title="七、安装Grub写入grub配置文件"></a>七、安装Grub写入grub配置文件</h3><p>1.安装grub</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 boot]<span class="comment"># grub-install --root-directory=/mnt /dev/sdb</span></span><br><span class="line">Probing devices to guess BIOS drives. This may take a long time.</span><br><span class="line">Installation finished. No error reported.</span><br><span class="line">This is the contents of the device map /mnt/boot/grub/device.map.</span><br><span class="line">Check <span class="keyword">if</span> this is correct or not. If any of the lines is incorrect,</span><br><span class="line">fix it and re-run the script `grub-install<span class="string">&#x27;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(fd0)	/dev/fd0</span></span><br><span class="line"><span class="string">(hd0)	/dev/sda</span></span><br><span class="line"><span class="string">(hd1)	/dev/sdb</span></span><br><span class="line"><span class="string">[root@centos6 boot]# ls /mnt/boot</span></span><br><span class="line"><span class="string">grub  initramfs-2.6.32-754.el6.x86_64.img  vmlinuz-2.6.32-754.el6.x86_64</span></span><br></pre></td></tr></table></figure>

<p>2.写配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 boot]<span class="comment"># cd /mnt/boot/grub/</span></span><br><span class="line">[root@centos6 grub]<span class="comment"># ls</span></span><br><span class="line">device.map     ffs_stage1_5      minix_stage1_5     stage2           xfs_stage1_5</span><br><span class="line">e2fs_stage1_5  iso9660_stage1_5  reiserfs_stage1_5  ufs2_stage1_5</span><br><span class="line">fat_stage1_5   jfs_stage1_5      stage1             vstafs_stage1_5</span><br><span class="line">[root@centos6 grub]<span class="comment"># vim grub.conf</span></span><br><span class="line">default=0</span><br><span class="line">timeout=3</span><br><span class="line">title=linux</span><br><span class="line">kernel /vmlinuz-2.6.32-754.el6.x86_64 ro root=/dev/sda2 selinux=0 init=/bin/bash          <span class="comment">#由于硬盘是需要安装至新机器上所以此处指定的root为/dev/sda2  linux系统启动后用bash来代替init进程 selinux必须关闭</span></span><br><span class="line">initrd /initramfs-2.6.32-754.el6.x86_64.img</span><br><span class="line">~                                                </span><br></pre></td></tr></table></figure>

<h3 id="八、复制相应的命令和库文件至新的根内"><a href="#八、复制相应的命令和库文件至新的根内" class="headerlink" title="八、复制相应的命令和库文件至新的根内"></a>八、复制相应的命令和库文件至新的根内</h3><p>1.编写一个简易的脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">DIRPATH=/mnt/sysroot</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> ;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;please input a cmd: &quot;</span> CMD</span><br><span class="line">        ldd `<span class="built_in">which</span> <span class="variable">$CMD</span> | grep -E <span class="string">&#x27;/.*&#x27;</span>` | grep -Eo <span class="string">&quot;/[^ ]+&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> LINE ;<span class="keyword">do</span></span><br><span class="line">           cp --parents `<span class="built_in">which</span> <span class="variable">$CMD</span> | egrep <span class="string">&#x27;/.*&#x27;</span>` <span class="variable">$DIRPATH</span></span><br><span class="line">           cp --parents <span class="variable">$LINE</span> <span class="variable">$DIRPATH</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>2.复制命令及库文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># bash +x cpcmd.sh </span></span><br><span class="line">please input a cmd: cp</span><br><span class="line">please input a cmd: ls</span><br><span class="line">please input a cmd: vim</span><br><span class="line">please input a cmd: cat</span><br><span class="line">please input a cmd: ping</span><br><span class="line">please input a cmd: ifconfig</span><br><span class="line">please input a cmd: modprobe</span><br><span class="line">please input a cmd: insmod</span><br><span class="line">please input a cmd: rm</span><br><span class="line">please input a cmd: lsblk</span><br><span class="line">please input a cmd: blkid</span><br><span class="line">please input a cmd: mount</span><br><span class="line">please input a cmd: swapon</span><br><span class="line">please input a cmd: df</span><br><span class="line">please input a cmd: hostname</span><br><span class="line">please input a cmd: <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h3 id="九、复制网卡的驱动模块"><a href="#九、复制网卡的驱动模块" class="headerlink" title="九、复制网卡的驱动模块"></a>九、复制网卡的驱动模块</h3><p>1.查看网卡的驱动模块</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># ethtool -i eth0</span></span><br><span class="line">driver: e1000                   <span class="comment">#模块为e1000</span></span><br><span class="line">version: 7.3.21-k8-NAPI</span><br><span class="line">firmware-version: </span><br><span class="line">bus-info: 0000:02:01.0</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: yes</span><br><span class="line">supports-register-dump: yes</span><br><span class="line">supports-priv-flags: no</span><br></pre></td></tr></table></figure>

<p>2.查看模块文件所在的位置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># modinfo e1000 | grep &quot;e1000&quot;</span></span><br><span class="line">filename:       /lib/modules/2.6.32-754.el6.x86_64/kernel/drivers/net/e1000/e1000.ko</span><br></pre></td></tr></table></figure>

<p>3.复制模块文件至相应位置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># cp /lib/modules//2.6.32-754.el6.x86_64//kernel//drivers/net/e1000/e1000.ko /mnt/sysroot/lib</span></span><br><span class="line">[root@centos6 ~]<span class="comment"># ls /mnt/sysroot/lib</span></span><br><span class="line">e1000.ko</span><br></pre></td></tr></table></figure>

<h3 id="十、切根测试"><a href="#十、切根测试" class="headerlink" title="十、切根测试"></a>十、切根测试</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@centos6 ~]# chroot /mnt/sysroot/</span><br><span class="line">bash-4.1# ls</span><br><span class="line">bin   data  etc   lib	 lost+found  misc  net	proc  sbin     srv  tmp  var</span><br><span class="line">boot  dev   home  lib64  media	     mnt   opt	root  selinux  sys  usr</span><br><span class="line">bash-4.1# hostname</span><br><span class="line">centos6.localdomain</span><br></pre></td></tr></table></figure>

<p>测试成功 </p>
<h3 id="十一、将硬盘挪至新机器测试开机"><a href="#十一、将硬盘挪至新机器测试开机" class="headerlink" title="十一、将硬盘挪至新机器测试开机"></a>十一、将硬盘挪至新机器测试开机</h3><p><img src="2.png" alt="2.png"></p>
<h3 id="十二、加载网卡驱动测试"><a href="#十二、加载网卡驱动测试" class="headerlink" title="十二、加载网卡驱动测试"></a>十二、加载网卡驱动测试</h3><p><img src="3.png" alt="3.png"></p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>误删库文件恢复方法</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/%E8%AF%AF%E5%88%A0%E5%BA%93%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D%E6%96%B9%E6%B3%95/%E8%AF%AF%E5%88%A0%E5%BA%93%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D/</url>
    <content><![CDATA[<h2 id="误删库文件恢复方法"><a href="#误删库文件恢复方法" class="headerlink" title="误删库文件恢复方法"></a>误删库文件恢复方法</h2><h3 id="libc-so-6删除恢复"><a href="#libc-so-6删除恢复" class="headerlink" title="libc.so.6删除恢复"></a>libc.so.6删除恢复</h3><p>libc.so.6是linux中非常重要的库文件，误删除后会影响许多命令无法使用。  </p>
<p>以下演示如何删除libc.so.6后恢复  </p>
<span id="more"></span>

<p>示例：  </p>
<p>1.创建删除libc.so.6的环境。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># rm -rf /lib64/libc.so.6 </span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ls</span></span><br><span class="line">ls: error <span class="keyword">while</span> loading shared libraries: libc.so.6: cannot open shared object file: No such file or directory</span><br><span class="line">[root@centos7 /]<span class="comment"># cat /etc/passwd</span></span><br><span class="line">cat: error <span class="keyword">while</span> loading shared libraries: libc.so.6: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>

<p>删除后ls、cat、等命令都已经无法使用。  </p>
<p>2.重启机器，选择光盘启动。CD-ROM Drive</p>
<p><img src="%E5%88%A0%E5%BA%931.jpg" alt="删库1"></p>
<p>3.选择Troubleshooting</p>
<p><img src="%E5%88%A0%E5%BA%932.jpg" alt="删库2"></p>
<p>4.选择进入救援模式 Rescue a CentOS system</p>
<p><img src="%E5%88%A0%E5%BA%935.jpg" alt="删库5"></p>
<p>5.选择第一项continue</p>
<p><img src="%E5%88%A0%E5%BA%933.jpg" alt="删库3"></p>
<p>6.此时linux已经将原来硬盘的根挂载到/mnt/sysimage路径下，系统进入了救援模式。</p>
<p><img src="%E5%88%A0%E5%BA%934.jpg" alt="删库4"></p>
<p>7.恢复思路</p>
<p>由于在救援模式下，ls，及cat等命令仍旧可以使用说明在救援模式下也存在libc.so.6这个文件，只需要将救援模式的libc.so.6复制回硬盘就可以恢复,<br>执行以下操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp /lib64/libc.so.6 /mnt/sysimage/lib64</span><br></pre></td></tr></table></figure>

<p>重启系统，此时文件已经恢复所有命令可以正常执行。</p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>系统修复</tag>
      </tags>
  </entry>
  <entry>
    <title>释放磁盘空间技巧</title>
    <url>/2019/03/04/Linux%E5%9F%BA%E7%A1%80/%E9%87%8A%E6%94%BE%E7%A9%BA%E9%97%B4%E6%8A%80%E5%B7%A7/%E9%87%8A%E6%94%BE%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E7%9A%84%E6%8A%80%E5%B7%A7/</url>
    <content><![CDATA[<h2 id="释放磁盘空间技巧"><a href="#释放磁盘空间技巧" class="headerlink" title="释放磁盘空间技巧"></a>释放磁盘空间技巧</h2><p>生产环境中会出现磁盘被一些大文件填满，但是大文件却因为被打开而无法马上删除释放空间的情况，以下技巧是解决此类问题的一种方法</p>
<span id="more"></span>

<h3 id="模拟环境"><a href="#模拟环境" class="headerlink" title="模拟环境"></a>模拟环境</h3><p>先用/dev/zero 将/boot分区填满</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 boot]<span class="comment"># cp /dev/zero /boot/bigfile</span></span><br><span class="line">cp: error writing ‘/boot/bigfile’: No space left on device</span><br><span class="line">cp: failed to extend ‘/boot/bigfile’: No space left on device</span><br><span class="line">[root@centos7 boot]<span class="comment"># df</span></span><br><span class="line">Filesystem     1K-blocks    Used Available Use% Mounted on</span><br><span class="line">/dev/sda2      104806400 3708520 101097880   4% /</span><br><span class="line">devtmpfs          740168       0    740168   0% /dev</span><br><span class="line">tmpfs             756008       0    756008   0% /dev/shm</span><br><span class="line">tmpfs             756008   10144    745864   2% /run</span><br><span class="line">tmpfs             756008       0    756008   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3       52403200   33140  52370060   1% /data</span><br><span class="line">/dev/sda1        1038336 1038296        40 100% /boot</span><br><span class="line">tmpfs             151204       0    151204   0% /run/user/0</span><br></pre></td></tr></table></figure>

<p>然后将/boot/bigfile文件打开，再新启一个终端，用df查看分区利用率</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># df</span></span><br><span class="line">Filesystem     1K-blocks    Used Available Use% Mounted on</span><br><span class="line">/dev/sda2      104806400 3708664 101097736   4% /</span><br><span class="line">devtmpfs          740168       0    740168   0% /dev</span><br><span class="line">tmpfs             756008       0    756008   0% /dev/shm</span><br><span class="line">tmpfs             756008   10184    745824   2% /run</span><br><span class="line">tmpfs             756008       0    756008   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3       52403200   33140  52370060   1% /data</span><br><span class="line">/dev/sda1        1038336 1038300        36 100% /boot</span><br><span class="line">tmpfs             151204       0    151204   0% /run/user/0</span><br></pre></td></tr></table></figure>

<p>使用rm将bigfile文件删除</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># rm /boot/bigfile </span></span><br><span class="line">rm: remove regular file ‘/boot/bigfile’? y</span><br><span class="line">[root@centos7 ~]<span class="comment"># df</span></span><br><span class="line">Filesystem     1K-blocks    Used Available Use% Mounted on</span><br><span class="line">/dev/sda2      104806400 3708584 101097816   4% /</span><br><span class="line">devtmpfs          740168       0    740168   0% /dev</span><br><span class="line">tmpfs             756008       0    756008   0% /dev/shm</span><br><span class="line">tmpfs             756008   10184    745824   2% /run</span><br><span class="line">tmpfs             756008       0    756008   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3       52403200   33140  52370060   1% /data</span><br><span class="line">/dev/sda1        1038336 1038300        36 100% /boot</span><br><span class="line">tmpfs             151204       0    151204   0% /run/user/0</span><br></pre></td></tr></table></figure>

<p>然而此时/boot分区利用率依然为100%，但目录下bigfile文件已经删除。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ls /boot</span></span><br><span class="line">config-3.10.0-957.el7.x86_64</span><br><span class="line">efi</span><br><span class="line">grub</span><br><span class="line">grub2</span><br><span class="line">initramfs-0-rescue-30905c0f8bf344f4af5b53a826370629.img</span><br><span class="line">initramfs-3.10.0-957.el7.x86_64.img</span><br><span class="line">symvers-3.10.0-957.el7.x86_64.gz</span><br><span class="line">System.map-3.10.0-957.el7.x86_64</span><br><span class="line">vmlinuz-0-rescue-30905c0f8bf344f4af5b53a826370629</span><br><span class="line">vmlinuz-3.10.0-957.el7.x86_64</span><br><span class="line">[root@centos7 ~]<span class="comment"># </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当bigfile文件被释放时，/boot分区的利用率归零。  </p>
<p>结论：当磁盘文件被写入时，若直接删除此文件是不会释放磁盘空间的，但是此文件已经删除。只有当文件被关闭时空间才会被释放。    </p>
<h3 id="以下演示正确的操作方法"><a href="#以下演示正确的操作方法" class="headerlink" title="以下演示正确的操作方法"></a>以下演示正确的操作方法</h3><p>先将磁盘填满</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># df</span></span><br><span class="line">Filesystem     1K-blocks    Used Available Use% Mounted on</span><br><span class="line">/dev/sda2      104806400 3708604 101097796   4% /</span><br><span class="line">devtmpfs          740168       0    740168   0% /dev</span><br><span class="line">tmpfs             756008       0    756008   0% /dev/shm</span><br><span class="line">tmpfs             756008   10144    745864   2% /run</span><br><span class="line">tmpfs             756008       0    756008   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3       52403200   33140  52370060   1% /data</span><br><span class="line">/dev/sda1        1038336  167000    871336  17% /boot</span><br><span class="line">tmpfs             151204       0    151204   0% /run/user/0</span><br><span class="line">[root@centos7 ~]<span class="comment"># cp /etc/zero /boot</span></span><br><span class="line">cp: cannot <span class="built_in">stat</span> ‘/etc/zero’: No such file or directory</span><br><span class="line">[root@centos7 ~]<span class="comment"># cp /dev/zero /boot/bigfile</span></span><br><span class="line">cp: overwrite ‘/boot/bigfile’? y</span><br><span class="line">cp: error writing ‘/boot/bigfile’: No space left on device</span><br><span class="line">cp: failed to extend ‘/boot/bigfile’: No space left on device</span><br><span class="line">[root@centos7 ~]<span class="comment"># df</span></span><br><span class="line">Filesystem     1K-blocks    Used Available Use% Mounted on</span><br><span class="line">/dev/sda2      104806400 3708584 101097816   4% /</span><br><span class="line">devtmpfs          740168       0    740168   0% /dev</span><br><span class="line">tmpfs             756008       0    756008   0% /dev/shm</span><br><span class="line">tmpfs             756008   10144    745864   2% /run</span><br><span class="line">tmpfs             756008       0    756008   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3       52403200   33140  52370060   1% /data</span><br><span class="line">/dev/sda1        1038336 1038296        40 100% /boot</span><br><span class="line">tmpfs             151204       0    151204   0% /run/user/0</span><br></pre></td></tr></table></figure>

<p>将bigfile文件打开后另起终端，查看boot分区利用率</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># df /boot</span></span><br><span class="line">Filesystem     1K-blocks    Used Available Use% Mounted on</span><br><span class="line">/dev/sda1        1038336 1038300        36 100% /boot</span><br></pre></td></tr></table></figure>

<p>然后执行重定向命令将bigfile文件清空，此时boot磁盘空间已经释放</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># &gt; /boot/bigfile</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># df</span></span><br><span class="line">Filesystem     1K-blocks    Used Available Use% Mounted on</span><br><span class="line">/dev/sda2      104806400 3708588 101097812   4% /</span><br><span class="line">devtmpfs          740168       0    740168   0% /dev</span><br><span class="line">tmpfs             756008       0    756008   0% /dev/shm</span><br><span class="line">tmpfs             756008   10184    745824   2% /run</span><br><span class="line">tmpfs             756008       0    756008   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3       52403200   33140  52370060   1% /data</span><br><span class="line">/dev/sda1        1038336  167004    871332  17% /boot</span><br><span class="line">tmpfs             151204       0    151204   0% /run/user/0</span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /boot</span></span><br><span class="line">bigfile</span><br><span class="line">config-3.10.0-957.el7.x86_64</span><br><span class="line">efi</span><br><span class="line">grub</span><br><span class="line">grub2</span><br><span class="line">initramfs-0-rescue-30905c0f8bf344f4af5b53a826370629.img</span><br><span class="line">initramfs-3.10.0-957.el7.x86_64.img</span><br><span class="line">symvers-3.10.0-957.el7.x86_64.gz</span><br><span class="line">System.map-3.10.0-957.el7.x86_64</span><br><span class="line">vmlinuz-0-rescue-30905c0f8bf344f4af5b53a826370629</span><br><span class="line">vmlinuz-3.10.0-957.el7.x86_64</span><br></pre></td></tr></table></figure>

<p>然后删除bigfile文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># rm -rf /boot/bigfile</span></span><br></pre></td></tr></table></figure>

<p>当bigfile文件被关闭时，文件即被删除。</p>
]]></content>
      <categories>
        <category>Linux基础</category>
      </categories>
      <tags>
        <tag>Linux基础</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL主主复制及相关的排坑</title>
    <url>/2019/04/10/MySQL/MySQL%E4%B8%BB%E4%B8%BB%E5%A4%8D%E5%88%B6/MySQL%E4%B8%BB%E4%B8%BB%E5%A4%8D%E5%88%B6%E5%8F%8A%E6%8E%92%E5%9D%91/</url>
    <content><![CDATA[<p>主主复制的本质就是2台MySQL服务器互为主从。  </p>
<p>但如此配置极易产生问题，如数据不一致导致主键的冲突，以及一些其他的错误。  </p>
<p>为了减少主键冲突的情况，可以考虑让两个节点的id分别使用奇数和偶数，这就需要用到两个服务器选项来配置。</p>
<span id="more"></span>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">auto_increment_offset       <span class="comment">#设置id的开始点</span></span><br><span class="line">auto_increment_increment    <span class="comment">#设置id的步进</span></span><br></pre></td></tr></table></figure>

<p>主主复制工作中不推荐使用，如确实需要使用，也将其当为主从来使用。</p>
<h2 id="主主复制的搭建"><a href="#主主复制的搭建" class="headerlink" title="主主复制的搭建"></a>主主复制的搭建</h2><p>使用2台主机来配置主主复制<br>|主机|ip|<br>|:-|:-|<br>|Master1|192.168.73.110|<br>|Master2|192.168.73.111|</p>
<h3 id="配置Master1"><a href="#配置Master1" class="headerlink" title="配置Master1"></a>配置Master1</h3><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master1 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin</span><br><span class="line">server-id=1</span><br><span class="line">auto_increment_offset=1</span><br><span class="line">auto_increment_increment=2</span><br></pre></td></tr></table></figure>

<p>2.启动MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master1 ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<p>3.查看二进制日志位置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master1 ~]<span class="comment"># mysql -e &quot;SHOW MASTER LOGS;&quot;</span></span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| Log_name           | File_size |</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| mariadb-bin.000001 |       245 |</span><br><span class="line">+--------------------+-----------+</span><br></pre></td></tr></table></figure>

<p>4.创建一个用来复制数据的用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master1 ~]<span class="comment"># mysql -e &quot;GRANT REPLICATION SLAVE ON *.* TO &#x27;repluser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;centos&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置Master2为Master1的从节点"><a href="#配置Master2为Master1的从节点" class="headerlink" title="配置Master2为Master1的从节点"></a>配置Master2为Master1的从节点</h3><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master2 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin</span><br><span class="line">server-id=2</span><br><span class="line">auto_increment_offset=1</span><br><span class="line">auto_increment_increment=2</span><br></pre></td></tr></table></figure>

<p>2.设置CHANGE MASTER TO</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.73.110&#x27;</span>, MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,MASTER_PASSWORD=<span class="string">&#x27;centos&#x27;</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">&#x27;mariadb-bin.000001&#x27;</span>,MASTER_LOG_POS=245;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>3.查看从节点状态，确认无误</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mariadb-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: mariadb-bin.000001</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br></pre></td></tr></table></figure>

<p>4.启动线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>5.再次查看从节点状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mariadb-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 407</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 693</span><br><span class="line">        Relay_Master_Log_File: mariadb-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes          <span class="comment">#线程已经全部启动</span></span><br></pre></td></tr></table></figure>

<p>6.查看二进制日志位置</p>
<p>查看二级制日志位置用于，给Master1作为从节点使用。由于Master2上无数据二进制日志为干净日志，所以可以直接供Master1使用。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW MASTER LOGS;</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| Log_name           | File_size |</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| mariadb-bin.000001 |       245 |</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="配置Master1为Master2的从节点"><a href="#配置Master1为Master2的从节点" class="headerlink" title="配置Master1为Master2的从节点"></a>配置Master1为Master2的从节点</h3><p>1.输入CHANGE MASTER TO的信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.73.111&#x27;</span>, MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,MASTER_PASSWORD=<span class="string">&#x27;centos&#x27;</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">&#x27;mariadb-bin.000001&#x27;</span>,MASTER_LOG_POS=245;</span><br></pre></td></tr></table></figure>

<p>2.查看从状态,确认信息无误</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.73.111</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mariadb-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: mariadb-bin.000001</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br></pre></td></tr></table></figure>

<p>3.启动线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>4.再次查看slave status</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.111</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mariadb-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 531</span><br><span class="line">        Relay_Master_Log_File: mariadb-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<p>主主复制搭建完毕</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="测试一、查看Master1输入数据，Master2能否复制"><a href="#测试一、查看Master1输入数据，Master2能否复制" class="headerlink" title="测试一、查看Master1输入数据，Master2能否复制"></a>测试一、查看Master1输入数据，Master2能否复制</h4><p>1.从Master1上导入hellodb数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master1 ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">[root@Master1 ~]<span class="comment"># mysql &lt; hellodb_innodb.sql</span></span><br><span class="line">[root@Master1 ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>2.从节点上查看数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master2 ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h4 id="测试二、Master2插入数据查看Master1是否能复制"><a href="#测试二、Master2插入数据查看Master1是否能复制" class="headerlink" title="测试二、Master2插入数据查看Master1是否能复制"></a>测试二、Master2插入数据查看Master1是否能复制</h4><p>1.在Master2中插入条记录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master2 ~]<span class="comment"># mysql -e &quot;INSERT hellodb.teachers(name,age) VALUE (&#x27;Ye Fan&#x27;,&#x27;25&#x27;);&quot;</span></span><br><span class="line">[root@Master2 ~]<span class="comment"># mysql -e &quot;INSERT hellodb.teachers(name,age) VALUE (&#x27;Shi Hao&#x27;,&#x27;20&#x27;);&quot;</span></span><br><span class="line">[root@Master2 ~]<span class="comment"># mysql -e &quot;SELECT * FROM hellodb.teachers&quot;</span></span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|   5 | Ye Fan        |  25 | NULL   |</span><br><span class="line">|   7 | Shi Hao       |  20 | NULL   |      <span class="comment">#此处可以看到插入数据时主键tid是以2为步进递增的。</span></span><br><span class="line">+-----+---------------+-----+--------+</span><br></pre></td></tr></table></figure>

<p>2.在Master1上查看数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master1 ~]<span class="comment"># mysql -e &quot;SELECT * FROM hellodb.teachers;&quot;</span></span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|   5 | Ye Fan        |  25 | NULL   |</span><br><span class="line">|   7 | Shi Hao       |  20 | NULL   |</span><br><span class="line">+-----+---------------+-----+--------+</span><br></pre></td></tr></table></figure>

<h4 id="测试三、两边同时创建一张相同的表"><a href="#测试三、两边同时创建一张相同的表" class="headerlink" title="测试三、两边同时创建一张相同的表"></a>测试三、两边同时创建一张相同的表</h4><p>1.同时对两个主机做出创建表的操作  </p>
<p><img src="%E4%B8%BB%E4%B8%BB1.png" alt="主主1.png"></p>
<p><img src="%E4%B8%BB%E4%B8%BB2.png" alt="主主2.png"></p>
<p>2.查看Master1的hellodb库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master1 ~]<span class="comment"># mysql -e &quot;SHOW TABLES FROM hellodb&quot;</span></span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">| <span class="built_in">test</span>              |</span><br><span class="line">| toc               |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure>

<p>3.查看Master2的hellodb库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master2 ~]<span class="comment"># mysql -e &quot;SHOW TABLES FROM hellodb&quot;</span></span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">| <span class="built_in">test</span>              |</span><br><span class="line">| toc               |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure>

<p>此处看上好像没问提</p>
<h4 id="测试四、继续插入数据-从看看复制状况"><a href="#测试四、继续插入数据-从看看复制状况" class="headerlink" title="测试四、继续插入数据,从看看复制状况"></a>测试四、继续插入数据,从看看复制状况</h4><p>1.在Master1上继续往hellodb.test表中插入数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master1 ~]<span class="comment"># mysql -e &quot;INSERT hellodb.test VALUE(1,&#x27;Tang San&#x27;);&quot;</span></span><br></pre></td></tr></table></figure>

<p>2.Master2上查看复制状况</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master2 ~]<span class="comment"># mysql</span></span><br><span class="line">MariaDB [(none)]&gt; SELECT * FROM hellodb.test;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#没有复制到数据</span></span><br></pre></td></tr></table></figure>

<p>3.查错</p>
<p>分别查看Master1和Master2主机上的SLAVE STATUS;</p>
<p>Master1状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.111</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mariadb-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 871</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 1018</span><br><span class="line">        Relay_Master_Log_File: mariadb-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 1050</span><br><span class="line">                   Last_Error: Error <span class="string">&#x27;Table &#x27;</span><span class="built_in">test</span><span class="string">&#x27; already exists&#x27;</span> on query. Default database: <span class="string">&#x27;&#x27;</span>. Query: <span class="string">&#x27;CREATE TABLE hellodb.test(id int auto_increment primary key,name  char(20))&#x27;</span></span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 732</span><br><span class="line">              Relay_Log_Space: 1453</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 1050</span><br><span class="line">               Last_SQL_Error: Error <span class="string">&#x27;Table &#x27;</span><span class="built_in">test</span><span class="string">&#x27; already exists&#x27;</span> on query. Default database: <span class="string">&#x27;&#x27;</span>. Query: <span class="string">&#x27;CREATE TABLE hellodb.test(id int auto_increment primary key,name  char(20))&#x27;</span></span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 2</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure>

<p>Master2状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mariadb-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 8360</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 8308</span><br><span class="line">        Relay_Master_Log_File: mariadb-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 1050</span><br><span class="line">                   Last_Error: Error <span class="string">&#x27;Table &#x27;</span><span class="built_in">test</span><span class="string">&#x27; already exists&#x27;</span> on query. Default database: <span class="string">&#x27;&#x27;</span>. Query: <span class="string">&#x27;CREATE TABLE hellodb.test(id int auto_increment primary key,name  char(20))&#x27;</span></span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 8022</span><br><span class="line">              Relay_Log_Space: 8942</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 1050</span><br><span class="line">               Last_SQL_Error: Error <span class="string">&#x27;Table &#x27;</span><span class="built_in">test</span><span class="string">&#x27; already exists&#x27;</span> on query. Default database: <span class="string">&#x27;&#x27;</span>. Query: <span class="string">&#x27;CREATE TABLE hellodb.test(id int auto_increment primary key,name  char(20))&#x27;</span></span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure>

<p>显示出来刚在在创建表时已经复制出错，由于两边同时创建了同一张表发生了冲突</p>
<h5 id="排错"><a href="#排错" class="headerlink" title="排错"></a>排错</h5><p>分别在主从节点上停止线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; STOP SLAVE;</span><br></pre></td></tr></table></figure>

<p>分别在主从节点上使用sql_slave_skip_counter忽略错误</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SET GLOBAL sql_slave_skip_counter=1;</span><br></pre></td></tr></table></figure>

<p>分别在主从节点上再次启动线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br></pre></td></tr></table></figure>

<p>再次在从节点上查test表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master2 ~]<span class="comment"># mysql -e &quot;SELECT * FROM hellodb.test;&quot;</span></span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | Tang San |</span><br><span class="line">+----+----------+</span><br></pre></td></tr></table></figure>

<p>此时数据已经能正常复制过去</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL主从复制</title>
    <url>/2019/04/10/MySQL/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</url>
    <content><![CDATA[<p>所有的关系型数据库都存在一个通病性能差，在企业中如果用户量特别大，将所有的数据都存放在一台服务器上，其性能是远远达不到要求的。所以需要使用一些手段来解决其性能的问题。</p>
<p>提升性能的方式有向上扩展以及向外扩展  </p>
<p>向上扩展(Scale Up)：使用更新更好的硬件，但硬件在怎么更新也有其性能的极限。盲目的向上扩展无法结局根本的问题  </p>
<p>向外扩展(Scale Out)：就是使用多台机器分摊压力来提供服务  </p>
<p>主从复制就是拿多个数据库服务器，组合成一个服务器的集合对外共同服务实现性能的提升，逻辑上使用的时对外扩展的方式(Scale out)来提升服务器的性能。</p>
<span id="more"></span>

<h2 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a>主从复制原理</h2><p>MySQL主从同步一共需要三个线程的操作，主MySQL有一个IO线程，从MySQL有一个IO线程和一个SQL线程， MySQL主从是实现MySQL高可用、数据备份、读写分离架构的一种最常见的解决方案，在绝大部分公司都有使用，要实现MySQL主从复制，必须要在Master打开binary log(bin-log)功能，因为整个MySQL的复制过程实际就是Slave从Master端获取响应的二进制日志，然后在Slave端顺序的执行日志中所记录的各种操作，二进制日志中几乎记录了出select以外的所有针对数据库的sql操作语句，具体的复制过程如下：</p>
<ol>
<li><p>Slave端的IO线程连接上Master，并向Master请求指定日志文件的指定位置（新部署的Master和Slave从最开始的日志）之后的日志。</p>
</li>
<li><p>Master接收到来自Slave的IO线程请求，负责IO复制的IO线程根据Slave的请求信息读取相应的日志内容，然后将本地读取的bin-log的文件名、位置及指定位置之后的内容一起返回给Slave的IO线程处理。</p>
</li>
<li><p>Slave的IO线程将接收到的信息依次添加到Slave端的relay-log文件的最末端，并将读取到的Master端的bin-log的文件名和位置记录到Master-info文件中，以便在下一次读取的时候能够清楚的告诉Master“我需要从哪个bin-log的哪个位置开始往后的日志内容请发给我”。</p>
</li>
<li><p>Slave的sql线程检查到relay-log中新增了内容后，会马上将relay-log中的内容解析为在Master端真实执行时候的可执行命令，并顺序执行，从而保证对Slave的MySQL进行响应的增加或删除等操作，最终实现和Master数据保持一致。</p>
</li>
</ol>
<p><img src="%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86.png" alt="主从复制原理.png"></p>
<h2 id="主从复制架构"><a href="#主从复制架构" class="headerlink" title="主从复制架构"></a>主从复制架构</h2><p><img src="1%E4%B8%BB1%E4%BB%8E.png" alt="1主1从.png"></p>
<p><img src="1%E4%B8%BB%E5%A4%9A%E4%BB%8E.png" alt="1主多从.png"></p>
<p>以下将演示新主机的主从配置和主服务器中已有数据的情况下的主从配置方法</p>
<hr>
<h2 id="新主机搭建主从复制"><a href="#新主机搭建主从复制" class="headerlink" title="新主机搭建主从复制"></a>新主机搭建主从复制</h2><p>使用两台新服务器配置MySQL主从复制。具体配置如下：</p>
<table>
<thead>
<tr>
<th align="left">服务器类型</th>
<th align="left">ip地址</th>
<th align="left">系统</th>
</tr>
</thead>
<tbody><tr>
<td align="left">主</td>
<td align="left">192.168.73.133</td>
<td align="left">CentOS 7.6</td>
</tr>
<tr>
<td align="left">从</td>
<td align="left">192.168.73.145</td>
<td align="left">CentOS 7.6</td>
</tr>
</tbody></table>
<h3 id="主服务器配置"><a href="#主服务器配置" class="headerlink" title="主服务器配置"></a>主服务器配置</h3><p>1.在主服务器上启用二进制日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/mysql/my.cnf</span></span><br><span class="line">log-bin=/data/bin/mysql-bin     <span class="comment">#开启二进制日志</span></span><br><span class="line">binlog-format=row               <span class="comment">#二进制日志记录格式使用row</span></span><br><span class="line">server-id=1                     <span class="comment">#server-id设置为1，此处需要注意主从服务器的server-id必须不同。</span></span><br></pre></td></tr></table></figure>

<p>2.创建二进制日志目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir /data/bin     #由于是新主机当前服务器上没有二进制日志目录需要自己手动创建。</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chown -R mysql.mysql /data/bin      #将二进制日志的属主和属组进行更改。</span></span><br></pre></td></tr></table></figure>

<p>3.重启服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># service mysqld restart    #主服务器配置完毕重启服务</span></span><br><span class="line">Restarting mysqld (via systemctl):                         [  OK  ]</span><br></pre></td></tr></table></figure>

<p>4.创建一个用来让从服务器复制数据的账号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; GRANT REPLICATION SLAVE ON *.* TO repluser@<span class="string">&#x27;192.168.73.%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;centos&#x27;</span>;         <span class="comment">#在主服务器上创建一个用来主从复制的账号</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>5.查看主服务器正在使用的二进制日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW MASTER LOGS;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |       515 |    <span class="comment">#当前二进制文件及位置需要记录，从服务器设置时需要</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="从服务器配置"><a href="#从服务器配置" class="headerlink" title="从服务器配置"></a>从服务器配置</h3><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/mysql/my.cnf</span></span><br><span class="line">server-id       = 2     <span class="comment">#server-id改为和主服务器不同</span></span><br><span class="line">read-only               <span class="comment">#设置为只读，此设置只正对普通用户root无效。</span></span><br><span class="line"><span class="comment">#log-bin=mysql-bin      #将二进制日志关闭</span></span><br></pre></td></tr></table></figure>

<p>2.启动MySQL服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># service mysqld restart        #重启从服务器上的MySQL服务</span></span><br><span class="line">Starting mysqld (via systemctl):                           [  OK  ]</span><br></pre></td></tr></table></figure>

<p>3.关联主服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.73.133&#x27;</span>,MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,MASTER_PASSWORD=<span class="string">&#x27;centos&#x27;</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000001&#x27;</span>,MASTER_LOG_POS=515;</span><br><span class="line"><span class="comment">#使用CHANGE MASTER TO 将从服务器与主服务器进行关联</span></span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>4.查看从服务器状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.73.133</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 515</span><br><span class="line">               Relay_Log_File: localhost-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: No   <span class="comment">#在线程启动后确保IO以及SQL线程是启动的</span></span><br><span class="line">            Slave_SQL_Running: No   <span class="comment">#SQL在线程启动后状态需要为yes</span></span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 515</span><br><span class="line">              Relay_Log_Space: 256</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: NULL       <span class="comment">#和主服务器之间的延迟时间</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 0</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">                   Using_Gtid: No</span><br><span class="line">                  Gtid_IO_Pos:</span><br><span class="line">      Replicate_Do_Domain_Ids:</span><br><span class="line">  Replicate_Ignore_Domain_Ids:</span><br><span class="line">                Parallel_Mode: conservative</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State:</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>5.启动线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;    <span class="comment">#启动复制线程</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>在主服务器上导入一个hellodb数据库，查看服务器主从复制是否配置成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql &lt; hellodb_innodb.sql</span></span><br></pre></td></tr></table></figure>

<p>从服务器上查看是否同步成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |      <span class="comment">#已经有hellodb库</span></span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="主服务器已有数据的情况下搭建主从"><a href="#主服务器已有数据的情况下搭建主从" class="headerlink" title="主服务器已有数据的情况下搭建主从"></a>主服务器已有数据的情况下搭建主从</h2><p>在通常情况下，MySQL搭建主从会在一台已经有数据的mysql服务器基础上，追加一台从服务器，此时如果直接使用原先的方法直接配置主从复制将导致主从同步的时间会很长，此时就需要先将所有的数据备份到从服务器上，然后再配置组从同步。具体配置方法如下：</p>
<h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><table>
<thead>
<tr>
<th align="left">服务器</th>
<th align="left">IP地址</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Master</td>
<td align="left">192.168.73.148</td>
</tr>
<tr>
<td align="left">Slave</td>
<td align="left">192.168.73.149</td>
</tr>
</tbody></table>
<p>Master中的数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">| test1              |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h3 id="配置主服务器"><a href="#配置主服务器" class="headerlink" title="配置主服务器"></a>配置主服务器</h3><p>1.修改主服务器配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin=/data/bin/mysql-bin         <span class="comment">#开启配二进制日志</span></span><br><span class="line">binlog-format=row                   <span class="comment">#日志记录格式设置为row</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl restart mariadb   #重启MySQL</span></span><br></pre></td></tr></table></figure>

<p>2.创建复制账号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -e &quot;GRANT REPLICATION SLAVE ON *.* TO &#x27;repluser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;centos&#x27;;&quot;    #创建一个用来主从复制的账号</span></span><br></pre></td></tr></table></figure>

<p>3.备份主节点中的所有数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysqldump -A --single-transaction -F --master-data=1 &gt; /data/all.sql      #将主机节点上的所有数据使用mysql </span></span><br></pre></td></tr></table></figure>

<p>4.将备份数据传送给从节点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># scp /data/all.sql 192.168.73.149:/data</span></span><br></pre></td></tr></table></figure>

<h3 id="配置从服务器"><a href="#配置从服务器" class="headerlink" title="配置从服务器"></a>配置从服务器</h3><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only</span><br></pre></td></tr></table></figure>

<p>2.清空MySQL数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rm -rf /var/lib/mysql/*</span></span><br></pre></td></tr></table></figure>

<p>3.修改备份数据将chang master to 加入文件中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /data/all.sql</span></span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=<span class="string">&#x27;192.168.73.148&#x27;</span>,</span><br><span class="line">  MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,</span><br><span class="line">  MASTER_PASSWORD=<span class="string">&#x27;centos&#x27;</span>,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000005&#x27;</span>,</span><br><span class="line">  MASTER_LOG_POS=245;</span><br></pre></td></tr></table></figure>

<p>4.启动MySQL服务，并导入备份</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql &lt; /data/all.sql</span></span><br></pre></td></tr></table></figure>

<p>5.查看从节点状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.73.148</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000005</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000005</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 245</span><br><span class="line">              Relay_Log_Space: 245</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 0</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>6.启动线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>7.再次查看从节点状态，复制的2个线程已经启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.148</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000005</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 529</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000005</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 245</span><br><span class="line">              Relay_Log_Space: 825</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>主节点删test1库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; DROP DATABASE  test1;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>从节点查看是否同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)      <span class="comment">#已经没有test1库</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL主从复制出错的解决方法</title>
    <url>/2019/04/10/MySQL/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%87%BA%E9%94%99%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%87%BA%E9%94%99%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>主从复制中若是出现错误可以通过几个方法来进行解决  </p>
<ol>
<li><p>如果主从复制时发生了主键冲突，从而阻止了主从复制，可以使用sql_slave_skip_counter这个变量来忽略错误将其排除  </p>
</li>
<li><p>如果发生了较大的错误，可以考虑使用reset slave的方法重新配置从服务器来恢复错误</p>
</li>
</ol>
<p>以下演示如何使用这两种方法解决错误，及相关操作的详细说明</p>
<span id="more"></span>

<h2 id="reset-slave的使用方法"><a href="#reset-slave的使用方法" class="headerlink" title="reset slave的使用方法"></a>reset slave的使用方法</h2><h3 id="环境准备搭建主从同步"><a href="#环境准备搭建主从同步" class="headerlink" title="环境准备搭建主从同步"></a>环境准备搭建主从同步</h3><h4 id="主节点配置"><a href="#主节点配置" class="headerlink" title="主节点配置"></a>主节点配置</h4><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin=/data/bin/mysql-bin</span><br><span class="line">binlog-format=row</span><br><span class="line">server-id=1</span><br></pre></td></tr></table></figure>

<p>2.创建二进制日志目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mkdir /data/bin</span></span><br><span class="line">[root@Master ~]<span class="comment"># chown -R mysql.mysql /data/bin</span></span><br></pre></td></tr></table></figure>

<p>3.启动mysqld服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<p>4.查看主服务器日志位置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;SHOW MASTER LOGS;&quot;</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |     26753 |</span><br><span class="line">| mysql-bin.000002 |    921736 |</span><br><span class="line">| mysql-bin.000003 |       245 |</span><br><span class="line">+------------------+-----------+</span><br></pre></td></tr></table></figure>

<p>5.创建一个用来复制数据的账户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;GRANT REPLICATION SLAVE ON *.* TO &#x27;repluser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;centos&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="从节点配置"><a href="#从节点配置" class="headerlink" title="从节点配置"></a>从节点配置</h4><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">read-only</span><br><span class="line">server-id=2</span><br></pre></td></tr></table></figure>

<p>2.启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>此处开始构建错误配置</strong>  </p>
<p><strong>以下所有CHANGE MASTER TO配置均为错误</strong></p>
<p>3.配置CHANGE MASTER TO</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;MariaDB [(none)]&gt; CHANGE MASTER TO</span><br><span class="line">   -&gt;   MASTER_HOST=<span class="string">&#x27;master2.mycompany.com&#x27;</span>,</span><br><span class="line">   -&gt;   MASTER_USER=<span class="string">&#x27;replication&#x27;</span>,</span><br><span class="line">   -&gt;   MASTER_PASSWORD=<span class="string">&#x27;bigs3cret&#x27;</span>,</span><br><span class="line">   -&gt;   MASTER_PORT=3306,</span><br><span class="line">   -&gt;   MASTER_LOG_FILE=<span class="string">&#x27;master2-bin.001&#x27;</span>,</span><br><span class="line">   -&gt;   MASTER_LOG_POS=4,</span><br><span class="line">   -&gt;   MASTER_CONNECT_RETRY=10;</span><br><span class="line">&gt;Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>4.查看下SLAVE STATUS</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">&gt;*************************** 1. row ***************************</span><br><span class="line">              Slave_IO_State:</span><br><span class="line">                 Master_Host: master2.mycompany.com</span><br><span class="line">                 Master_User: replication</span><br><span class="line">                 Master_Port: 3306</span><br><span class="line">               Connect_Retry: 10</span><br><span class="line">             Master_Log_File: master2-bin.001</span><br><span class="line">         Read_Master_Log_Pos: 4</span><br><span class="line">              Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">               Relay_Log_Pos: 4</span><br><span class="line">       Relay_Master_Log_File: master2-bin.001</span><br><span class="line">            Slave_IO_Running: No</span><br><span class="line">           Slave_SQL_Running: No</span><br><span class="line">      ...以下省略...</span><br></pre></td></tr></table></figure>

<p>5.启动复制线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;MariaDB [(none)]&gt; START SLAVE;</span><br></pre></td></tr></table></figure>

<p>6.再次查看SLAVE STATUS</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">&gt;*************************** 1. row ***************************</span><br><span class="line">              Slave_IO_State: Connecting to master</span><br><span class="line">                 Master_Host: master2.mycompany.com</span><br><span class="line">                 Master_User: replication</span><br><span class="line">                 Master_Port: 3306</span><br><span class="line">               Connect_Retry: 10</span><br><span class="line">             Master_Log_File: master2-bin.001</span><br><span class="line">         Read_Master_Log_Pos: 4</span><br><span class="line">              Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">               Relay_Log_Pos: 4</span><br><span class="line">       Relay_Master_Log_File: master2-bin.001</span><br><span class="line">            Slave_IO_Running: Connecting</span><br><span class="line">           Slave_SQL_Running: Yes</span><br><span class="line">      ...以下省略...</span><br></pre></td></tr></table></figure>

<p>线程已经正常启动  </p>
<p>主服务器导入数据进行测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;[root@Master ~]<span class="comment"># mysql &lt; hellodb_innodb.sql</span></span><br><span class="line">&gt;[root@Master ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">&gt;+--------------------+</span><br><span class="line">&gt;| Database           |</span><br><span class="line">&gt;+--------------------+</span><br><span class="line">&gt;| information_schema |</span><br><span class="line">&gt;| hellodb            |</span><br><span class="line">&gt;| mysql              |</span><br><span class="line">&gt;| performance_schema |</span><br><span class="line">&gt;| <span class="built_in">test</span>               |</span><br><span class="line">&gt;+--------------------+</span><br></pre></td></tr></table></figure>

<p>从服务器查看是否同步(CHANGE MASTER TO信息不对怎么可能同步)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">&gt;+--------------------+</span><br><span class="line">&gt;| Database           |</span><br><span class="line">&gt;+--------------------+</span><br><span class="line">&gt;| information_schema |</span><br><span class="line">&gt;| mysql              |</span><br><span class="line">&gt;| performance_schema |</span><br><span class="line">&gt;| <span class="built_in">test</span>               |</span><br><span class="line">&gt;+--------------------+</span><br><span class="line">&gt;4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="以下为错误解决方法"><a href="#以下为错误解决方法" class="headerlink" title="以下为错误解决方法"></a>以下为错误解决方法</h4><p>由于错误发生在CHANGE MASTER TO所以此处将CHANG MASTER TO部分纠正就行</p>
<p>1.首先将从服务器的复制线程停止</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; STOP SLAVE;</span><br><span class="line">Query OK, 0 rows affected (17.48 sec)</span><br></pre></td></tr></table></figure>

<p>2.将从服务器上的SLAVE信息重置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; RESET SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>3.重新输入正确的CHANGE MASTER TO信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.73.110&#x27;</span>,MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,MASTER_PASSWORD=<span class="string">&#x27;centos&#x27;</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000003&#x27;</span>,MASTER_LOG_POS=245;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>4.查看SLAVE STATUS;</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 10</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line"><span class="comment">#此处信息已经改为正确</span></span><br></pre></td></tr></table></figure>

<p>5.重新启动线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>6.再次查看SLAVE STATUS;</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 10</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 7384     <span class="comment">#已经有数据复制过来了</span></span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 7668</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line"><span class="comment">#IO和SQL线程已经启动</span></span><br></pre></td></tr></table></figure>

<p>7.查看下从节点内的库是否已经同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |          <span class="comment">#hellodb库已经从主节点中复制过来了</span></span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>其他说明：<br>如果生产中，发生主从节点之间的数据偏差较大并且迟迟不能同步，可以考虑将从服务器全部清除从新配置从服务器。具体配置方法可以参考<a href="https://blog.51cto.com/11886307/2390636">https://blog.51cto.com/11886307/2390636</a></p>
<hr>
<h2 id="关于sql-slave-skip-counter的使用方法"><a href="#关于sql-slave-skip-counter的使用方法" class="headerlink" title="关于sql_slave_skip_counter的使用方法"></a>关于sql_slave_skip_counter的使用方法</h2><p>当发生主键冲突时，从服务器会卡在出错的位置不再进行服务，此种错误一般会出现在主主复制或者从服务器已经占用了某条记录的情况下，此时可以使用此选项来忽略错误。</p>
<h3 id="构建错误"><a href="#构建错误" class="headerlink" title="构建错误"></a>构建错误</h3><p>此处继续沿用刚才的主从复制环境  </p>
<p>1.在从服务器上创建一条记录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; INSERT hellodb.teachers VALUE (5,<span class="string">&#x27;Li Xiaolong&#x27;</span>,30,<span class="string">&#x27;M&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>2.在主服务器上也创建一条主键相同的记录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; INSERT hellodb.teachers VALUE (5,<span class="string">&#x27;Xiao Yan&#x27;</span>,20,<span class="string">&#x27;M&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>3.返回从节点查看SLAVE STATUS</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 10</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 7576</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 7668</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 1062</span><br><span class="line">                   Last_Error: Could not execute Write_rows event on table hellodb.teachers; Duplicate entry <span class="string">&#x27;5&#x27;</span> <span class="keyword">for</span> key <span class="string">&#x27;PRIMARY&#x27;</span>, Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event<span class="string">&#x27;s master log mysql-bin.000003, end_log_pos 7549</span></span><br><span class="line"><span class="string">                 Skip_Counter: 0</span></span><br><span class="line"><span class="string">          Exec_Master_Log_Pos: 7384</span></span><br><span class="line"><span class="string">              Relay_Log_Space: 8156</span></span><br><span class="line"><span class="string">              Until_Condition: None</span></span><br><span class="line"><span class="string">               Until_Log_File:</span></span><br><span class="line"><span class="string">                Until_Log_Pos: 0</span></span><br><span class="line"><span class="string">           Master_SSL_Allowed: No</span></span><br><span class="line"><span class="string">           Master_SSL_CA_File:</span></span><br><span class="line"><span class="string">           Master_SSL_CA_Path:</span></span><br><span class="line"><span class="string">              Master_SSL_Cert:</span></span><br><span class="line"><span class="string">            Master_SSL_Cipher:</span></span><br><span class="line"><span class="string">               Master_SSL_Key:</span></span><br><span class="line"><span class="string">        Seconds_Behind_Master: NULL</span></span><br><span class="line"><span class="string">Master_SSL_Verify_Server_Cert: No</span></span><br><span class="line"><span class="string">                Last_IO_Errno: 0</span></span><br><span class="line"><span class="string">                Last_IO_Error:</span></span><br><span class="line"><span class="string">               Last_SQL_Errno: 1062</span></span><br><span class="line"><span class="string">               Last_SQL_Error: Could not execute Write_rows event on table hellodb.teachers; Duplicate entry &#x27;</span>5<span class="string">&#x27; for key &#x27;</span>PRIMARY<span class="string">&#x27;, Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event&#x27;</span>s master <span class="built_in">log</span> mysql-bin.000003, end_log_pos 7549</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>4.从节点已经出错，在主节点继续添加记录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; INSERT hellodb.teachers VALUE (6,<span class="string">&#x27;Xiao Xuner&#x27;</span>,20,<span class="string">&#x27;M&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>5.此时从节点已经不会再继续从主节点复制信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SELECT * FROM hellodb.teachers WHERE tid&gt;4;</span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">| TID | Name        | Age | Gender |</span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">|   5 | Li Xiaolong |  30 | M      |   <span class="comment">#此为刚才从节点添加的记录</span></span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="排错"><a href="#排错" class="headerlink" title="排错"></a>排错</h3><p>1.使用sql_slave_skip_counter变量忽略错误</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SET GLOBAL sql_slave_skip_counter=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>2.停止线程并重新启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; STOP SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>3.查看slave status状态，此时已经没有报错的信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 10</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 7770</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000003</span><br><span class="line">                Relay_Log_Pos: 529</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 7770</span><br><span class="line">              Relay_Log_Space: 8634</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>4.在从服务器上查看teachers表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SELECT * FROM hellodb.teachers WHERE tid&gt;4;</span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">| TID | Name        | Age | Gender |</span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">|   5 | Li Xiaolong |  30 | M      |</span><br><span class="line">|   6 | Xiao Xuner  |  20 | M      |    <span class="comment">#此时刚才在主节点插入的6号记录已经复制过来</span></span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Mariadb二进制安装</title>
    <url>/2019/04/17/MySQL/MySQL%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/MySQL%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<p>MySQL支持YUM安装，但是很多企业内不使用YUM安装，因为YUM源内所带有的MySQL数据库版本偏老，而且安装完毕后其默认路径并不符合我们的生产需要。所以MySQL安装通常会使用源码编译或二进制安装。</p>
<span id="more"></span>

<h2 id="Mariadb二进制安装"><a href="#Mariadb二进制安装" class="headerlink" title="Mariadb二进制安装"></a>Mariadb二进制安装</h2><p>创建mysql用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># useradd -r mysql</span></span><br></pre></td></tr></table></figure>

<p>下载Mariadb二进制包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># wget https://mirrors.tuna.tsinghua.edu.cn/mariadb//mariadb-10.3.17/bintar-linux-systemd-x86_64/mariadb-10.3.17-linux-systemd-x86_64.tar.gz</span></span><br></pre></td></tr></table></figure>

<p>解压文件到/usr/local目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># tar -xf mariadb-10.3.17-linux-systemd-x86_64.tar.gz -C mariadb-10.3.17-linux-systemd-x86_64</span></span><br></pre></td></tr></table></figure>

<p>为解压后的二进制安装包创建一个软连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cd /usr/local/</span></span><br><span class="line">[root@localhost <span class="built_in">local</span>]<span class="comment"># ln -sv mariadb-10.3.17-linux-systemd-x86_64 mysql</span></span><br></pre></td></tr></table></figure>

<p>修改二进制安装目录的属主和数组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#将二进制安装包内的所有文件的属主和属组改为mysql</span></span><br><span class="line">[root@localhost <span class="built_in">local</span>]<span class="comment"># chown -R mysql.mysql mysql</span></span><br><span class="line">[root@localhost <span class="built_in">local</span>]<span class="comment"># chown -R mysql.mysql mariadb-10.3.17-linux-systemd-x86_64</span></span><br></pre></td></tr></table></figure>

<p>创建MySQL数据目录，修改属主并设置安全权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost <span class="built_in">local</span>]<span class="comment"># mkdir -p /data/mysql</span></span><br><span class="line">[root@localhost <span class="built_in">local</span>]<span class="comment"># chown -R mysql.mysql /data/mysql</span></span><br><span class="line">[root@localhost <span class="built_in">local</span>]<span class="comment"># chmod -R 700 /data/mysql</span></span><br></pre></td></tr></table></figure>

<p>初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># scripts/mysql_install_db --datadir=/data/mysql --user=mysql</span></span><br></pre></td></tr></table></figure>

<p>从二进制安装包内复制配置文件模板</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># cd support-files        #配置文件模板在此路径内</span></span><br><span class="line">[root@localhost support-files]<span class="comment"># mkdir /etc/mysql    #创建配置文件目录</span></span><br><span class="line">[root@localhost support-files]<span class="comment"># cp my-large.cnf /etc/mysql/my.cnf   #复制配置文件</span></span><br></pre></td></tr></table></figure>

<p>对配置文件做修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost support-files]<span class="comment"># vim /etc/mysql/my.cnf</span></span><br><span class="line">...以上省略...</span><br><span class="line">[mysqld]        <span class="comment">#在mysqld字段中添加一行指定MySQL的数据库目录位置</span></span><br><span class="line">datadir         = /data/mysql</span><br></pre></td></tr></table></figure>

<p>为MySQL添加PATH环境变量并读取</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost support-files]<span class="comment"># echo &quot;export PATH=/usr/local/mysql/bin:\$PATH&quot; &gt; /etc/profile.d/mysql.sh</span></span><br><span class="line">[root@localhost support-files]<span class="comment"># source /etc/profile.d/mysql.sh</span></span><br></pre></td></tr></table></figure>

<p>复制服务启动脚本到相应目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost support-files]<span class="comment"># cp mysql.server /etc/rc.d/init.d/mysqld</span></span><br></pre></td></tr></table></figure>

<p>启动mysqld服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost support-files]<span class="comment"># service mysqld start</span></span><br></pre></td></tr></table></figure>

<p>验证3306端口是否启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ss -tnl | grep 3306</span></span><br><span class="line">LISTEN   0         80                        *:3306                   *:*</span><br></pre></td></tr></table></figure>

<p>使用MySQL工具连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql</span></span><br><span class="line">mysql: error <span class="keyword">while</span> loading shared libraries: libncurses.so.5: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment">#连接报错，没有找到libncurses.so.5这个文件，由于当前系统为rhel 8.0，</span></span><br><span class="line"><span class="comment">#libncurses.so.5已经变为libncurses.so.6。需要对其创建一个名为libncurses.so.5</span></span><br><span class="line"><span class="comment">#的软连接指向libncurses.so.6</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># ln -s /usr/lib64/libncurses.so.6 /usr/lib64/libncurses.so.5</span></span><br></pre></td></tr></table></figure>

<p>使用MySQL工具再次连接数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql</span></span><br><span class="line">mysql: error <span class="keyword">while</span> loading shared libraries: libtinfo.so.5: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment">#依旧报错，解决方法同上一部一样</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ln -s /usr/lib64/libtinfo.so.6 /usr/lib64/libtinfo.so.6</span></span><br></pre></td></tr></table></figure>

<p>再次登录MySQL成功登录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 11</span><br><span class="line">Server version: 10.3.17-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上为Mariadb 10.3.17的二进制安装方法</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL半同步复制</title>
    <url>/2019/04/10/MySQL/MySQL%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6/MySQL%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6/</url>
    <content><![CDATA[<p>MySQL的复制方法有异步复制，同步复制，半同步复制。</p>
<p>异步复制：是当用户写入一条记录时，先将数据写入到主节点，然后回复用户一个写入成功的消息，然后慢慢的将数据复制到其背后的其他从节点，这样的好处是效率比较高，但是缺点也是非常明显，主服务器和从服务器的延迟过大并且主服务器突然发生异常，此时就会造成数据的丢失。  </p>
<p>同步复制：是当用户写入一条记录时，主节点将数据写入数据库，然后将数据复制给其后面的其他从节点，当所有的从节点返回数据复制成功后，主节点再回复用户数据接入成功的消息，这样做的好处是，确保了数据的安全性，但损失了效率。  </p>
<span id="more"></span>

<p>半同步复制：是间于同步复制和异步复制之间的一种复制方法，他的工作原理是：当用户执行写操作时，主节点会将数据发送给其后面的其他从节点，只要有一个从节点返回复制成功的消息，主节点就直接返回写入成功，如果主节点背后的从节点迟迟不返回复制成功消息，此时就会有一个超时时长，一旦达到超时时长，主节点就先返回消息告诉用户复制成功，而后将数据继续给从节点复制。</p>
<h2 id="半同步复制的配置方法"><a href="#半同步复制的配置方法" class="headerlink" title="半同步复制的配置方法"></a>半同步复制的配置方法</h2><p>半同步复制要实现方法  </p>
<p>主服务器上安装semi_sync_master.so的插件，并启用，设置好超时的时长</p>
<p>从服务器上安装semi_sync_slave.so的插件，并启用</p>
<p>以下以两台主机来演示半同步复制的配置方法</p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">ip</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Master</td>
<td align="left">192.168.73.110</td>
</tr>
<tr>
<td align="left">Slave</td>
<td align="left">192.168.73.111</td>
</tr>
</tbody></table>
<h3 id="一、配置主从"><a href="#一、配置主从" class="headerlink" title="一、配置主从"></a>一、配置主从</h3><p>要实现MySQL的半同步复制首先要将将MySQL配置为主从模式</p>
<h4 id="Master配置"><a href="#Master配置" class="headerlink" title="Master配置"></a>Master配置</h4><p>1.修改MySQL配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin</span><br><span class="line">binlog-format=row</span><br><span class="line">server-id=1</span><br></pre></td></tr></table></figure>

<p>2.启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># systemctl  start mariadb</span></span><br></pre></td></tr></table></figure>

<p>3.查看二进制日志位置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;SHOW MASTER LOGS;&quot;</span></span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| Log_name           | File_size |</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| mariadb-bin.000001 |       245 |</span><br><span class="line">+--------------------+-----------+</span><br></pre></td></tr></table></figure>

<p>4.创建一个用户用来做主从复制</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;GRANT REPLICATION SLAVE ON *.* TO &#x27;repluser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;centos&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Slave配置"><a href="#Slave配置" class="headerlink" title="Slave配置"></a>Slave配置</h4><p>1.修改MySQL配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin</span><br><span class="line">binlog-format=row</span><br><span class="line">server-id=2</span><br><span class="line">read_only</span><br></pre></td></tr></table></figure>

<p>2.启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<p>3.写入CHANGE MASTER TO</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.73.110&#x27;</span>, MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,MASTER_PASSWORD=<span class="string">&#x27;centos&#x27;</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">&#x27;mariadb-bin.000001&#x27;</span>,MASTER_LOG_POS=245;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>4.启动复制线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>5.查看slave状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mariadb-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 521</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000003</span><br><span class="line">                Relay_Log_Pos: 531</span><br><span class="line">        Relay_Master_Log_File: mariadb-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>1.Master导入数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql &lt; hellodb_innodb.sql</span></span><br><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>2.Slave查看库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>主从同步配置成功，接下来配置半同步</p>
<h3 id="二、配置半同步"><a href="#二、配置半同步" class="headerlink" title="二、配置半同步"></a>二、配置半同步</h3><p>配置半同步前先将主从复制关闭</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># mysql -e &quot;STOP SLAVE;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Master节点配置"><a href="#Master节点配置" class="headerlink" title="Master节点配置"></a>Master节点配置</h4><p>1.在Master节点上安装semisync_master.so的插件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; INSTALL PLUGIN rpl_semi_sync_master SONAME <span class="string">&#x27;semisync_master.so&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>2.查看插件是否已经安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES LIKE <span class="string">&#x27;%semi%&#x27;</span>;</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| Variable_name                      | Value |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_master_enabled       | OFF   |          <span class="comment">#插件是否启用</span></span><br><span class="line">| rpl_semi_sync_master_timeout       | 10000 |          <span class="comment">#半同步的超时时长</span></span><br><span class="line">| rpl_semi_sync_master_trace_level   | 32    |          <span class="comment">#用于开启半同步复制模式时的调试级别</span></span><br><span class="line">| rpl_semi_sync_master_wait_no_slave | ON    |          <span class="comment">#是否允许master 每个事物提交后都要等待slave的receipt信号</span></span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>3.修改配置文件启用插件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin</span><br><span class="line">binlog-format=row</span><br><span class="line">server-id=1</span><br><span class="line">rpl_semi_sync_master_enabled                    <span class="comment">#启用插件</span></span><br></pre></td></tr></table></figure>

<p>4.重启服务，查看插件是否启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># systemctl restart mariadb</span></span><br><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;SHOW VARIABLES LIKE &#x27;%semi%&#x27;&quot;;</span></span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| Variable_name                      | Value |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_master_enabled       | ON    |  <span class="comment">#已经启动</span></span><br><span class="line">| rpl_semi_sync_master_timeout       | 10000 |</span><br><span class="line">| rpl_semi_sync_master_trace_level   | 32    |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave | ON    |</span><br><span class="line">+------------------------------------+-------+</span><br></pre></td></tr></table></figure>

<p>5.设置超时时长</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SET GLOBAL rpl_semi_sync_master_timeout=3000;     <span class="comment">#此处为了方便后续测试将超时时间设置为3秒</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="Slave节点配置"><a href="#Slave节点配置" class="headerlink" title="Slave节点配置"></a>Slave节点配置</h4><p>1.在Slave节点上安装semisync_slave.so插件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; INSTALL PLUGIN rpl_semi_sync_slave SONAME <span class="string">&#x27;semisync_slave.so&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>2.查看插件是否已经安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW VARIABLES LIKE <span class="string">&quot;%semi%&quot;</span>;</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_slave_enabled     | ON    |</span><br><span class="line">| rpl_semi_sync_slave_trace_level | 32    |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>3.修改配置文件启用插件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin</span><br><span class="line">binlog-format=row</span><br><span class="line">server-id=2</span><br><span class="line">read_only</span><br><span class="line">rpl_semi_sync_slave_enabled</span><br></pre></td></tr></table></figure>

<p>4.重启服务，查看插件是否启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># mysql -e &quot;SHOW VARIABLES LIKE &#x27;%semi%&#x27;&quot;;</span></span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_slave_enabled     | ON    |</span><br><span class="line">| rpl_semi_sync_slave_trace_level | 32    |</span><br><span class="line">+---------------------------------+-------+</span><br></pre></td></tr></table></figure>

<p>5.启动复制线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># mysql -e &quot;START SLAVE&quot;;</span></span><br></pre></td></tr></table></figure>

<h4 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h4><p>1.查看主节点的状态，由于没有复制过数据所有数据都为空</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE <span class="string">&#x27;%semi%&#x27;</span>;</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_master_clients               | 1     |</span><br><span class="line">| Rpl_semi_sync_master_net_avg_wait_time     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_wait_time         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_waits             | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_times              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_tx                 | 0     |</span><br><span class="line">| Rpl_semi_sync_master_status                | ON    |</span><br><span class="line">| Rpl_semi_sync_master_timefunc_failures     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_wait_time          | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_waits              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_sessions         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_yes_tx                | 0     |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">14 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>2.查看从节点的状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE <span class="string">&#x27;%semi%&#x27;</span>;</span><br><span class="line">+----------------------------+-------+</span><br><span class="line">| Variable_name              | Value |</span><br><span class="line">+----------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_slave_status | ON    |</span><br><span class="line">+----------------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>1.将从节点网路掐断</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># ifdown ens33</span></span><br></pre></td></tr></table></figure>

<p>2.在主节点添加一条记录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; INSERT hellodb.teachers VALUE (5,<span class="string">&#x27;Tang San&#x27;</span>,20,<span class="string">&#x27;M&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (3.00 sec)</span><br></pre></td></tr></table></figure>

<p>由于无法复制到从服务器，3秒后超时回复用户写入成功</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL的变量和选项</title>
    <url>/2019/04/17/MySQL/MySQL%E5%8F%98%E9%87%8F%E5%92%8C%E9%80%89%E9%A1%B9/MySQL%E5%8F%98%E9%87%8F%E5%92%8C%E9%80%89%E9%A1%B9/</url>
    <content><![CDATA[<h2 id="MySQL的系统数据库"><a href="#MySQL的系统数据库" class="headerlink" title="MySQL的系统数据库"></a>MySQL的系统数据库</h2><p>MySQL刚安装完毕时，默认带有MySQL数据库，performance_scema数据库和information_schema数据库这3个数据库。</p>
<ol>
<li>MySQL是MySQL的核心数据库</li>
<li>performance_scema是MySQL5.5之后新增的数据库，主要用于收集数据库服务器性能参数</li>
<li>information_schema是MySQL5.0之后产生的一个虚拟的数据库，物理上并不存在。</li>
</ol>
<h2 id="MySQL服务器配置"><a href="#MySQL服务器配置" class="headerlink" title="MySQL服务器配置"></a>MySQL服务器配置</h2><p>在MySQL数据库运行时，是跑了一个mysqld的进程，他实质上是由mysqld_safe来调用的，mysql_safe是一个脚本。</p>
<h2 id="mysqld选项、服务器系统变量和服务器状态变量"><a href="#mysqld选项、服务器系统变量和服务器状态变量" class="headerlink" title="mysqld选项、服务器系统变量和服务器状态变量"></a>mysqld选项、服务器系统变量和服务器状态变量</h2><h3 id="mysqld选项"><a href="#mysqld选项" class="headerlink" title="mysqld选项"></a>mysqld选项</h3><p>mysqld选项就是在进程中mysqld后面所跟的各种参数，这些选项都能存放在服务器的配置文件中。</p>
<p>MySQL运行时所使用的选项查看方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用ps -aux | grep mysqld 过滤出mysql的进程，在/app/mysql/bin/mysqld后面所带的各种参数就是MySQL的选项。</span></span><br><span class="line">[root@localhost Packages]<span class="comment"># ps -aux | grep mysqld</span></span><br><span class="line">mysql      9206  0.1  3.5 2275296 144752 ?      Sl   16:09   0:01 /app/mysql/bin/mysqld --basedir=/app/mysql --datadir=/data/mysql --plugin-dir=/app/mysql/lib/plugin --user=mysql --log-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log --pid-file=/data/mysql/localhost.localdomain.pid --socket=/data/mysql/mysql.sock --port=3306</span><br></pre></td></tr></table></figure>

<p>msyqld的选项可以通过命令查询，所列出的为mysqld所支持的选项的默认值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysqld --<span class="built_in">help</span> -v  <span class="comment">#注意mysqld这个命令不在PATH路径中需要使用 ps -aux | grep mysqld 找出路径。</span></span><br></pre></td></tr></table></figure>

<h3 id="MySQL的服务器系统变量"><a href="#MySQL的服务器系统变量" class="headerlink" title="MySQL的服务器系统变量"></a>MySQL的服务器系统变量</h3><p>变量可以在MySQL中使用show variables来进行查看，有些变量即时选项又是变量，变量又分为全局性变量和会话级变量，全局性变量影响了所有登陆的用户，会话级只影响当前的登陆的用户。</p>
<p>详细可以参考mariadb的官方文档：<a href="https://mariadb.com/kb/en/library/full-list-of-mariadb-options-system-and-status-variables/">https://mariadb.com/kb/en/library/full-list-of-mariadb-options-system-and-status-variables/</a></p>
<p>获取系统变量的方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#获取全局性的变量</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取会话级的变量</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW VARIABLES;</span><br></pre></td></tr></table></figure>

<p>变量的设置方法：</p>
<p>变量可以通过在会话窗口中使用 SET 命令进行设置，全局变量和会话级别的变量设置方法不同，具体使用方法如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#设置全局性的变量</span></span><br><span class="line">MariaDB [(none)]&gt; SET GLOBAL system_var_name=value;</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置会话级的变量</span></span><br><span class="line">MariaDB [(none)]&gt; SET system_var_name=value;</span><br></pre></td></tr></table></figure>

<h3 id="系统的状态变量"><a href="#系统的状态变量" class="headerlink" title="系统的状态变量"></a>系统的状态变量</h3><p>系统的状态变量又称为系统的只读变量，里面存放的是系统当前的状态信息</p>
<p>系统状态变量查看方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW STATUS LIKE <span class="string">&#x27;value_name&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>查看系统的启动时间</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW STATUS LIKE <span class="string">&#x27;uptime&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Uptime        | 2602  |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>

<h2 id="服务器相关的一些常用选项、变量和状态变量"><a href="#服务器相关的一些常用选项、变量和状态变量" class="headerlink" title="服务器相关的一些常用选项、变量和状态变量"></a>服务器相关的一些常用选项、变量和状态变量</h2><h3 id="常用选项"><a href="#常用选项" class="headerlink" title="常用选项"></a>常用选项</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">skip_name_resolve       <span class="comment">#禁止把ip地址反向解析成名称建议添加</span></span><br></pre></td></tr></table></figure>

<h3 id="常用变量"><a href="#常用变量" class="headerlink" title="常用变量"></a>常用变量</h3><p>最大连接数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">max_connections         <span class="comment">#最大连接数</span></span><br></pre></td></tr></table></figure>

<p>服务器变量SQL_MODE</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL_MODE:</span><br><span class="line">    NO_AUTO_CREATE_USER         <span class="comment">#禁止授权创建密码为空的用户</span></span><br><span class="line">    NO_ZERO_DATA                <span class="comment">#在严格模式，不允许使用&#x27;0000-00-00&#x27;的时间</span></span><br><span class="line">    ONLY_RULL_GROUP_BY          <span class="comment">#对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么将任务这个SQL是不合法的</span></span><br><span class="line">    NO_BACKSLASH_ESCAPES        <span class="comment">#反斜杠&quot;\&quot;作为普通字符而不是转义字符</span></span><br><span class="line">    PIPES_AS_CONCAT             <span class="comment">#将&quot;||&quot;视为连接操作符而非“或运算符”</span></span><br><span class="line">    TRADITIONAL                 <span class="comment">#当插入表的数据长度超长时不是截断，而是报错</span></span><br></pre></td></tr></table></figure>

<h3 id="常用状态变量"><a href="#常用状态变量" class="headerlink" title="常用状态变量"></a>常用状态变量</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Threads_connected               <span class="comment">#多少线程被连接</span></span><br><span class="line">Threads_created                 <span class="comment">#多少线程被创建</span></span><br><span class="line">Threads_running                 <span class="comment">#多少线程正在运行</span></span><br><span class="line">com_select                      <span class="comment">#当前数据库的查询次数</span></span><br><span class="line">com_insert                      <span class="comment">#表的添加次数</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL安全加固</title>
    <url>/2019/04/17/MySQL/MySQL%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/MySQL%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/</url>
    <content><![CDATA[<p>新安装的MySQL没有经过安全加固时，管理员的账户是空口令，匿名的账号也能登录数据库，此时是非常不安全的  </p>
<span id="more"></span>
<h3 id="匿名用户登录MySQL"><a href="#匿名用户登录MySQL" class="headerlink" title="匿名用户登录MySQL"></a>匿名用户登录MySQL</h3><p>当前MySQL数据库为新安装的数据库，所以使用匿名用户可以进行登录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># mysql -u 1234               #使用匿名用户登录MySQL</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 19</span><br><span class="line">Server version: 10.2.23-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; select user();            <span class="comment">#查看当前的登录用户</span></span><br><span class="line">+----------------+</span><br><span class="line">| user()         |</span><br><span class="line">+----------------+</span><br><span class="line">| 1234@localhost |</span><br><span class="line">+----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure>

<p>不过好在匿名用户的权限不大无法查看到数据库中的内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show databases;           <span class="comment">#查看数据库中的所有库</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>安全起见，新安装的数据库需要进行安全加固</p>
<h3 id="数据库的安全加固"><a href="#数据库的安全加固" class="headerlink" title="数据库的安全加固"></a>数据库的安全加固</h3><p>MySQL安装完毕后需要执行mysql_secure_installaion命令来进行安全的加固</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql_secure_installation</span></span><br><span class="line"><span class="comment">#输入旧的root密码</span></span><br><span class="line">Enter current password <span class="keyword">for</span> root (enter <span class="keyword">for</span> none):</span><br><span class="line"><span class="comment">#是否设置root密码</span></span><br><span class="line">Set root password? [Y/n]</span><br><span class="line">New password:</span><br><span class="line">Re-enter new password:</span><br><span class="line">Password updated successfully!</span><br><span class="line">Reloading privilege tables..</span><br><span class="line"> ... Success!</span><br><span class="line"><span class="comment">#删除匿名用户</span></span><br><span class="line">Remove anonymous users? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"><span class="comment">#禁止root用户远程登陆</span></span><br><span class="line">Disallow root login remotely? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"><span class="comment">#是否删除测试用的数据库</span></span><br><span class="line">Remove <span class="built_in">test</span> database and access to it? [Y/n] y</span><br><span class="line"> - Dropping <span class="built_in">test</span> database...</span><br><span class="line"> ... Success!</span><br><span class="line"> - Removing privileges on <span class="built_in">test</span> database...</span><br><span class="line"> ... Success!</span><br><span class="line"><span class="comment">#是否重新加载权限表</span></span><br><span class="line">Reload privilege tables now? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Cleaning up...</span><br><span class="line"></span><br><span class="line">All <span class="keyword">done</span>!  If you<span class="string">&#x27;ve completed all of the above steps, your MariaDB</span></span><br><span class="line"><span class="string">installation should now be secure.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Thanks for using MariaDB!</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL客户端简单使用</title>
    <url>/2019/04/17/MySQL/MySQL%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/MySQL%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>本节主要说明MySQL的客户端的使用方式</p>
<span id="more"></span>
<h3 id="MySQL账号"><a href="#MySQL账号" class="headerlink" title="MySQL账号"></a>MySQL账号</h3><p>mysql用户账号由两部分组成</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;USERNAME&#x27;</span>@<span class="string">&#x27;HOST&#x27;</span>  </span><br></pre></td></tr></table></figure>

<p>USERNAME：用户名</p>
<p>HOST：限制此用户可以通过哪些远程主机连接MySQL服务器  </p>
<ul>
<li>HOST支持使用通配符”%”，”_”  </li>
<li>%匹配任意长度的任意字符，如192.168.0.0/255.255.0.0 或172.16.%.%  </li>
<li>_匹配任意长度的单个字符。</li>
</ul>
<h3 id="MySQL的登录"><a href="#MySQL的登录" class="headerlink" title="MySQL的登录"></a>MySQL的登录</h3><p>MySQL在登录时需要使用-u指定账号，-p指定密码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># mysql -uroot@localhost -p</span></span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 15</span><br><span class="line">Server version: 10.2.23-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; <span class="built_in">exit</span></span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<p>由于MySQL刚安装好，管理员账号是没有密码的，所以不需要密码也可以登录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># mysql -uroot</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 16</span><br><span class="line">Server version: 10.2.23-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; <span class="built_in">exit</span></span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<p>不光没密码能登陆，连账号都不输入也能登录，MySQL默认使用root登录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 17</span><br><span class="line">Server version: 10.2.23-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br></pre></td></tr></table></figure>

<h3 id="查看当前MySQL登录用户"><a href="#查看当前MySQL登录用户" class="headerlink" title="查看当前MySQL登录用户"></a>查看当前MySQL登录用户</h3><p>登录MySQL后，使用SELECT USER();可以查看当前MySQL的登录用户是谁。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SELECT USER();</span><br><span class="line">+----------------+</span><br><span class="line">| user()         |</span><br><span class="line">+----------------+</span><br><span class="line">| root@localhost |              <span class="comment">#root用户</span></span><br><span class="line">+----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="查看MySQL数据库版本"><a href="#查看MySQL数据库版本" class="headerlink" title="查看MySQL数据库版本"></a>查看MySQL数据库版本</h3><p>登录MySQL后，使用SELECT VERSION();可以查看当前MySQL数据库的版本号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SELECT VERSION();</span><br><span class="line">+---------------------+</span><br><span class="line">| version()           |</span><br><span class="line">+---------------------+</span><br><span class="line">| 10.2.23-MariaDB-log |         <span class="comment">#此为数据库的版本号</span></span><br><span class="line">+---------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="查看MySQL客户端使用帮助"><a href="#查看MySQL客户端使用帮助" class="headerlink" title="查看MySQL客户端使用帮助"></a>查看MySQL客户端使用帮助</h3><p>登录MySQL后使用\h可以查看MySQL客户端的使用帮助</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; \h</span><br><span class="line"></span><br><span class="line">General information about MariaDB can be found at</span><br><span class="line">http://mariadb.org</span><br><span class="line"></span><br><span class="line">List of all MySQL commands:</span><br><span class="line">Note that all text commands must be first on line and end with <span class="string">&#x27;;&#x27;</span></span><br><span class="line">?         (\?) Synonym <span class="keyword">for</span> `<span class="built_in">help</span><span class="string">&#x27;.</span></span><br><span class="line"><span class="string">clear     (\c) Clear the current input statement.</span></span><br><span class="line"><span class="string">connect   (\r) Reconnect to the server. Optional arguments are db and host.</span></span><br><span class="line"><span class="string">delimiter (\d) Set statement delimiter.</span></span><br><span class="line"><span class="string">edit      (\e) Edit command with $EDITOR.</span></span><br><span class="line"><span class="string">ego       (\G) Send command to mysql server, display result vertically.</span></span><br><span class="line"><span class="string">exit      (\q) Exit mysql. Same as quit.</span></span><br><span class="line"><span class="string">go        (\g) Send command to mysql server.</span></span><br><span class="line"><span class="string">help      (\h) Display this help.</span></span><br><span class="line"><span class="string">nopager   (\n) Disable pager, print to stdout.</span></span><br><span class="line"><span class="string">notee     (\t) Don&#x27;</span>t write into outfile.</span><br><span class="line">pager     (\P) Set PAGER [to_pager]. Print the query results via PAGER.</span><br><span class="line"><span class="built_in">print</span>     (\p) Print current <span class="built_in">command</span>.</span><br><span class="line">prompt    (\R) Change your mysql prompt.</span><br><span class="line">quit      (\q) Quit mysql.</span><br><span class="line"><span class="built_in">rehash</span>    (\<span class="comment">#) Rebuild completion hash.</span></span><br><span class="line"><span class="built_in">source</span>    (\.) Execute an SQL script file. Takes a file name as an argument.</span><br><span class="line">status    (\s) Get status information from the server.</span><br><span class="line">system    (\!) Execute a system shell <span class="built_in">command</span>.</span><br><span class="line">tee       (\T) Set outfile [to_outfile]. Append everything into given outfile.</span><br><span class="line">use       (\u) Use another database. Takes database name as argument.</span><br><span class="line">charset   (\C) Switch to another charset. Might be needed <span class="keyword">for</span> processing binlog with multi-byte charsets.</span><br><span class="line">warnings  (\W) Show warnings after every statement.</span><br><span class="line">nowarning (\w) Don<span class="string">&#x27;t show warnings after every statement.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For server side help, type &#x27;</span><span class="built_in">help</span> contents<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="显示用户的状态信息"><a href="#显示用户的状态信息" class="headerlink" title="显示用户的状态信息"></a>显示用户的状态信息</h3><p>在登录后使用STATUS;可以显示当前登录用户的状态信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; status</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 15.1 Distrib 10.2.23-MariaDB, <span class="keyword">for</span> Linux (x86_64) using readline 5.1</span><br><span class="line"></span><br><span class="line">Connection id:        17</span><br><span class="line">Current database:</span><br><span class="line">Current user:        root@localhost</span><br><span class="line">SSL:            Not <span class="keyword">in</span> use</span><br><span class="line">Current pager:        stdout</span><br><span class="line">Using outfile:        <span class="string">&#x27;&#x27;</span></span><br><span class="line">Using delimiter:    ;</span><br><span class="line">Server:            MariaDB</span><br><span class="line">Server version:        10.2.23-MariaDB-log MariaDB Server</span><br><span class="line">Protocol version:    10</span><br><span class="line">Connection:        Localhost via UNIX socket</span><br><span class="line">Server characterset:    latin1</span><br><span class="line">Db     characterset:    latin1</span><br><span class="line">Client characterset:    utf8</span><br><span class="line">Conn.  characterset:    utf8</span><br><span class="line">UNIX socket:        /tmp/mysql.sock         <span class="comment">#此为本机连接的socket文件，由于是本机连接所以不走网路。</span></span><br><span class="line">Uptime:            1 hour 31 min 28 sec</span><br><span class="line"></span><br><span class="line">Threads: 8  Questions: 24  Slow queries: 0  Opens: 17  Flush tables: 1  Open tables: 11  Queries per second avg: 0.004</span><br><span class="line">--------------</span><br></pre></td></tr></table></figure>

<h3 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h3><p>登录数据库后，使用SHOW DATABASES;可以查看MySQL中所有的数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;       <span class="comment">#查看当前数据库中的所有库</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>数据库在磁盘上也是以文件的方式存放的，yum安装的数据库默认存放在/var/lib/mysql目录中，其中information_schema存在于内存中</p>
<h3 id="指定使用哪个数据库"><a href="#指定使用哪个数据库" class="headerlink" title="指定使用哪个数据库"></a>指定使用哪个数据库</h3><p>使用USE加上数据库名字，可以指定使用哪一个数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; USE mysql     <span class="comment">#使用mysql库</span></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [mysql]&gt;        <span class="comment">#此时已经切换至mysql数据库</span></span><br></pre></td></tr></table></figure>

<h3 id="查看当前数据库中的表"><a href="#查看当前数据库中的表" class="headerlink" title="查看当前数据库中的表"></a>查看当前数据库中的表</h3><p>在选中要使用的数据库后可以使用SHOW TABLES;来查看当前库中的所有表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [mysql]&gt; show tables;</span><br><span class="line">+---------------------------+</span><br><span class="line">| Tables_in_mysql           |</span><br><span class="line">+---------------------------+</span><br><span class="line">| column_stats              |</span><br><span class="line">| columns_priv              |</span><br><span class="line">| db                        |</span><br><span class="line">| event                     |</span><br><span class="line">| func                      |</span><br><span class="line">| general_log               |</span><br><span class="line">| gtid_slave_pos            |</span><br><span class="line">| help_category             |</span><br><span class="line">| help_keyword              |</span><br><span class="line">| help_relation             |</span><br><span class="line">| help_topic                |</span><br><span class="line">| host                      |</span><br><span class="line">| index_stats               |</span><br><span class="line">| innodb_index_stats        |</span><br><span class="line">| innodb_table_stats        |</span><br><span class="line">| plugin                    |</span><br><span class="line">| proc                      |</span><br><span class="line">| procs_priv                |</span><br><span class="line">| proxies_priv              |</span><br><span class="line">| roles_mapping             |</span><br><span class="line">| servers                   |</span><br><span class="line">| slow_log                  |</span><br><span class="line">| table_stats               |</span><br><span class="line">| tables_priv               |</span><br><span class="line">| time_zone                 |</span><br><span class="line">| time_zone_leap_second     |</span><br><span class="line">| time_zone_name            |</span><br><span class="line">| time_zone_transition      |</span><br><span class="line">| time_zone_transition_type |</span><br><span class="line">| user                      |</span><br><span class="line">+---------------------------+</span><br><span class="line">30 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="查看表的字段"><a href="#查看表的字段" class="headerlink" title="查看表的字段"></a>查看表的字段</h3><p>查看某表中的所有字段，可以使用DESC命令加上所要查看的表的表名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [mysql]&gt; DESC user;     <span class="comment">#查看user表上的所有字段。</span></span><br><span class="line">+------------------------+-----------------------------------+------+-----+----------+-------+</span><br><span class="line">| Field                  | Type                              | Null | Key | Default  | Extra |</span><br><span class="line">+------------------------+-----------------------------------+------+-----+----------+-------+</span><br><span class="line">| Host                   | char(60)                          | NO   | PRI |          |       |</span><br><span class="line">| User                   | char(80)                          | NO   | PRI |          |       |</span><br><span class="line">| Password               | char(41)                          | NO   |     |          |       |</span><br><span class="line">| Select_priv            | enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     | NO   |     | N        |       |</span><br><span class="line">| Insert_priv            | enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     | NO   |     | N        |       |</span><br><span class="line">| Update_priv            | enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     | NO   |     | N        |       |</span><br><span class="line">| Delete_priv            | enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     | NO   |     | N        |       |</span><br><span class="line">| Create_priv            | enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     | NO   |     | N        |       |</span><br><span class="line">| Drop_priv              | enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     | NO   |     | N        |       |</span><br><span class="line">| Reload_priv            | enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     | NO   |     | N        |       |</span><br><span class="line">| Shutdown_priv          | enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     | NO   |     | N        |       |</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<h3 id="查看表中指定字段的信息"><a href="#查看表中指定字段的信息" class="headerlink" title="查看表中指定字段的信息"></a>查看表中指定字段的信息</h3><p>使用select命令，指定字段的名称和所要查询的表，可以从表中查看所要查看的字段信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [mysql]&gt; select host,user,password from user;       <span class="comment">#从user表中查看host,user,password这几个字段的信息</span></span><br><span class="line">+-----------------------+------+----------+</span><br><span class="line">| host                  | user | password |</span><br><span class="line">+-----------------------+------+----------+</span><br><span class="line">| localhost             | root |          | <span class="comment">#password为空表示为无密码</span></span><br><span class="line">| localhost.localdomain | root |          |</span><br><span class="line">| 127.0.0.1             | root |          |</span><br><span class="line">| ::1                   | root |          |</span><br><span class="line">| localhost             |      |          | <span class="comment">#user为空表示为匿名用户</span></span><br><span class="line">| localhost.localdomain |      |          |</span><br><span class="line">+-----------------------+------+----------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="MySQL的命令执行方法"><a href="#MySQL的命令执行方法" class="headerlink" title="MySQL的命令执行方法"></a>MySQL的命令执行方法</h3><p>MySQL除了交互式状态下执行命令，还支持非交互式状态下执行命令</p>
<p>使用重定向执行MySQL命令  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat test.sql    #将所有要执行的MySQL命令写入一个文件中</span></span><br><span class="line">SHOW DATABASES;</span><br><span class="line">SELECT USER();</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># mysql &lt; test.sql    #使用重定向将文件导入</span></span><br><span class="line">Database</span><br><span class="line">information_schema</span><br><span class="line">mysql</span><br><span class="line">performance_schema</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">USER()</span><br><span class="line">root@localhost</span><br></pre></td></tr></table></figure>

<p>使用-e选项执行MySQL命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;SELECT USER();&quot;    #使用-e选项后面添加需要执行的MySQL命令</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">+----------------+</span><br><span class="line">| USER()         |</span><br><span class="line">+----------------+</span><br><span class="line">| root@localhost |</span><br><span class="line">+----------------+</span><br></pre></td></tr></table></figure>

<p>除了非交互式状态，MySQL还能在交互式状态下使用source调取系统的文件作为命令来使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql       #登陆MySQL</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 16</span><br><span class="line">Server version: 10.3.17-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; <span class="built_in">source</span> test.sql       <span class="comment">#执行source命令，读取本地文件。</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"></span><br><span class="line">+----------------+</span><br><span class="line">| USER()         |</span><br><span class="line">+----------------+</span><br><span class="line">| root@localhost |</span><br><span class="line">+----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="MySQL的登陆时默认数据库"><a href="#MySQL的登陆时默认数据库" class="headerlink" title="MySQL的登陆时默认数据库"></a>MySQL的登陆时默认数据库</h3><p>MySQL在登陆的时候使用-D 加上数据库名，还可以指定默认的数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#MySQL在登录时默认不会指定任何数据库</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 16</span><br><span class="line">Server version: 10.3.17-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;       <span class="comment">#数据库为none</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用-D选项指定MySQL登录时的默认数据库</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mysql -D mysql      #指定mysql库为登录时的默认库</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 17</span><br><span class="line">Server version: 10.3.17-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [mysql]&gt;        <span class="comment">#默认数据库为mysql</span></span><br></pre></td></tr></table></figure>

<h3 id="MySQL的客户端配置文件"><a href="#MySQL的客户端配置文件" class="headerlink" title="MySQL的客户端配置文件"></a>MySQL的客户端配置文件</h3><p>MySQL的客户端配置文件在/etc/my.cnf.d/mysql-clients.cnf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#客户端的相关配置</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/my.cnf.d/mysql-clients.cnf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># These groups are read by MariaDB command-line tools</span></span><br><span class="line"><span class="comment"># Use it for options that affect only one utility</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"></span><br><span class="line">[mysql_upgrade]</span><br><span class="line"></span><br><span class="line">[mysqladmin]</span><br><span class="line"></span><br><span class="line">[mysqlbinlog]</span><br><span class="line"></span><br><span class="line">[mysqlcheck]</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line"></span><br><span class="line">[mysqlimport]</span><br><span class="line"></span><br><span class="line">[mysqlshow]</span><br><span class="line"></span><br><span class="line">[mysqlslap]</span><br></pre></td></tr></table></figure>

<h3 id="MySQL客户端更改提示符"><a href="#MySQL客户端更改提示符" class="headerlink" title="MySQL客户端更改提示符"></a>MySQL客户端更改提示符</h3><p>MySQL客户端也和linux的客户端一样可以对提示符进行修改，需要在MySQL中使用prompt命令加上相关的参数进行修改  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; prompt \u@[\D \r:\m:\s]</span><br><span class="line">PROMPT <span class="built_in">set</span> to <span class="string">&#x27;\u@[\D \r:\m:\s]&#x27;</span></span><br><span class="line">root@[Wed Sep  4 14:35:22 2019 02:35:22]</span><br></pre></td></tr></table></figure>

<p>在命令行所作的配置只是零时有效，若要长期有效还是需要写入配置文件中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#将修改要修改的内容写入客户端配置文件中</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/my.cnf.d/mysql-clients.cnf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># These groups are read by MariaDB command-line tools</span></span><br><span class="line"><span class="comment"># Use it for options that affect only one utility</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">prompt=(\\u@\\h) [\\d]&gt;\\</span><br><span class="line"><span class="comment">#保存后退出</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#再次登录后观察提示符</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 11</span><br><span class="line">Server version: 10.3.17-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">(root@localhost) [(none)]&gt;      <span class="comment">#此时命令提示符变为配置文件中定义的。</span></span><br></pre></td></tr></table></figure>

<p>在登陆时使用–print-defaults查看客户端登陆时默认所带的选项</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql --print-defaults</span></span><br><span class="line">mysql would have been started with the following arguments:</span><br><span class="line">--prompt=(\u@\h) [\d]&gt;\ --port=3306 --socket=/tmp/mysql.sock --no-auto-rehash</span><br></pre></td></tr></table></figure>

<h3 id="MySQL的服务器端配置文件"><a href="#MySQL的服务器端配置文件" class="headerlink" title="MySQL的服务器端配置文件"></a>MySQL的服务器端配置文件</h3><p>MySQL的服务器端配置文件为类ini格式配置文件</p>
<p>MySQL的配置文件在读取时是有先后顺序的，后读取的配置会将之间的配置进行覆盖，MySQL的配置文件读取数据如下：</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/etc/my.cnf                 <span class="comment">#Global选项</span></span><br><span class="line">/etc/mysql/my.cnf           <span class="comment">#Global选项</span></span><br><span class="line">SYSCONFDIR/my.cnf           <span class="comment">#Global选项</span></span><br><span class="line"><span class="variable">$MYSQL_HOME</span>/my.cnf          <span class="comment">#Server-specific 选项</span></span><br><span class="line">--defaults-extra-file=path</span><br><span class="line">~/.my.cnf                   <span class="comment">#User-specific 选项</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库的操作</title>
    <url>/2019/04/18/MySQL/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%93%8D%E4%BD%9C/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>数据库的操作包括数据库的创建，修改及删除。数据库创建时的字符集设定以及数据库创建完毕后默认字符集更改等等。</p>
<span id="more"></span>

<h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><p>创建数据库的命令为CREATE DATABASE，数据库创建时需要设定字符集，默认使用的为latin1，需要将其改为utf8mb4。</p>
<p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CREATE &#123;DATABASE | SCHEMA&#125; [IF NOT EXISTS] db_name</span><br><span class="line">    [create_specification] ...</span><br><span class="line"></span><br><span class="line">create_specification:</span><br><span class="line">    [DEFAULT] CHARACTER SET [=] charset_name    <span class="comment">#设定字符集</span></span><br><span class="line">  | [DEFAULT] COLLATE [=] collation_name</span><br></pre></td></tr></table></figure>

<p>示例一：</p>
<p>创建数据库不指定字符集</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建一个名字为db3308的数据库</span></span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE db3308;</span><br><span class="line">Query OK, 1 row affected (0.001 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据库是否被创建出来</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| db3308             |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.011 sec)</span><br></pre></td></tr></table></figure>

<p>示例二：</p>
<p>创建数据库指定字符集</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建一个名字为db2的数据库并指定字符集为utf8mb4</span></span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE db2 CHARACTER SET utf8mb4;</span><br><span class="line">Query OK, 1 row affected (0.002 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据库是否被创建</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| db2                |</span><br><span class="line">| db3308             |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.012 sec)</span><br></pre></td></tr></table></figure>

<h3 id="数据库的字符集"><a href="#数据库的字符集" class="headerlink" title="数据库的字符集"></a>数据库的字符集</h3><p>MySQL在创建数据库时可以指定数据库的字符集，不通的字符集可以支持不同的语言。MySQL中可用字符集可以通过SHOW CHARACTER SET进行查看，默认创建出的数据库字符集为latin1，目前最新的字符集已经可以支持表情符号，所以目前推荐设计数据库时使用的字符集为utf8mb4。</p>
<p>查看MySQL数据库所支持的所有字符集</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW CHARACTER SET;</span><br><span class="line">+----------+-----------------------------+---------------------+--------+</span><br><span class="line">| Charset  | Description                 | Default collation   | Maxlen |</span><br><span class="line">+----------+-----------------------------+---------------------+--------+</span><br><span class="line">| big5     | Big5 Traditional Chinese    | big5_chinese_ci     |      2 |</span><br><span class="line">| dec8     | DEC West European           | dec8_swedish_ci     |      1 |</span><br><span class="line">| cp850    | DOS West European           | cp850_general_ci    |      1 |</span><br><span class="line">| hp8      | HP West European            | hp8_english_ci      |      1 |</span><br><span class="line">| koi8r    | KOI8-R Relcom Russian       | koi8r_general_ci    |      1 |</span><br><span class="line">| latin1   | cp1252 West European        | latin1_swedish_ci   |      1 |</span><br><span class="line">| latin2   | ISO 8859-2 Central European | latin2_general_ci   |      1 |</span><br><span class="line">| swe7     | 7bit Swedish                | swe7_swedish_ci     |      1 |</span><br><span class="line">| ascii    | US ASCII                    | ascii_general_ci    |      1 |</span><br><span class="line">| ujis     | EUC-JP Japanese             | ujis_japanese_ci    |      3 |</span><br><span class="line">| sjis     | Shift-JIS Japanese          | sjis_japanese_ci    |      2 |</span><br><span class="line">| hebrew   | ISO 8859-8 Hebrew           | hebrew_general_ci   |      1 |</span><br><span class="line">| tis620   | TIS620 Thai                 | tis620_thai_ci      |      1 |</span><br><span class="line">| euckr    | EUC-KR Korean               | euckr_korean_ci     |      2 |</span><br><span class="line">| koi8u    | KOI8-U Ukrainian            | koi8u_general_ci    |      1 |</span><br><span class="line">| gb2312   | GB2312 Simplified Chinese   | gb2312_chinese_ci   |      2 |</span><br><span class="line">| greek    | ISO 8859-7 Greek            | greek_general_ci    |      1 |</span><br><span class="line">| cp1250   | Windows Central European    | cp1250_general_ci   |      1 |</span><br><span class="line">| gbk      | GBK Simplified Chinese      | gbk_chinese_ci      |      2 |</span><br><span class="line">| latin5   | ISO 8859-9 Turkish          | latin5_turkish_ci   |      1 |</span><br><span class="line">| armscii8 | ARMSCII-8 Armenian          | armscii8_general_ci |      1 |</span><br><span class="line">| utf8     | UTF-8 Unicode               | utf8_general_ci     |      3 |</span><br><span class="line">| ucs2     | UCS-2 Unicode               | ucs2_general_ci     |      2 |</span><br><span class="line">| cp866    | DOS Russian                 | cp866_general_ci    |      1 |</span><br><span class="line">| keybcs2  | DOS Kamenicky Czech-Slovak  | keybcs2_general_ci  |      1 |</span><br><span class="line">| macce    | Mac Central European        | macce_general_ci    |      1 |</span><br><span class="line">| macroman | Mac West European           | macroman_general_ci |      1 |</span><br><span class="line">| cp852    | DOS Central European        | cp852_general_ci    |      1 |</span><br><span class="line">| latin7   | ISO 8859-13 Baltic          | latin7_general_ci   |      1 |</span><br><span class="line">| utf8mb4  | UTF-8 Unicode               | utf8mb4_general_ci  |      4 |</span><br><span class="line">| cp1251   | Windows Cyrillic            | cp1251_general_ci   |      1 |</span><br><span class="line">| utf16    | UTF-16 Unicode              | utf16_general_ci    |      4 |</span><br><span class="line">| utf16le  | UTF-16LE Unicode            | utf16le_general_ci  |      4 |</span><br><span class="line">| cp1256   | Windows Arabic              | cp1256_general_ci   |      1 |</span><br><span class="line">| cp1257   | Windows Baltic              | cp1257_general_ci   |      1 |</span><br><span class="line">| utf32    | UTF-32 Unicode              | utf32_general_ci    |      4 |</span><br><span class="line">| binary   | Binary pseudo charset       | binary              |      1 |</span><br><span class="line">| geostd8  | GEOSTD8 Georgian            | geostd8_general_ci  |      1 |</span><br><span class="line">| cp932    | SJIS <span class="keyword">for</span> Windows Japanese   | cp932_japanese_ci   |      2 |</span><br><span class="line">| eucjpms  | UJIS <span class="keyword">for</span> Windows Japanese   | eucjpms_japanese_ci |      3 |</span><br><span class="line">+----------+-----------------------------+---------------------+--------+</span><br><span class="line">40 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.012 sec)</span><br></pre></td></tr></table></figure>

<p>查看数据库字符集可以使用SHOW CREATE DATABASE命令进行查看，让我们查看下刚才所创建的2个数据库的字符集分别是什么</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#刚才在创建db3308时没有指定字符集，查看下其所创建出来的数据的默认字符集是什么</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW CREATE DATABASE db3308;</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                   |</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">| db3308   | CREATE DATABASE `db3308` /*!40100 DEFAULT CHARACTER SET latin1 */ |    <span class="comment">#默认字符集为latin1</span></span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.008 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建db2数据库时，指定的字符集为utf8mb4，查看下其数据库的字符集是否为指定的字符集</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW CREATE DATABASE db2;</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                 |</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| db2      | CREATE DATABASE `db2` /*!40100 DEFAULT CHARACTER SET utf8mb4 */ |      <span class="comment">#默认字符集为utf8mb4</span></span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>除了以上方法查看数据库字符集，还可以直接通过查询数据库目录内的文件查询出数据库的字符集</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看数据库db3308目录内db.opt文件内的内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /data/mysql/db3308/db.opt</span></span><br><span class="line">default-character-set=latin1    <span class="comment">#默认字符集为latin1</span></span><br><span class="line">default-collation=latin1_swedish_ci   <span class="comment">#字符的排序规则</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#产看数据库db2目录内db.opt文件的内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /data/mysql/db2/db.opt</span></span><br><span class="line">default-character-set=utf8mb4   <span class="comment">#设定默认字符集为utf8mb4</span></span><br><span class="line">default-collation=utf8mb4_general_ci    <span class="comment">#此为字符集的排序规则</span></span><br></pre></td></tr></table></figure>

<p>使用SHOW COLLATION可以查看字符集的排序规则，每种字符集有各种不同的排序方法，可以查看他们的排序方法然后在创建数据库的时候进行设定</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看所有字符集的排序规则</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW COLLATION;</span><br><span class="line">+------------------------------+----------+------+---------+----------+---------+</span><br><span class="line">| Collation                    | Charset  | Id   | Default | Compiled | Sortlen |</span><br><span class="line">+------------------------------+----------+------+---------+----------+---------+</span><br><span class="line">| big5_chinese_ci              | big5     |    1 | Yes     | Yes      |       1 |</span><br><span class="line">| big5_bin                     | big5     |   84 |         | Yes      |       1 |</span><br><span class="line">| big5_chinese_nopad_ci        | big5     | 1025 |         | Yes      |       1 |</span><br><span class="line">| big5_nopad_bin               | big5     | 1108 |         | Yes      |       1 |</span><br><span class="line">| dec8_swedish_ci              | dec8     |    3 | Yes     | Yes      |       1 |</span><br><span class="line">| dec8_bin                     | dec8     |   69 |         | Yes      |       1 |</span><br><span class="line">| dec8_swedish_nopad_ci        | dec8     | 1027 |         | Yes      |       1 |</span><br><span class="line">| dec8_nopad_bin               | dec8     | 1093 |         | Yes      |       1 |</span><br><span class="line">| cp850_general_ci             | cp850    |    4 | Yes     | Yes      |       1 |</span><br><span class="line">| cp850_bin                    | cp850    |   80 |         | Yes      |       1 |</span><br><span class="line">| cp850_general_nopad_ci       | cp850    | 1028 |         | Yes      |       1 |</span><br><span class="line">| cp850_nopad_bin              | cp850    | 1104 |         | Yes      |       1 |</span><br><span class="line">| hp8_english_ci               | hp8      |    6 | Yes     | Yes      |       1 |</span><br><span class="line">| hp8_bin                      | hp8      |   72 |         | Yes      |       1 |</span><br><span class="line">| hp8_english_nopad_ci         | hp8      | 1030 |         | Yes      |       1 |</span><br><span class="line">| hp8_nopad_bin                | hp8      | 1096 |         | Yes      |       1 |</span><br><span class="line">| koi8r_general_ci             | koi8r    |    7 | Yes     | Yes      |       1 |</span><br><span class="line">| koi8r_bin                    | koi8r    |   74 |         | Yes      |       1 |</span><br><span class="line">| koi8r_general_nopad_ci       | koi8r    | 1031 |         | Yes      |       1 |</span><br><span class="line">| koi8r_nopad_bin              | koi8r    | 1098 |         | Yes      |       1 |</span><br><span class="line">| latin1_german1_ci            | latin1   |    5 |         | Yes      |       1 |</span><br><span class="line">| latin1_swedish_ci            | latin1   |    8 | Yes     | Yes      |       1 |</span><br><span class="line">| latin1_danish_ci             | latin1   |   15 |         | Yes      |       1 |</span><br><span class="line">| latin1_german2_ci            | latin1   |   31 |         | Yes      |       2 |</span><br><span class="line">| latin1_bin                   | latin1   |   47 |         | Yes      |       1 |</span><br><span class="line">| latin1_general_ci            | latin1   |   48 |         | Yes      |       1 |</span><br><span class="line">| latin1_general_cs            | latin1   |   49 |         | Yes      |       1 |</span><br><span class="line">| latin1_spanish_ci            | latin1   |   94 |         | Yes      |       1 |</span><br><span class="line">| latin1_swedish_nopad_ci      | latin1   | 1032 |         | Yes      |       1 |</span><br><span class="line">| latin1_nopad_bin             | latin1   | 1071 |         | Yes      |       1 |</span><br><span class="line">| latin2_czech_cs              | latin2   |    2 |         | Yes      |       4 |</span><br><span class="line">| latin2_general_ci            | latin2   |    9 | Yes     | Yes      |       1 |</span><br><span class="line">| latin2_hungarian_ci          | latin2   |   21 |         | Yes      |       1 |</span><br><span class="line">| latin2_croatian_ci           | latin2   |   27 |         | Yes      |       1 |</span><br><span class="line">| latin2_bin                   | latin2   |   77 |         | Yes      |       1 |</span><br><span class="line">| latin2_general_nopad_ci      | latin2   | 1033 |         | Yes      |       1 |</span><br><span class="line">| latin2_nopad_bin             | latin2   | 1101 |         | Yes      |       1 |</span><br><span class="line">| swe7_swedish_ci              | swe7     |   10 | Yes     | Yes      |       1 |</span><br><span class="line">| swe7_bin                     | swe7     |   82 |         | Yes      |       1 |</span><br><span class="line">| swe7_swedish_nopad_ci        | swe7     | 1034 |         | Yes      |       1 |</span><br><span class="line">| swe7_nopad_bin               | swe7     | 1106 |         | Yes      |       1 |</span><br><span class="line">| ascii_general_ci             | ascii    |   11 | Yes     | Yes      |       1 |</span><br><span class="line">| ascii_bin                    | ascii    |   65 |         | Yes      |       1 |</span><br><span class="line">| ascii_general_nopad_ci       | ascii    | 1035 |         | Yes      |       1 |</span><br><span class="line">| ascii_nopad_bin              | ascii    | 1089 |         | Yes      |       1 |</span><br><span class="line">| ujis_japanese_ci             | ujis     |   12 | Yes     | Yes      |       1 |</span><br><span class="line">| ujis_bin                     | ujis     |   91 |         | Yes      |       1 |</span><br><span class="line">| ujis_japanese_nopad_ci       | ujis     | 1036 |         | Yes      |       1 |</span><br><span class="line">| ujis_nopad_bin               | ujis     | 1115 |         | Yes      |       1 |</span><br><span class="line">| sjis_japanese_ci             | sjis     |   13 | Yes     | Yes      |       1 |</span><br><span class="line">| sjis_bin                     | sjis     |   88 |         | Yes      |       1 |</span><br><span class="line">| sjis_japanese_nopad_ci       | sjis     | 1037 |         | Yes      |       1 |</span><br><span class="line">| sjis_nopad_bin               | sjis     | 1112 |         | Yes      |       1 |</span><br><span class="line">| hebrew_general_ci            | hebrew   |   16 | Yes     | Yes      |       1 |</span><br><span class="line">| hebrew_bin                   | hebrew   |   71 |         | Yes      |       1 |</span><br><span class="line">| hebrew_general_nopad_ci      | hebrew   | 1040 |         | Yes      |       1 |</span><br><span class="line">| hebrew_nopad_bin             | hebrew   | 1095 |         | Yes      |       1 |</span><br><span class="line">| tis620_thai_ci               | tis620   |   18 | Yes     | Yes      |       4 |</span><br><span class="line">| tis620_bin                   | tis620   |   89 |         | Yes      |       1 |</span><br><span class="line">| tis620_thai_nopad_ci         | tis620   | 1042 |         | Yes      |       4 |</span><br><span class="line">| tis620_nopad_bin             | tis620   | 1113 |         | Yes      |       1 |</span><br><span class="line">| euckr_korean_ci              | euckr    |   19 | Yes     | Yes      |       1 |</span><br><span class="line">| euckr_bin                    | euckr    |   85 |         | Yes      |       1 |</span><br><span class="line">| euckr_korean_nopad_ci        | euckr    | 1043 |         | Yes      |       1 |</span><br><span class="line">| euckr_nopad_bin              | euckr    | 1109 |         | Yes      |       1 |</span><br><span class="line">| koi8u_general_ci             | koi8u    |   22 | Yes     | Yes      |       1 |</span><br><span class="line">| koi8u_bin                    | koi8u    |   75 |         | Yes      |       1 |</span><br><span class="line">| koi8u_general_nopad_ci       | koi8u    | 1046 |         | Yes      |       1 |</span><br><span class="line">| koi8u_nopad_bin              | koi8u    | 1099 |         | Yes      |       1 |</span><br><span class="line">| gb2312_chinese_ci            | gb2312   |   24 | Yes     | Yes      |       1 |</span><br><span class="line">| gb2312_bin                   | gb2312   |   86 |         | Yes      |       1 |</span><br><span class="line">| gb2312_chinese_nopad_ci      | gb2312   | 1048 |         | Yes      |       1 |</span><br><span class="line">| gb2312_nopad_bin             | gb2312   | 1110 |         | Yes      |       1 |</span><br><span class="line">| greek_general_ci             | greek    |   25 | Yes     | Yes      |       1 |</span><br><span class="line">| greek_bin                    | greek    |   70 |         | Yes      |       1 |</span><br><span class="line">| greek_general_nopad_ci       | greek    | 1049 |         | Yes      |       1 |</span><br><span class="line">| greek_nopad_bin              | greek    | 1094 |         | Yes      |       1 |</span><br><span class="line">| cp1250_general_ci            | cp1250   |   26 | Yes     | Yes      |       1 |</span><br><span class="line">| cp1250_czech_cs              | cp1250   |   34 |         | Yes      |       2 |</span><br><span class="line">| cp1250_croatian_ci           | cp1250   |   44 |         | Yes      |       1 |</span><br><span class="line">| cp1250_bin                   | cp1250   |   66 |         | Yes      |       1 |</span><br><span class="line">| cp1250_polish_ci             | cp1250   |   99 |         | Yes      |       1 |</span><br><span class="line">| cp1250_general_nopad_ci      | cp1250   | 1050 |         | Yes      |       1 |</span><br><span class="line">| cp1250_nopad_bin             | cp1250   | 1090 |         | Yes      |       1 |</span><br><span class="line">| gbk_chinese_ci               | gbk      |   28 | Yes     | Yes      |       1 |</span><br><span class="line">| gbk_bin                      | gbk      |   87 |         | Yes      |       1 |</span><br><span class="line">| gbk_chinese_nopad_ci         | gbk      | 1052 |         | Yes      |       1 |</span><br><span class="line">| gbk_nopad_bin                | gbk      | 1111 |         | Yes      |       1 |</span><br><span class="line">| latin5_turkish_ci            | latin5   |   30 | Yes     | Yes      |       1 |</span><br><span class="line">| latin5_bin                   | latin5   |   78 |         | Yes      |       1 |</span><br><span class="line">| latin5_turkish_nopad_ci      | latin5   | 1054 |         | Yes      |       1 |</span><br><span class="line">| latin5_nopad_bin             | latin5   | 1102 |         | Yes      |       1 |</span><br><span class="line">| armscii8_general_ci          | armscii8 |   32 | Yes     | Yes      |       1 |</span><br><span class="line">| armscii8_bin                 | armscii8 |   64 |         | Yes      |       1 |</span><br><span class="line">| armscii8_general_nopad_ci    | armscii8 | 1056 |         | Yes      |       1 |</span><br><span class="line">| armscii8_nopad_bin           | armscii8 | 1088 |         | Yes      |       1 |</span><br><span class="line">| utf8_general_ci              | utf8     |   33 | Yes     | Yes      |       1 |</span><br><span class="line">| utf8_bin                     | utf8     |   83 |         | Yes      |       1 |</span><br><span class="line">| utf8_unicode_ci              | utf8     |  192 |         | Yes      |       8 |</span><br><span class="line">| utf8_icelandic_ci            | utf8     |  193 |         | Yes      |       8 |</span><br><span class="line">| utf8_latvian_ci              | utf8     |  194 |         | Yes      |       8 |</span><br><span class="line">| utf8_romanian_ci             | utf8     |  195 |         | Yes      |       8 |</span><br><span class="line">| utf8_slovenian_ci            | utf8     |  196 |         | Yes      |       8 |</span><br><span class="line">| utf8_polish_ci               | utf8     |  197 |         | Yes      |       8 |</span><br><span class="line">| utf8_estonian_ci             | utf8     |  198 |         | Yes      |       8 |</span><br><span class="line">| utf8_spanish_ci              | utf8     |  199 |         | Yes      |       8 |</span><br><span class="line">| utf8_swedish_ci              | utf8     |  200 |         | Yes      |       8 |</span><br><span class="line">| utf8_turkish_ci              | utf8     |  201 |         | Yes      |       8 |</span><br><span class="line">| utf8_czech_ci                | utf8     |  202 |         | Yes      |       8 |</span><br><span class="line">| utf8_danish_ci               | utf8     |  203 |         | Yes      |       8 |</span><br><span class="line">| utf8_lithuanian_ci           | utf8     |  204 |         | Yes      |       8 |</span><br><span class="line">| utf8_slovak_ci               | utf8     |  205 |         | Yes      |       8 |</span><br><span class="line">| utf8_spanish2_ci             | utf8     |  206 |         | Yes      |       8 |</span><br><span class="line">| utf8_roman_ci                | utf8     |  207 |         | Yes      |       8 |</span><br><span class="line">| utf8_persian_ci              | utf8     |  208 |         | Yes      |       8 |</span><br><span class="line">| utf8_esperanto_ci            | utf8     |  209 |         | Yes      |       8 |</span><br><span class="line">| utf8_hungarian_ci            | utf8     |  210 |         | Yes      |       8 |</span><br><span class="line">| utf8_sinhala_ci              | utf8     |  211 |         | Yes      |       8 |</span><br><span class="line">| utf8_german2_ci              | utf8     |  212 |         | Yes      |       8 |</span><br><span class="line">| utf8_croatian_mysql561_ci    | utf8     |  213 |         | Yes      |       8 |</span><br><span class="line">| utf8_unicode_520_ci          | utf8     |  214 |         | Yes      |       8 |</span><br><span class="line">| utf8_vietnamese_ci           | utf8     |  215 |         | Yes      |       8 |</span><br><span class="line">| utf8_general_mysql500_ci     | utf8     |  223 |         | Yes      |       1 |</span><br><span class="line">| utf8_croatian_ci             | utf8     |  576 |         | Yes      |       8 |</span><br><span class="line">| utf8_myanmar_ci              | utf8     |  577 |         | Yes      |       8 |</span><br><span class="line">| utf8_thai_520_w2             | utf8     |  578 |         | Yes      |       4 |</span><br><span class="line">| utf8_general_nopad_ci        | utf8     | 1057 |         | Yes      |       1 |</span><br><span class="line">| utf8_nopad_bin               | utf8     | 1107 |         | Yes      |       1 |</span><br><span class="line">| utf8_unicode_nopad_ci        | utf8     | 1216 |         | Yes      |       8 |</span><br><span class="line">| utf8_unicode_520_nopad_ci    | utf8     | 1238 |         | Yes      |       8 |</span><br><span class="line">| ucs2_general_ci              | ucs2     |   35 | Yes     | Yes      |       1 |</span><br><span class="line">| ucs2_bin                     | ucs2     |   90 |         | Yes      |       1 |</span><br><span class="line">| ucs2_unicode_ci              | ucs2     |  128 |         | Yes      |       8 |</span><br><span class="line">| ucs2_icelandic_ci            | ucs2     |  129 |         | Yes      |       8 |</span><br><span class="line">| ucs2_latvian_ci              | ucs2     |  130 |         | Yes      |       8 |</span><br><span class="line">| ucs2_romanian_ci             | ucs2     |  131 |         | Yes      |       8 |</span><br><span class="line">| ucs2_slovenian_ci            | ucs2     |  132 |         | Yes      |       8 |</span><br><span class="line">| ucs2_polish_ci               | ucs2     |  133 |         | Yes      |       8 |</span><br><span class="line">| ucs2_estonian_ci             | ucs2     |  134 |         | Yes      |       8 |</span><br><span class="line">| ucs2_spanish_ci              | ucs2     |  135 |         | Yes      |       8 |</span><br><span class="line">| ucs2_swedish_ci              | ucs2     |  136 |         | Yes      |       8 |</span><br><span class="line">| ucs2_turkish_ci              | ucs2     |  137 |         | Yes      |       8 |</span><br><span class="line">| ucs2_czech_ci                | ucs2     |  138 |         | Yes      |       8 |</span><br><span class="line">| ucs2_danish_ci               | ucs2     |  139 |         | Yes      |       8 |</span><br><span class="line">| ucs2_lithuanian_ci           | ucs2     |  140 |         | Yes      |       8 |</span><br><span class="line">| ucs2_slovak_ci               | ucs2     |  141 |         | Yes      |       8 |</span><br><span class="line">| ucs2_spanish2_ci             | ucs2     |  142 |         | Yes      |       8 |</span><br><span class="line">| ucs2_roman_ci                | ucs2     |  143 |         | Yes      |       8 |</span><br><span class="line">| ucs2_persian_ci              | ucs2     |  144 |         | Yes      |       8 |</span><br><span class="line">| ucs2_esperanto_ci            | ucs2     |  145 |         | Yes      |       8 |</span><br><span class="line">| ucs2_hungarian_ci            | ucs2     |  146 |         | Yes      |       8 |</span><br><span class="line">| ucs2_sinhala_ci              | ucs2     |  147 |         | Yes      |       8 |</span><br><span class="line">| ucs2_german2_ci              | ucs2     |  148 |         | Yes      |       8 |</span><br><span class="line">| ucs2_croatian_mysql561_ci    | ucs2     |  149 |         | Yes      |       8 |</span><br><span class="line">| ucs2_unicode_520_ci          | ucs2     |  150 |         | Yes      |       8 |</span><br><span class="line">| ucs2_vietnamese_ci           | ucs2     |  151 |         | Yes      |       8 |</span><br><span class="line">| ucs2_general_mysql500_ci     | ucs2     |  159 |         | Yes      |       1 |</span><br><span class="line">| ucs2_croatian_ci             | ucs2     |  640 |         | Yes      |       8 |</span><br><span class="line">| ucs2_myanmar_ci              | ucs2     |  641 |         | Yes      |       8 |</span><br><span class="line">| ucs2_thai_520_w2             | ucs2     |  642 |         | Yes      |       4 |</span><br><span class="line">| ucs2_general_nopad_ci        | ucs2     | 1059 |         | Yes      |       1 |</span><br><span class="line">| ucs2_nopad_bin               | ucs2     | 1114 |         | Yes      |       1 |</span><br><span class="line">| ucs2_unicode_nopad_ci        | ucs2     | 1152 |         | Yes      |       8 |</span><br><span class="line">| ucs2_unicode_520_nopad_ci    | ucs2     | 1174 |         | Yes      |       8 |</span><br><span class="line">| cp866_general_ci             | cp866    |   36 | Yes     | Yes      |       1 |</span><br><span class="line">| cp866_bin                    | cp866    |   68 |         | Yes      |       1 |</span><br><span class="line">| cp866_general_nopad_ci       | cp866    | 1060 |         | Yes      |       1 |</span><br><span class="line">| cp866_nopad_bin              | cp866    | 1092 |         | Yes      |       1 |</span><br><span class="line">| keybcs2_general_ci           | keybcs2  |   37 | Yes     | Yes      |       1 |</span><br><span class="line">| keybcs2_bin                  | keybcs2  |   73 |         | Yes      |       1 |</span><br><span class="line">| keybcs2_general_nopad_ci     | keybcs2  | 1061 |         | Yes      |       1 |</span><br><span class="line">| keybcs2_nopad_bin            | keybcs2  | 1097 |         | Yes      |       1 |</span><br><span class="line">| macce_general_ci             | macce    |   38 | Yes     | Yes      |       1 |</span><br><span class="line">| macce_bin                    | macce    |   43 |         | Yes      |       1 |</span><br><span class="line">| macce_general_nopad_ci       | macce    | 1062 |         | Yes      |       1 |</span><br><span class="line">| macce_nopad_bin              | macce    | 1067 |         | Yes      |       1 |</span><br><span class="line">| macroman_general_ci          | macroman |   39 | Yes     | Yes      |       1 |</span><br><span class="line">| macroman_bin                 | macroman |   53 |         | Yes      |       1 |</span><br><span class="line">| macroman_general_nopad_ci    | macroman | 1063 |         | Yes      |       1 |</span><br><span class="line">| macroman_nopad_bin           | macroman | 1077 |         | Yes      |       1 |</span><br><span class="line">| cp852_general_ci             | cp852    |   40 | Yes     | Yes      |       1 |</span><br><span class="line">| cp852_bin                    | cp852    |   81 |         | Yes      |       1 |</span><br><span class="line">| cp852_general_nopad_ci       | cp852    | 1064 |         | Yes      |       1 |</span><br><span class="line">| cp852_nopad_bin              | cp852    | 1105 |         | Yes      |       1 |</span><br><span class="line">| latin7_estonian_cs           | latin7   |   20 |         | Yes      |       1 |</span><br><span class="line">| latin7_general_ci            | latin7   |   41 | Yes     | Yes      |       1 |</span><br><span class="line">| latin7_general_cs            | latin7   |   42 |         | Yes      |       1 |</span><br><span class="line">| latin7_bin                   | latin7   |   79 |         | Yes      |       1 |</span><br><span class="line">| latin7_general_nopad_ci      | latin7   | 1065 |         | Yes      |       1 |</span><br><span class="line">| latin7_nopad_bin             | latin7   | 1103 |         | Yes      |       1 |</span><br><span class="line">| utf8mb4_general_ci           | utf8mb4  |   45 | Yes     | Yes      |       1 |</span><br><span class="line">| utf8mb4_bin                  | utf8mb4  |   46 |         | Yes      |       1 |</span><br><span class="line">| utf8mb4_unicode_ci           | utf8mb4  |  224 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_icelandic_ci         | utf8mb4  |  225 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_latvian_ci           | utf8mb4  |  226 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_romanian_ci          | utf8mb4  |  227 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_slovenian_ci         | utf8mb4  |  228 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_polish_ci            | utf8mb4  |  229 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_estonian_ci          | utf8mb4  |  230 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_spanish_ci           | utf8mb4  |  231 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_swedish_ci           | utf8mb4  |  232 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_turkish_ci           | utf8mb4  |  233 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_czech_ci             | utf8mb4  |  234 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_danish_ci            | utf8mb4  |  235 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_lithuanian_ci        | utf8mb4  |  236 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_slovak_ci            | utf8mb4  |  237 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_spanish2_ci          | utf8mb4  |  238 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_roman_ci             | utf8mb4  |  239 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_persian_ci           | utf8mb4  |  240 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_esperanto_ci         | utf8mb4  |  241 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_hungarian_ci         | utf8mb4  |  242 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_sinhala_ci           | utf8mb4  |  243 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_german2_ci           | utf8mb4  |  244 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_croatian_mysql561_ci | utf8mb4  |  245 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_unicode_520_ci       | utf8mb4  |  246 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_vietnamese_ci        | utf8mb4  |  247 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_croatian_ci          | utf8mb4  |  608 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_myanmar_ci           | utf8mb4  |  609 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_thai_520_w2          | utf8mb4  |  610 |         | Yes      |       4 |</span><br><span class="line">| utf8mb4_general_nopad_ci     | utf8mb4  | 1069 |         | Yes      |       1 |</span><br><span class="line">| utf8mb4_nopad_bin            | utf8mb4  | 1070 |         | Yes      |       1 |</span><br><span class="line">| utf8mb4_unicode_nopad_ci     | utf8mb4  | 1248 |         | Yes      |       8 |</span><br><span class="line">| utf8mb4_unicode_520_nopad_ci | utf8mb4  | 1270 |         | Yes      |       8 |</span><br><span class="line">| cp1251_bulgarian_ci          | cp1251   |   14 |         | Yes      |       1 |</span><br><span class="line">| cp1251_ukrainian_ci          | cp1251   |   23 |         | Yes      |       1 |</span><br><span class="line">| cp1251_bin                   | cp1251   |   50 |         | Yes      |       1 |</span><br><span class="line">| cp1251_general_ci            | cp1251   |   51 | Yes     | Yes      |       1 |</span><br><span class="line">| cp1251_general_cs            | cp1251   |   52 |         | Yes      |       1 |</span><br><span class="line">| cp1251_nopad_bin             | cp1251   | 1074 |         | Yes      |       1 |</span><br><span class="line">| cp1251_general_nopad_ci      | cp1251   | 1075 |         | Yes      |       1 |</span><br><span class="line">| utf16_general_ci             | utf16    |   54 | Yes     | Yes      |       1 |</span><br><span class="line">| utf16_bin                    | utf16    |   55 |         | Yes      |       1 |</span><br><span class="line">| utf16_unicode_ci             | utf16    |  101 |         | Yes      |       8 |</span><br><span class="line">| utf16_icelandic_ci           | utf16    |  102 |         | Yes      |       8 |</span><br><span class="line">| utf16_latvian_ci             | utf16    |  103 |         | Yes      |       8 |</span><br><span class="line">| utf16_romanian_ci            | utf16    |  104 |         | Yes      |       8 |</span><br><span class="line">| utf16_slovenian_ci           | utf16    |  105 |         | Yes      |       8 |</span><br><span class="line">| utf16_polish_ci              | utf16    |  106 |         | Yes      |       8 |</span><br><span class="line">| utf16_estonian_ci            | utf16    |  107 |         | Yes      |       8 |</span><br><span class="line">| utf16_spanish_ci             | utf16    |  108 |         | Yes      |       8 |</span><br><span class="line">| utf16_swedish_ci             | utf16    |  109 |         | Yes      |       8 |</span><br><span class="line">| utf16_turkish_ci             | utf16    |  110 |         | Yes      |       8 |</span><br><span class="line">| utf16_czech_ci               | utf16    |  111 |         | Yes      |       8 |</span><br><span class="line">| utf16_danish_ci              | utf16    |  112 |         | Yes      |       8 |</span><br><span class="line">| utf16_lithuanian_ci          | utf16    |  113 |         | Yes      |       8 |</span><br><span class="line">| utf16_slovak_ci              | utf16    |  114 |         | Yes      |       8 |</span><br><span class="line">| utf16_spanish2_ci            | utf16    |  115 |         | Yes      |       8 |</span><br><span class="line">| utf16_roman_ci               | utf16    |  116 |         | Yes      |       8 |</span><br><span class="line">| utf16_persian_ci             | utf16    |  117 |         | Yes      |       8 |</span><br><span class="line">| utf16_esperanto_ci           | utf16    |  118 |         | Yes      |       8 |</span><br><span class="line">| utf16_hungarian_ci           | utf16    |  119 |         | Yes      |       8 |</span><br><span class="line">| utf16_sinhala_ci             | utf16    |  120 |         | Yes      |       8 |</span><br><span class="line">| utf16_german2_ci             | utf16    |  121 |         | Yes      |       8 |</span><br><span class="line">| utf16_croatian_mysql561_ci   | utf16    |  122 |         | Yes      |       8 |</span><br><span class="line">| utf16_unicode_520_ci         | utf16    |  123 |         | Yes      |       8 |</span><br><span class="line">| utf16_vietnamese_ci          | utf16    |  124 |         | Yes      |       8 |</span><br><span class="line">| utf16_croatian_ci            | utf16    |  672 |         | Yes      |       8 |</span><br><span class="line">| utf16_myanmar_ci             | utf16    |  673 |         | Yes      |       8 |</span><br><span class="line">| utf16_thai_520_w2            | utf16    |  674 |         | Yes      |       4 |</span><br><span class="line">| utf16_general_nopad_ci       | utf16    | 1078 |         | Yes      |       1 |</span><br><span class="line">| utf16_nopad_bin              | utf16    | 1079 |         | Yes      |       1 |</span><br><span class="line">| utf16_unicode_nopad_ci       | utf16    | 1125 |         | Yes      |       8 |</span><br><span class="line">| utf16_unicode_520_nopad_ci   | utf16    | 1147 |         | Yes      |       8 |</span><br><span class="line">| utf16le_general_ci           | utf16le  |   56 | Yes     | Yes      |       1 |</span><br><span class="line">| utf16le_bin                  | utf16le  |   62 |         | Yes      |       1 |</span><br><span class="line">| utf16le_general_nopad_ci     | utf16le  | 1080 |         | Yes      |       1 |</span><br><span class="line">| utf16le_nopad_bin            | utf16le  | 1086 |         | Yes      |       1 |</span><br><span class="line">| cp1256_general_ci            | cp1256   |   57 | Yes     | Yes      |       1 |</span><br><span class="line">| cp1256_bin                   | cp1256   |   67 |         | Yes      |       1 |</span><br><span class="line">| cp1256_general_nopad_ci      | cp1256   | 1081 |         | Yes      |       1 |</span><br><span class="line">| cp1256_nopad_bin             | cp1256   | 1091 |         | Yes      |       1 |</span><br><span class="line">| cp1257_lithuanian_ci         | cp1257   |   29 |         | Yes      |       1 |</span><br><span class="line">| cp1257_bin                   | cp1257   |   58 |         | Yes      |       1 |</span><br><span class="line">| cp1257_general_ci            | cp1257   |   59 | Yes     | Yes      |       1 |</span><br><span class="line">| cp1257_nopad_bin             | cp1257   | 1082 |         | Yes      |       1 |</span><br><span class="line">| cp1257_general_nopad_ci      | cp1257   | 1083 |         | Yes      |       1 |</span><br><span class="line">| utf32_general_ci             | utf32    |   60 | Yes     | Yes      |       1 |</span><br><span class="line">| utf32_bin                    | utf32    |   61 |         | Yes      |       1 |</span><br><span class="line">| utf32_unicode_ci             | utf32    |  160 |         | Yes      |       8 |</span><br><span class="line">| utf32_icelandic_ci           | utf32    |  161 |         | Yes      |       8 |</span><br><span class="line">| utf32_latvian_ci             | utf32    |  162 |         | Yes      |       8 |</span><br><span class="line">| utf32_romanian_ci            | utf32    |  163 |         | Yes      |       8 |</span><br><span class="line">| utf32_slovenian_ci           | utf32    |  164 |         | Yes      |       8 |</span><br><span class="line">| utf32_polish_ci              | utf32    |  165 |         | Yes      |       8 |</span><br><span class="line">| utf32_estonian_ci            | utf32    |  166 |         | Yes      |       8 |</span><br><span class="line">| utf32_spanish_ci             | utf32    |  167 |         | Yes      |       8 |</span><br><span class="line">| utf32_swedish_ci             | utf32    |  168 |         | Yes      |       8 |</span><br><span class="line">| utf32_turkish_ci             | utf32    |  169 |         | Yes      |       8 |</span><br><span class="line">| utf32_czech_ci               | utf32    |  170 |         | Yes      |       8 |</span><br><span class="line">| utf32_danish_ci              | utf32    |  171 |         | Yes      |       8 |</span><br><span class="line">| utf32_lithuanian_ci          | utf32    |  172 |         | Yes      |       8 |</span><br><span class="line">| utf32_slovak_ci              | utf32    |  173 |         | Yes      |       8 |</span><br><span class="line">| utf32_spanish2_ci            | utf32    |  174 |         | Yes      |       8 |</span><br><span class="line">| utf32_roman_ci               | utf32    |  175 |         | Yes      |       8 |</span><br><span class="line">| utf32_persian_ci             | utf32    |  176 |         | Yes      |       8 |</span><br><span class="line">| utf32_esperanto_ci           | utf32    |  177 |         | Yes      |       8 |</span><br><span class="line">| utf32_hungarian_ci           | utf32    |  178 |         | Yes      |       8 |</span><br><span class="line">| utf32_sinhala_ci             | utf32    |  179 |         | Yes      |       8 |</span><br><span class="line">| utf32_german2_ci             | utf32    |  180 |         | Yes      |       8 |</span><br><span class="line">| utf32_croatian_mysql561_ci   | utf32    |  181 |         | Yes      |       8 |</span><br><span class="line">| utf32_unicode_520_ci         | utf32    |  182 |         | Yes      |       8 |</span><br><span class="line">| utf32_vietnamese_ci          | utf32    |  183 |         | Yes      |       8 |</span><br><span class="line">| utf32_croatian_ci            | utf32    |  736 |         | Yes      |       8 |</span><br><span class="line">| utf32_myanmar_ci             | utf32    |  737 |         | Yes      |       8 |</span><br><span class="line">| utf32_thai_520_w2            | utf32    |  738 |         | Yes      |       4 |</span><br><span class="line">| utf32_general_nopad_ci       | utf32    | 1084 |         | Yes      |       1 |</span><br><span class="line">| utf32_nopad_bin              | utf32    | 1085 |         | Yes      |       1 |</span><br><span class="line">| utf32_unicode_nopad_ci       | utf32    | 1184 |         | Yes      |       8 |</span><br><span class="line">| utf32_unicode_520_nopad_ci   | utf32    | 1206 |         | Yes      |       8 |</span><br><span class="line">| binary                       | binary   |   63 | Yes     | Yes      |       1 |</span><br><span class="line">| geostd8_general_ci           | geostd8  |   92 | Yes     | Yes      |       1 |</span><br><span class="line">| geostd8_bin                  | geostd8  |   93 |         | Yes      |       1 |</span><br><span class="line">| geostd8_general_nopad_ci     | geostd8  | 1116 |         | Yes      |       1 |</span><br><span class="line">| geostd8_nopad_bin            | geostd8  | 1117 |         | Yes      |       1 |</span><br><span class="line">| cp932_japanese_ci            | cp932    |   95 | Yes     | Yes      |       1 |</span><br><span class="line">| cp932_bin                    | cp932    |   96 |         | Yes      |       1 |</span><br><span class="line">| cp932_japanese_nopad_ci      | cp932    | 1119 |         | Yes      |       1 |</span><br><span class="line">| cp932_nopad_bin              | cp932    | 1120 |         | Yes      |       1 |</span><br><span class="line">| eucjpms_japanese_ci          | eucjpms  |   97 | Yes     | Yes      |       1 |</span><br><span class="line">| eucjpms_bin                  | eucjpms  |   98 |         | Yes      |       1 |</span><br><span class="line">| eucjpms_japanese_nopad_ci    | eucjpms  | 1121 |         | Yes      |       1 |</span><br><span class="line">| eucjpms_nopad_bin            | eucjpms  | 1122 |         | Yes      |       1 |</span><br><span class="line">+------------------------------+----------+------+---------+----------+---------+</span><br><span class="line">322 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.002 sec)</span><br></pre></td></tr></table></figure>

<h3 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h3><p>删除数据库需要使用DROP命令。</p>
<p>命令语法:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DROP &#123;DATABASE | SCHEMA&#125; [IF EXISTS] db_name</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>删除db3308数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用DROP命令删除db3308数据库</span></span><br><span class="line">MariaDB [(none)]&gt; DROP DATABASE db3308;</span><br><span class="line">Query OK, 0 rows affected (0.011 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据库，db3308是否被删除</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| db2                |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"><span class="comment">#已经没有db3308数据库</span></span><br></pre></td></tr></table></figure>

<p>删除数据库本质上就是删除一个目录，现在/data/mysql下已经没db3308这个目录了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ls /data/mysql/db3308</span></span><br><span class="line">ls: cannot access <span class="string">&#x27;/data/mysql/db3308&#x27;</span>: No such file or directory</span><br></pre></td></tr></table></figure>

<h3 id="修改数据库"><a href="#修改数据库" class="headerlink" title="修改数据库"></a>修改数据库</h3><p>如果在创建数据库后发现数据的字符集设置出错误可以使用ALTER DATABASE命令对数据库进行修改</p>
<p>命令语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ALTER &#123;DATABASE | SCHEMA&#125; [db_name]</span><br><span class="line">    alter_specification ...</span><br><span class="line">ALTER &#123;DATABASE | SCHEMA&#125; db_name</span><br><span class="line">    UPGRADE DATA DIRECTORY NAME</span><br><span class="line"></span><br><span class="line">alter_specification:</span><br><span class="line">    [DEFAULT] CHARACTER SET [=] charset_name</span><br><span class="line">  | [DEFAULT] COLLATE [=] collation_name</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>创建db1数据库，然后将数据库的字符集改为utf8mb4</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建出db1数据库</span></span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE db1;</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前数据库的字符集</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW CREATE DATABASE db1;</span><br><span class="line">+----------+----------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                |</span><br><span class="line">+----------+----------------------------------------------------------------+</span><br><span class="line">| db1      | CREATE DATABASE `db1` /*!40100 DEFAULT CHARACTER SET latin1 */ |       <span class="comment">#默认字符集为latin1</span></span><br><span class="line">+----------+----------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#将默认字符集改为utf8mb4</span></span><br><span class="line">MariaDB [(none)]&gt; ALTER DATABASE db1 CHARACTER SET utf8mb4;</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#再次查看数据库的字符集</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW CREATE DATABASE db1;</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                 |</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| db1      | CREATE DATABASE `db1` /*!40100 DEFAULT CHARACTER SET utf8mb4 */ |    <span class="comment">#默认字符集已经改为utf8mb4</span></span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure>

<p>以上就是数据库的操作方法</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库表的操作</title>
    <url>/2019/04/18/MySQL/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%9A%84%E6%93%8D%E4%BD%9C/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%9A%84%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>在上一节中已经说了如何创建数据库，接下来最重要的就是在数据库内存入数据，数据需要存放在相应的表中，数据库就是个文件夹，数据就是其内部的一个一个文件，文件所对应的就是数据库的表</p>
<span id="more"></span>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>数据类型大致理解为此数据是数字还是字符串。</p>
<p>数据类型类型不同数据的样子形式可以不同，数据在磁盘上占用的空间大小也不同。</p>
<p><img src="%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png" alt="数据类型.png"></p>
<h3 id="查看数据库的的表"><a href="#查看数据库的的表" class="headerlink" title="查看数据库的的表"></a>查看数据库的的表</h3><p>使用SHOW TABLES;可以查看当前数据库中的所有表</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#切换到db1数据库</span></span><br><span class="line">MariaDB [(none)]&gt; use db1;</span><br><span class="line">Database changed</span><br><span class="line"><span class="comment">#查看数据库内的所有表</span></span><br><span class="line">MariaDB [db1]&gt; show tables;</span><br><span class="line">Empty <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"><span class="comment">#由于db1为新创建的数据库其内部还没有任何表</span></span><br></pre></td></tr></table></figure>

<h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><p>创建表需要定义有哪些字段，有了字段后就可以在其内部添加一条一条的记录了。</p>
<p>表的结构包括几个关键的属性：</p>
<ol>
<li>表里面有哪些字段，字段名是什么</li>
<li>字段内数据的类型</li>
<li>修饰符，用来标识字段的特殊属性，比如主键、唯一键、是否允许为空等等。</li>
</ol>
<p>命令语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">    (create_definition,...)</span><br><span class="line">    [table_options]</span><br><span class="line">    [partition_options]</span><br><span class="line"></span><br><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">    [(create_definition,...)]</span><br><span class="line">    [table_options]</span><br><span class="line">    [partition_options]</span><br><span class="line">    select_statement</span><br><span class="line"></span><br><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">    &#123; LIKE old_tbl_name | (LIKE old_tbl_name) &#125;</span><br></pre></td></tr></table></figure>

<p>创建表有3种方法，常用的为第一种</p>
<p>示例：</p>
<p>创建一个学生信息表，字段分别为stuid,gender,age,mobile</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [db1]&gt; CREATE TABLE student ( stuid smallint unsigned auto_increment primary key,name char(10) not null ,gender enum(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>) default <span class="string">&#x27;m&#x27;</span>,age tinyint unsigned,mobile char(11));</span><br><span class="line">Query OK, 0 rows affected (0.006 sec)</span><br></pre></td></tr></table></figure>

<h3 id="查看表结构"><a href="#查看表结构" class="headerlink" title="查看表结构"></a>查看表结构</h3><p>查看表结构可以使用DESC命令进行查看</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看student表的定义</span></span><br><span class="line">MariaDB [db1]&gt; DESC student;</span><br><span class="line">+--------+----------------------+------+-----+---------+----------------+</span><br><span class="line">| Field  | Type                 | Null | Key | Default | Extra          |</span><br><span class="line">+--------+----------------------+------+-----+---------+----------------+</span><br><span class="line">| stuid  | smallint(5) unsigned | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name   | char(10)             | NO   |     | NULL    |                |</span><br><span class="line">| gender | enum(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>)        | YES  |     | m       |                |</span><br><span class="line">| age    | tinyint(3) unsigned  | YES  |     | NULL    |                |</span><br><span class="line">| mobile | char(11)             | YES  |     | NULL    |                |</span><br><span class="line">+--------+----------------------+------+-----+---------+----------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.011 sec)</span><br></pre></td></tr></table></figure>

<h3 id="查看表创建命令"><a href="#查看表创建命令" class="headerlink" title="查看表创建命令"></a>查看表创建命令</h3><p>如果要查询某表创建时所使用的命令可以使用SHOW CREATE TABLE命令来进行查询</p>
<p>示例：</p>
<p>查询student表创建时所使用的命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [db1]&gt; show create table student\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: student</span><br><span class="line">Create Table: CREATE TABLE `student` (</span><br><span class="line">  `stuid` smallint(5) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` char(10) NOT NULL,</span><br><span class="line">  `gender` enum(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>) DEFAULT <span class="string">&#x27;m&#x27;</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `mobile` char(11) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`stuid`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure>

<h3 id="查看表状态"><a href="#查看表状态" class="headerlink" title="查看表状态"></a>查看表状态</h3><p>使用SHOW TABLE STATUS可以查看表的各种状态。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [db1]&gt; SHOW TABLE STATUS LIKE <span class="string">&#x27;student&#x27;</span>\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">            Name: student</span><br><span class="line">          Engine: InnoDB</span><br><span class="line">         Version: 10</span><br><span class="line">      Row_format: Dynamic</span><br><span class="line">            Rows: 0</span><br><span class="line">  Avg_row_length: 0</span><br><span class="line">     Data_length: 16384</span><br><span class="line"> Max_data_length: 0</span><br><span class="line">    Index_length: 0</span><br><span class="line">       Data_free: 0</span><br><span class="line">  Auto_increment: 1</span><br><span class="line">     Create_time: 2019-03-18 15:41:06</span><br><span class="line">     Update_time: NULL</span><br><span class="line">      Check_time: NULL</span><br><span class="line">       Collation: utf8mb4_general_ci</span><br><span class="line">        Checksum: NULL</span><br><span class="line">  Create_options:</span><br><span class="line">         Comment:</span><br><span class="line">Max_index_length: 0</span><br><span class="line">       Temporary: N</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br></pre></td></tr></table></figure>

<h3 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h3><p>删除表使用DROP TABLE命令</p>
<p>示例：</p>
<p>删除student表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [db1]&gt; DROP TABLE student;</span><br><span class="line">Query OK, 0 rows affected (0.015 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看db1库内的所有表</span></span><br><span class="line">MariaDB [db1]&gt; show tables;</span><br><span class="line">Empty <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"><span class="comment">#已经没有student表</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL日志管理（一）</title>
    <url>/2019/04/17/MySQL/MySQL%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/MySQL%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86--1/</url>
    <content><![CDATA[<h2 id="MySQL的日志"><a href="#MySQL的日志" class="headerlink" title="MySQL的日志"></a>MySQL的日志</h2><p>MySQL的日志分为事务日志、错误日志、通用日志、慢查询日志、以及二进制日志，此处主要讲解前4种日志的配置及使用方法。二进制日志将在下一节中单独讲解。</p>
<h3 id="事务日志-transaction-log"><a href="#事务日志-transaction-log" class="headerlink" title="事务日志(transaction log)"></a>事务日志(transaction log)</h3><p>事务日志默认的存放位置为MySQL的数据库目录下的ib_logfile0、ib_logfile1</p>
<p>生产环境中建议将事务日志存放在单独的分区中，防止产生IO的争用。</p>
<p>Innodb事务日志相关配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#innodb事务日志相关配置可以使用以下命令进行查看</span></span><br><span class="line">show variables like <span class="string">&#x27;%innodb_log&#x27;</span>;</span><br><span class="line"><span class="comment">#查询出的结果</span></span><br><span class="line">innodb_log_block_size</span><br><span class="line">innodb_log_file_size   5242880   每个日志文件大小，生产环境建议将此数值改大到几百兆，5M数值太小</span><br><span class="line">innodb_log_files_in_group  2      日志组成员个数  </span><br><span class="line">innodb_log_group_home_dir  ./   事务文件路径  </span><br><span class="line">innodb_flush_log_at_trx_commit  默认为1</span><br></pre></td></tr></table></figure>

<p><em><strong>innodb_flush_log_at_trx_commit</strong></em></p>
<p>0: 提交时没有任何操作; 而是每秒执行一次日志缓冲区写入和刷新。这样可以提供更好的性能，但服务器崩溃可以清除最后一秒的事务</p>
<p>1: 默认情况下，日志缓冲区将写入日志文件，并在每次事务后执行刷新到磁盘。这是完全遵守ACID特性</p>
<p>2: 每次提交后都会写入日志缓冲区，但每秒都会进行一次刷新。性能比0略好一些，但操作系统或停电可能导致最后一秒的交易丢失</p>
<p>3: 模拟MariaDB 5.5组提交（每组提交3个同步），此项MariaDB 10.0支持</p>
<p>此参数修改方法/etc/my.cnf文件中进行修改。</p>
<h4 id="事务日志和数据分开存放"><a href="#事务日志和数据分开存放" class="headerlink" title="事务日志和数据分开存放"></a>事务日志和数据分开存放</h4><p>在生产中建议将事务日志存放到一个独立的分区中，带来的好处是性能更优。如果事务日志和数据库存放在一个磁盘上，既要写数据库又要写事务日志，这时候两个写操作都往同一磁盘内写数据必然会涉及到IO争用问题。如果将其存放到不同的磁盘上，这时候数据库和事务日志各写各的，理论上效率更高。</p>
<p>1.创建事务日志目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir /data/tlog</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chown -R mysql.mysql /data/tlog</span></span><br></pre></td></tr></table></figure>

<p>2.修改配置文件指定事务日志的存放位置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">innodb_log_group_home_dir=/data/tlog</span><br></pre></td></tr></table></figure>

<p>3.重启MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># service mysqld restart</span></span><br><span class="line">Restarting mysqld (via systemctl):                         [  OK  ]</span><br><span class="line">[root@localhost ~]<span class="comment"># ll /data/tlog/</span></span><br><span class="line">total 98304</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 May  5 04:35 ib_logfile0</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 May  5 04:35 ib_logfile1</span><br></pre></td></tr></table></figure>

<h3 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h3><p>mysqld启动和关闭过程中输出的事件信息</p>
<p>mysqld运行中产生的错误信息</p>
<p>event scheduler运行一个event时产生的日志信息</p>
<p>在主从复制架构中的从服务器上启动从服务器线程时产生的信息</p>
<p>错误日志相关配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">log_error=/PATH/TO/LOG_ERROR_FILE    <span class="comment">#错误日志的存放位置</span></span><br><span class="line">log_warnings=1|0 默认值1             <span class="comment">#是否记录警告信息至错误日志文件，1为记录警告信息，0为不记录警告信息只记录错误信息。</span></span><br></pre></td></tr></table></figure>

<h3 id="通用日志"><a href="#通用日志" class="headerlink" title="通用日志"></a>通用日志</h3><p>通用日志：记录对数据库的通用操作，包括错误的SQL语句，数据库的通用日志默认没有启用。</p>
<p>通用日志相关设置，在配置文件中修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在配置文件/etc/my.cnf中添加以下三行信息即可开启通用日志</span></span><br><span class="line">general_log=ON|OFF                  <span class="comment">#通用日志默认为关闭</span></span><br><span class="line">general_log_file=HOSTNAME.log       <span class="comment">#通用日志的名字默认为主机名.log</span></span><br><span class="line">log_output=TABLE|FILE|NONE          <span class="comment">#通用日志可以存放在文件中，也可以存放在表中，表放在MySQL库中general_log</span></span><br></pre></td></tr></table></figure>

<h3 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h3><p>慢查询日志：记录执行查询时长超出指定时长的操作，其配置在配置文件中进行修改</p>
<p>慢查询日志相关配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">slow_query_log=ON|OFF       <span class="comment">#开启或关闭慢查询</span></span><br><span class="line">long_query_time=N           <span class="comment">#慢查询的阀值，单位秒</span></span><br><span class="line">slow_query_log_file=HOSTNAME-slow.log         <span class="comment">#慢查询日志文件</span></span><br><span class="line">log_slow_filter = admin,filesort,filesort_on_disk,full_join,full_scan, query_cache,query_cache_miss,tmp_table,tmp_table_on_disk    <span class="comment">#上述查询类型且查询时长超过long_query_time，则记录日志</span></span><br><span class="line">log_queries_not_using_indexes=ON               <span class="comment">#不使用索引或使用全索引扫描，不论是否达到慢查询阀值的语句是否记录日志，默认OFF，即不记录</span></span><br><span class="line">log_slow_rate_limit = 1                 <span class="comment">#多少次查询才记录，mariadb特有</span></span><br><span class="line">log_slow_verbosity= Query_plan,explain       <span class="comment">#记录内容</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL日志管理（二）</title>
    <url>/2019/04/17/MySQL/MySQL%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/MySQL%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86--2/</url>
    <content><![CDATA[<h2 id="二进制日志"><a href="#二进制日志" class="headerlink" title="二进制日志"></a>二进制日志</h2><p>由于事务日志严重依赖于存储引擎，比如MyISAM不支持事务，所以对于MyISAM来说就没有事务日志这个概念，只有InnoDB才有事务日志。事务日志内记录的内容，已提交的事务未提交的事务都需要记录到事务日志中，而二进制日志不同。</p>
<p>二进制日志又叫存档日志，记录那些已提交的确定的事件，记录导致数据改变或潜在导致数据改变的SQL语句。二进制日志不依赖于存储引擎。二进制日志详细的记录了数据库所有的增删改操作，所以二进制日志就相当于忠实的记录了数据库的所有的行为（增、删、改）。所以利用二进制日志可以分析了解数据库内数据变化的整个过程。因为二进制日志记录了数据库内所有数据的行为，所以可以通过“重放”日志文件中的事件来生成数据副本，也就是说通过重放二进制日志文件来生成新的数据库备份。基于安全考虑，强烈建议将二进制日志文件和数据文件进行分开存放。</p>
<h3 id="二进制日志的记录格式"><a href="#二进制日志的记录格式" class="headerlink" title="二进制日志的记录格式"></a>二进制日志的记录格式</h3><p>二进制日志有3种格式</p>
<ol>
<li>statement：基于语句记录，默认</li>
<li>row:基于行记录，记录的是数据，日志量较大。</li>
<li>mixed:混合模式，系统自行判断基于那种方式进行记录</li>
</ol>
<p>在工作中，推荐基于row的方式进行记录</p>
<h3 id="二进制日志的开启方式"><a href="#二进制日志的开启方式" class="headerlink" title="二进制日志的开启方式"></a>二进制日志的开启方式</h3><p>二进制日志需要启动两个选项</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sql_log_bin   <span class="comment">#sql_log_bin为会话级的变量可以在MySQL内通过set命令来修改</span></span><br><span class="line">log_bin       <span class="comment">#log_bin为选项需要写在配置文件中。</span></span><br></pre></td></tr></table></figure>

<p>sql_log_bin默认已经开启</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show variables like <span class="string">&#x27;sql_log_bin&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| sql_log_bin   | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>由于是二进制安装的MySQL所以默认的配置文件中log_bin也是开启的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show variables like <span class="string">&#x27;log_bin&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_bin       | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>但是配置文件中默认定义的二进制日志是存放在和数据库一起，不复合我们的要求需要修改，将其更改至其他目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/mysql/my.cnf</span></span><br><span class="line">log-bin=/data/bin/mysql-bin</span><br></pre></td></tr></table></figure>

<p>为二进制日志创建存放目录，并修改目录的属主和属组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir /data/bin</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chown -R mysql.mysql /data/bin</span></span><br></pre></td></tr></table></figure>

<p>然后重启服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># service mysql restart</span></span><br></pre></td></tr></table></figure>

<p>再次查看二进制日志存放的目录，此时已经在目录下产生了二进制日志文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ll /data/bin/</span></span><br><span class="line">total 8</span><br><span class="line">-rw-rw---- 1 mysql mysql 328 May  6 03:31 mysql-bin.000001</span><br><span class="line">-rw-rw---- 1 mysql mysql  27 May  6 03:31 mysql-bin.index</span><br></pre></td></tr></table></figure>

<h3 id="二进制日志相关的变量"><a href="#二进制日志相关的变量" class="headerlink" title="二进制日志相关的变量"></a>二进制日志相关的变量</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">max_binlog_size=1073741824     <span class="comment">#单个二进制日志文件的最大体积，到达最大值会自动滚动，默认为1G</span></span><br><span class="line">sync_binlog=1|0    <span class="comment">#设定是否启动二进制日志即时同步磁盘功能，默认为0由操作系统负责同步日志到磁盘，1.表示立即写入日志到磁盘</span></span><br><span class="line">expire_logs_days=N  <span class="comment">#二进制日志可以自动删除的天数，默认为0，不自动删除。</span></span><br></pre></td></tr></table></figure>

<h3 id="二进制日志相关的一些命令"><a href="#二进制日志相关的一些命令" class="headerlink" title="二进制日志相关的一些命令"></a>二进制日志相关的一些命令</h3><p>SHOW MASTER LOGS:查看使用中的二进制日志文件列表及大小</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW MASTER LOGS;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |       328 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>SHOW MASTER STATUS:查看使用中的二进制日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW MASTER STATUS;</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| mysql-bin.000001 |      328 |              |                  |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>SHOW BINLOG EVENTS:查看二进制文件中记录的各种操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW BINLOG EVENTS IN <span class="string">&#x27;mysql-bin.000001&#x27;</span>;</span><br><span class="line">+------------------+-----+-------------------+-----------+-------------+------------------------------------------------+</span><br><span class="line">| Log_name         | Pos | Event_type        | Server_id | End_log_pos | Info                                           |</span><br><span class="line">+------------------+-----+-------------------+-----------+-------------+------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |   4 | Format_desc       |         1 |         256 | Server ver: 10.2.23-MariaDB-log, Binlog ver: 4 |</span><br><span class="line">| mysql-bin.000001 | 256 | Gtid_list         |         1 |         285 | []                                             |</span><br><span class="line">| mysql-bin.000001 | 285 | Binlog_checkpoint |         1 |         328 | mysql-bin.000001                               |</span><br><span class="line">+------------------+-----+-------------------+-----------+-------------+------------------------------------------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>查看二进制日志中指定的位置的操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW BINLOG EVENTS IN <span class="string">&#x27;mysql-bin.000001&#x27;</span> from 285;</span><br><span class="line">+------------------+-----+-------------------+-----------+-------------+------------------+</span><br><span class="line">| Log_name         | Pos | Event_type        | Server_id | End_log_pos | Info             |</span><br><span class="line">+------------------+-----+-------------------+-----------+-------------+------------------+</span><br><span class="line">| mysql-bin.000001 | 285 | Binlog_checkpoint |         1 |         328 | mysql-bin.000001 |</span><br><span class="line">+------------------+-----+-------------------+-----------+-------------+------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="二进制日志的客户端命令工具"><a href="#二进制日志的客户端命令工具" class="headerlink" title="二进制日志的客户端命令工具"></a>二进制日志的客户端命令工具</h3><p>mysqlbinlog</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysqlbinlog [options] log_file...</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>option</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>start-position</td>
<td>指定开始位置</td>
</tr>
<tr>
<td>stop-position</td>
<td>指定结束位置</td>
</tr>
<tr>
<td>start-datetime</td>
<td>指定开始的时间</td>
</tr>
<tr>
<td>stop-datetime</td>
<td>指定结束的时间</td>
</tr>
<tr>
<td>base64-output[=name]</td>
<td>使用base64格式导出</td>
</tr>
<tr>
<td>-v -vvv</td>
<td>显示详细信息</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysqlbinlog --start-position=8309 --stop-position=8639 /data/bin/mysql-bin.000001 -v    #-v选项可以将base64编码转换为可读的信息。</span></span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;</span><br><span class="line">/*!40019 SET @@session.max_insert_delayed_threads=0*/;</span><br><span class="line">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;</span><br><span class="line">DELIMITER /*!*/;</span><br><span class="line"><span class="comment"># at 4</span></span><br><span class="line"><span class="comment">#190506  3:31:11 server id 1  end_log_pos 256 CRC32 0x0c261669 	Start: binlog v 4, server v 10.2.23-MariaDB-log created 190506  3:31:11 at startup</span></span><br><span class="line"><span class="comment"># Warning: this binlog is either in use or was not closed properly.</span></span><br><span class="line">ROLLBACK/*!*/;</span><br><span class="line">BINLOG <span class="string">&#x27;</span></span><br><span class="line"><span class="string">/znPXA8BAAAA/AAAAAABAAABAAQAMTAuMi4yMy1NYXJpYURCLWxvZwAAAAAAAAAAAAAAAAAAAAAA</span></span><br><span class="line"><span class="string">AAAAAAAAAAAAAAAAAAD/Oc9cEzgNAAgAEgAEBAQEEgAA5AAEGggAAAAICAgCAAAACgoKAAAAAAAA</span></span><br><span class="line"><span class="string">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span><br><span class="line"><span class="string">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span><br><span class="line"><span class="string">AAAAAAAAAAAEEwQADQgICAoKCgFpFiYM</span></span><br><span class="line"><span class="string">&#x27;</span>/*!*/;</span><br><span class="line"><span class="comment"># at 8309</span></span><br><span class="line"><span class="comment">#190506  4:11:55 server id 1  end_log_pos 8351 CRC32 0x4cbdba04 	GTID 0-1-33 ddl</span></span><br><span class="line">/*!100101 SET @@session.skip_parallel_replication=0*//*!*/;</span><br><span class="line">/*!100001 SET @@session.gtid_domain_id=0*//*!*/;</span><br><span class="line">/*!100001 SET @@session.server_id=1*//*!*/;</span><br><span class="line">/*!100001 SET @@session.gtid_seq_no=33*//*!*/;</span><br><span class="line"><span class="comment"># at 8351</span></span><br><span class="line"><span class="comment">#190506  4:11:55 server id 1  end_log_pos 8639 CRC32 0x8b15477f 	Query	thread_id=12	exec_time=0	error_code=0</span></span><br><span class="line">use `hellodb`/*!*/;</span><br><span class="line">SET TIMESTAMP=1557087115/*!*/;</span><br><span class="line">SET @@session.pseudo_thread_id=12/*!*/;</span><br><span class="line">SET @@session.foreign_key_checks=0, @@session.sql_auto_is_null=0, @@session.unique_checks=0, @@session.autocommit=1, @@session.check_constraint_checks=1/*!*/;</span><br><span class="line">SET @@session.sql_mode=524288/*!*/;</span><br><span class="line">SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;</span><br><span class="line">/*!\C utf8 *//*!*/;</span><br><span class="line">SET @@session.character_set_client=33,@@session.collation_connection=33,@@session.collation_server=33/*!*/;</span><br><span class="line">SET @@session.lc_time_names=0/*!*/;</span><br><span class="line">SET @@session.collation_database=DEFAULT/*!*/;</span><br><span class="line">CREATE TABLE `toc` (</span><br><span class="line">  `ID` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `CourseID` smallint(5) unsigned DEFAULT NULL,</span><br><span class="line">  `TID` smallint(5) unsigned DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span><br><span class="line">/*!*/;</span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="comment"># End of log file</span></span><br><span class="line">ROLLBACK /* added by mysqlbinlog */;</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br></pre></td></tr></table></figure>

<h3 id="二进制日志的清理"><a href="#二进制日志的清理" class="headerlink" title="二进制日志的清理"></a>二进制日志的清理</h3><p>1.重新生成一个二进制日志</p>
<p>FLUSH LOGS;重新生成二进制日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW MASTER LOGS;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      8993 |</span><br><span class="line">| mysql-bin.000002 |       385 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;  FLUSH LOGS;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW MASTER LOGS;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      8993 |</span><br><span class="line">| mysql-bin.000002 |       432 |</span><br><span class="line">| mysql-bin.000003 |       385 |</span><br><span class="line">+------------------+-----------+</span><br></pre></td></tr></table></figure>

<p>2.清理二进制日志</p>
<p>PURGE BINARY LOGS TO ‘’:删除二进制文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW MASTER LOGS;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      8993 |</span><br><span class="line">| mysql-bin.000002 |       432 |</span><br><span class="line">| mysql-bin.000003 |       432 |</span><br><span class="line">| mysql-bin.000004 |       432 |</span><br><span class="line">| mysql-bin.000005 |       432 |</span><br><span class="line">| mysql-bin.000006 |       432 |</span><br><span class="line">| mysql-bin.000007 |       432 |</span><br><span class="line">| mysql-bin.000008 |       408 |</span><br><span class="line">| mysql-bin.000009 |       389 |</span><br><span class="line">| mysql-bin.000010 |       432 |</span><br><span class="line">| mysql-bin.000011 |       385 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">11 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除旧的二进制文件，表示删除指定的二进制日志之前的日志。</span></span><br><span class="line">MariaDB [(none)]&gt; PURGE BINARY LOGS TO <span class="string">&#x27;mysql-bin.000011&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW MASTER LOGS;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000011 |       385 |      <span class="comment">#mysql-bin.000011之前的日志已经删除。</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>3.重置二进制日志更新计数</p>
<p>RESET MASTER;</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW MASTER LOGS;     <span class="comment">#查看下当前二进制日志计数</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000011 |       385 |        <span class="comment">#当前二进制日计数为mysql-bin.000011</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; RESET MASTER;         <span class="comment">#重置计数</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW MASTER LOGS;      <span class="comment">#再次查看日志计数</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |       328 |          <span class="comment">#现在计数已经变为mysql-bin.000001</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#MariaDB从10.1.6之后开始支持TO，RESET MASTER [TO #];重置二进制日志到指定的日志计数。</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL服务器配置</title>
    <url>/2019/04/17/MySQL/MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>在MySQL数据库运行时，它本质上是跑了一个mysqld的进程，是由mysqld_safe来调用的。mysql_safe是一个脚本，脚本内调用了mysqld二进制程序，所以数据库真正运行时，是靠mysqld对外进行服务的，而mysqld是一个服务器软件，在其背后还支持一些参数和选项。</p>
<h2 id="mysqld选项，服务器系统变量和服务器状态变量的区别"><a href="#mysqld选项，服务器系统变量和服务器状态变量的区别" class="headerlink" title="mysqld选项，服务器系统变量和服务器状态变量的区别"></a>mysqld选项，服务器系统变量和服务器状态变量的区别</h2><h3 id="mysqld选项"><a href="#mysqld选项" class="headerlink" title="mysqld选项"></a>mysqld选项</h3><p>mysqld选项就是在进程中mysqld后面所跟的各种参数，这些选项都能存放在服务器的配置文件/etc/my.cnf中。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost Packages]<span class="comment"># ps -aux | grep mysqld</span></span><br><span class="line">mysql      9206  0.1  3.5 2275296 144752 ?      Sl   16:09   0:01 /app/mysql/bin/mysqld --basedir=/app/mysql --datadir=/data/mysql --plugin-dir=/app/mysql/lib/plugin --user=mysql --log-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log --pid-file=/data/mysql/localhost.localdomain.pid --socket=/data/mysql/mysql.sock --port=3306  </span><br><span class="line"><span class="comment">#mysqld后面所跟的各种参数为选项</span></span><br></pre></td></tr></table></figure>

<p>msyqld的选项可以通过命令查询，所列出的为mysqld所支持的选项的默认值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysqld --<span class="built_in">help</span> -v</span><br></pre></td></tr></table></figure>

<h3 id="MySQL的服务器系统变量"><a href="#MySQL的服务器系统变量" class="headerlink" title="MySQL的服务器系统变量"></a>MySQL的服务器系统变量</h3><p>变量可以在MySQL中使用show variables来进行查看，有些变量即时选项又是变量，变量又分为全局性变量和会话级变量，全局性变量影响了所有登陆的用户，会话级只影响当前的登陆的用户。</p>
<p>详细可以参考mariadb的官方文档。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://mariadb.com/kb/en/library/full-list-of-mariadb-options-system-and-status-variables/</span><br></pre></td></tr></table></figure>

<p>获取系统变量的方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES;   <span class="comment">#获取全局性的变量</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW VARIABLES;          <span class="comment">#获取会话级的变量</span></span><br></pre></td></tr></table></figure>

<p>变量的设置方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SET GLOBAL system_var_name=value;     <span class="comment">#设置全局性的变量</span></span><br><span class="line">MariaDB [(none)]&gt; SET system_var_name=value;            <span class="comment">#设置会话级的变量</span></span><br></pre></td></tr></table></figure>

<h3 id="系统的状态变量"><a href="#系统的状态变量" class="headerlink" title="系统的状态变量"></a>系统的状态变量</h3><p>系统的状态变量又称为系统的只读变量，里面存放的是系统当前的状态信息</p>
<p>查看方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW STATUS LIKE <span class="string">&#x27;value_name&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>查看系统的启动时间</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW STATUS LIKE <span class="string">&#x27;uptime&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Uptime        | 2602  |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>服务器相关的一些常用选项、变量和状态变量<br>选项：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">skip_name_resolve:禁止把ip地址反向解析成名称建议添加</span><br></pre></td></tr></table></figure>
<p>变量：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">max_connections:最大连接数</span><br><span class="line">SQL_MODE:</span><br><span class="line">    NO_AUTO_CREATE_USER:禁止授权创建密码为空的用户</span><br><span class="line">    NO_ZERO_DATA:在严格模式，不允许使用<span class="string">&#x27;0000-00-00&#x27;</span>的时间</span><br><span class="line">    ONLY_RULL_GROUP_BY:对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么将任务这个SQL是不合法的</span><br><span class="line">    NO_BACKSLASH_ESCAPES:反斜杠<span class="string">&quot;\&quot;作为普通字符而不是转义字符</span></span><br><span class="line"><span class="string">    PIPES_AS_CONCAT:将&quot;</span>||<span class="string">&quot;视为连接操作符而非“或运算符”</span></span><br><span class="line"><span class="string">    TRADITIONAL:当插入表的数据长度超长时不是截断，而是报错</span></span><br></pre></td></tr></table></figure>
<p>状态变量：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Threads_connected:多少线程被连接</span><br><span class="line">Threads_created:多少线程被创建</span><br><span class="line">Threads_running:多少线程正在运行</span><br><span class="line">com_select:当前数据库的查询次数</span><br><span class="line">com_insert:表的添加次数</span><br></pre></td></tr></table></figure>

<p>MySQL的查询缓存<br>查询缓存是基于hash算法的，要求命令和查询的参数大小写必须完全一致，当有新的查询语句或预处理查询请求，先去查询缓存，判断是否存在纪录集，若存在则直接返回结果。<br>查询缓存的优缺点<br>优点是sql语句不需要做任何解析和执行，直接从缓存中获得查询结合，提高了查询性能<br>缺点是不够智能，提高了缓存使用门槛，增加了缓存记录集检查和清理的开销。<br>有些查询是无法被缓存的比如：<br>1.查询的语句中带了SQL_NO_CACHE参数<br>2.查询语句中含有获取值的函数。如：NOW(),CURDATE(),GET_LOCK(),RAND()、CONVERT_TZ()等<br>3.对系统数据库查询时使用会话级别的变量或存储过程中的局部变量。<br>4.查询语句中加了锁不会使用缓存<br>5.对临时表的查询，存在警告信息的查询，只有列级别权限的查询。<br>6.事务隔离级别为serializable的不能缓存<br>缓存的相关变量：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">query_cache_limit</span><br><span class="line"><span class="comment">#单个查询结果能缓存的最大值，默认为1M。过大的值将无法缓存</span></span><br><span class="line">query_cache_min_res_unit</span><br><span class="line"><span class="comment">#在内存中给缓存分配的最小单位，默认为4K，较小值会减少浪费，但会产生频繁的内存分配，如果设置较大，则会造成浪费。     </span></span><br><span class="line">query_cache_size             </span><br><span class="line"><span class="comment">#总的用来放查询缓存的内存空间，最小为40K，必须为1024的整数倍。要长期有效需要写入配置文件。</span></span><br><span class="line">query_cache_strip_comments   </span><br><span class="line">query_cache_type             </span><br><span class="line"><span class="comment">#是否启用缓存默认为开启</span></span><br><span class="line">query_cache_wlock_invalidate </span><br><span class="line"><span class="comment">#如果表被其他的会话锁定，是否仍然可以从查询缓存中返回结果，默认为off,表示可以在表被其他会话锁定的场景中继续从缓存返回数据；ON则表示不允许</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查询缓存相关的状态变量，可以使用SHOW GLOBAL STATUS LIKE ‘Qcache%’;查询</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Qcache_free_blocks      <span class="comment">#处于空闲状态缓存中内存块数</span></span><br><span class="line">Qcache_total_blocks     <span class="comment">#缓存中总块，当Qcache_free_blocks相对此值较大时，可能用内存碎片，执行FLUSH QUERY CACHE清理碎片</span></span><br><span class="line">Qcache_free_memory      <span class="comment">#处于空闲状态的缓存内存总量</span></span><br><span class="line">Qcache_hits：Query Cache    <span class="comment">#命中次数</span></span><br><span class="line">Qcache_inserts：向 Query Cache  <span class="comment">#中插入新的缓存的次数，即没有命中的次数</span></span><br><span class="line">Qcache_lowmem_prunes    <span class="comment">#记录因为内存不足而被移除出查询缓存的查询数</span></span><br><span class="line">Qcache_not_cached       <span class="comment">#没有被缓存的记录数，包括无法被缓存的记录以及由于query_cache_type设置的不会被缓存的SQL语句</span></span><br><span class="line">Qcache_queries_in_cache <span class="comment">#在缓存中的SQL数量</span></span><br></pre></td></tr></table></figure>
<p>缓存的优化方法：<br>缓存的优化方法可以根据缓存优化表来进行查询和修改<br><img src="%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%E8%A1%A8.png" alt="缓存优化表.png"></p>
<p>MySQL的索引<br>索引是特殊的数据结构，定义在查找时作为查找条件的字段，在MySQL又称为建可以，索引通过存储引擎实现。<br>索引的类型：<br>B+tree索引：<br>B+tree的所有非叶子节点上只有索引没有有数据，真正的数据都存放在叶子节点上，叶子节点上不仅有索引还有数据。相邻叶子节点的数据块之间有指向性，所以在查找范围时也能使用索引</p>
<p>复合索引<br>复合索引就是把多个字段组合设置为索引，当第一个字段相同时，比对第二个字段。复合索引可以将排在前面的字段作为搜索条件， 但不能将排在后面的字段作为搜索条件。若跳过前一个搜索条件直接搜索第二个字段将导致索引失效。</p>
<p>聚簇索引和非聚簇索引<br>聚簇索引：索引和数据是捆在一起的，所以一张表中只能有一个主键。如果对非主键的字段设立的索引，那么其索引的叶子节点的信息为索引和主键索引的对应关系，通过主键索引的信息找到相对应的数据。（InnoDB就是聚簇分布）<br>非聚簇索引：索引和数据是分开的（MyISAM为非聚簇表分布）</p>
<p>创建索引：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CREATE [ONLINE|OFFLINE] [UNIQUE|FULLTEXT|SPATIAL] INDEX index_name</span><br><span class="line">    [index_type]</span><br><span class="line">    ON tbl_name (index_col_name,...)</span><br><span class="line">    [index_option] ...</span><br><span class="line"></span><br><span class="line">index_col_name:</span><br><span class="line">    col_name [(length)] [ASC | DESC]</span><br><span class="line"></span><br><span class="line">index_type:</span><br><span class="line">    USING &#123;BTREE | HASH&#125;</span><br><span class="line"></span><br><span class="line">index_option:</span><br><span class="line">    KEY_BLOCK_SIZE [=] value</span><br><span class="line">  | index_type</span><br><span class="line">  | WITH PARSER parser_name</span><br><span class="line">  | COMMENT <span class="string">&#x27;string&#x27;</span></span><br></pre></td></tr></table></figure>
<p>删除索引：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DROP INDEX index_name ON tbl_name;</span><br></pre></td></tr></table></figure>
<p>查看索引：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SHOW INDEXES FORM tlb_name;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<p>MySQL的并发控制：<br>在数据库中经常设计到并发访问，此时就涉及到不同用户同时修改同一个资源的问题。此时就涉及到一个冲突的问题。为了防止这种冲突的发生，确保数据的安全，就需要对数据加锁的机制，MyISAM使用的是表级锁，InnoDB使用的是行级锁。锁又分为读锁和写锁，读锁也叫共享锁，只可读不可写，多个读互不阻塞，写锁又称为独占锁，写锁会阻碍其他事务的读和写。锁又有隐式锁和显式锁的分别，隐式锁是由存储引擎自动施加的，显式锁式用户自己手动添加的</p>
<p>手动添加锁的方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LOCK TABLES tbl_name lock_type;   <span class="comment">#lock_type可以为read,write也就是读锁和写锁</span></span><br></pre></td></tr></table></figure>
<p>解锁：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>
<p>第二种加锁方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FLUSH TABLES [tbl_name[,...]][WITH READ LOCK]</span><br><span class="line"><span class="comment">#tbl_name如果不添加则对整个数据库加锁，通常在备份前加全局读锁</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL查看数据库表容量大小</title>
    <url>/2019/04/17/MySQL/MySQL%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E5%AE%B9%E9%87%8F%E5%A4%A7%E5%B0%8F/MySQL%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E5%AE%B9%E9%87%8F%E5%A4%A7%E5%B0%8F/</url>
    <content><![CDATA[<h1 id="MySQL查看数据库表容量大小"><a href="#MySQL查看数据库表容量大小" class="headerlink" title="MySQL查看数据库表容量大小"></a>MySQL查看数据库表容量大小</h1><p>1.查看所有数据库容量大小</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">table_schema as <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line">sum(table_rows) as <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line">sum(truncate(data_length/1024/1024, 2)) as <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line">sum(truncate(index_length/1024/1024, 2)) as <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line">from information_schema.tables</span><br><span class="line">group by table_schema</span><br><span class="line">order by sum(data_length) desc, sum(index_length) desc;</span><br></pre></td></tr></table></figure>

<p>2.查看所有数据库各表容量大小</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">table_schema as <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line">table_name as <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">table_rows as <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line">truncate(data_length/1024/1024, 2) as <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line">truncate(index_length/1024/1024, 2) as <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line">from information_schema.tables</span><br><span class="line">order by data_length desc, index_length desc;</span><br><span class="line">```　　</span><br><span class="line"></span><br><span class="line">3.查看指定数据库容量大小</span><br><span class="line"></span><br><span class="line">例：查看mysql库容量大小</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">select</span><br><span class="line">table_schema as <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line">sum(table_rows) as <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line">sum(truncate(data_length/1024/1024, 2)) as <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line">sum(truncate(index_length/1024/1024, 2)) as <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line">from information_schema.tables</span><br><span class="line"><span class="built_in">where</span> table_schema=<span class="string">&#x27;mysql&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>4.查看指定数据库各表容量大小</p>
<p>例：查看mysql库各表容量大小</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">table_schema as <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line">table_name as <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">table_rows as <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line">truncate(data_length/1024/1024, 2) as <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line">truncate(index_length/1024/1024, 2) as <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line">from information_schema.tables</span><br><span class="line"><span class="built_in">where</span> table_schema=<span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">order by data_length desc, index_length desc;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL用户和权限</title>
    <url>/2019/04/17/MySQL/MySQL%E7%94%A8%E6%88%B7%E5%92%8C%E6%8E%88%E6%9D%83/MySQL%E7%94%A8%E6%88%B7%E5%92%8C%E6%8E%88%E6%9D%83/</url>
    <content><![CDATA[<p>在MySQL中有一个系统自身就带有的数据库叫MySQL，数据库装好以后系统自带了好几个数据库，MySQL就是其中过一个，MySQL数据库有个用户账户权限相关的表叫user表，在其中就有创建的用户。</p>
<p>MySQL中完整的用户名是由用户+主机名形成，主机名决定了这个用户在哪个主机上能登陆。  </p>
<span id="more"></span>
<h2 id="用户的创建、删除和密码修改"><a href="#用户的创建、删除和密码修改" class="headerlink" title="用户的创建、删除和密码修改"></a>用户的创建、删除和密码修改</h2><h3 id="用户的创建"><a href="#用户的创建" class="headerlink" title="用户的创建"></a>用户的创建</h3><p>MySQL创建用户时可以使用create user命令来进行创建，也可以在授权时直接创建出用户。此处将演示create user的用法。</p>
<p>语法格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">create user <span class="string">&#x27;USERNAME&#x27;</span>@<span class="string">&#x27;HOST&#x27;</span> identified by <span class="string">&#x27;PASSWORD&#x27;</span>;</span><br><span class="line"></span><br><span class="line">USERNAME:用户名</span><br><span class="line">HOST:主机地址</span><br><span class="line">PASSWORD:密码</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; create user masuri@192.168.73.133 identified by <span class="string">&#x27;centos&#x27;</span>;   <span class="comment">#创建一个账户，用户名为masuri，指定主机地址为192。168.73.133，指定密码为centos</span></span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; select user,host,password from mysql.user;        <span class="comment">#查询mysql.user表中是否创建了masuri用户</span></span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">| user   | host                  | password                                  |</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">| root   | localhost             |                                           |</span><br><span class="line">| root   | localhost.localdomain |                                           |</span><br><span class="line">| root   | 127.0.0.1             |                                           |</span><br><span class="line">| root   | ::1                   |                                           |</span><br><span class="line">|        | localhost             |                                           |</span><br><span class="line">|        | localhost.localdomain |                                           |</span><br><span class="line">| masuri | 192.168.73.133        | *128977E278358FF80A246B5046F51043A2B1FCED |</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<h3 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h3><p>MySQL删除用户使用DROP命令</p>
<p>语法格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DROP USER <span class="string">&#x27;USERNAME&#x27;</span>@<span class="string">&#x27;HOST&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>MySQL中有匿名账户，可以通过跑安全加固脚本mysql_secure_installation来进行删除，也可以手动将其删除。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; select user,host,password from mysql.user;      <span class="comment">#查看下当前MySQL数据库中都有哪些用户</span></span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">| user   | host                  | password                                  |</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">| root   | localhost             |                                           |</span><br><span class="line">| root   | localhost.localdomain |                                           |</span><br><span class="line">| root   | 127.0.0.1             |                                           |</span><br><span class="line">| root   | ::1                   |                                           |</span><br><span class="line">|        | localhost             |                                           |</span><br><span class="line">|        | localhost.localdomain |                                           |</span><br><span class="line">| masuri | 192.168.73.133        | *128977E278358FF80A246B5046F51043A2B1FCED |</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除匿名用户</span></span><br><span class="line">MariaDB [(none)]&gt; DROP USER <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; DROP USER <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;localhost.localdomain&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#再次查看MySQL数据库中的用户</span></span><br><span class="line">MariaDB [(none)]&gt; select user,host,password from mysql.user;</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">| user   | host                  | password                                  |</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">| root   | localhost             |                                           |</span><br><span class="line">| root   | localhost.localdomain |                                           |</span><br><span class="line">| root   | 127.0.0.1             |                                           |</span><br><span class="line">| root   | ::1                   |                                           |</span><br><span class="line">| masuri | 192.168.73.133        | *128977E278358FF80A246B5046F51043A2B1FCED |</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="mysql密码的修改"><a href="#mysql密码的修改" class="headerlink" title="mysql密码的修改"></a>mysql密码的修改</h3><p>MySQL修改密码有两种方法，可以使用SET PASSWORD命令对其修改，也可以使用UPDATE命令对mysql库中的user表的字段做修改</p>
<p>语法格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SET PASSWORD FOR user = PASSWORD(<span class="string">&#x27;cleartext password&#x27;</span>)</span><br><span class="line">UPDATE table SET password = password(<span class="string">&#x27;cleartext password&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>对masuri用户做密码的修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SET PASSWORD FOR masuri@192.168.73.133 = PASSWORD (<span class="string">&#x27;magedu&#x27;</span>);</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; select user,host,password from mysql.user;</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">| user   | host                  | password                                  |</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">| root   | localhost             |                                           |</span><br><span class="line">| root   | localhost.localdomain |                                           |</span><br><span class="line">| root   | 127.0.0.1             |                                           |</span><br><span class="line">| root   | ::1                   |                                           |</span><br><span class="line">| masuri | 192.168.73.133        | *6B8CCC83799A26CD19D7AD9AEEADBCD30D8A8664 |</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line"><span class="comment">#此时密码已经发生改变</span></span><br></pre></td></tr></table></figure>

<p>root账号口令为空，为root口令设置口令，由于一条一条的设置太过麻烦也可以使用修改表的操作来修改密码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; update mysql.user <span class="built_in">set</span> password=password(<span class="string">&#x27;centos&#x27;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span>;    <span class="comment">#匹配user字段为root的账户密码全部改为centos</span></span><br><span class="line">Query OK, 4 rows affected (0.01 sec)</span><br><span class="line">Rows matched: 4  Changed: 4  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; select user,host,password from mysql.user;</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">| user   | host                  | password                                  |</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">| root   | localhost             | *128977E278358FF80A246B5046F51043A2B1FCED |</span><br><span class="line">| root   | localhost.localdomain | *128977E278358FF80A246B5046F51043A2B1FCED |</span><br><span class="line">| root   | 127.0.0.1             | *128977E278358FF80A246B5046F51043A2B1FCED |</span><br><span class="line">| root   | ::1                   | *128977E278358FF80A246B5046F51043A2B1FCED |</span><br><span class="line">| masuri | 192.168.73.133        | *6B8CCC83799A26CD19D7AD9AEEADBCD30D8A8664 |</span><br><span class="line">+--------+-----------------------+-------------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">此时密码已经修改但依旧无法登陆，需要将权限刷新</span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="MySQL权限管理"><a href="#MySQL权限管理" class="headerlink" title="MySQL权限管理"></a>MySQL权限管理</h2><p>权限管理涉及到多种权限的类别，比如说有管理类、程序类、数据库级别、表级别和字段级别</p>
<p>管理类：能否创建用户，能否显示数据库列表，能否重新加载配置文件，能否关闭数据库，和复制相关的能否执行，能否管理进程，能否创建临时表，能否创建数据库中的文件。  </p>
<p>程序类：主要涉及3个程序，函数、存储过程和触发器，例如能否创建，修改，删除和执行这些程序  </p>
<p>库，表和字段级别的权限：比如能否在库，表字段里进行增、删、查、改等操作  </p>
<h3 id="授权GRANT"><a href="#授权GRANT" class="headerlink" title="授权GRANT"></a>授权GRANT</h3><p>授权用户时如果用户不存在可以将其创建出来，在授权前首先要确认自己是管理员有授权的权限。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GRANT</span><br><span class="line">    priv_type [(column_list)]</span><br><span class="line">      [, priv_type [(column_list)]] ...</span><br><span class="line">    ON [object_type] priv_level</span><br><span class="line">    TO user_specification [, user_specification] ...</span><br><span class="line">    [REQUIRE &#123;NONE | ssl_option [[AND] ssl_option] ...&#125;]</span><br><span class="line">    [WITH with_option ...]</span><br></pre></td></tr></table></figure>

<p>示例：<br>创建一个wordpress的用户，并授权。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CREATE DATABASE wordpress;</span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL ON wordpress.* TO wpuser@<span class="string">&#x27;192.168.73.%&#x27;</span> identified by <span class="string">&#x27;mylinuxops&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="查看用户的权限"><a href="#查看用户的权限" class="headerlink" title="查看用户的权限"></a>查看用户的权限</h3><p>使用show grants 命令可以查看一个账户的授权</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show grants <span class="keyword">for</span> wpuser@<span class="string">&#x27;192.168.73.%&#x27;</span>;</span><br><span class="line">+------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> wpuser@192.168.73.%                                                                                   |</span><br><span class="line">+------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;wpuser&#x27;</span>@<span class="string">&#x27;192.168.73.%&#x27;</span> IDENTIFIED BY PASSWORD <span class="string">&#x27;*EC0DBFB480593BB6ED2EC028A4231A72D8137406&#x27;</span> |</span><br><span class="line">| GRANT ALL PRIVILEGES ON `wordpress`.* TO <span class="string">&#x27;wpuser&#x27;</span>@<span class="string">&#x27;192.168.73.%&#x27;</span>                                                 |</span><br><span class="line">+------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="授权的其他选项"><a href="#授权的其他选项" class="headerlink" title="授权的其他选项"></a>授权的其他选项</h3><p>MySQL在授权时候还可以限制用户的某些操作，其选项有以下这些</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MAX_QUESRIES_PER_HOUR count   <span class="comment">#每小时最多查多少次</span></span><br><span class="line">MAX_UPDATES_PER_HOUR count    <span class="comment">#每小时最多改多少次</span></span><br><span class="line">MAX_CONNECTIONS_PER_HOUR count <span class="comment">#每小时最多连多少次</span></span><br><span class="line">MAX_USER_CONNECTIONS count    <span class="comment">#用户的最大数连接数</span></span><br></pre></td></tr></table></figure>

<h3 id="取消权限"><a href="#取消权限" class="headerlink" title="取消权限"></a>取消权限</h3><p>有授权就有需要授权，取消授权时使用命令为REVOKE，其如法如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">REVOKE</span><br><span class="line">    priv_type [(column_list)]</span><br><span class="line">      [, priv_type [(column_list)]] ...</span><br><span class="line">    ON [object_type] priv_level</span><br><span class="line">    FROM user [, user] ...</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>需要<a href="mailto:&#119;&#x70;&#x75;&#x73;&#101;&#x72;&#x40;&#x31;&#57;&#x32;&#46;&#x31;&#54;&#x38;&#46;&#55;&#51;">&#119;&#x70;&#x75;&#x73;&#101;&#x72;&#x40;&#x31;&#57;&#x32;&#46;&#x31;&#54;&#x38;&#46;&#55;&#51;</a>.%这个账号对于wordpress库的删除权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; revoke delete on wordpress.* from wpuser@<span class="string">&#x27;192.168.73.%&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show grants <span class="keyword">for</span> wpuser@<span class="string">&#x27;192.168.73.%&#x27;</span>;</span><br><span class="line">+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> wpuser@192.168.73.%                                                                                                                                                                                                         |</span><br><span class="line">+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;wpuser&#x27;</span>@<span class="string">&#x27;192.168.73.%&#x27;</span> IDENTIFIED BY PASSWORD <span class="string">&#x27;*EC0DBFB480593BB6ED2EC028A4231A72D8137406&#x27;</span>                                                                                                                       |</span><br><span class="line">| GRANT SELECT, INSERT, UPDATE, CREATE, DROP, REFERENCES, INDEX, ALTER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, EVENT, TRIGGER ON `wordpress`.* TO <span class="string">&#x27;wpuser&#x27;</span>@<span class="string">&#x27;192.168.73.%&#x27;</span> |</span><br><span class="line">+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"><span class="comment"># 此时wpuser@&#x27;192.168.73.%&#x27;已经没有了delete权限</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL的root口令破解</title>
    <url>/2019/04/17/MySQL/MySQL%E7%9A%84root%E5%8F%A3%E4%BB%A4%E7%A0%B4%E8%A7%A3/MySQL%E7%9A%84root%E5%8F%A3%E4%BB%A4%E7%A0%B4%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="MySQL的root口令破解"><a href="#MySQL的root口令破解" class="headerlink" title="MySQL的root口令破解"></a>MySQL的root口令破解</h2><p>工作中有时候可能会遇到root口令丢失的情况，此时可以通过以下方法进行破解root口令</p>
<span id="more"></span>
<h3 id="MySQL破解root口令演示"><a href="#MySQL破解root口令演示" class="headerlink" title="MySQL破解root口令演示"></a>MySQL破解root口令演示</h3><p>当前环境由于root密码未知无法登陆MySQL</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql</span></span><br><span class="line">ERROR 1045 (28000): Access denied <span class="keyword">for</span> user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (using password: NO)</span><br></pre></td></tr></table></figure>

<p>修改配置文件/etc/my.cnf，添加两行参数<br>skip_grant_tables:跳过授权表信息，此项生效后再次使用MySQL就无需使用密码了，但是远程的其他用户也可以不使用密码登陆，有一定的风险性<br>skip_networking:关闭网路功能，由于光启用skip_grant_tables选项，其他用户也可以无需密码登陆MySQL非常危险，所以需要关闭网路功能只允许本地的用户进行操作。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">skip_networking=on            <span class="comment">#不启用网络功能</span></span><br><span class="line">skip_grant_tables=on          <span class="comment">#跳过授权表</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># service mysqld restart                            #对位置文件修改后需要重新启动服务</span></span><br><span class="line">Restarting mysqld (via systemctl):                         [  OK  ]</span><br></pre></td></tr></table></figure>

<p>登陆MySQL，进行密码修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql                                           #此时已经无需输入密码就能登陆</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 11</span><br><span class="line">Server version: 10.2.23-MariaDB-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; UPDATE mysql.user SET password=PASSWORD(<span class="string">&#x27;123456&#x27;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span>;        <span class="comment">#对root的口令进行修改</span></span><br><span class="line">Query OK, 4 rows affected (0.01 sec)</span><br><span class="line">Rows matched: 4  Changed: 4  Warnings: 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>口令修改完毕后，需要将配置文件恢复</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#将刚才启用的两个选项进行注销或者删除，然后重启服务</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#skip_networking=on</span></span><br><span class="line"><span class="comment">#skip_grant_tables=on</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># service mysqld restart</span></span><br><span class="line">Restarting mysqld (via systemctl):                         [  OK  ]</span><br></pre></td></tr></table></figure>

<p>使用新口令登陆MySQL</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -uroot -p123456</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 10</span><br><span class="line">Server version: 10.2.23-MariaDB-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;               <span class="comment">#登录成功</span></span><br></pre></td></tr></table></figure>

<p>以上为MySQL的root口令破解方法</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL的事务</title>
    <url>/2019/04/17/MySQL/MySQL%E7%9A%84%E4%BA%8B%E5%8A%A1/MySQL%E7%9A%84%E4%BA%8B%E5%8A%A1/</url>
    <content><![CDATA[<h2 id="什么是事务？"><a href="#什么是事务？" class="headerlink" title="什么是事务？"></a>什么是事务？</h2><p>事务：一组原子性的SQL语句，或一个独立工作单元  </p>
<p>事务日志:记录事务信息，实现undo,redo等故障恢复功能。</p>
<p>UNDO操作:当对数据执行修改操作时会先将数据读入到内存中，然后在内存中进行修改，修改完毕后记录到事务日志，如果一个事务在执行过程中只执行了一半就崩溃了，此时计算机重启后会发现事务不完整就会将之前执行的一半的事务全部撤销不做(undo)，以此来保证数据的完整性。  </p>
<p>REDO操作:假设有2个事务，第一个事务已经完成，开始第二个事务执行到一半时崩溃了，计算机重启后，就会发现第一个事务已经完成，但还能没有写入数据库中，此时就会对第一个事务进行重做(REDO)将修改后的数据写入数据库中，而第二个执行了一半的事务则会撤销不做(UNDO)  </p>
<h2 id="事务的ACID特性"><a href="#事务的ACID特性" class="headerlink" title="事务的ACID特性"></a>事务的ACID特性</h2><p>A:atomicity原子性;整个事务中的所有操作要么全部成功执行，要么全部失败后回滚  </p>
<p>C:consistency一致性;数据库总是从一个一致性状态转换为另一个一致性状态  </p>
<p>I:Isolation隔离性;一个事务所做出的操作在提交之前，是不能为其他事务所见，隔离有多种隔离级别，实现并发  </p>
<p>D：durability持久性;一旦事务提交，其所作的修改会永久保存于数据库中。  </p>
<h2 id="事务的生命周期"><a href="#事务的生命周期" class="headerlink" title="事务的生命周期"></a>事务的生命周期</h2><p>启动事务：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">BEGIN</span><br></pre></td></tr></table></figure>

<p>结束事务:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">COMMIT;                    <span class="comment">#提交</span></span><br><span class="line">ROLLBACK;                  <span class="comment">#回滚</span></span><br></pre></td></tr></table></figure>

<h2 id="事务的使用方法"><a href="#事务的使用方法" class="headerlink" title="事务的使用方法"></a>事务的使用方法</h2><p>t1表内现有数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; INSERT t1 VALUE(2,<span class="string">&#x27;Ye Fan&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; SELECT * FROM t1;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | Lin Dong |</span><br><span class="line">|  2 | Ye Fan   |</span><br><span class="line">+----+----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>开始事务<br>对t1表内插入数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; BEGIN;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="comment">#对t1表插入数据</span></span><br><span class="line">MariaDB [hellodb]&gt; INSERT t1 VALUE(3,<span class="string">&#x27;Shi Hao&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; INSERT t1 VALUE(4,<span class="string">&#x27;Chu Feng&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询下t1表</span></span><br><span class="line">MariaDB [hellodb]&gt; select * from t1;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | Lin Dong |</span><br><span class="line">|  2 | Ye Fan   |</span><br><span class="line">|  3 | Shi Hao  |</span><br><span class="line">|  4 | Chu Feng |</span><br><span class="line">+----+----------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>由于此时还没有进行提交，虽然本地能查询到，但切换到其他的终端查询到数据依旧为老的数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#切换终端对t1表进行查询，此时返回的结果依旧为旧的数据</span></span><br><span class="line">MariaDB [(none)]&gt; select * from hellodb.t1;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | Lin Dong |</span><br><span class="line">|  2 | Ye Fan   |</span><br><span class="line">+----+----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>切换回本地对数据进行提交</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; commit;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>再次切换至其他终端，此时已经能查询到新增加的数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; select * from hellodb.t1;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | Lin Dong |</span><br><span class="line">|  2 | Ye Fan   |</span><br><span class="line">|  3 | Shi Hao  |</span><br><span class="line">|  4 | Chu Feng |</span><br><span class="line">+----+----------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>事务还能进行回滚</p>
<p>对t1表内插入数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; BEGIN;                                            <span class="comment">#开始事务</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; INSERT t1 VALUE(5,<span class="string">&#x27;Qing Di&#x27;</span>);                     <span class="comment">#对t1表插入数据</span></span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; SELECT * FROM t1;                                 <span class="comment">#查询t1表</span></span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | Lin Dong |</span><br><span class="line">|  2 | Ye Fan   |</span><br><span class="line">|  3 | Shi Hao  |</span><br><span class="line">|  4 | Chu Feng |</span><br><span class="line">|  5 | Qing Di  |                                                   <span class="comment">#新增了第5条记录</span></span><br><span class="line">+----+----------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; ROLLBACK;                                        <span class="comment">#对数据进行回滚</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; SELECT * FROM t1;                                <span class="comment">#再次查询，此时已经没有第5条记录了</span></span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | Lin Dong |</span><br><span class="line">|  2 | Ye Fan   |</span><br><span class="line">|  3 | Shi Hao  |</span><br><span class="line">|  4 | Chu Feng |</span><br><span class="line">+----+----------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>事务的自动提交</p>
<p>在默认情况下MySQL执行增删改命令时是自动提交的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; SHOW VARIABLES LIKE <span class="string">&#x27;autocommit&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| autocommit    | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>也可以将其设置为手动提交</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; <span class="built_in">set</span> autocommit=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; SHOW VARIABLES LIKE <span class="string">&#x27;autocommit&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| autocommit    | OFF   |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>此处需要注意的是DDL语句是会自动提交的。</p>
<p>事务的保存点</p>
<p>事务还支持保存点savepoint</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SAVEPOINT identifier</span><br><span class="line">ROLLBACK TO [SAVEPOINT] identifier</span><br><span class="line">RELEASWE SAVEPOINT identifier</span><br></pre></td></tr></table></figure>

<p>保存点可以起到部分回滚的效果</p>
<p>保存点使用方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; begin;                   <span class="comment">#开始事务</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; SELECT * FROM t1;        <span class="comment">#此时表内有4条记录</span></span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | Lin Dong |</span><br><span class="line">|  2 | Ye Fan   |</span><br><span class="line">|  3 | Shi Hao  |</span><br><span class="line">|  4 | Chu Feng |</span><br><span class="line">+----+----------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; INSERT t1 VALUE(5,<span class="string">&#x27;Cheng Dong&#x27;</span>);     <span class="comment">#对表内添加记录</span></span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; SAVEPOINT <span class="built_in">cd</span>;                        <span class="comment">#设置保存点</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; INSERT t1 VALUE(6,<span class="string">&#x27;Xiao Yan&#x27;</span>);       <span class="comment">#添加记录</span></span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; SAVEPOINT xy;                        <span class="comment">#设置保存点</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; INSERT t1 VALUE(7,<span class="string">&#x27;Mei Dusha&#x27;</span>);      <span class="comment">#添加记录</span></span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; SELECT * FROM t1;                    <span class="comment">#查看表内的记录</span></span><br><span class="line">+----+------------+</span><br><span class="line">| id | name       |</span><br><span class="line">+----+------------+</span><br><span class="line">|  1 | Lin Dong   |</span><br><span class="line">|  2 | Ye Fan     |</span><br><span class="line">|  3 | Shi Hao    |</span><br><span class="line">|  4 | Chu Feng   |</span><br><span class="line">|  5 | Cheng Dong |</span><br><span class="line">|  6 | Xiao Yan   |</span><br><span class="line">|  7 | Mei Dusha  |</span><br><span class="line">+----+------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; ROLLBACK TO xy;                      <span class="comment">#回滚至xy的保存点</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; SELECT * FROM t1;</span><br><span class="line">+----+------------+</span><br><span class="line">| id | name       |</span><br><span class="line">+----+------------+</span><br><span class="line">|  1 | Lin Dong   |</span><br><span class="line">|  2 | Ye Fan     |</span><br><span class="line">|  3 | Shi Hao    |</span><br><span class="line">|  4 | Chu Feng   |</span><br><span class="line">|  5 | Cheng Dong |</span><br><span class="line">|  6 | Xiao Yan   |</span><br><span class="line">+----+------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; commit</span><br></pre></td></tr></table></figure>

<h2 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h2><ol>
<li><p>READ UNCOMMITTED:可读取未提交数据，产生脏读</p>
</li>
<li><p>READ COMMITTED:可以读到提交数据，但未提交数据不可读，产生不可重复读，即可读取到多个提交数据，导致每次读取数据不一致。</p>
</li>
<li><p>REPEATABLE READ:可重复读，多次读取数据都一致，会产生幻读，即读取过程中，即使有其他提交的事务修改数据，仍只能读取到未修改前的旧数据，此为MySQL的默认设置</p>
</li>
<li><p>SERALIZABLE：可串行化，未提交的读事务阻塞修改事务，或者未提交的修改事务阻塞读事务。导致并发性能差</p>
</li>
</ol>
<p>隔离级别，从上至下越来越严格。</p>
<table>
<thead>
<tr>
<th align="left">事务隔离级别</th>
<th align="left">脏读可能性</th>
<th align="left">不可重复读可能性</th>
<th align="left">幻读可能性</th>
<th align="left">加锁读</th>
</tr>
</thead>
<tbody><tr>
<td align="left">READ UNCOMMITTED</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">否</td>
</tr>
<tr>
<td align="left">READ COMMITTED</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">否</td>
</tr>
<tr>
<td align="left">REPEATABLE READ</td>
<td align="left">否</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">否</td>
</tr>
<tr>
<td align="left">SERIALIZABLE</td>
<td align="left">否</td>
<td align="left">否</td>
<td align="left">否</td>
<td align="left">是</td>
</tr>
</tbody></table>
<h3 id="事务隔离级别设定"><a href="#事务隔离级别设定" class="headerlink" title="事务隔离级别设定"></a>事务隔离级别设定</h3><p>事务的隔离级别可以通过服务器变量tx_isolation指定，可在全局和会话级进行设置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SET tx_isolation=<span class="string">&#x27;LEVEL&#x27;</span></span><br></pre></td></tr></table></figure>

<p>查看当前事务隔离级别</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">&#x27;tx_isolation&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>事务的隔离级别也可以通过服务器的选项来指定。</p>
<p>服务器选项为transaction-isolation，需要将其写入配置文件中。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]  </span><br><span class="line">transaction-isolation=SERIALIZABLE</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL的备份还原(mysqldump)</title>
    <url>/2019/04/10/MySQL/MySQL%E7%9A%84%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F(mysqldump)/MySQL%E7%9A%84%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F(mysqldump)/</url>
    <content><![CDATA[<p>MySQL的还原前提是要建立在，有完全备份和二进制日志开启的前提下，并且二进制日志文件和完全备份存放在与数据库文件不同的磁盘上，否则当磁盘发生损坏数据将无法进行恢复。</p>
<span id="more"></span>

<h2 id="mysqldump备份还原"><a href="#mysqldump备份还原" class="headerlink" title="mysqldump备份还原"></a>mysqldump备份还原</h2><p>mysqldump是逻辑备份工具，使用于所有存储引擎，温备份；支持完全或部分备份；对InnoDB存储引擎支持热备，结合binlog的增量备份可以实现数据库的完全备份及还原。</p>
<h3 id="mysqldump语法"><a href="#mysqldump语法" class="headerlink" title="mysqldump语法"></a>mysqldump语法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#挑选某个库或者挑选某个表来备份，由于此方法没有备份数据库的定义，在还原时需要先创建出数据库，然而原先数据库的定义方式并不知晓，所以此方法不推荐使用</span></span><br><span class="line">mysqldump [OPTIONS] database [tables]</span><br><span class="line"><span class="comment">#使用-B选项后面跟上各数据库的名称，可以选择特定的数据库做备份。使用此方法备份可以备份数据库的定义。</span></span><br><span class="line">mysqldump [OPTIONS] -B DB1 [DB2 DB3 ...]</span><br><span class="line"><span class="comment">#使用-A选项可以备份数据库中除information_schema和performance_schema的所有数据库。</span></span><br><span class="line">mysqldump [OPTIONS] -A [OPTIONS]</span><br></pre></td></tr></table></figure>

<h2 id="开启二进制日志"><a href="#开启二进制日志" class="headerlink" title="开启二进制日志"></a>开启二进制日志</h2><p>开启二进制日志需要将MySQL中的sql_log_bin和log_bin这两个选项</p>
<p>1.开启sql_log_bin</p>
<p>系统中默认开启sql_log_bin选项所以此处无需修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW VARIABLES LIKE <span class="string">&#x27;sql_log_bin&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| sql_log_bin   | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>2.开启log_bin</p>
<p>此选项需要对MySQL的配置文件进行修改，在修改之前需要先创建一个二进制日志存放的位置。<strong>注意：不要和数据库存放在同一磁盘内，不要和数据库存放在同一磁盘内，不要和数据库存放在同一磁盘内</strong>重要的事情说三遍。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir /data/bin</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chown -R mysql.mysql /data/bin  #将目录的属主和属组都改为mysql</span></span><br></pre></td></tr></table></figure>

<p>二进制日志目录创建完毕后，修改配置文件，添加log-bin选项，并指定路径，此处要注意mysql-bin是二进制日志的抬头。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/mysql/my.cnf</span></span><br><span class="line">log-bin=/data/bin/mysql-bin            <span class="comment">#mysql-bin为二进制日志的文件名的抬头</span></span><br></pre></td></tr></table></figure>

<p>以上配置完成后重启mysql服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># service mysqld restart</span></span><br><span class="line">Restarting mysqld (via systemctl):                         [  OK  ]</span><br></pre></td></tr></table></figure>

<p>此时二进制日志目录下已经多出了两个二进制日志文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ll /data/bin/</span></span><br><span class="line">total 12</span><br><span class="line">-rw-rw---- 1 mysql mysql 351 May  6 16:51 mysql-bin.000001</span><br><span class="line">-rw-rw---- 1 mysql mysql  54 May  6 16:51 mysql-bin.index</span><br></pre></td></tr></table></figure>

<h2 id="场景一、磁盘损坏恢复"><a href="#场景一、磁盘损坏恢复" class="headerlink" title="场景一、磁盘损坏恢复"></a>场景一、磁盘损坏恢复</h2><p>生产中会发生存放数据的磁盘突然发生损坏而造成数据丢失的情况，此时就需要结合之前所作的完全备份以及二进制日志进行将数据完全恢复</p>
<h3 id="场景模拟"><a href="#场景模拟" class="headerlink" title="场景模拟"></a>场景模拟</h3><p>对数据库进行备份</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># mysqldump -A --single-transaction --master-data=2 | xz &gt; /data/all.sql.xz</span></span><br></pre></td></tr></table></figure>

<p>备份完毕后数据库发生小部分变化</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; INSERT hellodb.students(stuid,name,gender,age) VALUE(26,<span class="string">&#x27;linchong&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,30) ;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; INSERT hellodb.students(stuid,name,gender,age) VALUE(27,<span class="string">&#x27;Lujunyi&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,30);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>数据库发生破坏，数据丢失</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rm -rf /data/mysql/*</span></span><br></pre></td></tr></table></figure>

<h3 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h3><p>将mysqld服务停止</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># service mysqld stop</span></span><br><span class="line">Stopping mysqld (via systemctl):                           [  OK  ]</span><br></pre></td></tr></table></figure>

<p>查看下二进制日志，由于每次启动服务都会重新生成一个新的二进制日志，所以先查看下二进制日志的编号以免等下在使用二进制日志还原数据时还原了不必要的数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ll /data/bin/</span></span><br><span class="line">total 504</span><br><span class="line">-rw-rw---- 1 mysql mysql    351 May  6 16:51 mysql-bin.000001</span><br><span class="line">-rw-rw---- 1 mysql mysql   9388 May  6 17:01 mysql-bin.000002</span><br><span class="line">-rw-rw---- 1 mysql mysql     81 May  6 17:03 mysql-bin.index</span><br></pre></td></tr></table></figure>

<p>重启MySQL服务，初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># service mysqld start</span></span><br><span class="line">Starting mysqld (via systemctl):                           [  OK  ]</span><br><span class="line">[root@localhost ~]<span class="comment"># ll /data/mysql/</span></span><br><span class="line">total 122924</span><br><span class="line">-rw-rw---- 1 mysql mysql    16384 May  6 17:01 aria_log.00000001</span><br><span class="line">-rw-rw---- 1 mysql mysql       52 May  6 17:01 aria_log_control</span><br><span class="line">drwx------ 2 mysql mysql      272 May  6 16:54 hellodb</span><br><span class="line">-rw-rw---- 1 mysql mysql     1298 May  6 17:01 ib_buffer_pool</span><br><span class="line">-rw-rw---- 1 mysql mysql 12582912 May  6 17:03 ibdata1</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 May  6 17:03 ib_logfile0</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Apr 29 12:49 ib_logfile1</span><br><span class="line">-rw-rw---- 1 mysql mysql 12582912 May  6 17:03 ibtmp1</span><br><span class="line">-rw-rw---- 1 mysql mysql        6 May  6 17:03 localhost.localdomain.pid</span><br><span class="line">-rw-rw---- 1 mysql mysql        0 Apr 29 12:57 multi-master.info</span><br><span class="line">drwx------ 2 mysql root      4096 Apr 29 12:49 mysql</span><br><span class="line">-rw-rw---- 1 mysql mysql      351 Apr 29 14:06 mysql-bin.000001</span><br><span class="line">-rw-rw---- 1 mysql mysql      351 May  6 16:50 mysql-bin.000002</span><br><span class="line">-rw-rw---- 1 mysql mysql       38 May  6 16:26 mysql-bin.index</span><br><span class="line">-rw-rw---- 1 mysql mysql        0 May  6 16:50 mysql-bin.state</span><br><span class="line">srwxrwxrwx 1 mysql mysql        0 May  6 17:03 mysql.sock</span><br><span class="line">drwx------ 2 mysql mysql       20 Apr 29 12:49 performance_schema</span><br><span class="line">drwx------ 2 mysql root         6 Apr 29 12:49 <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>将完全备份解压</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># unxz /data/all.sql.xz</span></span><br></pre></td></tr></table></figure>

<p>由于完全备份后数据又发生过改变所以需要利用二进制日志进行还原，在利用二进制还原前，先查看下完全备份时二进制日志所在的位置。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /data/all.sql</span></span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000002&#x27;</span>, MASTER_LOG_POS=8946;</span><br></pre></td></tr></table></figure>

<p>将完全备份后产生二进制日志的数据导出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysqlbinlog --start-position=8946 /data/bin/mysql-bin.000002 &gt; /data/inc.sql</span></span><br></pre></td></tr></table></figure>

<p>进入MySQL,停止二进制日志记录</p>
<p>由于接下来的操作是恢复数据，所以此处不需要让二进制日志记录数据。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SET sql_log_bin=off;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>导入之前做的完全备份</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; <span class="built_in">source</span> /data/all.sql</span><br></pre></td></tr></table></figure>

<p>导入完全备份后产生的数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; <span class="built_in">source</span> /data/inc.sql</span><br></pre></td></tr></table></figure>

<p>验证，查看数据库，以及完全备份后增加的内容是否存在</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -e &#x27;SHOW DATABASES;SELECT * FROM hellodb.students where stuid&gt;25;&#x27;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">+-------+----------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name     | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+----------+-----+--------+---------+-----------+</span><br><span class="line">|    26 | linchong |  30 | M      |    NULL |      NULL |</span><br><span class="line">|    27 | Lujunyi  |  30 | M      |    NULL |      NULL |</span><br><span class="line">+-------+----------+-----+--------+---------+-----------+</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="场景二、误删除的恢复"><a href="#场景二、误删除的恢复" class="headerlink" title="场景二、误删除的恢复"></a>场景二、误删除的恢复</h2><p>生产环境中通常会出现误删除的可能性，此时就需要用到完全备份，和部分修改后的二进制日志来还原数据</p>
<h3 id="场景模拟-1"><a href="#场景模拟-1" class="headerlink" title="场景模拟"></a>场景模拟</h3><p>对数据库进行完全备份</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysqldump -A --single-transaction --master-data=2 | xz &gt; /data/all.sql.xz</span></span><br></pre></td></tr></table></figure>

<p>一段时间后数据库发生了误删除操作,然后又进行了部分其他的新增的操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; DROP TABLE hellodb.students;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; INSERT hellodb.teachers VALUE (5,<span class="string">&#x27;Jiang Jieshi&#x27;</span>,50,<span class="string">&#x27;M&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>此时发现了数据库hellodb.students表被删除  </p>
<h3 id="恢复数据库"><a href="#恢复数据库" class="headerlink" title="恢复数据库"></a>恢复数据库</h3><p>停止MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># service mysqld stop</span></span><br><span class="line">Stopping mysqld (via systemctl):                           [  OK  ]</span><br></pre></td></tr></table></figure>

<p>将数据库文件内的文件清空</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rm -rf /data/mysql/*</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将完全备份解压</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># unxz /data/all.sql.xz</span></span><br></pre></td></tr></table></figure>

<p>查看完全备份内，二进制日志的记录点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /data/all.sql</span></span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000003&#x27;</span>, MASTER_LOG_POS=494073;</span><br></pre></td></tr></table></figure>

<p>查看二进制日志，并从二级制日志中导出数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ll /data/bin/</span></span><br><span class="line">total 508</span><br><span class="line">-rw-rw---- 1 mysql mysql    351 May  6 16:51 mysql-bin.000001</span><br><span class="line">-rw-rw---- 1 mysql mysql   9388 May  6 17:01 mysql-bin.000002</span><br><span class="line">-rw-rw---- 1 mysql mysql 494449 May  6 17:52 mysql-bin.000003</span><br><span class="line">-rw-rw---- 1 mysql mysql     81 May  6 17:03 mysql-bin.index</span><br><span class="line">-rw-rw---- 1 mysql mysql      8 May  6 17:52 mysql-bin.state</span><br><span class="line">[root@localhost ~]<span class="comment"># mysqlbinlog --start-position=494073 /data/bin/mysql-bin.000003 &gt; /data/inc.sql</span></span><br></pre></td></tr></table></figure>

<p>从导出的数据中找到那条误删除的数据将其删除或注释</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /data/inc.sql</span></span><br><span class="line"><span class="comment">#DROP TABLE `hellodb`.`students` /* generated by server */</span></span><br></pre></td></tr></table></figure>

<p>重启MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># service mysqld start</span></span><br><span class="line">Starting mysqld (via systemctl):                           [  OK  ]</span><br></pre></td></tr></table></figure>

<p>将二进制日志关闭</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SET sql_log_bin=off;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>导入完全备份</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SOURCE /data/all.sql</span><br><span class="line"></span><br><span class="line">MariaDB [<span class="built_in">test</span>]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"><span class="comment">#此时被删除的students表已经找回</span></span><br><span class="line">MariaDB [<span class="built_in">test</span>]&gt; SHOW TABLES FROM hellodb;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">| toc               |</span><br><span class="line">+-------------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"><span class="comment">#但是误操作后新加的记录还没有找回</span></span><br><span class="line">MariaDB [<span class="built_in">test</span>]&gt; SELECT * FROM hellodb.teachers ;</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>导入二进制日志所生成的修改后的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [<span class="built_in">test</span>]&gt; SOURCE /data/inc.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">#导入后再次查看students表在</span></span><br><span class="line">MariaDB [<span class="built_in">test</span>]&gt; SHOW TABLES FROM hellodb;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">| toc               |</span><br><span class="line">+-------------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"><span class="comment">#新添加的记录也有了</span></span><br><span class="line">MariaDB [<span class="built_in">test</span>]&gt; SELECT * FROM hellodb.teachers;</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|   5 | Jiang Jieshi  |  50 | M      |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL的备份还原(xtrabackup)</title>
    <url>/2019/04/10/MySQL/MySQL%E7%9A%84%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F(xtrabackup)/MySQL%E7%9A%84%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9Fxtrabackup/</url>
    <content><![CDATA[<h2 id="xtrabackup简介"><a href="#xtrabackup简介" class="headerlink" title="xtrabackup简介"></a>xtrabackup简介</h2><p>xtrabackup是percona提供的MySQL数据库的备份工具，是唯一开源的能对innodb和xtradb数据库进行热备的工具  </p>
<h3 id="xtrabackup的特点"><a href="#xtrabackup的特点" class="headerlink" title="xtrabackup的特点"></a>xtrabackup的特点</h3><ol>
<li>备份还原过程快、可靠  </li>
<li>备份过程不会打断正在执行的事务  </li>
<li>能够基于压缩等功能介于磁盘空间和流量  </li>
<li>自动实现备份检验  </li>
<li>开源免费</li>
</ol>
<span id="more"></span>

<h3 id="xtrabackup备份过程"><a href="#xtrabackup备份过程" class="headerlink" title="xtrabackup备份过程"></a>xtrabackup备份过程</h3><p><img src="xtrabackup.png" alt="xtrabackup.png"></p>
<h3 id="xtrabackup安装"><a href="#xtrabackup安装" class="headerlink" title="xtrabackup安装"></a>xtrabackup安装</h3><p>xtrabackup在centos的EPEL源中，可以在配置完EPEL源后使用yum安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># yum install -y percona-xtrabackup</span></span><br></pre></td></tr></table></figure>

<p>也可以去官网下载最新版本的xtrabackup</p>
<p><a href="https://www.percona.com/downloads/XtraBackup/LATEST">https://www.percona.com/downloads/XtraBackup/LATEST</a></p>
<h3 id="xtrabackup使用"><a href="#xtrabackup使用" class="headerlink" title="xtrabackup使用"></a>xtrabackup使用</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xtrabackup [option] BACKUP-ROOT-DIR</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">–user</td>
<td align="left">备份时连接到MySQL的账号</td>
</tr>
<tr>
<td align="left">–password</td>
<td align="left">备份时连接到MySQL所使用的账号的密码</td>
</tr>
<tr>
<td align="left">–host</td>
<td align="left">备份数据库的地址</td>
</tr>
<tr>
<td align="left">–databases</td>
<td align="left">所要备份的数据库名，如果有多个数据库可以使用”,”隔开，如果备份表则使用”DATABASE.TABLE”来指明</td>
</tr>
<tr>
<td align="left">–incremental</td>
<td align="left">表示创建一个增量备份</td>
</tr>
<tr>
<td align="left">–incremental-basedir</td>
<td align="left">指定前一次完全备份或者增量备份的目录</td>
</tr>
<tr>
<td align="left">–incremental-dir</td>
<td align="left">指定还原时增量备份的目录</td>
</tr>
<tr>
<td align="left">–apply-log</td>
<td align="left">备份完成后的数据不能直接用于恢复操作，因为备份的数据中可能包含尚未提交的事务或已经提交但尚未同步的至数据库中过的事务，此时数据仍处于不一致状态，此选项作用是通过回滚提交的事务及同步已经提交的事务至数据文件使数据文件处于一致性状态</td>
</tr>
<tr>
<td align="left">–apply-log-only</td>
<td align="left">恢复时阻止回滚未完成的事务，在有增量备份时使用</td>
</tr>
<tr>
<td align="left">–export</td>
<td align="left">开启可导出单独的表之后再导入其他MySQL中</td>
</tr>
<tr>
<td align="left">–redo-only</td>
<td align="left">合并增量备份时使用，不包括最后一个增量备份的合并</td>
</tr>
<tr>
<td align="left">–copy-back</td>
<td align="left">做数据恢复时将备份数据文件拷贝到MySQL服务器的datadir</td>
</tr>
<tr>
<td align="left">–move-back</td>
<td align="left">作用和copy-back想用区别在于此选项是用来移动备份的数据</td>
</tr>
</tbody></table>
<hr>
<h2 id="完全备份及还原"><a href="#完全备份及还原" class="headerlink" title="完全备份及还原"></a>完全备份及还原</h2><p>在完全备份之前需要创建一个备份的目录作为存放备份使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir /data/backup</span></span><br></pre></td></tr></table></figure>

<p>数据库内存放的数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -e &#x27;SHOW DATABASES;&#x27;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h3 id="完全备份"><a href="#完全备份" class="headerlink" title="完全备份"></a>完全备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mariabackup --backup --target-dir=/data/backup  --user=root --password=&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="对数据库破坏"><a href="#对数据库破坏" class="headerlink" title="对数据库破坏"></a>对数据库破坏</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rm -rf /data/mysql/*</span></span><br></pre></td></tr></table></figure>

<h3 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h3><p>3.1在恢复数据库前需要先将数据库内数据清理，然后停止mysql服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rm -rf /data/mysql/*</span></span><br><span class="line">[root@localhost ~]<span class="comment"># service mysqld stop</span></span><br><span class="line">Stopping mysqld (via systemctl):                           [  OK  ]</span><br></pre></td></tr></table></figure>

<p>3.2对备份目录做整理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mariabackup --prepare --target-dir=/data/backup</span></span><br></pre></td></tr></table></figure>

<p>3.3将整理好的备份数据还原至数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mariabackup --copy-back --target-dir=/data/backup</span></span><br></pre></td></tr></table></figure>

<p>3.4此时还原回去的数据属性还有问题，需要将其修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ll /data/mysql/</span></span><br><span class="line">total 12320</span><br><span class="line">-rw-r----- 1 root root    16384 May  6 21:28 aria_log.00000001</span><br><span class="line">-rw-r----- 1 root root       52 May  6 21:28 aria_log_control</span><br><span class="line">drwx------ 2 root root      272 May  6 21:28 hellodb</span><br><span class="line">-rw-r----- 1 root root      942 May  6 21:28 ib_buffer_pool</span><br><span class="line">-rw-r----- 1 root root 12582912 May  6 21:28 ibdata1</span><br><span class="line">drwx------ 2 root root     4096 May  6 21:28 mysql</span><br><span class="line">drwx------ 2 root root       20 May  6 21:28 performance_schema</span><br><span class="line">drwx------ 2 root root       20 May  6 21:28 <span class="built_in">test</span></span><br><span class="line">-rw-r----- 1 root root      527 May  6 21:28 xtrabackup_info</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># chown -R mysql.mysql /data/mysql/</span></span><br></pre></td></tr></table></figure>

<h3 id="启动服务测试"><a href="#启动服务测试" class="headerlink" title="启动服务测试"></a>启动服务测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># service mysqld start</span></span><br><span class="line">Starting mysqld (via systemctl):                           [  OK  ]</span><br><span class="line">[root@localhost ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;SHOW TABLES FROM hellodb;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">| toc               |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="完全备份-增量备份及还原"><a href="#完全备份-增量备份及还原" class="headerlink" title="完全备份+增量备份及还原"></a>完全备份+增量备份及还原</h2><p>在备份之前先创建出完全备份的目录以及增量备份的目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir -pv /dataa/backup/&#123;full,inc1,inc2&#125;</span></span><br><span class="line">mkdir: created directory ‘/data/backup’</span><br><span class="line">mkdir: created directory ‘/data/backup/full’</span><br><span class="line">mkdir: created directory ‘/data/backup/inc1’</span><br><span class="line">mkdir: created directory ‘/data/backup/inc2’</span><br></pre></td></tr></table></figure>

<p>数据库内所存放的数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -e &#x27;SHOW DATABASES;&#x27;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h3 id="对数据进行完全备份"><a href="#对数据进行完全备份" class="headerlink" title="对数据进行完全备份"></a>对数据进行完全备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mariabackup --backup --target-dir=/data/backup/full --user=root --password=&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="此时数据库内数据发生变化"><a href="#此时数据库内数据发生变化" class="headerlink" title="此时数据库内数据发生变化"></a>此时数据库内数据发生变化</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -e &quot;INSERT hellodb.teachers VALUE(5,&#x27;Li Xiaolong&#x27;,30,&#x27;M&#x27;);&quot;</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mysql -e &quot;SELECT * FROM hellodb.teachers WHERE tid&gt;4;&quot;</span></span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">| TID | Name        | Age | Gender |</span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">|   5 | Li Xiaolong |  30 | M      |</span><br><span class="line">+-----+-------------+-----+--------+</span><br></pre></td></tr></table></figure>

<h3 id="对数据库进行增量备份"><a href="#对数据库进行增量备份" class="headerlink" title="对数据库进行增量备份"></a>对数据库进行增量备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mariabackup --user=root --password=&#x27;&#x27; --backup --incremental-basedir=/data/backup/full --target-dir=/data/backup/inc1</span></span><br></pre></td></tr></table></figure>

<h3 id="数据库内数据再次发生变化"><a href="#数据库内数据再次发生变化" class="headerlink" title="数据库内数据再次发生变化"></a>数据库内数据再次发生变化</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -e &quot;INSERT hellodb.students(stuid,age,name) VALUE (26,35,&#x27;Sun Wukong&#x27;);&quot;</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mysql -e &quot;SELECT * FROM hellodb.students WHERE stuid&gt;25;&quot;</span></span><br><span class="line">+-------+------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name       | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+------------+-----+--------+---------+-----------+</span><br><span class="line">|    26 | Sun Wukong |  35 | F      |    NULL |      NULL |</span><br><span class="line">+-------+------------+-----+--------+---------+-----------+</span><br></pre></td></tr></table></figure>

<h3 id="再次对数据库做增量备份"><a href="#再次对数据库做增量备份" class="headerlink" title="再次对数据库做增量备份"></a>再次对数据库做增量备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mariabackup --user=root --password=&#x27;&#x27; --backup --incremental-basedir=/data/backup/inc1 --target-dir=/data/backup/inc2</span></span><br></pre></td></tr></table></figure>

<h3 id="破坏数据库"><a href="#破坏数据库" class="headerlink" title="破坏数据库"></a>破坏数据库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rm -rf /data/mysql/*</span></span><br></pre></td></tr></table></figure>

<h3 id="恢复数据库"><a href="#恢复数据库" class="headerlink" title="恢复数据库"></a>恢复数据库</h3><p>7.1先对数据库做清理，并停止数据库服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rm -rf /data/mysql/*</span></span><br><span class="line">[root@localhost ~]<span class="comment"># service mysqld stop</span></span><br><span class="line">Stopping mysqld (via systemctl):                           [  OK  ]</span><br></pre></td></tr></table></figure>

<p>7.2对完全备份做预整理</p>
<p>因为后续还有增量备份，所以此处需要使用apply-log-only选项来阻止事务的回滚。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mariabackup --prepare --apply-log-only --target-dir=/data/backup/full</span></span><br></pre></td></tr></table></figure>

<p>7.3合并第一次的增量备份</p>
<p>此为第一个增量备份后续还有第二个增量所以需要使用apply-log-only阻止回滚事务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost backup]<span class="comment"># mariabackup --prepare --apply-log-only --target-dir=/data/backup/full --incremental-dir=/data/backup/inc1</span></span><br></pre></td></tr></table></figure>

<p>7.3合并第二次的增量备份</p>
<p>此为最后个增量备份无需再使用apply-log-only阻止回滚事务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost backup]<span class="comment"># mariabackup --prepare --target-dir=/data/backup/full --incremental-dir=/data/backup/inc2</span></span><br></pre></td></tr></table></figure>

<p>7.4整理完毕将备份复制回数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost backup]<span class="comment"># mariabackup --copy-back --target-dir=/data/backup/full</span></span><br></pre></td></tr></table></figure>

<p>7.5将数据库内的属主和属组进行更改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost backup]<span class="comment"># chown -R mysql.mysql /data/mysql/</span></span><br></pre></td></tr></table></figure>

<h3 id="重启服务测试"><a href="#重启服务测试" class="headerlink" title="重启服务测试"></a>重启服务测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost backup]<span class="comment"># service mysqld start</span></span><br><span class="line">Starting mysqld (via systemctl):                           [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@localhost backup]<span class="comment"># msyql</span></span><br><span class="line">MariaDB [hellodb]&gt; select *from students <span class="built_in">where</span> stuid&gt;25;</span><br><span class="line">+-------+------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name       | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+------------+-----+--------+---------+-----------+</span><br><span class="line">|    26 | Sun Wukong |  35 | F      |    NULL |      NULL |</span><br><span class="line">+-------+------------+-----+--------+---------+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; select *from teachers <span class="built_in">where</span> tid&gt;4;</span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">| TID | Name        | Age | Gender |</span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">|   5 | Li Xiaolong |  30 | M      |</span><br><span class="line">+-----+-------------+-----+--------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="其他的注意事项"><a href="#其他的注意事项" class="headerlink" title="其他的注意事项"></a>其他的注意事项</h2><ol>
<li>在数据恢复之前必须先要停止MySQL服务</li>
<li>在还原时MySQL的数据库目录必须为空，否则不会覆盖</li>
<li>数据库内容还原后，其属主和属组为root需要手动将其全部改为mysql</li>
</ol>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL的存储引擎</title>
    <url>/2019/04/17/MySQL/MySQL%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/MySQL%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/</url>
    <content><![CDATA[<p>存储引擎决定了如何把数据库内的信息最终以某种方式转存在磁盘的数据库文件中，存储引擎用来管理磁盘上的各种不同文件。存储引擎在MySQL中是其特有的一种技术，在其他数据库中不提这个东西，Oracle、DB2、SQLserver这些商业级的数据库只有一种存储引擎，所以都不提存储引擎，而MySQL是个开源产品，所以很多的开发人员觉得某些存储引擎不好自己就开发一个，从而造成了MySQL的存储引擎特别的多。</p>
<span id="more"></span>

<p>MyISAM:MyISAM在5.5之前的版本中默认使用</p>
<p>MyISAM的存储引擎具有更好的性能</p>
<p>InnoDB:InnoDB在5.5之后的版本中默认使用</p>
<p>InnoDB的存储引擎具有很好的稳定性，支持事务和低级别的锁和外键</p>
<h3 id="默认存储引擎的查看方法"><a href="#默认存储引擎的查看方法" class="headerlink" title="默认存储引擎的查看方法"></a>默认存储引擎的查看方法</h3><p>存储引擎可以在MySQL中使用SHOW ENGINES;命令进行查看，所列出来的都是系统所支持的存储引擎，带有default的表示系统默认使用的存储引擎。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看所支持的所有存储引擎</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW ENGINES;</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                                          | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| MRG_MyISAM         | YES     | Collection of identical MyISAM tables                                            | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | Non-transactional engine with good performance and small data footprint          | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears)                   | NO           | NO   | NO         |</span><br><span class="line">| CSV                | YES     | Stores tables as CSV files                                                       | NO           | NO   | NO         |</span><br><span class="line">| Aria               | YES     | Crash-safe tables with MyISAM heritage                                           | NO           | NO   | NO         |</span><br><span class="line">| ARCHIVE            | YES     | gzip-compresses tables <span class="keyword">for</span> a low storage footprint                               | NO           | NO   | NO         |</span><br><span class="line">| MEMORY             | YES     | Hash based, stored <span class="keyword">in</span> memory, useful <span class="keyword">for</span> temporary tables                        | NO           | NO   | NO         |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                               | NO           | NO   | NO         |</span><br><span class="line">| InnoDB             | DEFAULT | Supports transactions, row-level locking, foreign keys and encryption <span class="keyword">for</span> tables | YES          | YES  | YES        |</span><br><span class="line">| SEQUENCE           | YES     | Generated tables filled with sequential values                                   | YES          | NO   | YES        |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">10 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="InnoDB和MyISAM的区别"><a href="#InnoDB和MyISAM的区别" class="headerlink" title="InnoDB和MyISAM的区别"></a>InnoDB和MyISAM的区别</h3><p>InnoDB和MyISAM主要有以下这些区别</p>
<table>
<thead>
<tr>
<th align="left">区别</th>
<th align="left">InnoDB</th>
<th align="left">MyISAM</th>
</tr>
</thead>
<tbody><tr>
<td align="left">聚集索引(Clustered indexex)</td>
<td align="left">支持</td>
<td align="left">不支持</td>
</tr>
<tr>
<td align="left">压缩数据(compressed data)</td>
<td align="left">支持</td>
<td align="left">支持，仅在压缩行的格式情况下支持</td>
</tr>
<tr>
<td align="left">数据的缓存(data caches)</td>
<td align="left">支持</td>
<td align="left">不支持</td>
</tr>
<tr>
<td align="left">外键</td>
<td align="left">支持</td>
<td align="left">不支持</td>
</tr>
<tr>
<td align="left">全文缩影</td>
<td align="left">支持需要5.6以后版本</td>
<td align="left">支持</td>
</tr>
<tr>
<td align="left">锁的并发性(locking granularity)</td>
<td align="left">行级锁</td>
<td align="left">表级锁</td>
</tr>
<tr>
<td align="left">多版本的并发控制(mvcc)</td>
<td align="left">支持</td>
<td align="left">不支持</td>
</tr>
<tr>
<td align="left">事务</td>
<td align="left">支持</td>
<td align="left">不支持(崩溃恢复性较差)</td>
</tr>
<tr>
<td align="left">存储大小</td>
<td align="left">64T</td>
<td align="left">256T</td>
</tr>
</tbody></table>
<h3 id="MyISAM和InnoDB的引擎文件"><a href="#MyISAM和InnoDB的引擎文件" class="headerlink" title="MyISAM和InnoDB的引擎文件"></a>MyISAM和InnoDB的引擎文件</h3><p>1.MyISAM引擎文件默认有3个，每个表有三个文件</p>
<table>
<thead>
<tr>
<th align="left">引擎文件</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">tbl_name.frm</td>
<td align="left">表格式定义</td>
</tr>
<tr>
<td align="left">tbl_name.MYD</td>
<td align="left">数据文件</td>
</tr>
<tr>
<td align="left">tbl_name.MYI</td>
<td align="left">索引文件</td>
</tr>
</tbody></table>
<p>2.InnoDB引擎文件在早期的版本中默认只有2个</p>
<table>
<thead>
<tr>
<th align="left">引擎文件</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">tbl_name.frm</td>
<td align="left">表格式定义</td>
</tr>
<tr>
<td align="left">../ibdata1</td>
<td align="left">所有的表的数据文件</td>
</tr>
</tbody></table>
<p>由于所有的表的数据内容都存放在数据库的ibdata1中非常不安全，所以innodb也有相关的参数可以让其进行每个表的数据分开存放。此参数的名字为innodb_file_per_table</p>
<p>查询innodb_file_per_table参数是否开启的方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysqladmin -uroot -p123456 variables | grep &#x27;innodb_file_per_table&#x27;</span></span><br><span class="line">| innodb_file_per_table                                  | ON           <span class="comment">#参数已经开启</span></span><br></pre></td></tr></table></figure>

<p>若为off则需要在MySQL的配置文件中加入此选项，然后重启服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">innodb_file_per_table</span><br></pre></td></tr></table></figure>

<p>3.修改默认的存储引擎<br>在早期的MySQL版本中默认的存储引擎为MyISAM若要使用InnoDB作为默认存储引擎，组需要对MySQL的配置文件进行修改，添加一个相关的参数，default_storage_engine=innodb，修改完毕后重启服务。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">default_storage_engine=innodb</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL的并发控制</title>
    <url>/2019/04/17/MySQL/MySQL%E7%9A%84%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/MySQL%E7%9A%84%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/</url>
    <content><![CDATA[<p>在数据库中经常设计到并发访问，此时就涉及到不同用户同时修改同一个资源的问题。此时就涉及到一个冲突的问题。为了防止这种冲突的发生，确保数据的安全，就需要对数据加锁的机制，MyISAM使用的是表级锁，InnoDB使用的是行级锁。锁又分为读锁和写锁，读锁也叫共享锁，只可读不可写，多个读互不阻塞，写锁又称为独占锁，写锁会阻碍其他事务的读和写。锁又有隐式锁和显式锁的分别，隐式锁是由存储引擎自动施加的，显式锁式用户自己手动添加的</p>
<p>手动添加锁的方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LOCK TABLES tbl_name lock_type;</span><br><span class="line"><span class="comment">#tbl_name：需要上锁的表名</span></span><br><span class="line"><span class="comment">#lock_type：锁的类型，可以为read,write也就是读锁和写锁</span></span><br></pre></td></tr></table></figure>

<p>解锁</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>

<p>第二种加锁方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FLUSH TABLES [tbl_name[,...]][WITH READ LOCK]</span><br><span class="line"><span class="comment">#tbl_name如果不添加则对整个数据库加锁，通常在备份前加全局读锁</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL的性能优化</title>
    <url>/2019/04/10/MySQL/MySQL%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/MySQL%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<p>MySQL的性能优化可以从两方面着手，一是从缓存，二是从索引。</p>
<h2 id="MySQL的查询缓存"><a href="#MySQL的查询缓存" class="headerlink" title="MySQL的查询缓存"></a>MySQL的查询缓存</h2><p>查询缓存是基于hash算法的，要求命令和查询的参数大小写必须完全一致，当有新的查询语句或预处理查询请求，先去查询缓存，判断是否存在纪录集，若存在则直接返回结果。</p>
<h3 id="查询缓存的优缺点"><a href="#查询缓存的优缺点" class="headerlink" title="查询缓存的优缺点"></a>查询缓存的优缺点</h3><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><p>sql语句不需要做任何解析和执行，直接从缓存中获得查询结合，提高了查询性能</p>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>不够智能，提高了缓存使用门槛，增加了缓存记录集检查和清理的开销。</p>
<p>有些查询是无法被缓存的比如：</p>
<ol>
<li>查询的语句中带了SQL_NO_CACHE参数</li>
<li>查询语句中含有获取值的函数。如：NOW(),CURDATE(),GET_LOCK(),RAND()、CONVERT_TZ()等</li>
<li>对系统数据库查询时使用会话级别的变量或存储过程中的局部变量。</li>
<li>查询语句中加了锁不会使用缓存</li>
<li>对临时表的查询，存在警告信息的查询，只有列级别权限的查询。</li>
<li>事务隔离级别为serializable的不能缓存</li>
</ol>
<h3 id="缓存的相关变量"><a href="#缓存的相关变量" class="headerlink" title="缓存的相关变量"></a>缓存的相关变量</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">query_cache_limit               <span class="comment">#单个查询结果能缓存的最大值，默认为1M。过大的值将无法缓存</span></span><br><span class="line">query_cache_min_res_unit        <span class="comment">#在内存中给缓存分配的最小单位，默认为4K，较小值会减少浪费，但会产生频繁的内存分配，如果设置较大，则会造成浪费。</span></span><br><span class="line">query_cache_size                <span class="comment">#总的用来放查询缓存的内存空间，最小为40K，必须为1024的整数倍。要长期有效需要写入配置文件。</span></span><br><span class="line">query_cache_strip_comments      <span class="comment">#控制QC中是否去掉SQL语句的注释部分</span></span><br><span class="line">query_cache_type                <span class="comment">#是否启用缓存默认为开启</span></span><br><span class="line">query_cache_wlock_invalidate    <span class="comment">#如果表被其他的会话锁定，是否仍然可以从查询缓存中返回结果，默认为off,表示可以在表被其他会话锁定的场景中继续从缓存返回数据；ON则表示不允许</span></span><br></pre></td></tr></table></figure>

<h3 id="查询缓存相关的状态变量"><a href="#查询缓存相关的状态变量" class="headerlink" title="查询缓存相关的状态变量"></a>查询缓存相关的状态变量</h3><p>缓存的状态变量可以使用SHOW GLOBAL STATUS LIKE ‘Qcache%’;进行查询</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Qcache_free_blocks              <span class="comment">#处于空闲状态缓存中内存块数</span></span><br><span class="line">Qcache_total_blocks             <span class="comment">#缓存中总块，当Qcache_free_blocks相对此值较大时，可能用内存碎片，执行FLUSH QUERY CACHE清理碎片</span></span><br><span class="line">Qcache_free_memory              <span class="comment">#处于空闲状态的缓存内存总量</span></span><br><span class="line">Qcache_hits                     <span class="comment">#Query Cache命中次数</span></span><br><span class="line">Qcache_inserts                  <span class="comment">#向 Query Cache 中插入新的缓存的次数，即没有命中的次数</span></span><br><span class="line">Qcache_lowmem_prunes            <span class="comment">#记录因为内存不足而被移除出查询缓存的查询数</span></span><br><span class="line">Qcache_not_cached               <span class="comment">#没有被缓存的记录数，包括无法被缓存的记录以及由于query_cache_type设置的不会被缓存的SQL语句</span></span><br><span class="line">Qcache_queries_in_cache         <span class="comment">#在缓存中的SQL数量</span></span><br></pre></td></tr></table></figure>

<h3 id="缓存的优化方法"><a href="#缓存的优化方法" class="headerlink" title="缓存的优化方法"></a>缓存的优化方法</h3><p>缓存的优化方法可以根据缓存优化表来进行查询和修改</p>
<p><img src="%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%E8%A1%A8.png" alt="缓存优化表.png"></p>
<h2 id="MySQL的索引"><a href="#MySQL的索引" class="headerlink" title="MySQL的索引"></a>MySQL的索引</h2><p>索引是特殊的数据结构，定义在查找时作为查找条件的字段，在MySQL又称为建可以，索引通过存储引擎实现。</p>
<h3 id="索引的类型"><a href="#索引的类型" class="headerlink" title="索引的类型"></a>索引的类型</h3><h4 id="B-tree索引"><a href="#B-tree索引" class="headerlink" title="B+tree索引"></a>B+tree索引</h4><p>B+tree的所有非叶子节点上只有索引没有有数据，真正的数据都存放在叶子节点上，叶子节点上不仅有索引还有数据。相邻叶子节点的数据块之间有指向性，所以在查找范围时也能使用索引</p>
<h4 id="复合索引"><a href="#复合索引" class="headerlink" title="复合索引"></a>复合索引</h4><p>复合索引就是把多个字段组合设置为索引，当第一个字段相同时，比对第二个字段。复合索引可以将排在前面的字段作为搜索条件， 但不能将排在后面的字段作为搜索条件。若跳过前一个搜索条件直接搜索第二个字段将导致索引失效。</p>
<h4 id="聚簇索引和非聚簇索引"><a href="#聚簇索引和非聚簇索引" class="headerlink" title="聚簇索引和非聚簇索引"></a>聚簇索引和非聚簇索引</h4><p>聚簇索引：索引和数据是捆在一起的，所以一张表中只能有一个主键。如果对非主键的字段设立的索引，那么其索引的叶子节点的信息为索引和主键索引的对应关系，通过主键索引的信息找到相对应的数据。（InnoDB就是聚簇分布）</p>
<p>非聚簇索引：索引和数据是分开的（MyISAM为非聚簇表分布）</p>
<h3 id="索引的创建、删除和查看"><a href="#索引的创建、删除和查看" class="headerlink" title="索引的创建、删除和查看"></a>索引的创建、删除和查看</h3><p>创建索引：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CREATE [ONLINE|OFFLINE] [UNIQUE|FULLTEXT|SPATIAL] INDEX index_name</span><br><span class="line">    [index_type]</span><br><span class="line">    ON tbl_name (index_col_name,...)</span><br><span class="line">    [index_option] ...</span><br><span class="line"></span><br><span class="line">index_col_name:</span><br><span class="line">    col_name [(length)] [ASC | DESC]</span><br><span class="line"></span><br><span class="line">index_type:</span><br><span class="line">    USING &#123;BTREE | HASH&#125;</span><br><span class="line"></span><br><span class="line">index_option:</span><br><span class="line">    KEY_BLOCK_SIZE [=] value</span><br><span class="line">  | index_type</span><br><span class="line">  | WITH PARSER parser_name</span><br><span class="line">  | COMMENT <span class="string">&#x27;string&#x27;</span></span><br></pre></td></tr></table></figure>

<p>删除索引：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DROP INDEX index_name ON tbl_name;</span><br></pre></td></tr></table></figure>

<p>查看索引：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SHOW INDEXES FORM tlb_name;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL系统数据库</title>
    <url>/2019/04/17/MySQL/MySQL%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    <content><![CDATA[<p>MySQL数据库在刚安装完毕后，默认带有mysql、performance_schema、information_schema这三个系统自身带有的数据库。</p>
<span id="more"></span>
<p>mysql数据库是mysql的核心数据库，类似于Sql Server中的master库，主要负责存储数据库的用户、权限设置、关键字等mysql自己需要使用的控制和管理信息</p>
<p>performance_schema数据库是MySQL 5.5开始新增的数据库，主要用于收集数据库服务器性能参数，库里表的存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为PERFORMANCE_SCHEMA的表</p>
<p>information_schema数据库是MySQL 5.0之后产生的一个虚拟数据库，物理上并不存在information_schema数据库类似与“数据字典”，提供了访问数据库元数据的方式，即数据的数据。比如数据库名或表名，列类型，访问权限（更加细化的访问方式）</p>
<p>所有以后在备份数据库时，我们只需要备份用户的数据库，以及mysql数据库。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL级联复制</title>
    <url>/2019/04/10/MySQL/MySQL%E7%BA%A7%E8%81%94%E5%A4%8D%E5%88%B6/MySQL%E7%BA%A7%E8%81%94%E5%A4%8D%E5%88%B6/</url>
    <content><![CDATA[<p>在生产换进中有一种主从复制的方法主节点先将数据同步到一个中间的从节点，然后由从节点给后续的其他从节点来复制数据，这种复制方式称为级联复制。</p>
<span id="more"></span>

<p><img src="%E7%BA%A7%E8%81%94%E5%A4%8D%E5%88%B6.png" alt="级联复制.png"></p>
<p>级联复制的好处是可以极大的减轻主节点的压力  </p>
<p>级联复制在配置时需要在中间节点上启用log_slave_updates的选项。</p>
<h2 id="级联复制的配置方法"><a href="#级联复制的配置方法" class="headerlink" title="级联复制的配置方法"></a>级联复制的配置方法</h2><p>准备主机4台，1台主节点(Master)，1台中间从节点(Slave)，1台从节点(Slave1)</p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">系统</th>
<th align="left">ip</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Master</td>
<td align="left">CentOS7</td>
<td align="left">192.168.73.110</td>
</tr>
<tr>
<td align="left">Slave</td>
<td align="left">CentOS7</td>
<td align="left">192.168.73.111</td>
</tr>
<tr>
<td align="left">Slave1</td>
<td align="left">CentOS7</td>
<td align="left">192.168.73.112</td>
</tr>
</tbody></table>
<h3 id="主节点配置-Master"><a href="#主节点配置-Master" class="headerlink" title="主节点配置(Master)"></a>主节点配置(Master)</h3><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log-bin=/data/bin/mysql-bin         <span class="comment">#启动二进制日志</span></span><br><span class="line">binlog-format=row                   <span class="comment">#修改日志格式</span></span><br><span class="line">server-id=1</span><br></pre></td></tr></table></figure>

<p>2.创建二级制日志目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mkdir /data/bin</span></span><br><span class="line">[root@Master ~]<span class="comment"># chown -R mysql.mysql /data/bin</span></span><br></pre></td></tr></table></figure>

<p>3.启动服务，查看当前二进制日志所在的位置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># systemctl start mariadb</span></span><br><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;SHOW MASTER LOGS;&quot;</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |     26753 |</span><br><span class="line">| mysql-bin.000002 |    921736 |</span><br><span class="line">| mysql-bin.000003 |       245 |      <span class="comment">#记录当前二进制的位置</span></span><br><span class="line">+------------------+-----------+</span><br></pre></td></tr></table></figure>

<p>4.创建一个用来复制数据的账户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;GRANT REPLICATION SLAVE ON *.* TO &#x27;repluser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;centos&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="中间从节点配置"><a href="#中间从节点配置" class="headerlink" title="中间从节点配置"></a>中间从节点配置</h3><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin=/data/bin/mysql-bin</span><br><span class="line">binlog-format=row</span><br><span class="line">read-only</span><br><span class="line">log_slave_updates</span><br><span class="line">server-id=2</span><br></pre></td></tr></table></figure>

<p>2.创建二进制日志目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># mkdir /data/bin</span></span><br><span class="line">[root@Slave ~]<span class="comment"># chown -R mysql.mysql /data/bin</span></span><br></pre></td></tr></table></figure>

<p>3.启动MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<p>4.写入CHANGE MASTER TO信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=<span class="string">&#x27;192.168.73.110&#x27;</span>,</span><br><span class="line">  MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,</span><br><span class="line">  MASTER_PASSWORD=<span class="string">&#x27;centos&#x27;</span>,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000003&#x27;</span>,</span><br><span class="line">  MASTER_LOG_POS=245;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>5.查看下从节点的配置状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: No           <span class="comment">#线程尚未开启</span></span><br><span class="line">            Slave_SQL_Running: No           <span class="comment">#线程尚未开启</span></span><br></pre></td></tr></table></figure>

<p>6.启动线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>7.再次查看从节点状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 402          <span class="comment">#已经有小部分数据被复制过来</span></span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 686</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes          <span class="comment">#线程已经启动</span></span><br><span class="line">            Slave_SQL_Running: Yes          <span class="comment">#线程已经启动</span></span><br></pre></td></tr></table></figure>

<p>8.测试</p>
<p>8.1在主节点导入数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql &lt; hellodb_innodb.sql</span></span><br><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>8.2从节点查看是否已经同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h3 id="配置Slave1"><a href="#配置Slave1" class="headerlink" title="配置Slave1"></a>配置Slave1</h3><p>由于此时各节点上已经有数据，作为后来追加的从服务器，首先需要将之前的所有数据使用备份恢复一次然后再进行主从复制进行同步</p>
<p>1.在中间节点上将数据库备份出来，并将数据传送到后续的Slave1主机上</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># mysqldump -A --single-transaction -F --master-data=1 &gt; /data/all.sql</span></span><br><span class="line">[root@Slave ~]<span class="comment"># scp /data/all.sql 192.168.73.112:/data</span></span><br></pre></td></tr></table></figure>

<p>2.在Slave1主机上修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">read-only</span><br><span class="line">server-id=3</span><br></pre></td></tr></table></figure>

<p>3.启动MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<p>4.对备份文件做修改</p>
<p>找到CHANGE MASTER TO行对信息加以修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># vim /data/all.sql</span></span><br><span class="line">CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.73.111&#x27;</span>,MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,MASTER_PASSWORD=<span class="string">&#x27;centos&#x27;</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000004&#x27;</span>, MASTER_LOG_POS=245;</span><br></pre></td></tr></table></figure>

<p>5.将修改后的备份文件导入数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># mysql &lt; /data/all.sql</span></span><br></pre></td></tr></table></figure>

<p>6.查看下slave status</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># mysql -e &quot;SHOW SLAVE STATUS\G;&quot;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.73.111</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000004</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000004</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br></pre></td></tr></table></figure>

<p>7.启动线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># mysql -e &quot;START SLAVE;&quot;</span></span><br></pre></td></tr></table></figure>

<p>8.再次查看slave status</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># mysql -e &quot;show slave status\G;&quot;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.111</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000004</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 529</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000004</span><br><span class="line">             Slave_IO_Running: Yes              <span class="comment">#线程已经全部启动</span></span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>在主节点上删除hellodb库中的teachers表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;SHOW TABLES FROM hellodb;&quot;       #先查看下库是否有teachers表</span></span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">| toc               |</span><br><span class="line">+-------------------+</span><br><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;DROP TABLE hellodb.teachers;&quot;    #删表</span></span><br><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;SHOW TABLES FROM hellodb;&quot;       #再次确认表是否删除</span></span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| toc               |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure>

<p>在slave1节点上查看是否同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># mysql -e &quot;SHOW TABLES FROM hellodb;&quot;   #查看从节点是否还存在teachers表</span></span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| toc               |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure>

<p>级联复制配置成功</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL编译安装和安装MySQL多实例</title>
    <url>/2019/04/17/MySQL/MySQL%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E5%8F%8A%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%AE%9E%E7%8E%B0/MySQL%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E5%8F%8A%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="编译安装MySQL"><a href="#编译安装MySQL" class="headerlink" title="编译安装MySQL"></a>编译安装MySQL</h2><p>安装编译所需要的包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install bison bison-devel zlib-devel libcurl-devel libarchive-devel boostdevel gcc gcc-c++ cmake ncurses-devel gnutls-devel libxml2-devel openssldevel libevent-devel libaio-devel -y</span><br></pre></td></tr></table></figure>

<p>添加MySQL用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># useradd -r -s /sbin/nologin -d /data/mysql mysql</span></span><br></pre></td></tr></table></figure>

<p>为MySQL用户添加家目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir /data/mysql</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chmod 700 /data/mysql</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chown mysql.mysql /data/mysql</span></span><br></pre></td></tr></table></figure>

<p>下载mariadb源码包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># wget http://ftp.hosteurope.de/mirror/archive.mariadb.org//mariadb-10.2.23/source/mariadb-10.2.23.tar.gz</span></span><br></pre></td></tr></table></figure>

<p>解压MySQL源码包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># tar -xf mariadb-10.2.23.tar.gz</span></span><br></pre></td></tr></table></figure>

<p>编译安装MySQL，此处需要注意如果编译时中间如果出现缺包的错误，需要将此目录下的CMakeCache.txt删除后重新进行编译。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cd mariadb-10.2.23</span></span><br><span class="line">[root@localhost mariadb-10.2.23]<span class="comment"># cmake . \</span></span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/apps/mysql \</span><br><span class="line">-DMYSQL_DATADIR=/data/mysql/ \</span><br><span class="line">-DSYSCONFDIR=/etc/mysql \</span><br><span class="line">-DMYSQL_USER=mysql \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITHOUT_MROONGA_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_DEBUG=0 \</span><br><span class="line">-DWITH_READLINE=1 \</span><br><span class="line">-DWITH_SSL=system \</span><br><span class="line">-DWITH_ZLIB=system \</span><br><span class="line">-DWITH_LIBWRAP=0 \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/data/mysql/mysql.sock \</span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci</span><br><span class="line"></span><br><span class="line">[root@localhost mariadb-10.2.23]<span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>

<p>初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mariadb-10.2.23]<span class="comment"># cd /apps/mysql/</span></span><br><span class="line">[root@localhost mysql]<span class="comment"># scripts/mysql_install_db --user=mysql --datadir=/data/mysql</span></span><br><span class="line">Installing MariaDB/MySQL system tables <span class="keyword">in</span> <span class="string">&#x27;/data/mysql&#x27;</span> ...</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>放置配置文件并修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># mkdir /etc/mysql        #创建MySQL配置文件目录</span></span><br><span class="line">[root@localhost mysql]<span class="comment"># cp support-files/my-huge.cnf /etc/mysql/my.cnf</span></span><br><span class="line">[root@localhost mysql]<span class="comment"># sed -i &#x27;/\[mysqld\]/adatadir=/data/mysql&#x27; /etc/mysql/my.cnf</span></span><br></pre></td></tr></table></figure>

<p>配置服务启动脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># cp support-files/mysql.service /etc/init.d/mysqld</span></span><br><span class="line">[root@localhost mysql]<span class="comment"># chmod +x /etc/init.d/mysqld</span></span><br><span class="line"></span><br><span class="line">[root@localhost mysql]<span class="comment"># chkconfig --add mysqld</span></span><br></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># service mysqld start</span></span><br><span class="line">Starting mysqld (via systemctl):                           [  OK  ]</span><br></pre></td></tr></table></figure>

<p>为MySQL添加环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># echo &#x27;PATH=/app/mysql/bin:$PATH&#x27; &gt; /etc/profile.d/mysql.sh</span></span><br><span class="line">[root@localhost mysql]<span class="comment"># . /etc/profile.d/mysql.sh</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="MySQL的多实例环境搭建"><a href="#MySQL的多实例环境搭建" class="headerlink" title="MySQL的多实例环境搭建"></a>MySQL的多实例环境搭建</h2><p>在测试环境中通常会需要在一台主机上搭建多个版本的MySQL，此处以编译安装完毕的MySQL为例，演示如何搭建多实例的MySQL。</p>
<p>为每个实例创建各自的目录并赋予权限（此处以创建2个实例为例）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># mkdir -pv /mysql/&#123;3306,3307&#125;/&#123;data,etc,socket,bin,log,pid&#125;</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chown -R mysql.mysql /mysql</span></span><br><span class="line">[root@localhost ~]<span class="comment"># tree /mysql                 #查看下目录结构</span></span><br><span class="line">/mysql</span><br><span class="line">├── 3306</span><br><span class="line">│   ├── bin</span><br><span class="line">│   ├── data</span><br><span class="line">│   ├── etc</span><br><span class="line">│   ├── <span class="built_in">log</span></span><br><span class="line">│   ├── pid</span><br><span class="line">│   └── socket</span><br><span class="line">└── 3307</span><br><span class="line">    ├── bin</span><br><span class="line">    ├── data</span><br><span class="line">    ├── etc</span><br><span class="line">    ├── <span class="built_in">log</span></span><br><span class="line">    ├── pid</span><br><span class="line">    └── socket</span><br></pre></td></tr></table></figure>

<p>为每个实例初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#为3306数据库初始化数据库</span></span><br><span class="line">[root@localhost /]<span class="comment"># /app/mysql/scripts/mysql_install_db --user=mysql --datadir=/mysql/3306/data</span></span><br><span class="line"><span class="comment">#为3307数据初始化数据库</span></span><br><span class="line">[root@localhost /]<span class="comment"># /app/mysql/scripts/mysql_install_db --user=mysql --datadir=/mysql/3307/data</span></span><br></pre></td></tr></table></figure>

<p>为每个实例创建配置文件，配置文件可以参考/etc/my.cnf进行修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># cp /etc/my.cnf /mysql/3306/etc/my.cnf       #复制/etc/my.cnf到多实例的etc目录下</span></span><br><span class="line">[root@localhost /]<span class="comment"># vim /mysql/3306/etc/my.cnf                  #修改my.cnf，写入配置</span></span><br><span class="line">[mysqld]                                                        <span class="comment">#注意需要将#!includedir /etc/my.cnf.d注释</span></span><br><span class="line">port=3306                           <span class="comment">#此处实例1的端口为3306</span></span><br><span class="line">datadir=/mysql/3306/data</span><br><span class="line">socket=/mysql/3306/socket/mysql.sock</span><br><span class="line">symbolic-links=0</span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/mysql/3306/<span class="built_in">log</span>/mariadb.log</span><br><span class="line">pid-file=/mysql/3306/pid/mariadb.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#将3306上配置完成的配置文件复制到3307上并做修改</span></span><br><span class="line">[root@localhost /]<span class="comment"># cp /mysql/3306/etc/my.cnf /mysql/3307/etc/</span></span><br><span class="line">[root@localhost /]<span class="comment"># sed -i &#x27;s/3306/3307/&#x27; /mysql/3307/etc/my.cnf    #将实例2配置文件中所有3306部分改为3307</span></span><br></pre></td></tr></table></figure>

<p>为实例添加服务脚本，此为事先准备好的服务脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">port=3306</span><br><span class="line">mysql_user=<span class="string">&quot;root&quot;</span></span><br><span class="line">mysql_pwd=<span class="string">&quot;&quot;</span></span><br><span class="line">cmd_path=<span class="string">&quot;/usr/bin&quot;</span></span><br><span class="line">mysql_basedir=<span class="string">&quot;/mysql&quot;</span></span><br><span class="line">mysql_sock=<span class="string">&quot;<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">function_start_mysql</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="string">&quot;<span class="variable">$mysql_sock</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">printf</span> <span class="string">&quot;Starting MySQL...\n&quot;</span></span><br><span class="line">      <span class="variable">$&#123;cmd_path&#125;</span>/mysqld_safe --defaults-file=<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/etc/my.cnf  &amp;&gt; /dev/null  &amp;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">printf</span> <span class="string">&quot;MySQL is running...\n&quot;</span></span><br><span class="line">      <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">function_stop_mysql</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="string">&quot;<span class="variable">$mysql_sock</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">       <span class="built_in">printf</span> <span class="string">&quot;MySQL is stopped...\n&quot;</span></span><br><span class="line">       <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       <span class="built_in">printf</span> <span class="string">&quot;Stoping MySQL...\n&quot;</span></span><br><span class="line">       <span class="variable">$&#123;cmd_path&#125;</span>/mysqladmin -u <span class="variable">$&#123;mysql_user&#125;</span> -p<span class="variable">$&#123;mysql_pwd&#125;</span> -S <span class="variable">$&#123;mysql_sock&#125;</span> shutdown</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">function_restart_mysql</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;Restarting MySQL...\n&quot;</span></span><br><span class="line">    function_stop_mysql</span><br><span class="line">    sleep 2</span><br><span class="line">    function_start_mysql</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    function_start_mysql</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">    function_stop_mysql</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">    function_restart_mysql</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;Usage: <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/bin/mysqld &#123;start|stop|restart&#125;\n&quot;</span></span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<p>将服务启动脚本存放至各实例的bin目录下，并加以修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># vim /mysql/3306/bin/mysqld      #对端口和cmd_path进行修改</span></span><br><span class="line">port=3306</span><br><span class="line">cmd_path=<span class="string">&quot;/app/mysql/bin&quot;</span></span><br><span class="line"></span><br><span class="line">[root@localhost /]<span class="comment"># vim /mysql/3307/bin/mysqld      #对端口和cmd_path进行修改</span></span><br><span class="line">port=3307</span><br><span class="line">cmd_path=<span class="string">&quot;/app/mysql/bin&quot;</span></span><br><span class="line"></span><br><span class="line">[root@localhost /]<span class="comment"># chmod +x /mysql/3306/bin/mysqld #为服务脚本添加执行权限</span></span><br><span class="line">[root@localhost /]<span class="comment"># chmod +x /mysql/3307/bin/mysqld</span></span><br></pre></td></tr></table></figure>

<p>关闭编译安装的MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># ss -tnl |grep 3306</span></span><br><span class="line">LISTEN     0      80          :::3306                    :::*</span><br><span class="line">[root@localhost /]<span class="comment"># service mysqld stop</span></span><br><span class="line">Stopping mysqld (via systemctl):                           [  OK  ]</span><br></pre></td></tr></table></figure>

<p>启动实例1，2</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># /mysql/3306/bin/mysqld start</span></span><br><span class="line">Starting MySQL...</span><br><span class="line">[root@localhost /]<span class="comment"># /mysql/3307/bin/mysqld start</span></span><br><span class="line">Starting MySQL...</span><br><span class="line"></span><br><span class="line">[root@localhost /]<span class="comment"># ss -tnl | grep 3306</span></span><br><span class="line">LISTEN     0      80          :::3306                    :::*</span><br><span class="line">[root@localhost /]<span class="comment"># ss -tnl | grep 3307</span></span><br><span class="line">LISTEN     0      80          :::3307                    :::*</span><br></pre></td></tr></table></figure>

<p>连接数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#客户端在连接多实例的MySQL时，需要指定端口号和socket文件路径否则报错。</span></span><br><span class="line">[root@localhost /]<span class="comment"># mysql -uroot -p -P3306 -S /mysql/3306/socket/mysql.sock</span></span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 8</span><br><span class="line">Server version: 10.2.23-MariaDB Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line"><span class="comment">#已经连接上实例1</span></span><br></pre></td></tr></table></figure>

<p>关闭多实例MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#多实例的MySQL服务在关闭时需要输入MySQL管理员的密码，也可以将管理员密码存放在配置文件的变量mysql_pwd=&quot;&quot;中</span></span><br><span class="line">[root@localhost /]<span class="comment"># /mysql/3306/bin/mysqld stop</span></span><br><span class="line">Stoping MySQL...</span><br><span class="line">Enter password:</span><br></pre></td></tr></table></figure>

<p>以上为mariadb多实例的配置方法。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL读写分离(ProxySQL)</title>
    <url>/2019/04/12/MySQL/MySQL%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB(ProxySQL)/MySQL%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BBProxySQL/</url>
    <content><![CDATA[<p>读写分离就是用户在发送请求时，请求经过中间件，中间件将请求中的读和写操作分辨出来将读请求发送给后端的从服务器，将写请求发送给后端的主服务器，再又主服务器通过主从复制将数据复制给其他从服务器</p>
<p><img src="%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.png" alt="读写分离.png"></p>
<h2 id="常见MySQL中间件"><a href="#常见MySQL中间件" class="headerlink" title="常见MySQL中间件"></a>常见MySQL中间件</h2><table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">公司</th>
<th align="left">站点地址</th>
</tr>
</thead>
<tbody><tr>
<td align="left">mysql-proxy</td>
<td align="left">Oracle</td>
<td align="left"><a href="https://downloads.mysql.com/archives/proxy">https://downloads.mysql.com/archives/proxy</a></td>
</tr>
<tr>
<td align="left">Atlas</td>
<td align="left">Qihoo</td>
<td align="left"><a href="https://github.com/Qihoo360/Atlas/blob/master/README_ZH.md">https://github.com/Qihoo360/Atlas/blob/master/README_ZH.md</a></td>
</tr>
<tr>
<td align="left">dbproxy</td>
<td align="left">美团</td>
<td align="left"><a href="https://github.com/Meituan-Dianping/DBProxy">https://github.com/Meituan-Dianping/DBProxy</a></td>
</tr>
<tr>
<td align="left">Cetus</td>
<td align="left">网易乐得</td>
<td align="left"><a href="https://github.com/Lede-Inc/cetus">https://github.com/Lede-Inc/cetus</a></td>
</tr>
<tr>
<td align="left">Amoeba</td>
<td align="left"></td>
<td align="left"><a href="https://sourceforge.net/projects/amoeba/">https://sourceforge.net/projects/amoeba/</a></td>
</tr>
<tr>
<td align="left">Cobar</td>
<td align="left">阿里巴巴</td>
<td align="left">Amoeba的升级版</td>
</tr>
<tr>
<td align="left">Mycat</td>
<td align="left">基于Cobar</td>
<td align="left"><a href="http://www.mycat.io/">http://www.mycat.io</a></td>
</tr>
<tr>
<td align="left">ProxySQL</td>
<td align="left"></td>
<td align="left"><a href="https://proxysql.com/">https://proxysql.com/</a></td>
</tr>
</tbody></table>
<p>本文以ProxySQL为例来介绍读写分离的使用方法</p>
<h2 id="ProxySQL简介"><a href="#ProxySQL简介" class="headerlink" title="ProxySQL简介"></a>ProxySQL简介</h2><p>ProxySQL为MySQL的中间件，其有两个版本官方版和percona版，percona版是基于官方版基础上修改而来。ProxySQL是由C++语言开发，轻量级但性能优异（支持处理千亿级数据），其具有中间件所需要的绝大多数功能，如：</p>
<ol>
<li>多种方式的读写分离</li>
<li>定制基于用户、基于schema、基于语言的规则对SQL语句进行路由</li>
<li>缓存查询结果</li>
<li>后端节点的控制</li>
</ol>
<p>官方站点：<a href="https://proxysql.com/">https://proxysql.com/</a><br>官方手册：<a href="https://github.com/sysown/proxysql/wiki">https://github.com/sysown/proxysql/wiki</a></p>
<h3 id="ProxySQL安装后生成的文件"><a href="#ProxySQL安装后生成的文件" class="headerlink" title="ProxySQL安装后生成的文件"></a>ProxySQL安装后生成的文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/etc/init.d/proxysql            <span class="comment">#此为服务脚本存放在init.d目录下所以需要使用service命令去启动他</span></span><br><span class="line">/etc/proxysql.cnf</span><br><span class="line">/usr/bin/proxysql</span><br><span class="line">/usr/share/proxysql/tools/proxysql_galera_checker.sh</span><br><span class="line">/usr/share/proxysql/tools/proxysql_galera_writer.pl</span><br></pre></td></tr></table></figure>

<h3 id="ProxySQL所使用的端口"><a href="#ProxySQL所使用的端口" class="headerlink" title="ProxySQL所使用的端口"></a>ProxySQL所使用的端口</h3><p>ProxySQL所使用的端口为6032和6033<br>6032:用来配置ProxySQL，是个管理接口<br>6033:用来被远程用户连接端口</p>
<h3 id="ProxySQL内置数据库"><a href="#ProxySQL内置数据库" class="headerlink" title="ProxySQL内置数据库"></a>ProxySQL内置数据库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | /var/lib/proxysql/proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>以上这些库中主要配置的库为main库，里面存放了ProxySQL的各种配置。</p>
<h3 id="ProxySQL-main库内的表"><a href="#ProxySQL-main库内的表" class="headerlink" title="ProxySQL main库内的表"></a>ProxySQL main库内的表</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; show tables;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| tables                                     |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| global_variables                           |</span><br><span class="line">| mysql_collations                           |</span><br><span class="line">| mysql_group_replication_hostgroups         |</span><br><span class="line">| mysql_query_rules                          |</span><br><span class="line">| mysql_query_rules_fast_routing             |</span><br><span class="line">| mysql_replication_hostgroups               |</span><br><span class="line">| mysql_servers                              |</span><br><span class="line">| mysql_users                                |</span><br><span class="line">| proxysql_servers                           |</span><br><span class="line">| runtime_checksums_values                   |</span><br><span class="line">| runtime_global_variables                   |</span><br><span class="line">| runtime_mysql_group_replication_hostgroups |</span><br><span class="line">| runtime_mysql_query_rules                  |</span><br><span class="line">| runtime_mysql_query_rules_fast_routing     |</span><br><span class="line">| runtime_mysql_replication_hostgroups       |</span><br><span class="line">| runtime_mysql_servers                      |</span><br><span class="line">| runtime_mysql_users                        |</span><br><span class="line">| runtime_proxysql_servers                   |</span><br><span class="line">| runtime_scheduler                          |</span><br><span class="line">| scheduler                                  |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">20 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>main库中的表分为runtime开头和非runtime开头  </p>
<p>runtime开头为运行时的设置  </p>
<p>非runtime开头为需要设置的配置  </p>
<p>所有的配置修改后需要执行命令才能加载到runtime生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LOAD ... TO RUNTIME</span><br></pre></td></tr></table></figure>

<p>所有的配置修改后需要执行命令才能永久保存</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SAVE ... TO DISK</span><br></pre></td></tr></table></figure>

<h3 id="日志查看"><a href="#日志查看" class="headerlink" title="日志查看"></a>日志查看</h3><p>查看read_only和replication_log的监控日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; select * from mysql_server_read_only_log;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; select * from mysql_server_replication_lag_log;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ProxySQL实现读写分离"><a href="#ProxySQL实现读写分离" class="headerlink" title="ProxySQL实现读写分离"></a>ProxySQL实现读写分离</h2><p>ProxySQL在实现读写分离之前先要实现主从复制的共功能  </p>
<p>本实验总计使用4台主机，详细配置如下  </p>
<table>
<thead>
<tr>
<th align="left">主机</th>
<th align="left">ip地址</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Client</td>
<td align="left">192.168.73.113</td>
</tr>
<tr>
<td align="left">ProxySQL</td>
<td align="left">192.168.73.112</td>
</tr>
<tr>
<td align="left">Master</td>
<td align="left">192.168.73.110</td>
</tr>
<tr>
<td align="left">Slave</td>
<td align="left">192.168.73.111</td>
</tr>
</tbody></table>
<p>注意事项：在实现主从复制时从节点在配置文件中必须要设置read_only，这是ProxySQL区分是用来作为读服务器还是写服务器的依据</p>
<hr>
<h3 id="一、实现主从复制"><a href="#一、实现主从复制" class="headerlink" title="一、实现主从复制"></a>一、实现主从复制</h3><h4 id="主节点配置"><a href="#主节点配置" class="headerlink" title="主节点配置"></a>主节点配置</h4><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin</span><br><span class="line">binlog-format=row</span><br></pre></td></tr></table></figure>

<p>2.启动MySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># systemctl start mariadb</span></span><br><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;SHOW MASTER LOGS;&quot;</span></span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| Log_name           | File_size |</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| mariadb-bin.000001 |       245 |</span><br><span class="line">+--------------------+-----------+</span><br></pre></td></tr></table></figure>

<p>3.创建用来复制的账号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;GRANT REPLICATION SLAVE ON *.* TO &#x27;repluser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;centos&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="从节点配置"><a href="#从节点配置" class="headerlink" title="从节点配置"></a>从节点配置</h4><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">log-bin</span><br><span class="line">binlog-format=row</span><br><span class="line">read-only               <span class="comment">#必须写</span></span><br></pre></td></tr></table></figure>

<p>2.启动数据库服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<p>3.写入CHANGE MASTSER TO信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.73.110&#x27;</span>, MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,MASTER_PASSWORD=<span class="string">&#x27;centos&#x27;</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">&#x27;mariadb-bin.000001&#x27;</span>,MASTER_LOG_POS=245;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>4.启动复制线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>5.查看状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.73.110</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mariadb-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 402</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 688</span><br><span class="line">        Relay_Master_Log_File: mariadb-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>1.主节点导入数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql &lt; hellodb_innodb.sql</span></span><br><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>2.从节点查看</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>主从复制配置完毕</p>
<h3 id="二、在ProxySQL上配置读写分离"><a href="#二、在ProxySQL上配置读写分离" class="headerlink" title="二、在ProxySQL上配置读写分离"></a>二、在ProxySQL上配置读写分离</h3><p>1.在ProxySQL主机上配置yum源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ProxySQL ~]<span class="comment"># vim /etc/yum.repos.d/proxysql.repo</span></span><br><span class="line">[proxysql_repo]</span><br><span class="line">name= ProxySQL YUM repository</span><br><span class="line">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/\<span class="variable">$releasever</span></span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span><br></pre></td></tr></table></figure>

<p>2.安装ProxySQL和mariadb客户端</p>
<p>ProxySQL内置了一个轻量级的数据库，所以需要有MySQL客户端连上去对其进行配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ProxySQL ~]<span class="comment"># yum install proxysql mariadb -y</span></span><br></pre></td></tr></table></figure>

<p>3.启动ProxySQL服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ProxySQL ~]<span class="comment"># service proxysql start</span></span><br><span class="line">Starting ProxySQL: 2019-05-08 14:03:07 [INFO] Using config file /etc/proxysql.cnf</span><br><span class="line">DONE!</span><br></pre></td></tr></table></figure>

<p>4.连接管理端口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ProxySQL ~]<span class="comment"># mysql -uadmin -padmin -P6032 -h127.0.0.1</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br></pre></td></tr></table></figure>

<p>5.将MySQL主从服务器信息添加入mysql_servers表中</p>
<p>先将主从服务器存放在同一组内，等指定好读写规则后，系统会根据配置文件中的read-only值自动将其分别添加至读组和写组。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; INSERT INTO mysql_servers(hostgroup_id,hostname,port) VALUES (10,<span class="string">&#x27;192.168.73.110&#x27;</span>,3306);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; INSERT INTO mysql_servers(hostgroup_id,hostname,port) VALUES (10,<span class="string">&#x27;192.168.73.111&#x27;</span>,3306);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SELECT * FROM mysql_servers</span><br><span class="line">    -&gt; ;</span><br><span class="line">+--------------+----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname       | port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 10           | 192.168.73.110 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 10           | 192.168.73.111 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6.在MySQL服务器的主节点上为ProxySQL添加账号用来查看MySQL节点是主还是从</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;GRANT REPLICATION CLIENT ON *.* TO &#x27;monitor&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;centos&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<p>7.在Proxy上配置监控账号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; SET mysql-monitor_username=<span class="string">&#x27;monitor&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SET mysql-monitor_password=<span class="string">&#x27;centos&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>8.将配置加载至内存，将配置保存至磁盘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; LOAD MYSQL VARIABLES TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL VARIABLES TO DISK;</span><br><span class="line">Query OK, 97 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>9.测试</p>
<p>9.1查看连接状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; select * from mysql_server_connect_log;</span><br><span class="line">+----------------+------+------------------+-------------------------+-------------------------------------------------------------------------+</span><br><span class="line">| hostname       | port | time_start_us    | connect_success_time_us | connect_error                                                           |</span><br><span class="line">+----------------+------+------------------+-------------------------+-------------------------------------------------------------------------+</span><br><span class="line">| 192.168.73.110 | 3306 | 1557296528658352 | 0                       | Access denied <span class="keyword">for</span> user <span class="string">&#x27;monitor&#x27;</span>@<span class="string">&#x27;192.168.73.112&#x27;</span> (using password: YES) |</span><br><span class="line">| 192.168.73.111 | 3306 | 1557296648056186 | 0                       | Access denied <span class="keyword">for</span> user <span class="string">&#x27;monitor&#x27;</span>@<span class="string">&#x27;192.168.73.112&#x27;</span> (using password: YES) |</span><br><span class="line">| 192.168.73.110 | 3306 | 1557296649025169 | 0                       | Access denied <span class="keyword">for</span> user <span class="string">&#x27;monitor&#x27;</span>@<span class="string">&#x27;192.168.73.112&#x27;</span> (using password: YES) |</span><br><span class="line">| 192.168.73.110 | 3306 | 1557296708057600 | 0                       | Access denied <span class="keyword">for</span> user <span class="string">&#x27;monitor&#x27;</span>@<span class="string">&#x27;192.168.73.112&#x27;</span> (using password: YES) |</span><br><span class="line">| 192.168.73.111 | 3306 | 1557296708872496 | 0                       | Access denied <span class="keyword">for</span> user <span class="string">&#x27;monitor&#x27;</span>@<span class="string">&#x27;192.168.73.112&#x27;</span> (using password: YES) |</span><br><span class="line">| 192.168.73.110 | 3306 | 1557296758752550 | 2763                    | NULL                                                                    |  <span class="comment">#此前由于没有创建监控账号所以连接一直失败</span></span><br><span class="line">| 192.168.73.111 | 3306 | 1557296759862679 | 3205                    | NULL                                                                    |</span><br><span class="line">| 192.168.73.110 | 3306 | 1557296818752346 | 1014                    | NULL                                                                    |</span><br><span class="line">| 192.168.73.111 | 3306 | 1557296819498108 | 3120                    | NULL                                                                    |</span><br><span class="line">| 192.168.73.110 | 3306 | 1557296878752978 | 3245                    | NULL                                                                    |</span><br><span class="line">| 192.168.73.111 | 3306 | 1557296879410404 | 3063                    | NULL                                                                    |</span><br><span class="line">+----------------+------+------------------+-------------------------+-------------------------------------------------------------------------+</span><br><span class="line">22 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>9.2测试连接ping</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; select * from mysql_server_ping_log;</span><br><span class="line">+----------------+------+------------------+----------------------+-------------------------------------------------------------------------+</span><br><span class="line">| hostname       | port | time_start_us    | ping_success_time_us | ping_error                                                              |</span><br><span class="line">+----------------+------+------------------+----------------------+-------------------------------------------------------------------------+</span><br><span class="line">| 192.168.73.111 | 3306 | 1557296508118738 | 0                    | Access denied <span class="keyword">for</span> user <span class="string">&#x27;monitor&#x27;</span>@<span class="string">&#x27;192.168.73.112&#x27;</span> (using password: YES) |</span><br><span class="line">| 192.168.73.110 | 3306 | 1557296508302837 | 0                    | Access denied <span class="keyword">for</span> user <span class="string">&#x27;monitor&#x27;</span>@<span class="string">&#x27;192.168.73.112&#x27;</span> (using password: YES) |</span><br><span class="line"></span><br><span class="line">...中间省略...</span><br><span class="line"></span><br><span class="line">| 192.168.73.110 | 3306 | 1557297088874658 | 675                  | NULL                                                                    |</span><br><span class="line">| 192.168.73.111 | 3306 | 1557297089037256 | 435                  | NULL                                                                    |</span><br><span class="line">| 192.168.73.110 | 3306 | 1557297098875954 | 1144                 | NULL                                                                    |</span><br><span class="line">| 192.168.73.111 | 3306 | 1557297099069333 | 1252                 | NULL                                                                    |</span><br><span class="line">+----------------+------+------------------+----------------------+-------------------------------------------------------------------------+</span><br><span class="line">122 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"><span class="comment">#已经可以联通</span></span><br></pre></td></tr></table></figure>

<p>10.设置读写分组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; INSERT INTO mysql_replication_hostgroups VALUES(10,20,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SELECT * FROM mysql_replication_hostgroups;</span><br><span class="line">+------------------+------------------+---------+</span><br><span class="line">| writer_hostgroup | reader_hostgroup | comment |</span><br><span class="line">+------------------+------------------+---------+</span><br><span class="line">| 10               | 20               | <span class="built_in">test</span>    |</span><br><span class="line">+------------------+------------------+---------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>11.让读写表生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; LOAD MYSQL SERVERS TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>12.查看mysql_server表此时已经将服务器分组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; SELECT * FROM mysql_servers;</span><br><span class="line">+--------------+----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname       | port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 10           | 192.168.73.110 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 20           | 192.168.73.111 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>13.保存配置至磁盘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; SAVE MYSQL SERVERS TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure>

<p>至此读写分离配置完毕，接下来需要定义读写分离的规则</p>
<h3 id="三、定义读写分离规则"><a href="#三、定义读写分离规则" class="headerlink" title="三、定义读写分离规则"></a>三、定义读写分离规则</h3><p>1.在主节点上创建一个账户让客户端连接调度器去访问主从服务器（此处授予的权限较大，实际生产中可以根据需要定义指定的那张表）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;GRANT ALL ON *.* TO &#x27;sqluser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;centos&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<p>2.在ProxySQL服务器上，将sqluser用户添加至mysql_users表中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; INSERT INTO mysql_users(username,password,default_hostgroup) VALUES (<span class="string">&#x27;sqluser&#x27;</span>,<span class="string">&#x27;centos&#x27;</span>,10);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>3.查看mysql_user表信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; SELECT * FROM mysql_users;</span><br><span class="line">+----------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span><br><span class="line">| username | password | active | use_ssl | default_hostgroup | default_schema | schema_locked | transaction_persistent | fast_forward | backend | frontend | max_connections |</span><br><span class="line">+----------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span><br><span class="line">| sqluser  | centos   | 1      | 0       | 10                | NULL           | 0             | 1                      | 0            | 1       | 1        | 10000           |</span><br><span class="line">+----------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>4.生效存盘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; load mysql users to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL USERS TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>5.测试</p>
<p>目前尚未设置读写路由规则，所有的请求都是发往主节点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Client ~]<span class="comment"># mysql -usqluser -pcentos -h192.168.73.112 -P6033 -e &quot;SELECT @@server_id;&quot;</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           1 |</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></figure>

<p>6.在ProxySQL上定义调度规则</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; INSERT INTO mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply) VALUES (1,1,<span class="string">&#x27;^SELECT.*FOR UPDATE$&#x27;</span>,10,1),(2,1,<span class="string">&#x27;^SELECT&#x27;</span>,20,1);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>7.查看定义规则</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt;  SELECT * FROM mysql_query_rules\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">              rule_id: 1</span><br><span class="line">               active: 1</span><br><span class="line">             username: NULL</span><br><span class="line">           schemaname: NULL</span><br><span class="line">               flagIN: 0</span><br><span class="line">          client_addr: NULL</span><br><span class="line">           proxy_addr: NULL</span><br><span class="line">           proxy_port: NULL</span><br><span class="line">               digest: NULL</span><br><span class="line">         match_digest: ^SELECT.*FOR UPDATE$</span><br><span class="line">        match_pattern: NULL</span><br><span class="line"> negate_match_pattern: 0</span><br><span class="line">         re_modifiers: CASELESS</span><br><span class="line">              flagOUT: NULL</span><br><span class="line">      replace_pattern: NULL</span><br><span class="line">destination_hostgroup: 10</span><br><span class="line">            cache_ttl: NULL</span><br><span class="line">            reconnect: NULL</span><br><span class="line">              timeout: NULL</span><br><span class="line">              retries: NULL</span><br><span class="line">                delay: NULL</span><br><span class="line">    next_query_flagIN: NULL</span><br><span class="line">       mirror_flagOUT: NULL</span><br><span class="line">     mirror_hostgroup: NULL</span><br><span class="line">            error_msg: NULL</span><br><span class="line">               OK_msg: NULL</span><br><span class="line">          sticky_conn: NULL</span><br><span class="line">            multiplex: NULL</span><br><span class="line">                  <span class="built_in">log</span>: NULL</span><br><span class="line">                apply: 1</span><br><span class="line">              comment: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">              rule_id: 2</span><br><span class="line">               active: 1</span><br><span class="line">             username: NULL</span><br><span class="line">           schemaname: NULL</span><br><span class="line">               flagIN: 0</span><br><span class="line">          client_addr: NULL</span><br><span class="line">           proxy_addr: NULL</span><br><span class="line">           proxy_port: NULL</span><br><span class="line">               digest: NULL</span><br><span class="line">         match_digest: ^SELECT</span><br><span class="line">        match_pattern: NULL</span><br><span class="line"> negate_match_pattern: 0</span><br><span class="line">         re_modifiers: CASELESS</span><br><span class="line">              flagOUT: NULL</span><br><span class="line">      replace_pattern: NULL</span><br><span class="line">destination_hostgroup: 20</span><br><span class="line">            cache_ttl: NULL</span><br><span class="line">            reconnect: NULL</span><br><span class="line">              timeout: NULL</span><br><span class="line">              retries: NULL</span><br><span class="line">                delay: NULL</span><br><span class="line">    next_query_flagIN: NULL</span><br><span class="line">       mirror_flagOUT: NULL</span><br><span class="line">     mirror_hostgroup: NULL</span><br><span class="line">            error_msg: NULL</span><br><span class="line">               OK_msg: NULL</span><br><span class="line">          sticky_conn: NULL</span><br><span class="line">            multiplex: NULL</span><br><span class="line">                  <span class="built_in">log</span>: NULL</span><br><span class="line">                apply: 1</span><br><span class="line">              comment: NULL</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>8.生效存盘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MySQL [(none)]&gt; LOAD MYSQL QUERY RULES TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL QUERY RULES TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="四、在Client端测试"><a href="#四、在Client端测试" class="headerlink" title="四、在Client端测试"></a>四、在Client端测试</h3><p>1.查询操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Client ~]<span class="comment"># mysql -usqluser -pcentos -h192.168.73.112 -P6033 -e &quot;SELECT @@server_id;&quot;</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           2 |</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></figure>

<p>2.写操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Client ~]<span class="comment"># mysql -usqluser -pcentos -h192.168.73.112 -P6033 -e &quot;BEGIN;INSERT hellodb.teachers VALUE(5,&#x27;Long&#x27;,30,&#x27;M&#x27;);SELECT @@server_id;commit;&quot;</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           1 |</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL进程的查杀</title>
    <url>/2019/04/17/MySQL/MySQL%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%9F%A5%E6%9D%80/MySQL%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%9F%A5%E6%9D%80/</url>
    <content><![CDATA[<h2 id="MySQL查杀进程"><a href="#MySQL查杀进程" class="headerlink" title="MySQL查杀进程"></a>MySQL查杀进程</h2><p>1.查看所要杀的进程编号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; SHOW PROCESSLIST;</span><br><span class="line">+----+-------------+-----------+---------+---------+------+---------------------------------+---------------------------------------------+----------+</span><br><span class="line">| Id | User        | Host      | db      | Command | Time | State                           | Info                                        | Progress |</span><br><span class="line">+----+-------------+-----------+---------+---------+------+---------------------------------+---------------------------------------------+----------+</span><br><span class="line">|  4 | system user |           | NULL    | Daemon  | NULL | InnoDB purge worker             | NULL                                        |    0.000 |</span><br><span class="line">|  2 | system user |           | NULL    | Daemon  | NULL | InnoDB purge worker             | NULL                                        |    0.000 |</span><br><span class="line">|  1 | system user |           | NULL    | Daemon  | NULL | InnoDB purge worker             | NULL                                        |    0.000 |</span><br><span class="line">|  3 | system user |           | NULL    | Daemon  | NULL | InnoDB purge coordinator        | NULL                                        |    0.000 |</span><br><span class="line">|  5 | system user |           | NULL    | Daemon  | NULL | InnoDB shutdown handler         | NULL                                        |    0.000 |</span><br><span class="line">| 10 | root        | localhost | hellodb | Sleep   | 6943 |                                 | NULL                                        |    0.000 |</span><br><span class="line">| 11 | root        | localhost | NULL    | Sleep   | 7393 |                                 | NULL                                        |    0.000 |</span><br><span class="line">| 13 | root        | localhost | hellodb | Query   |    0 | init                            | SHOW PROCESSLIST                            |    0.000 |</span><br><span class="line">| 14 | root        | localhost | NULL    | Query   |    3 | Waiting <span class="keyword">for</span> table metadata lock | delete from hellodb.students <span class="built_in">where</span> stuid=20 |    0.000 |</span><br><span class="line">+----+-------------+-----------+---------+---------+------+---------------------------------+---------------------------------------------+----------+</span><br><span class="line">9 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>2.将其进程杀死</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; <span class="built_in">kill</span> 14;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL高可用(Galera Cluster)</title>
    <url>/2019/04/13/MySQL/MySQL%E9%AB%98%E5%8F%AF%E7%94%A8(Galera%20Cluster)/MySQL%E9%AB%98%E5%8F%AF%E7%94%A8GC/</url>
    <content><![CDATA[<h2 id="Galera-Cluster简介"><a href="#Galera-Cluster简介" class="headerlink" title="Galera Cluster简介"></a>Galera Cluster简介</h2><p>Galera Cluster是集成了Galera插件的MySQL集群，是一种新型的，数据不共享的，高度冗余的高可用方案，目前Galera Cluster有两个版本，分别是Percona Xtradb Cluster和MariaDB Cluster，Galera本时是具有多主特性，即采用Multi-master的集群架构，是一个即稳健，又在数据一致性、完整性及高性能方面有出色表现的高可用解决方案</p>
<h3 id="Galera-Cluster内部机制"><a href="#Galera-Cluster内部机制" class="headerlink" title="Galera Cluster内部机制"></a>Galera Cluster内部机制</h3><p><img src="GC.png" alt="GC.png"></p>
<p>Galera Cluster种每个MySQLServer之间相互为主主的关系，当客户端发送指令到一个数据库时，数据库将数据修改后返回一个OK，表示用户的请求已经被收到，但是事务并没有结束依旧可以撤销。当事务结束时用户发送一个commit(提交)，服务器收到后会将数据的更新发送给其他的MySQLServer，此时会开启一个全局性的事务ID给组内的其他服务器，其他服务器会查看是否有事务冲突，如果没有冲突就确认更改成功。</p>
<h3 id="Galera-Cluster特点"><a href="#Galera-Cluster特点" class="headerlink" title="Galera Cluster特点"></a>Galera Cluster特点</h3><ol>
<li><p>多主架构：真正的多点读写的集群，在任何时候读写数据都是最新的</p>
</li>
<li><p>同步复制：集群不同节点之间数据同步，没有延迟，在数据库挂掉之后，数据不会丢失</p>
</li>
<li><p>并发复制：从节点APPLY数据时，支持并行执行有更好的性能。</p>
</li>
<li><p>故障切换：数据库故障时，因为支持多点写入，切换容易</p>
</li>
<li><p>热插拔：在服务期间，如果数据库挂了，只要监控程序发现的够快，不可服务的时间就会非常少。在节点故障期间，节点本身对集群的影响非常小</p>
</li>
<li><p>自动节点克隆： 在新增节点，或者停机维护时，增量数据或者基础数据不需要人工手动备份提供，Galera Cluster会自动拉取在线节点数据，最终集群会变为一直</p>
</li>
<li><p>对应用透明：集群的维护，对应用程序是透明的</p>
</li>
</ol>
<hr>
<h2 id="Galera-Cluster搭建"><a href="#Galera-Cluster搭建" class="headerlink" title="Galera Cluster搭建"></a>Galera Cluster搭建</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>准备3台msyql服务器</p>
<table>
<thead>
<tr>
<th align="left">主机名</th>
<th align="left">ip地址</th>
</tr>
</thead>
<tbody><tr>
<td align="left">node1</td>
<td align="left">192.168.73.110</td>
</tr>
<tr>
<td align="left">node2</td>
<td align="left">192.168.73.111</td>
</tr>
<tr>
<td align="left">node3</td>
<td align="left">192.168.73.112</td>
</tr>
</tbody></table>
<h3 id="一、配置YUM源"><a href="#一、配置YUM源" class="headerlink" title="一、配置YUM源"></a>一、配置YUM源</h3><p>在每个节点上配置YUM源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># vim /etc/yum.repos.d/mysql.repo</span></span><br><span class="line">[mysql]</span><br><span class="line">name=galera cluster</span><br><span class="line">baseurl=http://mirrors.neusoft.edu.cn/mariadb//mariadb-10.0.38/yum/centos7-amd64/</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure>

<h3 id="二、安装MariaDB-Galera-server"><a href="#二、安装MariaDB-Galera-server" class="headerlink" title="二、安装MariaDB-Galera-server"></a>二、安装MariaDB-Galera-server</h3><p>在每个节点上安装MariaDB-Galera-server</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># yum install MariaDB-Galera-server -y</span></span><br></pre></td></tr></table></figure>

<h3 id="三、修改配置文件"><a href="#三、修改配置文件" class="headerlink" title="三、修改配置文件"></a>三、修改配置文件</h3><p>配置文件在/etc/my.cnf.d/server.cnf，有必须设置和可选设置两个配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Mandatory settings                    #这里的项目为必填</span></span><br><span class="line">wsrep_provider=                         <span class="comment">#添加模块路径</span></span><br><span class="line">wsrep_cluster_address=                  <span class="comment">#添加所有服务器的地址gcomm服务器间代替通讯协议</span></span><br><span class="line">binlog_format=row                       <span class="comment">#启用二进制日志</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional setting                      #以下项为可选项</span></span><br><span class="line"><span class="comment">#wsrep_slave_threads=1</span></span><br><span class="line"><span class="comment">#innodb_flush_log_at_trx_commit=0</span></span><br><span class="line"><span class="comment">#wsrep_cluster_name=&#x27;testcluster&#x27;       #集群的名称</span></span><br><span class="line"><span class="comment">#wsrep_node_name=&#x27;node1&#x27;                #当前节点的名称</span></span><br><span class="line"><span class="comment">#wsrep_node_address=&#x27;192.168.73.110&#x27;    #当前节点的地址</span></span><br></pre></td></tr></table></figure>

<p>对每个节点配置文件进行修改，此处以node1为例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># vim /etc/my.cnf.d/server.cnf</span></span><br><span class="line">[galera]</span><br><span class="line"><span class="comment"># Mandatory settings</span></span><br><span class="line">wsrep_provider=/usr/lib64/galera/libgalera_smm.so</span><br><span class="line">wsrep_cluster_address=<span class="string">&quot;gcomm://192.168.73.110,192.168.73.111,192.168.73.112&quot;</span></span><br><span class="line">binlog_format=row</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line">bind-address=0.0.0.0</span><br></pre></td></tr></table></figure>

<h3 id="四、启动服务"><a href="#四、启动服务" class="headerlink" title="四、启动服务"></a>四、启动服务</h3><p>第一个启动的节点需要添加–wsrep-new-cluster选项，说明这是一个新的集群，其余节点启动服务无需添加参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># service mysql start --wsrep-new-cluster</span></span><br></pre></td></tr></table></figure>

<p>node2节点启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># service mysql start</span></span><br></pre></td></tr></table></figure>

<p>node3节点启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node3 ~]<span class="comment"># service mysql start</span></span><br></pre></td></tr></table></figure>

<h3 id="五、测试"><a href="#五、测试" class="headerlink" title="五、测试"></a>五、测试</h3><h4 id="1-测试同步"><a href="#1-测试同步" class="headerlink" title="1.测试同步"></a>1.测试同步</h4><p>从node1导入数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># mysql &lt; hellodb_innodb.sql</span></span><br></pre></td></tr></table></figure>

<p>node2查看</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>node3查看</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node3 ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h4 id="2-测试冲突"><a href="#2-测试冲突" class="headerlink" title="2.测试冲突"></a>2.测试冲突</h4><p>同时在3节点创建表</p>
<p>在node2节点成功，其余节点都失败</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># mysql -e &quot;CREATE TABLE hellodb.test(id int auto_increment primary key,name char(20));&quot;</span></span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>node1节点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># mysql -e &quot;CREATE TABLE hellodb.test(id int auto_increment primary key,name char(20));&quot;</span></span><br><span class="line">ERROR 1050 (42S01) at line 1: Table <span class="string">&#x27;test&#x27;</span> already exists</span><br></pre></td></tr></table></figure>

<p>node3节点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node3 ~]<span class="comment"># mysql -e &quot;CREATE TABLE hellodb.test(id int auto_increment primary key,name char(20));&quot;</span></span><br><span class="line">ERROR 1050 (42S01) at line 1: Table <span class="string">&#x27;test&#x27;</span> already exists</span><br></pre></td></tr></table></figure>

<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>Galera Cluster系统和状态变量</p>
<p>1.查看状态变量:SHOW STATUS LIKE ‘wsrep_%’</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW STATUS LIKE <span class="string">&#x27;wsrep_%&#x27;</span>;</span><br><span class="line">+------------------------------+-------------------------------------------------------------+</span><br><span class="line">| Variable_name                | Value                                                       |</span><br><span class="line">+------------------------------+-------------------------------------------------------------+</span><br><span class="line">| wsrep_local_state_uuid       | e9f07cd3-7253-11e9-b27e-174ea2b4587d                        |</span><br><span class="line">| wsrep_protocol_version       | 9                                                           |</span><br><span class="line">| wsrep_last_committed         | 38                                                          |</span><br><span class="line">| wsrep_replicated             | 36                                                          |</span><br><span class="line">| wsrep_replicated_bytes       | 18960                                                       |</span><br><span class="line">| wsrep_repl_keys              | 144                                                         |</span><br><span class="line">| wsrep_repl_keys_bytes        | 2016                                                        |</span><br><span class="line">| wsrep_repl_data_bytes        | 14522                                                       |</span><br><span class="line">| wsrep_repl_other_bytes       | 0                                                           |</span><br><span class="line">| wsrep_received               | 12                                                          |</span><br><span class="line">| wsrep_received_bytes         | 1782                                                        |</span><br><span class="line">| wsrep_local_commits          | 6                                                           |</span><br><span class="line">| wsrep_local_cert_failures    | 0                                                           |</span><br><span class="line">| wsrep_local_replays          | 0                                                           |</span><br><span class="line">| wsrep_local_send_queue       | 0                                                           |</span><br><span class="line">| wsrep_local_send_queue_max   | 1                                                           |</span><br><span class="line">| wsrep_local_send_queue_min   | 0                                                           |</span><br><span class="line">| wsrep_local_send_queue_avg   | 0.000000                                                    |</span><br><span class="line">| wsrep_local_recv_queue       | 0                                                           |</span><br><span class="line">| wsrep_local_recv_queue_max   | 1                                                           |</span><br><span class="line">| wsrep_local_recv_queue_min   | 0                                                           |</span><br><span class="line">| wsrep_local_recv_queue_avg   | 0.000000                                                    |</span><br><span class="line">| wsrep_local_cached_downto    | 1                                                           |</span><br><span class="line">| wsrep_flow_control_paused_ns | 0                                                           |</span><br><span class="line">| wsrep_flow_control_paused    | 0.000000                                                    |</span><br><span class="line">| wsrep_flow_control_sent      | 0                                                           |</span><br><span class="line">| wsrep_flow_control_recv      | 0                                                           |</span><br><span class="line">| wsrep_cert_deps_distance     | 1.000000                                                    |</span><br><span class="line">| wsrep_apply_oooe             | 0.000000                                                    |</span><br><span class="line">| wsrep_apply_oool             | 0.000000                                                    |</span><br><span class="line">| wsrep_apply_window           | 1.000000                                                    |</span><br><span class="line">| wsrep_commit_oooe            | 0.000000                                                    |</span><br><span class="line">| wsrep_commit_oool            | 0.000000                                                    |</span><br><span class="line">| wsrep_commit_window          | 1.000000                                                    |</span><br><span class="line">| wsrep_local_state            | 4                                                           |</span><br><span class="line">| wsrep_local_state_comment    | Synced                                                      |</span><br><span class="line">| wsrep_cert_index_size        | 82                                                          |</span><br><span class="line">| wsrep_causal_reads           | 0                                                           |</span><br><span class="line">| wsrep_cert_interval          | 0.026316                                                    |</span><br><span class="line">| wsrep_open_transactions      | 0                                                           |</span><br><span class="line">| wsrep_open_connections       | 0                                                           |</span><br><span class="line">| wsrep_incoming_addresses     | 192.168.73.110:3306,192.168.73.111:3306,192.168.73.112:3306 |</span><br><span class="line">| wsrep_cluster_weight         | 3                                                           |</span><br><span class="line">| wsrep_desync_count           | 0                                                           |</span><br><span class="line">| wsrep_evs_delayed            |                                                             |</span><br><span class="line">| wsrep_evs_evict_list         |                                                             |</span><br><span class="line">| wsrep_evs_repl_latency       | 0/0/0/0/0                                                   |</span><br><span class="line">| wsrep_evs_state              | OPERATIONAL                                                 |</span><br><span class="line">| wsrep_gcomm_uuid             | e9efec79-7253-11e9-8e15-9f3e0cc2d8a1                        |</span><br><span class="line">| wsrep_cluster_conf_id        | 3                                                           |</span><br><span class="line">| wsrep_cluster_size           | 3                                                           |</span><br><span class="line">| wsrep_cluster_state_uuid     | e9f07cd3-7253-11e9-b27e-174ea2b4587d                        |</span><br><span class="line">| wsrep_cluster_status         | Primary                                                     |</span><br><span class="line">| wsrep_connected              | ON                                                          |</span><br><span class="line">| wsrep_local_bf_aborts        | 0                                                           |</span><br><span class="line">| wsrep_local_index            | 0                                                           |</span><br><span class="line">| wsrep_provider_name          | Galera                                                      |</span><br><span class="line">| wsrep_provider_vendor        | Codership Oy &lt;info@codership.com&gt;                           |</span><br><span class="line">| wsrep_provider_version       | 25.3.25(r3836)                                              |</span><br><span class="line">| wsrep_ready                  | ON                                                          |</span><br><span class="line">| wsrep_thread_count           | 2                                                           |</span><br><span class="line">+------------------------------+-------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>2.查看系统变量:SHOW VARIABLES like ‘wsrep_%’\G;</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW VARIABLES like <span class="string">&#x27;wsrep_%&#x27;</span>\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Variable_name: wsrep_auto_increment_control</span><br><span class="line">        Value: ON</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">Variable_name: wsrep_causal_reads</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">Variable_name: wsrep_certification_rules</span><br><span class="line">        Value: strict</span><br><span class="line">*************************** 4. row ***************************</span><br><span class="line">Variable_name: wsrep_certify_nonpk</span><br><span class="line">        Value: ON</span><br><span class="line">*************************** 5. row ***************************</span><br><span class="line">Variable_name: wsrep_cluster_address</span><br><span class="line">        Value: gcomm://192.168.73.110,192.168.73.111,192.168.73.112</span><br><span class="line">*************************** 6. row ***************************</span><br><span class="line">Variable_name: wsrep_cluster_name</span><br><span class="line">        Value: testcluster</span><br><span class="line">*************************** 7. row ***************************</span><br><span class="line">Variable_name: wsrep_convert_lock_to_trx</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 8. row ***************************</span><br><span class="line">Variable_name: wsrep_data_home_dir</span><br><span class="line">        Value: /var/lib/mysql/</span><br><span class="line">*************************** 9. row ***************************</span><br><span class="line">Variable_name: wsrep_dbug_option</span><br><span class="line">        Value: </span><br><span class="line">*************************** 10. row ***************************</span><br><span class="line">Variable_name: wsrep_debug</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 11. row ***************************</span><br><span class="line">Variable_name: wsrep_desync</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 12. row ***************************</span><br><span class="line">Variable_name: wsrep_dirty_reads</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 13. row ***************************</span><br><span class="line">Variable_name: wsrep_drupal_282555_workaround</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 14. row ***************************</span><br><span class="line">Variable_name: wsrep_forced_binlog_format</span><br><span class="line">        Value: NONE</span><br><span class="line">*************************** 15. row ***************************</span><br><span class="line">Variable_name: wsrep_load_data_splitting</span><br><span class="line">        Value: ON</span><br><span class="line">*************************** 16. row ***************************</span><br><span class="line">Variable_name: wsrep_log_conflicts</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 17. row ***************************</span><br><span class="line">Variable_name: wsrep_max_ws_rows</span><br><span class="line">        Value: 0</span><br><span class="line">*************************** 18. row ***************************</span><br><span class="line">Variable_name: wsrep_max_ws_size</span><br><span class="line">        Value: 2147483647</span><br><span class="line">*************************** 19. row ***************************</span><br><span class="line">Variable_name: wsrep_mysql_replication_bundle</span><br><span class="line">        Value: 0</span><br><span class="line">*************************** 20. row ***************************</span><br><span class="line">Variable_name: wsrep_node_address</span><br><span class="line">        Value: 192.168.73.110</span><br><span class="line">*************************** 21. row ***************************</span><br><span class="line">Variable_name: wsrep_node_incoming_address</span><br><span class="line">        Value: AUTO</span><br><span class="line">*************************** 22. row ***************************</span><br><span class="line">Variable_name: wsrep_node_name</span><br><span class="line">        Value: node1</span><br><span class="line">*************************** 23. row ***************************</span><br><span class="line">Variable_name: wsrep_notify_cmd</span><br><span class="line">        Value: </span><br><span class="line">*************************** 24. row ***************************</span><br><span class="line">Variable_name: wsrep_on</span><br><span class="line">        Value: ON</span><br><span class="line">*************************** 25. row ***************************</span><br><span class="line">Variable_name: wsrep_osu_method</span><br><span class="line">        Value: TOI</span><br><span class="line">*************************** 26. row ***************************</span><br><span class="line">Variable_name: wsrep_provider</span><br><span class="line">        Value: /usr/lib64/galera/libgalera_smm.so</span><br><span class="line">*************************** 27. row ***************************</span><br><span class="line">Variable_name: wsrep_provider_options</span><br><span class="line">        Value: base_dir = /var/lib/mysql/; base_host = 192.168.73.110; base_port = 4567; cert.log_conflicts = no; cert.optimistic_pa = yes; debug = no; evs.auto_evict = 0; evs.causal_keepalive_period = PT1S; evs.debug_log_mask = 0x1; evs.delay_margin = PT1S; evs.delayed_keep_period = PT30S; evs.inactive_check_period = PT0.5S; evs.inactive_timeout = PT15S; evs.info_log_mask = 0; evs.install_timeout = PT7.5S; evs.join_retrans_period = PT1S; evs.keepalive_period = PT1S; evs.max_install_timeouts = 3; evs.send_window = 4; evs.stats_report_period = PT1M; evs.suspect_timeout = PT5S; evs.use_aggregate = <span class="literal">true</span>; evs.user_send_window = 2; evs.version = 0; evs.view_forget_timeout = P1D; gcache.dir = /var/lib/mysql/; gcache.keep_pages_size = 0; gcache.mem_size = 0; gcache.name = /var/lib/mysql//galera.cache; gcache.page_size = 128M; gcache.recover = no; gcache.size = 128M; gcomm.thread_prio = ; gcs.fc_debug = 0; gcs.fc_factor = 1.0; gcs.fc_limit = 16; gcs.fc_master_slave = no; gcs.max_packet_size = 64500; gcs.max_throttle = 0.25; gcs.recv_q_hard_limit = 9223372036854775807; gcs.recv_q_soft_limit = 0.25; gcs.sync_donor = no; gmcast.listen_addr = tcp://0.0.0.0:4567; gmcast.mcast_addr = ; gmcast.mcast_ttl = 1; gmcast.peer_timeout = PT3S; gmcast.segment = 0; gmcast.time_wait = PT5S; gmcast.version = 0; ist.recv_addr = 192.168.73.110; pc.announce_timeout = PT3S; pc.checksum = <span class="literal">false</span>; pc.ignore_quorum = <span class="literal">false</span>; pc.ignore_sb = <span class="literal">false</span>; pc.linger = PT20S; pc.npvo = <span class="literal">false</span>; pc.recovery = <span class="literal">true</span>; pc.version = 0; pc.wait_prim = <span class="literal">true</span>; pc.wait_prim_timeout = PT30S; pc.weight = 1; protonet.backend = asio; protonet.version = 0; repl.causal_read_timeout = PT30S; repl.commit_order = 3; repl.key_format = FLAT8; repl.max_ws_size = 2147483647; repl.proto_max = 9; socket.checksum = 2; socket.recv_buf_size = 212992; </span><br><span class="line">*************************** 28. row ***************************</span><br><span class="line">Variable_name: wsrep_recover</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 29. row ***************************</span><br><span class="line">Variable_name: wsrep_replicate_myisam</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 30. row ***************************</span><br><span class="line">Variable_name: wsrep_restart_slave</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 31. row ***************************</span><br><span class="line">Variable_name: wsrep_retry_autocommit</span><br><span class="line">        Value: 1</span><br><span class="line">*************************** 32. row ***************************</span><br><span class="line">Variable_name: wsrep_slave_fk_checks</span><br><span class="line">        Value: ON</span><br><span class="line">*************************** 33. row ***************************</span><br><span class="line">Variable_name: wsrep_slave_threads</span><br><span class="line">        Value: 1</span><br><span class="line">*************************** 34. row ***************************</span><br><span class="line">Variable_name: wsrep_slave_uk_checks</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 35. row ***************************</span><br><span class="line">Variable_name: wsrep_sst_auth</span><br><span class="line">        Value:</span><br><span class="line">*************************** 36. row ***************************</span><br><span class="line">Variable_name: wsrep_sst_donor</span><br><span class="line">        Value:</span><br><span class="line">*************************** 37. row ***************************</span><br><span class="line">Variable_name: wsrep_sst_donor_rejects_queries</span><br><span class="line">        Value: OFF</span><br><span class="line">*************************** 38. row ***************************</span><br><span class="line">Variable_name: wsrep_sst_method</span><br><span class="line">        Value: rsync</span><br><span class="line">*************************** 39. row ***************************</span><br><span class="line">Variable_name: wsrep_sst_receive_address</span><br><span class="line">        Value: AUTO</span><br><span class="line">*************************** 40. row ***************************</span><br><span class="line">Variable_name: wsrep_start_position</span><br><span class="line">        Value: 00000000-0000-0000-0000-000000000000:-1</span><br><span class="line">*************************** 41. row ***************************</span><br><span class="line">Variable_name: wsrep_sync_wait</span><br><span class="line">        Value: 0</span><br><span class="line">41 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL的高可用(MHA)</title>
    <url>/2019/04/14/MySQL/MySQL%E9%AB%98%E5%8F%AF%E7%94%A8(MHA)/MySQL%E9%AB%98%E5%8F%AF%E7%94%A8MHA/</url>
    <content><![CDATA[<p>MHA:Master High Availability,对主节点进行监控，可实现自动故障转移至其他从节点；通过提升某一从节点为新的主节点，基于主从复制实现，还需要客户端配合实现，目前MHA主要支持一主二从，即一台充当master，一台充当备用master，另外一台充当从数据库，出于机器成本的考虑，淘宝进行了改造，目前淘宝TMHA已经一主一从。</p>
<span id="more"></span>

<h2 id="MHA架构"><a href="#MHA架构" class="headerlink" title="MHA架构"></a>MHA架构</h2><p><img src="MHA.png" alt="MHA.png"></p>
<h2 id="MHA的工作原理"><a href="#MHA的工作原理" class="headerlink" title="MHA的工作原理"></a>MHA的工作原理</h2><p><img src="MHA2.png" alt="MHA2.png"></p>
<p>MHA是由一台manager服务器远程监控主服务器,当主服务器挂了提升一台从服务器作为主服务器。  </p>
<p>当主节点挂了，manager首先要查看哪台从节点，同步的数据最多，然后提升同步最多的从节点为主节点，再将其余的MySQL服务器对他做从节点。  </p>
<p>如果原主节点没彻底死透，manager会让新的主机通过ssh协议远程连接到原先的主节点，拉取二进制日志进行同步。如果主节死透了那就放弃。　　</p>
<hr>
<h2 id="MHA搭建"><a href="#MHA搭建" class="headerlink" title="MHA搭建"></a>MHA搭建</h2><h3 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h3><p>准备4台主机，管理节点1台，主节点MySQL服务器1台，从节点MySQL服务器2台<br>|主机|IP|<br>|:-|:-|<br>|Manager|192.168.73.111|<br>|Master|192.168.73.110|<br>|Slave1|192.168.73.112|<br>|Slave2|192.168.73.113|</p>
<h3 id="二、将Manager管理节点配置为时间服务器，向所有MySQL服务器提供时间同步"><a href="#二、将Manager管理节点配置为时间服务器，向所有MySQL服务器提供时间同步" class="headerlink" title="二、将Manager管理节点配置为时间服务器，向所有MySQL服务器提供时间同步"></a>二、将Manager管理节点配置为时间服务器，向所有MySQL服务器提供时间同步</h3><p>1.安装chrony服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># yum install -y chrony</span></span><br></pre></td></tr></table></figure>

<p>2.修改chrony配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># vim /etc/chrony.conf</span></span><br><span class="line">server 172.22.0.1 iburst</span><br><span class="line">allow 192.168.0.0/16</span><br><span class="line"><span class="built_in">local</span> stratum 10</span><br></pre></td></tr></table></figure>

<p>3.启动chrony服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># systemctl start chronyd</span></span><br></pre></td></tr></table></figure>

<p>4.将MySQL服务器与Manager服务器进行时间同步</p>
<p>4.1在所有MySQL主机上修改配置文件并启动，并启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># sed -i &#x27;/^server 0/i server 192.168.73.111 iburst&#x27; /etc/chrony.conf</span></span><br><span class="line">[root@Master ~]<span class="comment"># systemctl start chronyd</span></span><br></pre></td></tr></table></figure>

<p>4.2确认时间同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># chronyc sources -v</span></span><br><span class="line">210 Number of sources = 1</span><br><span class="line"></span><br><span class="line">  .-- Source mode  <span class="string">&#x27;^&#x27;</span> = server, <span class="string">&#x27;=&#x27;</span> = peer, <span class="string">&#x27;#&#x27;</span> = <span class="built_in">local</span> clock.</span><br><span class="line"> / .- Source state <span class="string">&#x27;*&#x27;</span> = current synced, <span class="string">&#x27;+&#x27;</span> = combined , <span class="string">&#x27;-&#x27;</span> = not combined,</span><br><span class="line">| /   <span class="string">&#x27;?&#x27;</span> = unreachable, <span class="string">&#x27;x&#x27;</span> = time may be <span class="keyword">in</span> error, <span class="string">&#x27;~&#x27;</span> = time too variable.</span><br><span class="line">||                                                 .- xxxx [ yyyy ] +/- zzzz</span><br><span class="line">||      Reachability register (octal) -.           |  xxxx = adjusted offset,</span><br><span class="line">||      Log2(Polling interval) --.      |          |  yyyy = measured offset,</span><br><span class="line">||                                \     |          |  zzzz = estimated error.</span><br><span class="line">||                                 |    |           \</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample</span><br><span class="line">===============================================================================</span><br><span class="line">^* 192.168.73.111                4   6   377    54    +25us[  +41us] +/-  105ms</span><br></pre></td></tr></table></figure>

<h3 id="三、配置ssh为的密钥认证登陆"><a href="#三、配置ssh为的密钥认证登陆" class="headerlink" title="三、配置ssh为的密钥认证登陆"></a>三、配置ssh为的密钥认证登陆</h3><p>当主节点宕机，manager会让从节点通过ssh协议去尝试连接主节点，并拉取二进制日志，所以要时用密钥的认证方式让从节点登陆到主节点拉取数据。</p>
<p>1.在manager服务器上生成私钥文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa):</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:yAvC2PJUlRyAf1udlrVXzmIsUljTdUdW6X6FVpQ3Ajo root@Manager</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|   ..ooo   ++. +%|</span></span><br><span class="line"><span class="string">|  .  .o   o oo.=*|</span></span><br><span class="line"><span class="string">|   ..    E = oo*o|</span></span><br><span class="line"><span class="string">| + ...... B o B.+|</span></span><br><span class="line"><span class="string">|o = ..ooS. . =...|</span></span><br><span class="line"><span class="string">| + . ...       ..|</span></span><br><span class="line"><span class="string">|  .   .         .|</span></span><br><span class="line"><span class="string">|                 |</span></span><br><span class="line"><span class="string">|                 |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure>

<p>2.将公钥文件复制给自己</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># ssh-copy-id 127.0.0.1</span></span><br></pre></td></tr></table></figure>

<p>3.将整个~/.ssh目录复制给所有的MySQL主机</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># scp -r ~/.ssh 192.168.73.110:/root</span></span><br></pre></td></tr></table></figure>

<p>至此所有环境准备完毕</p>
<h3 id="配置主从复制"><a href="#配置主从复制" class="headerlink" title="配置主从复制"></a>配置主从复制</h3><h4 id="主节点配置"><a href="#主节点配置" class="headerlink" title="主节点配置"></a>主节点配置</h4><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin</span><br><span class="line">binlog-format=row</span><br><span class="line">skip_name_resolve</span><br></pre></td></tr></table></figure>

<p>2.启动数据库服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<p>3.创建主从复制账号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;GRANT REPLICATION SLAVE ON *.* TO &#x27;repluser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;centos&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<p>4.添加mha的管理账号，让管理节点远程连接到主机用来设置主从调整</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql -e &quot;GRANT ALL ON *.* TO &#x27;mhauser&#x27;@&#x27;192.168.73.%&#x27; IDENTIFIED BY &#x27;centos&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="从节点配置"><a href="#从节点配置" class="headerlink" title="从节点配置"></a>从节点配置</h4><p>1.修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only</span><br><span class="line">log-bin</span><br><span class="line">relay_log_purge=0</span><br><span class="line">skip_name_resolve</span><br></pre></td></tr></table></figure>

<p>2.启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>

<p>3.配置CHANGE MASTER TO</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.73.110&#x27;</span>, MASTER_USER=<span class="string">&#x27;repluser&#x27;</span>,MASTER_PASSWORD=<span class="string">&#x27;centos&#x27;</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">&#x27;mariadb-bin.000001&#x27;</span>,MASTER_LOG_POS=245;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>4.启动线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>在Slave2节点上也执行相同的操作，此处步骤省略，需要注意server-id需要修改为和其他主从节点不同  </p>
<p>5.测试  </p>
<p>主节点导入hellodb库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql &lt; hellodb_innodb.sql</span></span><br></pre></td></tr></table></figure>

<p>从节点查看是否同步</p>
<p>slave1</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>Slave2</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave2 ~]<span class="comment"># mysql -e &quot;SHOW DATABASES;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h3 id="二、配置管理节点及被管理节点"><a href="#二、配置管理节点及被管理节点" class="headerlink" title="二、配置管理节点及被管理节点"></a>二、配置管理节点及被管理节点</h3><p>1.在管理节上安装mha4mysql-manager、mha4mysql-node，将两个包放在同一目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># yum install *.rpm -y  #这两个包有依赖管理需要一起安装</span></span><br></pre></td></tr></table></figure>

<p>2.在所有被管理节点上安装mha4mysql-node</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># yum install mha4mysql-node-0.56-0.el6.noarch.rpm -y</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># yum install mha4mysql-node-0.56-0.el6.noarch.rpm -y</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave2 ~]<span class="comment"># yum install mha4mysql-node-0.56-0.el6.noarch.rpm -y</span></span><br></pre></td></tr></table></figure>

<p>3.在管理节点上创建配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># vim /etc/mha/aap1.conf</span></span><br><span class="line">[server default]</span><br><span class="line">user=mhauser</span><br><span class="line">password=111111</span><br><span class="line">manager_workdir=/data/mastermha/app1/</span><br><span class="line">manager_log=/data/mastermha/app1/manager.log</span><br><span class="line">remote_workdir=/data/mastermha/app1/</span><br><span class="line">ssh_user=root</span><br><span class="line">repl_user=repluser</span><br><span class="line">repl_password=111111</span><br><span class="line">ping_interval=1</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=192.168.27.31</span><br><span class="line">candidate_master=1</span><br><span class="line">[server2]</span><br><span class="line">hostname=192.168.27.32</span><br><span class="line">candidate_master=1</span><br><span class="line">[server3]</span><br><span class="line">hostname=192.168.27.33</span><br><span class="line">candidate_master=1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.做检查</p>
<p>4.1检查ssh连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># masterha_check_ssh --conf=/etc/mha/aap1.conf</span></span><br></pre></td></tr></table></figure>

<p>4.2检查主从复制</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># masterha_check_repl --conf=/etc/mha/aap1.conf</span></span><br></pre></td></tr></table></figure>

<p>5.以上两项全部成功后启动程序</p>
<p>mha这个程序是跑在前台的，一次性的可以使用nohub或screen来解决跑在前台的问题</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager ~]<span class="comment"># masterha_manager --conf=/etc/mha/aap1.conf</span></span><br></pre></td></tr></table></figure>

<h3 id="三、测试"><a href="#三、测试" class="headerlink" title="三、测试"></a>三、测试</h3><p>1.在master上跑个存储过程，导入存储过程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># mysql hellodb &lt; testlog.sql</span></span><br></pre></td></tr></table></figure>

<p>2.调用存储过程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; USE hellodb</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [hellodb]&gt; call pro_testlog;</span><br></pre></td></tr></table></figure>

<p>3.另起一个主节点窗口将主节点断网</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Master ~]<span class="comment"># ifdown ens33</span></span><br></pre></td></tr></table></figure>

<p>4.manager端完成切换退出，查看日志，查看新的主节点是哪台slave</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Manager app1]<span class="comment"># tail /data/mastermha/app1/manager.log</span></span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">The latest slave 192.168.73.112(192.168.73.112:3306) has all relay logs <span class="keyword">for</span> recovery.</span><br><span class="line">Selected 192.168.73.112(192.168.73.112:3306) as a new master.</span><br><span class="line">192.168.73.112(192.168.73.112:3306): OK: Applying all logs succeeded.</span><br><span class="line">192.168.73.113(192.168.73.113:3306): This host has the latest relay <span class="built_in">log</span> events.</span><br><span class="line">Generating relay diff files from the latest slave succeeded.</span><br><span class="line">192.168.73.113(192.168.73.113:3306): OK: Applying all logs succeeded. Slave started, replicating from 192.168.73.112(192.168.73.112:3306)</span><br><span class="line">192.168.73.112(192.168.73.112:3306): Resetting slave info succeeded.</span><br><span class="line">Master failover to 192.168.73.112(192.168.73.112:3306) completed successfully.</span><br><span class="line"><span class="comment">#此处显示最新的主节点为192.168.73.112</span></span><br></pre></td></tr></table></figure>

<p>由于从节点在配置文件中定义的为read-only，此时被提升为主能执行写操作时应为管理服务器上有管理账号，他将从节点的服务器全局变量read_only给关闭了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># mysql -e &quot;SELECT @@read_only;&quot;</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@read_only |</span><br><span class="line">+-------------+</span><br><span class="line">|           0 |</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></figure>

<p>为了防止服务服务重启再次变为read-only，此时需要对新主节点的配置文件进行修改将read-only行注释</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line"><span class="comment">#read-only</span></span><br><span class="line">log-bin</span><br><span class="line">relay_log_purge=0</span><br><span class="line">skip_name_resolve</span><br></pre></td></tr></table></figure>

<h3 id="四、测试新的主节点"><a href="#四、测试新的主节点" class="headerlink" title="四、测试新的主节点"></a>四、测试新的主节点</h3><p>1.对hellodb.teachers表插入数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave1 ~]<span class="comment"># mysql -e &quot;INSERT hellodb.teachers VALUES(5,&#x27;Tang San&#x27;,30,&#x27;M&#x27;);&quot;</span></span><br></pre></td></tr></table></figure>

<p>2.Slave2主机上查看是否同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@Slave2 ~]<span class="comment"># mysql -e &quot;SELECT * FROM hellodb.teachers;&quot;</span></span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|   5 | Tang San      |  30 | M      |    <span class="comment">#已经同步</span></span><br><span class="line">+-----+---------------+-----+--------+</span><br></pre></td></tr></table></figure>

<h3 id="其他事项"><a href="#其他事项" class="headerlink" title="其他事项"></a>其他事项</h3><p>当原主节点被修复后，将其添加为从节点使用。</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL语言基础</title>
    <url>/2019/04/16/MySQL/SQL%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/SQL%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/</url>
    <content><![CDATA[<h2 id="SQL语言规范"><a href="#SQL语言规范" class="headerlink" title="SQL语言规范"></a>SQL语言规范</h2><p>SQL是一种结构化的查询语言，需要遵守以下规范：</p>
<ol>
<li>它的命令是不区分大小写的。</li>
<li>SQL语句可以单行或多行书写，以“;”结尾。</li>
<li>关键字不能够跨行或者简写。用空格缩进可以提高语句的可读性。</li>
<li>子句通常位于独立行，便于编辑，提高可读性。</li>
</ol>
<span id="more"></span>
<h2 id="数据库对象"><a href="#数据库对象" class="headerlink" title="数据库对象"></a>数据库对象</h2><p>数据库的对象有数据库、表、索引、视图、用户、存储过程、函数、触发器、事件调度器等等。这些对象在命名时需要遵守其命名的规则：</p>
<ol>
<li>必须以字母开头</li>
<li>可包括数字和三个特殊字符(#_$)</li>
<li>不要使用MySQL的保留字段</li>
<li>同一databases(Schema)下的对象不能同名</li>
</ol>
<h2 id="SQL语句分类"><a href="#SQL语句分类" class="headerlink" title="SQL语句分类"></a>SQL语句分类</h2><p>SQL语句有各种各样的指令，这种语句大致上分成4个类型。这4种类型不通的数据库厂商其分类也不同。</p>
<h3 id="DDL：Data-Defination-Language-数据定义语言"><a href="#DDL：Data-Defination-Language-数据定义语言" class="headerlink" title="DDL：Data Defination Language 数据定义语言"></a>DDL：Data Defination Language 数据定义语言</h3><p>定义如何来创建一个资源，比如创建一个数据库，创建一个表，也包括删除和修改</p>
<p>相关指令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CREATE、DROP、ALTER</span><br></pre></td></tr></table></figure>

<h3 id="DML：Data-Manipulation-Language-数据操纵语言"><a href="#DML：Data-Manipulation-Language-数据操纵语言" class="headerlink" title="DML：Data Manipulation Language 数据操纵语言"></a>DML：Data Manipulation Language 数据操纵语言</h3><p>数据库操纵语言主要用来操作数据库内的数据，这种数据的操作主要是指对数据的增、删、改。</p>
<p>相关指令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">INSERT、DELETE、UPDATE</span><br></pre></td></tr></table></figure>

<h3 id="DCL：Data-Control-Language-数据控制语言"><a href="#DCL：Data-Control-Language-数据控制语言" class="headerlink" title="DCL：Data Control Language 数据控制语言"></a>DCL：Data Control Language 数据控制语言</h3><p>数据控制语言主要指的是对数据库的各种权限控制，比如说授权、删除权限、提交、撤销</p>
<p>相关指令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GRANT、REVOKE、COMMIT、ROLLBACK</span><br></pre></td></tr></table></figure>

<h3 id="DQL：Data-Query-Language-数据查询语言"><a href="#DQL：Data-Query-Language-数据查询语言" class="headerlink" title="DQL：Data Query Language 数据查询语言"></a>DQL：Data Query Language 数据查询语言</h3><p>数据库查询语言是对数据库内的相关数据进行查询的指令，是运维人员在工作中对数据的常用操作</p>
<p>相关指令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SELECT</span><br></pre></td></tr></table></figure>

<h2 id="SQL语句构成"><a href="#SQL语句构成" class="headerlink" title="SQL语句构成"></a>SQL语句构成</h2><p>SQL语句是由关键字(keyword)加上对象的名称组合而成的子句(clause)，多个子句(clause)再构成一个完整的语句</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SELECT * FROM products WHERE price&gt;400;  </span><br><span class="line"><span class="comment">#上面这是一个完整的查询语句，他是由以下几个字句组成</span></span><br><span class="line">SELECT *                    <span class="comment">#SELECT子句</span></span><br><span class="line">FROM products               <span class="comment">#FROM子句</span></span><br><span class="line">WHERE price&gt;400             <span class="comment">#WHERE子句</span></span><br><span class="line"><span class="comment">#一组SQL语句由三个子句构成，SELECT、FROM和WHERE是关键字</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库的基础（一）</title>
    <url>/2019/04/16/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80--1/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80--1/</url>
    <content><![CDATA[<p>数据库在互联网企业中应用非常普遍，数据库在企业内一般由专业的DBA来进行管理，但是在有些公司内梅有专业的DBA管理员，这时候就需要运维人员兼任DBA。传说中删库跑路就是说的此处。</p>
<p>MySQL数据库相当复杂，首先我们先介绍下MySQL数据库基础。</p>
<span id="more"></span>

<h2 id="数据库基础"><a href="#数据库基础" class="headerlink" title="数据库基础"></a>数据库基础</h2><h3 id="数据的时代"><a href="#数据的时代" class="headerlink" title="数据的时代"></a>数据的时代</h3><p>现在是大数据的时代，产生了大量的数据，近代时间所产生的数据比人类文明产生到计算机诞生所产生的数据更多，所以大数据的概念应运而生，大数据就是分析各种地方产生的数据，从中能分析出一些有价值的东西。</p>
<h3 id="数据库的发展历史"><a href="#数据库的发展历史" class="headerlink" title="数据库的发展历史"></a>数据库的发展历史</h3><p>产生了那么多数据，我们要使用这些数据，就需要让其找个地方保存下来。数据库发展至今都经历了以下几个阶段。</p>
<h4 id="萌芽阶段：文件系统"><a href="#萌芽阶段：文件系统" class="headerlink" title="萌芽阶段：文件系统"></a>萌芽阶段：文件系统</h4><p>使用磁盘文件来存储数据</p>
<p>早期数据是以文件的方式存放，将数据存放在一个文件内。这种数据的存放方式到目前为止依旧在使用。但是以文件的方式来存放数据，这种方式并不专业。比如说，如果把一个具体的数据存放在一个文件中，那么当你要管理磁盘上的文件是相当麻烦的，因为我们要管理这些文件需要用到对应的文件管理工具，比如我要把文件放在word内就需要用word打开，如果将数据存放在excel内就需要使用excel进行打开。</p>
<p>使用文件来存储还存在一个问题，那就是当有2个用户同时对一个文件进行修改时，最后生效的会是哪一个用户呢？最后存盘的那个用户生效了，这时存储数据的结果就出现了一个不可预知的结果，第一个用户以为他存盘生效了实际上他所写的内容却被后存盘的用户所覆盖。</p>
<p>所以使用文件来作为数据存储的方式是相当不可靠的。所以急需一中更专业的软件，这种软件专用于管理数据库。你要是想使用数据必须要使用此软件间接去访问数据库，而不能直接的去访问数据库</p>
<p>这种数据库的专业软件有个名称叫DBMS(Databases Managerment System)，它是管理数据库的系统软件，它实现数据库系统的各种功能，是数据库系统的核心。它来和存储数据的文件进行打交道，用户访问数据库时不需要直接访问文件，所以用户无需关心文件保存的格式。DBMS自动将文件中的内容显示出来展现给用户。用户通过DBMS访问数据库时，可以不关心数据库在磁盘上的存储方式来更加方便的访问数据，访问数据时还支持并发访问数据。在并发访问时它还对文件进行加锁，避免了文件的破坏。</p>
<h4 id="初级阶段：第一代数据库"><a href="#初级阶段：第一代数据库" class="headerlink" title="初级阶段：第一代数据库"></a>初级阶段：第一代数据库</h4><p>第一代数据库系统是网状模型、层次模型的数据库</p>
<p>最早出现的是网状DBMS，1964年通用电气公司的Charles Bachman成功地开发出世界上第一个网状IDS，也是第一个数据库管理系统，IDS具有数据模型和日志的特征，只能在GE主机运行。网状模型其类似于人类的关系网，虽然网状模型符合人的逻辑思维。但是一旦数据量到了一定的程度将造成数据管理的混乱。</p>
<p>层次性数据库，将数据分层进行管理，以数形结构表示实体及其之间的联系，关系只支持一对多，代表数据库IBM IMS。层次性数据库容易造成数据的冗余，同一个数据被多次存放。造成数据量的增大。</p>
<h4 id="中级阶段：第二代数据库"><a href="#中级阶段：第二代数据库" class="headerlink" title="中级阶段：第二代数据库"></a>中级阶段：第二代数据库</h4><p>关系型数据库和结构化查询语言。</p>
<p>目前主要数据库结构为关系型数据库，其代表类型为 MySQL、Oracle、sql_server、DB2。<br>关系型数据库有个最大的问题，性能较差，在当今数据量如此的巨大的情况下，其数据库的性能是远远达不到要求的。于是又产生了一种非关系型数据库技术叫NOSQL。</p>
<p>NOSQL中No表示not only，表示除了关系型数据库还有其他的数据库，比如memcached、redis等等。</p>
<h4 id="高级阶段：新一代数据库"><a href="#高级阶段：新一代数据库" class="headerlink" title="高级阶段：新一代数据库"></a>高级阶段：新一代数据库</h4><p>现在关系型数据库的基础上添加了一些面向对象的思想，所以称之为”关系-对象” 型数据库</p>
<h3 id="数据库管理系统的优缺点"><a href="#数据库管理系统的优缺点" class="headerlink" title="数据库管理系统的优缺点"></a>数据库管理系统的优缺点</h3><h4 id="数据库管理系统的优点"><a href="#数据库管理系统的优点" class="headerlink" title="数据库管理系统的优点"></a>数据库管理系统的优点</h4><ol>
<li>相互关联的数据的集合</li>
<li>较少的数据冗余</li>
<li>程序与数据相互独立</li>
<li>保证数据的安全、可靠</li>
<li>最大限度地保证数据的正确性</li>
<li>数据可以并发使用并能同时保证一致性</li>
</ol>
<h4 id="数据库管理系统的缺点"><a href="#数据库管理系统的缺点" class="headerlink" title="数据库管理系统的缺点"></a>数据库管理系统的缺点</h4><ol>
<li>编写应用程序不方便</li>
<li>数据冗余不可避免</li>
<li>应用程序依赖性</li>
<li>不支持对文件的并发访问</li>
<li>数据间联系弱</li>
<li>难以按用户视图表示数据</li>
<li>无安全控制功能</li>
</ol>
<h3 id="数据库管理系统的基本功能"><a href="#数据库管理系统的基本功能" class="headerlink" title="数据库管理系统的基本功能"></a>数据库管理系统的基本功能</h3><p>数据库管理系统所必须的基本功能有以下这些：</p>
<p>数据定义：在关系型数据库中需要用到数据库的定义，例如表的定义、视图、触发器、存储过程。</p>
<p>数据处理：对数据库中的数据进行处理，比如增、删、改、查。</p>
<p>数据安全：对数据库设置权限等。</p>
<p>数据备份：对数据库进行备份和还原。</p>
<h3 id="数据库的架构"><a href="#数据库的架构" class="headerlink" title="数据库的架构"></a>数据库的架构</h3><p>数据库的架构有以下几种：</p>
<p>单机架构：比如说数据库安装在那台主机上，操作人员就坐在哪台主机上进行操作。典型的数据库access数据库</p>
<p>大型主机/终端架构：一个大型机上带多个终端，使用终端方式远程链接到服务器上。</p>
<p>主从式架构(C/S)：目前主流，有客户端有服务器端。</p>
<p>分布式架构：</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库的基础（二）</title>
    <url>/2019/04/16/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80--2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80--2/</url>
    <content><![CDATA[<h2 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h2><p>关系型数据库就是将所有的数据基于关系的方式来保存，所谓的关系就是将所有的数据将其保存在一个一个的二维表中。</p>
<span id="more"></span>
<p>关系 ：关系就是二维表，其中：表中的行、列次序并不重要</p>
<p>行row：表中的每一行，又称为一条记录</p>
<p>列column：表中的每一列，称为属性，字段</p>
<p>主键Primary key：用于惟一确定一个记录的字段。主键是一个属性作用在某一个字段上，一旦作用在某一个字段上，那么就表示这个字段上所有的记录在这个字段内是不能重复的，注意每张表上的主键只能有一个。</p>
<p>域domain：每个字段、属性的取值范围，如，性别只能是‘男’和‘女’两个值</p>
<h3 id="数据的操作"><a href="#数据的操作" class="headerlink" title="数据的操作"></a>数据的操作</h3><p>数据提取：在数据集合中提取感兴趣的内容。SELECT（查）。</p>
<p>数据更新：变更数据库中的数据。INSERT、DELETE、UPDATE</p>
<h3 id="表和表之间的联系"><a href="#表和表之间的联系" class="headerlink" title="表和表之间的联系"></a>表和表之间的联系</h3><p>数据库的表和表之间是有关联的，它们之间的关联有可能是一对一的关系，也有可能是一对多的关系或者多对多的关系。</p>
<h4 id="一对一联系"><a href="#一对一联系" class="headerlink" title="一对一联系"></a>一对一联系</h4><p>比如说员工信息表和员工工资表，这两张表就是一对一的关系，但是如何将这两张表进行关联起来？这就需要靠员工编号进行关联，比如1号员工的信息是什么，1号员工的工资是多少。这样就将这两张表一对一的关联起来了。</p>
<p>表1:员工信息</p>
<table>
<thead>
<tr>
<th align="left">员工编号</th>
<th align="left">姓名</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">张三</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">李四</td>
</tr>
</tbody></table>
<p>表2:员工工资</p>
<table>
<thead>
<tr>
<th align="left">员工编号</th>
<th align="left">一月工资</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">12000</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">14000</td>
</tr>
</tbody></table>
<h4 id="一对多联系"><a href="#一对多联系" class="headerlink" title="一对多联系"></a>一对多联系</h4><p>比如说部门和员工的关系，假设一个公司有销售部，技术部等等，一个部门有多个员工，每个员工对应一个部门。如下表所示：</p>
<p>表1：员工信息表</p>
<table>
<thead>
<tr>
<th align="left">员工ID</th>
<th align="left">员工姓名</th>
<th align="left">部门ID</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">a</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">b</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">c</td>
<td align="left">1</td>
</tr>
</tbody></table>
<p>表2：部门表</p>
<table>
<thead>
<tr>
<th align="left">部门ID</th>
<th align="left">部门名称</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">技术部</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">销售部</td>
</tr>
</tbody></table>
<p>以上两张表从逻辑上来说的确是1对1的关系，但是从技术角度来说如何保证他们的一对一关系呢？比如说添加了第4个员工，它的员工编号为4，部门编号为3，而表2的部门编号为1、2没有第三个部门，那么如何避免这种错误的记录产生？</p>
<p>在上一节中我们说到了主键，在这两张表中表1的员工ID设为主键，表2的部门ID为主键，有了主键后那么主键上的每条记录都是唯一的，有了主键之后我们怎么把两张表上多对多的关系表现出来？也就是说确保表1中的部门ID就是表2中部门ID，这时候就需要用到外键技术foreign key (FK)，外键就是将表和表之间一对多的关系表现出来。由于表1上的部门ID字段依赖于表2的部门ID字段，所以在依赖表（表1）上的部门ID字段建立一个外键，这个外键依赖于表2的部门ID字段，一旦外键建立，那就意味外键上的所有字段必须来自于表2的主键，如果此时在表1上插入一个不存在的部门字段将会报错。</p>
<p>这样就将表和表之间一对多的关系用主外键进行关联起来了，这里需要注意的是表1依赖于表2的话，那么表2上必须要有主键或者唯一键。</p>
<h4 id="多对多联系"><a href="#多对多联系" class="headerlink" title="多对多联系"></a>多对多联系</h4><p>通常还有一些情况下表和表之间的关系有可能是多对多的关系。比如以下表之间的关系，表1为学生信息表，表2为课程表，表3为学生和课程的对应关系</p>
<p>student_table<br>|ID|name|<br>|:-|:-|<br>|1|a|<br>|2|b|</p>
<p>class_table<br>|class_id|name|<br>|:-|:-|<br>|1|Linux|<br>|2|Python|</p>
<p>student_class<br>|ID|sudent_ID|Class_ID|<br>|:-|:-|:-|<br>|1|1|1|<br>|2|2|1|<br>|3|2|2|</p>
<h3 id="简易数据规划流程"><a href="#简易数据规划流程" class="headerlink" title="简易数据规划流程"></a>简易数据规划流程</h3><h4 id="第一阶段：收集数据，得到字段"><a href="#第一阶段：收集数据，得到字段" class="headerlink" title="第一阶段：收集数据，得到字段"></a>第一阶段：收集数据，得到字段</h4><p>收集必要且完整的数据项<br>转换成数据表的字段</p>
<h4 id="第二阶段：把字段分类，归入表，建立表的关联"><a href="#第二阶段：把字段分类，归入表，建立表的关联" class="headerlink" title="第二阶段：把字段分类，归入表，建立表的关联"></a>第二阶段：把字段分类，归入表，建立表的关联</h4><p>关联：表和表间的关系<br>分割数据表并建立关联的优点<br>节省空间<br>减少输入错误<br>方便数据修改</p>
<h4 id="第三阶段：规范化数据库"><a href="#第三阶段：规范化数据库" class="headerlink" title="第三阶段：规范化数据库"></a>第三阶段：规范化数据库</h4><p>数据库规范化，又称数据库或资料库的正规化、标准化，是数据库设计中的一系列原理和技术，以减少数据库中数据冗余，增进数据的一致性。关系模型的发明者埃德加·科德最早提出这一概念，并于1970年代初定义了第一范式、第二范式和第三范式的概念</p>
<h5 id="RDMBS设计范式基础概念"><a href="#RDMBS设计范式基础概念" class="headerlink" title="RDMBS设计范式基础概念"></a>RDMBS设计范式基础概念</h5><p>设计关系数据库时，遵从不同的规范要求，设计出合理的关系型数据库，不同的规范要求被称为不同范式，各种范式呈递次规范，越高的范式数据库冗余越小目前关系数据库有六种范式：第一范式（1NF）、第二范式（2NF）、第三范式（3NF）、巴德斯科范式（BCNF）、第四范式(4NF）和第五范式（5NF，又称完美范式）。满足最低要求的范式是第一范式（1NF）。在第一范式的基础上进一步满足更多规范要求的称为第二范式（2NF），其余范式以次类推。一般数据库只需满足第三范式(3NF）即可</p>
<h5 id="范式"><a href="#范式" class="headerlink" title="范式"></a>范式</h5><p>1NF：无重复的列，每一列都是不可分割的基本数据项，同一列中不能有多个值，即实体中的某个属性不能有多个值或者不能有重复的属性，确保每一列的原子性。除去同类型的字段，就是无重复的列<br> 说明：第一范式（1NF）是对关系模式的基本要求，不满足第一范式（1NF）的数据库就不是关系数据库</p>
<p>2NF：属性完全依赖于主键，第二范式必须先满足第一范式，要求表中的每个行必须可以被唯一地区分。通常为表加上一个列，以存储各个实例的唯一标识PK，非PK的字段需要与整个PK有直接相关性</p>
<p>3NF：属性不依赖于其它非主属性，满足第三范式必须先满足第二范式。第三范式要求一个数据库表中不包含已在其它表中已包含的非主关键字信息，非PK的字段间不能有从属关系</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库的基础（三）</title>
    <url>/2019/04/17/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80--3/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80--3/</url>
    <content><![CDATA[<h2 id="SQL概念"><a href="#SQL概念" class="headerlink" title="SQL概念"></a>SQL概念</h2><p>对于MySQL数据库来说，它所使用的数据库语言是数据库的标准规范语言。除了MySQL其他的关系型数据库语言如oreclo、sql_server、DB2，所使用的也都是标准的关系型数据库语言SQL语言。MySQL中的SQL就是从此处而来。</p>
<span id="more"></span>
<p>SQL的含义为结构化的查询语言，这种语言转适用于对关系型数据库进行各种增删查改的操作，这是一种国际标准的SQL语言，适用于各种关系型数据库。所以MySQL的语言是可以在其他的SQL数据库中通用的。</p>
<h3 id="MySQL服务器端"><a href="#MySQL服务器端" class="headerlink" title="MySQL服务器端"></a>MySQL服务器端</h3><p>MySQL包括其他数据库基本上都是基于C/S架构，有专门的服务器端软件按和专门的客户端软件，MySQL的服务器端软件会监听在tcp的3306端口</p>
<h3 id="MySQL客户端"><a href="#MySQL客户端" class="headerlink" title="MySQL客户端"></a>MySQL客户端</h3><p>MySQL客户端软件有图形界面的也有命令行模式，在MySQL中客户端工具是在服务端安装完毕后自带了一个命令行工具，名字叫mysql。通过mysql这个小软件就可以连接数据库进行操作，当然也有第三方图形化的软件。对于这种连接方式对用户的要求是非常高的，要求用户必须是专业的数据库的工程师才能知道去输入哪些命令去连接和管理。</p>
<p>事实上大部分普通人根本不会些SQL语句，但是他就是想对数据库中的内容做相应的操作。比如说在淘宝上下订单买了一个商品，这时候在后台数据库应为下了一个订单就会增加一个订单记录，记录下订单的时间、订单号、用户信息等等。那么如果要对订单进行操作，作为一个普通的用户来说根本不知道什么叫做SQL语句。所以我们需要通过一个友好的界面，比如在淘宝上只需要点击鼠标，但是在点鼠标的背后必须由工程师，把点鼠标的行为转换成SQL语句最终来操作数据库。所以这个过程时候开发人员来负责的，开发人员编写程序，通过对应的数据库的开发接口，连接到后端的数据库进行操作。比如说做各种开发需要连接到后台服务器，就需要用到连接数据库api接口ODBC或JDBC</p>
<h3 id="MySQL的基本概念"><a href="#MySQL的基本概念" class="headerlink" title="MySQL的基本概念"></a>MySQL的基本概念</h3><h4 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h4><p>约束(constraint)，表中的数据要遵守的限制，其约束有以下几种：</p>
<table>
<thead>
<tr>
<th align="left">约束方式</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">主键(PK)</td>
<td align="left">一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行；必须提供数据，即NOT NULL，一个表只能有一个</td>
</tr>
<tr>
<td align="left">惟一键(UK)</td>
<td align="left">一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行；允许为NULL，一个表可以存在多个</td>
</tr>
<tr>
<td align="left">外键(FK)</td>
<td align="left">一个表中的某字段可填入的数据取决于另一个表的主键或唯一键已有的数据</td>
</tr>
<tr>
<td align="left">检查</td>
<td align="left">限制一个字段的有效范围</td>
</tr>
</tbody></table>
<h4 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h4><p>将表中的一个或多个字段中的数据复制一份另存，并且按特定次序排序存储</p>
<h4 id="关系运算"><a href="#关系运算" class="headerlink" title="关系运算"></a>关系运算</h4><p>选择：挑选出符合条件的行</p>
<p>投影：挑选出需要的字段</p>
<p>连接：表间字段的关联</p>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><h4 id="数据抽象"><a href="#数据抽象" class="headerlink" title="数据抽象"></a>数据抽象</h4><p>物理层：从数据存储格式的角度出发，即RDBMS在磁盘上如何组织文件，如何存储数据。</p>
<p>逻辑层：从DBA角度出发，描述存储什么数据，以及数据间存在什么样的关系。</p>
<p>视图层：从用户角度出发，描述DB中的部分数据。比如在网站上购物时你只能看到出售的价格，但看不到进货价格。</p>
<h4 id="关系模型的分类"><a href="#关系模型的分类" class="headerlink" title="关系模型的分类"></a>关系模型的分类</h4><p>关系模型</p>
<p>基于对象的关系模型</p>
<p>半结构化的关系模型：XML数据</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>服务器</title>
    <url>/2019/03/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%9C%8D%E5%8A%A1%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
    <content><![CDATA[<h2 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h2><p>服务器(Server)是计算机的一种，是网络中为客户端计算机提供各种服务的高性能的计算机，服务器在网络操作系统的控制下，将与其相连的硬盘、磁带、打印机及昂贵的专用通讯设备提供给网络上的客户站点共享，也能为网络用户提供集中计算、信息发布及数据管理等服务。</p>
<h3 id="服务器分类"><a href="#服务器分类" class="headerlink" title="服务器分类"></a>服务器分类</h3><h4 id="按应用功能分类："><a href="#按应用功能分类：" class="headerlink" title="按应用功能分类："></a>按应用功能分类：</h4><p>Web服务器、数据库服务器、文件服务器、中间件应用服务器、日志服务器、监控服务器、程序版本控制服务器、虚拟机服务器、邮件服务器、打印服务器、域控制服务器、多媒体服务器、通讯服务器、ERP服务器等</p>
<h4 id="按外形分类："><a href="#按外形分类：" class="headerlink" title="按外形分类："></a>按外形分类：</h4><h5 id="塔式服务器"><a href="#塔式服务器" class="headerlink" title="塔式服务器"></a>塔式服务器</h5><p>早期的服务器形式，外形以及结构和平时使用的立式PC差不多，机箱空间大，主板扩展性较强，插槽较多，预留了足够的内部空间，以便日后进行硬盘和电源的冗余扩展， 设计一般都考虑降噪，目前较少使用。</p>
<p> <img src="clip_image002.gif" alt="塔式服务器"></p>
<h5 id="刀片式服务器"><a href="#刀片式服务器" class="headerlink" title="刀片式服务器"></a>刀片式服务器</h5><p>在标准高度的机架式机箱内可插装多个卡式的服务器单元，实现高可用和高密度</p>
<p>更高的密度，集中管理，高性能，灵活扩展， 按需配置</p>
<p>可以使用系统软件将这些母板集合成一个服务器集群。在集群模式下，所有的母板可以连接起来提供高速的网络环境，并同时共享资源， 为相同的用户群服务</p>
<p> <img src="clip_image003.gif" alt="刀片式服务器"></p>
<p> <img src="clip_image004.gif" alt="刀片式服务器"></p>
<h5 id="机架式服务器"><a href="#机架式服务器" class="headerlink" title="机架式服务器"></a>机架式服务器</h5><p>按照统一标准设计，配合机柜统一使用，便于统计管理，高密度，节省空间。</p>
<p>机架服务器的宽度为19英寸（48.26cm）， 高度以U为单位，如42U。1U=1.75英寸=44.45毫米，通常有1U， 2U，3U，4U，5U，7U几种标准的服务器。机柜的尺寸也是采用通用的工业标准。</p>
<p>现阶段销售数量最多的服务器，机箱尺寸比较小巧，在机柜中可以同时放置多台服务器。</p>
<p> <img src="2.png" alt="1U机架式服务器"></p>
<p> <img src="123.png" alt="2U机架式服务器"></p>
<p><img src="image-20200627123600272.gif" alt="4U机架式服务器"></p>
<p><img src="image-20200627123533440.gif" alt="机柜"></p>
]]></content>
      <categories>
        <category>计算机基础</category>
      </categories>
      <tags>
        <tag>计算机基础</tag>
      </tags>
  </entry>
  <entry>
    <title>服务器cpu</title>
    <url>/2019/03/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%9C%8D%E5%8A%A1%E5%99%A8CPU/%E6%9C%8D%E5%8A%A1%E5%99%A8CPU/</url>
    <content><![CDATA[<h2 id="服务器CPU"><a href="#服务器CPU" class="headerlink" title="服务器CPU"></a>服务器CPU</h2><p>CPU是Central Processing Unit的缩写，即中央处理器。由控制器和运算器构成，是整个计算机系统中最重要的部分。</p>
<h3 id="服务器cpu公司"><a href="#服务器cpu公司" class="headerlink" title="服务器cpu公司"></a>服务器cpu公司</h3><p><strong>Intel</strong>: Xeon志强 Itaniun安腾</p>
<p><img src="image-20200628215234451.png" alt="Intel"></p>
<p><strong>AMD</strong>: Althlon MP</p>
<p><img src="image-20200628215253194.png" alt="AMD"></p>
<p><strong>IBM</strong>: Power</p>
<p><img src="image-20200628215314866.png" alt="IBM"></p>
<h3 id="CPU相关术语"><a href="#CPU相关术语" class="headerlink" title="CPU相关术语"></a>CPU相关术语</h3><p>主频：主频是CPU的时钟频率(CPU Clock Speed)，是CPU运算时的工作的频率（1秒内发生的同步脉冲数）的简称。单位是Hz。一般说来，主频越高，CPU的速度越快，由于内部结构不同，并非所有的时钟频率相同的CPU的性能都一样</p>
<p>外频：系统总线的工作频率， CPU与外部（主板芯片组）交换数据、指令的工作时钟频率</p>
<p>倍频：倍频则是指CPU外频与主频相差的倍数</p>
<p>三者关系是：主频=外频x倍频</p>
<p>高速缓存（cache）：高速交换的存储器。CPU缓存分为一级，二级，三级缓存， 即L1，L2，L3</p>
<p>内存总线速度(Memory-Bus Speed)：一般等同于CPU的外频，指CPU与二级(L2)高速缓存和内存之间的通信速度</p>
<p>地址总线宽度：决定了CPU可以访问的物理地址空间</p>
<h3 id="CPU类型"><a href="#CPU类型" class="headerlink" title="CPU类型"></a>CPU类型</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x86</span><br><span class="line">x64（CISC）</span><br><span class="line">ARM（Acorn RISC Machine）</span><br><span class="line">m68000, m68k（moto）</span><br><span class="line">Power（IBM）</span><br><span class="line">Powerpc（apple,ibm,moto）</span><br><span class="line">Ultrasparc （Sun）</span><br><span class="line">Alpha（HP）</span><br><span class="line">安腾（compaq）</span><br></pre></td></tr></table></figure>

<p>按照CPU体系架构来区分，服务器主要分为两类：</p>
<p><strong>非x86服务器</strong>：使用RISC（精简指令集）或EPIC（并行指令代码） 处理器，并且主要采用UNIX和其它专用操作系统的服务器，指令系统相对简单，它只要求硬件执行很有限且最常用的那部分执令，CPU主要有Compaq的Alpha、HP的PA-RISC、IBM的Power PC、MIPS的MIPS和SUN的Sparc、Intel研发的EPIC 安腾处理器等。这种服务器价格昂贵，体系封闭，但是稳定性好，性能强，主要用在金融、电信等大型企业的核心系统。</p>
<p><strong>x86服务器</strong>：又称CISC（复杂指令集）架构服务器，即通常所讲的PC服务器， 它是基于PC机体系结构，使用Intel或其它兼容x86指令集的处理器芯片的服务器。目前主要为intel的Xeon E3，E5，E7系列，价格相对便宜、兼容性好、稳定性较差、安全性不算太高。</p>
]]></content>
      <categories>
        <category>计算机基础</category>
      </categories>
      <tags>
        <tag>计算机基础</tag>
      </tags>
  </entry>
  <entry>
    <title>服务器主板</title>
    <url>/2019/03/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%BB%E6%9D%BF/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%BB%E6%9D%BF/</url>
    <content><![CDATA[<h2 id="服务器主板"><a href="#服务器主板" class="headerlink" title="服务器主板"></a>服务器主板</h2><p>主板mainboard、系统板systemboard或母板motherboard，安装在机箱内， 是计算机最基本的也是最重要的部件之一。</p>
<p>主板一般为矩形电路板，上面安装了组成计算机的主要电路系统，一般有BIOS 芯片、I/O控制芯片、键盘和面板控制开关接口、指示灯插接件、扩充插槽、主板及插卡的直流电源供电接插件等元件。</p>
<p><img src="image-20200627215201433.png" alt="服务器主板"></p>
]]></content>
      <categories>
        <category>计算机基础</category>
      </categories>
      <tags>
        <tag>计算机基础</tag>
      </tags>
  </entry>
  <entry>
    <title>服务器内存</title>
    <url>/2019/03/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%86%85%E5%AD%98/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%86%85%E5%AD%98/</url>
    <content><![CDATA[<h2 id="服务器内存"><a href="#服务器内存" class="headerlink" title="服务器内存"></a>服务器内存</h2><h3 id="内存和外存"><a href="#内存和外存" class="headerlink" title="内存和外存"></a>内存和外存</h3><p>内存是介于CPU和外部存储之间，是CPU对外部存储中程序与数据进行高速运算时存放程序指令、数据和中间结果的临时场所，它的物理实质就是一组具备数据输入输出和数据存储功能的高速集成电路，内存是CPU能直接寻址的存储空间，由半导体器件制成。内存的特点是存取速度快，计算机中所有程序的运行都是在内存中进行的，因此内存的性能对计算机的影响非常大。</p>
<p> <img src="clip_image002.jpg" alt="内存"></p>
<p>外存：硬盘，U盘，软盘，光盘</p>
<h4 id="内存和外存的区别："><a href="#内存和外存的区别：" class="headerlink" title="内存和外存的区别："></a>内存和外存的区别：</h4><ul>
<li><p>内存断电后数据丢失</p>
</li>
<li><p>外存断电后数据可以保存</p>
</li>
</ul>
<h3 id="内存相关术语"><a href="#内存相关术语" class="headerlink" title="内存相关术语"></a>内存相关术语</h3><p><strong>容量</strong>：即该内存的存储容量，单位一般为“MB”或“GB”</p>
<p><strong>内存带宽</strong>：内存带宽是指内存与北桥芯片之间的数据传输率，单通道内存节制器一般都是64-bit的，8个二进制位相当于1个字节，换算成字节是64/8=8，再乘以内存的运行频率，如果是DDR内存就要再乘以2。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">计算公式：</span><br><span class="line">内存带宽=内存总线频率×数据总线位数/8</span><br><span class="line">示例：DDR内存带宽计算</span><br><span class="line">DDR2 667,运行频率为333MHz，带宽为333×2×64/8=5400MB/s=5.4GB/s</span><br><span class="line">DDR2 800,运行频率为400MHz，带宽为400×2×64/8=6400MB/s=6.4GB/s</span><br></pre></td></tr></table></figure>

<h3 id="服务器内存所使用的技术"><a href="#服务器内存所使用的技术" class="headerlink" title="服务器内存所使用的技术"></a>服务器内存所使用的技术</h3><h4 id="在线备用内存技术"><a href="#在线备用内存技术" class="headerlink" title="在线备用内存技术"></a>在线备用内存技术</h4><p>当主内存或者是扩展内存中的内存出现多位错误时或者出现物理内存故障时，服务器仍继续运行，由备用内存接替出现故障内存的工作，备用的内存区域必须比其它区域的内存容量要大或相同。</p>
<p><img src="backup.PNG" alt="在线备用内存技术"></p>
<h4 id="内存镜像"><a href="#内存镜像" class="headerlink" title="内存镜像"></a>内存镜像</h4><p>镜像为系统在出现多位错或内存物理故障时提供数据保护功能，以保证系统仍能正常的运行，数据同时写入两个镜像的内存区域，从一个区域进行数据的读取。 </p>
<p><img src="image-20200628214553325.png" alt="内存镜像"></p>
]]></content>
      <categories>
        <category>计算机基础</category>
      </categories>
      <tags>
        <tag>计算机基础</tag>
      </tags>
  </entry>
  <entry>
    <title>服务器硬盘</title>
    <url>/2019/03/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A1%AC%E7%9B%98/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A1%AC%E7%9B%98/</url>
    <content><![CDATA[<h2 id="服务器硬盘"><a href="#服务器硬盘" class="headerlink" title="服务器硬盘"></a>服务器硬盘</h2><p>硬盘分为机械硬盘和固态硬盘</p>
<h3 id="机械硬盘"><a href="#机械硬盘" class="headerlink" title="机械硬盘"></a>机械硬盘</h3><h4 id="机械硬盘结构"><a href="#机械硬盘结构" class="headerlink" title="机械硬盘结构"></a>机械硬盘结构</h4><p><strong>存储介质（Media）——盘片</strong></p>
<p>盘片的基板是金属或玻璃材质制成，为达到高密度高稳定的质量，基板要求表面光滑平整，不可有任何暇疵。</p>
<p><strong>读写头（Read Write Head）——磁头</strong></p>
<p>磁头是硬盘读取数据的关键部件，它的主要作用就是将存储在硬盘盘片上的磁信息转化为电信号向外传输。</p>
<p><strong>马达（ Spindle Motor &amp; Voice Coil Motor ）</strong></p>
<p>马达上装有一至多片盘片，以7200，10000，15000 RPM等定速旋转，为保持其平衡不可抖动，所以其质量要求严谨，不产生高温躁音。</p>
<p><img src="clip_image002.jpg" alt="机械硬盘"></p>
<h4 id="硬盘基本参数"><a href="#硬盘基本参数" class="headerlink" title="硬盘基本参数"></a>硬盘基本参数</h4><p><strong>容量</strong>：容量是硬盘最主要的参数。单位有MB、GB、TB</p>
<p><strong>转速</strong>：转速是指硬盘盘片每分钟转动的圈数，单位为rpm。现在硬盘的转速已经达到10000rpm，15000rpm</p>
<p><strong>传输速率</strong>：传输速率(Data Transfer Rate) 。硬盘的数据传输率是指硬盘读写数据的速度，单位为兆字节每秒（MB/s）</p>
<p><strong>缓存</strong>：硬盘缓存的目的是为了解决系统前后级读写速度不匹配的问题，以提高硬盘的读写速度</p>
<h4 id="硬盘接口类型"><a href="#硬盘接口类型" class="headerlink" title="硬盘接口类型"></a>硬盘接口类型</h4><p><strong>IDE接口</strong>：硬盘接口规范，采用ATA技术规范</p>
<p><strong>SCSI接口</strong>：应用于小型机上的高速数据传输技术</p>
<p><strong>SATA接口</strong>： Serial ATA，提高传输速率，支持热插拔</p>
<p><strong>SAS接口</strong>： Serial Attached SCSI，兼容SATA</p>
<p>目前主流的硬盘接口为<code>SATA</code>和<code>SAS</code>接口</p>
<h3 id="固态硬盘"><a href="#固态硬盘" class="headerlink" title="固态硬盘"></a>固态硬盘</h3><p>SSD(Solid State Disk)泛指使用NAND Flash组成的固态硬盘。其特别之处在于没有机械结构，以区块写入和抹除的方式作读写的功能，因此在读写的效率上，非常依赖读写技术上的设计SSD读写存取速度快，性能稳定，防震性高，发热低，耐低温，电耗低，无噪音。因为没有机械部分，所以长时间使用也出现故障几率也较小。</p>
<p>缺点：价格高，容量小，在普通硬盘前毫无性价比优势</p>
<p> <img src="clip_image005.jpg" alt="普通固态"></p>
<p> <img src="clip_image006.jpg" alt="pci接口固态"></p>
<h3 id="服务器的性能短板"><a href="#服务器的性能短板" class="headerlink" title="服务器的性能短板"></a>服务器的性能短板</h3><p>如果CPU有每秒处理1000个服务请求的能力，各种总线的负载能力能达到500个， 但网卡只能接受200个请求，而硬盘只能负担150个的话，那这台服务器得处理能力只能是150个请求/秒，有85%的处理器计算能力浪费了。在计算机系统当中，硬盘的读写速率已经成为影响系统性能进一步提高的瓶颈。</p>
<p><strong>各硬件的处理速度</strong></p>
<p> <img src="clip_image013.jpg" alt="硬件处理速度对比"></p>
]]></content>
      <categories>
        <category>计算机基础</category>
      </categories>
      <tags>
        <tag>计算机基础</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机系统组成</title>
    <url>/2019/03/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%84%E6%88%90/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%84%E6%88%90/</url>
    <content><![CDATA[<h2 id="计算机系统组成"><a href="#计算机系统组成" class="headerlink" title="计算机系统组成"></a>计算机系统组成</h2><p>计算机系统由<code>硬件系统</code>（Hardware）和<code>软件系统</code>（Software）两大部分组成。</p>
<p><img src="image-20200626111327218.png" alt="计算机系统组成"></p>
<h3 id="计算机硬件"><a href="#计算机硬件" class="headerlink" title="计算机硬件"></a>计算机硬件</h3><p>计算机（Computer）：俗称电脑，是一种能接收和存储信息，并按照存储在其内部的程序对海量数据进行自动、高速地处理，然后把处理结果输出的现代化智能电子设备</p>
<table>
<thead>
<tr>
<th>发展历史：</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>第一代计算机（1946-1957）</td>
<td>电子管时代</td>
</tr>
<tr>
<td>第二代计算机（1958-1964）</td>
<td>晶体管时代</td>
</tr>
<tr>
<td>第三代计算机（1965-1970）</td>
<td>集成电路时代</td>
</tr>
<tr>
<td>第四代计算机（1971以后）</td>
<td>大规模集成电路时代</td>
</tr>
</tbody></table>
<h4 id="世界上第一台计算机"><a href="#世界上第一台计算机" class="headerlink" title="世界上第一台计算机"></a>世界上第一台计算机</h4><p>1946年,世界上第一台计算机ENIAC(electronic numerical integrator and calculator)在美国宾州大学诞生，是美国奥伯丁武器试验场为了满足计算弹道需要而研制成的。使用了17468只电子管，占地170平方米,重达30吨，耗电174千瓦，耗资40多万美元。每秒可进行5000次加法或减法运算。</p>
<p><img src="image-20200626113422577.png" alt="世界上第一台计算机"></p>
<h4 id="冯·诺依曼体系结构"><a href="#冯·诺依曼体系结构" class="headerlink" title="冯·诺依曼体系结构"></a>冯·诺依曼体系结构</h4><p>1945年6月，冯•诺依曼提出了在数字计算机内部的存储器中存放程序的概念(Stored Program Concept)，这是所有现代电子计算机的范式，被称为“冯• 诺依曼结构”，按这一结构建造的电脑称为存储程序计算机(Stored Program Computer)，又称为通用计算机。冯•诺依曼计算机主要由运算器、控制器、存储器和输入输出设备组成，它的的特点是：程序以二进制代码的形式存放在存储器中；所有的指令都是由操作码和地址码组成；指令在其存储过程中按照执行的顺序；以运算器和控制器作为计算机结构的中心等。冯诺依曼计算机广泛应用于数据的处理和控制方面，但是存在一些局限性。</p>
<p><img src="image-20200626115536182.png" alt="冯诺依曼体系"></p>
<p><strong>运算器</strong>：计算机中执行各种算术和逻辑运算操作的部件。运算器的基本操作包括加、减、乘、除四则运算，与、或、非、异或等逻辑操作，以及移位、比较和传送等操作，亦称算术逻辑部件（ALU）。</p>
<p><strong>控制器</strong>：由程序计数器、指令寄存器、指令译码器、时序产生器和操作控制器组成，它是发布命令的“决策机构”，即完成协调和指挥整个计算机系统的操作。运算器和控制器统称中央处理器，也叫做CPU。中央处理器是电脑的心脏。</p>
<p><strong>存储器</strong>：存储器分为内存和外存。内存是电脑的记忆部件，用于存放电脑运行中的原始数据、中间结果以及指示电脑工作的程序。外存就像笔记本一样，用来存放一些需要长期保存的程序或数据，断电后也不会丢失，容量比较大，但存取速度慢。当电脑要执行外存里的程序，处理外存中的数据时，需要先把外存里的数据读入内存，然后中央处理器才能进行处理。外存储器包括硬盘、光盘和优盘。</p>
<p><strong>输入设备</strong>：输入设备是向计算机输入数据和信息的设备。是计算机与用户或其他设备通信的桥梁。输入设备是用户和计算机系统之间进行信息交换的主要装置之一。键盘，鼠标，摄像头，扫描仪，光笔等都属于输入设备。</p>
<p><strong>输出设备</strong>：是计算机硬件系统的终端设备，用于接收计算机数据的输出显示、打印、声音、控制外围设备操作等。也是把各种计算结果数据或信息以数字、字符、图像、声音等形式表现出来。常见的输出设备有显示器、打印机等。</p>
]]></content>
      <categories>
        <category>计算机基础</category>
      </categories>
      <tags>
        <tag>计算机基础</tag>
      </tags>
  </entry>
  <entry>
    <title>GitLab数据备份和恢复</title>
    <url>/2019/05/03/CICD/gitlab/gitlab%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD/gitlab%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D/</url>
    <content><![CDATA[<p>gitlab的数据目录在/var/opt/gitlab目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># ll /var/opt/gitlab/</span></span><br><span class="line">total 96</span><br><span class="line">drwxr-xr-x 20 root              root       4096 Jul 18 11:48 ./</span><br><span class="line">drwxr-xr-x  3 root              root       4096 Jul 18 11:46 ../</span><br><span class="line">drwxr-x---  3 gitlab-prometheus root       4096 Jul 18 11:48 alertmanager/</span><br><span class="line">drwx------  2 git               root       4096 Jul 18 11:46 backups/</span><br><span class="line">-rw-------  1 root              root         38 Jul 18 11:48 bootstrapped</span><br><span class="line">drwxr-xr-x  2 git               git        4096 Jul 18 11:46 .bundle/</span><br><span class="line">drwx------  2 git               root       4096 Jul 18 11:48 gitaly/</span><br><span class="line">-rw-r--r--  1 git               git         286 Jul 18 11:46 .gitconfig</span><br><span class="line">drwx------  3 git               root       4096 Jul 18 11:46 git-data/</span><br><span class="line">drwxr-xr-x  3 git               root       4096 Jul 18 11:46 gitlab-ci/</span><br><span class="line">drwxr-xr-x  2 git               root       4096 Jul 18 11:48 gitlab-monitor/</span><br><span class="line">drwxr-xr-x  9 git               root       4096 Jul 18 11:47 gitlab-rails/</span><br><span class="line">drwx------  2 git               root       4096 Jul 18 11:46 gitlab-shell/</span><br><span class="line">drwxr-x---  2 git               gitlab-www 4096 Jul 18 11:48 gitlab-workhorse/</span><br><span class="line">drwx------  3 root              root       4096 Jul 18 13:58 logrotate/</span><br><span class="line">drwxr-x---  9 root              gitlab-www 4096 Jul 18 11:47 nginx/</span><br><span class="line">drwxr-xr-x  3 root              root       4096 Jul 18 11:48 node-exporter/</span><br><span class="line">drwx------  2 gitlab-psql       root       4096 Jul 18 11:48 postgres-exporter/</span><br><span class="line">drwxr-xr-x  3 gitlab-psql       root       4096 Jul 18 11:47 postgresql/</span><br><span class="line">drwxr-x---  4 gitlab-prometheus root       4096 Jul 18 11:48 prometheus/</span><br><span class="line">-rw-r--r--  1 root              root        226 Jul 18 11:48 public_attributes.json</span><br><span class="line">drwxr-x---  2 gitlab-redis      git        4096 Jul 19 00:57 redis/</span><br><span class="line">drwx------  2 git               git        4096 Jul 18 13:20 .ssh/</span><br><span class="line">-rw-r--r--  1 root              root         40 Jul 18 11:47 trusted-certs-directory-hash</span><br></pre></td></tr></table></figure>

<p>开发提交的数据在以下目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># ll /var/opt/gitlab/git-data/</span></span><br><span class="line">total 12</span><br><span class="line">drwx------  3 git  root 4096 Jul 18 11:46 ./</span><br><span class="line">drwxr-xr-x 20 root root 4096 Jul 18 11:48 ../</span><br><span class="line">drwxrws---  3 git  root 4096 Jul 18 12:29 repositories/</span><br></pre></td></tr></table></figure>

<h2 id="gitlab的数据备份"><a href="#gitlab的数据备份" class="headerlink" title="gitlab的数据备份"></a>gitlab的数据备份</h2><p>gitlab数据备份需要使用gitlab-rake命令，在数据备份之前需要先停止unicorn和sidekiq这两个服务</p>
<h3 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h3><p>暂停服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># gitlab-ctl stop unicorn</span></span><br><span class="line">ok: down: unicorn: 0s, normally up</span><br><span class="line">root@mylinuxops:~<span class="comment"># gitlab-ctl stop sidekiq</span></span><br><span class="line">ok: down: sidekiq: 1s, normally up</span><br></pre></td></tr></table></figure>

<p>执行数据备份命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># gitlab-rake gitlab:backup:create</span></span><br></pre></td></tr></table></figure>

<p>备份完毕后会在gitlab的数据目录下的backups目录下生成一个打包文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># ll /var/opt/gitlab/backups/</span></span><br><span class="line">total 128</span><br><span class="line">drwx------  2 git  root   4096 Jul 19 01:11 ./</span><br><span class="line">drwxr-xr-x 20 root root   4096 Jul 18 11:48 ../</span><br><span class="line">-rw-------  1 git  git  122880 Jul 19 01:11 1563498718_2019_07_19_11.11.5_gitlab_backup.tar</span><br></pre></td></tr></table></figure>

<p>备份完毕后启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># gitlab-ctl start</span></span><br></pre></td></tr></table></figure>

<h2 id="gitlab的数据恢复"><a href="#gitlab的数据恢复" class="headerlink" title="gitlab的数据恢复"></a>gitlab的数据恢复</h2><p>先将gitlab上的数据进行删除</p>
<p><img src="delete.png" alt="delete.png"></p>
<p><img src="delete1.png" alt="delete1.png"></p>
<p>数据被误删除后，先停止unicorn和sidekiq服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># gitlab-ctl stop unicorn</span></span><br><span class="line">ok: down: unicorn: 0s, normally up</span><br><span class="line">root@mylinuxops:~<span class="comment"># gitlab-ctl stop sidekiq</span></span><br><span class="line">ok: down: sidekiq: 0s, normally up</span><br></pre></td></tr></table></figure>

<p>恢复时一般使用最近的时间的备份</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#先查看下所有的备份</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># ll /var/opt/gitlab/backups/</span></span><br><span class="line">total 128</span><br><span class="line">drwx------  2 git  root   4096 Jul 19 01:11 ./</span><br><span class="line">drwxr-xr-x 20 root root   4096 Jul 18 11:48 ../</span><br><span class="line">-rw-------  1 git  git  122880 Jul 19 01:11 1563498718_2019_07_19_11.11.5_gitlab_backup.tar</span><br><span class="line"><span class="comment">#使用备份</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># gitlab-rake gitlab:backup:restore BACKUP=1563498718_2019_07_19_11.11.5</span></span><br></pre></td></tr></table></figure>

<p>恢复完毕后再次启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># gitlab-ctl start unicorn</span></span><br><span class="line">ok: run: unicorn: (pid 87294) 1s</span><br><span class="line">root@mylinuxops:~<span class="comment"># gitlab-ctl start sidekiq</span></span><br><span class="line">ok: run: sidekiq: (pid 87348) 1s</span><br></pre></td></tr></table></figure>

<p>查看代码是否恢复</p>
<p><img src="back.png" alt="back.png"></p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>gitlab</tag>
      </tags>
  </entry>
  <entry>
    <title>GitLab简单使用</title>
    <url>/2019/05/03/CICD/gitlab/gitlab%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/gitlab%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>配置完毕后使用浏览器登录</p>
<p><img src="gitlab1.png" alt="gitlab1.png"></p>
<p><img src="gitlab2.png" alt="gitlab2.png"></p>
<p>创建组</p>
<p><img src="gitlab3.png" alt="gitlab3.png"></p>
<p><img src="gitlab4.png" alt="gitlab4.png"></p>
<p>创建用户</p>
<p><img src="gitlab5.png" alt="gitlab5.png"></p>
<p><img src="gitlab6.png" alt="gitlab6.png"></p>
<p>修改用户密码</p>
<p><img src="gitlab7.png" alt="gitlab7.png"></p>
<p><img src="gitlab8.png" alt="gitlab8.png"></p>
<p>将用户添加到组中</p>
<p><img src="gitlab9.png" alt="gitlab9.png"></p>
<p>创建项目</p>
<p><img src="gitlab10.png" alt="gitlab10.png"></p>
<p><img src="gitlab11.png" alt="gitlab11.png"></p>
<p><img src="gitlab12.png" alt="gitlab12.png"></p>
<p><img src="gitlab13.png" alt="gitlab13.png"></p>
<p>创建一个文件</p>
<p><img src="gitlab13.png" alt="gitlab13.png"></p>
<p><img src="gitlab14.png" alt="gitlab14.png"></p>
<p><img src="gitlab15.png" alt="gitlab15.png"></p>
<p><img src="gitlab16.png" alt="gitlab16.png"></p>
<h2 id="克隆项目"><a href="#克隆项目" class="headerlink" title="克隆项目"></a>克隆项目</h2><p>本地克隆项目，先获取克隆的链接</p>
<p><img src="gitlab17.png" alt="gitlab17.png"></p>
<h3 id="使用http克隆"><a href="#使用http克隆" class="headerlink" title="使用http克隆"></a>使用http克隆</h3><p>获得到httpd地址后直接使用git clone来克隆项目</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># git clone http://192.168.27.11/mylinuxops/web1.git</span></span><br><span class="line">Cloning into <span class="string">&#x27;web1&#x27;</span>...</span><br><span class="line">Username <span class="keyword">for</span> <span class="string">&#x27;http://192.168.27.11&#x27;</span>: masuri</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">&#x27;http://masuri@192.168.27.11&#x27;</span>: </span><br><span class="line">remote: Enumerating objects: 3, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">Unpacking objects: 100% (3/3), <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>

<p>使用git clone命令后会在当前目录下生成克隆项目</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看当前目录下的内容</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># ls</span></span><br><span class="line">web1</span><br><span class="line"><span class="comment">#查看目录的结构</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">└── web1</span><br><span class="line">    └── index.html</span><br><span class="line"></span><br><span class="line">1 directory, 1 file</span><br><span class="line"><span class="comment">#查看index.html内的文件内容</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># cat web1/index.html </span></span><br><span class="line">welcome to mylinuxops.com       v1</span><br><span class="line"><span class="comment">#文件内的内容就是刚才在web界面上所创建的文件</span></span><br></pre></td></tr></table></figure>
<h3 id="使用ssh克隆"><a href="#使用ssh克隆" class="headerlink" title="使用ssh克隆"></a>使用ssh克隆</h3><p>使用ssh克隆，需要在本机生成一个ssh的公钥，并将公钥配置到gitlab的账号中</p>
<p>生成ssh公钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># ssh-keygen </span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:FoqVq5Jo4lm5MSMGeJUrRXi+neDgmRW4DT3i6byE/Oc root@mylinuxops</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|   +.            |</span></span><br><span class="line"><span class="string">|  =.=. .         |</span></span><br><span class="line"><span class="string">| . O+oo .        |</span></span><br><span class="line"><span class="string">|. =o=+ o .       |</span></span><br><span class="line"><span class="string">|+=o*o+o.S        |</span></span><br><span class="line"><span class="string">|o+Bo+.o.         |</span></span><br><span class="line"><span class="string">|o=+B.            |</span></span><br><span class="line"><span class="string">|= =o=.           |</span></span><br><span class="line"><span class="string">| o .oE           |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure>

<p>查看公钥将公钥复制到gitlab的配置界面</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># cat /root/.ssh/id_rsa.pub </span></span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDWyPPvaNxHvwXwjqQjhfmH+hS7E5BzcjV5UWKwjvXQFa6d9LBnJTPfG+kAWXBeQGJQHRxz+2sdrv2Le0bcE+5NYJbn7Dxe/iDwUSJeWk6lJHa4OEzgFMWoljXZY4kGbhFlZSYikhV7KpZdrtHW5SwbgFjn4ewuFw+yacsydK8DA6X8mPZcS5YI6EKALGHSCqqepBuBInSP8fYPp16qXpNbd3OQ8VrOrHB5zKrpq2lMv0OSSrQJVxbc2Ut8fCMH3+uT2oIiLijAXmS6lBbnYu8YjO69xkY0KSB4oWdA2s6MTHRYxaQjT08n56M5SPrjX1Zq5tWbDVQRaFYGlmsoXok9 root@mylinuxops</span><br></pre></td></tr></table></figure>

<p><img src="gitlab18.png" alt="gitlab18.png"></p>
<p>将当前目录下的web1目录删除后再次克隆，在使用克隆时当前目录下不能存在与像目录相同的目录，否则将会认为项目已经存在</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># rm -rf web1</span></span><br><span class="line"><span class="comment">#使用ssh克隆时无需再输入账号和密码</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># git clone git@192.168.27.11:mylinuxops/web1.git</span></span><br><span class="line">Cloning into <span class="string">&#x27;web1&#x27;</span>...</span><br><span class="line">The authenticity of host <span class="string">&#x27;192.168.27.11 (192.168.27.11)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:tcC7W8ATUPjHG7RdNF1sFEUkSiV/19CrLk5loLaTkO0.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>192.168.27.11<span class="string">&#x27; (ECDSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">remote: Enumerating objects: 3, done.</span></span><br><span class="line"><span class="string">remote: Counting objects: 100% (3/3), done.</span></span><br><span class="line"><span class="string">remote: Total 3 (delta 0), reused 0 (delta 0)</span></span><br><span class="line"><span class="string">Receiving objects: 100% (3/3), done.</span></span><br></pre></td></tr></table></figure>

<p>查看目录及目录中的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">└── web1</span><br><span class="line">    └── index.html</span><br><span class="line"></span><br><span class="line">1 directory, 1 file</span><br><span class="line">root@mylinuxops:~<span class="comment"># cat web1/</span></span><br><span class="line">.git/       index.html  </span><br><span class="line">root@mylinuxops:~<span class="comment"># cat web1/index.html </span></span><br><span class="line">welcome to mylinuxops.com       v1</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>gitlab</tag>
      </tags>
  </entry>
  <entry>
    <title>GitLab部署</title>
    <url>/2019/05/03/CICD/gitlab/gitlab%E9%83%A8%E7%BD%B2/gitlab%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h2 id="GitLab部署"><a href="#GitLab部署" class="headerlink" title="GitLab部署"></a>GitLab部署</h2><p>在gitlab官网获取gitlab的相应版本的安装包，本次部署的版本为gitlab-ce_11.11.5-ce，使用的linux系统为ubuntu 18.04.2.</p>
<p>gitlab官方下载地址：</p>
<p><a href="https://packages.gitlab.com/gitlab/gitlab-ce">https://packages.gitlab.com/gitlab/gitlab-ce</a></p>
<p>将下载后的安装包上传到linux</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># ls</span></span><br><span class="line">gitlab-ce_11.11.5-ce.0_amd64.deb</span><br></pre></td></tr></table></figure>

<p>安装gitlab，getlab对系统有一定的要求要求内存为4G</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># dpkg -i gitlab-ce_11.11.5-ce.0_amd64.deb </span></span><br></pre></td></tr></table></figure>

<p>修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># vim /etc/gitlab/gitlab.rb </span></span><br><span class="line"><span class="comment"># 配置url的ip地址</span></span><br><span class="line">external_url <span class="string">&#x27;http://192.168.27.11&#x27;</span></span><br><span class="line"><span class="comment"># 配置邮箱</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_enable&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_address&#x27;</span>] = <span class="string">&quot;smtp.qq.com&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_port&#x27;</span>] = 465</span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_user_name&#x27;</span>] = <span class="string">&quot;438214186@qq.com&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_password&#x27;</span>] = <span class="string">&quot;hghrqwjeoprscbcb&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_domain&#x27;</span>] = <span class="string">&quot;qq.com&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_authentication&#x27;</span>] = :login</span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_enable_starttls_auto&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_tls&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_email_from&#x27;</span>] = <span class="string">&quot;438214186@qq.com&quot;</span></span><br><span class="line">user[<span class="string">&quot;git_user_email&quot;</span>] = <span class="string">&quot;438214186@qq.com&quot;</span></span><br></pre></td></tr></table></figure>

<p>让配置文件重新生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># gitlab-ctl reconfigure</span></span><br></pre></td></tr></table></figure>
<h2 id="gitlab的简单使用"><a href="#gitlab的简单使用" class="headerlink" title="gitlab的简单使用"></a>gitlab的简单使用</h2><p>配置完毕后使用浏览器登录</p>
<p><img src="gitlab1.png" alt="gitlab1.png"></p>
<p><img src="gitlab2.png" alt="gitlab2.png"></p>
<p>创建组</p>
<p><img src="gitlab3.png" alt="gitlab3.png"></p>
<p><img src="gitlab4.png" alt="gitlab4.png"></p>
<p>创建用户</p>
<p><img src="gitlab5.png" alt="gitlab5.png"></p>
<p><img src="gitlab6.png" alt="gitlab6.png"></p>
<p>修改用户密码</p>
<p><img src="gitlab7.png" alt="gitlab7.png"></p>
<p><img src="gitlab8.png" alt="gitlab8.png"></p>
<p>将用户添加到组中</p>
<p><img src="gitlab9.png" alt="gitlab9.png"></p>
<p>创建项目</p>
<p><img src="gitlab10.png" alt="gitlab10.png"></p>
<p><img src="gitlab11.png" alt="gitlab11.png"></p>
<p><img src="gitlab12.png" alt="gitlab12.png"></p>
<p><img src="gitlab13.png" alt="gitlab13.png"></p>
<p>创建一个文件</p>
<p><img src="gitlab13.png" alt="gitlab13.png"></p>
<p><img src="gitlab14.png" alt="gitlab14.png"></p>
<p><img src="gitlab15.png" alt="gitlab15.png"></p>
<p><img src="gitlab16.png" alt="gitlab16.png"></p>
<h2 id="克隆项目"><a href="#克隆项目" class="headerlink" title="克隆项目"></a>克隆项目</h2><p>本地克隆项目，先获取克隆的链接</p>
<p><img src="gitlab17.png" alt="gitlab17.png"></p>
<h3 id="使用http克隆"><a href="#使用http克隆" class="headerlink" title="使用http克隆"></a>使用http克隆</h3><p>获得到httpd地址后直接使用git clone来克隆项目</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># git clone http://192.168.27.11/mylinuxops/web1.git</span></span><br><span class="line">Cloning into <span class="string">&#x27;web1&#x27;</span>...</span><br><span class="line">Username <span class="keyword">for</span> <span class="string">&#x27;http://192.168.27.11&#x27;</span>: masuri</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">&#x27;http://masuri@192.168.27.11&#x27;</span>: </span><br><span class="line">remote: Enumerating objects: 3, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">Unpacking objects: 100% (3/3), <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>

<p>使用git clone命令后会在当前目录下生成克隆项目</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看当前目录下的内容</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># ls</span></span><br><span class="line">web1</span><br><span class="line"><span class="comment">#查看目录的结构</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">└── web1</span><br><span class="line">    └── index.html</span><br><span class="line"></span><br><span class="line">1 directory, 1 file</span><br><span class="line"><span class="comment">#查看index.html内的文件内容</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># cat web1/index.html </span></span><br><span class="line">welcome to mylinuxops.com       v1</span><br><span class="line"><span class="comment">#文件内的内容就是刚才在web界面上所创建的文件</span></span><br></pre></td></tr></table></figure>
<h3 id="使用ssh克隆"><a href="#使用ssh克隆" class="headerlink" title="使用ssh克隆"></a>使用ssh克隆</h3><p>使用ssh克隆，需要在本机生成一个ssh的公钥，并将公钥配置到gitlab的账号中</p>
<p>生成ssh公钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># ssh-keygen </span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:FoqVq5Jo4lm5MSMGeJUrRXi+neDgmRW4DT3i6byE/Oc root@mylinuxops</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|   +.            |</span></span><br><span class="line"><span class="string">|  =.=. .         |</span></span><br><span class="line"><span class="string">| . O+oo .        |</span></span><br><span class="line"><span class="string">|. =o=+ o .       |</span></span><br><span class="line"><span class="string">|+=o*o+o.S        |</span></span><br><span class="line"><span class="string">|o+Bo+.o.         |</span></span><br><span class="line"><span class="string">|o=+B.            |</span></span><br><span class="line"><span class="string">|= =o=.           |</span></span><br><span class="line"><span class="string">| o .oE           |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure>

<p>查看公钥将公钥复制到gitlab的配置界面</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># cat /root/.ssh/id_rsa.pub </span></span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDWyPPvaNxHvwXwjqQjhfmH+hS7E5BzcjV5UWKwjvXQFa6d9LBnJTPfG+kAWXBeQGJQHRxz+2sdrv2Le0bcE+5NYJbn7Dxe/iDwUSJeWk6lJHa4OEzgFMWoljXZY4kGbhFlZSYikhV7KpZdrtHW5SwbgFjn4ewuFw+yacsydK8DA6X8mPZcS5YI6EKALGHSCqqepBuBInSP8fYPp16qXpNbd3OQ8VrOrHB5zKrpq2lMv0OSSrQJVxbc2Ut8fCMH3+uT2oIiLijAXmS6lBbnYu8YjO69xkY0KSB4oWdA2s6MTHRYxaQjT08n56M5SPrjX1Zq5tWbDVQRaFYGlmsoXok9 root@mylinuxops</span><br></pre></td></tr></table></figure>

<p><img src="gitlab18.png" alt="gitlab18.png"></p>
<p>将当前目录下的web1目录删除后再次克隆，在使用克隆时当前目录下不能存在与像目录相同的目录，否则将会认为项目已经存在</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># rm -rf web1</span></span><br><span class="line"><span class="comment">#使用ssh克隆时无需再输入账号和密码</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># git clone git@192.168.27.11:mylinuxops/web1.git</span></span><br><span class="line">Cloning into <span class="string">&#x27;web1&#x27;</span>...</span><br><span class="line">The authenticity of host <span class="string">&#x27;192.168.27.11 (192.168.27.11)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:tcC7W8ATUPjHG7RdNF1sFEUkSiV/19CrLk5loLaTkO0.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>192.168.27.11<span class="string">&#x27; (ECDSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">remote: Enumerating objects: 3, done.</span></span><br><span class="line"><span class="string">remote: Counting objects: 100% (3/3), done.</span></span><br><span class="line"><span class="string">remote: Total 3 (delta 0), reused 0 (delta 0)</span></span><br><span class="line"><span class="string">Receiving objects: 100% (3/3), done.</span></span><br></pre></td></tr></table></figure>

<p>查看目录及目录中的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">└── web1</span><br><span class="line">    └── index.html</span><br><span class="line"></span><br><span class="line">1 directory, 1 file</span><br><span class="line">root@mylinuxops:~<span class="comment"># cat web1/</span></span><br><span class="line">.git/       index.html  </span><br><span class="line">root@mylinuxops:~<span class="comment"># cat web1/index.html </span></span><br><span class="line">welcome to mylinuxops.com       v1</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="git常用命令"><a href="#git常用命令" class="headerlink" title="git常用命令"></a>git常用命令</h2><p>1.克隆</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># git clone git@192.168.27.11:mylinuxops/web1.git</span></span><br><span class="line">Cloning into <span class="string">&#x27;web1&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: 3, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">Receiving objects: 100% (3/3), <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>

<p>2.提交</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#对代码做更改</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># echo &quot;welcome to mylinuxops.com    V2&quot; &gt;&gt; web1/index.html </span></span><br><span class="line"><span class="comment">#提交代码</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git add index.html </span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git commit -m &quot;v2&quot;</span></span><br><span class="line"></span><br><span class="line">*** Please tell me who you are.</span><br><span class="line"></span><br><span class="line">Run</span><br><span class="line"></span><br><span class="line">  git config --global user.email <span class="string">&quot;you@example.com&quot;</span></span><br><span class="line">  git config --global user.name <span class="string">&quot;Your Name&quot;</span></span><br><span class="line"></span><br><span class="line">to <span class="built_in">set</span> your account<span class="string">&#x27;s default identity.</span></span><br><span class="line"><span class="string">Omit --global to set the identity only in this repository.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fatal: unable to auto-detect email address (got &#x27;</span>root@mylinuxops.(none)<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#第一次提交时需要配置提交的用户和账户</span></span><br><span class="line"><span class="string">root@mylinuxops:~/web1# git config --global user.email &quot;438214186@qq.com&quot;</span></span><br><span class="line"><span class="string">root@mylinuxops:~/web1# git config --global user.name &quot;masuri&quot;</span></span><br><span class="line"><span class="string">#提交用户名和账户后会在家里目录下生成.gitconfig文件里面为提交的信息</span></span><br><span class="line"><span class="string">root@mylinuxops:~/web1# cat ~/.gitconfig </span></span><br><span class="line"><span class="string">[user]</span></span><br><span class="line"><span class="string">	email = 438214186@qq.com</span></span><br><span class="line"><span class="string">	name = masuri</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#再次提交版本信息</span></span><br><span class="line"><span class="string">[master 54e4d4f] v2</span></span><br><span class="line"><span class="string"> 1 file changed, 1 insertion(+), 1 deletion(-)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#现在文件还在本机的缓存中，需要将其提交到gitlab上还需要将其push上去</span></span><br><span class="line"><span class="string">root@mylinuxops:~/web1# git push</span></span><br><span class="line"><span class="string">Counting objects: 3, done.</span></span><br><span class="line"><span class="string">Delta compression using up to 12 threads.</span></span><br><span class="line"><span class="string">Compressing objects: 100% (2/2), done.</span></span><br><span class="line"><span class="string">Writing objects: 100% (3/3), 265 bytes | 265.00 KiB/s, done.</span></span><br><span class="line"><span class="string">Total 3 (delta 0), reused 0 (delta 0)</span></span><br><span class="line"><span class="string">To 192.168.27.11:mylinuxops/web1.git</span></span><br><span class="line"><span class="string">   39130ff..54e4d4f  master -&gt; master</span></span><br></pre></td></tr></table></figure>

<p>3.第一次克隆像目录时需要将像目录完整的克隆下来，之后是需要使用pull就行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~/web1<span class="comment"># git pull</span></span><br><span class="line">remote: Enumerating objects: 5, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (5/5), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (2/2), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 3 (delta 1), reused 0 (delta 0)</span><br><span class="line">Unpacking objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">From 192.168.27.11:mylinuxops/web1</span><br><span class="line">   9da11e0..07a9e44  master     -&gt; origin/master</span><br><span class="line">Updating 9da11e0..07a9e44</span><br><span class="line">Fast-forward</span><br><span class="line"> index.html | 3 ++-</span><br><span class="line"> 1 file changed, 2 insertions(+), 1 deletion(-)</span><br></pre></td></tr></table></figure>

<p>4.获取git日志，可以根据日志中的tag号对其进行版本的回滚操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~/web1<span class="comment"># git log</span></span><br><span class="line">commit 07a9e4447c8809ce4c08087549f3a8f7c98065d7 (HEAD -&gt; master, origin/master, origin/HEAD)</span><br><span class="line">Author: Administrator &lt;admin@example.com&gt;</span><br><span class="line">Date:   Thu Jul 18 13:45:09 2019 +0000</span><br><span class="line"></span><br><span class="line">    v4</span><br><span class="line"></span><br><span class="line">commit 9da11e042c623ec6555cbb559c210da666a05572</span><br><span class="line">Author: masuri &lt;438214186@qq.com&gt;</span><br><span class="line">Date:   Thu Jul 18 13:42:19 2019 +0000</span><br><span class="line"></span><br><span class="line">    v3</span><br><span class="line"></span><br><span class="line">commit 54e4d4fc15bc8b34fd736784ebd883b33afc666a</span><br><span class="line">Author: masuri &lt;438214186@qq.com&gt;</span><br><span class="line">Date:   Thu Jul 18 13:39:06 2019 +0000</span><br><span class="line"></span><br><span class="line">    v2</span><br><span class="line"></span><br><span class="line">commit 39130ff04585cbf48064adb9fd9f1e9a1c847044</span><br><span class="line">Author: Administrator &lt;admin@example.com&gt;</span><br><span class="line">Date:   Thu Jul 18 12:52:52 2019 +0000</span><br><span class="line"></span><br><span class="line">    test-v1</span><br></pre></td></tr></table></figure>

<p>4.版本的回滚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#版本回滚有2种方法</span></span><br><span class="line"><span class="comment">#1.使用&quot;^&quot;将其恢复到上一个版本，也可以使用&quot;^^&quot;将其恢复到上上一个版本</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git reset --hard HEAD^</span></span><br><span class="line">HEAD is now at 9da11e0 v3</span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git reset --hard HEAD^^</span></span><br><span class="line">HEAD is now at 39130ff test-v1</span><br><span class="line"><span class="comment">#2.使用tag号来进行回滚，先找到相应的tag号</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git reflog</span></span><br><span class="line">07a9e44 (HEAD -&gt; master) HEAD@&#123;0&#125;: reset: moving to 07a9e44</span><br><span class="line">7b5ebd9 (origin/master, origin/HEAD) HEAD@&#123;1&#125;: commit: v5</span><br><span class="line">07a9e44 (HEAD -&gt; master) HEAD@&#123;2&#125;: <span class="built_in">clone</span>: from git@192.168.27.11:mylinuxops/web1.git</span><br><span class="line"><span class="comment">#执行回滚操作</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git reset --hard 7b5ebd9</span></span><br><span class="line">HEAD is now at 7b5ebd9 v5</span><br></pre></td></tr></table></figure>

<p>5.查看当前项目所属的分支</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~/web1<span class="comment"># git branch</span></span><br><span class="line">* master</span><br><span class="line"><span class="comment">#master一般只有像目录的负责人能看到</span></span><br></pre></td></tr></table></figure>

<p>创建新的分支</p>
<p><img src="gitlab19.png" alt="gitlab19.png"></p>
<p><img src="gitlab20.png" alt="gitlab20.png"></p>
<p>切换分支</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#先删除之前目录</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># rm -rf web1</span></span><br><span class="line"><span class="comment">#克隆项目</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># git clone git@192.168.27.11:mylinuxops/web1.git</span></span><br><span class="line"><span class="comment">#进入到项目目录进行分支切换</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># cd web1/</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git checkout develop</span></span><br><span class="line">Branch <span class="string">&#x27;develop&#x27;</span> <span class="built_in">set</span> up to track remote branch <span class="string">&#x27;develop&#x27;</span> from <span class="string">&#x27;origin&#x27;</span>.</span><br><span class="line">Switched to a new branch <span class="string">&#x27;develop&#x27;</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git branch</span></span><br><span class="line">* develop</span><br><span class="line">  master</span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git checkout master</span></span><br><span class="line">Switched to branch <span class="string">&#x27;master&#x27;</span></span><br><span class="line">Your branch is up to date with <span class="string">&#x27;origin/master&#x27;</span>.</span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git branch</span></span><br><span class="line">  develop</span><br><span class="line">* master</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>gitlab</tag>
      </tags>
  </entry>
  <entry>
    <title>Git常用命令</title>
    <url>/2019/05/03/CICD/gitlab/git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h2 id="git基本使用"><a href="#git基本使用" class="headerlink" title="git基本使用"></a>git基本使用</h2><p>1.克隆</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~<span class="comment"># git clone git@192.168.27.11:mylinuxops/web1.git</span></span><br><span class="line">Cloning into <span class="string">&#x27;web1&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: 3, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">Receiving objects: 100% (3/3), <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>

<p>2.提交</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#对代码做更改</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># echo &quot;welcome to mylinuxops.com    V2&quot; &gt;&gt; web1/index.html </span></span><br><span class="line"><span class="comment">#提交代码</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git add index.html </span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git commit -m &quot;v2&quot;</span></span><br><span class="line"></span><br><span class="line">*** Please tell me who you are.</span><br><span class="line"></span><br><span class="line">Run</span><br><span class="line"></span><br><span class="line">  git config --global user.email <span class="string">&quot;you@example.com&quot;</span></span><br><span class="line">  git config --global user.name <span class="string">&quot;Your Name&quot;</span></span><br><span class="line"></span><br><span class="line">to <span class="built_in">set</span> your account<span class="string">&#x27;s default identity.</span></span><br><span class="line"><span class="string">Omit --global to set the identity only in this repository.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fatal: unable to auto-detect email address (got &#x27;</span>root@mylinuxops.(none)<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#第一次提交时需要配置提交的用户和账户</span></span><br><span class="line"><span class="string">root@mylinuxops:~/web1# git config --global user.email &quot;438214186@qq.com&quot;</span></span><br><span class="line"><span class="string">root@mylinuxops:~/web1# git config --global user.name &quot;masuri&quot;</span></span><br><span class="line"><span class="string">#提交用户名和账户后会在家里目录下生成.gitconfig文件里面为提交的信息</span></span><br><span class="line"><span class="string">root@mylinuxops:~/web1# cat ~/.gitconfig </span></span><br><span class="line"><span class="string">[user]</span></span><br><span class="line"><span class="string">	email = 438214186@qq.com</span></span><br><span class="line"><span class="string">	name = masuri</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#再次提交版本信息</span></span><br><span class="line"><span class="string">[master 54e4d4f] v2</span></span><br><span class="line"><span class="string"> 1 file changed, 1 insertion(+), 1 deletion(-)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#现在文件还在本机的缓存中，需要将其提交到gitlab上还需要将其push上去</span></span><br><span class="line"><span class="string">root@mylinuxops:~/web1# git push</span></span><br><span class="line"><span class="string">Counting objects: 3, done.</span></span><br><span class="line"><span class="string">Delta compression using up to 12 threads.</span></span><br><span class="line"><span class="string">Compressing objects: 100% (2/2), done.</span></span><br><span class="line"><span class="string">Writing objects: 100% (3/3), 265 bytes | 265.00 KiB/s, done.</span></span><br><span class="line"><span class="string">Total 3 (delta 0), reused 0 (delta 0)</span></span><br><span class="line"><span class="string">To 192.168.27.11:mylinuxops/web1.git</span></span><br><span class="line"><span class="string">   39130ff..54e4d4f  master -&gt; master</span></span><br></pre></td></tr></table></figure>

<p>3.第一次克隆像目录时需要将像目录完整的克隆下来，之后是需要使用pull就行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~/web1<span class="comment"># git pull</span></span><br><span class="line">remote: Enumerating objects: 5, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (5/5), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (2/2), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 3 (delta 1), reused 0 (delta 0)</span><br><span class="line">Unpacking objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">From 192.168.27.11:mylinuxops/web1</span><br><span class="line">   9da11e0..07a9e44  master     -&gt; origin/master</span><br><span class="line">Updating 9da11e0..07a9e44</span><br><span class="line">Fast-forward</span><br><span class="line"> index.html | 3 ++-</span><br><span class="line"> 1 file changed, 2 insertions(+), 1 deletion(-)</span><br></pre></td></tr></table></figure>

<p>4.获取git日志，可以根据日志中的tag号对其进行版本的回滚操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~/web1<span class="comment"># git log</span></span><br><span class="line">commit 07a9e4447c8809ce4c08087549f3a8f7c98065d7 (HEAD -&gt; master, origin/master, origin/HEAD)</span><br><span class="line">Author: Administrator &lt;admin@example.com&gt;</span><br><span class="line">Date:   Thu Jul 18 13:45:09 2019 +0000</span><br><span class="line"></span><br><span class="line">    v4</span><br><span class="line"></span><br><span class="line">commit 9da11e042c623ec6555cbb559c210da666a05572</span><br><span class="line">Author: masuri &lt;438214186@qq.com&gt;</span><br><span class="line">Date:   Thu Jul 18 13:42:19 2019 +0000</span><br><span class="line"></span><br><span class="line">    v3</span><br><span class="line"></span><br><span class="line">commit 54e4d4fc15bc8b34fd736784ebd883b33afc666a</span><br><span class="line">Author: masuri &lt;438214186@qq.com&gt;</span><br><span class="line">Date:   Thu Jul 18 13:39:06 2019 +0000</span><br><span class="line"></span><br><span class="line">    v2</span><br><span class="line"></span><br><span class="line">commit 39130ff04585cbf48064adb9fd9f1e9a1c847044</span><br><span class="line">Author: Administrator &lt;admin@example.com&gt;</span><br><span class="line">Date:   Thu Jul 18 12:52:52 2019 +0000</span><br><span class="line"></span><br><span class="line">    test-v1</span><br></pre></td></tr></table></figure>

<h2 id="版本的回滚"><a href="#版本的回滚" class="headerlink" title="版本的回滚"></a>版本的回滚</h2><p>版本回滚有2种方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1.使用&quot;^&quot;将其恢复到上一个版本，也可以使用&quot;^^&quot;将其恢复到上上一个版本</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git reset --hard HEAD^</span></span><br><span class="line">HEAD is now at 9da11e0 v3</span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git reset --hard HEAD^^</span></span><br><span class="line">HEAD is now at 39130ff test-v1</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.使用tag号来进行回滚，先找到相应的tag号</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git reflog</span></span><br><span class="line">07a9e44 (HEAD -&gt; master) HEAD@&#123;0&#125;: reset: moving to 07a9e44</span><br><span class="line">7b5ebd9 (origin/master, origin/HEAD) HEAD@&#123;1&#125;: commit: v5</span><br><span class="line">07a9e44 (HEAD -&gt; master) HEAD@&#123;2&#125;: <span class="built_in">clone</span>: from git@192.168.27.11:mylinuxops/web1.git</span><br><span class="line"><span class="comment">#执行回滚操作</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git reset --hard 7b5ebd9</span></span><br><span class="line">HEAD is now at 7b5ebd9 v5</span><br></pre></td></tr></table></figure>

<p>查看当前项目所属的分支</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mylinuxops:~/web1<span class="comment"># git branch</span></span><br><span class="line">* master</span><br><span class="line"><span class="comment">#master一般只有像目录的负责人能看到</span></span><br></pre></td></tr></table></figure>

<h2 id="创建新的分支"><a href="#创建新的分支" class="headerlink" title="创建新的分支"></a>创建新的分支</h2><p><img src="gitlab19.png" alt="gitlab19.png"></p>
<p><img src="gitlab20.png" alt="gitlab20.png"></p>
<h2 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#先删除之前目录</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># rm -rf web1</span></span><br><span class="line"><span class="comment">#克隆项目</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># git clone git@192.168.27.11:mylinuxops/web1.git</span></span><br><span class="line"><span class="comment">#进入到项目目录进行分支切换</span></span><br><span class="line">root@mylinuxops:~<span class="comment"># cd web1/</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git checkout develop</span></span><br><span class="line">Branch <span class="string">&#x27;develop&#x27;</span> <span class="built_in">set</span> up to track remote branch <span class="string">&#x27;develop&#x27;</span> from <span class="string">&#x27;origin&#x27;</span>.</span><br><span class="line">Switched to a new branch <span class="string">&#x27;develop&#x27;</span></span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git branch</span></span><br><span class="line">* develop</span><br><span class="line">  master</span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git checkout master</span></span><br><span class="line">Switched to branch <span class="string">&#x27;master&#x27;</span></span><br><span class="line">Your branch is up to date with <span class="string">&#x27;origin/master&#x27;</span>.</span><br><span class="line">root@mylinuxops:~/web1<span class="comment"># git branch</span></span><br><span class="line">  develop</span><br><span class="line">* master</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>gitlab</tag>
      </tags>
  </entry>
</search>
